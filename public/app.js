(()=>{"use strict";class e{constructor(e){this.currentRoom=null,this.ws=null,this.messageHandlers=[],this.userId=e}setWebSocket(e){this.ws=e,this.setupMessageHandler()}createRoom(){const e="room_"+Math.random().toString(36).substring(2,10);return this.joinRoom(e,!0),e}joinRoom(e,t=!1){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void console.error("WebSocket not connected");const s={type:t?"create-room":"join-room",roomId:e,userId:this.userId};this.ws.send(JSON.stringify(s)),this.currentRoom=e,function(e){const t=`${window.location.origin}?room=${e}`;window.history.pushState({roomId:e},"",t)}(e)}leaveRoom(){if(!this.currentRoom||!this.ws)return;const e={type:"leave-room",roomId:this.currentRoom,userId:this.userId};this.ws.send(JSON.stringify(e)),this.currentRoom=null,window.history.pushState({},"",window.location.origin)}sendMessage(e){if(!this.currentRoom||!this.ws)return;const t={type:"room-message",roomId:this.currentRoom,userId:this.userId,message:e};this.ws.send(JSON.stringify(t))}getCurrentRoom(){return this.currentRoom}getRoomLink(){return this.currentRoom?(e=this.currentRoom,`${window.location.origin}?room=${e}`):null;var e}onMessage(e){this.messageHandlers.push(e)}setupMessageHandler(){this.ws&&(this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.messageHandlers.forEach(e=>e(t))}catch(t){const s={type:"room-message",userId:"server",message:e.data};this.messageHandlers.forEach(e=>e(s))}})}}class t{constructor(){this.ws=null,this.messagesList=null,this.messageInput=null,this.sendBtn=null,this.roomControls=null,this.chatContainer=null,this.userIdDisplay=null,this.roomIdDisplay=null,this.roomLinkDisplay=null,this.userId=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),this.roomManager=new e(this.userId),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initializeElements(),this.setupEventListeners(),this.checkForRoomInURL()}):(this.initializeElements(),this.setupEventListeners(),this.checkForRoomInURL())}initializeElements(){this.messagesList=document.getElementById("messages"),this.messageInput=document.getElementById("msg"),this.sendBtn=document.getElementById("sendBtn"),this.roomControls=document.getElementById("roomControls"),this.chatContainer=document.getElementById("chatContainer"),this.userIdDisplay=document.getElementById("userId"),this.roomIdDisplay=document.getElementById("roomId"),this.roomLinkDisplay=document.getElementById("roomLink"),this.messagesList&&this.messageInput&&this.sendBtn&&this.roomControls&&this.chatContainer&&this.userIdDisplay&&this.roomIdDisplay&&this.roomLinkDisplay?(this.userIdDisplay.textContent=this.userId,this.showRoomControls()):console.error("Some required DOM elements are missing")}setupEventListeners(){this.sendBtn&&this.messageInput&&(this.sendBtn.addEventListener("click",()=>this.sendMessage()),this.messageInput.addEventListener("keypress",e=>{"Enter"===e.key&&this.sendMessage()}),document.getElementById("hostBtn")?.addEventListener("click",()=>this.hostRoom()),document.getElementById("joinBtn")?.addEventListener("click",()=>this.joinRoom()),document.getElementById("leaveBtn")?.addEventListener("click",()=>this.leaveRoom()),document.getElementById("copyLinkBtn")?.addEventListener("click",()=>this.copyRoomLink()),this.roomManager.onMessage(e=>this.handleRoomMessage(e)))}connectWebSocket(){const e="https:"===location.protocol?"wss:":"ws:";this.ws=new WebSocket(`${e}//${location.host}`),this.ws.onopen=()=>{console.log("Connected to WebSocket"),this.roomManager.setWebSocket(this.ws)},this.ws.onclose=()=>{console.log("Disconnected from WebSocket"),setTimeout(()=>this.connectWebSocket(),3e3)},this.ws.onerror=e=>{console.error("WebSocket error:",e)}}checkForRoomInURL(){const e=new URLSearchParams(window.location.search).get("room");e&&(this.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(e)},1e3))}hostRoom(){if(this.ws){const e=this.roomManager.createRoom();this.showChatContainer(e)}else this.connectWebSocket(),setTimeout(()=>{const e=this.roomManager.createRoom();this.showChatContainer(e)},1e3)}joinRoom(){const e=prompt("Enter room link:");if(e)try{const t=new URL(e),s=new URLSearchParams(t.search).get("room");if(!s)return void alert("Invalid room link");this.ws?(this.roomManager.joinRoom(s),this.showChatContainer(s)):(this.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(s),this.showChatContainer(s)},1e3))}catch(e){alert("Invalid room link format")}}leaveRoom(){this.roomManager.leaveRoom(),this.showRoomControls()}sendMessage(){if(!this.messageInput)return;const e=this.messageInput.value.trim();e&&(this.roomManager.sendMessage(e),this.messageInput.value="")}copyRoomLink(){const e=this.roomManager.getRoomLink();if(e&&this.roomLinkDisplay){this.roomLinkDisplay.value=e,this.roomLinkDisplay.select();try{document.execCommand("copy"),alert("Room link copied to clipboard!")}catch(t){navigator.clipboard?.writeText(e).then(()=>{alert("Room link copied to clipboard!")}).catch(()=>{alert("Could not copy to clipboard. Please copy manually.")})}}}handleRoomMessage(e){if(!this.messagesList)return;const t=document.createElement("li");switch(e.type){case"room-created":t.textContent=`Room created! Share this link: ${this.roomManager.getRoomLink()}`,t.className="system-message";break;case"room-joined":t.textContent=`Joined room: ${e.roomId}`,t.className="system-message";break;case"user-joined":t.textContent=`User ${e.userId} joined the room`,t.className="system-message";break;case"user-left":t.textContent=`User ${e.userId} left the room`,t.className="system-message";break;case"room-message":const s=e.userId===this.userId;t.textContent=`${s?"You":e.userId}: ${e.message}`,t.className=s?"own-message":"other-message";break;case"room-error":t.textContent=`Error: ${e.message}`,t.className="error-message";break;default:t.textContent=e.message||""}this.messagesList.appendChild(t),this.messagesList.scrollTop=this.messagesList.scrollHeight}showRoomControls(){this.roomControls&&this.chatContainer&&(this.roomControls.style.display="block",this.chatContainer.style.display="none")}showChatContainer(e){this.roomControls&&this.chatContainer&&this.roomIdDisplay&&this.roomLinkDisplay&&(this.roomControls.style.display="none",this.chatContainer.style.display="block",this.roomIdDisplay.textContent=e,this.roomLinkDisplay.value=this.roomManager.getRoomLink()||"")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new t}):new t})();