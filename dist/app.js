(()=>{var t={65:(t,e,a)=>{var s={"./clustermodule/clustermodule":224,"./clustermodule/clustermodule.ts":224,"./kineticbrain/kineticbrain":748,"./kineticbrain/kineticbrain.ts":748,"./muzzlesplitter/muzzlesplitter":358,"./muzzlesplitter/muzzlesplitter.ts":358,"./phoenixmodule/phoenixmodule":96,"./phoenixmodule/phoenixmodule.ts":96,"./projectilearray/projectilearray":800,"./projectilearray/projectilearray.ts":800,"./spatialtargeting/spatialtargeting":88,"./spatialtargeting/spatialtargeting.ts":88,"./spectralimage/spectralimage":368,"./spectralimage/spectralimage.ts":368};function i(t){var e=o(t);return a(e)}function o(t){if(!a.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}i.keys=function(){return Object.keys(s)},i.resolve=o,t.exports=i,i.id=65},88:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"spatial_targeting",name:"Spatial Targeting",subtitle:"Projectile upgrade that syncs its spatial awareness with the user.",icon:"/assets/img/icon/upgrades/unique/spatialtargeting.png",type:s.Tq.UNIQUE,rarity:s._8.SUPERIOR,unique:!0,func:t=>{t.unique.includes("spatial_targeting")||t.unique.push("spatial_targeting")}}}},96:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"phoenix_module",name:"Phoenix Module",subtitle:"Return from the flames with vengeance.",icon:"/assets/img/icon/upgrades/unique/phoenixmodule.png",type:s.Tq.UNIQUE,rarity:s._8.LEGENDARY,unique:!0,func:t=>{t.unique.includes("phoenix_module")||t.unique.push("phoenix_module")}}}},136:(t,e,a)=>{var s={"./carepackage/carepackage":751,"./carepackage/carepackage.ts":751};function i(t){var e=o(t);return a(e)}function o(t){if(!a.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}i.keys=function(){return Object.keys(s)},i.resolve=o,t.exports=i,i.id=136},152:(t,e,a)=>{"use strict";var s,i,o,r,n,l;a.d(e,{Tq:()=>o,VA:()=>s,_8:()=>i,mA:()=>l,o7:()=>n,wr:()=>r}),function(t){t.Perlin="perlin",t.Worley="worley",t.Voronoi="voronoi",t.Ridged="ridged"}(s||(s={})),function(t){t[t.COMMON=0]="COMMON",t[t.UNCOMMON=1]="UNCOMMON",t[t.SPECIAL=2]="SPECIAL",t[t.SUPERIOR=3]="SUPERIOR",t[t.RARE=4]="RARE",t[t.EXCEPTIONAL=5]="EXCEPTIONAL",t[t.LEGENDARY=6]="LEGENDARY",t[t.MYTHICAL=7]="MYTHICAL",t[t.ENLIGHTENED=8]="ENLIGHTENED",t[t.HOLY=9]="HOLY"}(i||(i={})),function(t){t.EQUIPMENT="equipment",t.RESOURCE="resource",t.STAT="stat",t.UNIQUE="unique"}(o||(o={})),function(t){t[t.Liquid=0]="Liquid",t[t.Solid=1]="Solid",t[t.Gas=2]="Gas"}(r||(r={})),function(t){t[t.Sticky=.7]="Sticky",t[t.Wet=.755]="Wet",t[t.Soft=.8]="Soft",t[t.Normal=.825]="Normal",t[t.Hard=.85]="Hard",t[t.Slick=.9]="Slick"}(n||(n={})),function(t){t[t.Water=.915]="Water"}(l||(l={}))},168:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"hemoglobin_saturator",name:"Hemoglobin Saturator",subtitle:"Increases red blood cell density for extended durability.",icon:"/assets/img/icon/upgrades/stats/hemoglobinsaturator.png",type:s.Tq.STAT,rarity:s._8.UNCOMMON,unique:!1,func:e=>{t.playerState.updateStat("stats.health.max",e.stats.health.max+10),t.playerState.updateStat("stats.health.value",e.stats.health.max)}}}},204:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"locomotion_module",name:"Locomotion Module",subtitle:"Primitave locomotion module installed on the user's footwear.",icon:"/assets/img/icon/upgrades/stats/locomotionmodule.png",type:s.Tq.STAT,rarity:s._8.COMMON,unique:!1,func:e=>{t.playerState.updateStat("stats.speed",e.stats.speed+1),t.playerState.updateStat("actions.dash.cooldown",1.5*e.actions.dash.cooldown)}}}},224:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"cluster_module",name:"Cluster Module",subtitle:"Cluster enhancement module for primary attacks.",icon:"/assets/img/icon/upgrades/unique/clustermodule.png",type:s.Tq.UNIQUE,rarity:s._8.RARE,unique:!0,func:t=>{t.unique.includes("cluster_module")||t.unique.push("cluster_module")}}}},358:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"muzzle_splitter",name:"Muzzle Splitter",subtitle:"Muzzle modification for primary attacks, requires certain skillset.",icon:"/assets/img/icon/upgrades/unique/muzzlesplitter.png",type:s.Tq.UNIQUE,rarity:s._8.SPECIAL,unique:!0,func:t=>{t.unique.includes("muzzle_splitter")||t.unique.push("muzzle_splitter")}}}},368:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"spectral_image",name:"Spectral Image",subtitle:"Forward imaging coordinate transponder.",icon:"/assets/img/icon/upgrades/unique/spectralimage.png",type:s.Tq.UNIQUE,rarity:s._8.EXCEPTIONAL,unique:!0,func:e=>{e.unique.includes("spectral_image")||(e.unique.push("spectral_image"),t.playerState.updateStat("actions.dash.time",e.actions.dash.time+50))}}}},528:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"bioregulator",name:"Bioregulator",subtitle:"Increases energy regulation efficiency, with a small boot overhead.",icon:"/assets/img/icon/upgrades/stats/bioregulator.png",type:s.Tq.STAT,rarity:s._8.COMMON,unique:!1,func:e=>{t.playerState.updateStat("stats.stamina.max",1.1*e.stats.stamina.max),t.playerState.updateStat("stats.stamina.recovery.rate",e.stats.stamina.recovery.rate+1),t.playerState.updateStat("stats.stamina.recovery.delay",1.25*e.stats.stamina.recovery.delay)}}}},612:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"damage_buffer",name:"Damage Buffer",subtitle:"Type D125 buffer, which improves damage at a small cost. ",icon:"/assets/img/icon/upgrades/stats/damagebuffer.png",type:s.Tq.STAT,rarity:s._8.UNCOMMON,unique:!1,func:e=>{t.playerState.updateStat("actions.primary.projectile.damage",1.1*e.actions.primary.projectile.damage),t.playerState.updateStat("actions.primary.buffer",1.1*e.actions.primary.buffer)}}}},617:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"switch",name:"Switch",subtitle:"Completely legal and completely functional.",icon:"/assets/img/icon/upgrades/equipment/switch.png",type:s.Tq.EQUIPMENT,rarity:s._8.RARE,unique:!1,func:e=>{e.equipment.includes("switch")||(e.equipment.push("switch"),t.playerState.updateStat("actions.primary.projectile.spread",e.actions.primary.projectile.spread*=1.15))}}}},748:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"kinetic_brain",name:"Kinetic Brain",subtitle:"Cerebral kinetic stem implant, unable to function at maximum capacity.",icon:"/assets/img/icon/upgrades/unique/kineticbrain.png",type:s.Tq.UNIQUE,rarity:s._8.EXCEPTIONAL,unique:!0,func:t=>{t.unique.includes("kinetic_brain")||t.unique.push("kinetic_brain")}}}},751:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"care_package",name:"Care Package",subtitle:"These are hard to come by.",icon:"/assets/img/icon/upgrades/resource/carepackage.png",type:s.Tq.RESOURCE,rarity:s._8.COMMON,unique:!1,func:e=>{e.actions.primary.magazine.currentReserve+=20,t.ui.ammoReservesUIController.spawnAmmoInReserveUI(20)}}}},800:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"projectile_array",name:"Projectile Array",subtitle:"Chance to fire an array of extra projectiles.",icon:"/assets/img/icon/upgrades/unique/projectilearray.png",type:s.Tq.UNIQUE,rarity:s._8.RARE,unique:!0,func:t=>{t.unique.includes("projectile_array")||t.unique.push("projectile_array")}}}},823:(t,e,a)=>{var s={"./bioregulator/bioregulator":528,"./bioregulator/bioregulator.ts":528,"./damagebuffer/damagebuffer":612,"./damagebuffer/damagebuffer.ts":612,"./hemoglobinsaturator/hemoglobinsaturator":168,"./hemoglobinsaturator/hemoglobinsaturator.ts":168,"./locomotionmodule/locomotionmodule":204,"./locomotionmodule/locomotionmodule.ts":204};function i(t){var e=o(t);return a(e)}function o(t){if(!a.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}i.keys=function(){return Object.keys(s)},i.resolve=o,t.exports=i,i.id=823},854:(t,e,a)=>{var s={"./switch/switch":617,"./switch/switch.ts":617};function i(t){var e=o(t);return a(e)}function o(t){if(!a.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}i.keys=function(){return Object.keys(s)},i.resolve=o,t.exports=i,i.id=854}},e={};function a(s){var i=e[s];if(void 0!==i)return i.exports;var o=e[s]={exports:{}};return t[s](o,o.exports,a),o.exports}a.d=(t,e)=>{for(var s in e)a.o(e,s)&&!a.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";const t=["/assets/img/effects/shrapnel/shrapnel_00.png","/assets/img/effects/shrapnel/shrapnel_01.png","/assets/img/effects/shrapnel/shrapnel_02.png","/assets/img/effects/shrapnel/shrapnel_03.png","/assets/img/effects/shrapnel/shrapnel_04.png","/assets/img/effects/shrapnel/shrapnel_05.png"],e={BASE:"/assets/img/object/ammobox/base.png",BULLETS:"/assets/img/object/ammobox/bullets.png",LID:"/assets/img/object/ammobox/lid.png"},s=3200,i=2400,o=15,r=800,n=600,l={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,SELECT:8,START:9,L_STICK:10,R_STICK:11,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,HOME:16,AXES:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},h={CHARACTER_SIZE:650,CONNECTION_TIMEOUT:1e3,CONTROLS:{KEYBINDS:{MELEE:"mouse2",MOVE_UP:"w",MOVE_LEFT:"a",MOVE_DOWN:"s",MOVE_RIGHT:"d",RELOAD:"r",SPRINT:"shift",ATTACK:"mouse1",DASH:" "},GAMEPAD:{MELEE:l.RB,DASH:l.LB,DEADZONE:.2,RELOAD:l.A,SPRINT:l.LT,ATTACK:l.RT}},DATA:{ID_LENGTH:8},GAME_END_DELAY:5e3,GRAPHICS:{PHYSICS:{AMMORESERVES:!0},STATIC_OVERLAY:!0,BACKGROUND_PARTICLES:!0},MAX_PLAYERS:4,MAX_WINS:5,RECONNECT_DELAY:3e3,ROUND_END_DELAY:3e3,NEW_ROUND_DELAY:500},d={KEYS:["Control","Shift","Alt","-","+"],REQUIRED_COUNT:5};class c{constructor(t,e){this.cacheManager=t,this.ui=e,this.adminKeysHeld=new Set,this.initKeyListener(),this.initConsoleKeybinds()}initKeyListener(){window.addEventListener("keydown",t=>{this.adminKeysHeld.add(t.key),this.checkAdminCombo()}),window.addEventListener("keyup",t=>{this.adminKeysHeld.delete(t.key)})}checkAdminCombo(){d.KEYS.every(t=>this.adminKeysHeld.has(t))&&this.adminKeysHeld.size===d.REQUIRED_COUNT&&(this.adminKeysHeld.clear(),this.showAdminModal())}showAdminModal(){this.ui.modal&&this.ui.modalInput&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalErrorDiv&&this.ui.modalText&&(this.ui.modal.classList.remove("hidden"),this.ui.modalConfirmButton.classList.remove("hidden"),this.ui.modalInput.value="",this.ui.modalInput.style.display="block",this.ui.modalErrorDiv.textContent="",this.ui.modalText.textContent="Enter Admin Command.",this.ui.modalConfirmButton.textContent="Execute",this.ui.modalCancelButton.textContent="Cancel",this.ui.modalInput.focus(),this.ui.modalConfirmButton.onclick=()=>{if(!this.ui.modalInput||!this.ui.modalErrorDiv)return;const t=this.ui.modalInput.value.trim();if(!t.includes(":"))return void(this.ui.modalErrorDiv.textContent="Invalid format.");const[e,a]=t.split(":");e&&a?(this.executeAdminCommand(e.trim(),a.trim()),this.ui.closeModal()):this.ui.modalErrorDiv.textContent="Invalid format."},this.ui.modalCancelButton.onclick=()=>this.ui.closeModal())}executeAdminCommand(t,e){console.log(`Admin command: ${t} with key: ${e}`),this.onAdminCommand?.(t,e)}initConsoleKeybinds(){document.addEventListener("keydown",t=>{t.getModifierState("Control")&&"`"===t.key&&(t.preventDefault(),this.clearCacheCommand())})}clearCacheCommand(){this.cacheManager.clear().then(()=>{console.log("Cache cleared! Reload the page."),location.reload()})}}class m{constructor(t,e,a){this.playerState=t,this.roomManager=e,this.userId=a,this.characterAnimations=new Map,this.characterOffsets=new Map}clear(){this.characterAnimations.clear(),this.characterOffsets.clear()}animateCharacterPart(t){this.generateCharacterAnimation(t),this.roomManager.sendMessage(JSON.stringify({type:"character-animation",params:t}))}rotateCharacterPart(t,e){if(t===this.userId)this.playerState.myPlayer.transform.rot=e;else{const a=this.playerState.players.get(t);if(!a)return;a.transform.rot=e}const a=Date.now();Math.abs(e-this.playerState.lastSentRotation)>.1&&a-this.playerState.lastSentRotationTime>=25&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{rot:this.playerState.myPlayer.transform.rot}})),this.playerState.lastSentRotation=e,this.playerState.lastSentRotationTime=a)}animateCharacterPartNetwork(t){this.generateCharacterAnimation(t)}generateCharacterAnimation(t){const{playerId:e,part:a,frames:s,duration:i,partIndex:o}=t,r=`${e}_${a}_${o||0}`;this.characterAnimations.set(r,{playerId:e,part:a,partIndex:o,frames:s,duration:i,startTime:Date.now(),originalOffset:{x:0,y:0}})}updateCharacterAnimations(t){const e=[],a=Date.now();this.characterAnimations.forEach((t,s)=>{const i=(a-t.startTime)/t.duration;if(0!==t.duration&&i>=1)return void e.push(s);const o=Object.keys(t.frames).map(Number).sort((t,e)=>t-e);let r,n,l=0;for(let t=0;t<o.length-1;t++){const e=o[t],a=o[t+1];if(i>=e&&i<a){l=t;break}}if(i>=1){const e=t.frames[o[o.length-1]];r=e.x,n=e.y}else{const e=t.frames[o[l]],a=t.frames[o[l+1]]||e,s=(i-o[l])/(o[l+1]-o[l])||0;r=e.x+(a.x-e.x)*s,n=e.y+(a.y-e.y)*s}this.characterOffsets.set(s,{x:r,y:n})}),e.forEach(t=>{this.characterAnimations.delete(t),this.characterOffsets&&this.characterOffsets.delete(t)})}}class u{constructor(){this.dbName="SaltpeterCache",this.dbVersion=3,this.db=null,this.initDB()}async initDB(){return new Promise((t,e)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>e(a.error),a.onsuccess=()=>{this.db=a.result,t()},a.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains("settings")||e.createObjectStore("settings")}})}async write(t,e){return this.db||await this.initDB(),new Promise((a,s)=>{const i=this.db.transaction(["settings"],"readwrite").objectStore("settings").put(e,t);i.onerror=()=>s(i.error),i.onsuccess=()=>a()})}async read(t){return this.db||await this.initDB(),new Promise((e,a)=>{const s=this.db.transaction(["settings"],"readonly").objectStore("settings").get(t);s.onerror=()=>a(s.error),s.onsuccess=()=>e(s.result)})}async delete(t){return this.db||await this.initDB(),new Promise((e,a)=>{const s=this.db.transaction(["settings"],"readwrite").objectStore("settings").delete(t);s.onerror=()=>a(s.error),s.onsuccess=()=>e()})}async clear(){return this.db||await this.initDB(),new Promise((t,e)=>{const a=this.db.transaction(["settings"],"readwrite").objectStore("settings").clear();a.onerror=()=>e(a.error),a.onsuccess=()=>t()})}}class g{constructor(t,e){this.playerState=t,this.utility=e,this.pos={x:0,y:0},this.targetPos={x:0,y:0},this.config={followSpeed:.1,lookAhead:100}}update(t){const e=this.playerState.myPlayer.transform.rot-Math.PI/2,a=this.utility.forward(e),s=a.x*this.config.lookAhead,i=a.y*this.config.lookAhead;this.targetPos.x=this.playerState.myPlayer.transform.pos.x+s-400,this.targetPos.y=this.playerState.myPlayer.transform.pos.y+i-300,this.targetPos.x=Math.max(0,Math.min(2400,this.targetPos.x)),this.targetPos.y=Math.max(0,Math.min(1800,this.targetPos.y)),this.pos.x+=(this.targetPos.x-this.pos.x)*this.config.followSpeed*t,this.pos.y+=(this.targetPos.y-this.pos.y)*this.config.followSpeed*t}worldToScreen(t){return{x:t.x-this.pos.x,y:t.y-this.pos.y}}screenToWorld(t){return{x:t.x+this.pos.x,y:t.y+this.pos.y}}isVisible(t,e=50){return t.x>=this.pos.x-e&&t.x<=this.pos.x+r+e&&t.y>=this.pos.y-e&&t.y<=this.pos.y+n+e}}class p{constructor(){this.weapon={glock:["/assets/img/weapon/glock/body.png","/assets/img/weapon/glock/slide.png"],knife:["/assets/img/weapon/melee/knife_00.png"]},this.magazine={glock:{empty:"/assets/img/object/weapons/glock/magazine_empty.png",full:"/assets/img/object/weapons/glock/magazine_full.png"}},this.body={default:"/assets/img/char/body/default.png"},this.head={default:"/assets/img/char/head/default.png",blondeAfro:"/assets/img/char/head/blonde_afro.png"},this.headwear={default:"/assets/img/char/headwear/default.png",fez:"/assets/img/char/headwear/fez.png",strawHat:"/assets/img/char/headwear/straw_hat.png",trucker:"/assets/img/char/headwear/trucker.png"},this.upgrades={kineticBrain:"/assets/img/char/upgrades/kineticbrain.png"},this.characterDecals={default:{blood:["/assets/img/effects/blood/blood_00.png","/assets/img/effects/blood/blood_01.png","/assets/img/effects/blood/blood_02.png","/assets/img/effects/blood/blood_03.png","/assets/img/effects/blood/blood_04.png"],gore:["/assets/img/effects/gore/gore_00.png","/assets/img/effects/gore/gore_01.png","/assets/img/effects/gore/gore_02.png","/assets/img/effects/gore/gore_03.png","/assets/img/effects/gore/gore_04.png","/assets/img/effects/gore/gore_05.png","/assets/img/effects/gore/gore_06.png","/assets/img/effects/gore/gore_07.png","/assets/img/effects/gore/gore_08.png","/assets/img/effects/gore/gore_09.png","/assets/img/effects/gore/gore_10.png","/assets/img/effects/gore/gore_11.png","/assets/img/effects/gore/gore_12.png","/assets/img/effects/gore/gore_13.png"]}}}}class y{constructor(t){this.charConfig=t}getCharacterAsset(t,e){switch(t){case"body":return this.charConfig.body[e]||this.charConfig.body.default;case"weapon":return this.charConfig.weapon[e]||this.charConfig.weapon.glock;case"head":return this.charConfig.head[e]||this.charConfig.head.default;case"headwear":return this.charConfig.headwear[e]||this.charConfig.headwear.default;case"upgrades":return e;default:throw new Error(`Unknown character layer: ${t}`)}}getUpgradeVisual(t){const e=t.toLowerCase();return this.charConfig.upgrades[e]||null}}class f{constructor(t){this.settingsManager=t,this.activeKeys=new Set,this.gamepadKeys=new Set,this.previousKeys=new Set,this.mousePos={x:0,y:0},this.gamepadConnected=!1,this.gamepadConnectionEnabled=!0,this.gamepadRAxis=null,this.initGamepad()}clear(){this.clearActiveKeys(),this.gamepadRAxis=null,this.mousePos.x=0,this.mousePos.y=0}held(t){return this.activeKeys.has(t)}triggered(t){return this.activeKeys.has(t)&&!this.previousKeys.has(t)}getActiveKeys(){return this.activeKeys}addKey(t){this.activeKeys.add(t)}removeKey(t){this.activeKeys.delete(t)}clearActiveKeys(){this.activeKeys.clear(),this.gamepadKeys.clear(),this.previousKeys.clear()}updatePreviousKeys(){this.previousKeys=new Set(this.activeKeys)}getMousePos(){return this.mousePos}setMousePos(t){this.mousePos.x=t.x,this.mousePos.y=t.y}initGamepad(){window.addEventListener("gamepadconnected",()=>{console.log("Gamepad connected!"),this.gamepadConnected=!0}),window.addEventListener("gamepaddisconnected",()=>{console.log("Gamepad disconnected!"),this.gamepadConnected=!1})}pollGamepad(){if(!this.gamepadConnected)return;const t=navigator.getGamepads()[0];if(!t)return;const e=this.settingsManager.getSettings(),a=e.controls.keybinds,s=e.controls.gamepad,i=s.deadzone;this.gamepadKeys.forEach(t=>this.activeKeys.delete(t)),this.gamepadKeys.clear();const o=t.axes[0],r=t.axes[1];o>i&&(this.activeKeys.add(a.moveRight),this.gamepadKeys.add(a.moveRight)),o<-i&&(this.activeKeys.add(a.moveLeft),this.gamepadKeys.add(a.moveLeft)),r>i&&(this.activeKeys.add(a.moveDown),this.gamepadKeys.add(a.moveDown)),r<-i&&(this.activeKeys.add(a.moveUp),this.gamepadKeys.add(a.moveUp)),t.buttons[s.melee].pressed&&(this.activeKeys.add(a.melee),this.gamepadKeys.add(a.melee)),t.buttons[s.dash].pressed&&(this.activeKeys.add(a.dash),this.gamepadKeys.add(a.dash)),t.buttons[s.reload].pressed&&(this.activeKeys.add(a.reload),this.gamepadKeys.add(a.reload)),t.buttons[s.attack].pressed&&(this.activeKeys.add(a.attack),this.gamepadKeys.add(a.attack)),t.buttons[s.sprint].pressed&&(this.activeKeys.add(a.sprint),this.gamepadKeys.add(a.sprint));const n=t.axes[2],l=t.axes[3],h=Math.sqrt(n*n+l*l);this.gamepadRAxis=h>i?Math.atan2(l,n)+Math.PI/2:null}getGamepadRAxis(){return this.gamepadRAxis}}class w{constructor(t,e,a,s,i){this.objectsManager=t,this.playerState=e,this.roomManager=a,this.ui=s,this.userId=i}checkCollisions(t){this.playerState.myPlayer.transform.pos.x=Math.max(15,Math.min(3185,this.playerState.myPlayer.transform.pos.x)),this.playerState.myPlayer.transform.pos.y=Math.max(15,Math.min(2385,this.playerState.myPlayer.transform.pos.y)),this.checkObjectCollisions(t),this.checkPlayersCollisions(t)}checkObjectCollisions(t){if(!this.collisionsEnabled(this.playerState.myPlayer))return;const e=this.getPlayerCollider(this.playerState.myPlayer,5);this.objectsManager.ammoBoxes.forEach((t,a)=>{if(t.isOpen)return;const s=this.playerState.myPlayer.transform.pos.x-t.transform.pos.x,i=this.playerState.myPlayer.transform.pos.y-t.transform.pos.y;if(Math.sqrt(s*s+i*i)<=e){const e=this.playerState.myPlayer.actions.primary.magazine.currentReserve,s=this.playerState.myPlayer.actions.primary.magazine.maxReserve,i=Math.min(t.ammoAmount,s-e);if(i>0){this.playerState.myPlayer.actions.primary.magazine.currentReserve+=i,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(i),console.log(`Picked up ammo box! +${i} bullets. Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`);const e=Math.random()*Math.PI*2,s=2+3*Math.random();t.isOpen=!0,t.lid.velocity={x:Math.cos(e)*s,y:Math.sin(e)*s},t.lid.torque=.3*(Math.random()-.5),this.roomManager.sendMessage(JSON.stringify({type:"ammo-pickup",ammoBoxId:a,playerId:this.userId,boxState:{isOpen:!0,lid:t.lid}}))}}})}checkPlayersCollisions(t){this.collisionsEnabled(this.playerState.myPlayer)&&this.playerState.players.forEach(t=>{if(!this.collisionsEnabled(t))return;const e=this.playerState.myPlayer.transform.pos.x-t.transform.pos.x,a=this.playerState.myPlayer.transform.pos.y-t.transform.pos.y,s=Math.sqrt(e*e+a*a),i=this.getPlayerCollider(this.playerState.myPlayer)+this.getPlayerCollider(t);if(s<i&&s>.01){const t=i-s,o=e/s*t,r=a/s*t;this.playerState.myPlayer.transform.pos.x+=o,this.playerState.myPlayer.transform.pos.y+=r}})}getPlayerCollider(t,e){let a=t.stats.size/4;return e&&e>0&&(a=t.stats.size/4+e),a}collisionsEnabled(t){return!(t.stats.health.value<=0||t.flags.hidden&&t.flags.invulnerable)}}class x{constructor(){this.decals={projectile:{radius:{min:4,max:8},density:{min:.175,max:.35},opacity:{min:.15,max:.25},variation:.215,colors:["#000000","#191919","#39362d"]},blood:{radius:{min:5,max:17.5},density:{min:.1,max:.175},opacity:{min:.275,max:.315},variation:.5,colors:["#781414","#710606","#a10101"]},explosion:{radius:{min:25,max:40},density:{min:.375,max:.575},opacity:{min:.35,max:.525},variation:.2,colors:["#434343","#2a2a2a","#3b1d1d"]}}}}class b{constructor(t,e,a,s,i,o,r,n){this.camera=t,this.charConfig=e,this.playerState=a,this.renderingManager=s,this.roomManager=i,this.ui=o,this.userId=r,this.utility=n,this.dynamicDecals=new Map,this.staticDecalData=null,this.decalsConfig=new x}clear(){this.dynamicDecals.clear(),this.staticDecalData=null}createDecal(t){this.generateDecal(t),this.roomManager.sendMessage(JSON.stringify({type:"add-decal",params:t}))}createDecalNetwork(t){this.dynamicDecals.has(t.id)||this.generateDecal(t)}generateDecal(t){if(!this.ui.decalCtx)return;const{x:e,y:a}=t.pos;e<0||e>s||a<0||a>i||("parametric"===t.type&&t.parametric?this.generateParametricDecal(t.pos,t.parametric):"image"===t.type&&t.image&&this.generateImageDecal(t.pos,t.image),this.dynamicDecals.set(t.id,{params:t,pos:{x:e,y:a}}))}generateParametricDecal(t,e){if(!this.ui.decalCtx)return;const a=e.radius.min+Math.random()*(e.radius.max-e.radius.min),o=e.density.min+Math.random()*(e.density.max-e.density.min),r=e.opacity.min+Math.random()*(e.opacity.max-e.opacity.min),n=Math.floor(a*a*Math.PI*o);this.ui.decalCtx.save(),this.ui.decalCtx.globalCompositeOperation="source-over";for(let o=0;o<n;o++){const o=Math.random()*Math.PI*2,n=Math.random()*a,l=t.x+Math.cos(o)*n,h=t.y+Math.sin(o)*n;if(l<0||l>=s||h<0||h>=i)continue;const d=e.colors[Math.floor(Math.random()*e.colors.length)],c=this.utility.hexToRgb(d);if(!c)continue;const m=r+(Math.random()-.5)*e.variation,u=Math.max(.05,Math.min(.6,m));this.ui.decalCtx.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, ${u})`,this.ui.decalCtx.fillRect(Math.floor(l),Math.floor(h),1,1)}this.ui.decalCtx.restore()}generateImageDecal(t,e){if(!this.ui.decalCtx)return;let a=new Image;a.src=e.src;const s=()=>{if(!this.ui.decalCtx)return;if(!a.complete||0===a.naturalWidth)return;this.ui.decalCtx.save(),this.ui.decalCtx.translate(t.x,t.y),this.ui.decalCtx.rotate(e.rotation);const s=32*e.scale;this.ui.decalCtx.drawImage(a,-s/2,-s/2,s,s),this.ui.decalCtx.restore()};a.complete?s():a.onload=s}generateGore(t){const e=[...this.charConfig.characterDecals.default.gore];for(let a=0;a<t.gore.amount&&e.length>0;a++){const s=this.utility.getRandomInArray(e);e.splice(e.indexOf(s),1);const i=this.utility.getRandomNum(0,2*Math.PI),o=this.utility.getRandomNum(0,t.radius),r={type:"gore",src:s,transform:{pos:{x:t.pos.x+Math.cos(i)*o,y:t.pos.y+Math.sin(i)*o},rot:this.utility.getRandomNum(0,2*Math.PI)},scale:this.utility.getRandomNum(.65,1.05)},n=`death_gore_${t.ownerId}_${Date.now()}_${a}`;this.stampGore(r),this.dynamicDecals.set(n,{params:null,pos:{x:r.transform.pos.x,y:r.transform.pos.y}})}const a=[...this.charConfig.characterDecals.default.blood];for(let e=0;e<t.blood.amount&&a.length>0;e++){const s=this.utility.getRandomInArray(a);a.splice(a.indexOf(s),1);const i=this.utility.getRandomNum(0,2*Math.PI),o=this.utility.getRandomNum(0,.7*t.radius),r={type:"blood",src:s,transform:{pos:{x:t.pos.x+Math.cos(i)*o,y:t.pos.y+Math.sin(i)*o},rot:this.utility.getRandomNum(0,2*Math.PI)},scale:this.utility.getRandomNum(1.25,1.45)},n=`death_blood_${t.ownerId}_${Date.now()}_${e}`;this.stampGore(r),this.dynamicDecals.set(n,{params:null,pos:{x:r.transform.pos.x,y:r.transform.pos.y}})}}stampGore(t){if(!this.ui.decalCtx)return;const e=t.transform.pos;this.ui.decalCtx.save(),this.ui.decalCtx.translate(e.x,e.y),this.ui.decalCtx.rotate(t.transform.rot);let a=this.renderingManager.characterImages.get(t.src);if(!a&&(a=new Image,a.src=t.src,this.renderingManager.characterImages.set(t.src,a),!a.complete))return void(a.onload=()=>{this.stampGore(t)});if(!a.complete||0===a.naturalWidth)return;const s=32*t.scale;this.ui.decalCtx.drawImage(a,-s/2,-s/2,s,s),this.ui.decalCtx.restore()}bakeDecals(){if(!this.ui.decalCtx)return;const t=this.ui.decalCtx.getImageData(0,0,s,i);if(this.staticDecalData)for(let e=0;e<t.data.length;e+=4){const a=t.data[e+3];if(a>0){const s=a/255,i=this.staticDecalData.data[e+3]/255;this.staticDecalData.data[e]=t.data[e]*s+this.staticDecalData.data[e]*i*(1-s),this.staticDecalData.data[e+1]=t.data[e+1]*s+this.staticDecalData.data[e+1]*i*(1-s),this.staticDecalData.data[e+2]=t.data[e+2]*s+this.staticDecalData.data[e+2]*i*(1-s),this.staticDecalData.data[e+3]=Math.min(255,a+this.staticDecalData.data[e+3])}}else this.staticDecalData=t;this.dynamicDecals.clear(),this.ui.decalCtx.clearRect(0,0,s,i)}renderBakedDecals(){this.staticDecalData&&this.ui.decalCtx&&this.ui.decalCtx.putImageData(this.staticDecalData,0,0)}spawnMagazineDecal(){setTimeout(()=>{const t=this.playerState.myPlayer.actions.primary.magazine.currentAmmo,e=this.playerState.myPlayer.inventory.primary,a=t>0?this.charConfig.magazine[e].full:this.charConfig.magazine[e].empty,s=this.utility.getRandomNum(0,2*Math.PI),i=this.utility.getRandomNum(8,24),o=this.playerState.myPlayer.transform.pos.x+Math.cos(s)*i,r=this.playerState.myPlayer.transform.pos.y+Math.sin(s)*i,n=this.utility.getRandomNum(0,2*Math.PI),l=this.utility.getRandomNum(.65,.75),h={id:`magazine_${this.userId}_${Date.now()}`,pos:{x:o,y:r},type:"image",image:{src:a,scale:l,rotation:n}};this.createDecal(h),console.log(`Spawned ${t>0?"full":"empty"} magazine at reload`)},150)}}class S{constructor(t,e,a,s,i,o,r,n,l,h,d){this.animator=t,this.audioManager=e,this.camera=a,this.chatManager=s,this.controlsManager=i,this.gameState=o,this.roomController=r,this.playerState=n,this.settingsManager=l,this.ui=h,this.userId=d}initEventListeners(){this.ui.canvas&&this.ui.hostButton&&this.ui.joinButton&&this.ui.quickplayButton&&this.ui.lobbyLeaveButton&&this.ui.lobbyCodeButton&&this.ui.gameLeaveButton&&this.ui.gameCodeButton&&this.ui.startGameBtn&&this.ui.chatSendBtn&&this.ui.chatInput&&(this.ui.hostButton.addEventListener("click",()=>this.roomController.hostRoom()),this.ui.joinButton.addEventListener("click",()=>this.roomController.joinRoom()),this.ui.quickplayButton.addEventListener("click",()=>this.roomController.quickPlay()),this.ui.lobbyLeaveButton.addEventListener("click",()=>this.roomController.leaveRoom()),this.ui.lobbyCodeButton.addEventListener("click",()=>this.roomController.copyRoomCode()),this.ui.gameLeaveButton.addEventListener("click",()=>this.roomController.leaveRoom()),this.ui.gameCodeButton.addEventListener("click",()=>this.roomController.copyRoomCode()),this.ui.startGameBtn.addEventListener("click",()=>this.onStartButtonClick()),this.ui.chatSendBtn.addEventListener("click",()=>this.chatManager.sendChatMessage(this.userId)),this.ui.chatInput.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.chatManager.sendChatMessage(this.userId))}),this.ui.chatInput.addEventListener("focus",()=>{this.controlsManager.clearActiveKeys(),this.playerState.canShoot=!1,this.playerState.isSprinting=!1,this.playerState.isDashing=!1,this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0}),this.ui.chatInput.addEventListener("blur",()=>{this.controlsManager.clearActiveKeys(),this.playerState.canShoot=!0,this.playerState.isSprinting=!1,this.playerState.isDashing=!1}),this.ui.settingsButton?.addEventListener("click",()=>{this.ui.showSettingsPage()}),this.ui.settingsCloseButton?.addEventListener("click",()=>{this.ui.hideSettingsPage()}),window.addEventListener("contextmenu",t=>{t.preventDefault()}),document.addEventListener("keydown",t=>this.onKeyDown(t)),document.addEventListener("keyup",t=>this.onKeyUp(t)),document.addEventListener("mouseup",t=>this.onMouseUp(t)),document.addEventListener("mousemove",t=>this.onMouseMove(t)),this.ui.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)),this.ui.switchSettingsPage("sound"),this.ui.controlsTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("controls")}),this.ui.graphicsTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("graphics")}),this.ui.soundTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("sound")}),this.ui.controlsBody?.addEventListener("click",()=>{this.ui.controlsBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("controls")}),this.ui.graphicsBody?.addEventListener("click",()=>{this.ui.graphicsBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("graphics")}),this.ui.soundBody?.addEventListener("click",()=>{this.ui.soundBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("sound")}),this.initSettingsAudioSliders(),this.initSettingsInputListeners(),this.initSettingsToggleListeners())}onKeyDown(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress||this.gameState.isPaused)return;const e=t.key.toLowerCase(),a=this.settingsManager.getSettings().controls.keybinds;Object.values(a).includes(e)&&(t.preventDefault(),this.controlsManager.addKey(e))}onKeyUp(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress)return;const e=t.key.toLowerCase(),a=this.settingsManager.getSettings().controls.keybinds;Object.values(a).includes(e)&&(t.preventDefault(),this.controlsManager.removeKey(e))}onMouseDown(t){this.ui.chatInput!==document.activeElement&&this.gameState.gameInProgress&&!this.gameState.isPaused&&this.ui.canvas&&(0===t.button?(this.updateMouse(t),this.controlsManager.addKey("mouse1")):1===t.button?this.controlsManager.addKey("mouse3"):2===t.button&&(this.updateMouse(t),this.controlsManager.addKey("mouse2")))}onMouseUp(t){this.ui.chatInput!==document.activeElement&&this.gameState.gameInProgress&&(0===t.button?this.controlsManager.removeKey("mouse1"):1===t.button?this.controlsManager.addKey("mouse3"):2===t.button&&this.controlsManager.removeKey("mouse2"))}onMouseMove(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress||this.gameState.isPaused)return;this.updateMouse(t);const e=this.controlsManager.getMousePos(),a=this.camera.screenToWorld(e),s=a.x-this.playerState.myPlayer.transform.pos.x,i=a.y-this.playerState.myPlayer.transform.pos.y,o=Math.sqrt(s*s+i*i),r=Math.atan2(i,s)+Math.PI/2;let n=1;o<100&&(n=.1+o/100*.9);const l=this.playerState.myPlayer.transform.rot,h=l+(r-l)*n;this.animator.rotateCharacterPart(this.userId,h)}updateMouse(t){if(this.ui.chatInput===document.activeElement)return;if(!this.ui.canvas)return;const e=this.ui.canvas.getBoundingClientRect(),a=t.clientX-e.left,s=t.clientY-e.top;this.controlsManager.setMousePos({x:a,y:s})}onStartButtonClick(){const t=new CustomEvent("customEvent_startGame");window.dispatchEvent(t)}initSettingsAudioSliders(){[{slider:this.ui.masterSlider,fill:this.ui.masterFill,value:this.ui.masterValue,channel:"master"},{slider:this.ui.ambienceSlider,fill:this.ui.ambienceFill,value:this.ui.ambienceValue,channel:"ambience"},{slider:this.ui.musicSlider,fill:this.ui.musicFill,value:this.ui.musicValue,channel:"music"},{slider:this.ui.sfxSlider,fill:this.ui.sfxFill,value:this.ui.sfxValue,channel:"sfx"},{slider:this.ui.voiceSlider,fill:this.ui.voiceFill,value:this.ui.voiceValue,channel:"voice"}].forEach(({slider:t,fill:e,value:a,channel:s})=>{t&&e&&a&&t.addEventListener("mousedown",i=>{const o=i=>{const o=this.ui.calculateSliderValue(t,i.clientX);this.ui.updateSettingsSlider(e,a,o),this.settingsManager.updateSettings({audio:{mixer:{[s]:{...this.settingsManager.getSettings().audio.mixer[s],volume:o}}}})},r=()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",r),this.audioManager.updateMixerGains()};o(i),document.addEventListener("mousemove",o),document.addEventListener("mouseup",r),i.preventDefault()})})}initSettingsInputListeners(){[{input:this.ui.deadzoneInput,settingPath:"controls.gamepad.deadzone",parse:parseFloat}].forEach(({input:t,settingPath:e,parse:a})=>{t&&t.addEventListener("change",()=>{const s=t.value,i=a(s);if(isNaN(i))return;const o=e.split("."),r={};let n=r;for(let t=0;t<o.length-1;t++)n[o[t]]={},n=n[o[t]];n[o[o.length-1]]=i,this.settingsManager.updateSettings(r)})})}initSettingsToggleListeners(){[{toggle:this.ui.particleJSToggle,settingPath:"graphics.renderBackgroundParticles"},{toggle:this.ui.staticVfxToggle,settingPath:"graphics.showStaticOverlay"},{toggle:this.ui.ammoReservesPhysicsToggle,settingPath:"graphics.physics.ammoReserves"}].forEach(({toggle:t,settingPath:e})=>{t&&t.addEventListener("click",()=>{const a=!("true"===t.getAttribute("aria-checked"));a?(t.setAttribute("checked","true"),t.setAttribute("aria-checked","true")):(t.removeAttribute("checked"),t.setAttribute("aria-checked","false"));const s=e.split("."),i={};let o=i;for(let t=0;t<s.length-1;t++)o[s[t]]={},o=o[s[t]];o[s[s.length-1]]=a,this.settingsManager.updateSettings(i)})})}initKeybindListeners(){const t=this.settingsManager.getSettings().controls;this.ui.initKeybindsInterface(t,(t,e,a)=>this.onBindingChange(t,e,a))}onBindingChange(t,e,a){if("keybind"===e){this.settingsManager.updateSettings({controls:{keybinds:{[t]:a}}});const e=document.getElementById(`${t}Keybind`);e&&(e.textContent=" "===a?"SPACE":a.toUpperCase())}else{this.settingsManager.updateSettings({controls:{gamepad:{[t]:a}}});const e=document.getElementById(`${t}Gamepad`);if(e){const t=Object.keys(l).find(t=>"number"==typeof l[t]&&l[t]===a);e.textContent=t||a.toString()}}}}class v{constructor(){this.isPaused=!1,this.gameInProgress=!1,this.gameMaxWins=h.MAX_WINS,this.gameMaxPlayers=h.MAX_PLAYERS}clear(){this.gameInProgress=!1,this.isPaused=!1,this.gameMaxWins=h.MAX_WINS,this.gameMaxPlayers=h.MAX_PLAYERS}}class C{constructor(t,e,a,s,i,o,r){this.characterManager=t,this.playerConfig=e,this.playerState=a,this.roomManager=s,this.settingsManager=i,this.ui=o,this.utility=r,this.inLobby=!1,this.lobbyPlayers=new Map,this.charCustomizeHandlers=[]}showLobbyControls(t){const{lobby:e,lobbyOptions:a,myPlayer:s,roomId:i,userId:o}=t,{isHost:r,maxWins:n,privateRoom:l,upgradesEnabled:h}=a;this.ui.updateDisplay(e,"lobby",i);const d=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,c=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyPlayers.set(o,{id:o,color:s.color,isHost:r,rig:this.settingsManager.getSettings().character.rig,transform:{pos:{x:d,y:c},rot:0}}),this.setupLobbyOptions(a);const m={inputId:"winsInput",value:n},u={toggleId:"privateToggle",value:l},g={toggleId:"upgradesToggle",value:h};this.utility.setToggle(u),this.utility.setToggle(g),this.utility.setInput(m),this.ui.displayLobbyPlayers(r,e,o),this.ui.updateHostDisplay(r,e),window.dispatchEvent(new CustomEvent("customEvent_renderCharacter")),this.setupCharacterCustomization()}setupLobbyOptions(t){this.setupLobbyToggle("privateToggle",t.isHost,"privateRoom",()=>t.privateRoom,e=>t.privateRoom=e),this.setupLobbyToggle("upgradesToggle",t.isHost,"upgradesEnabled",()=>t.upgradesEnabled,e=>t.upgradesEnabled=e),this.setupLobbyInput("winsInput",t.isHost,"maxWins",()=>t.maxWins,e=>t.maxWins=e),this.setupLobbyInput("playersInput",t.isHost,"maxPlayers",()=>t.maxPlayers,e=>t.maxPlayers=e)}setupLobbyToggle(t,e,a,s,i){const o=this.ui[t];if(!o)return;const r=`${t}Handler`;this[r]&&o.removeEventListener("click",this[r]);const n=()=>{if(!e)return;const o=!s();i(o);const r={toggleId:t,value:o};this.utility.setToggle(r),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",[a]:o})),console.log(`${a} changed to: ${o}`)};this[r]=n,o.addEventListener("click",n)}setupLobbyInput(t,e,a,s,i){const o=this.ui[t];if(!o)return;const r=`${t}Handler`;this[r]&&o.removeEventListener("change",this[r]);const n=()=>{if(!e)return;const r=parseInt(o.value);if(isNaN(r)||r<1)return void(o.value=s().toString());i(r);const n={inputId:t,value:r};this.utility.setInput(n),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",[a]:r})),console.log(`${a} changed to: ${r}`)};this[r]=n,o.addEventListener("change",n)}syncLobbyOptions(t){this.syncOption(t,"privateRoom","isPrivateRoom","privateToggle",this.utility.setToggle.bind(this.utility),"Lobby privacy",t=>t?"Private":"Public"),this.syncOption(t,"maxWins","gameMaxWins","winsInput",this.utility.setInput.bind(this.utility),"Game max wins"),this.syncOption(t,"maxPlayers","gameMaxPlayers","playersInput",this.utility.setInput.bind(this.utility),"Game max players"),this.syncOption(t,"upgradesEnabled","isUpgradesEnabled","upgradesToggle",this.utility.setToggle.bind(this.utility),"Game upgrades toggled")}syncOption(t,e,a,s,i,o,r){if(void 0===t[e])return;this[a]=t[e],i(s.includes("Input")?{inputId:s,value:t[e]}:{toggleId:s,value:t[e]});const n=r?r(t[e]):t[e];console.log(`${o} synced to: ${n}`)}promotePlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"promote-player",targetPlayerId:t}))}kickPlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"kick-player",targetPlayerId:t}))}setupCharacterCustomization(){if(!(this.ui.bodyArrowLeft&&this.ui.bodyArrowRight&&this.ui.headArrowLeft&&this.ui.headArrowRight&&this.ui.headwearArrowLeft&&this.ui.headwearArrowRight))return;if(!this.lobbyPlayers.get(this.playerState.myPlayer.id))return;this.charCustomizeHandlers.forEach(({element:t,handler:e})=>{t.removeEventListener("click",e)}),this.charCustomizeHandlers=[];const t=(t,e)=>{this.charCustomizeHandlers.push({element:t,handler:e}),t.addEventListener("click",e)};t(this.ui.bodyArrowLeft,()=>this.cycleRigVariant("body",-1)),t(this.ui.bodyArrowRight,()=>this.cycleRigVariant("body",1)),t(this.ui.headArrowLeft,()=>this.cycleRigVariant("head",-1)),t(this.ui.headArrowRight,()=>this.cycleRigVariant("head",1)),t(this.ui.headwearArrowLeft,()=>this.cycleRigVariant("headwear",-1)),t(this.ui.headwearArrowRight,()=>this.cycleRigVariant("headwear",1))}cycleRigVariant(t,e){const a=this.lobbyPlayers.get(this.playerState.myPlayer.id);if(!a)return;const s=Object.keys(this.characterManager.charConfig[t]),i=a.rig[t];let o=s.indexOf(i)+e;o<0?o=s.length-1:o>=s.length&&(o=0),a.rig[t]=s[o],this.settingsManager.updateSettings({character:{rig:a.rig}}),window.dispatchEvent(new CustomEvent("customEvent_renderCharacter"))}}class M{constructor(t,e){this.playerState=t,this.utility=e,this.ammoBoxes=new Map}clear(){this.ammoBoxes.clear()}spawnObject(t){const e={id:this.utility.generateUID(h.DATA.ID_LENGTH),transform:t.transform,timestamp:Date.now()};if("AmmoBox"===t.type)return{id:e.id,transform:e.transform,timestamp:e.timestamp,ammoAmount:t.data?.amount||10,isOpen:!1,lid:{pos:{x:0,y:0},rot:0,velocity:{x:0,y:0},torque:0}};throw new Error(`Unknown object type: ${t.type}`)}spawnAmmoBox(t){return this.spawnObject({type:"AmmoBox",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},data:{amount:t}})}}class I{constructor(){this.goreParticles={blood:{drip:{count:{min:1,max:4},lifetime:{min:800,max:1e3},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.25,max:.75},speed:{min:.25,max:.75},sizeOverLifetime:{min:0,max:0},size:{min:.125,max:2.275},torque:{min:-720,max:720},collide:!0,fade:!0,paint:!1,spread:.25,stain:!0,colors:["#690303","#820c0c","#a70707"]},spray:{count:{min:4,max:12},lifetime:{min:150,max:1200},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.425,max:.775},speed:{min:1.5,max:4.75},sizeOverLifetime:{min:0,max:0},size:{min:.75,max:3.5},torque:{min:-720,max:720},collide:!0,fade:!1,paint:!0,spread:.425,stain:!0,colors:["#7e0a0a","#941414","#b51a1a"]}}},this.weaponParticles={glock:{muzzle:{smoke:{count:{min:3,max:6},lifetime:{min:800,max:1400},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.15,max:.35},speed:{min:.5,max:1.5},size:{min:4,max:8},sizeOverLifetime:{min:2,max:3},torque:{min:-180,max:180},collide:!1,fade:!0,paint:!1,spread:.4,stain:!1,colors:["#5a5a5a","#7a7a7a"]},flash:{count:{min:8,max:15},lifetime:{min:150,max:300},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.4,max:.8},speed:{min:4,max:10},sizeOverLifetime:{min:0,max:0},size:{min:1,max:3},torque:{min:0,max:0},collide:!1,fade:!0,paint:!1,spread:.6,stain:!1,colors:["#ffaa00","#f3b02a","#edbe60"]}},projectile:{shell:{count:{min:1,max:1},lifetime:{min:250,max:550},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:1,max:1},speed:{min:5,max:8},sizeOverLifetime:{min:0,max:0},size:{min:2,max:2},torque:{min:-720,max:720},collide:!0,fade:!1,paint:!0,spread:.4,stain:!1,colors:["#d4af37","#c69e1c","#dcb01f"]},sparks:{count:{min:8,max:16},lifetime:{min:150,max:300},noise:{strength:{min:.25,max:5},scale:{min:.25,max:1.5}},opacity:{min:.4,max:.8},speed:{min:4,max:10},size:{min:1,max:3},sizeOverLifetime:{min:0,max:0},torque:{min:-720,max:720},collide:!1,fade:!0,paint:!1,spread:.6,stain:!1,colors:["#ffaa00","#ffcf70","#f9dea7"]}}}}}}class P{constructor(t,e,a,s,i,o,r,n,l,h){this.camera=t,this.charConfig=e,this.collisionsManager=a,this.decalsManager=s,this.playerState=i,this.renderingManager=o,this.roomManager=r,this.ui=n,this.userId=l,this.utility=h,this.particles=new Map,this.emitters=new Map,this.shrapnel=new Map,this.particlesConfig=new I}clear(){this.particles.clear(),this.emitters.clear(),this.shrapnel.clear()}createParticles(t){this.generateParticles(t),this.roomManager.sendMessage(JSON.stringify({type:"add-particles",params:t}))}createParticlesNetwork(t){this.particles.has(t.id)||this.generateParticles(t)}generateParticles(t){const e=t.particleParams,a=Math.floor(this.utility.getRandomNum(e.count.min,e.count.max));for(let s=0;s<a;s++){const a=this.utility.getRandomNum(e.lifetime.min,e.lifetime.max),i=this.utility.getRandomNum(e.speed.min,e.speed.max),o=this.utility.getRandomNum(e.size.min,e.size.max),r=this.utility.getRandomNum(e.opacity.min,e.opacity.max),n=this.utility.getRandomNum(e.torque.min,e.torque.max),l=this.utility.getRandomNum(e.noise.strength.min,e.noise.strength.max),h=this.utility.getRandomNum(e.noise.scale.min,e.noise.scale.max),d=this.utility.getRandomNum(e.sizeOverLifetime.min,e.sizeOverLifetime.max),c=this.utility.getRandomInArray(e.colors);let m;m=t.direction?Math.atan2(t.direction.y,t.direction.x)+(this.utility.getRandomNum(0,1)-.5)*e.spread:this.utility.getRandomNum(0,2*Math.PI);const u={age:0,collide:e.collide,color:c,fade:e.fade,hasCollided:!1,id:`${t.id}_${s}`,initialSize:o,lifetime:a,maxOpacity:r,noiseScale:h,noiseStrength:l,opacity:r,paint:e.paint,pos:{x:t.pos.x,y:t.pos.y},size:o,stain:e.stain,torque:n,rotation:this.utility.getRandomNum(0,2*Math.PI),sizeOverLifetime:d,velocity:{x:Math.cos(m)*i,y:Math.sin(m)*i}};this.particles.set(u.id,u)}}updateParticles(t){const e=[];this.particles.forEach((a,o)=>{if(a.noiseStrength>0&&a.noiseScale>0){const e=.001*Date.now(),s=this.utility.simplexNoise2D(a.pos.x/a.noiseScale,e),i=this.utility.simplexNoise2D(a.pos.y/a.noiseScale,e+100);a.velocity.x+=s*a.noiseStrength*t,a.velocity.y+=i*a.noiseStrength*t}if(a.sizeOverLifetime>0){const t=a.age/a.lifetime;a.size=a.initialSize*(1+t*a.sizeOverLifetime)}if(a.pos.x+=a.velocity.x*t,a.pos.y+=a.velocity.y*t,a.age+=16.67*t,a.rotation+=a.torque*Math.PI/180*t,a.fade){const t=a.age/a.lifetime;a.opacity=a.maxOpacity*(1-t)}if(a.hasCollided&&a.stain){this.stampParticle(a);const t=(a.age-(a.lifetime-.5*a.lifetime))/(.5*a.lifetime);t>0&&(a.size=Math.max(.5,a.size*(1-.1*t)),a.opacity=a.opacity*(1-t))}if(a.age>=a.lifetime||a.pos.x<-10||a.pos.x>3210||a.pos.y<-10||a.pos.y>2410){if(a.collide&&a.age>=a.lifetime&&a.pos.x>=0&&a.pos.x<=s&&a.pos.y>=0&&a.pos.y<=i&&!a.hasCollided){a.hasCollided=!0;const t=.875+.1*Math.random();a.velocity.x*=1-t,a.velocity.y*=1-t;const e=.5*a.lifetime;return void(a.lifetime+=e)}a.paint&&!a.stain&&a.age>=a.lifetime&&a.pos.x>=0&&a.pos.x<=s&&a.pos.y>=0&&a.pos.y<=i&&this.stampParticle(a),e.push(o)}}),e.forEach(t=>this.particles.delete(t))}drawParticles(){this.ui.ctx&&this.particles.forEach(t=>{if(!this.camera.isVisible(t.pos))return;const e=this.camera.worldToScreen(t.pos),a=this.utility.hexToRgb(t.color);a&&this.ui.ctx&&(this.ui.ctx.save(),this.ui.ctx.globalAlpha=t.opacity,0!==t.torque?(this.ui.ctx.translate(e.x+t.size/2,e.y+t.size/2),this.ui.ctx.rotate(t.rotation),this.ui.ctx.fillStyle=`rgb(${a.r}, ${a.g}, ${a.b})`,this.ui.ctx.fillRect(-t.size/2,-t.size/2,t.size,t.size)):(this.ui.ctx.fillStyle=`rgb(${a.r}, ${a.g}, ${a.b})`,this.ui.ctx.fillRect(Math.floor(e.x),Math.floor(e.y),t.size,t.size)),this.ui.ctx.restore())})}stampParticle(t){if(!this.ui.decalCtx)return;const e=this.utility.hexToRgb(t.color);if(!e)return;this.ui.decalCtx.save(),this.ui.decalCtx.globalCompositeOperation="source-over",0!==t.torque?(this.ui.decalCtx.translate(t.pos.x+t.size/2,t.pos.y+t.size/2),this.ui.decalCtx.rotate(t.rotation),this.ui.decalCtx.fillStyle=`rgba(${e.r}, ${e.g}, ${e.b}, ${t.opacity})`,this.ui.decalCtx.fillRect(-t.size/2,-t.size/2,t.size,t.size)):(this.ui.decalCtx.fillStyle=`rgba(${e.r}, ${e.g}, ${e.b}, ${t.opacity})`,this.ui.decalCtx.fillRect(Math.floor(t.pos.x),Math.floor(t.pos.y),t.size,t.size)),this.ui.decalCtx.restore();const a=`stamp_${Date.now()}`;this.decalsManager.dynamicDecals.set(a,{params:null,pos:{x:t.pos.x,y:t.pos.y}})}createEmitter(t){this.generateEmitter(t);const e={type:"particle-emitter",id:t.id,interval:t.interval,lifetime:t.lifetime,offset:{x:t.offset.x,y:t.offset.y},pos:{x:t.pos.x,y:t.pos.y},particleType:t.particleType,playerId:t.playerId};this.roomManager.sendMessage(JSON.stringify(e)),console.log(`Emitter created on ${t.playerId} for ${t.lifetime}ms`)}generateEmitter(t){const e=t.pos.x-t.offset.x,a=t.pos.y-t.offset.y,s=Math.atan2(a,e);this.emitters.set(t.id,{age:0,direction:s,emissionInterval:t.interval,lastEmission:0,lifetime:t.lifetime,offset:{x:e,y:a},particleType:t.particleType,playerId:t.playerId})}updateEmitters(t){const e=[];this.emitters.forEach((a,s)=>{a.age+=16.67*t;const i=a.playerId===this.userId?this.playerState.myPlayer:this.playerState.players.get(a.playerId);if(!i||i.stats.health.value<=0)return void e.push(s);const o=i.transform.pos.x+a.offset.x,r=i.transform.pos.y+a.offset.y;if(a.age>=a.lastEmission+a.emissionInterval){const t=.6*Math.PI,e=(Math.random()-.5)*t,i=a.direction+e,n=3,l=4*(Math.random()-.5),h=Math.max(.5,n+l),d={id:`emitter_particles_${s}_${a.age}`,pos:{x:o+8*(Math.random()-.5),y:r+8*(Math.random()-.5)},particleParams:a.particleType,direction:{x:Math.cos(i)*h,y:Math.sin(i)*h}};this.generateParticles(d),a.lastEmission=a.age,a.emissionInterval=120+180*Math.random()}if(a.age>=a.lifetime){const t={id:`emitter_decal_${s}`,pos:{x:o,y:r},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.blood};this.decalsManager.generateDecal(t),e.push(s)}}),e.forEach(t=>this.emitters.delete(t))}spawnShrapnel(t){const e=[];for(let a=0;a<t.amount;a++){const s=this.utility.getRandomNum(0,2*Math.PI),i=this.utility.getRandomNum(t.speed.min,t.speed.max),o=this.utility.getRandomNum(t.lifetime.min,t.lifetime.max),r=this.utility.getRandomNum(t.size.min,t.size.max),n=this.utility.getRandomNum(t.torque.min,t.torque.max)*(Math.PI/180),l={id:this.utility.generateUID(h.DATA.ID_LENGTH),image:t.images[a],transform:{pos:{x:t.pos.x,y:t.pos.y},rot:this.utility.getRandomNum(0,2*Math.PI)},velocity:{x:Math.cos(s)*i,y:Math.sin(s)*i},rotationSpeed:n,size:r,age:0,lifetime:o,ownerId:this.userId,damage:t.damage};e.push(l),this.shrapnel.set(l.id,l)}this.roomManager.sendMessage(JSON.stringify({type:"shrapnel-spawn",pieces:e})),console.log(`Spawned ${e.length} shrapnel pieces`)}generateShrapnel(t){t.forEach(t=>{this.shrapnel.set(t.id,t)}),console.log(`Received ${t.length} shrapnel pieces from network`)}updateShrapnel(t){if(0===this.shrapnel.size)return;const e=[];this.shrapnel.forEach((a,o)=>{a.transform.pos.x+=a.velocity.x*t,a.transform.pos.y+=a.velocity.y*t,a.transform.rot+=a.rotationSpeed*t,a.age+=16.67*t,a.velocity.x*=.98,a.velocity.y*=.98,a.ownerId===this.userId&&this.playerState.players.forEach((t,s)=>{if(t.stats.health.value>0){const i=a.transform.pos.x-t.transform.pos.x,r=a.transform.pos.y-t.transform.pos.y;if(Math.sqrt(i*i+r*r)<=this.collisionsManager.getPlayerCollider(t,a.size)){const i=Math.max(0,a.damage-t.stats.defense),r=Math.max(0,t.stats.health.value-i);t.stats.health.value=r,e.push(o),console.log(`Shrapnel hit ${s} for ${a.damage} damage`);const n={target:t,shooterId:this.userId,damage:a.damage,newHealth:r,source:a,wasKill:r<=0};window.dispatchEvent(new CustomEvent("customEvent_playerHitRelay",{detail:{params:n}}))}}}),(a.age>=a.lifetime||a.transform.pos.x<0||a.transform.pos.x>s||a.transform.pos.y<0||a.transform.pos.y>i)&&(a.transform.pos.x>=0&&a.transform.pos.x<=s&&a.transform.pos.y>=0&&a.transform.pos.y<=i&&this.stampShrapnel(a),e.push(o))}),e.forEach(t=>this.shrapnel.delete(t))}drawShrapnel(){this.ui.ctx&&0!==this.shrapnel.size&&this.shrapnel.forEach(t=>{if(!this.ui.ctx)return;if(!this.camera.isVisible(t.transform.pos))return;const e=this.camera.worldToScreen(t.transform.pos);let a=this.renderingManager.characterImages.get(t.image);(a||(a=new Image,a.src=t.image,this.renderingManager.characterImages.set(t.image,a),a.complete))&&a.complete&&0!==a.naturalWidth&&(this.ui.ctx.save(),this.ui.ctx.translate(e.x,e.y),this.ui.ctx.rotate(t.transform.rot),this.ui.ctx.drawImage(a,-t.size/2,-t.size/2,t.size,t.size),this.ui.ctx.restore())})}stampShrapnel(t){if(!this.ui.decalCtx)return;if(!this.camera.isVisible(t.transform.pos))return;const e=this.camera.worldToScreen(t.transform.pos);let a=this.renderingManager.characterImages.get(t.image);a&&a.complete&&0!==a.naturalWidth&&(this.ui.decalCtx.save(),this.ui.decalCtx.translate(e.x,e.y),this.ui.decalCtx.rotate(t.transform.rot),this.ui.decalCtx.drawImage(a,-t.size/2,-t.size/2,t.size,t.size),this.ui.decalCtx.restore(),this.decalsManager.dynamicDecals.set(`shrapnel_${t.id}`,{params:null,pos:{x:t.transform.pos.x,y:t.transform.pos.y}}))}}class _{constructor(t,e,a,s,i,o,r,n){this.animator=t,this.camera=e,this.charManager=a,this.lobbyManager=s,this.objectsManager=i,this.playerConfig=o,this.ui=r,this.userId=n,this.characterImages=new Map,this.ammoBoxImages={},this.initEventListeners()}clearCtx(t){t?t.clearRect(0,0,r,n):this.ui.decalCtx&&this.ui.ctx&&(this.ui.ctx.clearRect(0,0,r,n),this.ui.decalCtx.clearRect(0,0,s,i))}drawCharacter(t){const{player:e,context:a}=t;if(a&&e){if("stats"in e){if(e.stats.health.value<=0)return;if(this.renderUniqueEffects(t),e.flags.hidden)return;if(!this.camera.isVisible(e.transform.pos))return;const s=this.camera.worldToScreen(e.transform.pos);a.fillStyle="#fff",a.font="12px Arial",a.textAlign="center";const i=e.id===this.userId?"You":e.id.substring(0,6);a.fillText(i,s.x,s.y-this.playerConfig.default.data.idOffset)}this.drawCharacterLayers(t)}}drawCharacterLayers(t){const e=t.player;e&&(this.drawCharacterLayer(t,"body",e.rig.body),this.drawCharacterLayer(t,"weapon",e.rig.weapon),this.drawCharacterLayer(t,"head",e.rig.head),this.drawCharacterLayer(t,"headwear",e.rig.headwear),"stats"in e&&this.drawUpgradeLayers(t))}drawCharacterLayer(t,e,a){if(!t)return;const s=this.charManager.getCharacterAsset(e,a);"string"==typeof s?this.drawCharacterPart(t,s,e):Array.isArray(s)&&s.forEach((a,s)=>{this.drawCharacterPart(t,a,e,s)})}drawCharacterPart(t,e,a,s){const{context:i,player:o}=t;if(!i||!o)return;let r=this.characterImages.get(e);if(!r&&(r=new Image,r.src=e,this.characterImages.set(e,r),r.onload=()=>{this.renderLobbyPlayer()},!r.complete))return;if(!r.complete||0===r.naturalWidth)return;const n="stats"in o?h.CHARACTER_SIZE*(o.stats.size/h.CHARACTER_SIZE):.35*h.CHARACTER_SIZE,l=o.transform?.pos?.x??0,d=o.transform?.pos?.y??0,c="stats"in o&&void 0!==o.transform.rot,m=c?this.camera.worldToScreen({x:l,y:d}).x:l,u=c?this.camera.worldToScreen({x:l,y:d}).y:d;if(i.save(),c){const t=`${o.id}_${a}_${s||0}`,e=this.animator.characterOffsets?.get(t)||{x:0,y:0};i.translate(m,u),i.rotate(o.transform.rot),i.translate(e.x,e.y),i.drawImage(r,-n/2,-n/2,n,n)}else i.drawImage(r,m-n/2,u-n/2,n,n);i.restore()}drawUpgradeLayers(t){const{player:e}=t;"unique"in e&&(e.unique.forEach(e=>{const a=this.charManager.getUpgradeVisual(e);a&&this.drawCharacterPart(t,a,"upgrades")}),e.equipment.forEach(e=>{const a=this.charManager.getUpgradeVisual(e);a&&this.drawCharacterPart(t,a,"upgrades")}))}renderUniqueEffects(t){const{player:e}=t;e&&"unique"in e&&e.unique.includes("spectral_image")&&this.renderSpectralImage(t)}renderSpectralImage(t){const{context:e,player:a}=t;if(!e||!a||!("stats"in a))return;const s=this._spectralGhosts??(this._spectralGhosts={lastHidden:new Map,flashes:[]}),i=Date.now(),o=s.lastHidden.get(a.id)??!1,r=a.flags.hidden;!o&&r&&s.flashes.push({x:a.transform.pos.x,y:a.transform.pos.y,t:i,type:"start",playerId:a.id}),o&&!r&&s.flashes.push({x:a.transform.pos.x,y:a.transform.pos.y,t:i,type:"end",playerId:a.id}),s.lastHidden.set(a.id,r);for(const t of s.flashes){if(t.playerId!==a.id)continue;const s=i-t.t;if(s>a.actions.dash.time)continue;const o=this.camera.worldToScreen({x:t.x,y:t.y}),r="start"===t.type?1-s/a.actions.dash.time:s/a.actions.dash.time;e.save(),e.globalAlpha=.8*r,e.globalCompositeOperation="difference",e.filter="saturate(100) contrast(2)";const n={...a,transform:{...a.transform,pos:{x:o.x,y:o.y}}};this.drawCharacterLayers({player:n,context:e}),e.restore()}}renderLobbyPlayer(){if(!this.lobbyManager.inLobby)return;const t=this.lobbyManager.lobbyPlayers.get(this.userId);if(!t||!this.ui.charCustomizeCanvas)return;const e=this.ui.charCustomizeCanvas.getContext("2d");e&&(e.clearRect(0,0,this.ui.charCustomizeCanvas.width,this.ui.charCustomizeCanvas.height),this.drawCharacter({player:t,context:e}))}drawObjects(){this.ui.ctx&&this.objectsManager.ammoBoxes.forEach(t=>{if(!this.ui.ctx)return;if(!this.camera.isVisible(t.transform.pos))return;this.ammoBoxImages||(this.ammoBoxImages={});const a=["BASE","BULLETS","LID"];if(a.forEach(t=>{if(!this.ammoBoxImages[t]){const a=new Image;a.src=e[t],this.ammoBoxImages[t]=a}}),!a.every(t=>this.ammoBoxImages[t]?.complete&&this.ammoBoxImages[t]?.naturalWidth>0))return;const s=35,i=this.camera.worldToScreen(t.transform.pos);t.isOpen&&(t.lid.velocity.x*=.85,t.lid.velocity.y*=.85,t.lid.torque*=.85,t.lid.pos.x+=t.lid.velocity.x,t.lid.pos.y+=t.lid.velocity.y,t.lid.rot+=t.lid.torque),this.ui.ctx.save(),this.ui.ctx.translate(i.x,i.y),this.ui.ctx.rotate(t.transform.rot||0),this.ui.ctx.drawImage(this.ammoBoxImages.BASE,-17.5,-17.5,s,s),t.isOpen||(this.ui.ctx.drawImage(this.ammoBoxImages.BULLETS,-17.5,-17.5,s,s),this.ui.ctx.drawImage(this.ammoBoxImages.LID,-17.5,-17.5,s,s)),this.ui.ctx.restore(),t.isOpen&&(this.ui.ctx.save(),this.ui.ctx.translate(i.x+t.lid.pos.x,i.y+t.lid.pos.y),this.ui.ctx.rotate((t.transform.rot||0)+t.lid.rot),this.ui.ctx.drawImage(this.ammoBoxImages.LID,-17.5,-17.5,s,s),this.ui.ctx.restore())})}drawProjectile(t){if(!this.ui.ctx)return;if(!this.camera.isVisible(t.transform.pos))return;const e=this.camera.worldToScreen(t.transform.pos),a=Math.sqrt(t.velocity.x*t.velocity.x+t.velocity.y*t.velocity.y),s=t.velocity.x/a,i=t.velocity.y/a,o=e.x+s*(t.length/2),r=e.y+i*(t.length/2),n=e.x-s*(t.length/2),l=e.y-i*(t.length/2);this.ui.ctx.fillStyle=t.color,this.ui.ctx.strokeStyle=t.color,this.ui.ctx.lineWidth=t.size,this.ui.ctx.lineCap="round",this.ui.ctx.beginPath(),this.ui.ctx.moveTo(n,l),this.ui.ctx.lineTo(o,r),this.ui.ctx.stroke()}initEventListeners(){window.addEventListener("customEvent_renderCharacter",()=>this.renderLobbyPlayer())}}class E{constructor(t,e,a,s,i,o,r,n,l){this.gameState=t,this.lobbyManager=e,this.playerState=a,this.roomManager=s,this.ui=i,this.upgradeManager=o,this.userId=r,this.utility=n,this.wsManager=l}showRoomControls(){this.ui.updateDisplay(this.lobbyManager,"room")}hostRoom(){if(this.wsManager.getWebSocket()){const t=this.roomManager.createRoom();if(!t)return;this.playerState.isHost=!0,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:t,userId:this.userId})}else this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{const t=this.roomManager.createRoom();t&&(this.playerState.isHost=!0,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:t,userId:this.userId}))},h.CONNECTION_TIMEOUT)}joinRoom(){this.ui.showJoinRoomModal(t=>{this.joinRoomById(t)})}joinRoomById(t){t&&(this.wsManager.getWebSocket()?this.roomManager.joinRoom(t):(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(t)},h.CONNECTION_TIMEOUT)))}quickPlay(){fetch("/quickplay").then(t=>{if(!t.ok)throw new Error("No available rooms");return t.json()}).then(t=>{this.wsManager.getWebSocket()?this.roomManager.joinRoom(t.roomId):(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(t.roomId)},h.CONNECTION_TIMEOUT))}).catch(t=>{this.ui.modal&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalContent&&this.ui.modalText&&this.ui.modalInput&&this.ui.modalErrorDiv&&this.ui.modalButtons&&(this.ui.modal.classList.remove("hidden"),this.ui.modalInput.style.display="none",this.ui.modalErrorDiv.textContent=" ",this.ui.modalButtons.style.display="flex",this.ui.modalCancelButton.style.display="none",this.ui.modalText.textContent="No available games found.",this.ui.modalConfirmButton.textContent="Confirm",this.ui.modalConfirmButton.onclick=()=>{this.ui.modal&&this.ui.modalInput&&this.ui.modalCancelButton&&this.ui.modalText&&this.ui.modalConfirmButton&&(this.ui.modal.classList.add("hidden"),this.ui.modalInput.style.display="flex",this.ui.modalText.textContent="Join Room",this.ui.modalCancelButton.style.display="flex",this.ui.modalConfirmButton.onclick=null)})})}leaveRoom(){this.roomManager.leaveRoom(),window.dispatchEvent(new CustomEvent("customEvent_resetGameState",{detail:{resetType:"Room"}})),this.showRoomControls()}checkForRoomInURL(){const t=this.getRoomIdFromURL();t&&(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(t)},h.CONNECTION_TIMEOUT))}getRoomIdFromURL(){return new URLSearchParams(window.location.search).get("room")}copyRoomCode(){const t=this.lobbyManager.inLobby?this.ui.roomIdDisplay?.textContent:this.ui.gameRoomIdDisplay?.textContent;t&&navigator.clipboard.writeText(t).then(()=>{if(!(this.ui.modal&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalContent&&this.ui.modalText&&this.ui.modalInput&&this.ui.modalErrorDiv&&this.ui.modalButtons))return;this.ui.modal.classList.remove("hidden"),this.ui.modalInput.style.display="none",this.ui.modalErrorDiv.textContent=" ",this.ui.modalButtons.style.display="flex",this.ui.modalCancelButton.style.display="none",this.ui.modalText.textContent="Room code copied!",this.ui.modalConfirmButton.textContent="Confirm";const t=()=>{this.ui.modal&&this.ui.modalInput&&this.ui.modalCancelButton&&this.ui.modalText&&this.ui.modalConfirmButton&&(this.ui.modal.classList.add("hidden"),this.ui.modalInput.style.display="flex",this.ui.modalText.textContent="Join Room",this.ui.modalCancelButton.style.display="flex",this.ui.modalConfirmButton.onclick=null)};this.ui.modalConfirmButton.onclick=t,this.utility.safeTimeout(()=>{this.ui.modal&&!this.ui.modal.classList.contains("hidden")&&t()},3e3)}).catch(()=>{alert("Could not copy. Please copy manually.")})}}class k{constructor(t,e){this.userId=t,this.utility=e,this.currentRoom=null,this.ws=null,this.messageHandlers=[],this.isPrivateRoom=!1}setWebSocket(t){this.ws=t,this.setupMessageHandler()}createRoom(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return alert("Cannot create room: Not connected to server. Please refresh the page."),null;const t=this.utility.generateUID(10,"room_");return this.joinRoom(t,!0),t}joinRoom(t,e=!1){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void alert("Cannot join room: Not connected to server. Please refresh the page.");const a={type:e?"create-room":"join-room",roomId:t,userId:this.userId};this.ws.send(JSON.stringify(a)),this.currentRoom=t,this.utility.generateLink(t,"room")}leaveRoom(){if(!this.currentRoom||!this.ws)return;const t={type:"leave-room",roomId:this.currentRoom,userId:this.userId};this.ws.send(JSON.stringify(t)),this.currentRoom=null,window.history.pushState({},"",window.location.origin)}sendMessage(t){if(!this.currentRoom||!this.ws)return;if(this.ws.readyState!==WebSocket.OPEN)return void alert("Cannot send message: Not connected to server. Please refresh the page.");const e={type:"room-message",roomId:this.currentRoom,userId:this.userId,message:t};this.ws.send(JSON.stringify(e))}sendAdminCommand(t,e){if(!this.ws)return;const a={type:"admin-command",id:t,key:e,userId:this.userId};this.ws.send(JSON.stringify(a))}getCurrentRoom(){return this.currentRoom}getRoomLink(t){return this.currentRoom?this.utility.generateLink(this.currentRoom,t):null}onMessage(t){this.messageHandlers.push(t)}setupMessageHandler(){this.ws&&(this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);this.messageHandlers.forEach(t=>t(e))}catch(e){const a={type:"room-message",userId:"server",message:t.data};this.messageHandlers.forEach(t=>t(a))}})}}class R{constructor(t,e,a){this.audioConfig=t,this.cacheManager=e,this.playerConfig=a,this.gameSettings=this.initSettings()}initSettings(){return{audio:{mixer:{master:this.audioConfig.mixer.master,ambience:this.audioConfig.mixer.ambience,music:this.audioConfig.mixer.music,sfx:this.audioConfig.mixer.sfx,voice:this.audioConfig.mixer.voice}},controls:{keybinds:{attack:h.CONTROLS.KEYBINDS.ATTACK,dash:h.CONTROLS.KEYBINDS.DASH,melee:h.CONTROLS.KEYBINDS.MELEE,moveDown:h.CONTROLS.KEYBINDS.MOVE_DOWN,moveLeft:h.CONTROLS.KEYBINDS.MOVE_LEFT,moveRight:h.CONTROLS.KEYBINDS.MOVE_RIGHT,moveUp:h.CONTROLS.KEYBINDS.MOVE_UP,reload:h.CONTROLS.KEYBINDS.RELOAD,sprint:h.CONTROLS.KEYBINDS.SPRINT},gamepad:{attack:h.CONTROLS.GAMEPAD.ATTACK,dash:h.CONTROLS.GAMEPAD.DASH,deadzone:h.CONTROLS.GAMEPAD.DEADZONE,melee:h.CONTROLS.GAMEPAD.MELEE,reload:h.CONTROLS.GAMEPAD.RELOAD,sprint:h.CONTROLS.GAMEPAD.SPRINT}},character:{rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon}},graphics:{physics:{ammoReserves:h.GRAPHICS.PHYSICS.AMMORESERVES},renderBackgroundParticles:h.GRAPHICS.BACKGROUND_PARTICLES,showStaticOverlay:h.GRAPHICS.STATIC_OVERLAY}}}getSettings(){return this.gameSettings}updateSettings(t){if(t.audio?.mixer){const e=t.audio.mixer;return Object.keys(e).forEach(t=>{const a=e[t];a&&"number"==typeof a.volume&&(this.gameSettings.audio.mixer[t].volume=a.volume)}),void this.cacheManager.write("gameSettings",this.gameSettings)}const e=(t,a)=>{for(const s in a)a[s]&&"object"==typeof a[s]&&!Array.isArray(a[s])?(t[s]||(t[s]={}),e(t[s],a[s])):t[s]=a[s]};e(this.gameSettings,t),this.cacheManager.write("gameSettings",this.gameSettings)}async loadSettings(){const t=await this.cacheManager.read("gameSettings");t&&(this.gameSettings=t)}}var T=a(152);const L={equipment:["switch"],resource:["carepackage"],stats:["bioregulator","damagebuffer","hemoglobinsaturator","locomotionmodule"],unique:["clustermodule","kineticbrain","muzzlesplitter","phoenixmodule","projectilearray","spatialtargeting","spectralimage"]};class A{constructor(t,e,a,s){this.playerConfig=t,this.playerState=e,this.ui=a,this.utility=s,this.takenUniques=new Set,this.upgradesCompleted=new Set,this.isUpgradesEnabled=!0,this.rarityConfig={[T._8.COMMON]:{weight:35,color:"#7e7e7e"},[T._8.UNCOMMON]:{weight:20,color:"#61b6d5"},[T._8.SPECIAL]:{weight:15,color:"#58d688"},[T._8.SUPERIOR]:{weight:12,color:"#ffc233"},[T._8.RARE]:{weight:8,color:"#0077ff"},[T._8.EXCEPTIONAL]:{weight:5,color:"#00ff62"},[T._8.LEGENDARY]:{weight:2.5,color:"#f6ff00"},[T._8.MYTHICAL]:{weight:1.5,color:"#ff0000"},[T._8.ENLIGHTENED]:{weight:.9,color:"#9500ff"},[T._8.HOLY]:{weight:.1,color:"#ff00f7"}},this.upgrades=[],this.initUpgrades()}initUpgrades(){const t={playerState:this.playerState,ui:this.ui,utility:this.utility};L.equipment.forEach(e=>{const s=a(854)(`./${e}/${e}`).create(t);this.upgrades.push(s)}),L.resource.forEach(e=>{const s=a(136)(`./${e}/${e}`).create(t);this.upgrades.push(s)}),L.stats.forEach(e=>{const s=a(823)(`./${e}/${e}`).create(t);this.upgrades.push(s)}),L.unique.forEach(e=>{const s=a(65)(`./${e}/${e}`).create(t);this.upgrades.push(s)})}getUpgrades(t,e){const a=this.upgrades.filter(t=>!(t.unique&&this.takenUniques.has(t.id)||t.type===T.Tq.EQUIPMENT&&e.equipment.includes(t.id))),s=[];for(let e=0;e<Math.min(t,a.length)&&0!==a.length;e++){const t=a.reduce((t,e)=>t+this.getRarityWeight(e.rarity),0);let e=Math.random()*t,i=null;for(const t of a)if(e-=this.getRarityWeight(t.rarity),e<=0){i=t;break}if(i){s.push(i);const t=a.indexOf(i);a.splice(t,1)}}return s}applyUpgrade(t,e){const a=this.upgrades.find(e=>e.id===t);return!(!a||(a.unique&&this.takenUniques.has(t)?(console.warn(`Unique upgrade ${t} already taken globally`),1):a.type===T.Tq.EQUIPMENT&&this.hasEquipment(e,t)?(console.warn(`Equipment ${t} already owned by player`),1):(a.unique&&this.takenUniques.add(t),a.func(e),0)))}removeUpgradeFromPool(t){this.takenUniques.add(t)}resetUpgrades(t){this.takenUniques.clear(),t.equipment=this.playerConfig.default.equipment,t.unique=this.playerConfig.default.unique}hasEquipment(t,e){return t.equipment.includes(e)}hasUnique(t,e){return t.unique.includes(e)}getRarityColor(t){return this.rarityConfig[t].color}getRarityWeight(t){return this.rarityConfig[t].weight}}class D{constructor(t,e,a){this.settings=t,this.ui=e,this.utility=a,this.ammoReserveIcon=null,this.projectileIcon=null,this.reserveBulletParticles=[]}clear(){this.reserveBulletParticles=[]}initAmmoReserveCanvas(){this.ammoReserveIcon=new Image,this.ammoReserveIcon.src="/assets/img/icon/inventory/ammobox.png",this.ammoReserveIcon.onload=()=>{this.renderAmmoReserves()},this.projectileIcon=new Image,this.projectileIcon.src="/assets/img/icon/inventory/9mm.png",this.settings.getSettings().graphics.physics.ammoReserves&&requestAnimationFrame(()=>this.updateAmmoReservePhysics())}spawnAmmoInReserveUI(t=1){if(!this.ui.ammoReservesCtx||!this.projectileIcon)return;const e=this.settings.getSettings().graphics.physics.ammoReserves,{collisionHeight:a,collisionWidth:s,collisionX:i,collisionY:o}=this.getAmmoReserveCollisionZone();for(let r=0;r<t;r++)this.utility.safeTimeout(()=>{if(e){const t=i+s,e=o+a/2,r=2+8*Math.random(),n=(Math.random()-.5)*(Math.PI/3),l=Math.cos(n)*r,h=Math.sin(n)*r,d=Math.random()*Math.PI*2,c=.1*(Math.random()-.5);this.reserveBulletParticles.push({transform:{pos:{x:t,y:e},rot:d},velocity:{x:l,y:h},torque:c,width:2.75,height:7})}else{const t=i+Math.random()*s,e=o+Math.random()*a,r=Math.random()*Math.PI*2;this.reserveBulletParticles.push({transform:{pos:{x:t,y:e},rot:r},velocity:{x:0,y:0},torque:0,width:2.75,height:7}),this.renderAmmoReserves()}},100*r)}removeAmmoFromReserveUI(t=1){for(let e=0;e<t;e++)this.utility.safeTimeout(()=>{this.reserveBulletParticles.length>0&&this.reserveBulletParticles.shift(),this.settings.getSettings().graphics.physics.ammoReserves||this.renderAmmoReserves()},100*e)}updateAmmoReservePhysics(){if(!this.settings.getSettings().graphics.physics.ammoReserves)return;if(!this.ui.ammoReservesCtx||!this.ammoReserveIcon)return;const{collisionHeight:t,collisionWidth:e,collisionX:a,collisionY:s}=this.getAmmoReserveCollisionZone();this.ui.ammoReservesCtx.clearRect(0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),this.ui.ammoReservesCtx.drawImage(this.ammoReserveIcon,0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height);for(let i of this.reserveBulletParticles)i.transform.pos.x+=i.velocity.x,i.transform.pos.y+=i.velocity.y,i.transform.rot+=i.torque,i.velocity.x*=.9,i.velocity.y*=.9,i.torque*=.9,i.transform.pos.x-i.width/2<a&&(i.transform.pos.x=a+i.width/2,i.velocity.x*=-.5),i.transform.pos.x+i.width/2>a+e&&(i.transform.pos.x=a+e-i.width/2,i.velocity.x*=-.5),i.transform.pos.y-i.height/2<s&&(i.transform.pos.y=s+i.height/2,i.velocity.y*=-.5),i.transform.pos.y+i.height/2>s+t&&(i.transform.pos.y=s+t-i.height/2,i.velocity.y*=-.5);for(let t=0;t<this.reserveBulletParticles.length;t++)for(let e=t+1;e<this.reserveBulletParticles.length;e++){const a=this.reserveBulletParticles[t],s=this.reserveBulletParticles[e],i=a.transform.pos.x-s.transform.pos.x,o=a.transform.pos.y-s.transform.pos.y,r=Math.sqrt(i*i+o*o),n=(a.width+s.width)/2;if(r<n){const t=Math.atan2(o,i),e=n-r,l=Math.cos(t)*e/2,h=Math.sin(t)*e/2;a.transform.pos.x+=l,a.transform.pos.y+=h,s.transform.pos.x-=l,s.transform.pos.y-=h;const d=a.velocity.x*Math.cos(t)+a.velocity.y*Math.sin(t),c=s.velocity.x*Math.cos(t)+s.velocity.y*Math.sin(t),m=(d+c)/2;a.velocity.x+=.5*(m-d),s.velocity.x+=.5*(m-c)}}for(let t of this.reserveBulletParticles)this.ui.ammoReservesCtx.save(),this.ui.ammoReservesCtx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.ammoReservesCtx.rotate(t.transform.rot),this.ui.ammoReservesCtx.drawImage(this.projectileIcon,-t.width/2,-t.height/2,t.width,t.height),this.ui.ammoReservesCtx.restore();requestAnimationFrame(()=>this.updateAmmoReservePhysics())}renderAmmoReserves(){if(this.ui.ammoReservesCtx&&this.ammoReserveIcon&&this.ammoReserveIcon.complete&&(this.ui.ammoReservesCtx.clearRect(0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),this.ui.ammoReservesCtx.drawImage(this.ammoReserveIcon,0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),!this.settings.getSettings().graphics.physics.ammoReserves))for(let t of this.reserveBulletParticles)this.ui.ammoReservesCtx.save(),this.ui.ammoReservesCtx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.ammoReservesCtx.rotate(t.transform.rot),this.ui.ammoReservesCtx.drawImage(this.projectileIcon,-t.width/2,-t.height/2,t.width,t.height),this.ui.ammoReservesCtx.restore()}getAmmoReserveCollisionZone(){return{collisionHeight:27,collisionWidth:63,collisionX:(this.ui.ammoReservesCanvas.width-63)/2-3,collisionY:(this.ui.ammoReservesCanvas.height-27)/2-1}}}class B{constructor(t,e,a){this.playerState=t,this.settingsManager=e,this.utility=a,this.leaderboard=new Map,this.ammoReservesCanvas=null,this.ammoReservesCtx=null,this.canvas=null,this.ctx=null,this.decalCanvas=null,this.decalCtx=null,this.worldCanvas=null,this.worldCtx=null,this.liquidCanvas=null,this.liquidCtx=null,this.postEffectsCanvas=null,this.postEffectsCtx=null,this.gameContainer=null,this.gameOptionsContainer=null,this.lobbyContainer=null,this.roomControls=null,this.upgradeContainer=null,this.gameRoomIdDisplay=null,this.lobbyPlayersList=null,this.roomIdDisplay=null,this.userIdDisplay=null,this.gameCodeButton=null,this.gameLeaveButton=null,this.hostButton=null,this.joinButton=null,this.lobbyCodeButton=null,this.lobbyLeaveButton=null,this.quickplayButton=null,this.startGameBtn=null,this.playersInput=null,this.privateToggle=null,this.upgradesToggle=null,this.winsInput=null,this.chatContainer=null,this.chatInput=null,this.chatMessages=null,this.chatSendBtn=null,this.charCustomizeContainer=null,this.charCustomizeCanvas=null,this.charCustomizeCtx=null,this.headwearArrowLeft=null,this.headArrowLeft=null,this.bodyArrowLeft=null,this.headwearArrowRight=null,this.headArrowRight=null,this.bodyArrowRight=null,this.modal=null,this.modalButtons=null,this.modalCancelButton=null,this.modalConfirmButton=null,this.modalContent=null,this.modalErrorDiv=null,this.modalInput=null,this.modalText=null,this.leaderboardBody=null,this.leaderboardContainer=null,this.settingsContainer=null,this.settingsButton=null,this.settingsCloseButton=null,this.controlsTab=null,this.graphicsTab=null,this.soundTab=null,this.controlsBody=null,this.graphicsBody=null,this.soundBody=null,this.masterSlider=null,this.masterFill=null,this.masterValue=null,this.ambienceSlider=null,this.ambienceFill=null,this.ambienceValue=null,this.musicSlider=null,this.musicFill=null,this.musicValue=null,this.sfxSlider=null,this.sfxFill=null,this.sfxValue=null,this.voiceSlider=null,this.voiceFill=null,this.voiceValue=null,this.deadzoneInput=null,this.particleJSToggle=null,this.staticVfxToggle=null,this.ammoReservesPhysicsToggle=null,this.accuracyStat=null,this.damageStat=null,this.luckStat=null,this.rangeStat=null,this.shotSpeedStat=null,this.speedStat=null,this.HUD_LERP_TIME=300,this.ammoReservesUIController=new D(this.settingsManager,this,this.utility),this.initInterfaceListeners()}clear(){this.ammoReservesUIController.clear(),this.clearLeaderboard()}initInterface(){if(this.canvas=document.getElementById("gameCanvas"),this.decalCanvas=document.createElement("canvas"),this.worldCanvas=document.createElement("canvas"),this.liquidCanvas=document.createElement("canvas"),this.postEffectsCanvas=document.createElement("canvas"),this.ammoReservesCanvas=document.getElementById("ammoReservesCanvas"),this.charCustomizeCanvas=document.getElementById("charCustomizeCanvas"),this.roomControls=document.getElementById("roomControls"),this.gameContainer=document.getElementById("gameContainer"),this.lobbyContainer=document.getElementById("lobbyContainer"),this.lobbyPlayersList=document.getElementById("lobbyPlayersList"),this.startGameBtn=document.getElementById("startGameBtn"),this.gameOptionsContainer=document.getElementById("gameOptionsContainer"),this.userIdDisplay=document.getElementById("userId"),this.roomIdDisplay=document.getElementById("roomId"),this.gameRoomIdDisplay=document.getElementById("gameRoomId"),this.chatContainer=document.getElementById("chatContainer"),this.chatMessages=document.getElementById("chatMessages"),this.chatInput=document.getElementById("chatInput"),this.chatSendBtn=document.getElementById("chatSendBtn"),this.charCustomizeContainer=document.getElementById("charCustomizeContainer"),this.headwearArrowLeft=document.getElementById("headwearArrowLeft"),this.headArrowLeft=document.getElementById("headArrowLeft"),this.bodyArrowLeft=document.getElementById("bodyArrowLeft"),this.headwearArrowRight=document.getElementById("headwearArrowRight"),this.headArrowRight=document.getElementById("headArrowRight"),this.bodyArrowRight=document.getElementById("bodyArrowRight"),this.privateToggle=document.getElementById("privateToggle"),this.upgradesToggle=document.getElementById("upgradesToggle"),this.winsInput=document.getElementById("winsInput"),this.playersInput=document.getElementById("playersInput"),this.upgradeContainer=document.getElementById("upgradeContainer"),this.leaderboardContainer=document.getElementById("leaderboardContainer"),this.leaderboardBody=document.getElementById("leaderboardBody"),this.hostButton=document.getElementById("atomHost"),this.joinButton=document.getElementById("atomJoin"),this.quickplayButton=document.getElementById("atomQuickplay"),this.lobbyLeaveButton=document.getElementById("lobbyLeaveBtn"),this.lobbyCodeButton=document.getElementById("lobbyCodeBtn"),this.gameLeaveButton=document.getElementById("gameLeaveBtn"),this.gameCodeButton=document.getElementById("gameCodeBtn"),this.modal=document.getElementById("modal"),this.modalInput=document.getElementById("joinRoomInput"),this.modalButtons=document.getElementById("modalButtons"),this.modalConfirmButton=document.getElementById("joinRoomConfirmBtn"),this.modalCancelButton=document.getElementById("joinRoomCancelBtn"),this.modalErrorDiv=document.getElementById("joinRoomError"),this.modalContent=document.getElementById("modalContent"),this.modalText=document.getElementById("modalText"),this.settingsContainer=document.getElementById("settingsContainer"),this.settingsButton=document.getElementById("atomSettings"),this.settingsCloseButton=document.getElementById("settingsCloseButton"),this.controlsTab=document.getElementById("controlsTab"),this.graphicsTab=document.getElementById("graphicsTab"),this.soundTab=document.getElementById("soundTab"),this.controlsBody=document.getElementById("controlsBody"),this.graphicsBody=document.getElementById("graphicsBody"),this.soundBody=document.getElementById("soundBody"),this.masterSlider=document.getElementById("masterSlider"),this.masterFill=document.getElementById("masterFill"),this.masterValue=document.getElementById("masterValue"),this.ambienceSlider=document.getElementById("ambienceSlider"),this.ambienceFill=document.getElementById("ambienceFill"),this.ambienceValue=document.getElementById("ambienceValue"),this.musicSlider=document.getElementById("musicSlider"),this.musicFill=document.getElementById("musicFill"),this.musicValue=document.getElementById("musicValue"),this.sfxSlider=document.getElementById("sfxSlider"),this.sfxFill=document.getElementById("sfxFill"),this.sfxValue=document.getElementById("sfxValue"),this.voiceSlider=document.getElementById("voiceSlider"),this.voiceFill=document.getElementById("voiceFill"),this.voiceValue=document.getElementById("voiceValue"),this.deadzoneInput=document.getElementById("deadzoneInput"),this.particleJSToggle=document.getElementById("particleJSToggle"),this.staticVfxToggle=document.getElementById("staticToggle"),this.ammoReservesPhysicsToggle=document.getElementById("ammoReservesPhysicsToggle"),this.accuracyStat=document.getElementById("accuracyValue"),this.damageStat=document.getElementById("damageValue"),this.luckStat=document.getElementById("luckValue"),this.rangeStat=document.getElementById("rangeValue"),this.shotSpeedStat=document.getElementById("shotSpeedValue"),this.speedStat=document.getElementById("speedValue"),!(this.canvas&&this.decalCanvas&&this.postEffectsCanvas&&this.ammoReservesCanvas&&this.charCustomizeCanvas&&this.liquidCanvas&&this.worldCanvas&&this.roomControls&&this.gameContainer&&this.lobbyContainer&&this.userIdDisplay&&this.roomIdDisplay&&this.gameRoomIdDisplay&&this.lobbyPlayersList&&this.startGameBtn&&this.gameOptionsContainer&&this.chatContainer&&this.chatMessages&&this.chatInput&&this.chatSendBtn&&this.privateToggle&&this.upgradesToggle&&this.winsInput&&this.playersInput&&this.upgradeContainer&&this.leaderboardContainer&&this.leaderboardBody&&this.hostButton&&this.joinButton&&this.quickplayButton&&this.lobbyLeaveButton&&this.lobbyCodeButton&&this.gameLeaveButton&&this.gameCodeButton&&this.settingsButton&&this.settingsCloseButton&&this.settingsContainer&&this.controlsTab&&this.graphicsTab&&this.soundTab&&this.controlsBody&&this.graphicsBody&&this.soundBody&&this.masterSlider&&this.masterFill&&this.ambienceSlider&&this.ambienceFill&&this.musicSlider&&this.musicFill&&this.sfxSlider&&this.sfxFill&&this.voiceSlider&&this.voiceFill&&this.masterValue&&this.ambienceValue&&this.musicValue&&this.sfxValue&&this.voiceValue&&this.accuracyStat&&this.damageStat&&this.luckStat&&this.rangeStat&&this.shotSpeedStat&&this.speedStat&&this.deadzoneInput&&this.particleJSToggle&&this.staticVfxToggle&&this.ammoReservesPhysicsToggle&&this.charCustomizeContainer&&this.headwearArrowLeft&&this.headArrowLeft&&this.bodyArrowLeft&&this.headwearArrowRight&&this.headArrowRight&&this.bodyArrowRight))throw alert("Failed to load game. Please refresh the page."),new Error("Critical error: Required DOM elements are missing.");if(this.canvas.width=r,this.canvas.height=n,this.postEffectsCanvas.width=r,this.postEffectsCanvas.height=n,this.decalCanvas.width=s,this.decalCanvas.height=i,this.worldCanvas.width=s,this.worldCanvas.height=i,this.liquidCanvas.width=s,this.liquidCanvas.height=i,this.ammoReservesCanvas.width=100,this.ammoReservesCanvas.height=64,this.charCustomizeCanvas.width=200,this.charCustomizeCanvas.height=200,this.ctx=this.canvas.getContext("2d"),this.decalCtx=this.decalCanvas.getContext("2d"),this.worldCtx=this.worldCanvas.getContext("2d"),this.liquidCtx=this.liquidCanvas.getContext("2d"),this.postEffectsCtx=this.postEffectsCanvas.getContext("2d"),this.ammoReservesCtx=this.ammoReservesCanvas.getContext("2d"),this.charCustomizeCtx=this.charCustomizeCanvas.getContext("2d"),!(this.ctx&&this.decalCtx&&this.worldCtx&&this.liquidCtx&&this.postEffectsCtx&&this.ammoReservesCtx&&this.charCustomizeCtx))throw alert("Failed to load game. Please refresh the page."),new Error("Could not get canvas context")}updateDisplay(t,e,a){if(this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer&&this.charCustomizeContainer)switch(this.clearDisplay(),e){case"lobby":this.lobbyContainer.style.display="flex",this.chatContainer.style.display="flex",this.charCustomizeContainer.style.display="flex",a&&this.roomIdDisplay&&(this.roomIdDisplay.textContent=a),t.inLobby=!0;break;case"room":this.roomControls.style.display="flex";break;case"game":if(this.gameContainer.style.display="flex",this.chatContainer.style.display="flex",this.leaderboardContainer.style.display="flex",a){const t=this.gameRoomIdDisplay;t&&(t.textContent=a)}t.inLobby=!1}}updateHostDisplay(t,e){this.startGameBtn&&this.gameOptionsContainer&&(this.startGameBtn.style.display=t?"block":"none",this.startGameBtn.disabled=e.lobbyPlayers.size<1,this.gameOptionsContainer.style.display=t?"flex":"none")}displayLobbyPlayers(t,e,a){this.lobbyPlayersList&&(this.lobbyPlayersList.innerHTML="",Array.from(e.lobbyPlayers.values()).sort((t,e)=>t.isHost&&!e.isHost?-1:!t.isHost&&e.isHost?1:0).forEach(s=>{const i=document.createElement("div");i.className="lobby_player";const o=document.createElement("div");o.className="player_color",o.style.backgroundColor=s.color;const r=document.createElement("div");r.className="player_name",r.textContent=`${s.id}${s.isHost?" (Host)":""}`;const n=document.createElement("div");if(n.className="player_controls",t&&s.id!==a){const t=document.createElement("button");t.textContent="Promote",t.onclick=()=>e.promotePlayer(s.id);const a=document.createElement("button");a.textContent="Kick",a.className="danger",a.onclick=()=>e.kickPlayer(s.id),n.appendChild(t),n.appendChild(a)}i.appendChild(o),i.appendChild(r),i.appendChild(n),this.lobbyPlayersList&&this.lobbyPlayersList.appendChild(i)}))}clearDisplay(){this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer&&this.upgradeContainer&&this.charCustomizeContainer&&(this.roomControls.style.display="none",this.lobbyContainer.style.display="none",this.gameContainer.style.display="none",this.chatContainer.style.display="none",this.leaderboardContainer.style.display="none",this.upgradeContainer.style.display="none",this.charCustomizeContainer.style.display="none")}closeModal(){this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalText&&(this.modal.classList.add("hidden"),this.modalInput.style.display="flex",this.modalText.textContent="Join Room",this.modalConfirmButton.onclick=null,this.modalCancelButton.onclick=null,this.modalInput.onkeydown=null)}showJoinRoomModal(t){this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalErrorDiv&&(this.modal.classList.remove("hidden"),this.modalConfirmButton.classList.remove("hidden"),this.modalInput.value="",this.modalErrorDiv.textContent="",this.modalConfirmButton.textContent="Join",this.modalInput.focus(),this.modalConfirmButton.onclick=()=>{if(!this.modalInput||!this.modalErrorDiv)return;const e=this.modalInput.value.trim();if(!e)return void(this.modalErrorDiv.textContent="Invalid code...");let a=null;try{const t=new URL(e,window.location.origin);a=t.pathname.startsWith("/room_")?t.pathname.replace("/",""):new URLSearchParams(t.search).get("room")}catch{e.startsWith("room_")&&(a=e)}a?(this.closeModal(),t(a)):this.modalErrorDiv.textContent="Invalid code..."},this.modalCancelButton.onclick=()=>this.closeModal())}soloGameWarning(t){this.modal&&this.modalConfirmButton&&this.modalCancelButton&&this.modalContent&&this.modalText&&this.modalInput&&this.modalErrorDiv&&this.modalButtons&&(this.modal.classList.remove("hidden"),this.modalConfirmButton.classList.remove("hidden"),this.modalInput.style.display="none",this.modalErrorDiv.textContent=" ",this.modalButtons.style.display="flex",this.modalCancelButton.style.display="flex",this.modalText.textContent="Start game as only player? Other players will be unable to join until you return to the lobby.",this.modalConfirmButton.textContent="Start Game",this.modalCancelButton.textContent="Cancel",this.modalConfirmButton.onclick=()=>{this.closeModal(),t()},this.modalCancelButton.onclick=()=>this.closeModal())}showSettingsPage(){this.settingsContainer&&this.settingsContainer.classList.remove("hidden")}hideSettingsPage(){this.settingsContainer&&this.settingsContainer.classList.add("hidden")}switchSettingsPage(t){if(this.controlsBody&&this.graphicsBody&&this.soundBody&&this.controlsTab&&this.graphicsTab&&this.soundTab)switch(this.controlsTab.classList.remove("settings_tab_active"),this.graphicsTab.classList.remove("settings_tab_active"),this.soundTab.classList.remove("settings_tab_active"),this.controlsBody.classList.remove("settings_page_hidden"),this.graphicsBody.classList.remove("settings_page_hidden"),this.soundBody.classList.remove("settings_page_hidden"),t){case"controls":this.controlsTab.classList.add("settings_tab_active"),this.graphicsBody.classList.add("settings_page_hidden"),this.soundBody.classList.add("settings_page_hidden");break;case"graphics":this.graphicsTab.classList.add("settings_tab_active"),this.controlsBody.classList.add("settings_page_hidden"),this.soundBody.classList.add("settings_page_hidden");break;case"sound":this.soundTab.classList.add("settings_tab_active"),this.controlsBody.classList.add("settings_page_hidden"),this.graphicsBody.classList.add("settings_page_hidden")}}updateSettingsSlider(t,e,a){const s=Math.max(0,Math.min(100,100*a));t.style.width=`${s}%`,e.textContent=`${Math.round(s)}%`}calculateSliderValue(t,e){const a=t.getBoundingClientRect(),s=e-a.left,i=a.width;return Math.max(0,Math.min(1,s/i))}initSoundSliders(t){const e=t.audio.mixer;this.masterFill&&this.masterValue&&this.updateSettingsSlider(this.masterFill,this.masterValue,e.master.volume),this.ambienceFill&&this.ambienceValue&&this.updateSettingsSlider(this.ambienceFill,this.ambienceValue,e.ambience.volume),this.musicFill&&this.musicValue&&this.updateSettingsSlider(this.musicFill,this.musicValue,e.music.volume),this.sfxFill&&this.sfxValue&&this.updateSettingsSlider(this.sfxFill,this.sfxValue,e.sfx.volume),this.voiceFill&&this.voiceValue&&this.updateSettingsSlider(this.voiceFill,this.voiceValue,e.voice.volume)}initSettingsInputs(t){this.deadzoneInput&&(this.deadzoneInput.value=t.controls.gamepad.deadzone.toString())}initSettingsToggles(t){this.particleJSToggle&&this.utility.setToggle({toggleId:"particleJSToggle",value:t.graphics.renderBackgroundParticles}),this.staticVfxToggle&&this.utility.setToggle({toggleId:"staticToggle",value:t.graphics.showStaticOverlay}),this.ammoReservesPhysicsToggle&&this.utility.setToggle({toggleId:"ammoReservesPhysicsToggle",value:t.graphics.physics.ammoReserves})}initKeybindsInterface(t,e){Object.keys(t.keybinds).forEach(a=>{const s=`${a}Keybind`,i=document.getElementById(s);if(i){const s=t.keybinds[a];i.textContent=" "===s?"SPACE":s.toUpperCase(),i.addEventListener("click",()=>{this.showRebindModal(a,"keybind",t=>{e(a,"keybind",t)})})}}),Object.keys(t.gamepad).forEach(a=>{const s=`${a}Gamepad`,i=document.getElementById(s);if(i&&void 0!==t.gamepad[a]){const s=t.gamepad[a],o=Object.keys(l).find(t=>"number"==typeof l[t]&&l[t]===s);i.textContent=o||s.toString(),i.addEventListener("click",()=>{this.showRebindModal(a,"gamepad",t=>{e(a,"gamepad",t)})})}})}showRebindModal(t,e,a){if(!(this.modal&&this.modalText&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalErrorDiv))return;const s=["Binding already assigned!","Binding already in use!","That binding is assigned already!","Binding already being used!","Already bound to another action!"];let i=0;if("gamepad"===e){const t=navigator.getGamepads();if(!Array.from(t).some(t=>null!==t))return this.modal.classList.remove("hidden"),this.modalErrorDiv.textContent="",this.modalText.textContent="No gamepad detected",this.modalInput.style.display="none",this.modalConfirmButton.classList.add("hidden"),this.modalCancelButton.textContent="Close",this.modalCancelButton.onclick=()=>this.closeModal(),void this.utility.safeTimeout(()=>{this.closeModal()},3e3)}this.modal.classList.remove("hidden"),this.modalErrorDiv.textContent="",this.modalInput.style.display="none",this.modalText.textContent=`Press any ${"keybind"===e?"key":"button"} for ${t.toUpperCase()}`,this.modalConfirmButton.classList.add("hidden"),this.modalCancelButton.textContent="Cancel";const o=a=>"keybind"===e?Object.entries(this.settingsManager?.getSettings().controls.keybinds||{}).some(([e,s])=>e!==t&&s===a):Object.entries(this.settingsManager?.getSettings().controls.gamepad||{}).some(([e,s])=>e!==t&&s===a),r=t=>{if(t.preventDefault(),"Escape"===t.key)return h(),void this.closeModal();const e=t.key.toLowerCase();if(o(e)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],void i++}h(),a(e),this.closeModal()},n=t=>{if(t.target===this.modalCancelButton||this.modalCancelButton?.contains(t.target))return;t.preventDefault(),t.stopPropagation();let e="";if(0===t.button?e="mouse1":1===t.button?e="mouse3":2===t.button&&(e="mouse2"),e){if(o(e)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],void i++}h(),a(e),this.closeModal()}},l=()=>{const t=navigator.getGamepads();for(const e of t)if(e)for(let t=0;t<e.buttons.length;t++)if(e.buttons[t].pressed){if(o(t)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],i++,void requestAnimationFrame(l)}return h(),a(t),void this.closeModal()}requestAnimationFrame(l)},h=()=>{"keybind"===e&&(document.removeEventListener("keydown",r),document.removeEventListener("mousedown",n)),this.modalCancelButton.onclick=null};"keybind"===e?(document.addEventListener("keydown",r),document.addEventListener("mousedown",n)):requestAnimationFrame(l),this.modalCancelButton.onclick=()=>{h(),this.closeModal()}}createLeaderboard(t,e,a){const s=new Set;s.add(a),e.forEach((t,e)=>{s.add(e)}),t.lobbyPlayers.forEach((t,e)=>{s.add(e)}),s.forEach(t=>{this.leaderboard.has(t)||(this.leaderboard.set(t,{playerId:t,wins:0,kills:0,deaths:0}),console.log(`Created leaderboard entry for ${t}`))}),this.updateLeaderboardDisplay(a),console.log("Leaderboard created/updated:",Array.from(this.leaderboard.entries()))}updateLeaderboardDisplay(t){this.leaderboardBody&&(this.leaderboardBody.innerHTML="",Array.from(this.leaderboard.entries()).sort((t,e)=>{const[,a]=t,[,s]=e;return s.wins!==a.wins?s.wins-a.wins:s.kills-a.kills}).forEach(([e,a])=>{const s=document.createElement("tr");s.className="leaderboard_row",e===t&&s.classList.add("current-player");const i=document.createElement("td");i.textContent=e===t?"You":e.substring(0,8),i.className="player_name",s.appendChild(i);const o=document.createElement("td");o.textContent=a.wins.toString(),o.className="wins",s.appendChild(o);const r=document.createElement("td");r.textContent=a.kills.toString(),r.className="kills",s.appendChild(r);const n=document.createElement("td");n.textContent=a.deaths.toString(),n.className="deaths",s.appendChild(n),this.leaderboardBody&&this.leaderboardBody.appendChild(s)}))}clearLeaderboard(){this.leaderboard.clear(),this.leaderboardBody&&(this.leaderboardBody.innerHTML="")}updateSlider(t){const e=this.playerState.myPlayer.stats,a={sliderId:"health"===t?"healthBar":"staminaBar",targetValue:e[t].value,maxValue:e[t].max,lerpTime:this.HUD_LERP_TIME};this.utility.setSlider(a)}initInterfaceListeners(){const t=500,e=20,a="#00ff00",s="#ff0000",i=200;this.playerState.onStatChange("actions.primary.projectile.spread",o=>{if(!this.accuracyStat)return;const r=parseFloat(this.accuracyStat.textContent||"0"),n=o<r;this.utility.animateTextInElement({element:this.accuracyStat,oldValue:r,newValue:o,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.damage",o=>{if(!this.damageStat)return;const r=parseFloat(this.damageStat.textContent||"0"),n=o>r;this.utility.animateTextInElement({element:this.damageStat,oldValue:r,newValue:Math.round(o),decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("stats.speed",o=>{if(!this.speedStat)return;const r=parseFloat(this.speedStat.textContent||"0"),n=o>r;this.utility.animateTextInElement({element:this.speedStat,oldValue:r,newValue:o,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.range",o=>{if(!this.rangeStat)return;const r=parseFloat(this.rangeStat.textContent||"0"),n=o>r;this.utility.animateTextInElement({element:this.rangeStat,oldValue:r,newValue:o,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.speed",o=>{if(!this.shotSpeedStat)return;const r=parseFloat(this.shotSpeedStat.textContent||"0"),n=o>r;this.utility.animateTextInElement({element:this.shotSpeedStat,oldValue:r,newValue:o,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("stats.luck",o=>{if(!this.luckStat)return;const r=parseFloat(this.luckStat.textContent||"0"),n=o>r;this.utility.animateTextInElement({element:this.luckStat,oldValue:r,newValue:o,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})})}}class N{constructor(){this.lastFrameTime=performance.now(),this.simplexTable=this.generateSimplexTable(),this.activeTimeouts=new Set}deepMerge(t,e){for(const a in e)null===e[a]||"object"!=typeof e[a]||Array.isArray(e[a])?t[a]=e[a]:(t[a]||(t[a]={}),this.deepMerge(t[a],e[a]))}async yield(t){console.log(`[Yield] ${t??"(no message)"}`),t?document.dispatchEvent(new CustomEvent("yieldMessage",{detail:{message:t}})):document.dispatchEvent(new CustomEvent("yieldProgress")),await new Promise(t=>requestAnimationFrame(()=>t()))}deltaTime(){const t=performance.now(),e=t-this.lastFrameTime;return this.lastFrameTime=t,Math.min(e,100)/16.67}safeTimeout(t,e){const a=window.setTimeout(()=>{this.activeTimeouts.delete(a),t()},e);return this.activeTimeouts.add(a),a}clearTimeoutCache(){this.activeTimeouts.forEach(t=>window.clearTimeout(t)),this.activeTimeouts.clear()}clamp(t,e,a){return t<e?e:t>a?a:t}getRandomNum(t,e,a){const s=Math.random()*(e-t)+t;return void 0!==a?parseFloat(s.toFixed(a)):s}getRandomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}getRandomInArray(t){return t[Math.floor(Math.random()*t.length)]}getShuffledArray(t){return t.slice().sort(()=>Math.random()-.5)}getDotProduct(t,e){return t.x*e.x+t.y*e.y}getReflection(t,e){const a=this.getDotProduct(t,e);return{x:t.x-2*a*e.x,y:t.y-2*a*e.y}}forward(t){return{x:Math.cos(t),y:Math.sin(t)}}getDirection(t){const e=t.targetPos.x-t.rootPos.x,a=t.targetPos.y-t.rootPos.y,s=Math.sqrt(e*e+a*a);return 0===s?{x:0,y:0}:{x:e/s,y:a/s}}getRandomDirection(t){const e=Math.random()*(t*Math.PI/180);return{x:Math.cos(e),y:Math.sin(e)}}getRandomColor(t){const e=t?.format??"hex";let a;switch(t?.mode??"any"){case"primary":const t=["#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF"];a=this.getRandomInArray(t);break;case"pastel":const e=this.getRandomInt(127,254),s=this.getRandomInt(127,254),i=this.getRandomInt(127,254);a=`#${e.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;break;case"vibrant":const o=[255,this.getRandomInt(0,255),this.getRandomInt(0,255)];o.sort(()=>Math.random()-.5),a=`#${o[0].toString(16).padStart(2,"0")}${o[1].toString(16).padStart(2,"0")}${o[2].toString(16).padStart(2,"0")}`;break;case"dark":const r=this.getRandomInt(0,127),n=this.getRandomInt(0,127),l=this.getRandomInt(0,127);a=`#${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`;break;case"light":const h=this.getRandomInt(128,255),d=this.getRandomInt(128,255),c=this.getRandomInt(128,255);a=`#${h.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`;break;case"grayscale":const m=this.getRandomInt(0,255);a=`#${m.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`;break;default:a="#"+this.getRandomInt(0,16777215).toString(16).padStart(6,"0")}if("rgb"===e){const t=this.hexToRgb(a);return t?`rgb(${t.r}, ${t.g}, ${t.b})`:a}return a}getLightestColor(t){let e=t[0],a=0;for(const s of t){const t=.299*parseInt(s.slice(1,3),16)+.587*parseInt(s.slice(3,5),16)+.114*parseInt(s.slice(5,7),16);t>a&&(a=t,e=s)}return e}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}generateSimplexTable(){const t=new Uint8Array(512);for(let e=0;e<256;e++)t[e]=e;for(let e=0;e<256;e++){const a=e+this.getRandomInt(0,255-e);[t[e],t[a]]=[t[a],t[e]]}for(let e=0;e<256;e++)t[256+e]=t[e];return t}simplexNoise2D(t,e,a=!1){a&&(this.simplexTable=this.generateSimplexTable());const s=this.simplexTable,i=.5*(Math.sqrt(3)-1),o=(3-Math.sqrt(3))/6,r=(t+e)*i,n=Math.floor(t+r),l=Math.floor(e+r),h=(n+l)*o,d=t-(n-h),c=e-(l-h),m=d>c?1:0,u=d>c?0:1,g=d-m+o,p=c-u+o,y=d-1+2*o,f=c-1+2*o,w=255&n,x=255&l,b=s[w+s[x]]%12,S=s[w+m+s[x+u]]%12,v=s[w+1+s[x+1]]%12,C=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],M=(t,e,a)=>t[0]*e+t[1]*a;let I=.5-d*d-c*c,P=.5-g*g-p*p,_=.5-y*y-f*f;return 70*((I<0?0:Math.pow(I,4)*M(C[b],d,c))+(P<0?0:Math.pow(P,4)*M(C[S],g,p))+(_<0?0:Math.pow(_,4)*M(C[v],y,f)))}getNoise(t,e,a,s,i){switch(t){case T.VA.Perlin:return this.perlinNoise(e,a,s,i?.octaves??1,i?.persistence??.5);case T.VA.Ridged:return this.ridgedNoise(e,a,s,i?.octaves??1,i?.persistence??.5);case T.VA.Worley:return this.worleyNoise(e,a,s,Math.max(1,Math.floor(i?.octaves??1)));case T.VA.Voronoi:return this.voronoiNoise(e,a,s);default:return this.perlinNoise(e,a,s)}}perlinNoise(t,e,a,s=1,i=1){let o=0,r=1,n=1,l=0;for(let h=0;h<s;h++)o+=this.interpolateNoise(t*r,e*r,a+1e3*h)*n,l+=n,n*=i,r*=2;return o/l}ridgedNoise(t,e,a,s=1,i=.5){let o=0,r=1,n=1,l=0;for(let h=0;h<s;h++){let s=this.interpolateNoise(t*r,e*r,a+1e3*h);s=1-Math.abs(s),o+=s*n,l+=n,n*=i,r*=2}return o/l}worleyNoise(t,e,a,s=1){const i=Math.floor(t),o=Math.floor(e);let r=1/0;for(let n=-1;n<=1;n++)for(let l=-1;l<=1;l++){const h=i+n,d=o+l;for(let i=0;i<s;i++){const s=t-(h+this.hash2D(h,d,a+1e4*i)),o=e-(d+this.hash2D(h,d,a+1e4*i+1)),n=Math.sqrt(s*s+o*o);n<r&&(r=n)}}return this.normalize(r/1.5)}voronoiNoise(t,e,a){return this.worleyNoise(t,e,a,1)}hash2D(t,e,a){const s=374761393*t+668265263*e+a,i=1274126177*(s^s>>13);return(2147483647&(i^i>>16))/2147483647}interpolateNoise(t,e,a){const s=Math.floor(t),i=t-s,o=Math.floor(e),r=e-o,n=this.hash2D(s,o,a),l=this.hash2D(s+1,o,a),h=this.hash2D(s,o+1,a),d=this.hash2D(s+1,o+1,a),c=this.smoothstep(i),m=this.smoothstep(r),u=this.lerp(n,l,c),g=this.lerp(h,d,c);return this.lerp(u,g,m)}smoothstep(t){return t*t*(3-2*t)}lerp(t,e,a){return t+(e-t)*a}normalize(t){return Math.max(0,Math.min(1,t))}generateUID(t,e){let a=e??"";for(let e=0;e<t;e++)a+="0123456789abcdefghijklmnopqrstuvwxyz"[this.getRandomInt(0,35)];return a}generateLink(t,e){const a=window.location.origin;return e?`${a}?${e}=${t}`:`${a}?${t}`}setInput(t){const e=document.getElementById(t.inputId);e&&(e.value=t.value.toString())}setSlider(t){const{sliderId:e,targetValue:a,maxValue:s,lerpTime:i=0}=t,o=document.getElementById(e),r=o?.querySelector("div");if(!o||!r)return void console.warn(`Slider not found: ${e}...`);if(0===s)return void console.warn("maxValue cannot be 0...");const n=Math.max(0,Math.min(s,a))/s*100,l=r.style.width||"100%",h=parseFloat(l.replace("%",""));if(!(Math.abs(h-n)<.1)){if(i<=0)return r.style.transition="none",void(r.style.width=`${n}%`);r.style.transition=`width ${i}ms ease-out`,r.style.width=`${n}%`,setTimeout(()=>{r&&(r.style.transition="")},i)}}setSpan(t){const e=document.getElementById(t.spanId);e?e.textContent=t.value.toString():console.warn(`Span not found: ${t.spanId}`)}setToggle(t){const e=document.getElementById(t.toggleId);e&&(t.value?(e.setAttribute("checked","true"),e.setAttribute("aria-checked","true")):(e.removeAttribute("checked"),e.setAttribute("aria-checked","false")))}animateTextInElement(t){const e=(t.newValue-t.oldValue)/t.steps,a=t.animTime/t.steps;let s=0,i=t.oldValue;t.element.style.color=t.color;const o=setInterval(()=>{s++,i+=e,s>=t.steps?(t.element.textContent=t.newValue.toFixed(t.decimals),clearInterval(o),setTimeout(()=>{t.element.style.color=""},t.timeout)):t.element.textContent=i.toFixed(t.decimals)},a)}}class O{constructor(t,e,a){this.gameState=t,this.roomManager=e,this.utility=a,this.ws=null}connectWebSocket(){const t="https:"===location.protocol?"wss:":"ws:";let e;"8888"===location.port?(e="localhost:8080",this.ws=new WebSocket(`ws://${e}`)):"9999"===location.port?(e="saltpeter.xyz",this.ws=new WebSocket(`wss://${e}`)):(e="localhost"===location.hostname?"localhost:8080":location.host,this.ws=new WebSocket(`${t}//${e}`)),this.ws.onopen=()=>{console.log("Connected to WebSocket"),this.roomManager.setWebSocket(this.ws)},this.ws.onclose=()=>{console.log("Disconnected from WebSocket"),this.gameState.gameInProgress=!1,this.utility.safeTimeout(()=>this.connectWebSocket(),h.RECONNECT_DELAY)},this.ws.onerror=t=>{console.error("WebSocket error:",t)}}getWebSocket(){return this.ws}}class z{constructor(){this.mixer={master:{out:null,volume:1},ambience:{out:"master",volume:.5},music:{out:"master",volume:.75},sfx:{out:"master",volume:.9},voice:{out:"master",volume:1}},this.resources={sfx:{impact:{flesh:{ranged:["/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_00.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_01.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_02.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_03.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_04.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_05.ogg"],melee:[]},metal:{ranged:["/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_00.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_01.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_02.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_03.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_04.ogg"],melee:[]}},player:{locomotion:{footsteps:{dirt:["/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_06.ogg"],grass:["/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_06.ogg"],gravel:["/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_06.ogg"],mud:["/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_06.ogg"],sand:["/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_06.ogg"],sand_wet:["/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_06.ogg"],silt:["/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_06.ogg"],silt_wet:["/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_06.ogg"],snow:["/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_06.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_07.ogg"],stone:["/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_05.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_06.ogg"],water:{light:["/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_05.ogg"],medium:["/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_00.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_01.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_02.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_03.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_04.ogg","/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_05.ogg"]}}},voice:{voice_00:{grunt:["/assets/audio/sfx/player/voice/00/player_voice_00_hit_00.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_01.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_02.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_03.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_04.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_05.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_06.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_07.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_08.ogg","/assets/audio/sfx/player/voice/00/player_voice_00_hit_09.ogg"]},voice_01:{grunt:["/assets/audio/sfx/player/voice/01/player_voice_01_hit_00.ogg","/assets/audio/sfx/player/voice/01/player_voice_01_hit_01.ogg","/assets/audio/sfx/player/voice/01/player_voice_01_hit_02.ogg","/assets/audio/sfx/player/voice/01/player_voice_01_hit_03.ogg","/assets/audio/sfx/player/voice/01/player_voice_01_hit_04.ogg","/assets/audio/sfx/player/voice/01/player_voice_01_hit_05.ogg","/assets/audio/sfx/player/voice/01/player_voice_01_hit_06.ogg"]}}},weapon:{glock:{attack:["/assets/audio/sfx/weapons/glock/glock_attack_00.ogg","/assets/audio/sfx/weapons/glock/glock_attack_01.ogg","/assets/audio/sfx/weapons/glock/glock_attack_02.ogg","/assets/audio/sfx/weapons/glock/glock_attack_03.ogg","/assets/audio/sfx/weapons/glock/glock_attack_04.ogg","/assets/audio/sfx/weapons/glock/glock_attack_05.ogg"],empty:["/assets/audio/sfx/weapons/glock/glock_empty_00.ogg"],reload:{end:["/assets/audio/sfx/weapons/glock/glock_reload_end_00.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_01.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_02.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_03.ogg"],start:["/assets/audio/sfx/weapons/glock/glock_reload_start_00.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_01.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_02.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_03.ogg"]},shell:["/assets/audio/sfx/weapons/glock/glock_shell_00.ogg","/assets/audio/sfx/weapons/glock/glock_shell_01.ogg","/assets/audio/sfx/weapons/glock/glock_shell_02.ogg","/assets/audio/sfx/weapons/glock/glock_shell_03.ogg","/assets/audio/sfx/weapons/glock/glock_shell_04.ogg","/assets/audio/sfx/weapons/glock/glock_shell_05.ogg","/assets/audio/sfx/weapons/glock/glock_shell_06.ogg","/assets/audio/sfx/weapons/glock/glock_shell_07.ogg","/assets/audio/sfx/weapons/glock/glock_shell_08.ogg","/assets/audio/sfx/weapons/glock/glock_shell_09.ogg","/assets/audio/sfx/weapons/glock/glock_shell_10.ogg","/assets/audio/sfx/weapons/glock/glock_shell_11.ogg","/assets/audio/sfx/weapons/glock/glock_shell_12.ogg","/assets/audio/sfx/weapons/glock/glock_shell_13.ogg","/assets/audio/sfx/weapons/glock/glock_shell_14.ogg"]}}},ambience:{beds:{app:["/assets/audio/ambience/beds/env_app_00.ogg"],cliffs:["/assets/audio/ambience/beds/env_cliffs_00.ogg"],mountains:["/assets/audio/ambience/beds/env_mountains_00.ogg"],ocean:["/assets/audio/ambience/beds/env_ocean_00.ogg"],plains:["/assets/audio/ambience/beds/env_plains_00.ogg"],shore:["/assets/audio/ambience/beds/env_shore_00.ogg"]}}}}}class ${constructor(t,e,a,s){this.audioConfig=t,this.roomManager=e,this.settingsManager=a,this.utility=s,this.buffers=new Map,this.mixers=new Map,this.loops=new Set,this.audioContext=new AudioContext,this.initMixers()}initMixers(){const t=this.settingsManager.getSettings().audio.mixer;for(const e in t){const t=this.audioContext.createGain();t.connect(this.audioContext.destination),this.mixers.set(e,t)}this.updateMixerGains()}updateMixerGains(){for(const[t,e]of this.mixers)e.gain.value=this.getMixerVolume(t)}getMixerVolume(t){const e=this.settingsManager.getSettings().audio.mixer;let a=1,s=e[t];for(;null!==s;)a*=s.volume,s=s.out?e[s.out]:null;return a}async preloadAudio(t,e){const a=[];for(const s in t){const i=t[s];Array.isArray(i)?i.forEach(t=>{"string"==typeof t&&t.endsWith(e)&&a.push(this.loadSound(t))}):"object"==typeof i&&null!==i&&a.push(this.preloadAudio(i,e))}await Promise.all(a)}async loadSound(t){if(!this.buffers.has(t))try{const e=await fetch(t),a=await e.arrayBuffer(),s=await this.audioContext.decodeAudioData(a);this.buffers.set(t,s)}catch(e){console.error(`Failed to load audio: ${t}`,e)}}playAudio(t){const e=this.buffers.get(t.src);if(!e)return console.warn(`Audio not loaded: ${t.src}`),null;"suspended"===this.audioContext.state&&this.audioContext.resume();const a=t.output||"master",o=this.mixers.get(a);if(!o)return console.warn(`No mixer found: ${a}`),null;const r=this.audioContext.createBufferSource(),n=this.audioContext.createGain(),l=this.audioContext.createStereoPanner();if(r.buffer=e,r.loop=t.loop??!1,t.pitch){const e=this.utility.getRandomNum(t.pitch.min,t.pitch.max);r.playbackRate.value=Math.max(.25,Math.min(4,e))}let h=1;t.volume&&(h=this.utility.getRandomNum(t.volume.min,t.volume.max));const d=t.spatial?.blend??0;if(d>0&&t.spatial?.pos&&t.listener){const e=t.spatial.pos.x-t.listener.x,a=t.spatial.pos.y-t.listener.y,o=Math.sqrt(e*e+a*a);let r;if(t.spatial.rolloff){const e=t.spatial.rolloff.type||"linear",a=t.spatial.rolloff.factor,s=t.spatial.rolloff.distance;if("logarithmic"===e){const t=s*a;if(o<t)r=1;else{const e=(o-t)/(s-t);r=Math.max(0,1-Math.pow(e,.5))}}else r=Math.max(0,1-o/s*a)}else{const t=Math.max(s,i);r=Math.max(0,1-o/t)}h*=1-d+r*d;const n=t.spatial.rolloff?.distance||Math.max(s,i),c=Math.max(-1,Math.min(1,e/(n/2)));l.pan.value=c}else l.pan.value=0;n.gain.value=Math.max(0,Math.min(1,h)),r.connect(n),n.connect(l),l.connect(o),t.loop&&this.loops.add({source:r,gain:n,params:t}),r.onended=()=>{const t=Array.from(this.loops).find(t=>t.source===r);t&&this.loops.delete(t),n.disconnect()};let c=0;t.startTime&&(c=this.utility.getRandomNum(t.startTime.min,t.startTime.max));let m=0;t.delay&&(m=1e3*this.utility.getRandomNum(t.delay.min,t.delay.max));const u={setVolume:t=>{n.gain.value=Math.max(0,Math.min(1,t))},stop:()=>{try{r.stop()}catch(t){}const t=Array.from(this.loops).find(t=>t.source===r);t&&this.loops.delete(t)}};return this.utility.safeTimeout(()=>{try{r.start(0,c)}catch(t){console.warn("Audio play failed:",t)}},m),u}playAudioNetwork(t){this.playAudio(t),this.roomManager.sendMessage(JSON.stringify({type:"play-audio",params:t}))}refreshActiveLoops(){const t=Array.from(this.loops);for(const e of t){this.loops.delete(e);try{e.source.stop()}catch(t){}this.playAudio(e.params)}}}class q{constructor(){this.defaults={maxMessages:100,maxMessageLength:200}}}class H{constructor(t,e){this.roomManager=t,this.ui=e,this.chatConfig=new q}clear(){this.ui.chatMessages&&(this.ui.chatMessages.innerHTML=""),this.ui.chatInput&&(this.ui.chatInput.value="")}sendChatMessage(t){if(!this.ui.chatInput||!this.ui.chatInput.value.trim())return;const e=this.ui.chatInput.value.trim();e.length>this.chatConfig.defaults.maxMessageLength?alert(`Message too long! Max ${this.chatConfig.defaults.maxMessageLength} characters.`):(this.roomManager.sendMessage(JSON.stringify({type:"chat-message",message:e,timestamp:Date.now()})),this.displayChatMessage({senderId:t,message:e,isOwn:!0}),this.ui.chatInput.value="")}displayChatMessage(t){if(!this.ui.chatMessages)return;const{senderId:e,message:a,isOwn:s=!1}=t,i=document.createElement("div");i.className="chat_message "+(s?"own":"other");const o=document.createElement("span");o.className="sender",o.textContent=s?"You:":`${e}:`;const r=document.createElement("span");for(r.className="content",r.textContent=a,i.appendChild(o),i.appendChild(r),this.ui.chatMessages.appendChild(i),this.ui.chatMessages.scrollTop=this.ui.chatMessages.scrollHeight;this.ui.chatMessages.children.length>this.chatConfig.defaults.maxMessages;)this.ui.chatMessages.removeChild(this.ui.chatMessages.firstChild)}}class j{constructor(t,e,a,s,i,o,r,n,l,h,d,c,m,u,g){this.animator=t,this.audioConfig=e,this.audioManager=a,this.collisionsManager=s,this.decalsManager=i,this.gameState=o,this.luckController=r,this.particlesManager=n,this.playerController=l,this.playerState=h,this.roomManager=d,this.ui=c,this.userId=m,this.utility=u,this.world=g,this.projectiles=new Map}triggerAttack(t){switch(t){case"melee":this.startMelee();break;case"ranged":this.startBurst();break;default:console.warn(`Unknown attack type: ${t}`)}}updateAttack(t){if(!this.gameState.gameInProgress||this.playerState.myPlayer.stats.health.value<=0)return;const e=Date.now();if(this.playerState.isReloading)e>=this.playerState.reloadStartTime+this.playerState.myPlayer.actions.primary.reload.time&&this.finishReload();else if(this.playerState.isBurstActive&&e>=this.playerState.nextBurstShotTime){const t=this.playerState.myPlayer.actions.primary.burst.amount;if(this.playerState.myPlayer.actions.primary.magazine.currentAmmo>0&&this.playerState.currentBurstShot<t){const a=this.playerState.myPlayer.transform.rot-Math.PI/2,s={x:Math.cos(a),y:Math.sin(a)};0===this.triggerBurstUniques().length&&this.launchProjectile(s),this.playerState.currentBurstShot++,this.playerState.myPlayer.actions.primary.magazine.currentAmmo--,console.log(`Burst shot ${this.playerState.currentBurstShot}! Magazine: ${this.playerState.myPlayer.actions.primary.magazine.currentAmmo}/${this.playerState.myPlayer.actions.primary.magazine.size}, Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`),this.playerState.currentBurstShot>=t||0===this.playerState.myPlayer.actions.primary.magazine.currentAmmo?(this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0):this.playerState.nextBurstShotTime=e+this.playerState.myPlayer.actions.primary.burst.delay}else this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0}}canMelee(){const t=Date.now();return!this.playerState.isMelee&&t>=this.playerState.lastMeleeTime+this.playerState.myPlayer.actions.melee.cooldown&&this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)&&!this.playerState.isBurstActive&&!this.playerState.isReloading}startMelee(){this.playerState.isMelee=!0,this.playerState.lastMeleeTime=Date.now(),this.playerState.myPlayer.rig.weapon=this.playerState.myPlayer.inventory.melee,this.roomManager.sendMessage(JSON.stringify({type:"weapon-change",playerId:this.userId,weapon:this.playerState.myPlayer.inventory.melee}));const t=this.playerState.myPlayer.transform.rot,e=this.playerState.myPlayer.actions.melee.range,a=this.playerState.myPlayer.actions.melee.size,s=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+this.playerState.myPlayer.actions.primary.projectile.size+this.playerState.myPlayer.actions.primary.offset,i=this.playerState.myPlayer.transform.pos.x+Math.cos(t-Math.PI/2)*s,o=this.playerState.myPlayer.transform.pos.y+Math.sin(t-Math.PI/2)*s,r={x:Math.cos(t-Math.PI/2)*e,y:Math.sin(t-Math.PI/2)*e},n={id:this.utility.generateUID(h.DATA.ID_LENGTH),transform:{pos:{x:i,y:o},rot:t},timestamp:Date.now(),color:"rgba(255, 255, 255, 0)",damage:this.playerState.myPlayer.actions.melee.damage,distanceTraveled:0,length:a,ownerId:this.userId,range:e,size:a,type:"melee",velocity:r};this.projectiles.set(n.id,n),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:n})),this.utility.safeTimeout(()=>{this.projectiles.delete(n.id),this.playerState.isMelee=!1,this.playerState.myPlayer.rig.weapon=this.playerState.myPlayer.inventory.primary,this.roomManager.sendMessage(JSON.stringify({type:"weapon-change",playerId:this.userId,weapon:this.playerState.myPlayer.inventory.primary}))},this.playerState.myPlayer.actions.melee.duration)}startBurst(){if(this.playerState.isBurstActive||!this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)||this.playerState.isReloading)return;const t=Date.now();if(t<this.playerState.lastShotTime+this.playerState.myPlayer.actions.primary.buffer)return;this.playerState.lastShotTime=t;const e=this.playerState.myPlayer.actions.primary.burst.amount,a=Math.min(e,this.playerState.myPlayer.actions.primary.magazine.currentAmmo),s=this.playerState.myPlayer.inventory.primary,i=this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[s].empty??[]),o=this.playerState.myPlayer.transform.pos.x,r=this.playerState.myPlayer.transform.pos.y;if(0===a)return console.log("Out of ammo! Magazine empty."),this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:8}},duration:0,partIndex:1}),i?void this.audioManager.playAudioNetwork({src:i,listener:{x:o,y:r},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:o,y:r}},volume:{min:.985,max:1}}):void console.warn(`No empty sound effects for ${s}`);this.playerState.isBurstActive=!0,this.playerState.currentBurstShot=0;const n=this.playerState.myPlayer.transform.rot-Math.PI/2,l={x:Math.cos(n),y:Math.sin(n)};0===this.triggerBurstUniques().length&&this.launchProjectile(l),this.playerState.currentBurstShot++,this.playerState.myPlayer.actions.primary.magazine.currentAmmo--;const h=1-this.playerState.myPlayer.actions.primary.magazine.currentAmmo/this.playerState.myPlayer.actions.primary.magazine.size;if(i&&h>.5){const t=2*(h-.5)*.5;this.audioManager.playAudio({src:i,listener:{x:o,y:r},output:"sfx",pitch:{min:.975,max:1.05},volume:{min:t,max:t}})}this.playerState.myPlayer.actions.primary.burst.amount>1&&this.playerState.myPlayer.actions.primary.magazine.currentAmmo>0&&this.playerState.currentBurstShot<a?this.playerState.nextBurstShotTime=Date.now()+this.playerState.myPlayer.actions.primary.burst.delay:(this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0,0===this.playerState.myPlayer.actions.primary.magazine.currentAmmo&&this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:8}},duration:0,partIndex:1}))}launchProjectile(t,e){console.log("Fired shot!");const a=Math.sqrt(t.x*t.x+t.y*t.y);if(0===a)return;const o=this.playerState.myPlayer.transform.pos.x,r=this.playerState.myPlayer.transform.pos.y,n=this.playerState.myPlayer.inventory.primary,l=t.x/a,d=t.y/a,c=e?.canTriggerUnique??!0,m=e?.amount??this.playerState.myPlayer.actions.primary.projectile.amount,u=e?.color??this.playerState.myPlayer.actions.primary.projectile.color,g=e?.damage??this.playerState.myPlayer.actions.primary.projectile.damage,p=e?.length??this.playerState.myPlayer.actions.primary.projectile.length,y=e?.range??this.playerState.myPlayer.actions.primary.projectile.range,f=e?.size??this.playerState.myPlayer.actions.primary.projectile.size,w=e?.speed??this.playerState.myPlayer.actions.primary.projectile.speed,x=e?.spread??this.playerState.myPlayer.actions.primary.projectile.spread,b=Math.atan2(d,l),S=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+f+this.playerState.myPlayer.actions.primary.offset,v=o+Math.cos(b)*S,C=r+Math.sin(b)*S,M=-d,I=l;this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:0},.5:{x:0,y:20},1:{x:0,y:0}},duration:175,partIndex:1});const P={id:`muzzle_${Date.now()}`,pos:{x:v,y:C},particleParams:this.particlesManager.particlesConfig.weaponParticles[n].muzzle.flash,direction:{x:l,y:d}};this.particlesManager.createParticles(P);const _={id:`smoke_${Date.now()}`,pos:{x:v,y:C},particleParams:this.particlesManager.particlesConfig.weaponParticles[n].muzzle.smoke,direction:{x:.3*l,y:.3*d}};this.particlesManager.createParticles(_);const E={id:`shell_${Date.now()}`,pos:{x:v-5,y:C-5},particleParams:this.particlesManager.particlesConfig.weaponParticles[n].projectile.shell,direction:{x:.8*M+-.2*l,y:.8*I+-.2*d}};this.particlesManager.createParticles(E),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[n].attack),listener:{x:o,y:r},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:o,y:r},rolloff:{distance:Math.max(s,i)/2,factor:.5,type:"logarithmic"}},volume:{min:.965,max:1}});const k=this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[n].shell??[]);this.audioManager.playAudioNetwork({src:k,delay:{min:.25,max:.5},listener:{x:o,y:r},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:o,y:r}},volume:{min:.375,max:.85}});for(let t=0;t<m;t++){if(this.playerState.myPlayer.unique.length>0&&c){const t=this.utility.getShuffledArray(this.playerState.myPlayer.unique);for(const e of t)if(this.luckController.luckRoll()){this.triggerUnique(e);break}}const t=(Math.random()-.5)*(x/100),e=Math.atan2(d,l)+t,a=this.utility.forward(e),s={id:this.utility.generateUID(h.DATA.ID_LENGTH),transform:{pos:{x:v,y:C},rot:e},timestamp:Date.now(),color:u,damage:g,distanceTraveled:0,length:p,ownerId:this.userId,range:100*y,size:f,type:"ranged",velocity:{x:a.x*w,y:a.y*w}};this.projectiles.set(s.id,s),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:s}))}}updateProjectiles(t){const e=[],a=this.playerState.myPlayer,o=a.transform.pos.x,r=a.transform.pos.y,n=a.stats;this.projectiles.forEach((l,h)=>{if(l.ownerId===this.userId&&a.unique.includes("spatial_targeting")){const t=a.transform.rot-Math.PI/2,e=Math.cos(t),s=Math.sin(t),i=Math.sqrt(l.velocity.x**2+l.velocity.y**2),o=l.velocity.x/i,r=l.velocity.y/i,n=.05,h=o+(e-o)*n,d=r+(s-r)*n,c=Math.sqrt(h**2+d**2);l.velocity.x=h/c*i,l.velocity.y=d/c*i,l.transform.rot=Math.atan2(l.velocity.y,l.velocity.x)}l.transform.pos.x+=l.velocity.x*t,l.transform.pos.y+=l.velocity.y*t;const d=Math.sqrt(l.velocity.x*l.velocity.x+l.velocity.y*l.velocity.y)*t;if(l.distanceTraveled+=d,this.collisionsManager.collisionsEnabled(a)){const t=l.transform.pos.x-o,s=l.transform.pos.y-r,i=Math.sqrt(t*t+s*s),d=this.collisionsManager.getPlayerCollider(a);if(a.unique.includes("kinetic_brain")&&i<=4*d&&i>d+l.size&&l.ownerId!==this.userId&&this.luckController.luckRoll()){console.log("Kinetic Brain activated! Deflecting projectile.");const t={x:(l.transform.pos.x-o)/i,y:(l.transform.pos.y-r)/i},e=this.utility.getRandomNum(.85,.95),s=this.utility.getReflection(l.velocity,t);return l.velocity.x=s.x*e,l.velocity.y=.85*s.y,l.ownerId=this.userId,l.color=a.actions.primary.projectile.color,l.transform.rot=Math.atan2(l.velocity.y,l.velocity.x),void this.roomManager.sendMessage(JSON.stringify({type:"projectile-update",projectileId:l.id,newOwnerId:this.userId,velocity:l.velocity,color:l.color}))}if(i<=d+l.size){e.push(h);const t=Math.max(0,l.damage-n.defense);n.health.value=Math.max(0,n.health.value-t);const s=n.health.value,i={target:a,shooterId:l.ownerId,damage:l.damage,newHealth:s,source:l,wasKill:s<=0};this.playerController.playerHit(i)}}if(l.ownerId===this.userId&&this.playerState.players.forEach((t,a)=>{if(this.collisionsManager.collisionsEnabled(t)){const a=l.transform.pos.x-t.transform.pos.x,s=l.transform.pos.y-t.transform.pos.y;if(Math.sqrt(a*a+s*s)<=this.collisionsManager.getPlayerCollider(t)+l.size){e.push(h);const a=Math.max(0,l.damage-t.stats.defense),s=Math.max(0,t.stats.health.value-a);t.stats.health.value=s;const i={target:t,shooterId:this.userId,damage:l.damage,newHealth:s,source:l,wasKill:s<=0};this.playerController.playerHit(i)}}}),(l.distanceTraveled>=l.range||l.transform.pos.x<0||l.transform.pos.x>s||l.transform.pos.y<0||l.transform.pos.y>i)&&(e.push(h),l.ownerId===this.userId)){const t=l.transform.pos.x,e=l.transform.pos.y;if(this.triggerCollisionUniques(l.transform.pos),this.roomManager.sendMessage(JSON.stringify({type:"projectile-remove",projectileId:h})),!(t>=0&&t<=s&&e>=0&&e<=i))return;const n=a.inventory.primary;if(l.distanceTraveled>=l.range){const a={id:`impact_${h}`,pos:{x:t,y:e},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.projectile};this.decalsManager.createDecal(a)}const d={id:`sparks_${h}`,pos:{x:t,y:e},particleParams:this.particlesManager.particlesConfig.weaponParticles[n].projectile.sparks};this.particlesManager.createParticles(d);const c=this.world.getMaterialAt(Math.round(t),Math.round(e));if(!c)return void console.warn("No material returned from hit.");const m=c.name.toLowerCase(),u=this.audioConfig.resources.sfx.impact[m];if(!u)return void console.warn("No impact sounds for:",m);const g=u[l.type];if(!g||g.length<=0)return void console.warn("No impact soundlist for:",u);const p={src:this.utility.getRandomInArray(g),listener:{x:o,y:r},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:t,y:e}},volume:{min:.965,max:1}};this.audioManager.playAudioNetwork(p),this.world.worldEdit.requestCraterAt(l.transform.pos)}}),e.forEach(t=>{this.projectiles.delete(t)})}toggleAutoFire(t){this.playerState.canAutoFire=!0;const e=this.playerState.myPlayer.actions.primary.buffer;this.playerState.myPlayer.actions.primary.buffer*=.5,console.log(`Auto-fire enabled until ${t}`),this.utility.safeTimeout(()=>{this.playerState.canAutoFire=!1,this.playerState.myPlayer.actions.primary.buffer=e,console.log("Auto-fire disabled.")},t-Date.now())}triggerUnique(e,a){if("cluster_module"===e&&a){const e=this.utility.getRandomInt(3,6),s=[];for(let a=0;a<e;a++)s.push(this.utility.getRandomInArray(t));const i={amount:e,damage:.1*this.playerState.myPlayer.actions.primary.projectile.damage,images:s,lifetime:{min:100,max:500},pos:{x:a.x,y:a.y},size:{min:8,max:14},speed:{min:10,max:15},torque:{min:-360,max:360}};this.particlesManager.spawnShrapnel(i)}if("projectile_array"===e){const t=this.utility.getRandomInt(1,3);for(let e=0;e<t;e++){const t=this.utility.getRandomDirection(360),e={canTriggerUnique:!1,damage:this.playerState.myPlayer.actions.primary.projectile.damage/2,range:this.utility.getRandomNum(this.playerState.myPlayer.actions.primary.projectile.range/2,this.playerState.myPlayer.actions.primary.projectile.range),spread:this.utility.getRandomNum(this.playerState.myPlayer.actions.primary.projectile.spread,2*this.playerState.myPlayer.actions.primary.projectile.spread)};this.launchProjectile(t,e)}}console.log(`Triggered Unique: ${e}`)}triggerBurstUniques(){const t=[];if(this.playerState.myPlayer.unique.includes("muzzle_splitter")&&this.luckController.luckRoll()){const e=this.playerState.myPlayer.transform.rot-Math.PI/2,a=Math.PI/180*10,s={x:Math.cos(e-a),y:Math.sin(e-a)},i={x:Math.cos(e+a),y:Math.sin(e+a)},o={canTriggerUnique:!1,damage:this.playerState.myPlayer.actions.primary.projectile.damage,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,color:this.playerState.myPlayer.actions.primary.projectile.color,length:this.playerState.myPlayer.actions.primary.projectile.length,spread:this.playerState.myPlayer.actions.primary.projectile.spread};this.launchProjectile(s,o),this.launchProjectile(i,o),console.log("Triggered burst unique: muzzle_splitter"),t.push("muzzle_splitter")}return t}triggerCollisionUniques(t){if(0===this.playerState.myPlayer.unique.length)return[];const e=[];for(const a of this.playerState.myPlayer.unique)"cluster_module"===a&&this.luckController.luckRoll()&&(this.triggerUnique(a,t),e.push("cluster_module"));return e}canReload(){return!this.playerState.isReloading&&this.playerState.myPlayer.actions.primary.magazine.currentAmmo<this.playerState.myPlayer.actions.primary.magazine.size&&this.playerState.myPlayer.actions.primary.magazine.currentReserve>0&&!this.playerState.isMelee}startReload(){if(!this.canReload())return;console.log("Reloading..."),this.playerState.isReloading=!0,this.playerState.reloadStartTime=Date.now(),this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0,this.decalsManager.spawnMagazineDecal(),this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:8}},duration:0,partIndex:1});const t=this.playerState.myPlayer.inventory.primary,e=this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[t].reload?.start??[]);e?this.audioManager.playAudioNetwork({src:e,listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}}):console.warn(`No reload sounds for ${t}`)}finishReload(){console.log("Reload complete...");const t=this.playerState.myPlayer.actions.primary.magazine.size-this.playerState.myPlayer.actions.primary.magazine.currentAmmo,e=Math.min(t,this.playerState.myPlayer.actions.primary.magazine.currentReserve);this.playerState.myPlayer.actions.primary.magazine.currentAmmo+=e,this.playerState.myPlayer.actions.primary.magazine.currentReserve-=e,this.playerState.isReloading=!1,this.ui.ammoReservesUIController.removeAmmoFromReserveUI(e),this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:20},1:{x:0,y:0}},duration:175,partIndex:1});const a=this.playerState.myPlayer.inventory.primary,s=this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[a].reload?.end??[]);s?this.audioManager.playAudioNetwork({src:s,listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}}):console.warn(`No reload sounds for ${a}`)}}class U{constructor(t,e,a,s,i,o,r){this.collisionsManager=t,this.combatController=e,this.moveController=a,this.playerState=s,this.roomManager=i,this.staminaController=o,this.userId=r}startDash(){if(this.playerState.isDashing||!this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)||!this.moveController.isMoveInput())return;const t=Date.now();if(t<this.playerState.lastDashTime+this.playerState.myPlayer.actions.dash.cooldown)return void console.log("Dash on cooldown");let{inputX:e,inputY:a,inputLength:s}=this.moveController.getMoveInput();if(!this.moveController.isMoveInput())return void console.log("No movement input for dash");if(e/=s,a/=s,!this.staminaController.requestStamina(this.playerState.myPlayer.actions.dash.drain))return void console.log("Not enough stamina to dash");this.playerState.myPlayer.unique.includes("spectral_image")&&(this.playerState.myPlayer.flags.hidden=!0,this.playerState.myPlayer.flags.invulnerable=!0,this.roomManager.sendMessage(JSON.stringify({type:"partial-state",userId:this.userId,flags:{hidden:!0,invulnerable:!0}}))),this.playerState.isDashing=!0,this.playerState.dashStartTime=t,this.playerState.lastDashTime=t;const i=this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.dash.multiplier;this.playerState.playerVelocityX=e*i,this.playerState.playerVelocityY=a*i,console.log(`Dashing! Speed: ${i}`)}updateDash(t){if(!this.playerState.isDashing)return;const e=Date.now();let a=this.playerState.myPlayer.transform.pos.x+this.playerState.playerVelocityX*t,s=this.playerState.myPlayer.transform.pos.y+this.playerState.playerVelocityY*t;this.playerState.myPlayer.transform.pos.x=a,this.playerState.myPlayer.transform.pos.y=s;let i=0!==this.playerState.playerVelocityX||0!==this.playerState.playerVelocityY;const o=Math.sqrt((this.playerState.myPlayer.transform.pos.x-this.playerState.lastSentX)**2+(this.playerState.myPlayer.transform.pos.y-this.playerState.lastSentY)**2);i&&o>2&&e-this.playerState.lastSentMoveTime>=10&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}}})),this.playerState.lastSentX=this.playerState.myPlayer.transform.pos.x,this.playerState.lastSentY=this.playerState.myPlayer.transform.pos.y,this.playerState.lastSentMoveTime=e),e>=this.playerState.dashStartTime+this.playerState.myPlayer.actions.dash.time&&(this.playerState.myPlayer.unique.includes("spectral_image")&&(this.playerState.myPlayer.flags.hidden=!1,this.playerState.myPlayer.flags.invulnerable=!1,this.roomManager.sendMessage(JSON.stringify({type:"partial-state",userId:this.userId,flags:{hidden:!1,invulnerable:!1}}))),this.playerState.isDashing=!1,this.playerState.myPlayer.equipment.includes("switch")&&this.combatController.toggleAutoFire(Date.now()+this.playerState.myPlayer.actions.dash.cooldown),console.log("Dash ended"))}}class W{constructor(t){this.playerState=t}luckRoll(t=1){const e=this.playerState.myPlayer.stats.luck*t,a=.1+.35*Math.tanh(e/10);return Math.random()<a}}class F{constructor(t,e,a){this.controlsManager=t,this.playerState=e,this.settingsManager=a,this.currentSpeed=0,this.maxSpeed=0}getMoveInput(){let t=0,e=0;this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveUp)&&(e-=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveDown)&&(e+=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveLeft)&&(t-=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveRight)&&(t+=1);const a=Math.sqrt(t*t+e*e);return a>0&&(t/=a,e/=a),{inputX:t,inputY:e,inputLength:a}}isMoveInput(){return this.getMoveInput().inputLength>0}isMoving(){return Math.abs(this.playerState.playerVelocityX)>.01||Math.abs(this.playerState.playerVelocityY)>.01}getMoveSpeed(){return this.currentSpeed=Math.sqrt(this.playerState.playerVelocityX**2+this.playerState.playerVelocityY**2)}getMaxSpeed(){return this.maxSpeed=this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.sprint.multiplier}}class V{constructor(){this.default={actions:{dash:{cooldown:1e3,drain:40,multiplier:3,time:150},melee:{cooldown:250,damage:10,duration:100,range:10,size:2},primary:{buffer:250,burst:{amount:1,delay:75},magazine:{size:10,startingReserve:20,maxReserve:50},offset:10,projectile:{amount:1,color:"#fff5beff",damage:25,length:15,range:5,size:1,speed:35,spread:10},reload:{time:750}},sprint:{drain:5,multiplier:1.75}},data:{idLength:12,idOffset:25},equipment:[],flags:{hidden:!1,invulnerable:!1},inventory:{primary:"glock",melee:"knife"},physics:{acceleration:.65,friction:T.o7.Normal},rig:{body:"default",head:"default",headwear:"default",weapon:"glock"},stats:{defense:0,health:{max:100},luck:1,size:100,speed:6,stamina:{max:100,recovery:{delay:1e3,rate:25}}},unique:[]}}}class G{constructor(t,e,a,s,i,o,r,n,l,h,d,c,m,u){this.audioConfig=t,this.audioManager=e,this.decalsManager=a,this.gameState=s,this.luckController=i,this.moveController=o,this.objectsManager=r,this.particlesManager=n,this.playerState=l,this.roomManager=h,this.ui=d,this.userId=c,this.utility=m,this.world=u,this.footstepInterval=0,this.lastFootstepTime=0,this.FOOTSTEP_INTERVAL_MIN=200,this.FOOTSTEP_INTERVAL_MAX=500,this.FOOTSTEP_SAMPLE_RADIUS=8,this.MEDIUM_WATER_DEPTH=.35,this.DEEP_WATER_DEPTH=.6,this.POSITION_SAMPLE_INTERVAL=250,this.lastSampleTime=0,this.lastWaterData=null,this.lastFriction=0,this.lastStrokeTime=0,this.strokePower=0,this.lastSwimDir={x:0,y:0},this.STROKE_FORCE=7.5,this.STROKE_DECAY_RATE=.996,this.STROKE_COOLDOWN=.8,this.MAX_SWIM_SPEED=3.5,this.setupEventListeners(),this.initSwimDebugMenu()}setupEventListeners(){window.addEventListener("customEvent_playerHitRelay",t=>{console.log("Player hit event received:",t.detail.params),this.playerHit(t.detail.params)})}updatePlayerPosition(t){if(!this.gameState.gameInProgress||this.playerState.myPlayer.stats.health.value<=0)return;const e=Date.now(),{inputX:a,inputY:s}=this.moveController.getMoveInput(),i=this.moveController.isMoveInput();if(this.moveController.isMoving()&&e-this.lastSampleTime>=this.POSITION_SAMPLE_INTERVAL&&this.samplePlayerPosition(e),this.applyEnvironmentalFriction(t),this.playerState.isSwimming?this.handleSwimming(t,a,s,i):this.playerState.isDashing||this.handleGroundMovement(t,a,s,i),this.playerState.myPlayer.transform.pos.x+=this.playerState.playerVelocityX*t,this.playerState.myPlayer.transform.pos.y+=this.playerState.playerVelocityY*t,this.syncMovement(e),!this.playerState.isSwimming&&this.moveController.isMoving()){const t=Math.min(1,this.moveController.getMoveSpeed()/this.moveController.getMaxSpeed());this.footstepInterval=this.FOOTSTEP_INTERVAL_MAX-t*(this.FOOTSTEP_INTERVAL_MAX-this.FOOTSTEP_INTERVAL_MIN),e-this.lastFootstepTime>=this.footstepInterval&&(this.footstep(),this.lastFootstepTime=e)}}handleGroundMovement(t,e,a,s){const i=this.playerState.isSprinting&&this.playerState.myPlayer.stats.stamina.value>0&&s?this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.sprint.multiplier:this.playerState.myPlayer.stats.speed;if(this.playerState.isSprinting&&this.playerState.myPlayer.stats.stamina.value<=0&&(this.playerState.isSprinting=!1,console.log("Out of stamina, stopped sprinting")),s){const s=this.playerState.myPlayer.physics.acceleration,o=e*i,r=a*i;this.playerState.playerVelocityX+=(o-this.playerState.playerVelocityX)*s*t,this.playerState.playerVelocityY+=(r-this.playerState.playerVelocityY)*s*t}}initSwimDebugMenu(){window.addEventListener("keydown",t=>{t.ctrlKey&&"Numpad5"===t.code&&this.toggleSwimDebugMenu()})}toggleSwimDebugMenu(){let t=document.getElementById("swimDebugPanel");if(t)return t.remove(),void console.log("Swim Debug Menu closed");t=document.createElement("div"),t.id="swimDebugPanel",t.style.position="fixed",t.style.top="20px",t.style.right="20px",t.style.background="rgba(0,0,0,0.8)",t.style.color="#fff",t.style.padding="10px",t.style.zIndex="9999",t.style.fontFamily="monospace",t.style.fontSize="12px",t.style.border="1px solid #555",t.style.width="200px",[{key:"STROKE_FORCE",min:1,max:200,step:1},{key:"STROKE_DECAY_RATE",min:.8,max:.999,step:.001},{key:"STROKE_COOLDOWN",min:.1,max:3,step:.05},{key:"MAX_SWIM_SPEED",min:1,max:10,step:.1}].forEach(e=>{const a=document.createElement("label");a.textContent=e.key,a.style.display="block";const s=document.createElement("input");s.type="range",s.min=String(e.min),s.max=String(e.max),s.step=String(e.step),s.value=String(this[e.key]);const i=document.createElement("span");i.textContent=" "+this[e.key],s.addEventListener("input",()=>{const t=parseFloat(s.value);this[e.key]=t,i.textContent=" "+t.toFixed(3),console.log(`Adjusted ${e.key}: ${t}`)}),t.appendChild(a),t.appendChild(s),t.appendChild(i)}),document.body.appendChild(t),console.log("Swim Debug Menu opened")}handleSwimming(t,e,a,s){this.playerState.isSprinting=!1,this.playerState.isDashing=!1;const i=performance.now();if(!s)return void(this.strokePower=0);this.lastSwimDir.x=e,this.lastSwimDir.y=a,i-this.lastStrokeTime>=1e3*this.STROKE_COOLDOWN&&(this.strokePower=this.STROKE_FORCE,this.lastStrokeTime=i,console.log("Swim stroke triggered | Power: "+this.strokePower)),this.strokePower>0&&(this.playerState.playerVelocityX+=this.lastSwimDir.x*this.strokePower*t,this.playerState.playerVelocityY+=this.lastSwimDir.y*this.strokePower*t,this.strokePower*=Math.pow(this.STROKE_DECAY_RATE,60*t));const o=this.playerState.playerVelocityX,r=this.playerState.playerVelocityY,n=Math.sqrt(o*o+r*r);if(n>this.MAX_SWIM_SPEED){const t=this.MAX_SWIM_SPEED/n;this.playerState.playerVelocityX*=t,this.playerState.playerVelocityY*=t}}syncMovement(t){const e=Math.sqrt((this.playerState.myPlayer.transform.pos.x-this.playerState.lastSentX)**2+(this.playerState.myPlayer.transform.pos.y-this.playerState.lastSentY)**2);this.moveController.isMoving()&&e>2&&t-this.playerState.lastSentMoveTime>=10&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:this.playerState.myPlayer.transform.pos}})),this.playerState.lastSentX=this.playerState.myPlayer.transform.pos.x,this.playerState.lastSentY=this.playerState.myPlayer.transform.pos.y,this.playerState.lastSentMoveTime=t)}applyEnvironmentalFriction(t){let e=this.lastFriction;if(this.lastWaterData&&this.lastWaterData.hasWater){const t=this.lastWaterData.waterLevel;if(t>=this.DEEP_WATER_DEPTH)e=T.mA.Water;else{const a=this.utility.clamp(t/this.DEEP_WATER_DEPTH,0,1),s=1-Math.pow(a,2);e=this.lastFriction*(1-.25*s)}}e=this.utility.clamp(e,.7,1);const a=Math.pow(e,t);this.playerState.playerVelocityX*=a,this.playerState.playerVelocityY*=a}samplePlayerPosition(t){const e=this.playerState.myPlayer.transform.pos,a={x:Math.round(e.x),y:Math.round(e.y)};this.lastWaterData=this.world.getWaterData(a),this.lastSampleTime=t;const s=this.world.getPhysicsAt(a.x,a.y);if(s&&"friction"in s){const t=s.friction;"number"==typeof t&&(this.lastFriction=t,console.log("Updated surface friction:",t))}if(this.lastWaterData&&this.lastWaterData.hasWater){const t=this.lastWaterData.waterLevel>=this.DEEP_WATER_DEPTH;t&&!this.playerState.isSwimming?(this.playerState.isSwimming=!0,console.log("Entered swimming state, waterLevel: "+this.lastWaterData.waterLevel)):!t&&this.playerState.isSwimming&&(this.playerState.isSwimming=!1,console.log("Exited swimming state, waterLevel: "+this.lastWaterData.waterLevel))}else this.playerState.isSwimming&&(this.playerState.isSwimming=!1,console.log("Exited swimming state, no water detected"))}playerHit(t){if(this.ui.updateSlider("health"),t.target.id===this.userId){if(this.utility.getRandomNum(0,1)<.2){const t={src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.player.voice.voice_00.grunt),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"voice",pitch:{min:.95,max:1.075},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.9,max:1}};this.audioManager.playAudioNetwork(t)}}else{const e={src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.impact.flesh.ranged),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.925,max:1.15},spatial:{blend:1,pos:{x:t.source.transform.pos.x,y:t.source.transform.pos.y}},volume:{min:.95,max:1}};this.audioManager.playAudioNetwork(e);const a={id:`blood_${t.source.id}`,pos:{x:t.source.transform.pos.x,y:t.source.transform.pos.y},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.blood};this.decalsManager.createDecal(a);const s={x:-t.source.velocity.x/Math.sqrt(t.source.velocity.x**2+t.source.velocity.y**2),y:-t.source.velocity.y/Math.sqrt(t.source.velocity.x**2+t.source.velocity.y**2)},i={id:`blood_${t.source.id}`,pos:{x:t.source.transform.pos.x,y:t.source.transform.pos.y},particleParams:this.particlesManager.particlesConfig.goreParticles.blood.spray,direction:s};this.particlesManager.createParticles(i);const o={id:`particle_emitter_${t.target.id}_${Date.now()}`,interval:this.utility.getRandomNum(200,400),lifetime:this.utility.getRandomNum(1e3,3e3),offset:{x:t.target.transform.pos.x,y:t.target.transform.pos.y},particleType:this.particlesManager.particlesConfig.goreParticles.blood.drip,playerId:t.target.id,pos:{x:t.source.transform.pos.x,y:t.source.transform.pos.y}};if(this.particlesManager.createEmitter(o),t.newHealth<=0){console.log(`I killed ${t.target.id}!`);const e=this.ui.leaderboard.get(this.userId);e&&e.kills++;const a=this.ui.leaderboard.get(t.target.id);a&&a.deaths++,this.ui.updateLeaderboardDisplay(this.userId)}}const e={type:"player-hit",targetId:t.target.id,shooterId:t.shooterId,damage:t.damage,newHealth:t.newHealth,projectileId:t.source.id,wasKill:t.wasKill};this.roomManager.sendMessage(JSON.stringify(e))}playerDeath(){this.triggerUniques(),console.log("I died! Waiting for round to end..."),this.playerState.resetPlayerState();const t=this.objectsManager.spawnAmmoBox(10);this.objectsManager.ammoBoxes.set(t.id,t);const e={gore:{amount:this.utility.getRandomInt(2,5)},blood:{amount:this.utility.getRandomInt(1,3)},ownerId:this.userId,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},radius:this.playerState.myPlayer.stats.size};this.decalsManager.generateGore(e),this.roomManager.sendMessage(JSON.stringify({type:"player-death",playerId:this.userId,x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y,size:this.playerState.myPlayer.stats.size,ammoBox:t}))}triggerUniques(){if(0===this.playerState.myPlayer.unique.length)return[];const t=[];for(const e of this.playerState.myPlayer.unique)if("phoenix_module"===e&&this.luckController.luckRoll(1.5)){console.log("Phoenix Module activated!"),this.playerState.myPlayer.actions.primary.projectile.damage*=2;const e=this.playerState.myPlayer.unique.indexOf("phoenix_module");e>-1&&this.playerState.myPlayer.unique.splice(e,1),t.push("phoenix_module")}return t}footstep(){const t=this.playerState.myPlayer.transform.pos,e=new Map;for(let a=0;a<8;a++){const s=a/8*Math.PI*2,i=Math.round(t.x+Math.cos(s)*this.FOOTSTEP_SAMPLE_RADIUS),o=Math.round(t.y+Math.sin(s)*this.FOOTSTEP_SAMPLE_RADIUS),r=this.world.getMaterialAt(i,o);r&&e.set(r.name,(e.get(r.name)||0)+1)}let a=null,s=0;if(e.forEach((t,e)=>{t>s&&(s=t,a=e)}),!a)return;const i=this.lastWaterData,o=i&&i.hasWater?this.utility.clamp(i.waterLevel,0,1):0,r=o>.05,n=this.moveController.getMoveSpeed(),l=this.moveController.getMaxSpeed(),h=Math.min(1,n/l),d={pos:t,material:a,waterRatio:o,isWet:r,speedRatio:h};this.footstepSound(d),this.footstepImpact(d)}footstepSound(t){const{pos:e,material:a,waterRatio:s,isWet:i,speedRatio:o}=t,r=this.audioConfig.resources.sfx.player.locomotion.footsteps,n=r[a];if(!n||!Array.isArray(n)||0===n.length)return;const l=.075*o+.1*s,h=.001+l,d=.01+l,c=.95+.03*o,m=1.05+.03*o,u=Math.min(1,6*s),g=1-u,p=.5+.5*u,y=.04*(1-o);if(s<this.MEDIUM_WATER_DEPTH){const t={src:this.utility.getRandomInArray(n),listener:e,output:"sfx",pitch:{min:c,max:m},startTime:{min:y,max:y+.005},volume:{min:h*g,max:d*g}};this.audioManager.playAudio(t)}if(i){const t=r.water;let a=[];if(s>0&&s<this.MEDIUM_WATER_DEPTH?a=t.light:s>=this.MEDIUM_WATER_DEPTH&&(a=t.medium),a.length>0){const t=.04*o,s={src:this.utility.getRandomInArray(a),listener:e,output:"sfx",pitch:{min:c,max:m},startTime:{min:t,max:t+.005},volume:{min:h*p,max:d*p},delay:{min:.015,max:.02}};this.audioManager.playAudio(s)}}}footstepImpact(t){const{pos:e,material:a,speedRatio:s,waterRatio:i}=t,o=(.4+.6*s)*(1-.5*i);this.world.worldEdit.applyFootstepAt(e,a,o)}}class K{constructor(t,e,a){this.playerConfig=t,this.userId=e,this.utility=a,this.players=new Map,this.isHost=!1,this.canShoot=!0,this.canAutoFire=!1,this.isBurstActive=!1,this.isReloading=!1,this.isMelee=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.isSwimming=!1,this.lastSentX=0,this.lastSentY=0,this.lastSentRotation=0,this.lastSentRotationTime=0,this.lastSentMoveTime=0,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastShotTime=0,this.lastMeleeTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0,this.statListeners=new Map,this.myPlayer=this.initPlayer(this.userId)}clear(){this.players.clear(),this.resetPlayerState()}initPlayer(t){return this.myPlayer={id:t,transform:{pos:{x:3170*Math.random()+o,y:2370*Math.random()+o},rot:0},timestamp:Date.now(),color:this.utility.getRandomColor(),actions:{dash:{cooldown:this.playerConfig.default.actions.dash.cooldown,drain:this.playerConfig.default.actions.dash.drain,multiplier:this.playerConfig.default.actions.dash.multiplier,time:this.playerConfig.default.actions.dash.time},melee:{cooldown:this.playerConfig.default.actions.melee.cooldown,damage:this.playerConfig.default.actions.melee.damage,duration:this.playerConfig.default.actions.melee.duration,range:this.playerConfig.default.actions.melee.range,size:this.playerConfig.default.actions.melee.size},primary:{buffer:this.playerConfig.default.actions.primary.buffer,burst:{amount:this.playerConfig.default.actions.primary.burst.amount,delay:this.playerConfig.default.actions.primary.burst.delay},magazine:{currentAmmo:this.playerConfig.default.actions.primary.magazine.size,currentReserve:this.playerConfig.default.actions.primary.magazine.startingReserve,maxReserve:this.playerConfig.default.actions.primary.magazine.maxReserve,size:this.playerConfig.default.actions.primary.magazine.size},offset:this.playerConfig.default.actions.primary.offset,projectile:{amount:this.playerConfig.default.actions.primary.projectile.amount,color:this.playerConfig.default.actions.primary.projectile.color,damage:this.playerConfig.default.actions.primary.projectile.damage,length:this.playerConfig.default.actions.primary.projectile.length,range:this.playerConfig.default.actions.primary.projectile.range,size:this.playerConfig.default.actions.primary.projectile.size,speed:this.playerConfig.default.actions.primary.projectile.speed,spread:this.playerConfig.default.actions.primary.projectile.spread},reload:{time:this.playerConfig.default.actions.primary.reload.time}},sprint:{drain:this.playerConfig.default.actions.sprint.drain,multiplier:this.playerConfig.default.actions.sprint.multiplier}},equipment:this.playerConfig.default.equipment,flags:{hidden:this.playerConfig.default.flags.hidden,invulnerable:this.playerConfig.default.flags.invulnerable},inventory:{primary:this.playerConfig.default.inventory.primary,melee:this.playerConfig.default.inventory.melee},physics:{acceleration:this.playerConfig.default.physics.acceleration,friction:this.playerConfig.default.physics.friction},rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon},stats:{defense:this.playerConfig.default.stats.defense,health:{max:this.playerConfig.default.stats.health.max,value:this.playerConfig.default.stats.health.max},luck:this.playerConfig.default.stats.luck,size:this.playerConfig.default.stats.size,speed:this.playerConfig.default.stats.speed,stamina:{max:this.playerConfig.default.stats.stamina.max,recovery:{delay:this.playerConfig.default.stats.stamina.recovery.delay,rate:this.playerConfig.default.stats.stamina.recovery.rate},value:this.playerConfig.default.stats.stamina.max}},unique:this.playerConfig.default.unique}}resetPlayerState(){this.canShoot=!0,this.isBurstActive=!1,this.isReloading=!1,this.isMelee=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.isSwimming=!1,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastMeleeTime=0,this.lastShotTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0,this.lastSentX=0,this.lastSentY=0,this.lastSentRotation=0,this.lastSentRotationTime=0,this.lastSentMoveTime=0}onStatChange(t,e){this.statListeners.set(t,e)}notifyChange(t,e){const a=this.statListeners.get(t);a&&a(e)}updateStat(t,e){const a=t.split(".");let s=this.myPlayer;for(let t=0;t<a.length-1;t++)s=s[a[t]];const i=a[a.length-1];s[i]=e,console.log(`${i}: ${e}`),this.notifyChange(t,e)}}class Y{constructor(t){this.playerState=t}requestStamina(t){return this.playerState.myPlayer.stats.stamina.value<t?(console.log(`Insufficient stamina! Need: ${t}, Have: ${this.playerState.myPlayer.stats.stamina}`),!1):(this.playerState.myPlayer.stats.stamina.value-=t,this.playerState.isStaminaRecoveryBlocked=!0,this.playerState.staminaRecoveryBlockedUntil=Date.now()+this.playerState.myPlayer.stats.stamina.recovery.delay,console.log(`Stamina drained: -${t}, Remaining: ${this.playerState.myPlayer.stats.stamina}`),!0)}updateStamina(t){const e=Date.now();if(this.playerState.isSprinting&&e>=this.playerState.lastStaminaDrainTime+100&&(this.requestStamina(this.playerState.myPlayer.actions.sprint.drain)||(this.playerState.isSprinting=!1,console.log("Out of stamina, stopped sprinting")),this.playerState.lastStaminaDrainTime=e),(!this.playerState.isStaminaRecoveryBlocked||e>=this.playerState.staminaRecoveryBlockedUntil)&&(this.playerState.isStaminaRecoveryBlocked=!1,this.playerState.myPlayer.stats.stamina.value<this.playerState.myPlayer.stats.stamina.max&&!this.playerState.isSprinting)){const e=this.playerState.myPlayer.stats.stamina.recovery.rate/1e3*16.67*t;this.playerState.myPlayer.stats.stamina.value=Math.min(this.playerState.myPlayer.stats.stamina.max,this.playerState.myPlayer.stats.stamina.value+e)}}}class X{constructor(t,e,a,s,i){this.version=0,this.pos={x:0,y:0},this.size=0,this.pixelData=e,this.heightData=a,this.waterData=s,this.chosenBiomeName=t,this.worldConfig=i}getColorAt(t,e,a){const s=e*a+t,i=this.pixelData[s],o=i>>2,r=3&i;return this.worldConfig.materialsList[o].colors[r]}getHeightAt(t,e,a){const s=e*a+t;return this.heightData[s]/255}getWaterAt(t,e,a){const s=e*a+t;return this.waterData[s]/255}}class J{constructor(){this.worldgenParams={general:{chunk:{size:128},cell:{size:2},options:{island:!1,valley:!1},seed:0},terrain:{noiseType:T.VA.Perlin,intensity:2,octaves:6,scale:5e-4,persistence:.55,heightCurve:1.5,seaLevel:.18,lowestDepth:.1},material:{noiseType:T.VA.Perlin,scale:.005,detail:{noiseType:T.VA.Perlin,scale:1},colorVariation:.75},degen:{noiseType:T.VA.Perlin,scale:1e-4,intensity:.35,minHeight:.1,threshold:.55,hardness:.5,detail:{noiseType:T.VA.Perlin,scale:.005}},hydration:{noiseType:T.VA.Perlin,intensity:.5,scale:.001,multiplier:1},render:{water:{opacityBase:.55,opacityMultiplier:.975,foamIntensity:1,foamScale:.035,noiseScale:.001,shoreBlend:.0275,shimmerStrength:.15,depthDarkness:1},grid:{active:!1,lineWidth:1,chunkBorderColor:"#a1a1a1",worldBorderColor:"#9747ff",layerBorderColor:"#ff4343",borderWidth:3}}},this.worldgenMessages={bakeStart:["baking chunks...","baking pixels into chunks...","assembling chunks...","chunkifying... is that a word?","packing pixels into chunks...","arranging cells into chunks..."],bakeHalf:["getting close...","thanks for waiting...","almost done...","still chunking...","about 50% of chunks baked...","still baking pixels into chunks...","almost all pixels baked..."],generation:["building cells...","placing pixels...","spawning pixels...","creating cells..."],degeneration:["eroding terrain...","wearing down surfaces...","carving material layers...","degenerating terrain...","exposing layers..."],hydration:["hydrating terrain...","filling water basins...","moisturizing...","creating shores..."],special:["beltalowding...","i love a24 films","tehe","thank you for buying the battlepass..."]},this.regionAudioParams={shore:{minRegionSize:4,radius:400,volume:{min:0,max:.175}},cliffs:{minRegionSize:6,radius:550,volume:{min:0,max:.135}},mountains:{minRegionSize:8,radius:650,volume:{min:0,max:.125}},ocean:{minRegionSize:16,radius:750,volume:{min:0,max:.115}},plains:{minRegionSize:14,radius:1e3,volume:{min:0,max:.1}}},this.worldLayers={foundation:{name:"foundation",height:.05,materials:[{material:"bedrock",weight:10,blend:.1},{material:"granite",weight:6,blend:.2},{material:"basalt",weight:3,blend:.2}]},substrate:{name:"substrate",height:.07,materials:[{material:"granite",weight:6,blend:.3},{material:"limestone",weight:4,blend:.5},{material:"shale",weight:3,blend:.4},{material:"slate",weight:2,blend:.4}]},sediment:{name:"sediment",height:.12,materials:[{material:"silt",weight:4,blend:.9},{material:"sand",weight:5,blend:.9},{material:"sand_wet",weight:3,blend:.1},{material:"gravel",weight:2,blend:.6},{material:"dirt",weight:1,blend:.4}]},alluvium:{name:"alluvium",height:.18,materials:[{material:"silt",weight:3,blend:.95},{material:"sand",weight:6,blend:.9},{material:"sand_wet",weight:3,blend:.1},{material:"gravel",weight:3,blend:.6},{material:"stone",weight:1,blend:.2}]},soil:{name:"soil",height:.3,materials:[{material:"grass",weight:7,blend:.8},{material:"dirt",weight:2,blend:.6},{material:"mud",weight:1,blend:.1},{material:"gravel",weight:2,blend:.7},{material:"stone",weight:1,blend:.3}]},topsoil:{name:"topsoil",height:.45,materials:[{material:"grass",weight:7,blend:.8},{material:"dirt",weight:2,blend:.6},{material:"gravel",weight:1,blend:.4}]},colluvium:{name:"colluvium",height:.7,materials:[{material:"stone",weight:6,blend:.3},{material:"gravel",weight:3,blend:.5},{material:"dirt",weight:1,blend:.6},{material:"snow",weight:1,blend:.8}]},summit:{name:"summit",height:.9,materials:[{material:"stone",weight:2,blend:.3},{material:"gravel",weight:1,blend:.4},{material:"snow",weight:4,blend:.8},{material:"ice",weight:3,blend:.9}]}},this.materials={basalt:{name:"basalt",type:"terrain",colors:["#2e2e2e","#3e3e3e","#4e4e4e","#5e5e5e"],physics:{type:T.wr.Solid,simulate:!1,durability:.8,friction:T.o7.Hard,density:.88},tags:[]},bedrock:{name:"bedrock",type:"terrain",colors:["#2f3236","#3a3e44","#454a52","#50565f"],physics:{type:T.wr.Solid,simulate:!1,durability:1,friction:T.o7.Hard,density:.95},tags:[]},clay:{name:"clay",type:"terrain",colors:["#6f5a4a","#7c6755","#897461","#96816e"],physics:{type:T.wr.Solid,simulate:!1,durability:.2,friction:T.o7.Soft,density:.4},tags:["absorbent","imprint_on_footstep"]},clay_wet:{name:"clay_wet",type:"terrain",colors:["#4a3a2f","#554437","#604e3f","#6b5947"],physics:{type:T.wr.Solid,simulate:!1,durability:.1,friction:T.o7.Wet,density:.4},tags:["imprint_on_footstep","track_on_footstep"]},dirt:{name:"dirt",type:"terrain",colors:["#5b3a1f","#6b4a2f","#7b5a3f","#8b6a4f"],physics:{type:T.wr.Solid,simulate:!1,durability:.2,friction:T.o7.Normal,density:.5},tags:["absorbent","imprint_on_footstep"]},granite:{name:"granite",type:"terrain",colors:["#6e6e6e","#7e7e7e","#8e8e8e","#9e9e9e"],physics:{type:T.wr.Solid,simulate:!1,durability:.9,friction:T.o7.Hard,density:.9},tags:[]},grass:{name:"grass",type:"terrain",colors:["#3a5f3e","#4a6f4e","#5a7f5e","#6a8f6e"],physics:{type:T.wr.Solid,simulate:!1,durability:.2,friction:T.o7.Normal,density:.5},tags:[]},gravel:{name:"gravel",type:"terrain",colors:["#606060","#707070","#808080","#909090"],physics:{type:T.wr.Solid,simulate:!0,durability:.1,friction:T.o7.Soft,density:.3},tags:["imprint_on_footstep"]},ice:{name:"ice",type:"terrain",colors:["#a9d5ff","#8fc5ff","#6fb5ff","#5aa4f2"],physics:{type:T.wr.Solid,simulate:!1,durability:.3,friction:T.o7.Slick,density:.5},tags:[]},permafrost:{name:"permafrost",type:"terrain",colors:["#a4b5ef","#7aabeb","#9bc6f5","#7d92f9"],physics:{type:T.wr.Solid,simulate:!1,durability:.7,friction:T.o7.Slick,density:.8},tags:[]},loam:{name:"loam",type:"terrain",colors:["#2d1f12","#3a2918","#4a361f","#5a4328"],physics:{type:T.wr.Solid,simulate:!1,durability:.2,friction:T.o7.Soft,density:.55},tags:["absorbent"]},limestone:{name:"limestone",type:"terrain",colors:["#c0b8a0","#b0a890","#a09880","#908870"],physics:{type:T.wr.Solid,simulate:!1,durability:.5,friction:T.o7.Hard,density:.7},tags:[]},moss:{name:"moss",type:"terrain",colors:["#264a2f","#2f5a3a","#376a45","#3f7a50"],physics:{type:T.wr.Solid,simulate:!1,durability:.1,friction:T.o7.Soft,density:.4},tags:["absorbent"]},mud:{name:"mud",type:"terrain",colors:["#3b2416","#4a2e1d","#583924","#66452b"],physics:{type:T.wr.Solid,simulate:!1,durability:.1,friction:T.o7.Wet,density:.6},tags:["imprint_on_footstep","track_on_footstep"]},peat:{name:"peat",type:"terrain",colors:["#1a150f","#241e16","#2e271e","#383024"],physics:{type:T.wr.Solid,simulate:!1,durability:.1,friction:T.o7.Soft,density:.3},tags:["absorbent"]},sand:{name:"sand",type:"terrain",colors:["#b2a280","#c2b290","#d2c2a0","#e2d2b0"],physics:{type:T.wr.Solid,simulate:!0,durability:.1,friction:T.o7.Soft,density:.2},tags:["absorbent","imprint_on_footstep"]},sand_wet:{name:"sand_wet",type:"terrain",colors:["#8f7e5e","#9d8d6c","#ab9c7a","#b9ab88"],physics:{type:T.wr.Solid,simulate:!1,durability:.1,friction:T.o7.Wet,density:.3},tags:["imprint_on_footstep","track_on_footstep"]},sandstone:{name:"sandstone",type:"terrain",colors:["#c2b290","#b2a280","#a29270","#928260"],physics:{type:T.wr.Solid,simulate:!1,durability:.4,friction:T.o7.Hard,density:.65},tags:[]},scree:{name:"scree",type:"terrain",colors:["#868680","#8f8f88","#999990","#a3a399"],physics:{type:T.wr.Solid,simulate:!1,durability:.4,friction:T.o7.Hard,density:.65},tags:[]},shale:{name:"shale",type:"terrain",colors:["#4f555d","#5a616a","#656d77","#707a85"],physics:{type:T.wr.Solid,simulate:!1,durability:.4,friction:T.o7.Hard,density:.7},tags:[]},silt:{name:"silt",type:"terrain",colors:["#7a7362","#777165","#6b6965","#6d6755"],physics:{type:T.wr.Solid,simulate:!0,durability:.1,friction:T.o7.Soft,density:.3},tags:["absorbent","imprint_on_footstep"]},silt_wet:{name:"silt_wet",type:"terrain",colors:["#5e5648","#655d4f","#6c6453","#746b57"],physics:{type:T.wr.Solid,simulate:!1,durability:.1,friction:T.o7.Wet,density:.4},tags:["imprint_on_footstep","track_on_footstep"]},slate:{name:"slate",type:"terrain",colors:["#4a4f55","#555a60","#60656b","#6b7076"],physics:{type:T.wr.Solid,simulate:!1,durability:.6,friction:T.o7.Hard,density:.75},tags:[]},snow:{name:"snow",type:"terrain",colors:["#ffffff","#e6eef5","#dfe8f2","#cfdceb"],physics:{type:T.wr.Solid,simulate:!1,durability:.2,friction:T.o7.Sticky,density:.4},tags:["absorbent","imprint_on_footstep"]},stone:{name:"stone",type:"terrain",colors:["#707070","#808080","#909090","#a0a0a0"],physics:{type:T.wr.Solid,simulate:!1,durability:.5,friction:T.o7.Hard,density:.75},tags:[]},coal:{name:"coal",type:"mineral",colors:["#0a0a0a","#1a1a1a","#2a2a2a","#3a3a3a"],physics:{type:T.wr.Solid,simulate:!1,durability:.6,friction:T.o7.Hard,density:.55},tags:[]},iron:{name:"iron",type:"mineral",colors:["#7b3716","#8b4726","#9b5736","#ab6746"],physics:{type:T.wr.Solid,simulate:!1,durability:.7,friction:T.o7.Hard,density:.9},tags:[]},gold:{name:"gold",type:"mineral",colors:["#eec700","#fed700","#ffe700","#fff74c"],physics:{type:T.wr.Solid,simulate:!1,durability:.8,friction:T.o7.Hard,density:.8},tags:[]},silver:{name:"silver",type:"mineral",colors:["#b0b0b0","#c0c0c0","#d0d0d0","#e0e0e0"],physics:{type:T.wr.Solid,simulate:!1,durability:.7,friction:T.o7.Hard,density:.75},tags:[]},copper:{name:"copper",type:"mineral",colors:["#a86323","#b87333","#c88343","#d89353"],physics:{type:T.wr.Solid,simulate:!1,durability:.6,friction:T.o7.Hard,density:.7},tags:[]},flesh:{name:"flesh",type:"organic",colors:["#c895e3","#b94e51","#be6987","#c04444"],physics:{type:T.wr.Solid,simulate:!1,durability:.2,friction:T.o7.Soft,density:.4},tags:[]},wood:{name:"wood",type:"surface",colors:["#7b3503","#8b4513","#9b5523","#ab6533"],physics:{type:T.wr.Solid,simulate:!1,durability:.4,friction:T.o7.Hard,density:.5},tags:[]},concrete:{name:"concrete",type:"surface",colors:["#2a2a2a","#3a3a3a","#4a4a4a","#5a5a5a"],physics:{type:T.wr.Solid,simulate:!1,durability:.8,friction:T.o7.Hard,density:.65},tags:[]},metal:{name:"metal",type:"surface",colors:["#4a4a4a","#6a6a6a","#7a7a7a","#8a8a8a"],physics:{type:T.wr.Solid,simulate:!1,durability:.9,friction:T.o7.Hard,density:.8},tags:[]},asphalt:{name:"asphalt",type:"surface",colors:["#1b1b1b","#2b2b2b","#3b3b3b","#4b4b4b"],physics:{type:T.wr.Solid,simulate:!1,durability:.8,friction:T.o7.Hard,density:.7},tags:[]},water:{name:"water",type:"liquid",colors:["#2d6bc9","#2450a6","#1f3f8a","#1a2f6e"],physics:{type:T.wr.Liquid,simulate:!0,friction:T.mA.Water,viscosity:.2},tags:[]}},this.materialIndex={},this.worldLayerIndex={},this.materialsList=[],this.worldLayerList=[],this.materialsList=Object.values(this.materials),this.worldLayerList=Object.values(this.worldLayers),this.materialsList.forEach((t,e)=>{this.materialIndex[t.name]=e}),this.worldLayerList.forEach((t,e)=>{this.worldLayerIndex[t.name]=e})}getWorldgenMessage(t){const e=this.worldgenMessages;if(Math.random()<=.01&&e.special.length>0){const t=Math.floor(Math.random()*e.special.length);return e.special[t]}const a=e[t];return a&&0!==a.length?a[Math.floor(Math.random()*a.length)]:"loading..."}}class Z{constructor(t,e,a,s,i){this.camera=t,this.controlsManager=e,this.ui=a,this.utility=s,this.world=i,this.hoveredChunk=null,this.overlayMode=0,this.overlayNames=["Chunk","Heightmap","Contours","Regions","Audio"],this.listenForDebugShortcuts()}listenForDebugShortcuts(){window.addEventListener("keydown",t=>{if(t.ctrlKey&&t.altKey){if(!this.world.isGenerated)return;switch(t.code){case"Numpad0":t.preventDefault(),console.log("Opening generation menu..."),this.world.showGenerationMenu().then(async t=>{"load"!==t&&await this.world.generateWorld(t)});break;case"NumpadDecimal":t.preventDefault(),console.log("Refreshing world rendering..."),this.world.renderMenu();break;case"NumpadEnter":t.preventDefault(),this.world.worldConfig.worldgenParams.render.grid.active=!this.world.worldConfig.worldgenParams.render.grid.active,this.world.worldConfig.worldgenParams.render.grid.active||(this.hoveredChunk=null),console.log("Overlay "+(this.world.worldConfig.worldgenParams.render.grid.active?"enabled":"disabled")+" (mode: "+this.overlayNames[this.overlayMode]+")"),this.world.worldConfig.worldgenParams.render.grid.active&&this.showOverlayName();break;case"NumpadDivide":t.preventDefault(),console.log("Exporting world data..."),this.world.exportWorldData()}}this.world.worldConfig.worldgenParams.render.grid.active&&t.ctrlKey&&t.altKey&&("["!==t.key&&"BracketLeft"!==t.code||(t.preventDefault(),this.overlayMode=(this.overlayMode-1+this.overlayNames.length)%this.overlayNames.length,console.log("Overlay mode: "+this.overlayNames[this.overlayMode]),this.showOverlayName()),"]"!==t.key&&"BracketRight"!==t.code||(t.preventDefault(),this.overlayMode=(this.overlayMode+1)%this.overlayNames.length,console.log("Overlay mode: "+this.overlayNames[this.overlayMode]),this.showOverlayName()))})}drawDebug(){if(this.ui.ctx&&this.world.isGenerated&&this.world.worldConfig.worldgenParams.render.grid.active){switch(this.overlayMode){case 0:this.drawChunks();break;case 1:this.drawHeightmap();break;case 2:this.drawContours();break;case 3:this.drawRegions();break;case 4:this.drawAudioZones()}this.drawInfoPanels()}}drawInfoPanels(){const t=this.world.updateHoveredChunk();if(!t||!this.hoveredChunk)return;const e=this.world.worldConfig.worldgenParams.general.chunk.size,a=this.hoveredChunk.cx,s=this.hoveredChunk.cy,i=Math.floor(t.worldX),o=Math.floor(t.worldY),r={x:i,y:o},n=this.world.chunks[a]?.[s],l=this.world.chunkLayers[a]?.[s];if(!n)return;const h=i-a*e,d=o-s*e,c=d*e+h,m=n.pixelData[c],u=m>>2,g=3&m,p=n.getHeightAt(h,d,e),y=this.world.worldConfig.materialsList[u],f=this.world.getWaterData(r);let w=10,x="N/A";if(this.world.regions)for(const t of this.world.regions)if(t.chunkCoords.some(t=>t.cx===a&&t.cy===s)){x=t.name;break}const b=[`Region: ${x}`,`Layer: ${l?l.name:"N/A"}`,`Chunk: ${a},${s})`,`Pixel: ${i},${o}`,`Height: ${p.toFixed(3)}`];if(w+=this.drawPanel("Main",b,w,10,"#888888",null)+10,y&&y.physics.type===T.wr.Solid){const t=this.utility.getLightestColor(y.colors),e=[`Material: ${y.name} [${u}]`,`Type: ${y.type}`,`Color Var: ${g}`,`Simulate: ${y.physics.simulate}`,`Durability: ${y.physics.durability.toFixed(2)}`,`Friction: ${y.physics.friction.toFixed(2)}`,`Density: ${y.physics.density.toFixed(2)}`];w+=this.drawPanel("Solid",e,w,10,t,t)+10}if(f&&f.hasWater){const t=f.material.physics,e=this.utility.getLightestColor(f.material.colors);if(t.type===T.wr.Liquid){const a=[`Material: ${f.material.name}`,`Depth: ${f.depth.toFixed(3)}`,`Simulate: ${t.simulate}`,`Viscosity: ${t.viscosity.toFixed(2)}`];w+=this.drawPanel("Liquid",a,w,10,e,e)+10}}}drawPanel(t,e,a,s,i,o){const r=this.ui.ctx;if(!r)return 0;r.font="11px monospace",r.textAlign="left";let n=r.measureText(t).width;e.forEach(t=>{n=Math.max(n,r.measureText(t).width)});const l=n+16,h=24+14*e.length+8;return r.fillStyle="rgba(0, 0, 0, 0.85)",r.fillRect(a,s,l,h),r.strokeStyle=i,r.lineWidth=2,r.strokeRect(a,s,l,h),o&&(r.fillStyle=o,r.fillRect(a,s,l,20)),r.font="bold 12px monospace",r.fillStyle=o?"#000000":i,r.fillText(t,a+8,s+8+10),r.fillStyle=o?i:"#ffffff",r.font="11px monospace",e.forEach((t,e)=>{r.fillText(t,a+8,s+20+4+8+14*e)}),l}drawChunks(){if(!this.ui.ctx||!this.world.isGenerated)return;const t=this.ui.ctx,e=this.world.worldConfig.worldgenParams.general.chunk.size,a=this.camera.pos.x,o=this.camera.pos.y,l=Math.floor(a/e),h=Math.ceil((a+r)/e),d=Math.floor(o/e),c=Math.ceil((o+n)/e);if(t.save(),this.hoveredChunk){const s=this.hoveredChunk.cx*e-a,i=this.hoveredChunk.cy*e-o,r=this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor.slice(1),n=parseInt(r.slice(0,2),16),l=parseInt(r.slice(2,4),16),h=parseInt(r.slice(4,6),16);t.fillStyle=`rgba(${n}, ${l}, ${h}, 0.2)`,t.fillRect(s,i,e,e)}for(let s=l;s<h;s++)for(let i=d;i<c;i++){const r=s*e-a,n=i*e-o,l=this.world.getChunkLayer(s,i),h=this.world.getChunkLayer(s+1,i)||l,d=this.world.getChunkLayer(s,i+1)||l,c=!(!l||!h||l.name===h.name),m=!(!l||!d||l.name===d.name);t.beginPath(),t.moveTo(r+e,n),t.lineTo(r+e,n+e),t.lineWidth=c?this.world.worldConfig.worldgenParams.render.grid.borderWidth:this.world.worldConfig.worldgenParams.render.grid.lineWidth,t.strokeStyle=c?this.world.worldConfig.worldgenParams.render.grid.layerBorderColor:this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor,t.stroke(),t.beginPath(),t.moveTo(r,n+e),t.lineTo(r+e,n+e),t.lineWidth=m?this.world.worldConfig.worldgenParams.render.grid.borderWidth:this.world.worldConfig.worldgenParams.render.grid.lineWidth,t.strokeStyle=m?this.world.worldConfig.worldgenParams.render.grid.layerBorderColor:this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor,t.stroke()}t.strokeStyle=this.world.worldConfig.worldgenParams.render.grid.worldBorderColor,t.lineWidth=this.world.worldConfig.worldgenParams.render.grid.borderWidth,t.strokeRect(0-a,0-o,s,i),t.restore()}drawHeightmap(){const t=this.ui.ctx;if(!t||!this.world.isGenerated)return;const e=this.camera.pos.x,a=this.camera.pos.y,s=this.world.worldConfig.worldgenParams.general.chunk.size,{seaLevel:i,lowestDepth:o}=this.world.worldConfig.worldgenParams.terrain,l=this.world.worldConfig.worldLayerList;t.save(),t.globalAlpha=.6;const h=Math.floor(e/s),d=Math.ceil((e+r)/s),c=Math.floor(a/s),m=Math.ceil((a+n)/s),u=(t,e,a)=>[Math.floor(this.utility.lerp(t[0],e[0],a)),Math.floor(this.utility.lerp(t[1],e[1],a)),Math.floor(this.utility.lerp(t[2],e[2],a))],g=[];g.push([o,[0,0,90]]),g.push([.5*i,[0,60,170]]),g.push([i-.05,[0,120,220]]),g.push([i+.05,[0,200,140]]);for(const t of Object.values(l)){const e=t.height;if(e<=i)continue;const a=this.world.worldConfig.worldLayerIndex[t.name]/(this.world.worldConfig.worldLayerList.length-1);let s;s=a<.25?[60,220,80]:a<.5?[230,230,60]:a<.75?[240,140,50]:a<.95?[255,70,40]:[255,255,255],g.push([e,s])}g.sort((t,e)=>t[0]-e[0]);for(let i=h;i<d;i++)for(let o=c;o<m;o++){const r=this.world.chunks[i]?.[o];if(!r)continue;const n=i*s-e,l=o*s-a;for(let e=0;e<s;e+=4)for(let a=0;a<s;a+=4){const i=r.getHeightAt(a,e,s);let o=g[0],h=g[g.length-1];for(let t=0;t<g.length-1;t++)if(i>=g[t][0]&&i<=g[t+1][0]){o=g[t],h=g[t+1];break}const d=h[0]-o[0];let c=d>0?(i-o[0])/d:0;c=this.utility.smoothstep(c);const[m,p,y]=u(o[1],h[1],c);t.fillStyle=`rgb(${m},${p},${y})`,t.fillRect(n+a,l+e,4,4)}}t.restore()}drawContours(){const t=this.ui.ctx;if(!t||!this.world.isGenerated)return;const e=this.camera.pos.x,a=this.camera.pos.y,s=this.world.worldConfig.worldgenParams.general.chunk.size,i=.02;t.save(),t.lineWidth=1,t.strokeStyle="rgba(0,0,0,0.35)";const o=Math.floor(e/s),l=Math.ceil((e+r)/s),h=Math.floor(a/s),d=Math.ceil((a+n)/s),c=(t,e,a)=>t.getHeightAt(e,a,s);for(let r=o;r<l;r++)for(let o=h;o<d;o++){const n=this.world.chunks[r]?.[o];if(!n)continue;const l=r*s-e,h=o*s-a;for(let e=0;e<s-2;e+=2)for(let a=0;a<s-2;a+=2){const s=c(n,a,e),o=c(n,a+2,e),r=c(n,a,e+2),d=c(n,a+2,e+2),m=Math.min(s,o,r,d),u=Math.max(s,o,r,d);for(let n=Math.floor(m/i)*i;n<=u;n+=i)if(n>=m&&n<=u){t.beginPath();const i=(t,e,a)=>{const s=(a-t)/(e-t);return Math.max(0,Math.min(1,s))},c=[];if((n-s)*(n-o)<0&&c.push({x:l+a+2*i(s,o,n),y:h+e}),(n-o)*(n-d)<0&&c.push({x:l+a+2,y:h+e+2*i(o,d,n)}),(n-d)*(n-r)<0&&c.push({x:l+a+2*(1-i(d,r,n)),y:h+e+2}),(n-r)*(n-s)<0&&c.push({x:l+a,y:h+e+2*(1-i(r,s,n))}),c.length>=2){t.moveTo(c[0].x,c[0].y);for(let e=1;e<c.length;e++)t.lineTo(c[e].x,c[e].y);t.stroke()}}}}t.restore()}drawRegions(){if(!this.ui.ctx||!this.world.isGenerated||!this.world.regions)return;const t=this.ui.ctx,e=this.camera.pos.x,a=this.camera.pos.y,s=this.world.worldConfig.worldgenParams.general.chunk.size,i={shore:"rgba(30, 150, 200, 0.25)",cliffs:"rgba(180, 80, 60, 0.25)",mountains:"rgba(120, 120, 140, 0.25)",ocean:"rgba(40, 80, 180, 0.3)",plains:"rgba(160, 200, 100, 0.25)"},o={shore:"#1e96c8",cliffs:"#b4503c",mountains:"#78788c",ocean:"#2850b4",plains:"#afc543ff"};t.save();for(const o of this.world.regions){const r=i[o.name];t.fillStyle=r;for(const{cx:i,cy:r}of o.chunkCoords){const o=i*s-e,n=r*s-a;t.fillRect(o,n,s,s)}}t.lineWidth=2;for(const i of this.world.regions){const r=o[i.name];t.strokeStyle=r;for(const{cx:o,cy:r}of i.chunkCoords){const i=o*s-e,n=r*s-a;t.strokeRect(i,n,s,s)}}t.restore()}drawAudioZones(){const t=this.ui.ctx;t&&(t.save(),this.world.audioZones.forEach(e=>{const a=e.center.x-this.camera.pos.x,s=e.center.y-this.camera.pos.y,i=e.audioParams.spatial?.rolloff?.distance||500;t.strokeStyle=e.isActive?"#00ff0055":"#ffffff22",t.lineWidth=2,t.beginPath(),t.arc(a,s,i,0,2*Math.PI),t.stroke(),t.fillStyle=e.isActive?"#00ff00":"#ffffff",t.fillRect(a-3,s-3,6,6)}),t.restore())}showOverlayName(){const t=document.getElementById("debugOverlayName");t&&t.remove();const e=document.createElement("div");e.id="debugOverlayName",e.textContent=this.overlayNames[this.overlayMode],e.style.cssText="\n            position: fixed;\n            top: 60%;\n            left: 50%;\n            transform: translate(-50%, -50%);\n            background: rgba(0, 0, 0, 0.85);\n            color: #ffffff;\n            padding: 12px 24px;\n            border: 2px solid #888888;\n            border-radius: 4px;\n            z-index: 99999;\n            pointer-events: none;\n            opacity: 1;\n            transition: opacity 0.3s ease-out;\n        ",document.body.appendChild(e),setTimeout(()=>{e.style.opacity="0",setTimeout(()=>{e.parentElement&&e.remove()},300)},800)}}class Q{constructor(t,e,a,s){this.world=t,this.roomManager=e,this.ui=a,this.utility=s}createChunkPatch(t){this.world.handleChunkUpdate(t),this.roomManager.sendMessage(JSON.stringify({type:"chunk-update",chunk:t}))}createChunkPatchNetwork(t){this.world.handleChunkUpdate(t)}requestCraterAt(t){const e=this.world.worldConfig.worldgenParams.general.chunk.size,a=Math.floor(t.x/e),s=Math.floor(t.y/e),i=this.world.chunks[a]?.[s];if(!i)return;const o=Math.floor(t.x)%e,r=Math.floor(t.y)%e,n=this.world.worldConfig.materialIndex.bedrock,l=this.world.worldConfig.materialsList[n],h=[];for(let t=-10;t<=10;t++)for(let a=-10;a<=10;a++){const s=o+a,d=r+t;if(s<0||s>=e||d<0||d>=e)continue;const c=d*e+s,m=n<<2|Math.floor(Math.random()*l.colors.length);i.pixelData[c]=m,i.heightData[c]=Math.max(0,i.heightData[c]-1),h.push({i:c,pixel:m,height:i.heightData[c]})}this.createChunkPatch({pos:{x:a,y:s},version:Date.now(),size:e,layer:this.world.chunkLayers[a]?.[s]?.name||"unknown",patches:h}),console.log(`Crater applied: ${t.x},${t.y}`)}applyFootstepAt(t,e,a){const s=this.world.worldConfig.worldgenParams.general.chunk.size,i=Math.floor(t.x/s),o=Math.floor(t.y/s),r=this.world.chunks[i]?.[o];if(!r)return;const n=Math.floor(t.x)%s,l=Math.floor(t.y)%s,h=this.world.worldConfig.materialsList,d=4+Math.floor(3*a),c=[];for(let t=-d;t<=d;t++)for(let e=-d;e<=d;e++){const i=n+e,o=l+t;if(i<0||i>=s||o<0||o>=s)continue;const m=Math.sqrt(e*e+1.2*t*(1.2*t));if(m>d)continue;const u=o*s+i;if(r.waterData[u]>0)continue;const g=r.pixelData[u],p=g>>2,y=3&g,f=h[p];if(!f)continue;if(!f.tags||!f.tags.includes("imprint_on_footstep"))continue;const w=Math.random()<.9?Math.max(0,y-1):y,x=.4*(1-m/d)*a,b=Math.max(0,r.heightData[u]-x),S=p<<2|w;r.pixelData[u]=S,r.heightData[u]=b,c.push({i:u,pixel:S,height:b})}this.createChunkPatch({pos:{x:i,y:o},version:Date.now(),size:s,layer:this.world.chunkLayers[i]?.[o]?.name||"unknown",patches:c}),console.log(`Footstep imprint applied: ${t.x}, ${t.y} [${e}]`)}}class tt{constructor(t,e,a,s,i,o,r,n){this.audioConfig=t,this.audioManager=e,this.camera=a,this.controlsManager=s,this.playerState=i,this.roomManager=o,this.ui=r,this.utility=n,this.chunks=[],this.chunkLayers=[],this.regions=[],this.audioZones=new Map,this.regionAudioSources=new Map,this.isGenerated=!1,this.currentSeed=0,this.erosionTemplate=null,this.chunkBuffer=[],this.worldBuffer=null,this.YIELD_RATE=10,this.WORLDGEN_PHASES=["cells","degen","hydration"],this.worldConfig=new J,this.worldDebug=new Z(this.camera,this.controlsManager,this.ui,this.utility,this),this.worldEdit=new Q(this,this.roomManager,this.ui,this.utility),this.initLoadingProgressEvents()}clear(){console.log("Clearing world data..."),this.chunks=[],this.chunkLayers=[],this.regions=[],this.cleanWorldAudio(),this.chunkBuffer=[],this.worldBuffer=null,this.erosionTemplate=null,this.isGenerated=!1,this.currentSeed=0,this.worldDebug.hoveredChunk=null,this.ui.worldCtx&&this.ui.worldCanvas&&this.ui.worldCtx.clearRect(0,0,s,i)}async showGenerationMenu(){const t=await this.worldgenMenu();if("load"===t.mode&&t.file)return await this.loadWorldFromFile(t.file),"load";const e=this.worldConfig.worldgenParams,a=e.general.seed||Date.now();return e.general.seed=a,this.currentSeed=a,{seed:a,params:e}}async generateWorld(t){this.showLoadingMenu(),this.clear(),this.worldConfig.worldgenParams=t.params,this.currentSeed=t.seed;const e=await this.generateCells(t.seed),a=await this.applyDegen(e,t.seed),s=await this.applyHydration(a,t.seed);await this.bakeChunksFromCells(s),this.isGenerated=!0,this.hideLoadingMenu(),console.log(`World generated: ${t.seed}`)}async generateCells(t){const e=this.worldConfig.worldgenParams,a=e.general.cell.size,o=e.terrain,r=o.lowestDepth,n=o.seaLevel,l=Math.ceil(s/a),h=Math.ceil(i/a),d=new Uint8Array(768e4),c=new Uint8Array(768e4),m=Array.from({length:h},()=>new Array(l).fill(0)),u=this.worldConfig.getWorldgenMessage("generation");await this.utility.yield(u);const g=l*h;let p=0;for(let u=0;u<h;u++)for(let h=0;h<l;h++){p++,p%Math.floor(g/this.YIELD_RATE)===0&&await this.utility.yield();let l=this.utility.getNoise(o.noiseType,(h+.5)*o.scale,(u+.5)*o.scale,t,{octaves:o.octaves,persistence:o.persistence});l<0?l=0:l>1&&(l=1);const y=.5;l=y+(l-y)*o.intensity,l<0?l=0:l>1&&(l=1),l=Math.pow(l,o.heightCurve),l<0?l=0:l>1&&(l=1);const f=e.general.options;if(f.island||f.valley){const e=Math.min(h*a,s-(h*a+a)),d=Math.min(u*a,i-(u*a+a)),c=Math.min(e,d),m=.5*Math.min(s,i);let g=Math.min(1,c/m);g=g*g*(3-2*g);const p=.1*this.utility.getNoise(o.noiseType,.002*h,.002*u,t+9100,{octaves:2,persistence:.5});if(f.island){const t=.5*n;l=this.utility.lerp(t,l,g+p),l<r?l=r:l>1&&(l=1)}else if(f.valley){const t=Math.pow(1-g,1.5*o.heightCurve),e=1;l=this.utility.lerp(l,e,t+p),l<r?l=r:l>1&&(l=1)}}l<r&&(l=r);const w=this.pickLayerForHeight(l),x=this.worldConfig.worldLayerIndex[w.name];m[u][h]=x;const b=h*a,S=u*a;for(let e=0;e<a;e++)for(let o=0;o<a;o++){const a={x:b+o,y:S+e};if(a.x>=s||a.y>=i)continue;const r=this.samplePixelData(a,t,w),n=this.worldConfig.materialIndex[r.material.name],h=(n>=0?n:0)<<2|r.materialColorIndex,m=a.y*s+a.x;d[m]=h,c[m]=Math.round(255*l)}}return{worldPixelData:d,worldHeightData:c,cellLayerGrid:m}}samplePixelData(t,e,a){const s=this.utility.getNoise(this.worldConfig.worldgenParams.material.noiseType,t.x*this.worldConfig.worldgenParams.material.scale,t.y*this.worldConfig.worldgenParams.material.scale,e+1e3,{octaves:this.worldConfig.worldgenParams.terrain.octaves,persistence:this.worldConfig.worldgenParams.terrain.persistence}),i=a.materials;let o=s*i.reduce((t,e)=>t+e.weight,0),r=this.worldConfig.materialsList[this.worldConfig.materialIndex.stone];for(const t of i)if(o-=t.weight,o<=0){const e=this.worldConfig.materialIndex[t.material];void 0!==e&&(r=this.worldConfig.materialsList[e]);break}const n=this.utility.getNoise(this.worldConfig.worldgenParams.material.detail.noiseType,t.x*this.worldConfig.worldgenParams.material.detail.scale,t.y*this.worldConfig.worldgenParams.material.detail.scale,e+3e3,{octaves:this.worldConfig.worldgenParams.terrain.octaves,persistence:this.worldConfig.worldgenParams.terrain.persistence});return{material:r,materialColorIndex:Math.floor(n*r.colors.length),layer:a}}pickLayerForHeight(t){const e=this.worldConfig.worldLayerList;let a=e[0],s=Math.abs(t-a.height);for(let i=1;i<e.length;i++){const o=Math.abs(t-e[i].height);o<s&&(a=e[i],s=o)}return a}async applyDegen(t,e){console.log("Applying degeneration pass...");const{worldPixelData:a,worldHeightData:o,cellLayerGrid:r}=t,n=new Uint8Array(a),l=new Uint8Array(o),h=this.worldConfig.worldgenParams.degen,d=this.worldConfig.materialsList,c=this.getErosionTemplate(),m=this.worldConfig.getWorldgenMessage("degeneration");await this.utility.yield(m);let u=0;for(let t=0;t<i;t++)for(let i=0;i<s;i++){const r=t*s+i;u++,u%Math.floor(768e4/this.YIELD_RATE)===0&&await this.utility.yield();const m=o[r]/255;if(m<h.minHeight){n[r]=a[r],l[r]=o[r];continue}const g=.7*this.utility.getNoise(h.noiseType,i*h.scale,t*h.scale,e+6e3,{octaves:this.worldConfig.worldgenParams.degen.scale,persistence:this.worldConfig.worldgenParams.degen.hardness})+.3*this.utility.getNoise(h.detail.noiseType,i*h.detail.scale,t*h.detail.scale,e+7e3,{octaves:this.worldConfig.worldgenParams.degen.detail.scale,persistence:this.worldConfig.worldgenParams.degen.hardness});if(g<h.threshold){n[r]=a[r],l[r]=o[r];continue}const p=(g-h.threshold)/(1-h.threshold)*h.intensity,y=a[r],f=y>>2,w=d[f];let x=.5;w.physics.type===T.wr.Solid&&(x=w.physics.durability);let b=m-p*(1-x)*h.hardness;b<0&&(b=0);const S=Math.round(255*b);l[r]=S;const v=(m-b)/Math.max(.01,m),C=w.physics.type===T.wr.Solid?w.physics.durability:.5,M=c.filter(t=>{const e=d[t.index];return!!e&&(e.physics.type===T.wr.Solid?e.physics.durability:.5)>=C});let I,P;if(0===M.length)I=f,P=3&y;else{const a=Math.min(1,v),s=Math.floor(a*(M.length-1));I=M[Math.min(s,M.length-1)].index;const o=this.utility.getNoise(this.worldConfig.worldgenParams.material.detail.noiseType,i*this.worldConfig.worldgenParams.material.detail.scale,t*this.worldConfig.worldgenParams.material.detail.scale,e+8e3,{octaves:this.worldConfig.worldgenParams.degen.detail.scale,persistence:this.worldConfig.worldgenParams.degen.hardness}),r=d[I].colors.length;P=Math.floor(o*r)%r}const _=I<<2|3&P;n[r]=_}return console.log("Degeneration pass complete."),{worldPixelData:n,worldHeightData:l,cellLayerGrid:r}}getErosionTemplate(){if(this.erosionTemplate)return this.erosionTemplate;const t=this.worldConfig.materialIndex,e=["silt","sand","gravel","dirt","clay","shale","limestone","stone","slate","basalt","granite","bedrock"].map(e=>({name:e,index:t[e]})).filter(t=>void 0!==t.index);return this.erosionTemplate=e,console.log("Cached erosion materials..."),e}async applyHydration(t,e){console.log("Applying hydration pass...");const{worldPixelData:a,worldHeightData:o,cellLayerGrid:r}=t,n=new Uint8Array(a.length),l=new Uint8Array(a),h=this.worldConfig.materialsList,d=this.worldConfig.materialIndex,c=this.worldConfig.worldgenParams.terrain.seaLevel,m=c-this.worldConfig.worldgenParams.terrain.lowestDepth,u=s,g=i,p=768e4,y={clay:"clay_wet",dirt:"mud",sand:"sand_wet",silt:"silt_wet"},f=this.worldConfig.getWorldgenMessage("hydration");await this.utility.yield(f);const w=new Float32Array(p),x=new Uint8Array(p);for(let t=0;t<p;t++){const e=o[t]/255;let a=0;e<c?(a=(c-e)/m,a=Math.max(0,Math.min(1,a)),n[t]=Math.round(255*a),w[t]=1,x[t]=1):(n[t]=0,w[t]=0)}const b=new Float32Array(p);for(let t=0;t<4;t++){for(let t=0;t<g;t++)for(let e=0;e<u;e++){const a=t*u+e;if(x[a]){b[a]=1;continue}let s=w[a],i=1;for(let a=-5;a<=5;a++)for(let o=-5;o<=5;o++){if(0===o&&0===a)continue;const r=e+o,n=t+a;r<0||n<0||r>=u||n>=g||(s+=w[n*u+r],i++)}b[a]=s/i}w.set(b)}const S=.0025;for(let t=0;t<g;t++)for(let a=0;a<u;a++){const s=t*u+a,i=this.utility.getNoise(this.worldConfig.worldgenParams.material.noiseType,a*S,t*S,e+9999);w[s]=Math.min(1,Math.max(0,w[s]*(.9+.3*i)))}for(let t=0;t<p;t++){const e=w[t];if(e<=.05)continue;const s=a[t],i=3&s,o=h[s>>2];if(!o.tags||!o.tags.includes("absorbent"))continue;const r=(e-.05)/.95;if(Math.random()<r){const e=y[o.name];if(e){const a=d[e];a>=0&&(l[t]=a<<2|i)}}}return console.log("Hydration pass complete (noise diffusion)."),{worldPixelData:l,worldHeightData:o,worldWaterData:n,cellLayerGrid:r}}getWaterData(t){const e=this.worldConfig.worldgenParams.general.chunk.size,a=Math.floor(t.x/e),s=Math.floor(t.y/e),i=this.chunks[a]?.[s];if(!i)return null;const o=t.x-a*e,r=t.y-s*e,n=i.getWaterAt(o,r,e);if(n<=0)return null;const l=i.getHeightAt(o,r,e);return{hasWater:!0,waterLevel:n,depth:this.worldConfig.worldgenParams.terrain.seaLevel-l,material:this.worldConfig.materialsList[this.worldConfig.materialIndex.water]}}async bakeChunksFromCells(t){const e=this.worldConfig.worldgenParams.general.chunk.size,a=this.worldConfig.worldLayerList;if(this.worldBuffer=t,!t.worldHeightData||!t.worldPixelData||!t.worldWaterData)return;const o=Math.ceil(s/e),r=Math.ceil(i/e),n=o*r,l=this.worldConfig.worldgenParams.general.cell.size,h=Math.ceil(s/l),d=Math.ceil(i/l),c=this.worldConfig.getWorldgenMessage("bakeStart"),m=this.worldConfig.getWorldgenMessage("bakeHalf");await this.utility.yield(c);const u=this.playerState.myPlayer.transform.pos.x,g=this.playerState.myPlayer.transform.pos.y,p=[];for(let t=0;t<o;t++)for(let a=0;a<r;a++){const s=(t+.5)*e-u,i=(a+.5)*e-g;p.push({cx:t,cy:a,dist:Math.sqrt(s*s+i*i)})}p.sort((t,e)=>t.dist-e.dist);const y=Math.floor(.25*n),f=Math.floor(.5*n);for(let o=0;o<p.length;o++){const{cx:r,cy:c}=p[o];if(o===y&&await this.utility.yield(m),o===f)return this.chunkBuffer=p.slice(o).map(t=>({cx:t.cx,cy:t.cy,loaded:!1})),this.isGenerated=!0,this.hideLoadingMenu(),console.log(`Returned early after ${o}/${n} chunks baked. Buffered ${this.chunkBuffer.length} chunks for streaming.`),void this.dumpChunkBuffer();await this.utility.yield();const u=new Uint8Array(e*e),g=new Uint8Array(e*e),w=new Uint8Array(e*e);for(let a=0;a<e;a++)for(let o=0;o<e;o++){const n=r*e+o,l=c*e+a;if(n>=s||l>=i)continue;const h=l*s+n,d=a*e+o;u[d]=t.worldPixelData[h],g[d]=t.worldHeightData[h],w[d]=t.worldWaterData[h]}const x={},b=Math.floor(r*e/l),S=Math.floor(((r+1)*e-1)/l),v=Math.floor(c*e/l),C=Math.floor(((c+1)*e-1)/l);for(let e=v;e<=C;e++)if(!(e<0||e>=d))for(let a=b;a<=S;a++){if(a<0||a>=h)continue;if(!t.cellLayerGrid)continue;const s=t.cellLayerGrid[e][a];x[s]=(x[s]||0)+1}let M=0,I=-1;for(const t in x){const e=x[t];e>I&&(I=e,M=parseInt(t,10))}const P=a[M]||a[0],_=new X(P.name,u,g,w,this.worldConfig);this.chunks[r]||(this.chunks[r]=[]),this.chunkLayers[r]||(this.chunkLayers[r]=[]),this.chunks[r][c]=_,this.chunkLayers[r][c]=P,this.renderChunk(r,c,_)}}bakeRegionsFromChunks(){const t=this.worldConfig.worldgenParams.general.chunk.size,e=Math.ceil(s/t),a=Math.ceil(i/t),o=new Set;let r=0;this.regions=[];const n=(t,e)=>e>=.9?"ocean":e>0&&e<.9&&["alluvium","sediment"].includes(t)?"shore":"colluvium"===t?"cliffs":["summit"].includes(t)?"mountains":["soil","topsoil","substrate","foundation"].includes(t)?"plains":null,l=Array.from({length:a},()=>Array.from({length:e},()=>null));for(let s=0;s<a;s++)for(let i=0;i<e;i++){const h=`${i},${s}`;if(o.has(h))continue;const d=this.getChunkLayer(i,s);if(!d)continue;const c=[],m=[{cx:i,cy:s}];for(;m.length>0;){const{cx:t,cy:s}=m.shift(),i=`${t},${s}`;if(o.has(i))continue;o.add(i);const r=this.getChunkLayer(t,s);if(!r||r.name!==d.name)continue;c.push({cx:t,cy:s});const n=[{cx:t-1,cy:s},{cx:t+1,cy:s},{cx:t,cy:s-1},{cx:t,cy:s+1}];for(const t of n)t.cx>=0&&t.cx<e&&t.cy>=0&&t.cy<a&&!o.has(`${t.cx},${t.cy}`)&&m.push(t)}if(c.length<=5)continue;let u=0,g=0;for(const{cx:e,cy:a}of c){const s=this.chunks[e]?.[a];if(s)for(let e=0;e<t;e++)for(let a=0;a<t;a++)u+=s.getWaterAt(a,e,t)>0?1:0,g++}const p=g>0?u/g:0,y=n(d.name,p);if(!y)continue;const f=Math.min(...c.map(t=>t.cx)),w=Math.max(...c.map(t=>t.cx)),x=Math.min(...c.map(t=>t.cy)),b=Math.max(...c.map(t=>t.cy));this.regions.push({id:r++,name:y,layerName:d.name,bounds:{minX:f,minY:x,maxX:w,maxY:b},chunkCoords:c,area:c.length});for(const t of c)l[t.cy][t.cx]=y}for(let t=0;t<a;t++)for(let s=0;s<e;s++){if(null!==l[t][s])continue;let i=null,o=1;for(;!i&&o<Math.max(e,a);){for(let r=-o;r<=o;r++){for(let n=-o;n<=o;n++){const o=s+n,h=t+r;if(o<0||h<0||o>=e||h>=a)continue;const d=l[h][o];if(d){i=d;break}}if(i)break}o++}l[t][s]=i||"plains"}this.regions=[],o.clear(),r=0;for(let t=0;t<a;t++)for(let s=0;s<e;s++){const i=l[t][s];if(!i||o.has(`${s},${t}`))continue;const n=[],h=[{cx:s,cy:t}];for(;h.length>0;){const{cx:t,cy:s}=h.shift(),r=`${t},${s}`;if(o.has(r))continue;if(l[s][t]!==i)continue;o.add(r),n.push({cx:t,cy:s});const d=[{cx:t-1,cy:s},{cx:t+1,cy:s},{cx:t,cy:s-1},{cx:t,cy:s+1}];for(const t of d)t.cx>=0&&t.cx<e&&t.cy>=0&&t.cy<a&&!o.has(`${t.cx},${t.cy}`)&&h.push(t)}const d=Math.min(...n.map(t=>t.cx)),c=Math.max(...n.map(t=>t.cx)),m=Math.min(...n.map(t=>t.cy)),u=Math.max(...n.map(t=>t.cy));this.regions.push({id:r++,name:i,layerName:i,bounds:{minX:d,minY:m,maxX:c,maxY:u},chunkCoords:n,area:n.length})}console.log(` Regions baked + filled: ${this.regions.length}`),this.regions.forEach(e=>{const a=(e.bounds.maxX-e.bounds.minX+1)*t,s=(e.bounds.maxY-e.bounds.minY+1)*t;console.log(`   ${e.name.padEnd(10)} | ${String(e.area).padStart(3)} chunks | ${a}${s}px`)}),this.generateAudioZones()}drawWorld(){if(!(this.ui.ctx&&this.ui.worldCanvas&&this.ui.liquidCanvas&&this.isGenerated))return;const t=this.camera.pos;this.ui.ctx.drawImage(this.ui.worldCanvas,t.x,t.y,r,n,0,0,r,n),this.ui.ctx.drawImage(this.ui.liquidCanvas,t.x,t.y,r,n,0,0,r,n)}renderChunk(t,e,a){if(!this.ui.worldCtx)return;const o=this.worldConfig.worldgenParams.general.chunk.size,r=t*o,n=e*o;for(let t=0;t<o;t++)for(let e=0;e<o;e++){const l=r+e,h=n+t;if(l>=s||h>=i)continue;const d=a.getColorAt(e,t,o),c=this.utility.getNoise(this.worldConfig.worldgenParams.material.detail.noiseType,l*this.worldConfig.worldgenParams.material.detail.scale,h*this.worldConfig.worldgenParams.material.detail.scale,this.currentSeed+3e3,{octaves:this.worldConfig.worldgenParams.terrain.octaves,persistence:this.worldConfig.worldgenParams.terrain.persistence}),m=this.adjustPixelColor(d,c);this.ui.worldCtx.fillStyle=m,this.ui.worldCtx.fillRect(l,h,1,1)}this.renderWater(t,e,a)}renderWater(t,e,a){if(!this.ui.liquidCtx)return;const o=this.ui.liquidCtx,r=this.worldConfig.worldgenParams.general.chunk.size,n=t*r,l=e*r,h=this.worldConfig.worldgenParams.terrain.seaLevel,d=this.worldConfig.worldgenParams.render.water,c=this.worldConfig.materialsList[this.worldConfig.materialIndex.water].colors,m=this.currentSeed+9100,u=d.noiseScale,g=d.foamScale,p=d.shoreBlend;for(let t=0;t<r;t++)for(let e=0;e<r;e++){const y=n+e,f=l+t;if(y>=s||f>=i)continue;const w=a.getHeightAt(e,t,r);if(a.getWaterAt(e,t,r)<=0)continue;const x=h-w,b=Math.max(0,Math.min(1,x/h)),S=c[Math.floor((1-b)*(c.length-1))],v=parseInt(S.slice(1,3),16),C=parseInt(S.slice(3,5),16),M=parseInt(S.slice(5,7),16),I=this.utility.getNoise(T.VA.Perlin,y*u,f*u,m,{octaves:4,persistence:.55}),P=this.utility.getNoise(T.VA.Ridged,y*g,f*g,m+3e3,{octaves:2,persistence:.5});let _=0;if(w>h-p){const t=(h-w)/p;_=this.utility.smoothstep(1-Math.max(0,Math.min(1,t)))*P*d.foamIntensity}const E=1-b*d.depthDarkness,k=(.5+.5*(1-b)+I*d.shimmerStrength)*E,R=.25+.25*I,L=Math.max(0,Math.min(255,v*k+200*_+30*R)),A=Math.max(0,Math.min(255,C*k+220*_+50*R)),D=Math.max(0,Math.min(255,M*k+255*_+60*R)),B=Math.min(1,d.opacityBase+b*d.opacityMultiplier);o.fillStyle=`rgba(${L},${A},${D},${B})`,o.fillRect(y,f,1,1)}}adjustPixelColor(t,e){const a=1+(e-.5)*this.worldConfig.worldgenParams.material.colorVariation,s=parseInt(t.slice(1,3),16),i=parseInt(t.slice(3,5),16),o=parseInt(t.slice(5,7),16),r=Math.max(0,Math.min(255,Math.floor(s*a))),n=Math.max(0,Math.min(255,Math.floor(i*a))),l=Math.max(0,Math.min(255,Math.floor(o*a)));return`#${r.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`}getMaterialAt(t,e){const a=this.worldConfig.worldgenParams.general.chunk.size,s=Math.floor(t/a),i=Math.floor(e/a),o=this.chunks[s]?.[i];if(!o)return null;const r=(e-i*a)*a+(t-s*a),n=o.pixelData[r]>>2;return this.worldConfig.materialsList[n]||null}getHeightAt(t,e){const a=this.worldConfig.worldgenParams.general.chunk.size,s=Math.floor(t/a),i=Math.floor(e/a),o=this.chunks[s]?.[i];if(!o)return null;if(!o)return null;const r=t-s*a,n=e-i*a;return o.getHeightAt(r,n,a)}getPhysicsAt(t,e){const a=this.getMaterialAt(t,e);return a?a.physics:null}getChunkLayer(t,e){return this.chunkLayers[t]?.[e]||null}updateHoveredChunk(){const t=this.controlsManager.getMousePos(),e=t.x+this.camera.pos.x,a=t.y+this.camera.pos.y;if(e<0||e>=s||a<0||a>=i)return this.worldDebug.hoveredChunk=null,null;const o=this.worldConfig.worldgenParams.general.chunk.size,r=Math.floor(e/o),n=Math.floor(a/o);return this.worldDebug.hoveredChunk={cx:r,cy:n},{worldX:e,worldY:a}}totalYieldSteps(){const t=this.worldConfig.worldgenParams.general.chunk.size,e=Math.ceil(s/t)*Math.ceil(i/t),a=Math.floor(.5*e);return this.YIELD_RATE*this.WORLDGEN_PHASES.length+a}async worldgenMenu(){return new Promise(t=>{const e=document.createElement("div");e.className="config_popup_container";const a=document.createElement("h3");a.textContent="World Generation Config";const s=document.createElement("div");s.className="config_popup";const i=document.createElement("form"),o=Object.values(T.VA).map(t=>`<option value="${t}" ${this.worldConfig.worldgenParams.terrain.noiseType===t?"selected":""}>${t.charAt(0).toUpperCase()+t.slice(1)}</option>`).join("");i.innerHTML=`\n            \x3c!-- GENERAL --\x3e\n            <fieldset id="generalFieldset">\n                <legend>General</legend>\n                <div class="form_grid">\n                    <label id="seedLabel">\n                        <span>Seed:</span>\n                        <input type="text" name="general.seed" placeholder="enter seed or leave blank...">\n                    </label>\n                    <div id="generalFormDiv">\n                        <label>\n                            <span>Chunk Size (px):</span>\n                            <input type="number" name="general.chunk.size" value="${this.worldConfig.worldgenParams.general.chunk.size}" min="1" step="1">\n                        </label>\n                        <label>\n                            <span>Cell Size (px):</span>\n                            <input type="number" name="general.cell.size" value="${this.worldConfig.worldgenParams.general.cell.size}" min="1" step="1">\n                        </label>\n                    </div>\n                </div>\n            </fieldset>\n\n            \x3c!-- TERRAIN --\x3e\n            <fieldset id="terrainFieldset">\n                <legend>Terrain</legend>\n                <div class="form_grid">\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="terrain.noiseType">${o}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="terrain.scale" value="${this.worldConfig.worldgenParams.terrain.scale}" step="any">\n                    </label>\n                    <label>\n                        <span>Intensity:</span>\n                        <input type="number" name="terrain.intensity" value="${this.worldConfig.worldgenParams.terrain.intensity}" step="any" min="0">\n                    </label>\n                    <label>\n                        <span>Octaves:</span>\n                        <input type="number" name="terrain.octaves" value="${this.worldConfig.worldgenParams.terrain.octaves}" min="1" max="12" step="1">\n                    </label>\n                    <label>\n                        <span>Persistence:</span>\n                        <input type="number" name="terrain.persistence" value="${this.worldConfig.worldgenParams.terrain.persistence}" step="any" min="0" max="1">\n                    </label>\n                    <label>\n                        <span>Height Curve:</span>\n                        <input type="number" name="terrain.heightCurve" value="${this.worldConfig.worldgenParams.terrain.heightCurve}" step="any" min="0.1">\n                    </label>\n                    <label>\n                        <span>Sea Level:</span>\n                        <input type="number" name="terrain.seaLevel" value="${this.worldConfig.worldgenParams.terrain.seaLevel}" step="any" min="0" max="1">\n                    </label>\n                    <label>\n                        <span>Lowest Depth:</span>\n                        <input type="number" name="terrain.lowestDepth" value="${this.worldConfig.worldgenParams.terrain.lowestDepth}" step="any" min="0" max="1">\n                    </label>\n                </div>\n            </fieldset>\n\n            \x3c!-- MATERIALS --\x3e\n            <fieldset id="materialsFieldset">\n                <legend>Materials</legend>\n                <div class="form_grid">\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="material.noiseType">${o}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="material.scale" value="${this.worldConfig.worldgenParams.material.scale}" step="any">\n                    </label>\n                    <label>\n                        <span>Color Variation:</span>\n                        <input type="number" name="material.colorVariation" value="${this.worldConfig.worldgenParams.material.colorVariation}" step="any" min="0" max="1">\n                    </label>\n                </div>\n                <div class="form_grid form_grid_detail">\n                <h4>Detail</h4>\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="material.detail.noiseType">${o}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="material.detail.scale" value="${this.worldConfig.worldgenParams.material.detail.scale}" step="any">\n                    </label>\n                </div>\n            </fieldset>\n\n            \x3c!-- DEGENERATION --\x3e\n            <fieldset id="degenerationFieldset">\n                <legend>Degeneration</legend>\n                <div class="form_grid">\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="degen.noiseType">${o}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="degen.scale" value="${this.worldConfig.worldgenParams.degen.scale}" step="any" min="0">\n                    </label>\n                    <label>\n                        <span>Intensity:</span>\n                        <input type="number" name="degen.intensity" value="${this.worldConfig.worldgenParams.degen.intensity}" step="any" min="0" max="2">\n                    </label>\n                    <label>\n                        <span>Min Height:</span>\n                        <input type="number" name="degen.minHeight" value="${this.worldConfig.worldgenParams.degen.minHeight}" step="any" min="0" max="1">\n                    </label>\n                    <label>\n                        <span>Threshold:</span>\n                        <input type="number" name="degen.threshold" value="${this.worldConfig.worldgenParams.degen.threshold}" step="any" min="0" max="1">\n                    </label>\n                    <label>\n                        <span>Hardness:</span>\n                        <input type="number" name="degen.hardness" value="${this.worldConfig.worldgenParams.degen.hardness}" step="any" min="0" max="1">\n                    </label>\n                </div>\n                <div class="form_grid form_grid_detail">\n                <h4>Detail</h4>\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="degen.detail.noiseType">${o}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="degen.detail.scale" value="${this.worldConfig.worldgenParams.degen.detail.scale}" step="any" min="0">\n                    </label>\n                </div>\n            </fieldset>\n\n            \x3c!-- HYDRATION\n            <fieldset id="hydrationFieldset">\n                <legend>Hydration</legend>\n                <div class="form_grid">\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="hydration.noiseType">${o}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="hydration.scale" value="${this.worldConfig.worldgenParams.hydration.scale}" step="any" min="0">\n                    </label>\n                    <label>\n                        <span>Intensity:</span>\n                        <input type="number" name="hydration.intensity" value="${this.worldConfig.worldgenParams.hydration.intensity}" step="any" min="0" max="5">\n                    </label>\n                    <label>\n                        <span>Multiplier:</span>\n                        <input type="number" name="hydration.multiplier" value="${this.worldConfig.worldgenParams.hydration.multiplier}" step="any" min="0" max="10">\n                    </label>\n                </div>\n            </fieldset> --\x3e\n\n            <div class="form_submit">\n                <button type="submit">Generate (Enter)</button>\n                <input id="loadWorldInput" type="file" accept=".json" style="display:none">\n                <button type="button" id="loadWorldButton">Load Saved World</button>\n            </div>\n            `;const r=i.querySelector("#loadWorldButton"),n=i.querySelector("#loadWorldInput");r.onclick=()=>n.click(),n.onchange=async a=>{const s=a.target.files?.[0];s&&(document.body.removeChild(e),t({mode:"load",file:s}))},i.onsubmit=a=>{a.preventDefault();const s=new FormData(i),o=t=>parseFloat(s.get(t)),r=t=>parseInt(s.get(t));this.worldConfig.worldgenParams.general.chunk.size=r("general.chunk.size"),this.worldConfig.worldgenParams.general.cell.size=r("general.cell.size"),this.worldConfig.worldgenParams.general.seed=r("general.seed"),this.worldConfig.worldgenParams.terrain.noiseType=s.get("terrain.noiseType"),this.worldConfig.worldgenParams.terrain.scale=o("terrain.scale"),this.worldConfig.worldgenParams.terrain.intensity=o("terrain.intensity"),this.worldConfig.worldgenParams.terrain.octaves=r("terrain.octaves"),this.worldConfig.worldgenParams.terrain.persistence=o("terrain.persistence"),this.worldConfig.worldgenParams.terrain.heightCurve=o("terrain.heightCurve"),this.worldConfig.worldgenParams.terrain.seaLevel=o("terrain.seaLevel"),this.worldConfig.worldgenParams.terrain.lowestDepth=o("terrain.lowestDepth"),this.worldConfig.worldgenParams.material.noiseType=s.get("material.noiseType"),this.worldConfig.worldgenParams.material.scale=o("material.scale"),this.worldConfig.worldgenParams.material.colorVariation=o("material.colorVariation"),this.worldConfig.worldgenParams.material.detail.noiseType=s.get("material.detail.noiseType"),this.worldConfig.worldgenParams.material.detail.scale=o("material.detail.scale"),this.worldConfig.worldgenParams.degen.noiseType=s.get("degen.noiseType"),this.worldConfig.worldgenParams.degen.scale=o("degen.scale"),this.worldConfig.worldgenParams.degen.intensity=o("degen.intensity"),this.worldConfig.worldgenParams.degen.minHeight=o("degen.minHeight"),this.worldConfig.worldgenParams.degen.threshold=o("degen.threshold"),this.worldConfig.worldgenParams.degen.hardness=o("degen.hardness"),this.worldConfig.worldgenParams.degen.detail.noiseType=s.get("degen.detail.noiseType"),this.worldConfig.worldgenParams.degen.detail.scale=o("degen.detail.scale"),document.body.removeChild(e),t({mode:"generate"})},s.appendChild(i),e.appendChild(a),e.appendChild(s),document.body.appendChild(e),i.querySelector("input")?.focus()})}async renderMenu(){return new Promise(t=>{const e=document.createElement("div");e.className="config_popup";const a=document.createElement("form"),o=this.worldConfig.worldgenParams.render.water;a.innerHTML=`\n            <h3>Render Config</h3>\n\n            <fieldset>\n                <legend>Water Rendering</legend>\n                <div class="form_grid">\n                    <label><span>Base Opacity:</span>\n                        <input type="number" name="opacityBase" value="${o.opacityBase}" step="any" min="0" max="1">\n                    </label>\n                    <label><span>Opacity Multiplier:</span>\n                        <input type="number" name="opacityMultiplier" value="${o.opacityMultiplier}" step="any" min="0" max="2">\n                    </label>\n                    <label><span>Foam Intensity:</span>\n                        <input type="number" name="foamIntensity" value="${o.foamIntensity}" step="any" min="0" max="2">\n                    </label>\n                    <label><span>Foam Scale:</span>\n                        <input type="number" name="foamScale" value="${o.foamScale}" step="any" min="0">\n                    </label>\n                    <label><span>Noise Scale:</span>\n                        <input type="number" name="noiseScale" value="${o.noiseScale}" step="any" min="0">\n                    </label>\n                    <label><span>Shore Blend:</span>\n                        <input type="number" name="shoreBlend" value="${o.shoreBlend}" step="any" min="0" max="1">\n                    </label>\n                    <label><span>Shimmer Strength:</span>\n                        <input type="number" name="shimmerStrength" value="${o.shimmerStrength}" step="any" min="0" max="1">\n                    </label>\n                    <label><span>Depth Darkness:</span>\n                        <input type="number" name="depthDarkness" value="${o.depthDarkness}" step="any" min="0" max="2">\n                    </label>\n                </div>\n            </fieldset>\n\n            <div class="form_submit">\n                <button type="submit">Apply (Enter)</button>\n            </div>\n            `,a.onsubmit=r=>{r.preventDefault();const n=new FormData(a),l=t=>parseFloat(n.get(t));o.opacityBase=l("opacityBase"),o.opacityMultiplier=l("opacityMultiplier"),o.foamIntensity=l("foamIntensity"),o.foamScale=l("foamScale"),o.noiseScale=l("noiseScale"),o.shoreBlend=l("shoreBlend"),o.shimmerStrength=l("shimmerStrength"),o.depthDarkness=l("depthDarkness"),console.log(" Re-rendering world (no regeneration)..."),this.ui.worldCtx&&this.ui.worldCtx.clearRect(0,0,s,i);for(let t=0;t<this.chunks.length;t++){const e=this.chunks[t];if(e)for(let a=0;a<e.length;a++){const s=e[a];s&&this.renderChunk(t,a,s)}}document.body.removeChild(e),t()},e.appendChild(a),document.body.appendChild(e),a.querySelector("input")?.focus()})}showLoadingMenu(){const t=document.getElementById("worldLoadingMenu");t&&t.remove();const e=document.createElement("div");e.id="worldLoadingMenu",e.innerHTML='\n        <div class="loading_wrapper">\n            <span id="loadingMessage">Initializing world...</span>\n            <div class="loading_bar">\n                <div id="loadingBarFill"></div>\n            </div>\n        </div>\n        ',document.body.appendChild(e)}hideLoadingMenu(){const t=document.getElementById("worldLoadingMenu");t&&(t.style.opacity="0",setTimeout(()=>t.remove(),300))}handleChunkUpdate(t){if(!t||!t.pos)return;if(t.patches)return void this.handleChunkPatch(t);const e=t.pos.x,a=t.pos.y,s=this.chunks[e]?.[a];if(s&&(t.version??0)<=s.version)return;const i=new X(t.layer,t.cellData.worldPixelData,t.cellData.worldHeightData,t.cellData.worldWaterData,this.worldConfig);i.version=t.version,i.pos=t.pos,i.size=t.size,this.chunks[e]||(this.chunks[e]=[]),this.chunks[e][a]=i,this.chunkLayers[e]||(this.chunkLayers[e]=[]);const o=this.worldConfig.worldLayerIndex[t.layer];this.chunkLayers[e][a]=void 0!==o?this.worldConfig.worldLayerList[o]:this.worldConfig.worldLayerList[0],this.renderChunk(e,a,i)}handleChunkPatch(t){const e=t.pos.x,a=t.pos.y,s=this.chunks[e]?.[a];if(!s||!t.patches)return;const i=this.ui.worldCtx;if(!i)return;const o=this.worldConfig.worldgenParams.general.chunk.size,r=t.pos.x*o,n=t.pos.y*o;for(const e of t.patches){const t=e.i;void 0!==e.pixel&&(s.pixelData[t]=e.pixel),void 0!==e.height&&(s.heightData[t]=e.height),s.waterData&&void 0!==e.water&&(s.waterData[t]=e.water);const a=t%o,l=Math.floor(t/o),h=r+a,d=n+l,c=s.getColorAt(a,l,o),m=this.utility.getNoise(this.worldConfig.worldgenParams.material.detail.noiseType,h*this.worldConfig.worldgenParams.material.detail.scale,d*this.worldConfig.worldgenParams.material.detail.scale,this.currentSeed+3e3,{octaves:this.worldConfig.worldgenParams.terrain.octaves,persistence:this.worldConfig.worldgenParams.terrain.persistence}),u=this.adjustPixelColor(c,m);i.fillStyle=u,i.fillRect(h,d,1,1)}}async dumpChunkBuffer(){console.log("Starting background chunk streaming...");for(let t=0;t<this.chunkBuffer.length;t++){const e=this.chunkBuffer[t];e.loaded||(this.loadChunk(e.cx,e.cy),e.loaded=!0,await this.utility.yield())}this.chunkBuffer=[],this.worldBuffer=null,this.bakeRegionsFromChunks(),console.log("All chunks loaded.")}loadChunk(t,e){if(!this.worldBuffer||!this.worldBuffer.cellLayerGrid||!this.worldBuffer.worldWaterData)return;const a=this.worldConfig.worldLayerList,o=this.worldConfig.worldgenParams.general.chunk.size,r=this.worldConfig.worldgenParams.general.cell.size,n=new Uint8Array(o*o),l=new Uint8Array(o*o),h=new Uint8Array(o*o);for(let a=0;a<o;a++)for(let r=0;r<o;r++){const d=t*o+r,c=e*o+a;if(d>=s||c>=i)continue;const m=c*s+d,u=a*o+r;n[u]=this.worldBuffer.worldPixelData[m],l[u]=this.worldBuffer.worldHeightData[m],h[u]=this.worldBuffer.worldWaterData[m]}const d={},c=Math.ceil(s/r),m=Math.ceil(i/r),u=Math.floor(t*o/r),g=Math.floor(((t+1)*o-1)/r),p=Math.floor(e*o/r),y=Math.floor(((e+1)*o-1)/r);for(let t=p;t<=y;t++)if(!(t<0||t>=m))for(let e=u;e<=g;e++){if(e<0||e>=c)continue;const a=this.worldBuffer.cellLayerGrid[t][e];d[a]=(d[a]||0)+1}let f=0,w=-1;for(const t in d){const e=d[t];e>w&&(w=e,f=parseInt(t,10))}const x=a[f]||a[0],b=new X(x.name,n,l,h,this.worldConfig);this.chunks[t]||(this.chunks[t]=[]),this.chunkLayers[t]||(this.chunkLayers[t]=[]),this.chunks[t][e]=b,this.chunkLayers[t][e]=x,this.renderChunk(t,e,b)}generateAudioZones(){console.log("Generating audio zones..."),this.regions.forEach(t=>{const e=this.worldConfig.regionAudioParams[t.name];if(!e||t.area<e.minRegionSize)return;const a=this.audioConfig.resources.ambience.beds[t.name];if(!a||!a.length)return;const s=a[0],i=this.worldConfig.worldgenParams.general.chunk.size;this.regionAudioSources.set(t.id,{element:null,volume:0});const o=(t.bounds.maxX-t.bounds.minX+1)*i,r=(t.bounds.maxY-t.bounds.minY+1)*i,n=2*e.radius*.9,l=Math.ceil(o/n),h=Math.ceil(r/n),d=l*h;d>10&&console.warn(`Region ${t.name} needs ${d} zones - capping at 10.`);let c=0;for(let a=0;a<h;a++){for(let o=0;o<l&&!(c>=10);o++){const r=t.bounds.minX*i+(o+.5)*n,l=t.bounds.minY*i+(a+.5)*n,h={x:Math.max(t.bounds.minX*i,Math.min(t.bounds.maxX*i+i,r)),y:Math.max(t.bounds.minY*i,Math.min(t.bounds.maxY*i+i,l))},d=`${t.id}_${o}_${a}`;this.audioZones.set(d,{region:t,center:h,audioParams:{src:s,listener:this.playerState.myPlayer.transform.pos,loop:!0,output:"sfx",volume:e.volume,spatial:{blend:1,pos:h,rolloff:{distance:e.radius,factor:1,type:"logarithmic"}}},isActive:!1}),c++}if(c>=10)break}}),console.log(`Generated ${this.audioZones.size} audio zones.`)}updateAudioZones(){if(!this.playerState?.myPlayer)return;const t=this.playerState.myPlayer.transform.pos;this.regionAudioSources.forEach(t=>t.volume=0),this.audioZones.forEach(e=>{const a=t.x-e.center.x,s=t.y-e.center.y,i=Math.sqrt(a*a+s*s),o=i<(e.audioParams.spatial?.rolloff?.distance||500);if(e.isActive=o,o){const t=e.audioParams.spatial.rolloff,a=Math.min(1,i/t.distance),s=t.factor>0?t.factor:.5,o="logarithmic"===t.type?1-Math.pow(a,.5)*s:1-a*s,r=e.region.id,n=this.regionAudioSources.get(r);n&&(n.volume=Math.max(n.volume,o))}}),this.regionAudioSources.forEach((t,e)=>{const a=this.regions.find(t=>t.id===e);if(!a)return;const s=this.worldConfig.regionAudioParams[a.name];if(!s)return;const i=s.volume.min+(s.volume.max-s.volume.min)*t.volume;if(i>s.volume.min){if(!t.element){const e=this.audioConfig.resources.ambience.beds[a.name][0];t.element=this.audioManager.playAudio({src:e,loop:!0,output:"ambience",volume:{min:s.volume.min,max:s.volume.max}}),console.log(`Started ${a.name} ambience`)}t.element&&t.element.setVolume(i)}else t.element&&(t.element.stop(),t.element=null,console.log(`Stopped ${a.name} ambience`))})}cleanWorldAudio(){console.log("Clearing world ambience..."),this.regionAudioSources.forEach(t=>{if(t.element)try{t.element.stop()}catch(t){console.warn("Failed to stop world audio:",t)}}),this.regionAudioSources.clear(),this.audioZones.clear()}initLoadingProgressEvents(){document.addEventListener("yieldMessage",t=>{const e=t,a=document.getElementById("loadingMessage");a&&(a.textContent=e.detail.message)}),document.addEventListener("yieldProgress",()=>{const t=document.getElementById("loadingBarFill");if(!t)return;const e=parseFloat(t.style.width||"0"),a=Math.min(100,e+100/this.totalYieldSteps());t.style.width=`${a}%`})}exportWorldData(){console.log("Exporting full world data snapshot...");const t=this.worldConfig.worldgenParams.general.chunk.size,e=t=>{let e="";const a=t.byteLength;for(let s=0;s<a;s++)e+=String.fromCharCode(t[s]);return btoa(e)},a=[];for(let s=0;s<this.chunks.length;s++){const i=this.chunks[s];if(i)for(let o=0;o<i.length;o++){const r=i[o];if(!r)continue;const n={x:s*t,y:o*t};a.push({cx:s,cy:o,pos:n,size:t,chosenBiomeName:r.chosenBiomeName,pixelData:e(r.pixelData),heightData:e(r.heightData),waterData:e(r.waterData)})}}const o=this.regions.map(t=>({id:t.id,name:t.name,layerName:t.layerName,bounds:t.bounds,chunkCoords:t.chunkCoords,area:t.area})),r=[];this.audioZones.forEach((t,e)=>{r.push({id:e,regionId:t.region.id,regionName:t.region.name,center:t.center,src:t.audioParams.src,volume:t.audioParams.volume,rolloff:t.audioParams.spatial?.rolloff,radius:t.audioParams.spatial?.rolloff?.distance})});const n={meta:{seed:this.currentSeed,generatedAt:(new Date).toISOString(),worldSize:{width:s,height:i},chunkCount:a.length,regionCount:this.regions.length,audioZoneCount:this.audioZones.size},params:this.worldConfig.worldgenParams,chunks:a,regions:o,audioZones:r},l=JSON.stringify(n,null,2),h=new Blob([l],{type:"application/json"}),d=document.createElement("a");d.href=URL.createObjectURL(h),d.download=`${this.currentSeed}.json`,d.click(),console.log(`World exported successfully (${this.currentSeed}.json)`)}async loadWorldFromFile(t){console.log(`Loading saved world from ${t.name}...`);const e=await t.text(),a=JSON.parse(e);this.showLoadingMenu(),this.clear(),this.worldConfig.worldgenParams=a.params,this.currentSeed=a.meta.seed;const s=t=>{const e=atob(t),a=e.length,s=new Uint8Array(a);for(let t=0;t<a;t++)s[t]=e.charCodeAt(t);return s};this.chunks=[],this.chunkLayers=[];const i=a.chunks.length,o=this.worldConfig.worldLayerList;for(let t=0;t<i;t++){const e=a.chunks[t],r=s(e.pixelData),n=s(e.heightData),l=s(e.waterData),h=new X(e.chosenBiomeName,r,n,l,this.worldConfig),d=o.find(t=>t.name===e.chosenBiomeName)||o[0],c=e.cx,m=e.cy;this.chunks[c]||(this.chunks[c]=[]),this.chunkLayers[c]||(this.chunkLayers[c]=[]),this.chunks[c][m]=h,this.chunkLayers[c][m]=d,h.pos=e.pos,h.size=e.size,this.renderChunk(c,m,h),t%20==0&&await this.utility.yield(`Restoring chunk ${t}/${i}`)}console.log("All chunks rendered."),this.regions=a.regions.map(t=>({id:t.id,name:t.name,layerName:t.layerName,bounds:t.bounds,chunkCoords:t.chunkCoords,area:t.area})),this.audioZones.clear(),a.audioZones.forEach(t=>{const e=this.regions.find(e=>e.id===t.regionId);e&&this.audioZones.set(t.id,{region:e,center:t.center,audioParams:{src:t.src,loop:!0,output:"sfx",volume:t.volume,spatial:{blend:1,pos:t.center,rolloff:t.rolloff}},isActive:!1})}),this.isGenerated=!0,this.hideLoadingMenu(),console.log(`World loaded and rendered successfully (Seed: ${a.meta.seed}).`)}}class et{constructor(){this.isRoundInProgress=!1,this.roundWinner=null,this.gameWinner=null,this.cacheManager=new u,this.utility=new N,this.gameState=new v,this.audioConfig=new z,this.playerConfig=new V,this.settingsManager=new R(this.audioConfig,this.cacheManager,this.playerConfig),this.controlsManager=new f(this.settingsManager),this.charConfig=new p,this.charManager=new y(this.charConfig),this.userId=this.utility.generateUID(this.playerConfig.default.data.idLength),this.playerState=new K(this.playerConfig,this.userId,this.utility),this.camera=new g(this.playerState,this.utility),this.ui=new B(this.playerState,this.settingsManager,this.utility),this.admin=new c(this.cacheManager,this.ui),this.objectsManager=new M(this.playerState,this.utility),this.roomManager=new k(this.userId,this.utility),this.lobbyManager=new C(this.charManager,this.playerConfig,this.playerState,this.roomManager,this.settingsManager,this.ui,this.utility),this.wsManager=new O(this.gameState,this.roomManager,this.utility),this.chatManager=new H(this.roomManager,this.ui),this.upgradeManager=new A(this.playerConfig,this.playerState,this.ui,this.utility),this.roomController=new E(this.gameState,this.lobbyManager,this.playerState,this.roomManager,this.ui,this.upgradeManager,this.userId,this.utility,this.wsManager),this.collisionsManager=new w(this.objectsManager,this.playerState,this.roomManager,this.ui,this.userId),this.moveController=new F(this.controlsManager,this.playerState,this.settingsManager),this.staminaController=new Y(this.playerState),this.luckController=new W(this.playerState),this.audioManager=new $(this.audioConfig,this.roomManager,this.settingsManager,this.utility),this.animator=new m(this.playerState,this.roomManager,this.userId),this.world=new tt(this.audioConfig,this.audioManager,this.camera,this.controlsManager,this.playerState,this.roomManager,this.ui,this.utility),this.renderingManager=new _(this.animator,this.camera,this.charManager,this.lobbyManager,this.objectsManager,this.playerConfig,this.ui,this.userId),this.decalsManager=new b(this.camera,this.charConfig,this.playerState,this.renderingManager,this.roomManager,this.ui,this.userId,this.utility),this.particlesManager=new P(this.camera,this.charConfig,this.collisionsManager,this.decalsManager,this.playerState,this.renderingManager,this.roomManager,this.ui,this.userId,this.utility),this.playerController=new G(this.audioConfig,this.audioManager,this.decalsManager,this.gameState,this.luckController,this.moveController,this.objectsManager,this.particlesManager,this.playerState,this.roomManager,this.ui,this.userId,this.utility,this.world),this.combatController=new j(this.animator,this.audioConfig,this.audioManager,this.collisionsManager,this.decalsManager,this.gameState,this.luckController,this.particlesManager,this.playerController,this.playerState,this.roomManager,this.ui,this.userId,this.utility,this.world),this.dashController=new U(this.collisionsManager,this.combatController,this.moveController,this.playerState,this.roomManager,this.staminaController,this.userId),this.eventsManager=new S(this.animator,this.audioManager,this.camera,this.chatManager,this.controlsManager,this.gameState,this.roomController,this.playerState,this.settingsManager,this.ui,this.userId),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initClient()}):this.initClient(),document.addEventListener("keydown",t=>{if("Escape"===t.key&&this.gameState.gameInProgress&&!this.lobbyManager.inLobby){t.preventDefault();const e=20;this.playerState.myPlayer.actions.primary.magazine.currentReserve+=e,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(e)}})}clear(){this.isRoundInProgress=!1,this.gameWinner=null,this.roundWinner=null}async initClient(){this.ui.initInterface(),this.eventsManager.initEventListeners(),this.initGlobalEvents(),this.roomController.checkForRoomInURL(),this.roomController.showRoomControls();const t={spanId:"userId",value:this.userId};this.utility.setSpan(t),await this.settingsManager.loadSettings();const e=this.settingsManager.getSettings();this.ui.initSoundSliders(e),this.ui.initSettingsInputs(e),this.ui.initSettingsToggles(e),this.ui.ammoReservesUIController.initAmmoReserveCanvas(),this.eventsManager.initKeybindListeners(),this.audioManager.updateMixerGains(),await this.audioManager.preloadAudio(this.audioConfig.resources.sfx,".ogg"),await this.audioManager.preloadAudio(this.audioConfig.resources.ambience,".ogg"),this.watchForInputs(),this.admin.onAdminCommand=(t,e)=>{this.roomManager.sendAdminCommand(t,e)},window.addEventListener("customEvent_AppStart",()=>{const t=this.audioConfig.resources.ambience.beds.app[0];this.audioManager.playAudio({src:t,loop:!0,output:"ambience",volume:{min:.025,max:.025}})})}initGlobalEvents(){window.addEventListener("customEvent_startGame",()=>this.startGame()),window.addEventListener("customEvent_resetGameState",t=>{const e=t;this.resetGameState(e.detail.resetType)}),this.roomManager.onMessage(t=>this.handleRoomMessage(t))}handleRoomMessage(t){switch(t.type){case"room-created":console.log("Room created");break;case"room-joined":console.log("Joined room - lobby"),this.playerState.isHost=!1,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId}),this.roomManager.sendMessage(JSON.stringify({type:"lobby-join",color:this.playerState.myPlayer.color,rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon}}));const e=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,a=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyManager.lobbyPlayers.set(this.userId,{id:this.userId,color:this.playerState.myPlayer.color,isHost:this.playerState.isHost,rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon},transform:{pos:{x:e,y:a},rot:0}}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),0===this.lobbyManager.lobbyPlayers.size&&(this.playerState.isHost=!0,this.lobbyManager.lobbyPlayers.get(this.userId).isHost=!0,this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),console.log("I am the only player in the room..."));break;case"user-left":console.log(`User ${t.userId} left`),this.lobbyManager.lobbyPlayers.delete(t.userId),this.playerState.players.delete(t.userId),this.ui.leaderboard.delete(t.userId),this.ui.updateLeaderboardDisplay(this.userId),console.log(`Removed ${t.userId} from leaderboard`),this.combatController.projectiles.forEach((e,a)=>{e.ownerId===t.userId&&this.combatController.projectiles.delete(a)}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId);break;case"room-message":this.handleGameMessage(t);break;case"room-error":alert(`Error: ${t.message}`)}}async handleGameMessage(t){if(t.message)try{const e=JSON.parse(t.message);switch(e.type){case"lobby-join":const a=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,s=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyManager.lobbyPlayers.set(t.userId,{id:t.userId,color:e.color,isHost:!1,rig:e.rig,transform:{pos:{x:a,y:s},rot:0}}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.playerState.isHost&&this.roomManager.sendMessage(JSON.stringify({type:"lobby-state",players:Array.from(this.lobbyManager.lobbyPlayers.values()),options:{privateRoom:this.roomManager.isPrivateRoom,maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,upgradesEnabled:this.upgradeManager.isUpgradesEnabled}}));break;case"lobby-state":this.lobbyManager.lobbyPlayers.clear(),e.players.forEach(t=>{this.lobbyManager.lobbyPlayers.set(t.id,t)}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),e.options&&this.lobbyManager.syncLobbyOptions(e.options);break;case"lobby-options":this.lobbyManager.syncLobbyOptions(e);break;case"promote-player":this.lobbyManager.lobbyPlayers.forEach((t,a)=>{t.isHost=a===e.targetPlayerId}),this.playerState.isHost=e.targetPlayerId===this.userId,this.playerState.isHost&&"host-migration"===e.reason&&console.log("I am now the host due to host migration"),this.lobbyManager.setupLobbyOptions({maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager);break;case"return-to-lobby":console.log("Returning to lobby - last player or game ended"),e.newHostId===this.userId&&(this.playerState.isHost=!0,console.log("I am now the host as the last remaining player")),this.resetGameState("Lobby"),this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId});break;case"kick-player":e.targetPlayerId===this.userId&&(alert("You have been kicked from the lobby"),this.roomController.leaveRoom());break;case"chat-message":t.userId!==this.userId&&this.chatManager.displayChatMessage({senderId:t.userId,message:e.message,isOwn:!1});break;case"player-state":{const a=e.data;if(!a||!a.id)return;this.playerState.players.set(a.id,a),this.ui.createLeaderboard(this.lobbyManager,this.playerState.players,this.userId),console.log("State update for player",t.userId,":",e);break}case"partial-state":{if(t.userId===this.userId)return;const a=this.playerState.players.get(t.userId);if(!a)break;this.utility.deepMerge(a,e),console.log("Partial State update for player",t.userId,":",e);break}case"player-move":if(!this.lobbyManager.inLobby&&this.playerState.players.has(t.userId)){const a=this.playerState.players.get(t.userId);if(!a)break;e.transform.pos&&(a.transform.pos.x=e.transform.pos.x,a.transform.pos.y=e.transform.pos.y),void 0!==e.transform.rot&&(a.transform.rot=e.transform.rot)}break;case"player-hit":if(e.projectileId&&this.combatController.projectiles.delete(e.projectileId),e.targetId===this.userId)this.playerState.myPlayer.stats.health.value=e.newHealth,this.ui.updateSlider("health"),this.playerState.myPlayer.stats.health.value<=0&&this.playerController.playerDeath();else if(this.playerState.players.has(e.targetId)){const t=this.playerState.players.get(e.targetId);if(!t)break;t.stats.health.value=e.newHealth,t.stats.health.value<=0&&console.log(`Player ${t.id} died`)}if(e.wasKill){const t=this.ui.leaderboard.get(e.shooterId);t&&t.kills++;const a=this.ui.leaderboard.get(e.targetId);a&&a.deaths++,this.ui.updateLeaderboardDisplay(this.userId)}break;case"player-death":t.userId!==this.userId&&e.ammoBox&&(this.objectsManager.ammoBoxes.set(e.ammoBox.id,e.ammoBox),console.log(`Ammo box spawned at death of ${t.userId}`));const i={gore:{amount:this.utility.getRandomInt(2,5)},blood:{amount:this.utility.getRandomInt(1,3)},ownerId:t.userId,pos:{x:e.x,y:e.y},radius:e.size};this.decalsManager.generateGore(i),console.log(`Generated gore for ${t.userId}`);break;case"ammo-pickup":if(e.playerId===this.userId)break;if(this.objectsManager.ammoBoxes.has(e.ammoBoxId)){const t=this.objectsManager.ammoBoxes.get(e.ammoBoxId);if(!t)break;t.isOpen=e.boxState.isOpen,t.lid=e.boxState.lid,console.log(`Ammo box opened by ${e.playerId}`)}break;case"weapon-change":if(t.userId!==this.userId&&this.playerState.players.has(t.userId)){const a=this.playerState.players.get(t.userId);if(!a)break;a.rig.weapon=e.weapon,console.log(`${t.userId} switched to ${e.weapon}`)}break;case"projectile-launch":this.lobbyManager.inLobby||t.userId===this.userId||this.combatController.projectiles.set(e.projectile.id,e.projectile);break;case"projectile-remove":this.lobbyManager.inLobby||this.combatController.projectiles.delete(e.projectileId);break;case"projectile-update":if(!this.lobbyManager.inLobby&&this.combatController.projectiles.has(e.projectileId)){const t=this.combatController.projectiles.get(e.projectileId);if(!t)break;t.ownerId=e.newOwnerId,t.velocity=e.velocity,t.color=e.color,t.transform.rot=Math.atan2(t.velocity.y,t.velocity.x),console.log(`Projectile ${e.projectileId} data updated by ${e.newOwnerId}`)}break;case"start-game":e.spawnMap&&e.spawnMap[this.userId]&&(this.playerState.myPlayer.transform.pos.x=e.spawnMap[this.userId].x,this.playerState.myPlayer.transform.pos.y=e.spawnMap[this.userId].y,console.log("My Player Spawn:",e.spawnMap[this.userId].x,e.spawnMap[this.userId].y)),e.spawnMap&&this.playerState.players.forEach((t,a)=>{e.spawnMap[a]&&(t.transform.pos.x=e.spawnMap[a].x,t.transform.pos.y=e.spawnMap[a].y,console.log(`Player ${a} spawn:`,e.spawnMap[a].x,e.spawnMap[a].y))}),e.worldData&&await this.world.generateWorld(e.worldData),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop();break;case"game-end":console.log(`Game ended! Winner: ${e.winnerId}`),this.gameWinner=e.winnerId;break;case"round-end":console.log(`Round ended! Winner: ${e.winnerId||"No one"}`),this.endRound(e.winnerId);break;case"new-round":if(!e.spawnMap)return;console.log(e.spawnMap),this.ui.upgradeContainer&&(this.ui.upgradeContainer.style.display="none"),console.log("New round started! Everyone respawning..."),this.isRoundInProgress=!0,this.roundWinner=null,this.playerState.myPlayer.stats.health.value=this.playerState.myPlayer.stats.health.max,this.ui.updateSlider("health"),this.ui.updateSlider("stamina"),this.playerState.myPlayer.transform.pos.x=e.spawnMap[this.userId].x,this.playerState.myPlayer.transform.pos.y=e.spawnMap[this.userId].y,this.resumeGame(),this.playerState.players.forEach((t,a)=>{e.spawnMap[a]&&(t.transform.pos.x=e.spawnMap[t.id].x,t.transform.pos.y=e.spawnMap[t.id].y,t.transform.rot=0,t.stats.health.value=t.stats.health.max,t.stats.stamina.value=t.stats.stamina.max)});break;case"upgrade-taken":e.upgradeId&&e.isUnique&&(this.upgradeManager.removeUpgradeFromPool(e.upgradeId),console.log(`Unique upgrade ${e.upgradeId} taken by ${t.userId}`)),this.roundWinner===this.userId&&(this.upgradeManager.upgradesCompleted.add(t.userId),console.log(`${t.userId} completed upgrade. ${this.upgradeManager.upgradesCompleted.size}/${this.playerState.players.size} done`),this.upgradeManager.upgradesCompleted.size>=this.playerState.players.size&&this.showWinnerContinueButton());break;case"play-audio":t.userId!==this.userId&&this.audioManager.playAudio(e.params);break;case"add-decal":t.userId!==this.userId&&this.decalsManager.createDecalNetwork(e.params);break;case"add-particles":t.userId!==this.userId&&this.particlesManager.createParticlesNetwork(e.params);break;case"particle-emitter":if(t.userId!==this.userId){const t={id:e.id,interval:e.interval,lifetime:e.lifetime,offset:{x:e.offset.x,y:e.offset.y},particleType:e.particleType,playerId:e.playerId,pos:{x:e.pos.x,y:e.pos.y}};this.particlesManager.generateEmitter(t)}break;case"character-animation":e.params.playerId!==this.userId&&this.animator.animateCharacterPartNetwork(e.params);break;case"shrapnel-spawn":t.userId!==this.userId&&this.particlesManager.generateShrapnel(e.pieces);break;case"chunk-update":t.userId!==this.userId&&this.world.worldEdit.createChunkPatchNetwork(e.chunk)}}catch(t){console.error("Error parsing game message:",t)}}returnToLobby(){this.resetGameState("Lobby"),this.roomManager.sendMessage(JSON.stringify({type:"return-to-lobby",reason:"game-ended"})),this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId})}endRound(t){if(this.isRoundInProgress){if(console.log(`Server confirmed round end. Winner: ${t||"No one"}`),this.isRoundInProgress=!1,this.roundWinner=t,!t)return console.log("Round ended with no survivors!"),void(this.playerState.isHost&&this.utility.safeTimeout(()=>{this.startNewRound()},h.ROUND_END_DELAY));if(t&&this.ui.leaderboard.has(t)){const e=this.ui.leaderboard.get(t);if(!e)return;if(e.wins++,console.log(`${t} won the round! Total wins: ${e.wins}`),e.wins>=this.gameState.gameMaxWins)return void this.endGame(t);this.ui.updateLeaderboardDisplay(this.userId)}this.utility.safeTimeout(()=>{this.pauseGame()},h.ROUND_END_DELAY/6),this.utility.safeTimeout(()=>{this.startUpgradePhase(t)},h.ROUND_END_DELAY)}else console.log("Ignoring endRound - round already ended")}endGame(t){this.gameWinner=t,console.log(`${t} won the game with ${this.gameState.gameMaxWins} wins!`),this.roomManager.sendMessage(JSON.stringify({type:"game-end",winnerId:t})),this.utility.safeTimeout(()=>{this.returnToLobby()},h.GAME_END_DELAY)}startNewRound(){console.log("Starting new round..."),this.roomManager.sendMessage(JSON.stringify({type:"new-round",reservedSpawn:{x:3170*Math.random()+o,y:2370*Math.random()+o}}))}showGameControls(t){this.ui.updateDisplay(this.lobbyManager,"game",t)}startGame(){this.playerState.isHost&&(1!==this.lobbyManager.lobbyPlayers.size?this.executeStartGame():this.ui.soloGameWarning(()=>this.executeStartGame()))}async executeStartGame(){const t=await this.world.showGenerationMenu();this.roomManager.sendMessage(JSON.stringify({type:"start-game",reservedSpawn:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},worldData:t})),"load"!==t&&await this.world.generateWorld(t),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop()}startGameLoop(){this.gameState.gameInProgress=!0,this.isRoundInProgress=!0,this.playerState.myPlayer.actions.primary.magazine.currentReserve=Math.floor(this.playerConfig.default.actions.primary.magazine.maxReserve/2),this.playerState.myPlayer.actions.primary.magazine.currentAmmo=this.playerState.myPlayer.actions.primary.magazine.size,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(this.playerState.myPlayer.actions.primary.magazine.currentReserve),this.playerState.isReloading=!1,this.ui.createLeaderboard(this.lobbyManager,this.playerState.players,this.userId),this.upgradeManager.resetUpgrades(this.playerState.myPlayer);const t=this.lobbyManager.lobbyPlayers.get(this.userId);t&&(console.log("Found lobby rig for my player: ",t.rig),this.playerState.myPlayer.rig.body=t.rig.body,this.playerState.myPlayer.rig.head=t.rig.head,this.playerState.myPlayer.rig.headwear=t.rig.headwear,this.playerState.myPlayer.rig.weapon=t.rig.weapon),this.roomManager.sendMessage(JSON.stringify({type:"player-state",userId:this.userId,data:this.playerState.myPlayer})),this.gameLoop(),this.ui.updateSlider("health"),this.ui.updateSlider("stamina")}gameLoop(){if(!(this.gameState.gameInProgress&&this.ui.ctx&&this.ui.canvas&&this.ui.decalCtx&&this.ui.decalCanvas&&this.ui.postEffectsCtx))return;if(this.gameState.isPaused)return void requestAnimationFrame(()=>this.gameLoop());const t=this.utility.deltaTime();this.camera.update(t),this.playerController.updatePlayerPosition(t),this.combatController.updateAttack(t),this.combatController.updateProjectiles(t),this.particlesManager.updateParticles(t),this.particlesManager.updateEmitters(t),this.particlesManager.updateShrapnel(t),this.animator.updateCharacterAnimations(t),this.staminaController.updateStamina(t),this.dashController.updateDash(t),this.collisionsManager.checkCollisions(t),this.ui.updateSlider("stamina"),this.renderingManager.clearCtx(this.ui.ctx),this.world.drawWorld(),this.world.worldDebug.drawDebug(),this.world.updateAudioZones(),this.ui.ctx.drawImage(this.ui.decalCanvas,this.camera.pos.x,this.camera.pos.y,r,n,0,0,r,n),this.renderingManager.drawObjects(),this.combatController.projectiles.forEach(t=>{this.renderingManager.drawProjectile(t)}),this.playerState.players.forEach(t=>{if(!this.ui.ctx)return;const e={player:t,context:this.ui.ctx};this.renderingManager.drawCharacter(e)});const e={player:this.playerState.myPlayer,context:this.ui.ctx};this.renderingManager.drawCharacter(e),this.particlesManager.drawParticles(),this.particlesManager.drawShrapnel(),requestAnimationFrame(()=>this.gameLoop())}pauseGame(){this.gameState.gameInProgress&&(this.gameState.isPaused=!0,console.log("Game paused"),this.controlsManager.clearActiveKeys(),this.playerState.isSprinting=!1,this.playerState.isDashing=!1,this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0)}resumeGame(){this.gameState.gameInProgress&&(this.gameState.isPaused=!1,console.log("Game resumed"))}resetGameState(t){this.clear(),this.gameState.clear(),"Room"===t&&(this.lobbyManager.inLobby=!1,this.playerState.isHost=!1),this.combatController.projectiles.clear(),this.decalsManager.clear(),this.objectsManager.clear(),this.particlesManager.clear(),"Room"===t&&this.lobbyManager.lobbyPlayers.clear(),this.renderingManager.clearCtx(),this.ui.clear(),this.chatManager.clear(),this.playerState.clear(),this.playerState.initPlayer(this.userId),this.controlsManager.clear(),this.animator.clear(),this.utility.clearTimeoutCache(),this.world.clear(),this.upgradeManager.resetUpgrades(this.playerState.myPlayer),this.upgradeManager.upgradesCompleted.clear()}watchForInputs(){const t=()=>{this.controlsManager.gamepadConnectionEnabled&&this.controlsManager.pollGamepad(),this.checkActions(),requestAnimationFrame(t)};t()}checkActions(){if(!this.gameState.gameInProgress||this.gameState.isPaused)return;const t=this.settingsManager.getSettings().controls.keybinds;this.controlsManager.triggered(t.dash)&&this.dashController.startDash(),this.controlsManager.triggered(t.melee)&&this.combatController.canMelee()&&this.combatController.triggerAttack("melee"),this.controlsManager.triggered(t.reload)&&this.combatController.startReload(),this.controlsManager.held(t.sprint)?this.moveController.isMoveInput()&&(this.playerState.isSprinting=!0):this.playerState.isSprinting=!1,this.controlsManager.triggered(t.attack)&&(!this.playerState.canShoot||this.playerState.isBurstActive||this.playerState.isMelee||this.combatController.triggerAttack("ranged")),this.controlsManager.held(t.attack)&&this.playerState.canAutoFire&&this.combatController.triggerAttack("ranged");const e=this.controlsManager.getGamepadRAxis();null!==e&&this.animator.rotateCharacterPart(this.userId,e),this.controlsManager.updatePreviousKeys()}startUpgradePhase(t){console.log("Starting upgrade phase..."),this.upgradeManager.upgradesCompleted.clear(),t===this.userId?this.showWinnerWaitScreen():this.showUpgradeSelection(2)}showWinnerWaitScreen(){if(!this.ui.upgradeContainer)return;this.ui.upgradeContainer.innerHTML="";const t=document.createElement("div");t.className="upgrade_waiting",t.textContent="Waiting for other players...",this.ui.upgradeContainer.appendChild(t),this.ui.upgradeContainer.style.display="flex"}showWinnerContinueButton(){if(!this.ui.upgradeContainer)return;this.ui.upgradeContainer.innerHTML="";const t=document.createElement("div");t.className="upgrade_waiting",t.textContent="Upgrade phase complete.";const e=document.createElement("button");e.textContent="Continue",e.onclick=()=>{this.ui.upgradeContainer&&(console.log("Winner pressed continue..."),this.ui.upgradeContainer.style.display="none",this.utility.safeTimeout(()=>{this.startNewRound()},h.NEW_ROUND_DELAY))},this.ui.upgradeContainer.appendChild(t),this.ui.upgradeContainer.appendChild(e),this.ui.upgradeContainer.style.display="flex"}showUpgradeSelection(t){this.ui.upgradeContainer&&(this.ui.upgradeContainer.innerHTML="",this.upgradeManager.getUpgrades(t,this.playerState.myPlayer).forEach(t=>{const e=document.createElement("div");e.className="upgrade_card container",e.setAttribute("data-rarity",t.rarity.toString());const a=document.createElement("div");a.className="upgrade_image";const s=document.createElement("img");s.src=t.icon,s.alt=t.name,s.className="upgrade_icon",s.onerror=()=>{console.warn(`Failed to load upgrade image: ${t.icon}`),s.style.display="none"},a.appendChild(s);const i=document.createElement("div");i.className="upgrade_name",i.textContent=t.name;const o=document.createElement("div");o.className="upgrade_subtitle",o.textContent=t.subtitle,e.appendChild(a),e.appendChild(i),e.appendChild(o),e.addEventListener("click",()=>{console.log("Selected upgrade: ",t.name),this.selectUpgrade(t.id)}),this.ui.upgradeContainer&&this.ui.upgradeContainer.appendChild(e)}),this.ui.upgradeContainer.style.display="flex")}selectUpgrade(t){this.upgradeManager.applyUpgrade(t,this.playerState.myPlayer)?this.finishUpgrade(t):console.error("Failed to apply upgrade")}finishUpgrade(t){this.ui.upgradeContainer&&(this.ui.upgradeContainer.style.display="none"),this.roomManager.sendMessage(JSON.stringify({type:"upgrade-taken",upgradeId:t,userId:this.userId,isUnique:this.upgradeManager.upgrades.find(e=>e.id===t)?.unique||!1})),this.roomManager.sendMessage(JSON.stringify({type:"player-state",userId:this.userId,data:this.playerState.myPlayer})),console.log("Upgrade selected, waiting for others...")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new et}):new et})()})();
//# sourceMappingURL=app.js.map