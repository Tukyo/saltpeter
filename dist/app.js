(()=>{"use strict";const t={ACTIONS:{DASH:{COOLDOWN:1e3,DRAIN:40,MULTIPLIER:3,TIME:150},PRIMARY:{BUFFER:100,BURST:{AMOUNT:1,DELAY:75},MAGAZINE:{SIZE:10,STARTING_RESERVE:20,MAX_RESERVE:50},OFFSET:10,RELOAD:{TIME:750}},SPRINT:{DRAIN:5,MULTIPLIER:1.75}},DATA:{ID_LENGTH:12},EQUIPMENT:{CROSSHAIR:!1},PHYSICS:{ACCELERATION:.55,FRICTION:.85},PROJECTILE:{AMOUNT:1,COLOR:"#fff5beff",DAMAGE:25,LENGTH:15,RANGE:5,SIZE:1,SPEED:30,SPREAD:.1},STATS:{LUCK:1,MAX_HEALTH:100,MAX_STAMINA:100,SIZE:100,SPEED:6},STAMINA:{RECOVER_DELAY:1e3,RECOVER_RATE:25},VISUAL:{ID_DISPLAY_OFFSET:25}},e={RADIUS:{MIN:4,MAX:8},DENSITY:{MIN:.175,MAX:.35},OPACITY:{MIN:.15,MAX:.25},VARIATION:.215,COLOR:"#000000"},s={RADIUS:{MIN:5,MAX:17.5},DENSITY:{MIN:.1,MAX:.175},OPACITY:{MIN:.275,MAX:.315},VARIATION:.5,COLOR:"#781414"},a={COUNT:{MIN:1,MAX:4},LIFETIME:{MIN:800,MAX:1e3},OPACITY:{MIN:.25,MAX:.75},SPEED:{MIN:.25,MAX:.75},SIZE:{MIN:.125,MAX:2.275},TORQUE:{MIN:-720,MAX:720},COLLIDE:!0,FADE:!0,PAINT:!1,SPREAD:.25,STAIN:!0,COLOR:"#8b1a1a"},i={COUNT:{MIN:4,MAX:12},LIFETIME:{MIN:150,MAX:1200},OPACITY:{MIN:.425,MAX:.775},SPEED:{MIN:1.5,MAX:4.75},SIZE:{MIN:.75,MAX:3.5},TORQUE:{MIN:-720,MAX:720},COLLIDE:!0,FADE:!1,PAINT:!0,SPREAD:.425,STAIN:!0,COLOR:"#8b1a1a"},r={COUNT:{MIN:8,MAX:15},LIFETIME:{MIN:150,MAX:300},OPACITY:{MIN:.4,MAX:.8},SPEED:{MIN:4,MAX:10},SIZE:{MIN:1,MAX:3},TORQUE:{MIN:0,MAX:0},COLLIDE:!1,FADE:!0,PAINT:!1,SPREAD:.6,STAIN:!1,COLOR:"#ffaa00"},o={COUNT:{MIN:1,MAX:1},LIFETIME:{MIN:250,MAX:550},OPACITY:{MIN:1,MAX:1},SPEED:{MIN:5,MAX:8},SIZE:{MIN:2,MAX:2},TORQUE:{MIN:-720,MAX:720},COLLIDE:!0,FADE:!1,PAINT:!0,SPREAD:.4,STAIN:!1,COLOR:"#d4af37"},n=800,l=600,h=15,m=1e3,c={MOVE_UP:"w",MOVE_LEFT:"a",MOVE_DOWN:"s",MOVE_RIGHT:"d",RELOAD:"r",SPRINT:"shift",ATTACK:"mouse1",DASH:" "};function y(){let e="";for(let s=0;s<t.DATA.ID_LENGTH;s++)e+="0123456789abcdefghijklmnopqrstuvwxyz"[Math.floor(36*Math.random())];return e}function d(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}function p(t,e,s=100,a=300){const i=document.getElementById(t),r=i?.querySelector("div");if(!i||!r)return void console.warn(`Slider not found: ${t}`);const o=Math.max(0,Math.min(s,e))/s*100,n=r.style.width||"100%",l=parseFloat(n.replace("%",""));Math.abs(l-o)<.1||(r.style.transition=`width ${a}ms ease-out`,r.style.width=`${o}%`,setTimeout(()=>{r&&(r.style.transition="")},a))}function u(t,e){const s=document.getElementById(t);s&&(e?(s.setAttribute("checked","true"),s.setAttribute("aria-checked","true")):(s.removeAttribute("checked"),s.setAttribute("aria-checked","false")))}function g(t,e){const s=document.getElementById(t);s&&(s.value=e.toString())}class I{constructor(t){this.currentRoom=null,this.ws=null,this.messageHandlers=[],this.userId=t}setWebSocket(t){this.ws=t,this.setupMessageHandler()}createRoom(){const t=function(){let t="room_";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyz"[Math.floor(36*Math.random())];return t}();return this.joinRoom(t,!0),t}joinRoom(t,e=!1){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void console.error("WebSocket not connected");const s={type:e?"create-room":"join-room",roomId:t,userId:this.userId};this.ws.send(JSON.stringify(s)),this.currentRoom=t,function(t){const e=`${window.location.origin}?room=${t}`;window.history.pushState({roomId:t},"",e)}(t)}leaveRoom(){if(!this.currentRoom||!this.ws)return;const t={type:"leave-room",roomId:this.currentRoom,userId:this.userId};this.ws.send(JSON.stringify(t)),this.currentRoom=null,window.history.pushState({},"",window.location.origin)}sendMessage(t){if(!this.currentRoom||!this.ws)return;const e={type:"room-message",roomId:this.currentRoom,userId:this.userId,message:t};this.ws.send(JSON.stringify(e))}getCurrentRoom(){return this.currentRoom}getRoomLink(){return this.currentRoom?(t=this.currentRoom,`${window.location.origin}?room=${t}`):null;var t}onMessage(t){this.messageHandlers.push(t)}setupMessageHandler(){this.ws&&(this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);this.messageHandlers.forEach(t=>t(e))}catch(e){const s={type:"room-message",userId:"server",message:t.data};this.messageHandlers.forEach(t=>t(s))}})}}const f=new Set,P=new Set;var M,E;!function(t){t[t.COMMON=0]="COMMON",t[t.UNCOMMON=1]="UNCOMMON",t[t.RARE=2]="RARE",t[t.EPIC=3]="EPIC",t[t.LEGENDARY=4]="LEGENDARY"}(M||(M={})),function(t){t.STAT="stat",t.UNIQUE="unique",t.EQUIPMENT="equipment"}(E||(E={}));const A={[M.COMMON]:{weight:70,color:"#ffffff"},[M.UNCOMMON]:{weight:20,color:"#1eff00"},[M.RARE]:{weight:7,color:"#0099ff"},[M.EPIC]:{weight:2,color:"#9d00ff"},[M.LEGENDARY]:{weight:1,color:"#ff9500"}},S=[{id:"bigger_is_better",name:"Bigger is Better",subtitle:"Have my bullets always been this big?",type:E.STAT,rarity:M.COMMON,unique:!1,func:()=>{t.PROJECTILE.SIZE*=1.1,t.PROJECTILE.DAMAGE*=1.05,t.PROJECTILE.SPREAD*=1.025,console.log("[Bigger is Better] - Projectile Changes: ","Size: ",t.PROJECTILE.SIZE,"Dmg: ",t.PROJECTILE.DAMAGE,"Spread: ",t.PROJECTILE.SPREAD)}},{id:"neural_target_interface",name:"Neural Target Interface",subtitle:"G.I.M.P. proprietary targeting module.",type:E.EQUIPMENT,rarity:M.UNCOMMON,unique:!1,func:()=>{t.EQUIPMENT.CROSSHAIR=!0,t.PROJECTILE.SPREAD*=.95,console.log("[Neural Target Interface] - Crosshair enabled.","Spread: ",t.PROJECTILE.SPREAD)}}];function R(){f.clear(),P.clear()}const C={GLOCK:["/assets/img/weapon/glock/body.png","/assets/img/weapon/glock/slide.png"],KNIFE:["/assets/img/weapon/melee/knife_00.png"]},b={DEFAULT:"/assets/img/char/default/body.png"},x={DEFAULT:"/assets/img/char/default/head.png"},v={DEFAULT:"/assets/img/char/default/headwear.png"},T={BLOOD:["/assets/img/effects/blood/blood_00.png","/assets/img/effects/blood/blood_01.png","/assets/img/effects/blood/blood_02.png","/assets/img/effects/blood/blood_03.png","/assets/img/effects/blood/blood_04.png"],GORE:["/assets/img/effects/gore/gore_00.png","/assets/img/effects/gore/gore_01.png","/assets/img/effects/gore/gore_02.png","/assets/img/effects/gore/gore_03.png","/assets/img/effects/gore/gore_04.png","/assets/img/effects/gore/gore_05.png","/assets/img/effects/gore/gore_06.png","/assets/img/effects/gore/gore_07.png","/assets/img/effects/gore/gore_08.png","/assets/img/effects/gore/gore_09.png","/assets/img/effects/gore/gore_10.png","/assets/img/effects/gore/gore_11.png","/assets/img/effects/gore/gore_12.png","/assets/img/effects/gore/gore_13.png"]},O={body:"DEFAULT",weapon:"GLOCK",head:"DEFAULT",headwear:"DEFAULT"};class N{constructor(){this.ws=null,this.canvas=null,this.ctx=null,this.decalCanvas=null,this.decalCtx=null,this.roomControls=null,this.gameContainer=null,this.userIdDisplay=null,this.roomIdDisplay=null,this.gameRoomIdDisplay=null,this.lobbyContainer=null,this.lobbyPlayersList=null,this.startGameBtn=null,this.gameOptionsContainer=null,this.chatContainer=null,this.chatMessages=null,this.chatInput=null,this.chatSendBtn=null,this.privateToggle=null,this.upgradesToggle=null,this.winsInput=null,this.playersInput=null,this.upgradeContainer=null,this.leaderboardContainer=null,this.leaderboardBody=null,this.crosshair=null,this.players=new Map,this.lobbyPlayers=new Map,this.characterImages=new Map,this.characterOffsets=new Map,this.characterAnimations=new Map,this.decals=new Map,this.particles=new Map,this.emitters=new Map,this.projectiles=new Map,this.ammoBoxes=new Map,this.gamePaused=!1,this.gameRunning=!1,this.isHost=!1,this.inLobby=!1,this.isPrivateRoom=!1,this.isUpgradesEnabled=!0,this.isRoundInProgress=!1,this.gameMaxWins=5,this.gameMaxPlayers=4,this.alivePlayersCount=0,this.roundWinner=null,this.gameWinner=null,this.leaderboard=new Map,this.pausedPlayers=new Set,this.keys=new Set,this.canShoot=!0,this.isBurstActive=!1,this.isReloading=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.mouseX=0,this.mouseY=0,this.lastSentX=0,this.lastSentY=0,this.lastSentRotation=0,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastShotTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0,this.defaultPlayerConfig=JSON.parse(JSON.stringify(t)),this.userId=y(),this.roomManager=new I(this.userId),this.myPlayer={id:this.userId,transform:{pos:{x:770*Math.random()+h,y:570*Math.random()+h},rot:0},color:"#"+Math.floor(16777215*Math.random()).toString(16).padStart(6,"0"),actions:{dash:{cooldown:t.ACTIONS.DASH.COOLDOWN,drain:t.ACTIONS.DASH.DRAIN,multiplier:t.ACTIONS.DASH.MULTIPLIER,time:t.ACTIONS.DASH.TIME},primary:{buffer:t.ACTIONS.PRIMARY.BUFFER,burst:{amount:t.ACTIONS.PRIMARY.BURST.AMOUNT,delay:t.ACTIONS.PRIMARY.BURST.DELAY},magazine:{currentAmmo:t.ACTIONS.PRIMARY.MAGAZINE.SIZE,currentReserve:t.ACTIONS.PRIMARY.MAGAZINE.STARTING_RESERVE,maxReserve:t.ACTIONS.PRIMARY.MAGAZINE.MAX_RESERVE,size:t.ACTIONS.PRIMARY.MAGAZINE.SIZE},offset:t.ACTIONS.PRIMARY.OFFSET,reload:{time:t.ACTIONS.PRIMARY.RELOAD.TIME}},sprint:{drain:t.ACTIONS.SPRINT.DRAIN,multiplier:t.ACTIONS.SPRINT.MULTIPLIER}},equipment:{crosshair:t.EQUIPMENT.CROSSHAIR},physics:{acceleration:t.PHYSICS.ACCELERATION,friction:t.PHYSICS.FRICTION},stats:{health:{max:t.STATS.MAX_HEALTH,value:t.STATS.MAX_HEALTH},stamina:{max:t.STATS.MAX_HEALTH,recovery:{delay:t.STAMINA.RECOVER_DELAY,rate:t.STAMINA.RECOVER_RATE},value:t.STATS.MAX_HEALTH},luck:t.STATS.LUCK,size:t.STATS.SIZE,speed:t.STATS.SPEED}},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initializeElements(),this.setupEventListeners(),this.checkForRoomInURL()}):(this.initializeElements(),this.setupEventListeners(),this.checkForRoomInURL())}initializeElements(){this.canvas=document.getElementById("gameCanvas"),this.decalCanvas=document.createElement("canvas"),this.roomControls=document.getElementById("roomControls"),this.gameContainer=document.getElementById("gameContainer"),this.lobbyContainer=document.getElementById("lobbyContainer"),this.lobbyPlayersList=document.getElementById("lobbyPlayersList"),this.startGameBtn=document.getElementById("startGameBtn"),this.gameOptionsContainer=document.getElementById("gameOptionsContainer"),this.userIdDisplay=document.getElementById("userId"),this.roomIdDisplay=document.getElementById("roomId"),this.gameRoomIdDisplay=document.getElementById("gameRoomId"),this.chatContainer=document.getElementById("chatContainer"),this.chatMessages=document.getElementById("chatMessages"),this.chatInput=document.getElementById("chatInput"),this.chatSendBtn=document.getElementById("chatSendBtn"),this.privateToggle=document.getElementById("privateToggle"),this.upgradesToggle=document.getElementById("upgradesToggle"),this.winsInput=document.getElementById("winsInput"),this.playersInput=document.getElementById("playersInput"),this.upgradeContainer=document.getElementById("upgradeContainer"),this.crosshair=document.getElementById("crosshair"),this.leaderboardContainer=document.getElementById("leaderboardContainer"),this.leaderboardBody=document.getElementById("leaderboardBody"),this.canvas&&this.decalCanvas&&this.roomControls&&this.gameContainer&&this.lobbyContainer&&this.userIdDisplay&&this.roomIdDisplay&&this.lobbyPlayersList&&this.startGameBtn&&this.gameOptionsContainer&&this.chatContainer&&this.chatMessages&&this.chatInput&&this.chatSendBtn&&this.leaderboardContainer&&this.leaderboardBody?(this.canvas.width=n,this.canvas.height=l,this.decalCanvas.width=n,this.decalCanvas.height=l,this.ctx=this.canvas.getContext("2d"),this.decalCtx=this.decalCanvas.getContext("2d"),this.ctx&&this.decalCtx?(this.userIdDisplay.textContent=this.userId,this.showRoomControls()):console.error("Could not get canvas context")):console.error("Some required DOM elements are missing")}connectWebSocket(){const t="https:"===location.protocol?"wss:":"ws:";this.ws=new WebSocket(`${t}//${location.host}`),this.ws.onopen=()=>{console.log("Connected to WebSocket"),this.roomManager.setWebSocket(this.ws)},this.ws.onclose=()=>{console.log("Disconnected from WebSocket"),this.gameRunning=!1,setTimeout(()=>this.connectWebSocket(),3e3)},this.ws.onerror=t=>{console.error("WebSocket error:",t)}}handleRoomMessage(t){switch(t.type){case"room-created":console.log("Room created");break;case"room-joined":console.log("Joined room - lobby"),this.isHost=!1,this.showLobbyControls(t.roomId||""),this.roomManager.sendMessage(JSON.stringify({type:"lobby-join",color:this.myPlayer.color})),this.lobbyPlayers.set(this.userId,{id:this.userId,color:this.myPlayer.color,isHost:this.isHost}),this.updateLobbyPlayersList(),this.updateHostDisplay();break;case"user-joined":console.log(`User ${t.userId} joined`),this.gameRunning&&!this.inLobby&&this.roomManager.sendMessage(JSON.stringify({type:"player-state",id:this.myPlayer.id,transform:{pos:{x:this.myPlayer.transform.pos.x,y:this.myPlayer.transform.pos.y},rot:this.myPlayer.transform.rot},color:this.myPlayer.color,actions:{dash:{cooldown:this.myPlayer.actions.dash.cooldown,drain:this.myPlayer.actions.dash.drain,multiplier:this.myPlayer.actions.dash.multiplier,time:this.myPlayer.actions.dash.time},primary:{buffer:this.myPlayer.actions.primary.buffer,burst:{amount:this.myPlayer.actions.primary.burst.amount,delay:this.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.myPlayer.actions.primary.magazine.maxReserve,size:this.myPlayer.actions.primary.magazine.size},offset:this.myPlayer.actions.primary.offset,reload:{time:this.myPlayer.actions.primary.reload.time}},sprint:{drain:this.myPlayer.actions.sprint.drain,multiplier:this.myPlayer.actions.sprint.multiplier}},equipment:{crosshair:this.myPlayer.equipment.crosshair},physics:{acceleration:this.myPlayer.physics.acceleration,friction:this.myPlayer.physics.friction},stats:{health:{max:this.myPlayer.stats.health.max,value:this.myPlayer.stats.health.value},stamina:{max:this.myPlayer.stats.stamina.max,recovery:{delay:this.myPlayer.stats.stamina.recovery.delay,rate:this.myPlayer.stats.stamina.recovery.rate},value:this.myPlayer.stats.stamina.value},luck:this.myPlayer.stats.luck,size:this.myPlayer.stats.size,speed:this.myPlayer.stats.speed},leaderboard:Array.from(this.leaderboard.entries())}));break;case"room-joined-game":console.log("Joined room - game in progress"),this.isHost=!1,this.showGameControls(t.roomId||""),this.startGameLoop();break;case"user-left":console.log(`User ${t.userId} left`),this.lobbyPlayers.delete(t.userId),this.players.delete(t.userId),this.leaderboard.delete(t.userId),this.updateLeaderboardDisplay(),console.log(`Removed ${t.userId} from leaderboard`),this.projectiles.forEach((e,s)=>{e.ownerId===t.userId&&this.projectiles.delete(s)}),this.updateLobbyPlayersList();break;case"room-message":this.handleGameMessage(t);break;case"room-error":alert(`Error: ${t.message}`)}}handleGameMessage(e){var s;if(e.message)try{const a=JSON.parse(e.message);switch(a.type){case"lobby-join":this.lobbyPlayers.set(e.userId,{id:e.userId,color:a.color,isHost:!1}),this.updateLobbyPlayersList(),this.isHost&&this.roomManager.sendMessage(JSON.stringify({type:"lobby-state",players:Array.from(this.lobbyPlayers.values()),options:{privateRoom:this.isPrivateRoom,maxPlayers:this.gameMaxPlayers,maxWins:this.gameMaxWins,upgradesEnabled:this.isUpgradesEnabled}}));break;case"lobby-state":this.lobbyPlayers.clear(),a.players.forEach(t=>{this.lobbyPlayers.set(t.id,t)}),this.updateLobbyPlayersList(),this.updateHostDisplay(),a.options&&this.syncLobbyOptions(a.options);break;case"lobby-options":this.syncLobbyOptions(a);break;case"promote-player":this.lobbyPlayers.forEach((t,e)=>{t.isHost=e===a.targetPlayerId}),this.isHost=a.targetPlayerId===this.userId,this.isHost&&"host-migration"===a.reason&&console.log("I am now the host due to host migration"),this.updateLobbyPlayersList(),this.updateHostDisplay();break;case"return-to-lobby":console.log("Returning to lobby - last player or game ended"),this.gameRunning=!1,a.newHostId===this.userId&&(this.isHost=!0,console.log("I am now the host as the last remaining player")),this.players.clear(),this.projectiles.clear(),this.showLobbyControls(this.roomManager.getCurrentRoom()||"");break;case"kick-player":a.targetPlayerId===this.userId&&(alert("You have been kicked from the lobby"),this.leaveRoom());break;case"chat-message":e.userId!==this.userId&&this.displayChatMessage(e.userId,a.message,!1);break;case"player-state":this.inLobby||this.players.set(e.userId,{id:e.userId,transform:{pos:{x:a.transform?.pos.x,y:a.transform?.pos.y},rot:a.transform?.rot},color:a.color,actions:{dash:{cooldown:a.actions?.dash.cooldown||t.ACTIONS.DASH.COOLDOWN,drain:a.actions?.dash.drain||t.ACTIONS.DASH.DRAIN,multiplier:a.actions?.dash.multiplier||t.ACTIONS.DASH.MULTIPLIER,time:a.actions?.dash.time||t.ACTIONS.DASH.TIME},primary:{buffer:a.actions?.primary.buffer||t.ACTIONS.PRIMARY.BUFFER,burst:{amount:a.actions?.primary.burst.amount||t.ACTIONS.PRIMARY.BURST.AMOUNT,delay:a.actions?.primary.burst.delay||t.ACTIONS.PRIMARY.BURST.DELAY},magazine:{currentAmmo:a.actions?.primary.magazine.currentAmmo,currentReserve:a.actions?.primary.magazine.currentReserve,maxReserve:a.actions?.primary.magazine.maxReserve,size:a.actions?.primary.magazine.size||t.ACTIONS.PRIMARY.MAGAZINE.SIZE},offset:a.actions?.primary.offset||t.ACTIONS.PRIMARY.OFFSET,reload:{time:a.actions?.primary.reload.time||t.ACTIONS.PRIMARY.RELOAD.TIME}},sprint:{drain:a.actions?.sprint.drain||t.ACTIONS.SPRINT.DRAIN,multiplier:a.actions?.sprint.multiplier||t.ACTIONS.SPRINT.MULTIPLIER}},equipment:{crosshair:a.equipment?.crosshair||t.EQUIPMENT.CROSSHAIR},physics:{acceleration:a.physics?.acceleration||t.PHYSICS.ACCELERATION,friction:a.physics?.friction||t.PHYSICS.FRICTION},stats:{health:{max:a.stats?.health.max||t.STATS.MAX_HEALTH,value:a.stats?.health.value||t.STATS.MAX_HEALTH},stamina:{max:a.stats?.stamina.max||t.STATS.MAX_STAMINA,recovery:{delay:a.stats?.stamina.recovery.delay||t.STAMINA.RECOVER_DELAY,rate:a.stats?.stamina.recovery.rate||t.STAMINA.RECOVER_RATE},value:a.stats?.stamina.value||t.STATS.MAX_STAMINA},luck:a.stats?.luck||t.STATS.LUCK,size:a.stats?.size||t.STATS.SIZE,speed:a.stats?.speed||t.STATS.SPEED}}),a.leaderboard&&a.leaderboard.forEach(([t,e])=>{this.leaderboard.set(t,e)}),this.createLeaderboard();break;case"player-move":if(!this.inLobby&&this.players.has(e.userId)){const t=this.players.get(e.userId);t.transform.pos.x=a.transform.pos.x,t.transform.pos.y=a.transform.pos.y,t.transform.rot=a.transform.rot}break;case"player-hit":if(a.projectileId&&this.projectiles.delete(a.projectileId),a.targetId===this.userId)this.myPlayer.stats.health.value=a.newHealth,p("healthBar",this.myPlayer.stats.health.value,this.myPlayer.stats.health.max),this.myPlayer.stats.health.value<=0&&(this.recordDeath(),this.checkRoundEnd());else if(this.players.has(a.targetId)){const t=this.players.get(a.targetId);t.stats.health.value=a.newHealth,t.stats.health.value<=0&&(console.log(`Player ${t.id} died`),this.checkRoundEnd())}a.wasKill&&(this.leaderboard.has(a.shooterId)&&this.leaderboard.get(a.shooterId).kills++,this.leaderboard.has(a.targetId)&&this.leaderboard.get(a.targetId).deaths++,this.updateLeaderboardDisplay());break;case"player-death":e.userId!==this.userId&&a.ammoBox&&(this.ammoBoxes.set(a.ammoBox.id,a.ammoBox),console.log(`Ammo box spawned at death of ${e.userId}`)),a.gore&&Array.isArray(a.gore)&&(a.gore.forEach((t,s)=>{const a=`death_gore_${e.userId}_${Date.now()}_${s}`;this.stampGore(t),this.decals.set(a,{x:t.x,y:t.y,params:null})}),console.log(`Stamped ${a.gore.length} gore decals for ${e.userId}`));break;case"player-pause":this.pausedPlayers.add(a.userId),this.updatePauseState(),console.log(`${a.userId} paused the game`);break;case"player-unpause":this.pausedPlayers.delete(a.userId),this.updatePauseState(),console.log(`${a.userId} unpaused`);break;case"ammo-pickup":this.ammoBoxes.has(a.ammoBoxId)&&(this.ammoBoxes.delete(a.ammoBoxId),console.log(`Ammo box picked up by ${a.playerId}`));break;case"projectile-launch":this.inLobby||e.userId===this.userId||this.projectiles.set(a.projectile.id,a.projectile);break;case"projectile-remove":this.inLobby||this.projectiles.delete(a.projectileId);break;case"start-game":this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop();break;case"game-end":console.log(`Game ended! Winner: ${a.winnerId}`),this.gameWinner=a.winnerId;break;case"round-end":console.log(`Round ended! Winner: ${a.winnerId||"No one"}`),this.isRoundInProgress=!1,this.roundWinner=a.winnerId;break;case"new-round":if(console.log("New round started! Everyone respawning..."),this.isRoundInProgress=!0,this.roundWinner=null,this.myPlayer.stats.health.value=this.myPlayer.stats.health.max,p("healthBar",this.myPlayer.stats.health.value,this.myPlayer.stats.health.max),p("staminaBar",this.myPlayer.stats.stamina.value,this.myPlayer.stats.stamina.max),this.players.has(e.userId)){const t=this.players.get(e.userId);t.transform.pos.x=a.transform.pos.x,t.transform.pos.y=a.transform.pos.y,t.transform.rot=a.transform.rot,t.actions.dash.cooldown=a.actions.dash.cooldown,t.actions.dash.drain=a.actions.dash.drain,t.actions.dash.multiplier=a.actions.dash.multiplier,t.actions.dash.time=a.actions.dash.time,t.actions.primary.buffer=a.actions.primary.buffer,t.actions.primary.burst.amount=a.actions.primary.burst.amount,t.actions.primary.burst.delay=a.actions.primary.burst.delay,t.actions.primary.magazine.currentAmmo=a.actions.primary.magazine.currentAmmo,t.actions.primary.magazine.currentReserve=a.actions.primary.magazine.currentReserve,t.actions.primary.magazine.maxReserve=a.actions.primary.magazine.maxReserve,t.actions.primary.magazine.size=a.actions.primary.magazine.size,t.actions.primary.offset=a.actions.primary.offset,t.actions.primary.reload.time=a.actions.primary.reload.time,t.actions.sprint.drain=a.actions.sprint.drain,t.actions.sprint.multiplier=a.actions.sprint.multiplier,t.equipment.crosshair=a.equipment.crosshair,t.physics.acceleration=a.physics.acceleration,t.physics.friction=a.physics.friction,t.stats.health.max=a.stats.health.max,t.stats.health.value=a.stats.health.max,t.stats.stamina.max=a.stats.stamina.max,t.stats.stamina.recovery.delay=a.stats.stamina.recovery.delay,t.stats.stamina.recovery.rate=a.stats.stamina.recovery.rate,t.stats.stamina.value=a.stats.stamina.value,t.stats.luck=a.stats.luck,t.stats.size=a.stats.size,t.stats.speed=a.stats.speed}break;case"upgrade-taken":a.upgradeId&&a.isUnique&&(s=a.upgradeId,f.add(s),console.log(`Unique upgrade ${a.upgradeId} taken by ${e.userId}`));break;case"upgrade-complete":this.togglePause(),this.roundWinner===this.userId&&1===this.pausedPlayers.size&&this.showWinnerContinueButton(),0===this.pausedPlayers.size&&setTimeout(()=>{this.startNewRound()},500);break;case"add-decal":e.userId!==this.userId&&this.applyDecal(a.x,a.y,a.decalId,a.params);break;case"add-particles":e.userId!==this.userId&&this.applyParticles(a.x,a.y,a.particleId,a.particleData,a.color,a.collide,a.fade);break;case"particle-stamp":e.userId!==this.userId&&this.applyParticleStamp(a.x,a.y,a.stampId,a.color,a.opacity,a.size,a.rotation,a.torque);break;case"particle-emitter":e.userId!==this.userId&&this.emitters.set(a.emitterId,{playerId:a.playerId,offsetX:a.offsetX,offsetY:a.offsetY,direction:a.direction||0,lifetime:a.lifetime,age:0,lastEmission:0,emissionInterval:200+300*Math.random()});break;case"character-animation":a.playerId!==this.userId&&this.animateCharacterPart(a.playerId,a.part,a.frames,a.duration,a.partIndex)}}catch(t){console.error("Error parsing game message:",t)}}showRoomControls(){this.updateDisplay("room")}hostRoom(){if(this.ws){const t=this.roomManager.createRoom();this.isHost=!0,this.showLobbyControls(t)}else this.connectWebSocket(),setTimeout(()=>{const t=this.roomManager.createRoom();this.isHost=!0,this.showLobbyControls(t)},m)}joinRoom(){const t=prompt("Enter room code or link:");if(!t)return;let e=null;try{const s=new URL(t,window.location.origin);e=s.pathname.startsWith("/room_")?s.pathname.replace("/","").replace("/",""):new URLSearchParams(s.search).get("room")}catch{t.startsWith("room_")&&(e=t)}e?this.ws?this.roomManager.joinRoom(e):(this.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(e)},m)):alert("Invalid room code or link")}quickPlay(){fetch("/quickplay").then(t=>{if(!t.ok)throw new Error("No available rooms");return t.json()}).then(t=>{this.ws?this.roomManager.joinRoom(t.roomId):(this.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(t.roomId)},m))}).catch(t=>{alert("No available games found. Try hosting a new session!"),console.log("Quickplay error:",t)})}leaveRoom(){this.roomManager.leaveRoom(),this.gameRunning=!1,this.inLobby=!1,this.isHost=!1,this.players.clear(),this.projectiles.clear(),this.ammoBoxes.clear(),this.lobbyPlayers.clear(),this.clearChat(),this.clearLeaderboard(),this.showRoomControls(),this.resetPlayerConfig(),this.decals.clear(),this.decalCtx&&this.decalCtx.clearRect(0,0,n,l),this.ctx&&this.ctx.clearRect(0,0,n,l)}checkForRoomInURL(){const t=new URLSearchParams(window.location.search).get("room");t&&(this.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(t)},m))}copyRoomCode(){const t=this.inLobby?this.roomIdDisplay?.textContent:this.gameRoomIdDisplay?.textContent;t&&navigator.clipboard.writeText(t).then(()=>{alert("Room code copied!")}).catch(()=>{alert("Could not copy. Please copy manually.")})}showLobbyControls(t){this.updateDisplay("lobby",t),this.lobbyPlayers.set(this.userId,{id:this.userId,color:this.myPlayer.color,isHost:this.isHost}),this.setupLobbyOptions(),u("privateToggle",this.isPrivateRoom),u("upgradesToggle",this.isUpgradesEnabled),g("winsInput",this.gameMaxWins),this.updateLobbyPlayersList(),this.updateHostDisplay()}setupLobbyOptions(){this.privateToggle&&this.privateToggle.addEventListener("click",()=>{this.isHost&&(this.isPrivateRoom=!this.isPrivateRoom,u("privateToggle",this.isPrivateRoom),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",privateRoom:this.isPrivateRoom})),console.log("Room privacy changed to: "+(this.isPrivateRoom?"Private":"Public")))}),this.upgradesToggle&&this.upgradesToggle.addEventListener("click",()=>{this.isHost&&(this.isUpgradesEnabled=!this.isUpgradesEnabled,u("upgradesToggle",this.isUpgradesEnabled),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",upgradesEnabled:this.isUpgradesEnabled})))}),this.winsInput&&this.winsInput.addEventListener("change",()=>{if(!this.isHost)return;if(!this.winsInput)return;const t=parseInt(this.winsInput.value);isNaN(t)||t<1?this.winsInput.value=this.gameMaxWins.toString():(this.gameMaxWins=t,g("winsInput",this.gameMaxWins),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",maxWins:this.gameMaxWins})),console.log(`Game max wins changed to: ${this.gameMaxWins}`))}),this.playersInput&&this.playersInput.addEventListener("change",()=>{if(!this.isHost)return;if(!this.playersInput)return;const t=parseInt(this.playersInput.value);isNaN(t)||t<1?this.playersInput.value=this.gameMaxPlayers.toString():(this.gameMaxPlayers=t,g("playersInput",this.gameMaxPlayers),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",maxPlayers:this.gameMaxPlayers})),console.log(`Game max players changed to: ${this.gameMaxPlayers}`))})}syncLobbyOptions(t){void 0!==t.privateRoom&&(this.isPrivateRoom=t.privateRoom,u("privateToggle",this.isPrivateRoom),console.log("Lobby privacy synced to: "+(this.isPrivateRoom?"Private":"Public"))),void 0!==t.maxWins&&(this.gameMaxWins=t.maxWins,g("winsInput",this.gameMaxWins),console.log(`Game max wins synced to: ${this.gameMaxWins}`)),void 0!==t.maxPlayers&&(this.gameMaxPlayers=t.maxPlayers,g("playersInput",this.gameMaxPlayers),console.log(`Game max players synced to: ${this.gameMaxPlayers}`)),void 0!==t.upgradesEnabled&&(this.isUpgradesEnabled=t.upgradesEnabled,u("upgradesToggle",this.isUpgradesEnabled),console.log(`Game upgrades toggled: ${this.isUpgradesEnabled}`))}updateLobbyPlayersList(){this.lobbyPlayersList&&(this.lobbyPlayersList.innerHTML="",Array.from(this.lobbyPlayers.values()).sort((t,e)=>t.isHost&&!e.isHost?-1:!t.isHost&&e.isHost?1:0).forEach(t=>{const e=document.createElement("div");e.className="lobby_player";const s=document.createElement("div");s.className="player_color",s.style.backgroundColor=t.color;const a=document.createElement("div");a.className="player_name",a.textContent=`${t.id}${t.isHost?" (Host)":""}`;const i=document.createElement("div");if(i.className="player_controls",this.isHost&&t.id!==this.userId){const e=document.createElement("button");e.textContent="Promote",e.onclick=()=>this.promotePlayer(t.id);const s=document.createElement("button");s.textContent="Kick",s.className="danger",s.onclick=()=>this.kickPlayer(t.id),i.appendChild(e),i.appendChild(s)}e.appendChild(s),e.appendChild(a),e.appendChild(i),this.lobbyPlayersList&&this.lobbyPlayersList.appendChild(e)}))}promotePlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"promote-player",targetPlayerId:t}))}kickPlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"kick-player",targetPlayerId:t}))}returnToLobby(){this.gameRunning=!1,this.isRoundInProgress=!1,this.gameWinner=null,this.roundWinner=null,this.players.clear(),this.projectiles.clear(),this.ammoBoxes.clear(),this.leaderboard.clear(),this.decals.clear(),this.decalCtx&&this.decalCtx.clearRect(0,0,n,l),this.ctx&&this.ctx.clearRect(0,0,n,l),this.clearChat(),this.clearLeaderboard(),this.resetPlayerConfig(),R(),this.roomManager.sendMessage(JSON.stringify({type:"return-to-lobby",reason:"game-ended"})),this.showLobbyControls(this.roomManager.getCurrentRoom()||"")}checkRoundEnd(){if(!this.isRoundInProgress)return;let t=this.myPlayer.stats.health.value>0?1:0,e=this.myPlayer.stats.health.value>0?this.userId:null;this.players.forEach(s=>{s.stats.health.value>0&&(t++,e=s.id)}),t<=1&&this.endRound(e)}endRound(t){if(this.isRoundInProgress){if(this.isRoundInProgress=!1,this.roundWinner=t,t&&this.leaderboard.has(t)){const e=this.leaderboard.get(t);if(e.wins++,console.log(`${t} won the round! Total wins: ${e.wins}`),e.wins>=this.gameMaxWins)return void this.endGame(t);this.updateLeaderboardDisplay()}setTimeout(()=>{this.startUpgradePhase(t)},3e3)}}endGame(t){this.gameWinner=t,console.log(`${t} won the game with ${this.gameMaxWins} wins!`),this.resetPlayerConfig(),this.pausedPlayers.clear(),R(),this.roomManager.sendMessage(JSON.stringify({type:"game-end",winnerId:t})),setTimeout(()=>{this.returnToLobby()},5e3)}startNewRound(){console.log("Starting new round..."),this.myPlayer.stats.health.value=this.myPlayer.stats.health.max,this.myPlayer.transform.pos.x=770*Math.random()+h,this.myPlayer.transform.pos.y=570*Math.random()+h,this.isReloading=!1,this.isBurstActive=!1,this.currentBurstShot=0,p("healthBar",this.myPlayer.stats.health.value,this.myPlayer.stats.health.max),p("staminaBar",this.myPlayer.stats.stamina.value,this.myPlayer.stats.stamina.max),this.players.forEach(e=>{e.actions.dash.cooldown=e.actions.dash.cooldown||t.ACTIONS.DASH.COOLDOWN,e.actions.dash.drain=e.actions.dash.drain||t.ACTIONS.DASH.DRAIN,e.actions.dash.multiplier=e.actions.dash.multiplier||t.ACTIONS.DASH.MULTIPLIER,e.actions.dash.time=e.actions.dash.time||t.ACTIONS.DASH.TIME,e.actions.primary.buffer=e.actions.primary.buffer||t.ACTIONS.PRIMARY.BUFFER,e.actions.primary.burst.amount=e.actions.primary.burst.amount||t.ACTIONS.PRIMARY.BURST.AMOUNT,e.actions.primary.burst.delay=e.actions.primary.burst.delay||t.ACTIONS.PRIMARY.BURST.DELAY,e.actions.primary.magazine.currentAmmo=e.actions.primary.magazine.currentAmmo||t.ACTIONS.PRIMARY.MAGAZINE.SIZE,e.actions.primary.magazine.currentReserve=e.actions.primary.magazine.currentReserve||t.ACTIONS.PRIMARY.MAGAZINE.STARTING_RESERVE,e.actions.primary.magazine.maxReserve=e.actions.primary.magazine.maxReserve||t.ACTIONS.PRIMARY.MAGAZINE.MAX_RESERVE,e.actions.primary.magazine.size=e.actions.primary.magazine.size||t.ACTIONS.PRIMARY.MAGAZINE.SIZE,e.actions.primary.offset=e.actions.primary.offset||t.ACTIONS.PRIMARY.OFFSET,e.actions.primary.reload.time=e.actions.primary.reload.time||t.ACTIONS.PRIMARY.RELOAD.TIME,e.actions.sprint.drain=e.actions.sprint.drain||t.ACTIONS.SPRINT.DRAIN,e.actions.sprint.multiplier=e.actions.sprint.multiplier||t.ACTIONS.SPRINT.MULTIPLIER,e.equipment.crosshair=e.equipment.crosshair||t.EQUIPMENT.CROSSHAIR,e.physics.acceleration=e.physics.acceleration||t.PHYSICS.ACCELERATION,e.physics.friction=e.physics.friction||t.PHYSICS.FRICTION,e.stats.health.max=e.stats.health.max||t.STATS.MAX_HEALTH,e.stats.health.value=e.stats.health.max||t.STATS.MAX_HEALTH,e.stats.stamina.max=e.stats.stamina.max||t.STATS.MAX_STAMINA,e.stats.stamina.recovery.delay=e.stats.stamina.recovery.delay||t.STAMINA.RECOVER_DELAY,e.stats.stamina.recovery.rate=e.stats.stamina.recovery.rate||t.STAMINA.RECOVER_RATE,e.stats.stamina.value=e.stats.stamina.value||t.STATS.MAX_STAMINA,e.stats.luck=e.stats.luck||t.STATS.LUCK,e.stats.size=e.stats.size||t.STATS.SIZE,e.stats.speed=e.stats.speed||t.STATS.SPEED}),this.isRoundInProgress=!0,this.roundWinner=null,this.roomManager.sendMessage(JSON.stringify({type:"new-round",transform:{pos:{x:this.myPlayer.transform.pos.x,y:this.myPlayer.transform.pos.y},rot:this.myPlayer.transform.rot},actions:{dash:{cooldown:this.myPlayer.actions.dash.cooldown,drain:this.myPlayer.actions.dash.drain,multiplier:this.myPlayer.actions.dash.multiplier,time:this.myPlayer.actions.dash.time},primary:{buffer:this.myPlayer.actions.primary.buffer,burst:{amount:this.myPlayer.actions.primary.burst.amount,delay:this.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.myPlayer.actions.primary.magazine.maxReserve,size:this.myPlayer.actions.primary.magazine.size},offset:this.myPlayer.actions.primary.offset,reload:{time:this.myPlayer.actions.primary.reload.time}},sprint:{drain:this.myPlayer.actions.sprint.drain,multiplier:this.myPlayer.actions.sprint.multiplier}},equipment:{crosshair:this.myPlayer.equipment.crosshair},physics:{acceleration:this.myPlayer.physics.acceleration,friction:this.myPlayer.physics.friction},stats:{health:{max:this.myPlayer.stats.health.max,value:this.myPlayer.stats.health.value},stamina:{max:this.myPlayer.stats.stamina.max,recovery:{delay:this.myPlayer.stats.stamina.recovery.delay,rate:this.myPlayer.stats.stamina.recovery.rate},value:this.myPlayer.stats.stamina.value},luck:this.myPlayer.stats.luck,size:this.myPlayer.stats.size,speed:this.myPlayer.stats.speed}}))}sendChatMessage(){if(!this.chatInput||!this.chatInput.value.trim())return;const t=this.chatInput.value.trim();t.length>200?alert("Message too long! Max 200 characters."):(this.roomManager.sendMessage(JSON.stringify({type:"chat-message",message:t,timestamp:Date.now()})),this.displayChatMessage(this.userId,t,!0),this.chatInput.value="")}displayChatMessage(t,e,s=!1){if(!this.chatMessages)return;const a=document.createElement("div");a.className="chat_message "+(s?"own":"other");const i=document.createElement("span");i.className="sender",i.textContent=s?"You:":`${t}:`;const r=document.createElement("span");for(r.className="content",r.textContent=e,a.appendChild(i),a.appendChild(r),this.chatMessages.appendChild(a),this.chatMessages.scrollTop=this.chatMessages.scrollHeight;this.chatMessages.children.length>100;)this.chatMessages.removeChild(this.chatMessages.firstChild)}clearChat(){this.chatMessages&&(this.chatMessages.innerHTML=""),this.chatInput&&(this.chatInput.value="")}setupEventListeners(){document.getElementById("hostBtn")?.addEventListener("click",()=>this.hostRoom()),document.getElementById("joinBtn")?.addEventListener("click",()=>this.joinRoom()),document.getElementById("quickBtn")?.addEventListener("click",()=>this.quickPlay()),document.getElementById("lobbyLeaveBtn")?.addEventListener("click",()=>this.leaveRoom()),document.getElementById("lobbyCodeBtn")?.addEventListener("click",()=>this.copyRoomCode()),document.getElementById("gameLeaveBtn")?.addEventListener("click",()=>this.leaveRoom()),document.getElementById("gameCodeBtn")?.addEventListener("click",()=>this.copyRoomCode()),this.startGameBtn?.addEventListener("click",()=>this.startGame()),this.chatSendBtn?.addEventListener("click",()=>this.sendChatMessage()),this.chatInput?.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendChatMessage())}),this.chatInput?.addEventListener("focus",()=>{this.keys.clear(),this.canShoot=!1,this.isSprinting=!1,this.isDashing=!1,this.isBurstActive=!1,this.currentBurstShot=0}),this.chatInput?.addEventListener("blur",()=>{this.keys.clear(),this.canShoot=!0,this.isSprinting=!1,this.isDashing=!1}),document.addEventListener("keydown",t=>this.onKeyDown(t)),document.addEventListener("keyup",t=>this.onKeyUp(t)),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.gameRunning&&!this.inLobby&&(t.preventDefault(),this.myPlayer.stats.size*=10,console.log(this.myPlayer.stats.size))}),this.canvas?.addEventListener("mousedown",t=>this.onMouseDown(t)),this.canvas?.addEventListener("mouseup",t=>this.onMouseUp(t)),this.canvas?.addEventListener("mousemove",t=>this.onMouseMove(t)),this.roomManager.onMessage(t=>this.handleRoomMessage(t))}onKeyDown(t){if(this.chatInput===document.activeElement)return;if(!this.gameRunning||this.gamePaused)return;const e=t.key.toLowerCase(),s=c;Object.values(s).includes(e)&&(t.preventDefault(),this.keys.add(e),e===s.RELOAD&&!this.isReloading&&this.myPlayer.actions.primary.magazine.currentAmmo<this.myPlayer.actions.primary.magazine.size&&this.myPlayer.actions.primary.magazine.currentReserve>0&&this.startReload(),e===s.SPRINT&&(this.isSprinting=!0),e!==s.DASH||this.isDashing||this.startDash())}onKeyUp(t){if(this.chatInput===document.activeElement)return;if(!this.gameRunning)return;const e=t.key.toLowerCase(),s=c;Object.values(s).includes(e)&&(t.preventDefault(),this.keys.delete(e),e===s.SPRINT&&(this.isSprinting=!1))}onMouseDown(t){this.chatInput!==document.activeElement&&this.gameRunning&&!this.gamePaused&&this.canvas&&0===t.button&&this.canShoot&&!this.isBurstActive&&(this.updateMousePosition(t),this.startBurst(),this.canShoot=!1)}onMouseUp(t){this.chatInput!==document.activeElement&&this.gameRunning&&0===t.button&&(this.canShoot=!0)}onMouseMove(t){if(this.chatInput===document.activeElement)return;if(!this.gameRunning||this.gamePaused)return;this.updateMousePosition(t);const e=this.mouseX-this.myPlayer.transform.pos.x,s=this.mouseY-this.myPlayer.transform.pos.y,a=Math.atan2(s,e)+Math.PI/2;this.rotateCharacterPart(this.userId,a),Math.abs(a-this.lastSentRotation)>.1&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.myPlayer.transform.pos.x,y:this.myPlayer.transform.pos.y},rot:this.myPlayer.transform.rot}})),this.lastSentRotation=a),this.crosshair&&this.myPlayer.equipment.crosshair&&(this.crosshair.style.left=`${t.clientX}px`,this.crosshair.style.top=`${t.clientY}px`)}updateMousePosition(t){if(this.chatInput===document.activeElement)return;if(!this.canvas)return;const e=this.canvas.getBoundingClientRect();this.mouseX=t.clientX-e.left,this.mouseY=t.clientY-e.top}updateAttack(){if(!this.gameRunning||this.myPlayer.stats.health.value<=0)return;const t=Date.now();if(this.isReloading){if(t>=this.reloadStartTime+this.myPlayer.actions.primary.reload.time){const t=this.myPlayer.actions.primary.magazine.size-this.myPlayer.actions.primary.magazine.currentAmmo,e=Math.min(t,this.myPlayer.actions.primary.magazine.currentReserve);this.myPlayer.actions.primary.magazine.currentAmmo+=e,this.myPlayer.actions.primary.magazine.currentReserve-=e,this.isReloading=!1,this.animateCharacterPart(this.userId,"WEAPON",{0:{x:0,y:20},1:{x:0,y:0}},175,1),console.log(`Reload complete! Magazine: ${this.myPlayer.actions.primary.magazine.currentAmmo}/${this.myPlayer.actions.primary.magazine.size}, Inventory: ${this.myPlayer.actions.primary.magazine.currentReserve}/${this.myPlayer.actions.primary.magazine.maxReserve}`)}}else if(this.isBurstActive&&t>=this.nextBurstShotTime){const e=this.myPlayer.actions.primary.burst.amount;this.myPlayer.actions.primary.magazine.currentAmmo>0&&this.currentBurstShot<e?(this.launchProjectile(),this.currentBurstShot++,this.myPlayer.actions.primary.magazine.currentAmmo--,console.log(`Burst shot ${this.currentBurstShot}! Magazine: ${this.myPlayer.actions.primary.magazine.currentAmmo}/${this.myPlayer.actions.primary.magazine.size}, Inventory: ${this.myPlayer.actions.primary.magazine.currentReserve}/${this.myPlayer.actions.primary.magazine.maxReserve}`),this.currentBurstShot>=e||0===this.myPlayer.actions.primary.magazine.currentAmmo?(this.isBurstActive=!1,this.currentBurstShot=0):this.nextBurstShotTime=t+this.myPlayer.actions.primary.burst.delay):(this.isBurstActive=!1,this.currentBurstShot=0)}}startBurst(){if(this.isBurstActive||this.myPlayer.stats.health.value<=0||this.isReloading)return;const t=Date.now();if(t<this.lastShotTime+this.myPlayer.actions.primary.buffer)return;this.lastShotTime=t;const e=this.myPlayer.actions.primary.burst.amount,s=Math.min(e,this.myPlayer.actions.primary.magazine.currentAmmo);if(0===s)return console.log("Out of ammo! Magazine empty."),void this.animateCharacterPart(this.userId,"WEAPON",{0:{x:0,y:8}},0,1);this.isBurstActive=!0,this.currentBurstShot=0,this.launchProjectile(),this.currentBurstShot++,this.myPlayer.actions.primary.magazine.currentAmmo--,this.myPlayer.actions.primary.burst.amount>1&&this.myPlayer.actions.primary.magazine.currentAmmo>0&&this.currentBurstShot<s?this.nextBurstShotTime=Date.now()+this.myPlayer.actions.primary.burst.delay:(this.isBurstActive=!1,this.currentBurstShot=0,0===this.myPlayer.actions.primary.magazine.currentAmmo&&this.animateCharacterPart(this.userId,"WEAPON",{0:{x:0,y:8}},0,1)),console.log(`Fired shot! Magazine: ${this.myPlayer.actions.primary.magazine.currentAmmo}/${this.myPlayer.actions.primary.magazine.size}, Inventory: ${this.myPlayer.actions.primary.magazine.currentReserve}/${this.myPlayer.actions.primary.magazine.maxReserve}`)}launchProjectile(){const e=this.mouseX-this.myPlayer.transform.pos.x,s=this.mouseY-this.myPlayer.transform.pos.y,a=Math.sqrt(e*e+s*s);if(0===a)return;const i=e/a,n=s/a;this.animateCharacterPart(this.userId,"WEAPON",{0:{x:0,y:0},.5:{x:0,y:20},1:{x:0,y:0}},175,1);const l=this.myPlayer.stats.size/4+t.PROJECTILE.SIZE+this.myPlayer.actions.primary.offset,h=this.myPlayer.transform.pos.x+i*l,m=this.myPlayer.transform.pos.y+n*l,c=-n,d=i;this.createParticles(h,m,`muzzle_${Date.now()}`,r,{x:i,y:n}),this.createParticles(h-5,m-5,`shell_${Date.now()}`,o,{x:.8*c+-.2*i,y:.8*d+-.2*n});for(let e=0;e<t.PROJECTILE.AMOUNT;e++){const e=(Math.random()-.5)*t.PROJECTILE.SPREAD,s=Math.atan2(n,i)+e,a={id:y(),x:this.myPlayer.transform.pos.x+Math.cos(s)*l,y:this.myPlayer.transform.pos.y+Math.sin(s)*l,velocityX:Math.cos(s)*t.PROJECTILE.SPEED,velocityY:Math.sin(s)*t.PROJECTILE.SPEED,range:100*t.PROJECTILE.RANGE,distanceTraveled:0,ownerId:this.userId,timestamp:Date.now()};this.projectiles.set(a.id,a),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:a}))}}updateProjectiles(){const a=[];this.projectiles.forEach((r,o)=>{r.x+=r.velocityX,r.y+=r.velocityY;const h=Math.sqrt(r.velocityX*r.velocityX+r.velocityY*r.velocityY);if(r.distanceTraveled+=h,this.myPlayer.stats.health.value>0){const e=r.x-this.myPlayer.transform.pos.x,n=r.y-this.myPlayer.transform.pos.y;if(Math.sqrt(e*e+n*n)<=this.myPlayer.stats.size/4+t.PROJECTILE.SIZE){this.myPlayer.stats.health.value-=t.PROJECTILE.DAMAGE,p("healthBar",this.myPlayer.stats.health.value,this.myPlayer.stats.health.max),a.push(o),this.createDecal(r.x,r.y,`blood_${o}`,s);const e={x:-r.velocityX/Math.sqrt(r.velocityX**2+r.velocityY**2),y:-r.velocityY/Math.sqrt(r.velocityX**2+r.velocityY**2)};this.createParticles(r.x,r.y,`blood_${o}`,i,e),this.createEmitter(this.userId,r.x,r.y),this.roomManager.sendMessage(JSON.stringify({type:"player-hit",targetId:this.userId,shooterId:r.ownerId,damage:t.PROJECTILE.DAMAGE,newHealth:this.myPlayer.stats.health.value,projectileId:o})),this.myPlayer.stats.health.value<=0&&(this.recordDeath(),this.checkRoundEnd())}}r.ownerId===this.userId&&this.players.forEach((e,n)=>{if(e.stats.health.value>0){const l=r.x-e.transform.pos.x,h=r.y-e.transform.pos.y;if(Math.sqrt(l*l+h*h)<=e.stats.size/4+t.PROJECTILE.SIZE){a.push(o);const l=Math.max(0,e.stats.health.value-t.PROJECTILE.DAMAGE);e.stats.health.value=l,this.createDecal(r.x,r.y,`blood_${o}`,s);const h={x:-r.velocityX/Math.sqrt(r.velocityX**2+r.velocityY**2),y:-r.velocityY/Math.sqrt(r.velocityX**2+r.velocityY**2)};this.createParticles(r.x,r.y,`blood_${o}`,i,h),this.createEmitter(n,r.x,r.y),l<=0&&(console.log(`I killed ${n}!`),this.leaderboard.has(this.userId)&&this.leaderboard.get(this.userId).kills++,this.leaderboard.has(n)&&this.leaderboard.get(n).deaths++,this.updateLeaderboardDisplay()),this.roomManager.sendMessage(JSON.stringify({type:"player-hit",targetId:n,shooterId:this.userId,damage:t.PROJECTILE.DAMAGE,newHealth:l,projectileId:o,wasKill:l<=0})),l<=0&&this.checkRoundEnd()}}}),(r.distanceTraveled>=r.range||r.x<0||r.x>n||r.y<0||r.y>l)&&(a.push(o),r.ownerId===this.userId&&(r.distanceTraveled>=r.range&&this.createDecal(r.x,r.y,`impact_${o}`,e),this.roomManager.sendMessage(JSON.stringify({type:"projectile-remove",projectileId:o}))))}),a.forEach(t=>{this.projectiles.delete(t)})}startReload(){this.isReloading||this.myPlayer.actions.primary.magazine.currentAmmo>=this.myPlayer.actions.primary.magazine.size||this.myPlayer.actions.primary.magazine.currentReserve<=0||(console.log(`Starting reload - Current ammo: ${this.myPlayer.actions.primary.magazine.currentAmmo}, Inventory: ${this.myPlayer.actions.primary.magazine.currentReserve}`),this.isReloading=!0,this.reloadStartTime=Date.now(),this.isBurstActive=!1,this.currentBurstShot=0,this.animateCharacterPart(this.userId,"WEAPON",{0:{x:0,y:8}},0,1))}updatePlayerPosition(){if(!this.gameRunning||this.myPlayer.stats.health.value<=0)return;if(this.updateStamina(),this.updateDash(),this.checkCollisions(),this.isDashing){let t=this.myPlayer.transform.pos.x+this.playerVelocityX,e=this.myPlayer.transform.pos.y+this.playerVelocityY,s=!1;t>=h&&t<=785?(this.myPlayer.transform.pos.x=t,s=!0):(this.isDashing=!1,this.playerVelocityX=0),e>=h&&e<=585?(this.myPlayer.transform.pos.y=e,s=!0):(this.isDashing=!1,this.playerVelocityY=0);const a=Math.sqrt((this.myPlayer.transform.pos.x-this.lastSentX)**2+(this.myPlayer.transform.pos.y-this.lastSentY)**2);return void(s&&a>2&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.myPlayer.transform.pos.x,y:this.myPlayer.transform.pos.y},rot:this.myPlayer.transform.rot}})),this.lastSentX=this.myPlayer.transform.pos.x,this.lastSentY=this.myPlayer.transform.pos.y,this.lastSentRotation=this.myPlayer.transform.rot||0))}const t=c;let e=0,s=0;this.keys.has(t.MOVE_UP)&&(s-=1),this.keys.has(t.MOVE_DOWN)&&(s+=1),this.keys.has(t.MOVE_LEFT)&&(e-=1),this.keys.has(t.MOVE_RIGHT)&&(e+=1);const a=Math.sqrt(e*e+s*s);a>0&&(e/=a,s/=a);const i=this.isSprinting&&this.myPlayer.stats.stamina.value>0?this.myPlayer.stats.speed*this.myPlayer.actions.sprint.multiplier:this.myPlayer.stats.speed;this.isSprinting&&this.myPlayer.stats.stamina.value<=0&&(this.isSprinting=!1,console.log("Out of stamina, stopped sprinting"));const r=e*i,o=s*i;this.playerVelocityX+=(r-this.playerVelocityX)*this.myPlayer.physics.acceleration,this.playerVelocityY+=(o-this.playerVelocityY)*this.myPlayer.physics.acceleration,0===a&&(this.playerVelocityX*=this.myPlayer.physics.friction,this.playerVelocityY*=this.myPlayer.physics.friction);let n=this.myPlayer.transform.pos.x+this.playerVelocityX,l=this.myPlayer.transform.pos.y+this.playerVelocityY,m=!1;n>=h&&n<=785?(this.myPlayer.transform.pos.x=n,m=!0):this.playerVelocityX=0,l>=h&&l<=585?(this.myPlayer.transform.pos.y=l,m=!0):this.playerVelocityY=0;const y=Math.sqrt((this.myPlayer.transform.pos.x-this.lastSentX)**2+(this.myPlayer.transform.pos.y-this.lastSentY)**2);m&&y>2&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.myPlayer.transform.pos.x,y:this.myPlayer.transform.pos.y},rot:this.myPlayer.transform.rot}})),this.lastSentX=this.myPlayer.transform.pos.x,this.lastSentY=this.myPlayer.transform.pos.y,this.lastSentRotation=this.myPlayer.transform.rot||0),Math.abs(this.playerVelocityX)<.01&&(this.playerVelocityX=0),Math.abs(this.playerVelocityY)<.01&&(this.playerVelocityY=0)}rotateCharacterPart(t,e){t===this.userId?this.myPlayer.transform.rot=e:this.players.has(t)&&(this.players.get(t).transform.rot=e)}recordDeath(){console.log("I died! Waiting for round to end...");const t=this.spawnAmmoBox(10);this.ammoBoxes.set(t.id,t);const e=this.spawnGore(this.myPlayer.transform.pos.x,this.myPlayer.transform.pos.y);e.forEach((t,e)=>{const s=`death_gore_${this.userId}_${Date.now()}_${e}`;this.stampGore(t),this.decals.set(s,{x:t.x,y:t.y,params:null})}),this.roomManager.sendMessage(JSON.stringify({type:"player-death",playerId:this.userId,ammoBox:t,gore:e}))}resetPlayerConfig(){Object.assign(t,JSON.parse(JSON.stringify(this.defaultPlayerConfig))),this.crosshair&&this.toggleCrosshair(),console.log("Player config reset to defaults")}requestStamina(t){return this.myPlayer.stats.stamina.value<t?(console.log(`Insufficient stamina! Need: ${t}, Have: ${this.myPlayer.stats.stamina}`),!1):(this.myPlayer.stats.stamina.value-=t,this.isStaminaRecoveryBlocked=!0,this.staminaRecoveryBlockedUntil=Date.now()+this.myPlayer.stats.stamina.recovery.delay,console.log(`Stamina drained: -${t}, Remaining: ${this.myPlayer.stats.stamina}`),!0)}updateStamina(){const t=Date.now();if(this.isSprinting&&t>=this.lastStaminaDrainTime+100&&(this.requestStamina(this.myPlayer.actions.sprint.drain)||(this.isSprinting=!1,console.log("Out of stamina, stopped sprinting")),this.lastStaminaDrainTime=t),(!this.isStaminaRecoveryBlocked||t>=this.staminaRecoveryBlockedUntil)&&(this.isStaminaRecoveryBlocked=!1,this.myPlayer.stats.stamina.value<this.myPlayer.stats.stamina.max&&!this.isSprinting)){const t=this.myPlayer.stats.stamina.recovery.rate/1e3*16;this.myPlayer.stats.stamina.value=Math.min(this.myPlayer.stats.stamina.max,this.myPlayer.stats.stamina.value+t)}}checkCollisions(){const t=this.myPlayer.stats.size/4+15;this.ammoBoxes.forEach((e,s)=>{const a=this.myPlayer.transform.pos.x-e.x,i=this.myPlayer.transform.pos.y-e.y;Math.sqrt(a*a+i*i)<=t&&(this.myPlayer.actions.primary.magazine.currentReserve=Math.min(this.myPlayer.actions.primary.magazine.maxReserve,this.myPlayer.actions.primary.magazine.currentReserve+e.ammoAmount),console.log(`Picked up ammo box! +${e.ammoAmount} bullets. Inventory: ${this.myPlayer.actions.primary.magazine.currentReserve}/${this.myPlayer.actions.primary.magazine.maxReserve}`),this.ammoBoxes.delete(s),this.roomManager.sendMessage(JSON.stringify({type:"ammo-pickup",ammoBoxId:s,playerId:this.userId})))})}spawnGore(t,e){const s=[],a=2+Math.floor(4*Math.random()),i=[...T.GORE];for(let r=0;r<a&&i.length>0;r++){const a=Math.floor(Math.random()*i.length),r=i.splice(a,1)[0],o=Math.random()*Math.PI*2,n=Math.random()*this.myPlayer.stats.size;s.push({type:"gore",assetPath:r,x:t+Math.cos(o)*n,y:e+Math.sin(o)*n,rotation:Math.random()*Math.PI*2,scale:.65+.4*Math.random()})}const r=1+Math.floor(2*Math.random()),o=[...T.BLOOD];for(let a=0;a<r&&o.length>0;a++){const a=Math.floor(Math.random()*o.length),i=o.splice(a,1)[0],r=Math.random()*Math.PI*2,n=Math.random()*(.7*this.myPlayer.stats.size);s.push({type:"blood",assetPath:i,x:t+Math.cos(r)*n,y:e+Math.sin(r)*n,rotation:Math.random()*Math.PI*2,scale:1.25+.2*Math.random()})}return s}stampGore(t){if(!this.decalCtx)return;let e=this.characterImages.get(t.assetPath);if(!e&&(e=new Image,e.src=t.assetPath,this.characterImages.set(t.assetPath,e),!e.complete))return void(e.onload=()=>{this.stampGore(t)});if(!e.complete||0===e.naturalWidth)return;this.decalCtx.save(),this.decalCtx.translate(t.x,t.y),this.decalCtx.rotate(t.rotation);const s=32*t.scale;this.decalCtx.drawImage(e,-s/2,-s/2,s,s),this.decalCtx.restore()}startDash(){if(this.isDashing||this.myPlayer.stats.health.value<=0)return;console.log("Starting dash...");const t=Date.now();if(t<this.lastDashTime+this.myPlayer.actions.dash.cooldown)return void console.log("Dash on cooldown");if(!this.requestStamina(this.myPlayer.actions.dash.drain))return void console.log("Not enough stamina to dash");const e=c;let s=0,a=0;this.keys.has(e.MOVE_UP)&&(a-=1),this.keys.has(e.MOVE_DOWN)&&(a+=1),this.keys.has(e.MOVE_LEFT)&&(s-=1),this.keys.has(e.MOVE_RIGHT)&&(s+=1);const i=Math.sqrt(s*s+a*a);if(0===i)return void console.log("No movement input for dash");s/=i,a/=i,this.isDashing=!0,this.dashStartTime=t,this.lastDashTime=t;const r=this.myPlayer.stats.speed*this.myPlayer.actions.dash.multiplier;this.playerVelocityX=s*r,this.playerVelocityY=a*r,console.log(`Dashing! Speed: ${r}`)}updateDash(){this.isDashing&&Date.now()>=this.dashStartTime+this.myPlayer.actions.dash.time&&(this.isDashing=!1,console.log("Dash ended"))}showGameControls(t){this.updateDisplay("game",t)}startGame(){this.isHost&&(this.roomManager.sendMessage(JSON.stringify({type:"start-game"})),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop())}startGameLoop(){this.gameRunning=!0,this.isRoundInProgress=!0,this.myPlayer.actions.primary.magazine.currentReserve=Math.floor(t.ACTIONS.PRIMARY.MAGAZINE.MAX_RESERVE/2),this.myPlayer.actions.primary.magazine.currentAmmo=this.myPlayer.actions.primary.magazine.size,this.isReloading=!1,this.createLeaderboard(),this.resetPlayerConfig(),R(),this.roomManager.sendMessage(JSON.stringify({type:"player-state",id:this.myPlayer.id,transform:{pos:{x:this.myPlayer.transform.pos.x,y:this.myPlayer.transform.pos.y},rot:this.myPlayer.transform.rot},color:this.myPlayer.color,actions:{dash:{cooldown:this.myPlayer.actions.dash.cooldown,drain:this.myPlayer.actions.dash.drain,multiplier:this.myPlayer.actions.dash.multiplier,time:this.myPlayer.actions.dash.time},primary:{buffer:this.myPlayer.actions.primary.buffer,burst:{amount:this.myPlayer.actions.primary.burst.amount,delay:this.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.myPlayer.actions.primary.magazine.maxReserve,size:this.myPlayer.actions.primary.magazine.size},offset:this.myPlayer.actions.primary.offset,reload:{time:this.myPlayer.actions.primary.reload.time}},sprint:{drain:this.myPlayer.actions.sprint.drain,multiplier:this.myPlayer.actions.sprint.multiplier}},equipment:{crosshair:this.myPlayer.equipment.crosshair},physics:{acceleration:this.myPlayer.physics.acceleration,friction:this.myPlayer.physics.friction},stats:{health:{max:this.myPlayer.stats.health.max,value:this.myPlayer.stats.health.value},stamina:{max:this.myPlayer.stats.stamina.max,recovery:{delay:this.myPlayer.stats.stamina.recovery.delay,rate:this.myPlayer.stats.stamina.recovery.rate},value:this.myPlayer.stats.stamina.value},luck:this.myPlayer.stats.luck,size:this.myPlayer.stats.size,speed:this.myPlayer.stats.speed}})),this.gameLoop(),p("healthBar",this.myPlayer.stats.health.value,this.myPlayer.stats.health.max),p("staminaBar",this.myPlayer.stats.stamina.value,this.myPlayer.stats.stamina.max)}gameLoop(){this.gameRunning&&this.ctx&&this.canvas&&this.decalCtx&&this.decalCanvas&&(this.gamePaused||(this.updatePlayerPosition(),this.updateAttack(),this.updateProjectiles(),this.updateParticles(),this.updateEmitters(),this.updateCharacterAnimations(),p("staminaBar",this.myPlayer.stats.stamina.value,this.myPlayer.stats.stamina.max),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.decalCanvas&&this.ctx.drawImage(this.decalCanvas,0,0),this.ctx.strokeStyle="#333",this.ctx.lineWidth=2,this.ctx.strokeRect(0,0,this.canvas.width,this.canvas.height),this.drawAmmoBoxes(),this.projectiles.forEach(t=>{this.drawProjectile(t)}),this.players.forEach(t=>{this.drawCharacter(t)}),this.drawCharacter(this.myPlayer,!0),this.drawParticles()),requestAnimationFrame(()=>this.gameLoop()))}pauseGame(){this.gameRunning&&(this.gamePaused=!0,console.log("Game paused"),this.keys.clear(),this.isSprinting=!1,this.isDashing=!1,this.isBurstActive=!1,this.currentBurstShot=0)}resumeGame(){this.gameRunning&&(this.gamePaused=!1,console.log("Game resumed"))}togglePause(){this.gameRunning&&(this.pausedPlayers.has(this.userId)?(this.pausedPlayers.delete(this.userId),this.roomManager.sendMessage(JSON.stringify({type:"player-unpause",userId:this.userId})),console.log("Requesting unpause...")):(this.pausedPlayers.add(this.userId),this.roomManager.sendMessage(JSON.stringify({type:"player-pause",userId:this.userId})),console.log("Requesting pause...")),this.updatePauseState())}updatePauseState(){const t=this.pausedPlayers.size>0;t&&!this.gamePaused?(this.pauseGame(),console.log(`Game paused. ${this.pausedPlayers.size} player(s) paused.`)):!t&&this.gamePaused&&(this.resumeGame(),console.log("Game resumed. All players unpaused."))}startUpgradePhase(t){console.log("Starting upgrade phase..."),this.togglePause(),t===this.userId?this.showWinnerWaitScreen():this.showUpgradeSelection()}showWinnerWaitScreen(){if(!this.upgradeContainer)return;this.upgradeContainer.innerHTML="";const t=document.createElement("div");t.className="upgrade_waiting",t.textContent="Waiting for other players...",this.upgradeContainer.appendChild(t),this.upgradeContainer.style.display="flex"}showWinnerContinueButton(){if(!this.upgradeContainer)return;this.upgradeContainer.innerHTML="";const t=document.createElement("div");t.className="upgrade_waiting",t.textContent="Upgrade phase complete.";const e=document.createElement("button");e.textContent="Continue",e.onclick=()=>{this.upgradeContainer&&(console.log("Winner pressed continue..."),this.upgradeContainer.style.display="none",this.roomManager.sendMessage(JSON.stringify({type:"upgrade-complete",userId:this.userId})))},this.upgradeContainer.appendChild(t),this.upgradeContainer.appendChild(e),this.upgradeContainer.style.display="flex"}showUpgradeSelection(){this.upgradeContainer&&(this.upgradeContainer.innerHTML="",function(){const t=S.filter(t=>!(t.unique&&f.has(t.id)||t.type===E.EQUIPMENT&&P.has(t.id))),e=[];for(let s=0;s<Math.min(3,t.length)&&0!==t.length;s++){const s=t.reduce((t,e)=>t+A[e.rarity].weight,0);let a=Math.random()*s,i=null;for(const e of t)if(a-=A[e.rarity].weight,a<=0){i=e;break}if(i){e.push(i);const s=t.indexOf(i);t.splice(s,1)}}return e}().forEach(t=>{const e=document.createElement("div");e.className="upgrade_card",e.setAttribute("data-rarity",t.rarity.toString());const s=document.createElement("div");s.className="upgrade_name",s.textContent=t.name;const a=document.createElement("div");a.className="upgrade_subtitle",a.textContent=t.subtitle,e.appendChild(s),e.appendChild(a),e.addEventListener("click",()=>{console.log("Selected upgrade: ",t.name),this.selectUpgrade(t.id)}),this.upgradeContainer&&this.upgradeContainer.appendChild(e)}),this.upgradeContainer.style.display="flex")}selectUpgrade(t){const e=function(t){const e=S.find(e=>e.id===t);return!(!e||e.unique&&f.has(t)||e.type===E.EQUIPMENT&&P.has(t)||(e.type===E.EQUIPMENT&&P.add(t),e.unique&&f.add(t),e.func(),0))}(t);if(!e)return void console.error("Failed to apply upgrade");"neural_target_interface"===t&&this.toggleCrosshair(),this.roomManager.sendMessage(JSON.stringify({type:"upgrade-taken",upgradeId:t,userId:this.userId,isUnique:S.find(e=>e.id===t)?.unique||!1}));const s=document.getElementById("upgradeContainer");s&&(s.style.display="none"),this.roomManager.sendMessage(JSON.stringify({type:"upgrade-complete",userId:this.userId})),console.log("Upgrade selected, waiting for others...")}toggleCrosshair(){this.crosshair&&(this.myPlayer.equipment.crosshair?(this.crosshair.style.display="block",console.log("Crosshair enabled")):(this.crosshair.style.display="none",console.log("Crosshair disabled")))}spawnAmmoBox(t){return{id:y(),x:this.myPlayer.transform.pos.x,y:this.myPlayer.transform.pos.y,ammoAmount:t,timestamp:Date.now()}}createLeaderboard(){console.log("Creating/updating leaderboard for all players");const t=new Set;t.add(this.userId),this.players.forEach((e,s)=>{t.add(s)}),this.lobbyPlayers.forEach((e,s)=>{t.add(s)}),t.forEach(t=>{this.leaderboard.has(t)||(this.leaderboard.set(t,{playerId:t,wins:0,kills:0,deaths:0}),console.log(`Created leaderboard entry for ${t}`))}),this.updateLeaderboardDisplay(),console.log("Leaderboard created/updated:",Array.from(this.leaderboard.entries()))}updateLeaderboardDisplay(){this.leaderboardBody&&(this.leaderboardBody.innerHTML="",Array.from(this.leaderboard.entries()).sort((t,e)=>{const[,s]=t,[,a]=e;return a.wins!==s.wins?a.wins-s.wins:a.kills-s.kills}).forEach(([t,e])=>{const s=document.createElement("tr");s.className="leaderboard_row",t===this.userId&&s.classList.add("current-player");const a=document.createElement("td");a.textContent=t===this.userId?"You":t.substring(0,8),a.className="player_name",s.appendChild(a);const i=document.createElement("td");i.textContent=e.wins.toString(),i.className="wins",s.appendChild(i);const r=document.createElement("td");r.textContent=e.kills.toString(),r.className="kills",s.appendChild(r);const o=document.createElement("td");o.textContent=e.deaths.toString(),o.className="deaths",s.appendChild(o),this.leaderboardBody&&this.leaderboardBody.appendChild(s)}))}clearLeaderboard(){this.leaderboard.clear(),this.leaderboardBody&&(this.leaderboardBody.innerHTML="")}drawCharacter(e,s=!1){if(!this.ctx)return;if(e.stats.health.value<=0)return;const a=O;this.drawCharacterLayer(e,"BODY",a.body),this.drawCharacterLayer(e,"WEAPON",a.weapon),this.drawCharacterLayer(e,"HEAD",a.head),this.drawCharacterLayer(e,"HEADWEAR",a.headwear),this.ctx.fillStyle="#fff",this.ctx.font="12px Arial",this.ctx.textAlign="center";const i=s?"You":e.id.substring(0,6);this.ctx.fillText(i,e.transform.pos.x,e.transform.pos.y-t.VISUAL.ID_DISPLAY_OFFSET)}drawCharacterLayer(t,e,s){if(!this.ctx)return;const a=function(t,e){switch(t){case"BODY":return b[e]||b.DEFAULT;case"WEAPON":return C[e]||C.GLOCK;case"HEAD":return x[e]||x.DEFAULT;case"HEADWEAR":return v[e]||v.DEFAULT;default:throw new Error(`Unknown character layer: ${t}`)}}(e,s);"string"==typeof a?this.drawCharacterPart(t,a,e):Array.isArray(a)&&a.forEach((s,a)=>{this.drawCharacterPart(t,s,e,a)})}drawCharacterPart(t,e,s,a){if(!this.ctx)return;let i=this.characterImages.get(e);if(!i&&(i=new Image,i.src=e,this.characterImages.set(e,i),!i.complete))return;if(!i.complete||0===i.naturalWidth)return;const r=t.stats.size/650*650,o=`${t.id}_${s}_${a||0}`,n=this.characterOffsets?.get(o)||{x:0,y:0};this.ctx.save(),void 0!==t.transform.rot?(this.ctx.translate(t.transform.pos.x,t.transform.pos.y),this.ctx.rotate(t.transform.rot),this.ctx.translate(n.x,n.y),this.ctx.drawImage(i,-r/2,-r/2,r,r)):this.ctx.drawImage(i,t.transform.pos.x-r/2+n.x,t.transform.pos.y-r/2+n.y,r,r),this.ctx.restore()}drawProjectile(e){if(!this.ctx)return;const s=Math.sqrt(e.velocityX*e.velocityX+e.velocityY*e.velocityY),a=e.velocityX/s,i=e.velocityY/s,r=e.x+a*(t.PROJECTILE.LENGTH/2),o=e.y+i*(t.PROJECTILE.LENGTH/2),n=e.x-a*(t.PROJECTILE.LENGTH/2),l=e.y-i*(t.PROJECTILE.LENGTH/2);this.ctx.fillStyle=t.PROJECTILE.COLOR,this.ctx.strokeStyle=t.PROJECTILE.COLOR,this.ctx.lineWidth=2*t.PROJECTILE.SIZE,this.ctx.lineCap="round",this.ctx.beginPath(),this.ctx.moveTo(n,l),this.ctx.lineTo(r,o),this.ctx.stroke()}drawParticles(){this.ctx&&this.particles.forEach(t=>{const e=d(t.color);e&&this.ctx&&(this.ctx.save(),this.ctx.globalAlpha=t.opacity,0!==t.torque?(this.ctx.translate(t.x+t.size/2,t.y+t.size/2),this.ctx.rotate(t.rotation),this.ctx.fillStyle=`rgb(${e.r}, ${e.g}, ${e.b})`,this.ctx.fillRect(-t.size/2,-t.size/2,t.size,t.size)):(this.ctx.fillStyle=`rgb(${e.r}, ${e.g}, ${e.b})`,this.ctx.fillRect(Math.floor(t.x),Math.floor(t.y),t.size,t.size)),this.ctx.restore())})}drawAmmoBoxes(){this.ctx&&this.ammoBoxes.forEach(t=>{this.ctx&&(this.ctx.save(),this.ctx.beginPath(),this.ctx.arc(t.x,t.y,15,0,2*Math.PI),this.ctx.fillStyle="#FFD700",this.ctx.fill(),this.ctx.strokeStyle="#FFA500",this.ctx.lineWidth=2,this.ctx.stroke(),this.ctx.fillStyle="#000000",this.ctx.font="bold 10px Arial",this.ctx.textAlign="center",this.ctx.fillText(t.ammoAmount.toString(),t.x,t.y+3),this.ctx.restore())})}animateCharacterPart(t,e,s,a,i){const r=`${t}_${e}_${i||0}`;this.characterAnimations.set(r,{playerId:t,part:e,partIndex:i,frames:s,duration:a,startTime:Date.now(),originalOffset:{x:0,y:0}}),this.roomManager.sendMessage(JSON.stringify({type:"character-animation",playerId:t,part:e,partIndex:i,frames:s,duration:a}))}updateCharacterAnimations(){const t=[],e=Date.now();this.characterAnimations.forEach((s,a)=>{const i=(e-s.startTime)/s.duration;if(0!==s.duration&&i>=1)return void t.push(a);const r=Object.keys(s.frames).map(Number).sort((t,e)=>t-e);let o,n,l=0;for(let t=0;t<r.length-1;t++){const e=r[t],s=r[t+1];if(i>=e&&i<s){l=t;break}}if(i>=1){const t=s.frames[r[r.length-1]];o=t.x,n=t.y}else{const t=s.frames[r[l]],e=s.frames[r[l+1]]||t,a=(i-r[l])/(r[l+1]-r[l])||0;o=t.x+(e.x-t.x)*a,n=t.y+(e.y-t.y)*a}this.characterOffsets.set(a,{x:o,y:n})}),t.forEach(t=>{this.characterAnimations.delete(t),this.characterOffsets&&this.characterOffsets.delete(t)})}createDecal(t,s,a,i=e){if(!this.decalCtx)return;if(t<0||t>n||s<0||s>l)return;const r=i.RADIUS.MIN+Math.random()*(i.RADIUS.MAX-i.RADIUS.MIN),o=i.DENSITY.MIN+Math.random()*(i.DENSITY.MAX-i.DENSITY.MIN),h=i.OPACITY.MIN+Math.random()*(i.OPACITY.MAX-i.OPACITY.MIN),m=Math.floor(r*r*Math.PI*o),c=d(i.COLOR);if(c){this.decalCtx.save(),this.decalCtx.globalCompositeOperation="source-over";for(let e=0;e<m;e++){const e=Math.random()*Math.PI*2,a=Math.random()*r,o=t+Math.cos(e)*a,m=s+Math.sin(e)*a;if(o<0||o>=n||m<0||m>=l)continue;const y=h+(Math.random()-.5)*i.VARIATION,d=Math.max(.05,Math.min(.6,y));this.decalCtx.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, ${d})`,this.decalCtx.fillRect(Math.floor(o),Math.floor(m),1,1)}this.decalCtx.restore(),this.decals.set(a,{x:t,y:s,params:i}),this.roomManager.sendMessage(JSON.stringify({type:"add-decal",decalId:a,x:t,y:s,params:i}))}else console.error(`Invalid hex color: ${i.COLOR}`)}applyDecal(t,e,s,a){if(!this.decalCtx)return;if(this.decals.has(s))return;if(t<0||t>n||e<0||e>l)return;const i=a.RADIUS.MIN+Math.random()*(a.RADIUS.MAX-a.RADIUS.MIN),r=a.DENSITY.MIN+Math.random()*(a.DENSITY.MAX-a.DENSITY.MIN),o=a.OPACITY.MIN+Math.random()*(a.OPACITY.MAX-a.OPACITY.MIN),h=Math.floor(i*i*Math.PI*r),m=d(a.COLOR);if(m){this.decalCtx.save(),this.decalCtx.globalCompositeOperation="source-over";for(let s=0;s<h;s++){const s=Math.random()*Math.PI*2,r=Math.random()*i,h=t+Math.cos(s)*r,c=e+Math.sin(s)*r;if(h<0||h>=n||c<0||c>=l)continue;const y=o+(Math.random()-.5)*a.VARIATION,d=Math.max(.05,Math.min(.6,y));this.decalCtx.fillStyle=`rgba(${m.r}, ${m.g}, ${m.b}, ${d})`,this.decalCtx.fillRect(Math.floor(h),Math.floor(c),1,1)}this.decalCtx.restore(),this.decals.set(s,{x:t,y:e,params:a})}else console.error(`Invalid hex color: ${a.COLOR}`)}createParticles(t,e,s,a,i){const r=Math.floor(a.COUNT.MIN+Math.random()*(a.COUNT.MAX-a.COUNT.MIN)),o=[];for(let n=0;n<r;n++){const r=a.LIFETIME.MIN+Math.random()*(a.LIFETIME.MAX-a.LIFETIME.MIN),l=a.SPEED.MIN+Math.random()*(a.SPEED.MAX-a.SPEED.MIN),h=a.SIZE.MIN+Math.random()*(a.SIZE.MAX-a.SIZE.MIN),m=a.OPACITY.MIN+Math.random()*(a.OPACITY.MAX-a.OPACITY.MIN),c=a.TORQUE.MIN+Math.random()*(a.TORQUE.MAX-a.TORQUE.MIN);let y;y=i?Math.atan2(i.y,i.x)+(Math.random()-.5)*a.SPREAD:Math.random()*Math.PI*2;const d={lifetime:r,speed:l,size:h,opacity:m,torque:c,angle:y,velocityX:Math.cos(y)*l,velocityY:Math.sin(y)*l,rotation:Math.random()*Math.PI*2},p={id:`${s}_${n}`,x:t,y:e,velocityX:d.velocityX,velocityY:d.velocityY,size:d.size,opacity:d.opacity,maxOpacity:d.opacity,color:a.COLOR,lifetime:d.lifetime,age:0,collide:a.COLLIDE,fade:a.FADE,paint:a.PAINT,stain:a.STAIN,torque:d.torque,rotation:d.rotation,hasCollided:!1};this.particles.set(p.id,p),o.push(d)}this.roomManager.sendMessage(JSON.stringify({type:"add-particles",particleId:s,x:t,y:e,particleData:o,color:a.COLOR,collide:a.COLLIDE,fade:a.FADE}))}applyParticles(t,e,s,a,i,r,o){a.forEach((a,n)=>{const l={id:`${s}_${n}`,x:t,y:e,velocityX:a.velocityX,velocityY:a.velocityY,size:a.size,opacity:a.opacity,maxOpacity:a.opacity,color:i,lifetime:a.lifetime,age:0,collide:r,fade:o,paint:!1,stain:a.stain,torque:a.torque,rotation:a.rotation,hasCollided:!1};this.particles.set(l.id,l)})}updateParticles(){const t=[];this.particles.forEach((e,s)=>{if(e.x+=e.velocityX,e.y+=e.velocityY,e.age+=16,e.rotation+=e.torque*Math.PI/180/60,e.fade){const t=e.age/e.lifetime;e.opacity=e.maxOpacity*(1-t)}if(e.hasCollided&&e.stain){this.stampParticle(e.x,e.y,`stain_${s}_${Date.now()}`,e);const t=(e.age-(e.lifetime-.5*e.lifetime))/(.5*e.lifetime);t>0&&(e.size=Math.max(.5,e.size*(1-.1*t)),e.opacity=e.opacity*(1-t))}if(e.age>=e.lifetime||e.x<-10||e.x>810||e.y<-10||e.y>610){if(e.collide&&e.age>=e.lifetime&&e.x>=0&&e.x<=n&&e.y>=0&&e.y<=l&&!e.hasCollided){e.hasCollided=!0;const t=.875+.1*Math.random();e.velocityX*=1-t,e.velocityY*=1-t;const s=.5*e.lifetime;return void(e.lifetime+=s)}e.paint&&!e.stain&&e.age>=e.lifetime&&e.x>=0&&e.x<=n&&e.y>=0&&e.y<=l&&this.stampParticle(e.x,e.y,`stamp_${s}`,e),t.push(s)}}),t.forEach(t=>this.particles.delete(t))}stampParticle(t,e,s,a){if(!this.decalCtx)return;const i=d(a.color);i&&(this.decalCtx.save(),this.decalCtx.globalCompositeOperation="source-over",0!==a.torque?(this.decalCtx.translate(a.x+a.size/2,a.y+a.size/2),this.decalCtx.rotate(a.rotation),this.decalCtx.fillStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${a.opacity})`,this.decalCtx.fillRect(-a.size/2,-a.size/2,a.size,a.size)):(this.decalCtx.fillStyle=`rgba(${i.r}, ${i.g}, ${i.b}, ${a.opacity})`,this.decalCtx.fillRect(Math.floor(a.x),Math.floor(a.y),a.size,a.size)),this.decalCtx.restore(),this.decals.set(s,{x:a.x,y:a.y,params:null}),this.roomManager.sendMessage(JSON.stringify({type:"particle-stamp",stampId:s,x:a.x,y:a.y,color:a.color,opacity:a.opacity,size:a.size,rotation:a.rotation,torque:a.torque})))}applyParticleStamp(t,e,s,a,i,r,o,n){if(!this.decalCtx)return;if(this.decals.has(s))return;const l=d(a);l&&(this.decalCtx.save(),this.decalCtx.globalCompositeOperation="source-over",void 0!==o&&void 0!==n&&0!==n?(this.decalCtx.translate(t+r/2,e+r/2),this.decalCtx.rotate(o),this.decalCtx.fillStyle=`rgba(${l.r}, ${l.g}, ${l.b}, ${i})`,this.decalCtx.fillRect(-r/2,-r/2,r,r)):(this.decalCtx.fillStyle=`rgba(${l.r}, ${l.g}, ${l.b}, ${i})`,this.decalCtx.fillRect(Math.floor(t),Math.floor(e),r,r)),this.decalCtx.restore(),this.decals.set(s,{x:t,y:e,params:null}))}createEmitter(t,e,s){const a=t===this.userId?this.myPlayer:this.players.get(t);if(!a)return;const i=e-a.transform.pos.x,r=s-a.transform.pos.y,o=Math.atan2(r,i),n=`particle_emitter_${t}_${Date.now()}`,l=1e3+2e3*Math.random();this.emitters.set(n,{playerId:t,offsetX:i,offsetY:r,direction:o,lifetime:l,age:0,lastEmission:0,emissionInterval:200+300*Math.random()}),this.roomManager.sendMessage(JSON.stringify({type:"particle-emitter",emitterId:n,playerId:t,offsetX:i,offsetY:r,direction:o,lifetime:l})),console.log(`Emitter created on ${t} for ${l}ms`)}updateEmitters(){const t=[];this.emitters.forEach((e,i)=>{e.age+=16;const r=e.playerId===this.userId?this.myPlayer:this.players.get(e.playerId);if(!r||r.stats.health.value<=0)return void t.push(i);const o=r.transform.pos.x+e.offsetX,n=r.transform.pos.y+e.offsetY;if(e.age>=e.lastEmission+e.emissionInterval){const t=.6*Math.PI,s=(Math.random()-.5)*t,r=e.direction+s,l=3,h=4*(Math.random()-.5),m=Math.max(.5,l+h);this.createParticles(o+8*(Math.random()-.5),n+8*(Math.random()-.5),`blood_splatter_${i}_${e.age}`,a,{x:Math.cos(r)*m,y:Math.sin(r)*m}),e.lastEmission=e.age,e.emissionInterval=120+180*Math.random()}e.age>=e.lifetime&&(this.createDecal(o,n,`emitter_decal_${i}`,s),t.push(i))}),t.forEach(t=>this.emitters.delete(t))}updateDisplay(t,e){if(this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer)switch(this.clearDisplay(),t){case"lobby":this.lobbyContainer.style.display="flex",this.chatContainer.style.display="flex",e&&this.roomIdDisplay&&(this.roomIdDisplay.textContent=e),this.inLobby=!0;break;case"room":this.roomControls.style.display="flex";break;case"game":if(this.gameContainer.style.display="flex",this.chatContainer.style.display="flex",this.leaderboardContainer.style.display="flex",e){const t=this.gameRoomIdDisplay;t&&(t.textContent=e)}this.inLobby=!1}}updateHostDisplay(){this.startGameBtn&&this.gameOptionsContainer&&(this.startGameBtn.style.display=this.isHost?"block":"none",this.startGameBtn.disabled=this.lobbyPlayers.size<1,this.gameOptionsContainer.style.display=this.isHost?"flex":"none")}clearDisplay(){this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer&&(this.roomControls.style.display="none",this.lobbyContainer.style.display="none",this.gameContainer.style.display="none",this.chatContainer.style.display="none",this.leaderboardContainer.style.display="none")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new N}):new N})();