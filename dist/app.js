(()=>{"use strict";const t=.85,e=.55,s=8,o=100,i=15,a=15,r=800,n=600,h={RECONNECT_DELAY:3e3,CONNECTION_TIMEOUT:1e3,CONTROLS:["w","a","s","d"]},l="#000";function c(){let t="";for(let e=0;e<12;e++)t+="0123456789abcdefghijklmnopqrstuvwxyz"[Math.floor(36*Math.random())];return t}class y{constructor(t){this.currentRoom=null,this.ws=null,this.messageHandlers=[],this.userId=t}setWebSocket(t){this.ws=t,this.setupMessageHandler()}createRoom(){const t=function(){let t="room_";for(let e=0;e<10;e++)t+="0123456789abcdefghijklmnopqrstuvwxyz"[Math.floor(36*Math.random())];return t}();return this.joinRoom(t,!0),t}joinRoom(t,e=!1){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void console.error("WebSocket not connected");const s={type:e?"create-room":"join-room",roomId:t,userId:this.userId};this.ws.send(JSON.stringify(s)),this.currentRoom=t,function(t){const e=`${window.location.origin}?room=${t}`;window.history.pushState({roomId:t},"",e)}(t)}leaveRoom(){if(!this.currentRoom||!this.ws)return;const t={type:"leave-room",roomId:this.currentRoom,userId:this.userId};this.ws.send(JSON.stringify(t)),this.currentRoom=null,window.history.pushState({},"",window.location.origin)}sendMessage(t){if(!this.currentRoom||!this.ws)return;const e={type:"room-message",roomId:this.currentRoom,userId:this.userId,message:t};this.ws.send(JSON.stringify(e))}getCurrentRoom(){return this.currentRoom}getRoomLink(){return this.currentRoom?(t=this.currentRoom,`${window.location.origin}?room=${t}`):null;var t}onMessage(t){this.messageHandlers.push(t)}setupMessageHandler(){this.ws&&(this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);this.messageHandlers.forEach(t=>t(e))}catch(e){const s={type:"room-message",userId:"server",message:t.data};this.messageHandlers.forEach(t=>t(s))}})}}class d{constructor(){this.ws=null,this.canvas=null,this.ctx=null,this.roomControls=null,this.gameContainer=null,this.userIdDisplay=null,this.roomIdDisplay=null,this.lobbyContainer=null,this.lobbyPlayersList=null,this.startGameBtn=null,this.chatContainer=null,this.chatMessages=null,this.chatInput=null,this.chatSendBtn=null,this.playerVelocityX=0,this.playerVelocityY=0,this.lastSentX=0,this.lastSentY=0,this.players=new Map,this.lobbyPlayers=new Map,this.projectiles=new Map,this.keys=new Set,this.gameRunning=!1,this.isHost=!1,this.inLobby=!1,this.isMouseDown=!1,this.mouseX=0,this.mouseY=0,this.lastBurstTime=0,this.currentBurstShot=0,this.burstInProgress=!1,this.nextBurstShotTime=0,this.projectileOffset=5,this.userId=c(),this.roomManager=new y(this.userId),this.myPlayer={id:this.userId,x:770*Math.random()+a,y:570*Math.random()+a,color:"#"+Math.floor(16777215*Math.random()).toString(16).padStart(6,"0"),health:o},"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initializeElements(),this.setupEventListeners(),this.checkForRoomInURL()}):(this.initializeElements(),this.setupEventListeners(),this.checkForRoomInURL())}initializeElements(){this.canvas=document.getElementById("gameCanvas"),this.roomControls=document.getElementById("roomControls"),this.gameContainer=document.getElementById("gameContainer"),this.lobbyContainer=document.getElementById("lobbyContainer"),this.lobbyPlayersList=document.getElementById("lobbyPlayersList"),this.startGameBtn=document.getElementById("startGameBtn"),this.userIdDisplay=document.getElementById("userId"),this.roomIdDisplay=document.getElementById("roomId"),this.chatContainer=document.getElementById("chatContainer"),this.chatMessages=document.getElementById("chatMessages"),this.chatInput=document.getElementById("chatInput"),this.chatSendBtn=document.getElementById("chatSendBtn"),this.canvas&&this.roomControls&&this.gameContainer&&this.lobbyContainer&&this.userIdDisplay&&this.roomIdDisplay&&this.lobbyPlayersList&&this.startGameBtn&&this.chatContainer&&this.chatMessages&&this.chatInput&&this.chatSendBtn?(this.canvas.width=r,this.canvas.height=n,this.ctx=this.canvas.getContext("2d"),this.ctx?(this.userIdDisplay.textContent=this.userId,this.showRoomControls()):console.error("Could not get canvas context")):console.error("Some required DOM elements are missing")}connectWebSocket(){const t="https:"===location.protocol?"wss:":"ws:";this.ws=new WebSocket(`${t}//${location.host}`),this.ws.onopen=()=>{console.log("Connected to WebSocket"),this.roomManager.setWebSocket(this.ws)},this.ws.onclose=()=>{console.log("Disconnected from WebSocket"),this.gameRunning=!1,setTimeout(()=>this.connectWebSocket(),h.RECONNECT_DELAY)},this.ws.onerror=t=>{console.error("WebSocket error:",t)}}handleRoomMessage(t){switch(t.type){case"room-created":console.log("Room created");break;case"room-joined":console.log("Joined room - lobby"),this.isHost=!1,this.showLobbyControls(t.roomId||""),this.roomManager.sendMessage(JSON.stringify({type:"lobby-join",color:this.myPlayer.color})),this.lobbyPlayers.set(this.userId,{id:this.userId,color:this.myPlayer.color,isHost:this.isHost}),this.updateLobbyPlayersList(),this.updateStartButton();break;case"user-joined":console.log(`User ${t.userId} joined`),this.gameRunning&&!this.inLobby&&this.roomManager.sendMessage(JSON.stringify({type:"player-join",x:this.myPlayer.x,y:this.myPlayer.y,color:this.myPlayer.color}));break;case"room-joined-game":console.log("Joined room - game in progress"),this.isHost=!1,this.showGameControls(t.roomId||""),this.startGameLoop();break;case"user-left":console.log(`User ${t.userId} left`),this.lobbyPlayers.delete(t.userId),this.players.delete(t.userId),this.projectiles.forEach((e,s)=>{e.ownerId===t.userId&&this.projectiles.delete(s)}),this.updateLobbyPlayersList();break;case"room-message":this.handleGameMessage(t);break;case"room-error":alert(`Error: ${t.message}`)}}handleGameMessage(t){if(t.message)try{const e=JSON.parse(t.message);switch(e.type){case"lobby-join":this.lobbyPlayers.set(t.userId,{id:t.userId,color:e.color,isHost:!1}),this.updateLobbyPlayersList(),this.isHost&&this.roomManager.sendMessage(JSON.stringify({type:"lobby-state",players:Array.from(this.lobbyPlayers.values())}));break;case"lobby-state":this.lobbyPlayers.clear(),e.players.forEach(t=>{this.lobbyPlayers.set(t.id,t)}),this.updateLobbyPlayersList(),this.updateStartButton();break;case"promote-player":this.lobbyPlayers.forEach((t,s)=>{t.isHost=s===e.targetPlayerId}),this.isHost=e.targetPlayerId===this.userId,this.isHost&&"host-migration"===e.reason&&console.log("I am now the host due to host migration"),this.updateLobbyPlayersList(),this.updateStartButton();break;case"return-to-lobby":console.log("Returning to lobby - last player or game ended"),this.gameRunning=!1,e.newHostId===this.userId&&(this.isHost=!0,console.log("I am now the host as the last remaining player")),this.players.clear(),this.projectiles.clear(),this.showLobbyControls(this.roomManager.getCurrentRoom()||"");break;case"kick-player":e.targetPlayerId===this.userId&&(alert("You have been kicked from the lobby"),this.leaveRoom());break;case"chat-message":t.userId!==this.userId&&this.displayChatMessage(t.userId,e.message,!1);break;case"start-game":this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop();break;case"player-join":case"player-state":this.inLobby||this.players.set(t.userId,{id:t.userId,x:e.x,y:e.y,color:e.color,health:e.health||o});break;case"player-move":if(!this.inLobby&&this.players.has(t.userId)){const s=this.players.get(t.userId);s.x=e.x,s.y=e.y}break;case"player-hit":if(e.projectileId&&this.projectiles.delete(e.projectileId),e.targetId===this.userId)this.myPlayer.health=e.newHealth,console.log(`I was hit for ${e.damage} damage by ${e.shooterId}`),this.myPlayer.health<=0&&this.respawnPlayer();else if(this.players.has(e.targetId)){const t=this.players.get(e.targetId);t.health=e.newHealth,console.log(`Player ${t.id} was hit for ${e.damage} damage`),t.health<=0&&console.log(`Player ${t.id} died`)}break;case"player-respawn":if(this.players.has(t.userId)){const s=this.players.get(t.userId);s.x=e.x,s.y=e.y,s.health=e.health,console.log(`Player ${s.id} respawned`)}break;case"projectile-launch":this.inLobby||t.userId===this.userId||this.projectiles.set(e.projectile.id,e.projectile);break;case"projectile-remove":this.inLobby||this.projectiles.delete(e.projectileId)}}catch(t){console.error("Error parsing game message:",t)}}showRoomControls(){this.updateDisplay("room")}hostRoom(){if(this.ws){const t=this.roomManager.createRoom();this.isHost=!0,this.showLobbyControls(t)}else this.connectWebSocket(),setTimeout(()=>{const t=this.roomManager.createRoom();this.isHost=!0,this.showLobbyControls(t)},h.CONNECTION_TIMEOUT)}joinRoom(){const t=prompt("Enter room code or link:");if(!t)return;let e=null;try{const s=new URL(t,window.location.origin);e=s.pathname.startsWith("/room_")?s.pathname.replace("/","").replace("/",""):new URLSearchParams(s.search).get("room")}catch{t.startsWith("room_")&&(e=t)}e?this.ws?this.roomManager.joinRoom(e):(this.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(e)},h.CONNECTION_TIMEOUT)):alert("Invalid room code or link")}leaveRoom(){this.roomManager.leaveRoom(),this.gameRunning=!1,this.inLobby=!1,this.isHost=!1,this.players.clear(),this.projectiles.clear(),this.lobbyPlayers.clear(),this.clearChat(),this.showRoomControls()}checkForRoomInURL(){const t=new URLSearchParams(window.location.search).get("room");t&&(this.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(t)},h.CONNECTION_TIMEOUT))}copyRoomCode(){const t=this.inLobby?document.getElementById("roomId")?.textContent:document.getElementById("gameRoomId")?.textContent;t&&navigator.clipboard.writeText(t).then(()=>{alert("Room code copied!")}).catch(()=>{alert("Could not copy. Please copy manually.")})}showLobbyControls(t){this.updateDisplay("lobby",t),this.lobbyPlayers.set(this.userId,{id:this.userId,color:this.myPlayer.color,isHost:this.isHost}),this.updateLobbyPlayersList(),this.updateStartButton()}updateLobbyPlayersList(){this.lobbyPlayersList&&(this.lobbyPlayersList.innerHTML="",Array.from(this.lobbyPlayers.values()).sort((t,e)=>t.isHost&&!e.isHost?-1:!t.isHost&&e.isHost?1:0).forEach(t=>{const e=document.createElement("div");e.className="lobby-player";const s=document.createElement("div");s.className="player-color",s.style.backgroundColor=t.color;const o=document.createElement("div");o.className="player-name",o.textContent=`${t.id}${t.isHost?" (Host)":""}`;const i=document.createElement("div");if(i.className="player-controls",this.isHost&&t.id!==this.userId){const e=document.createElement("button");e.textContent="Promote",e.onclick=()=>this.promotePlayer(t.id);const s=document.createElement("button");s.textContent="Kick",s.className="danger",s.onclick=()=>this.kickPlayer(t.id),i.appendChild(e),i.appendChild(s)}e.appendChild(s),e.appendChild(o),e.appendChild(i),this.lobbyPlayersList&&this.lobbyPlayersList.appendChild(e)}))}updateStartButton(){this.startGameBtn&&(this.startGameBtn.style.display=this.isHost?"block":"none",this.startGameBtn.disabled=this.lobbyPlayers.size<1)}promotePlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"promote-player",targetPlayerId:t}))}kickPlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"kick-player",targetPlayerId:t}))}sendChatMessage(){if(!this.chatInput||!this.chatInput.value.trim())return;const t=this.chatInput.value.trim();t.length>200?alert("Message too long! Max 200 characters."):(this.roomManager.sendMessage(JSON.stringify({type:"chat-message",message:t,timestamp:Date.now()})),this.displayChatMessage(this.userId,t,!0),this.chatInput.value="")}displayChatMessage(t,e,s=!1){if(!this.chatMessages)return;const o=document.createElement("div");o.className="chat-message "+(s?"own":"other");const i=document.createElement("span");i.className="sender",i.textContent=s?"You:":`${t}:`;const a=document.createElement("span");for(a.className="content",a.textContent=e,o.appendChild(i),o.appendChild(a),this.chatMessages.appendChild(o),this.chatMessages.scrollTop=this.chatMessages.scrollHeight;this.chatMessages.children.length>100;)this.chatMessages.removeChild(this.chatMessages.firstChild)}clearChat(){this.chatMessages&&(this.chatMessages.innerHTML=""),this.chatInput&&(this.chatInput.value="")}setupEventListeners(){document.getElementById("hostBtn")?.addEventListener("click",()=>this.hostRoom()),document.getElementById("joinBtn")?.addEventListener("click",()=>this.joinRoom()),document.getElementById("lobbyLeaveBtn")?.addEventListener("click",()=>this.leaveRoom()),document.getElementById("lobbyCodeBtn")?.addEventListener("click",()=>this.copyRoomCode()),document.getElementById("gameLeaveBtn")?.addEventListener("click",()=>this.leaveRoom()),document.getElementById("gameCodeBtn")?.addEventListener("click",()=>this.copyRoomCode()),this.startGameBtn?.addEventListener("click",()=>this.startGame()),this.chatSendBtn?.addEventListener("click",()=>this.sendChatMessage()),this.chatInput?.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendChatMessage())}),document.addEventListener("keydown",t=>this.onKeyDown(t)),document.addEventListener("keyup",t=>this.onKeyUp(t)),document.addEventListener("mousedown",t=>this.onMouseDown(t)),document.addEventListener("mouseup",t=>this.onMouseUp(t)),document.addEventListener("mousemove",t=>this.onMouseMove(t)),this.roomManager.onMessage(t=>this.handleRoomMessage(t))}onKeyDown(t){if(!this.gameRunning)return;const e=t.key.toLowerCase();h.CONTROLS.includes(e)&&(t.preventDefault(),this.keys.add(e))}onKeyUp(t){if(!this.gameRunning)return;const e=t.key.toLowerCase();h.CONTROLS.includes(e)&&(t.preventDefault(),this.keys.delete(e))}onMouseDown(t){this.gameRunning&&this.canvas&&0===t.button&&(this.isMouseDown=!0,this.updateMousePosition(t))}onMouseUp(t){this.gameRunning&&0===t.button&&(this.isMouseDown=!1,this.burstInProgress=!1,this.currentBurstShot=0)}onMouseMove(t){this.gameRunning&&this.updateMousePosition(t)}updateMousePosition(t){if(!this.canvas)return;const e=this.canvas.getBoundingClientRect();this.mouseX=t.clientX-e.left,this.mouseY=t.clientY-e.top}updateAttack(){if(!this.isMouseDown||!this.gameRunning)return;const t=Date.now();!this.burstInProgress&&t-this.lastBurstTime>=500&&(this.burstInProgress=!0,this.currentBurstShot=0,this.nextBurstShotTime=t,this.lastBurstTime=t),this.burstInProgress&&t>=this.nextBurstShotTime&&(this.launchProjectile(),this.currentBurstShot++,this.currentBurstShot>=1?this.burstInProgress=!1:this.nextBurstShotTime=t+100)}launchProjectile(){const t=this.mouseX-this.myPlayer.x,e=this.mouseY-this.myPlayer.y,s=Math.sqrt(t*t+e*e);if(0===s)return;const o=t/s,a=e/s,r=i+3+this.projectileOffset;for(let t=0;t<1;t++){const t=.1*(Math.random()-.5),e=Math.atan2(a,o)+t,s={id:c(),x:this.myPlayer.x+Math.cos(e)*r,y:this.myPlayer.y+Math.sin(e)*r,velocityX:8*Math.cos(e),velocityY:8*Math.sin(e),range:250,distanceTraveled:0,ownerId:this.userId,timestamp:Date.now()};this.projectiles.set(s.id,s),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:s}))}}updateProjectiles(){const t=[];this.projectiles.forEach((e,s)=>{e.x+=e.velocityX,e.y+=e.velocityY;const o=Math.sqrt(e.velocityX*e.velocityX+e.velocityY*e.velocityY);e.distanceTraveled+=o;const a=e.x-this.myPlayer.x,h=e.y-this.myPlayer.y;Math.sqrt(a*a+h*h)<=i+3&&(this.myPlayer.health-=25,t.push(s),this.roomManager.sendMessage(JSON.stringify({type:"player-hit",targetId:this.userId,shooterId:e.ownerId,damage:25,newHealth:this.myPlayer.health,projectileId:s})),this.myPlayer.health<=0&&this.respawnPlayer()),e.ownerId===this.userId&&this.players.forEach((o,a)=>{const r=e.x-o.x,n=e.y-o.y;if(Math.sqrt(r*r+n*n)<=i+3){t.push(s);const e=Math.max(0,o.health-25);o.health=e,this.roomManager.sendMessage(JSON.stringify({type:"player-hit",targetId:a,shooterId:this.userId,damage:25,newHealth:e,projectileId:s}))}}),(e.distanceTraveled>=e.range||e.x<0||e.x>r||e.y<0||e.y>n)&&(t.push(s),e.ownerId===this.userId&&this.roomManager.sendMessage(JSON.stringify({type:"projectile-remove",projectileId:s})))}),t.forEach(t=>{this.projectiles.delete(t)})}updatePlayerPosition(){if(!this.gameRunning)return;let o=0,i=0;this.keys.has("w")&&(i-=1),this.keys.has("s")&&(i+=1),this.keys.has("a")&&(o-=1),this.keys.has("d")&&(o+=1);const r=Math.sqrt(o*o+i*i);r>0&&(o/=r,i/=r);const n=o*s,h=i*s;this.playerVelocityX+=(n-this.playerVelocityX)*e,this.playerVelocityY+=(h-this.playerVelocityY)*e,0===r&&(this.playerVelocityX*=t,this.playerVelocityY*=t);let l=this.myPlayer.x+this.playerVelocityX,c=this.myPlayer.y+this.playerVelocityY,y=!1;l>=a&&l<=785?(this.myPlayer.x=l,y=!0):this.playerVelocityX=0,c>=a&&c<=585?(this.myPlayer.y=c,y=!0):this.playerVelocityY=0;const d=Math.sqrt((this.myPlayer.x-this.lastSentX)**2+(this.myPlayer.y-this.lastSentY)**2);y&&d>2&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",x:this.myPlayer.x,y:this.myPlayer.y})),this.lastSentX=this.myPlayer.x,this.lastSentY=this.myPlayer.y),Math.abs(this.playerVelocityX)<.01&&(this.playerVelocityX=0),Math.abs(this.playerVelocityY)<.01&&(this.playerVelocityY=0)}respawnPlayer(){console.log("I died! Respawning..."),this.myPlayer.health=o,this.myPlayer.x=770*Math.random()+a,this.myPlayer.y=570*Math.random()+a,this.roomManager.sendMessage(JSON.stringify({type:"player-respawn",x:this.myPlayer.x,y:this.myPlayer.y,health:this.myPlayer.health}))}showGameControls(t){this.updateDisplay("game",t)}startGame(){this.isHost&&(this.roomManager.sendMessage(JSON.stringify({type:"start-game"})),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop())}startGameLoop(){this.gameRunning=!0,this.roomManager.sendMessage(JSON.stringify({type:"player-join",x:this.myPlayer.x,y:this.myPlayer.y,color:this.myPlayer.color,health:this.myPlayer.health})),this.gameLoop()}gameLoop(){this.gameRunning&&this.ctx&&this.canvas&&(this.updatePlayerPosition(),this.updateAttack(),this.updateProjectiles(),this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.strokeStyle="#333",this.ctx.lineWidth=2,this.ctx.strokeRect(0,0,this.canvas.width,this.canvas.height),this.projectiles.forEach(t=>{this.drawProjectile(t)}),this.players.forEach(t=>{this.drawPlayer(t)}),this.drawPlayer(this.myPlayer,!0),requestAnimationFrame(()=>this.gameLoop()))}drawPlayer(t,e=!1){if(!this.ctx)return;this.ctx.beginPath(),this.ctx.arc(t.x,t.y,i,0,2*Math.PI),this.ctx.fillStyle=t.color,this.ctx.fill(),e&&(this.ctx.strokeStyle=l,this.ctx.lineWidth=3,this.ctx.stroke()),this.ctx.fillStyle=l,this.ctx.font="12px Arial",this.ctx.textAlign="center";const s=`${e?"You":t.id.substring(4,10)} (${t.health}HP)`;this.ctx.fillText(s,t.x,t.y-25)}drawProjectile(t){this.ctx&&(this.ctx.beginPath(),this.ctx.arc(t.x,t.y,3,0,2*Math.PI),this.ctx.fillStyle="#ff4444",this.ctx.fill())}updateDisplay(t,e){if(this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer)switch(this.roomControls.style.display="none",this.lobbyContainer.style.display="none",this.gameContainer.style.display="none",this.chatContainer.style.display="none",t){case"lobby":this.lobbyContainer.style.display="flex",this.chatContainer.style.display="flex",e&&this.roomIdDisplay&&(this.roomIdDisplay.textContent=e),this.inLobby=!0;break;case"room":this.roomControls.style.display="flex";break;case"game":if(this.gameContainer.style.display="flex",this.chatContainer.style.display="flex",e){const t=document.getElementById("gameRoomId");t&&(t.textContent=e)}this.inLobby=!1}}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new d}):new d})();