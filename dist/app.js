(()=>{var e={65:(e,t,a)=>{var s={"./clustermodule/clustermodule":224,"./clustermodule/clustermodule.ts":224,"./kineticbrain/kineticbrain":748,"./kineticbrain/kineticbrain.ts":748,"./muzzlesplitter/muzzlesplitter":358,"./muzzlesplitter/muzzlesplitter.ts":358,"./phoenixmodule/phoenixmodule":96,"./phoenixmodule/phoenixmodule.ts":96,"./projectilearray/projectilearray":800,"./projectilearray/projectilearray.ts":800,"./spatialtargeting/spatialtargeting":88,"./spatialtargeting/spatialtargeting.ts":88,"./spectralimage/spectralimage":368,"./spectralimage/spectralimage.ts":368};function i(e){var t=r(e);return a(t)}function r(e){if(!a.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}i.keys=function(){return Object.keys(s)},i.resolve=r,e.exports=i,i.id=65},88:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"spatial_targeting",name:"Spatial Targeting",subtitle:"Projectile upgrade that syncs its spatial awareness with the user.",icon:"/assets/img/icon/upgrades/unique/spatialtargeting.png",type:s.Tq.UNIQUE,rarity:s._8.SUPERIOR,unique:!0,func:e=>{e.unique.includes("spatial_targeting")||e.unique.push("spatial_targeting")}}}},96:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"phoenix_module",name:"Phoenix Module",subtitle:"Return from the flames with vengeance.",icon:"/assets/img/icon/upgrades/unique/phoenixmodule.png",type:s.Tq.UNIQUE,rarity:s._8.LEGENDARY,unique:!0,func:e=>{e.unique.includes("phoenix_module")||e.unique.push("phoenix_module")}}}},136:(e,t,a)=>{var s={"./carepackage/carepackage":751,"./carepackage/carepackage.ts":751};function i(e){var t=r(e);return a(t)}function r(e){if(!a.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}i.keys=function(){return Object.keys(s)},i.resolve=r,e.exports=i,i.id=136},152:(e,t,a)=>{"use strict";var s,i,r,o;a.d(t,{Tq:()=>r,VA:()=>s,_8:()=>i,wr:()=>o}),function(e){e.Perlin="perlin",e.Worley="worley",e.Voronoi="voronoi",e.Ridged="ridged"}(s||(s={})),function(e){e[e.COMMON=0]="COMMON",e[e.UNCOMMON=1]="UNCOMMON",e[e.SPECIAL=2]="SPECIAL",e[e.SUPERIOR=3]="SUPERIOR",e[e.RARE=4]="RARE",e[e.EXCEPTIONAL=5]="EXCEPTIONAL",e[e.LEGENDARY=6]="LEGENDARY",e[e.MYTHICAL=7]="MYTHICAL",e[e.ENLIGHTENED=8]="ENLIGHTENED",e[e.HOLY=9]="HOLY"}(i||(i={})),function(e){e.EQUIPMENT="equipment",e.RESOURCE="resource",e.STAT="stat",e.UNIQUE="unique"}(r||(r={})),function(e){e[e.Liquid=0]="Liquid",e[e.Solid=1]="Solid",e[e.Gas=2]="Gas"}(o||(o={}))},168:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"hemoglobin_saturator",name:"Hemoglobin Saturator",subtitle:"Increases red blood cell density for extended durability.",icon:"/assets/img/icon/upgrades/stats/hemoglobinsaturator.png",type:s.Tq.STAT,rarity:s._8.UNCOMMON,unique:!1,func:t=>{e.playerState.updateStat("stats.health.max",t.stats.health.max+10),e.playerState.updateStat("stats.health.value",t.stats.health.max)}}}},204:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"locomotion_module",name:"Locomotion Module",subtitle:"Primitave locomotion module installed on the user's footwear.",icon:"/assets/img/icon/upgrades/stats/locomotionmodule.png",type:s.Tq.STAT,rarity:s._8.COMMON,unique:!1,func:t=>{e.playerState.updateStat("stats.speed",t.stats.speed+1),e.playerState.updateStat("actions.dash.cooldown",1.5*t.actions.dash.cooldown)}}}},224:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"cluster_module",name:"Cluster Module",subtitle:"Cluster enhancement module for primary attacks.",icon:"/assets/img/icon/upgrades/unique/clustermodule.png",type:s.Tq.UNIQUE,rarity:s._8.RARE,unique:!0,func:e=>{e.unique.includes("cluster_module")||e.unique.push("cluster_module")}}}},358:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"muzzle_splitter",name:"Muzzle Splitter",subtitle:"Muzzle modification for primary attacks, requires certain skillset.",icon:"/assets/img/icon/upgrades/unique/muzzlesplitter.png",type:s.Tq.UNIQUE,rarity:s._8.SPECIAL,unique:!0,func:e=>{e.unique.includes("muzzle_splitter")||e.unique.push("muzzle_splitter")}}}},368:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"spectral_image",name:"Spectral Image",subtitle:"Forward imaging coordinate transponder.",icon:"/assets/img/icon/upgrades/unique/spectralimage.png",type:s.Tq.UNIQUE,rarity:s._8.EXCEPTIONAL,unique:!0,func:t=>{t.unique.includes("spectral_image")||(t.unique.push("spectral_image"),e.playerState.updateStat("actions.dash.time",t.actions.dash.time+50))}}}},528:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"bioregulator",name:"Bioregulator",subtitle:"Increases energy regulation efficiency, with a small boot overhead.",icon:"/assets/img/icon/upgrades/stats/bioregulator.png",type:s.Tq.STAT,rarity:s._8.COMMON,unique:!1,func:t=>{e.playerState.updateStat("stats.stamina.max",1.1*t.stats.stamina.max),e.playerState.updateStat("stats.stamina.recovery.rate",t.stats.stamina.recovery.rate+1),e.playerState.updateStat("stats.stamina.recovery.delay",1.25*t.stats.stamina.recovery.delay)}}}},612:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"damage_buffer",name:"Damage Buffer",subtitle:"Type D125 buffer, which improves damage at a small cost. ",icon:"/assets/img/icon/upgrades/stats/damagebuffer.png",type:s.Tq.STAT,rarity:s._8.UNCOMMON,unique:!1,func:t=>{e.playerState.updateStat("actions.primary.projectile.damage",1.1*t.actions.primary.projectile.damage),e.playerState.updateStat("actions.primary.buffer",1.1*t.actions.primary.buffer)}}}},617:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"switch",name:"Switch",subtitle:"Completely legal and completely functional.",icon:"/assets/img/icon/upgrades/equipment/switch.png",type:s.Tq.EQUIPMENT,rarity:s._8.RARE,unique:!1,func:t=>{t.equipment.includes("switch")||(t.equipment.push("switch"),e.playerState.updateStat("actions.primary.projectile.spread",t.actions.primary.projectile.spread*=1.15))}}}},748:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"kinetic_brain",name:"Kinetic Brain",subtitle:"Cerebral kinetic stem implant, unable to function at maximum capacity.",icon:"/assets/img/icon/upgrades/unique/kineticbrain.png",type:s.Tq.UNIQUE,rarity:s._8.EXCEPTIONAL,unique:!0,func:e=>{e.unique.includes("kinetic_brain")||e.unique.push("kinetic_brain")}}}},751:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"care_package",name:"Care Package",subtitle:"These are hard to come by.",icon:"/assets/img/icon/upgrades/resource/carepackage.png",type:s.Tq.RESOURCE,rarity:s._8.COMMON,unique:!1,func:t=>{t.actions.primary.magazine.currentReserve+=20,e.ui.ammoReservesUIController.spawnAmmoInReserveUI(20)}}}},800:(e,t,a)=>{"use strict";a.r(t),a.d(t,{create:()=>i});var s=a(152);function i(e){return{id:"projectile_array",name:"Projectile Array",subtitle:"Chance to fire an array of extra projectiles.",icon:"/assets/img/icon/upgrades/unique/projectilearray.png",type:s.Tq.UNIQUE,rarity:s._8.RARE,unique:!0,func:e=>{e.unique.includes("projectile_array")||e.unique.push("projectile_array")}}}},823:(e,t,a)=>{var s={"./bioregulator/bioregulator":528,"./bioregulator/bioregulator.ts":528,"./damagebuffer/damagebuffer":612,"./damagebuffer/damagebuffer.ts":612,"./hemoglobinsaturator/hemoglobinsaturator":168,"./hemoglobinsaturator/hemoglobinsaturator.ts":168,"./locomotionmodule/locomotionmodule":204,"./locomotionmodule/locomotionmodule.ts":204};function i(e){var t=r(e);return a(t)}function r(e){if(!a.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}i.keys=function(){return Object.keys(s)},i.resolve=r,e.exports=i,i.id=823},854:(e,t,a)=>{var s={"./switch/switch":617,"./switch/switch.ts":617};function i(e){var t=r(e);return a(t)}function r(e){if(!a.o(s,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return s[e]}i.keys=function(){return Object.keys(s)},i.resolve=r,e.exports=i,i.id=854}},t={};function a(s){var i=t[s];if(void 0!==i)return i.exports;var r=t[s]={exports:{}};return e[s](r,r.exports,a),r.exports}a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";const e=8,t=["/assets/img/effects/shrapnel/shrapnel_00.png","/assets/img/effects/shrapnel/shrapnel_01.png","/assets/img/effects/shrapnel/shrapnel_02.png","/assets/img/effects/shrapnel/shrapnel_03.png","/assets/img/effects/shrapnel/shrapnel_04.png","/assets/img/effects/shrapnel/shrapnel_05.png"],s={BASE:"/assets/img/object/ammobox/base.png",BULLETS:"/assets/img/object/ammobox/bullets.png",LID:"/assets/img/object/ammobox/lid.png"},i=3200,r=2400,o=15,n=800,l=600,h={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,SELECT:8,START:9,L_STICK:10,R_STICK:11,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,HOME:16,AXES:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},d={CHARACTER_SIZE:650,CONNECTION_TIMEOUT:1e3,CONTROLS:{KEYBINDS:{MELEE:"mouse2",MOVE_UP:"w",MOVE_LEFT:"a",MOVE_DOWN:"s",MOVE_RIGHT:"d",RELOAD:"r",SPRINT:"shift",ATTACK:"mouse1",DASH:" "},GAMEPAD:{MELEE:h.RB,DASH:h.LB,DEADZONE:.2,RELOAD:h.A,SPRINT:h.LT,ATTACK:h.RT}},GAME_END_DELAY:5e3,GRAPHICS:{PHYSICS:{AMMORESERVES:!0},STATIC_OVERLAY:!0,BACKGROUND_PARTICLES:!0},MAX_PLAYERS:4,MAX_WINS:5,RECONNECT_DELAY:3e3,ROUND_END_DELAY:3e3,NEW_ROUND_DELAY:500},m={KEYS:["Control","Shift","Alt","-","+"],REQUIRED_COUNT:5};class c{constructor(e,t){this.cacheManager=e,this.ui=t,this.adminKeysHeld=new Set,this.initKeyListener(),this.initConsoleKeybinds()}initKeyListener(){window.addEventListener("keydown",e=>{this.adminKeysHeld.add(e.key),this.checkAdminCombo()}),window.addEventListener("keyup",e=>{this.adminKeysHeld.delete(e.key)})}checkAdminCombo(){m.KEYS.every(e=>this.adminKeysHeld.has(e))&&this.adminKeysHeld.size===m.REQUIRED_COUNT&&(this.adminKeysHeld.clear(),this.showAdminModal())}showAdminModal(){this.ui.modal&&this.ui.modalInput&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalErrorDiv&&this.ui.modalText&&(this.ui.modal.classList.remove("hidden"),this.ui.modalConfirmButton.classList.remove("hidden"),this.ui.modalInput.value="",this.ui.modalInput.style.display="block",this.ui.modalErrorDiv.textContent="",this.ui.modalText.textContent="Enter Admin Command.",this.ui.modalConfirmButton.textContent="Execute",this.ui.modalCancelButton.textContent="Cancel",this.ui.modalInput.focus(),this.ui.modalConfirmButton.onclick=()=>{if(!this.ui.modalInput||!this.ui.modalErrorDiv)return;const e=this.ui.modalInput.value.trim();if(!e.includes(":"))return void(this.ui.modalErrorDiv.textContent="Invalid format.");const[t,a]=e.split(":");t&&a?(this.executeAdminCommand(t.trim(),a.trim()),this.ui.closeModal()):this.ui.modalErrorDiv.textContent="Invalid format."},this.ui.modalCancelButton.onclick=()=>this.ui.closeModal())}executeAdminCommand(e,t){console.log(`Admin command: ${e} with key: ${t}`),this.onAdminCommand?.(e,t)}initConsoleKeybinds(){document.addEventListener("keydown",e=>{e.getModifierState("Control")&&"`"===e.key&&(e.preventDefault(),this.clearCacheCommand())})}clearCacheCommand(){this.cacheManager.clear().then(()=>{console.log("Cache cleared! Reload the page."),location.reload()})}}class y{constructor(e,t,a){this.playerState=e,this.roomManager=t,this.userId=a,this.characterAnimations=new Map,this.characterOffsets=new Map}animateCharacterPart(e){this.generateCharacterAnimation(e),this.roomManager.sendMessage(JSON.stringify({type:"character-animation",params:e}))}rotateCharacterPart(e,t){if(e===this.userId)this.playerState.myPlayer.transform.rot=t;else{const a=this.playerState.players.get(e);if(!a)return;a.transform.rot=t}const a=Date.now();Math.abs(t-this.playerState.lastSentRotation)>.1&&a-this.playerState.lastSentRotationTime>=25&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{rot:this.playerState.myPlayer.transform.rot}})),this.playerState.lastSentRotation=t,this.playerState.lastSentRotationTime=a)}animateCharacterPartNetwork(e){this.generateCharacterAnimation(e)}generateCharacterAnimation(e){const{playerId:t,part:a,frames:s,duration:i,partIndex:r}=e,o=`${t}_${a}_${r||0}`;this.characterAnimations.set(o,{playerId:t,part:a,partIndex:r,frames:s,duration:i,startTime:Date.now(),originalOffset:{x:0,y:0}})}updateCharacterAnimations(e){const t=[],a=Date.now();this.characterAnimations.forEach((e,s)=>{const i=(a-e.startTime)/e.duration;if(0!==e.duration&&i>=1)return void t.push(s);const r=Object.keys(e.frames).map(Number).sort((e,t)=>e-t);let o,n,l=0;for(let e=0;e<r.length-1;e++){const t=r[e],a=r[e+1];if(i>=t&&i<a){l=e;break}}if(i>=1){const t=e.frames[r[r.length-1]];o=t.x,n=t.y}else{const t=e.frames[r[l]],a=e.frames[r[l+1]]||t,s=(i-r[l])/(r[l+1]-r[l])||0;o=t.x+(a.x-t.x)*s,n=t.y+(a.y-t.y)*s}this.characterOffsets.set(s,{x:o,y:n})}),t.forEach(e=>{this.characterAnimations.delete(e),this.characterOffsets&&this.characterOffsets.delete(e)})}clearAllAnimations(){this.characterAnimations.clear(),this.characterOffsets.clear()}}class u{constructor(e=10,t=5){this.poolSize=e,this.maxConcurrent=t,this.pools=new Map,this.activeAudio=new Map}createPool(e){const t=[];for(let a=0;a<this.poolSize;a++){const a=new Audio(e);a.preload="auto",a.addEventListener("ended",()=>this.returnToPool(e,a)),a.addEventListener("pause",()=>this.returnToPool(e,a)),t.push(a)}return t}returnToPool(e,t){const a=this.activeAudio.get(e);if(a){const e=a.indexOf(t);e>-1&&a.splice(e,1)}const s=this.pools.get(e);s&&!s.includes(t)&&s.push(t)}getAudio(e){const t=this.activeAudio.get(e)||[];if(t.length>=this.maxConcurrent)return null;let a=this.pools.get(e);a||(a=this.createPool(e),this.pools.set(e,a),this.activeAudio.set(e,[]));const s=a.pop();return s?(s.currentTime=0,s.volume=1,s.playbackRate=1,s.loop=!1,t.push(s),s):null}preloadSound(e){if(!this.pools.has(e)){const t=this.createPool(e);this.pools.set(e,t),this.activeAudio.set(e,[])}}}class p{constructor(e,t,a,s){this.audioConfig=e,this.roomManager=t,this.settingsManager=a,this.utility=s,this.audioPool=new u(this.audioConfig.settings.poolSize,this.audioConfig.settings.maxConcurrent)}playAudio(e){const t=this.audioPool.getAudio(e.src);if(!t)return void console.warn(`Audio pool exhausted or max concurrent reached for: ${e.src}`);let a=1;e.volume&&(a=e.volume.min+Math.random()*(e.volume.max-e.volume.min));const s=e.spatial?.blend??0;if(s>0&&e.spatial?.pos){const t=e.spatial.pos.x-e.listener.x,o=e.spatial.pos.y-e.listener.y,n=Math.sqrt(t*t+o*o);let l;if(e.spatial.rolloff){const t=e.spatial.rolloff.type||"linear",a=e.spatial.rolloff.factor,s=e.spatial.rolloff.distance;if("logarithmic"===t){const e=s*a;if(n<e)l=1;else{const t=(n-e)/(s-e);l=Math.max(0,1-Math.pow(t,.5))}}else l=Math.max(0,1-n/s*a)}else{const e=Math.max(i,r);l=Math.max(0,1-n/e)}a*=1-s+l*s}const o=e.output?.toLowerCase()||null,n=this.settingsManager.getSettings().audio.mixer;if(o&&void 0!==n[o]&&(a*=n[o]),a*=this.settingsManager.getSettings().audio.mixer.master,t.volume=Math.max(0,Math.min(1,a)),e.pitch){const a=e.pitch.min+Math.random()*(e.pitch.max-e.pitch.min);t.playbackRate=Math.max(.25,Math.min(4,a))}void 0!==e.loop&&(t.loop=e.loop);let l=0;e.delay&&(l=1e3*(e.delay.min+Math.random()*(e.delay.max-e.delay.min))),this.utility.safeTimeout(()=>{t.play().catch(e=>{console.warn("Audio play failed:",e)})},l)}playAudioNetwork(e){this.playAudio(e),this.roomManager.sendMessage(JSON.stringify({type:"play-audio",params:e}))}preloadAudioAssets(e,t){this.preloadSFX(e,t)}preloadSFX(e,t){for(const a in e){const s=e[a];Array.isArray(s)?s.forEach(e=>{"string"==typeof e&&e.endsWith(t)&&this.audioPool.preloadSound(e)}):"object"==typeof s&&null!==s&&this.preloadSFX(s,t)}}}class g{constructor(){this.dbName="SaltpeterCache",this.dbVersion=1,this.db=null,this.initDB()}async initDB(){return new Promise((e,t)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>t(a.error),a.onsuccess=()=>{this.db=a.result,e()},a.onupgradeneeded=e=>{const t=e.target.result;t.objectStoreNames.contains("settings")||t.createObjectStore("settings")}})}async write(e,t){return this.db||await this.initDB(),new Promise((a,s)=>{const i=this.db.transaction(["settings"],"readwrite").objectStore("settings").put(t,e);i.onerror=()=>s(i.error),i.onsuccess=()=>a()})}async read(e){return this.db||await this.initDB(),new Promise((t,a)=>{const s=this.db.transaction(["settings"],"readonly").objectStore("settings").get(e);s.onerror=()=>a(s.error),s.onsuccess=()=>t(s.result)})}async delete(e){return this.db||await this.initDB(),new Promise((t,a)=>{const s=this.db.transaction(["settings"],"readwrite").objectStore("settings").delete(e);s.onerror=()=>a(s.error),s.onsuccess=()=>t()})}async clear(){return this.db||await this.initDB(),new Promise((e,t)=>{const a=this.db.transaction(["settings"],"readwrite").objectStore("settings").clear();a.onerror=()=>t(a.error),a.onsuccess=()=>e()})}}class f{constructor(){this.weapon={glock:["/assets/img/weapon/glock/body.png","/assets/img/weapon/glock/slide.png"],knife:["/assets/img/weapon/melee/knife_00.png"]},this.magazine={glock:{empty:"/assets/img/object/weapons/glock/magazine_empty.png",full:"/assets/img/object/weapons/glock/magazine_full.png"}},this.body={default:"/assets/img/char/body/default.png"},this.head={default:"/assets/img/char/head/default.png",blondeAfro:"/assets/img/char/head/blonde_afro.png"},this.headwear={default:"/assets/img/char/headwear/default.png",fez:"/assets/img/char/headwear/fez.png",strawHat:"/assets/img/char/headwear/straw_hat.png",trucker:"/assets/img/char/headwear/trucker.png"},this.upgrades={kineticBrain:"/assets/img/char/upgrades/kineticbrain.png"},this.characterDecals={default:{blood:["/assets/img/effects/blood/blood_00.png","/assets/img/effects/blood/blood_01.png","/assets/img/effects/blood/blood_02.png","/assets/img/effects/blood/blood_03.png","/assets/img/effects/blood/blood_04.png"],gore:["/assets/img/effects/gore/gore_00.png","/assets/img/effects/gore/gore_01.png","/assets/img/effects/gore/gore_02.png","/assets/img/effects/gore/gore_03.png","/assets/img/effects/gore/gore_04.png","/assets/img/effects/gore/gore_05.png","/assets/img/effects/gore/gore_06.png","/assets/img/effects/gore/gore_07.png","/assets/img/effects/gore/gore_08.png","/assets/img/effects/gore/gore_09.png","/assets/img/effects/gore/gore_10.png","/assets/img/effects/gore/gore_11.png","/assets/img/effects/gore/gore_12.png","/assets/img/effects/gore/gore_13.png"]}}}}class w{constructor(e){this.charConfig=e}getCharacterAsset(e,t){switch(e){case"body":return this.charConfig.body[t]||this.charConfig.body.default;case"weapon":return this.charConfig.weapon[t]||this.charConfig.weapon.glock;case"head":return this.charConfig.head[t]||this.charConfig.head.default;case"headwear":return this.charConfig.headwear[t]||this.charConfig.headwear.default;case"upgrades":return t;default:throw new Error(`Unknown character layer: ${e}`)}}getUpgradeVisual(e){const t=e.toLowerCase();return this.charConfig.upgrades[t]||null}}class S{constructor(e,t){this.roomManager=e,this.ui=t}sendChatMessage(e){if(!this.ui.chatInput||!this.ui.chatInput.value.trim())return;const t=this.ui.chatInput.value.trim();t.length>200?alert("Message too long! Max 200 characters."):(this.roomManager.sendMessage(JSON.stringify({type:"chat-message",message:t,timestamp:Date.now()})),this.displayChatMessage({senderId:e,message:t,isOwn:!0}),this.ui.chatInput.value="")}displayChatMessage(e){if(!this.ui.chatMessages)return;const{senderId:t,message:a,isOwn:s=!1}=e,i=document.createElement("div");i.className="chat_message "+(s?"own":"other");const r=document.createElement("span");r.className="sender",r.textContent=s?"You:":`${t}:`;const o=document.createElement("span");for(o.className="content",o.textContent=a,i.appendChild(r),i.appendChild(o),this.ui.chatMessages.appendChild(i),this.ui.chatMessages.scrollTop=this.ui.chatMessages.scrollHeight;this.ui.chatMessages.children.length>100;)this.ui.chatMessages.removeChild(this.ui.chatMessages.firstChild)}clearChat(){this.ui.chatMessages&&(this.ui.chatMessages.innerHTML=""),this.ui.chatInput&&(this.ui.chatInput.value="")}}class b{constructor(e){this.settingsManager=e,this.activeKeys=new Set,this.gamepadKeys=new Set,this.previousKeys=new Set,this.mousePos={x:0,y:0},this.gamepadConnected=!1,this.gamepadConnectionEnabled=!0,this.gamepadRAxis=null,this.initGamepad()}held(e){return this.activeKeys.has(e)}triggered(e){return this.activeKeys.has(e)&&!this.previousKeys.has(e)}getActiveKeys(){return this.activeKeys}addKey(e){this.activeKeys.add(e)}removeKey(e){this.activeKeys.delete(e)}clearActiveKeys(){this.activeKeys.clear()}updatePreviousKeys(){this.previousKeys=new Set(this.activeKeys)}getMousePos(){return this.mousePos}setMousePos(e){this.mousePos.x=e.x,this.mousePos.y=e.y}initGamepad(){window.addEventListener("gamepadconnected",()=>{console.log("Gamepad connected!"),this.gamepadConnected=!0}),window.addEventListener("gamepaddisconnected",()=>{console.log("Gamepad disconnected!"),this.gamepadConnected=!1})}pollGamepad(){if(!this.gamepadConnected)return;const e=navigator.getGamepads()[0];if(!e)return;const t=this.settingsManager.getSettings(),a=t.controls.keybinds,s=t.controls.gamepad,i=s.deadzone;this.gamepadKeys.forEach(e=>this.activeKeys.delete(e)),this.gamepadKeys.clear();const r=e.axes[0],o=e.axes[1];r>i&&(this.activeKeys.add(a.moveRight),this.gamepadKeys.add(a.moveRight)),r<-i&&(this.activeKeys.add(a.moveLeft),this.gamepadKeys.add(a.moveLeft)),o>i&&(this.activeKeys.add(a.moveDown),this.gamepadKeys.add(a.moveDown)),o<-i&&(this.activeKeys.add(a.moveUp),this.gamepadKeys.add(a.moveUp)),e.buttons[s.melee].pressed&&(this.activeKeys.add(a.melee),this.gamepadKeys.add(a.melee)),e.buttons[s.dash].pressed&&(this.activeKeys.add(a.dash),this.gamepadKeys.add(a.dash)),e.buttons[s.reload].pressed&&(this.activeKeys.add(a.reload),this.gamepadKeys.add(a.reload)),e.buttons[s.attack].pressed&&(this.activeKeys.add(a.attack),this.gamepadKeys.add(a.attack)),e.buttons[s.sprint].pressed&&(this.activeKeys.add(a.sprint),this.gamepadKeys.add(a.sprint));const n=e.axes[2],l=e.axes[3],h=Math.sqrt(n*n+l*l);this.gamepadRAxis=h>i?Math.atan2(l,n)+Math.PI/2:null}getGamepadRAxis(){return this.gamepadRAxis}}class C{constructor(e,t,a,s,i){this.objectsManager=e,this.playerState=t,this.roomManager=a,this.ui=s,this.userId=i}checkCollisions(e){this.playerState.myPlayer.transform.pos.x=Math.max(15,Math.min(3185,this.playerState.myPlayer.transform.pos.x)),this.playerState.myPlayer.transform.pos.y=Math.max(15,Math.min(2385,this.playerState.myPlayer.transform.pos.y)),this.checkObjectCollisions(e),this.checkPlayersCollisions(e)}checkObjectCollisions(e){if(!this.collisionsEnabled(this.playerState.myPlayer))return;const t=this.getPlayerCollider(this.playerState.myPlayer,5);this.objectsManager.ammoBoxes.forEach((e,a)=>{if(e.isOpen)return;const s=this.playerState.myPlayer.transform.pos.x-e.transform.pos.x,i=this.playerState.myPlayer.transform.pos.y-e.transform.pos.y;if(Math.sqrt(s*s+i*i)<=t){const t=this.playerState.myPlayer.actions.primary.magazine.currentReserve,s=this.playerState.myPlayer.actions.primary.magazine.maxReserve,i=Math.min(e.ammoAmount,s-t);if(i>0){this.playerState.myPlayer.actions.primary.magazine.currentReserve+=i,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(i),console.log(`Picked up ammo box! +${i} bullets. Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`);const t=Math.random()*Math.PI*2,s=2+3*Math.random();e.isOpen=!0,e.lid.velocity={x:Math.cos(t)*s,y:Math.sin(t)*s},e.lid.torque=.3*(Math.random()-.5),this.roomManager.sendMessage(JSON.stringify({type:"ammo-pickup",ammoBoxId:a,playerId:this.userId,boxState:{isOpen:!0,lid:e.lid}}))}}})}checkPlayersCollisions(e){this.collisionsEnabled(this.playerState.myPlayer)&&this.playerState.players.forEach(e=>{if(!this.collisionsEnabled(e))return;const t=this.playerState.myPlayer.transform.pos.x-e.transform.pos.x,a=this.playerState.myPlayer.transform.pos.y-e.transform.pos.y,s=Math.sqrt(t*t+a*a),i=this.getPlayerCollider(this.playerState.myPlayer)+this.getPlayerCollider(e);if(s<i&&s>.01){const e=i-s,r=t/s*e,o=a/s*e;this.playerState.myPlayer.transform.pos.x+=r,this.playerState.myPlayer.transform.pos.y+=o}})}getPlayerCollider(e,t){let a=e.stats.size/4;return t&&t>0&&(a=e.stats.size/4+t),a}collisionsEnabled(e){return!(e.stats.health.value<=0||e.flags.hidden&&e.flags.invulnerable)}}class x{constructor(){this.decals={projectile:{radius:{min:4,max:8},density:{min:.175,max:.35},opacity:{min:.15,max:.25},variation:.215,colors:["#000000","#191919","#39362d"]},blood:{radius:{min:5,max:17.5},density:{min:.1,max:.175},opacity:{min:.275,max:.315},variation:.5,colors:["#781414","#710606","#a10101"]},explosion:{radius:{min:25,max:40},density:{min:.375,max:.575},opacity:{min:.35,max:.525},variation:.2,colors:["#434343","#2a2a2a","#3b1d1d"]}}}}class v{constructor(e,t,a,s,i,r,o){this.camera=e,this.charConfig=t,this.playerState=a,this.roomManager=s,this.ui=i,this.userId=r,this.utility=o,this.dynamicDecals=new Map,this.staticDecalData=null,this.decalsConfig=new x}createDecal(e){this.generateDecal(e),this.roomManager.sendMessage(JSON.stringify({type:"add-decal",params:e}))}createDecalNetwork(e){this.dynamicDecals.has(e.id)||this.generateDecal(e)}generateDecal(e){if(!this.ui.decalCtx)return;const{x:t,y:a}=e.pos;t<0||t>i||a<0||a>r||("parametric"===e.type&&e.parametric?this.generateParametricDecal(e.pos,e.parametric):"image"===e.type&&e.image&&this.generateImageDecal(e.pos,e.image),this.dynamicDecals.set(e.id,{params:e,pos:{x:t,y:a}}))}generateParametricDecal(e,t){if(!this.ui.decalCtx)return;const a=t.radius.min+Math.random()*(t.radius.max-t.radius.min),s=t.density.min+Math.random()*(t.density.max-t.density.min),o=t.opacity.min+Math.random()*(t.opacity.max-t.opacity.min),n=Math.floor(a*a*Math.PI*s);this.ui.decalCtx.save(),this.ui.decalCtx.globalCompositeOperation="source-over";for(let s=0;s<n;s++){const s=Math.random()*Math.PI*2,n=Math.random()*a,l=e.x+Math.cos(s)*n,h=e.y+Math.sin(s)*n;if(l<0||l>=i||h<0||h>=r)continue;const d=t.colors[Math.floor(Math.random()*t.colors.length)],m=this.utility.hexToRgb(d);if(!m)continue;const c=o+(Math.random()-.5)*t.variation,y=Math.max(.05,Math.min(.6,c));this.ui.decalCtx.fillStyle=`rgba(${m.r}, ${m.g}, ${m.b}, ${y})`,this.ui.decalCtx.fillRect(Math.floor(l),Math.floor(h),1,1)}this.ui.decalCtx.restore()}generateImageDecal(e,t){if(!this.ui.decalCtx)return;let a=new Image;a.src=t.src;const s=()=>{if(!this.ui.decalCtx)return;if(!a.complete||0===a.naturalWidth)return;this.ui.decalCtx.save(),this.ui.decalCtx.translate(e.x,e.y),this.ui.decalCtx.rotate(t.rotation);const s=32*t.scale;this.ui.decalCtx.drawImage(a,-s/2,-s/2,s,s),this.ui.decalCtx.restore()};a.complete?s():a.onload=s}bakeDecals(){if(!this.ui.decalCtx)return;const e=this.ui.decalCtx.getImageData(0,0,i,r);if(this.staticDecalData)for(let t=0;t<e.data.length;t+=4){const a=e.data[t+3];if(a>0){const s=a/255,i=this.staticDecalData.data[t+3]/255;this.staticDecalData.data[t]=e.data[t]*s+this.staticDecalData.data[t]*i*(1-s),this.staticDecalData.data[t+1]=e.data[t+1]*s+this.staticDecalData.data[t+1]*i*(1-s),this.staticDecalData.data[t+2]=e.data[t+2]*s+this.staticDecalData.data[t+2]*i*(1-s),this.staticDecalData.data[t+3]=Math.min(255,a+this.staticDecalData.data[t+3])}}else this.staticDecalData=e;this.dynamicDecals.clear(),this.ui.decalCtx.clearRect(0,0,i,r)}renderBakedDecals(){this.staticDecalData&&this.ui.decalCtx&&this.ui.decalCtx.putImageData(this.staticDecalData,0,0)}spawnMagazineDecal(){setTimeout(()=>{const e=this.playerState.myPlayer.actions.primary.magazine.currentAmmo,t=e>0?this.charConfig.magazine.glock.full:this.charConfig.magazine.glock.empty,a=this.utility.getRandomNum(0,2*Math.PI),s=this.utility.getRandomNum(8,24),i=this.playerState.myPlayer.transform.pos.x+Math.cos(a)*s,r=this.playerState.myPlayer.transform.pos.y+Math.sin(a)*s,o=this.utility.getRandomNum(0,2*Math.PI),n=this.utility.getRandomNum(.65,.75),l={id:`magazine_${this.userId}_${Date.now()}`,pos:{x:i,y:r},type:"image",image:{src:t,scale:n,rotation:o}};this.createDecal(l),console.log(`Spawned ${e>0?"full":"empty"} magazine at reload`)},150)}}class M{constructor(e,t,a,s,i,r,o,n,l,h){this.animator=e,this.camera=t,this.chatManager=a,this.controlsManager=s,this.gameState=i,this.roomController=r,this.playerState=o,this.settingsManager=n,this.ui=l,this.userId=h}initEventListeners(){this.ui.canvas&&this.ui.hostButton&&this.ui.joinButton&&this.ui.quickplayButton&&this.ui.lobbyLeaveButton&&this.ui.lobbyCodeButton&&this.ui.gameLeaveButton&&this.ui.gameCodeButton&&this.ui.startGameBtn&&this.ui.chatSendBtn&&this.ui.chatInput&&(this.ui.hostButton.addEventListener("click",()=>this.roomController.hostRoom()),this.ui.joinButton.addEventListener("click",()=>this.roomController.joinRoom()),this.ui.quickplayButton.addEventListener("click",()=>this.roomController.quickPlay()),this.ui.lobbyLeaveButton.addEventListener("click",()=>this.roomController.leaveRoom()),this.ui.lobbyCodeButton.addEventListener("click",()=>this.roomController.copyRoomCode()),this.ui.gameLeaveButton.addEventListener("click",()=>this.roomController.leaveRoom()),this.ui.gameCodeButton.addEventListener("click",()=>this.roomController.copyRoomCode()),this.ui.startGameBtn.addEventListener("click",()=>this.onStartButtonClick()),this.ui.chatSendBtn.addEventListener("click",()=>this.chatManager.sendChatMessage(this.userId)),this.ui.chatInput.addEventListener("keypress",e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.chatManager.sendChatMessage(this.userId))}),this.ui.chatInput.addEventListener("focus",()=>{this.controlsManager.clearActiveKeys(),this.playerState.canShoot=!1,this.playerState.isSprinting=!1,this.playerState.isDashing=!1,this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0}),this.ui.chatInput.addEventListener("blur",()=>{this.controlsManager.clearActiveKeys(),this.playerState.canShoot=!0,this.playerState.isSprinting=!1,this.playerState.isDashing=!1}),this.ui.settingsButton?.addEventListener("click",()=>{this.ui.showSettingsPage()}),this.ui.settingsCloseButton?.addEventListener("click",()=>{this.ui.hideSettingsPage()}),window.addEventListener("contextmenu",e=>{e.preventDefault()}),document.addEventListener("keydown",e=>this.onKeyDown(e)),document.addEventListener("keyup",e=>this.onKeyUp(e)),document.addEventListener("mouseup",e=>this.onMouseUp(e)),document.addEventListener("mousemove",e=>this.onMouseMove(e)),this.ui.canvas.addEventListener("mousedown",e=>this.onMouseDown(e)),this.ui.switchSettingsPage("sound"),this.ui.controlsTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("controls")}),this.ui.graphicsTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("graphics")}),this.ui.soundTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("sound")}),this.ui.controlsBody?.addEventListener("click",()=>{this.ui.controlsBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("controls")}),this.ui.graphicsBody?.addEventListener("click",()=>{this.ui.graphicsBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("graphics")}),this.ui.soundBody?.addEventListener("click",()=>{this.ui.soundBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("sound")}),this.initSettingsAudioSliders(),this.initSettingsInputListeners(),this.initSettingsToggleListeners())}onKeyDown(e){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress||this.gameState.isPaused)return;const t=e.key.toLowerCase(),a=this.settingsManager.getSettings().controls.keybinds;Object.values(a).includes(t)&&(e.preventDefault(),this.controlsManager.addKey(t))}onKeyUp(e){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress)return;const t=e.key.toLowerCase(),a=this.settingsManager.getSettings().controls.keybinds;Object.values(a).includes(t)&&(e.preventDefault(),this.controlsManager.removeKey(t))}onMouseDown(e){this.ui.chatInput!==document.activeElement&&this.gameState.gameInProgress&&!this.gameState.isPaused&&this.ui.canvas&&(0===e.button?(this.updateMouse(e),this.controlsManager.addKey("mouse1")):1===e.button?this.controlsManager.addKey("mouse3"):2===e.button&&(this.updateMouse(e),this.controlsManager.addKey("mouse2")))}onMouseUp(e){this.ui.chatInput!==document.activeElement&&this.gameState.gameInProgress&&(0===e.button?this.controlsManager.removeKey("mouse1"):1===e.button?this.controlsManager.addKey("mouse3"):2===e.button&&this.controlsManager.removeKey("mouse2"))}onMouseMove(e){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress||this.gameState.isPaused)return;this.updateMouse(e);const t=this.controlsManager.getMousePos(),a=this.camera.screenToWorld(t),s=a.x-this.playerState.myPlayer.transform.pos.x,i=a.y-this.playerState.myPlayer.transform.pos.y,r=Math.sqrt(s*s+i*i),o=Math.atan2(i,s)+Math.PI/2;let n=1;r<100&&(n=.1+r/100*.9);const l=this.playerState.myPlayer.transform.rot,h=l+(o-l)*n;this.animator.rotateCharacterPart(this.userId,h)}updateMouse(e){if(this.ui.chatInput===document.activeElement)return;if(!this.ui.canvas)return;const t=this.ui.canvas.getBoundingClientRect(),a=e.clientX-t.left,s=e.clientY-t.top;this.controlsManager.setMousePos({x:a,y:s})}onStartButtonClick(){const e=new CustomEvent("customEvent_startGame");window.dispatchEvent(e)}initSettingsAudioSliders(){[{slider:this.ui.masterSlider,fill:this.ui.masterFill,value:this.ui.masterValue,channel:"master"},{slider:this.ui.interfaceSlider,fill:this.ui.interfaceFill,value:this.ui.interfaceValue,channel:"interface"},{slider:this.ui.musicSlider,fill:this.ui.musicFill,value:this.ui.musicValue,channel:"music"},{slider:this.ui.sfxSlider,fill:this.ui.sfxFill,value:this.ui.sfxValue,channel:"sfx"},{slider:this.ui.voiceSlider,fill:this.ui.voiceFill,value:this.ui.voiceValue,channel:"voice"}].forEach(({slider:e,fill:t,value:a,channel:s})=>{e&&t&&a&&e.addEventListener("mousedown",i=>{const r=i=>{const r=this.ui.calculateSliderValue(e,i.clientX);this.ui.updateSettingsSlider(t,a,r),this.settingsManager.updateSettings({audio:{mixer:{[s]:r}}})},o=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",o)};r(i),document.addEventListener("mousemove",r),document.addEventListener("mouseup",o),i.preventDefault()})})}initSettingsInputListeners(){[{input:this.ui.deadzoneInput,settingPath:"controls.gamepad.deadzone",parse:parseFloat}].forEach(({input:e,settingPath:t,parse:a})=>{e&&e.addEventListener("change",()=>{const s=e.value,i=a(s);if(isNaN(i))return;const r=t.split("."),o={};let n=o;for(let e=0;e<r.length-1;e++)n[r[e]]={},n=n[r[e]];n[r[r.length-1]]=i,this.settingsManager.updateSettings(o)})})}initSettingsToggleListeners(){[{toggle:this.ui.particleJSToggle,settingPath:"graphics.renderBackgroundParticles"},{toggle:this.ui.staticVfxToggle,settingPath:"graphics.showStaticOverlay"},{toggle:this.ui.ammoReservesPhysicsToggle,settingPath:"graphics.physics.ammoReserves"}].forEach(({toggle:e,settingPath:t})=>{e&&e.addEventListener("click",()=>{const a=!("true"===e.getAttribute("aria-checked"));a?(e.setAttribute("checked","true"),e.setAttribute("aria-checked","true")):(e.removeAttribute("checked"),e.setAttribute("aria-checked","false"));const s=t.split("."),i={};let r=i;for(let e=0;e<s.length-1;e++)r[s[e]]={},r=r[s[e]];r[s[s.length-1]]=a,this.settingsManager.updateSettings(i)})})}initKeybindListeners(){const e=this.settingsManager.getSettings().controls;this.ui.initKeybindsInterface(e,(e,t,a)=>this.onBindingChange(e,t,a))}onBindingChange(e,t,a){if("keybind"===t){this.settingsManager.updateSettings({controls:{keybinds:{[e]:a}}});const t=document.getElementById(`${e}Keybind`);t&&(t.textContent=" "===a?"SPACE":a.toUpperCase())}else{this.settingsManager.updateSettings({controls:{gamepad:{[e]:a}}});const t=document.getElementById(`${e}Gamepad`);if(t){const e=Object.keys(h).find(e=>"number"==typeof h[e]&&h[e]===a);t.textContent=e||a.toString()}}}}class P{constructor(){this.isPaused=!1,this.gameInProgress=!1,this.gameMaxWins=d.MAX_WINS,this.gameMaxPlayers=d.MAX_PLAYERS}}class I{constructor(e,t,a,s,i,r){this.characterManager=e,this.playerConfig=t,this.playerState=a,this.roomManager=s,this.ui=i,this.utility=r,this.inLobby=!1,this.lobbyPlayers=new Map,this.charCustomizeHandlers=[]}showLobbyControls(e){const{lobby:t,lobbyOptions:a,myPlayer:s,roomId:i,userId:r}=e,{isHost:o,maxWins:n,privateRoom:l,upgradesEnabled:h}=a;this.ui.updateDisplay(t,"lobby",i);const d=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,m=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyPlayers.set(r,{id:r,color:s.color,isHost:o,rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon},transform:{pos:{x:d,y:m},rot:0}}),this.setupLobbyOptions(a);const c={inputId:"winsInput",value:n},y={toggleId:"privateToggle",value:l},u={toggleId:"upgradesToggle",value:h};this.utility.setToggle(y),this.utility.setToggle(u),this.utility.setInput(c),this.ui.displayLobbyPlayers(o,t,r),this.ui.updateHostDisplay(o,t),window.dispatchEvent(new CustomEvent("customEvent_renderCharacter")),this.setupCharacterCustomization()}setupLobbyOptions(e){this.setupLobbyToggle("privateToggle",e.isHost,"privateRoom",()=>e.privateRoom,t=>e.privateRoom=t),this.setupLobbyToggle("upgradesToggle",e.isHost,"upgradesEnabled",()=>e.upgradesEnabled,t=>e.upgradesEnabled=t),this.setupLobbyInput("winsInput",e.isHost,"maxWins",()=>e.maxWins,t=>e.maxWins=t),this.setupLobbyInput("playersInput",e.isHost,"maxPlayers",()=>e.maxPlayers,t=>e.maxPlayers=t)}setupLobbyToggle(e,t,a,s,i){const r=this.ui[e];if(!r)return;const o=`${e}Handler`;this[o]&&r.removeEventListener("click",this[o]);const n=()=>{if(!t)return;const r=!s();i(r);const o={toggleId:e,value:r};this.utility.setToggle(o),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",[a]:r})),console.log(`${a} changed to: ${r}`)};this[o]=n,r.addEventListener("click",n)}setupLobbyInput(e,t,a,s,i){const r=this.ui[e];if(!r)return;const o=`${e}Handler`;this[o]&&r.removeEventListener("change",this[o]);const n=()=>{if(!t)return;const o=parseInt(r.value);if(isNaN(o)||o<1)return void(r.value=s().toString());i(o);const n={inputId:e,value:o};this.utility.setInput(n),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",[a]:o})),console.log(`${a} changed to: ${o}`)};this[o]=n,r.addEventListener("change",n)}syncLobbyOptions(e){this.syncOption(e,"privateRoom","isPrivateRoom","privateToggle",this.utility.setToggle.bind(this.utility),"Lobby privacy",e=>e?"Private":"Public"),this.syncOption(e,"maxWins","gameMaxWins","winsInput",this.utility.setInput.bind(this.utility),"Game max wins"),this.syncOption(e,"maxPlayers","gameMaxPlayers","playersInput",this.utility.setInput.bind(this.utility),"Game max players"),this.syncOption(e,"upgradesEnabled","isUpgradesEnabled","upgradesToggle",this.utility.setToggle.bind(this.utility),"Game upgrades toggled")}syncOption(e,t,a,s,i,r,o){if(void 0===e[t])return;this[a]=e[t],i(s.includes("Input")?{inputId:s,value:e[t]}:{toggleId:s,value:e[t]});const n=o?o(e[t]):e[t];console.log(`${r} synced to: ${n}`)}promotePlayer(e){this.roomManager.sendMessage(JSON.stringify({type:"promote-player",targetPlayerId:e}))}kickPlayer(e){this.roomManager.sendMessage(JSON.stringify({type:"kick-player",targetPlayerId:e}))}setupCharacterCustomization(){if(!(this.ui.bodyArrowLeft&&this.ui.bodyArrowRight&&this.ui.headArrowLeft&&this.ui.headArrowRight&&this.ui.headwearArrowLeft&&this.ui.headwearArrowRight))return;if(!this.lobbyPlayers.get(this.playerState.myPlayer.id))return;this.charCustomizeHandlers.forEach(({element:e,handler:t})=>{e.removeEventListener("click",t)}),this.charCustomizeHandlers=[];const e=(e,t)=>{this.charCustomizeHandlers.push({element:e,handler:t}),e.addEventListener("click",t)};e(this.ui.bodyArrowLeft,()=>this.cycleRigVariant("body",-1)),e(this.ui.bodyArrowRight,()=>this.cycleRigVariant("body",1)),e(this.ui.headArrowLeft,()=>this.cycleRigVariant("head",-1)),e(this.ui.headArrowRight,()=>this.cycleRigVariant("head",1)),e(this.ui.headwearArrowLeft,()=>this.cycleRigVariant("headwear",-1)),e(this.ui.headwearArrowRight,()=>this.cycleRigVariant("headwear",1))}cycleRigVariant(e,t){const a=this.lobbyPlayers.get(this.playerState.myPlayer.id);if(!a)return;const s=Object.keys(this.characterManager.charConfig[e]),i=a.rig[e];let r=s.indexOf(i)+t;r<0?r=s.length-1:r>=s.length&&(r=0),a.rig[e]=s[r],window.dispatchEvent(new CustomEvent("customEvent_renderCharacter"))}}class k{constructor(){this.particles={blood:{drip:{count:{min:1,max:4},lifetime:{min:800,max:1e3},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.25,max:.75},speed:{min:.25,max:.75},sizeOverLifetime:{min:0,max:0},size:{min:.125,max:2.275},torque:{min:-720,max:720},collide:!0,fade:!0,paint:!1,spread:.25,stain:!0,colors:["#690303","#820c0c","#a70707"]},spray:{count:{min:4,max:12},lifetime:{min:150,max:1200},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.425,max:.775},speed:{min:1.5,max:4.75},sizeOverLifetime:{min:0,max:0},size:{min:.75,max:3.5},torque:{min:-720,max:720},collide:!0,fade:!1,paint:!0,spread:.425,stain:!0,colors:["#7e0a0a","#941414","#b51a1a"]}},glock:{muzzle:{smoke:{count:{min:3,max:6},lifetime:{min:800,max:1400},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.15,max:.35},speed:{min:.5,max:1.5},size:{min:4,max:8},sizeOverLifetime:{min:2,max:3},torque:{min:-180,max:180},collide:!1,fade:!0,paint:!1,spread:.4,stain:!1,colors:["#5a5a5a","#7a7a7a"]},flash:{count:{min:8,max:15},lifetime:{min:150,max:300},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.4,max:.8},speed:{min:4,max:10},sizeOverLifetime:{min:0,max:0},size:{min:1,max:3},torque:{min:0,max:0},collide:!1,fade:!0,paint:!1,spread:.6,stain:!1,colors:["#ffaa00","#f3b02a","#edbe60"]}},projectile:{shell:{count:{min:1,max:1},lifetime:{min:250,max:550},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:1,max:1},speed:{min:5,max:8},sizeOverLifetime:{min:0,max:0},size:{min:2,max:2},torque:{min:-720,max:720},collide:!0,fade:!1,paint:!0,spread:.4,stain:!1,colors:["#d4af37","#c69e1c","#dcb01f"]},sparks:{count:{min:8,max:16},lifetime:{min:150,max:300},noise:{strength:{min:.25,max:5},scale:{min:.25,max:1.5}},opacity:{min:.4,max:.8},speed:{min:4,max:10},size:{min:1,max:3},sizeOverLifetime:{min:0,max:0},torque:{min:-720,max:720},collide:!1,fade:!0,paint:!1,spread:.6,stain:!1,colors:["#ffaa00","#ffcf70","#f9dea7"]}}}}}}class E{constructor(e,t,a,s,i,r,o,n,l,h){this.camera=e,this.charConfig=t,this.collisionsManager=a,this.decalsManager=s,this.playerState=i,this.renderingManager=r,this.roomManager=o,this.ui=n,this.userId=l,this.utility=h,this.particles=new Map,this.emitters=new Map,this.shrapnel=new Map,this.particlesConfig=new k}createParticles(e){this.generateParticles(e),this.roomManager.sendMessage(JSON.stringify({type:"add-particles",params:e}))}createParticlesNetwork(e){this.particles.has(e.id)||this.generateParticles(e)}generateParticles(e){const t=e.particleParams,a=Math.floor(this.utility.getRandomNum(t.count.min,t.count.max));for(let s=0;s<a;s++){const a=this.utility.getRandomNum(t.lifetime.min,t.lifetime.max),i=this.utility.getRandomNum(t.speed.min,t.speed.max),r=this.utility.getRandomNum(t.size.min,t.size.max),o=this.utility.getRandomNum(t.opacity.min,t.opacity.max),n=this.utility.getRandomNum(t.torque.min,t.torque.max),l=this.utility.getRandomNum(t.noise.strength.min,t.noise.strength.max),h=this.utility.getRandomNum(t.noise.scale.min,t.noise.scale.max),d=this.utility.getRandomNum(t.sizeOverLifetime.min,t.sizeOverLifetime.max),m=this.utility.getRandomInArray(t.colors);let c;c=e.direction?Math.atan2(e.direction.y,e.direction.x)+(this.utility.getRandomNum(0,1)-.5)*t.spread:this.utility.getRandomNum(0,2*Math.PI);const y={age:0,collide:t.collide,color:m,fade:t.fade,hasCollided:!1,id:`${e.id}_${s}`,initialSize:r,lifetime:a,maxOpacity:o,noiseScale:h,noiseStrength:l,opacity:o,paint:t.paint,pos:{x:e.pos.x,y:e.pos.y},size:r,stain:t.stain,torque:n,rotation:this.utility.getRandomNum(0,2*Math.PI),sizeOverLifetime:d,velocity:{x:Math.cos(c)*i,y:Math.sin(c)*i}};this.particles.set(y.id,y)}}updateParticles(e){const t=[];this.particles.forEach((a,s)=>{if(a.noiseStrength>0&&a.noiseScale>0){const t=.001*Date.now(),s=this.utility.simplexNoise2D(a.pos.x/a.noiseScale,t),i=this.utility.simplexNoise2D(a.pos.y/a.noiseScale,t+100);a.velocity.x+=s*a.noiseStrength*e,a.velocity.y+=i*a.noiseStrength*e}if(a.sizeOverLifetime>0){const e=a.age/a.lifetime;a.size=a.initialSize*(1+e*a.sizeOverLifetime)}if(a.pos.x+=a.velocity.x*e,a.pos.y+=a.velocity.y*e,a.age+=16.67*e,a.rotation+=a.torque*Math.PI/180*e,a.fade){const e=a.age/a.lifetime;a.opacity=a.maxOpacity*(1-e)}if(a.hasCollided&&a.stain){this.stampParticle(a);const e=(a.age-(a.lifetime-.5*a.lifetime))/(.5*a.lifetime);e>0&&(a.size=Math.max(.5,a.size*(1-.1*e)),a.opacity=a.opacity*(1-e))}if(a.age>=a.lifetime||a.pos.x<-10||a.pos.x>3210||a.pos.y<-10||a.pos.y>2410){if(a.collide&&a.age>=a.lifetime&&a.pos.x>=0&&a.pos.x<=i&&a.pos.y>=0&&a.pos.y<=r&&!a.hasCollided){a.hasCollided=!0;const e=.875+.1*Math.random();a.velocity.x*=1-e,a.velocity.y*=1-e;const t=.5*a.lifetime;return void(a.lifetime+=t)}a.paint&&!a.stain&&a.age>=a.lifetime&&a.pos.x>=0&&a.pos.x<=i&&a.pos.y>=0&&a.pos.y<=r&&this.stampParticle(a),t.push(s)}}),t.forEach(e=>this.particles.delete(e))}drawParticles(){this.ui.ctx&&this.particles.forEach(e=>{if(!this.camera.isVisible(e.pos))return;const t=this.camera.worldToScreen(e.pos),a=this.utility.hexToRgb(e.color);a&&this.ui.ctx&&(this.ui.ctx.save(),this.ui.ctx.globalAlpha=e.opacity,0!==e.torque?(this.ui.ctx.translate(t.x+e.size/2,t.y+e.size/2),this.ui.ctx.rotate(e.rotation),this.ui.ctx.fillStyle=`rgb(${a.r}, ${a.g}, ${a.b})`,this.ui.ctx.fillRect(-e.size/2,-e.size/2,e.size,e.size)):(this.ui.ctx.fillStyle=`rgb(${a.r}, ${a.g}, ${a.b})`,this.ui.ctx.fillRect(Math.floor(t.x),Math.floor(t.y),e.size,e.size)),this.ui.ctx.restore())})}stampParticle(e){if(!this.ui.decalCtx)return;const t=this.utility.hexToRgb(e.color);if(!t)return;this.ui.decalCtx.save(),this.ui.decalCtx.globalCompositeOperation="source-over",0!==e.torque?(this.ui.decalCtx.translate(e.pos.x+e.size/2,e.pos.y+e.size/2),this.ui.decalCtx.rotate(e.rotation),this.ui.decalCtx.fillStyle=`rgba(${t.r}, ${t.g}, ${t.b}, ${e.opacity})`,this.ui.decalCtx.fillRect(-e.size/2,-e.size/2,e.size,e.size)):(this.ui.decalCtx.fillStyle=`rgba(${t.r}, ${t.g}, ${t.b}, ${e.opacity})`,this.ui.decalCtx.fillRect(Math.floor(e.pos.x),Math.floor(e.pos.y),e.size,e.size)),this.ui.decalCtx.restore();const a=`stamp_${Date.now()}`;this.decalsManager.dynamicDecals.set(a,{params:null,pos:{x:e.pos.x,y:e.pos.y}})}createEmitter(e){this.generateEmitter(e);const t={type:"particle-emitter",id:e.id,interval:e.interval,lifetime:e.lifetime,offset:{x:e.offset.x,y:e.offset.y},pos:{x:e.pos.x,y:e.pos.y},particleType:e.particleType,playerId:e.playerId};this.roomManager.sendMessage(JSON.stringify(t)),console.log(`Emitter created on ${e.playerId} for ${e.lifetime}ms`)}generateEmitter(e){const t=e.pos.x-e.offset.x,a=e.pos.y-e.offset.y,s=Math.atan2(a,t);this.emitters.set(e.id,{age:0,direction:s,emissionInterval:e.interval,lastEmission:0,lifetime:e.lifetime,offset:{x:t,y:a},particleType:e.particleType,playerId:e.playerId})}updateEmitters(e){const t=[];this.emitters.forEach((a,s)=>{a.age+=16.67*e;const i=a.playerId===this.userId?this.playerState.myPlayer:this.playerState.players.get(a.playerId);if(!i||i.stats.health.value<=0)return void t.push(s);const r=i.transform.pos.x+a.offset.x,o=i.transform.pos.y+a.offset.y;if(a.age>=a.lastEmission+a.emissionInterval){const e=.6*Math.PI,t=(Math.random()-.5)*e,i=a.direction+t,n=3,l=4*(Math.random()-.5),h=Math.max(.5,n+l),d={id:`emitter_particles_${s}_${a.age}`,pos:{x:r+8*(Math.random()-.5),y:o+8*(Math.random()-.5)},particleParams:a.particleType,direction:{x:Math.cos(i)*h,y:Math.sin(i)*h}};this.generateParticles(d),a.lastEmission=a.age,a.emissionInterval=120+180*Math.random()}if(a.age>=a.lifetime){const e={id:`emitter_decal_${s}`,pos:{x:r,y:o},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.blood};this.decalsManager.generateDecal(e),t.push(s)}}),t.forEach(e=>this.emitters.delete(e))}generateGore(e){const t=[...this.charConfig.characterDecals.default.gore];for(let a=0;a<e.gore.amount&&t.length>0;a++){const s=this.utility.getRandomInArray(t);t.splice(t.indexOf(s),1);const i=this.utility.getRandomNum(0,2*Math.PI),r=this.utility.getRandomNum(0,e.radius),o={type:"gore",src:s,transform:{pos:{x:e.pos.x+Math.cos(i)*r,y:e.pos.y+Math.sin(i)*r},rot:this.utility.getRandomNum(0,2*Math.PI)},scale:this.utility.getRandomNum(.65,1.05)},n=`death_gore_${e.ownerId}_${Date.now()}_${a}`;this.stampGore(o),this.decalsManager.dynamicDecals.set(n,{params:null,pos:{x:o.transform.pos.x,y:o.transform.pos.y}})}const a=[...this.charConfig.characterDecals.default.blood];for(let t=0;t<e.blood.amount&&a.length>0;t++){const s=this.utility.getRandomInArray(a);a.splice(a.indexOf(s),1);const i=this.utility.getRandomNum(0,2*Math.PI),r=this.utility.getRandomNum(0,.7*e.radius),o={type:"blood",src:s,transform:{pos:{x:e.pos.x+Math.cos(i)*r,y:e.pos.y+Math.sin(i)*r},rot:this.utility.getRandomNum(0,2*Math.PI)},scale:this.utility.getRandomNum(1.25,1.45)},n=`death_blood_${e.ownerId}_${Date.now()}_${t}`;this.stampGore(o),this.decalsManager.dynamicDecals.set(n,{params:null,pos:{x:o.transform.pos.x,y:o.transform.pos.y}})}}stampGore(e){if(!this.ui.decalCtx)return;if(!this.camera.isVisible(e.transform.pos))return;const t=this.camera.worldToScreen(e.transform.pos);let a=this.renderingManager.characterImages.get(e.src);if(!a&&(a=new Image,a.src=e.src,this.renderingManager.characterImages.set(e.src,a),!a.complete))return void(a.onload=()=>{this.stampGore(e)});if(!a.complete||0===a.naturalWidth)return;this.ui.decalCtx.save(),this.ui.decalCtx.translate(t.x,t.y),this.ui.decalCtx.rotate(e.transform.rot);const s=32*e.scale;this.ui.decalCtx.drawImage(a,-s/2,-s/2,s,s),this.ui.decalCtx.restore()}spawnShrapnel(t){const a=[];for(let s=0;s<t.amount;s++){const i=this.utility.getRandomNum(0,2*Math.PI),r=this.utility.getRandomNum(t.speed.min,t.speed.max),o=this.utility.getRandomNum(t.lifetime.min,t.lifetime.max),n=this.utility.getRandomNum(t.size.min,t.size.max),l=this.utility.getRandomNum(t.torque.min,t.torque.max)*(Math.PI/180),h={id:this.utility.generateUID(e),image:t.images[s],transform:{pos:{x:t.pos.x,y:t.pos.y},rot:this.utility.getRandomNum(0,2*Math.PI)},velocity:{x:Math.cos(i)*r,y:Math.sin(i)*r},rotationSpeed:l,size:n,age:0,lifetime:o,ownerId:this.userId,damage:t.damage};a.push(h),this.shrapnel.set(h.id,h)}this.roomManager.sendMessage(JSON.stringify({type:"shrapnel-spawn",pieces:a})),console.log(`Spawned ${a.length} shrapnel pieces`)}generateShrapnel(e){e.forEach(e=>{this.shrapnel.set(e.id,e)}),console.log(`Received ${e.length} shrapnel pieces from network`)}updateShrapnel(e){if(0===this.shrapnel.size)return;const t=[];this.shrapnel.forEach((a,s)=>{a.transform.pos.x+=a.velocity.x*e,a.transform.pos.y+=a.velocity.y*e,a.transform.rot+=a.rotationSpeed*e,a.age+=16.67*e,a.velocity.x*=.98,a.velocity.y*=.98,a.ownerId===this.userId&&this.playerState.players.forEach((e,i)=>{if(e.stats.health.value>0){const r=a.transform.pos.x-e.transform.pos.x,o=a.transform.pos.y-e.transform.pos.y;if(Math.sqrt(r*r+o*o)<=this.collisionsManager.getPlayerCollider(e,a.size)){const r=Math.max(0,a.damage-e.stats.defense),o=Math.max(0,e.stats.health.value-r);e.stats.health.value=o,t.push(s),console.log(`Shrapnel hit ${i} for ${a.damage} damage`);const n={target:e,shooterId:this.userId,damage:a.damage,newHealth:o,source:a,wasKill:o<=0};window.dispatchEvent(new CustomEvent("customEvent_playerHitRelay",{detail:{params:n}}))}}}),(a.age>=a.lifetime||a.transform.pos.x<0||a.transform.pos.x>i||a.transform.pos.y<0||a.transform.pos.y>r)&&(a.transform.pos.x>=0&&a.transform.pos.x<=i&&a.transform.pos.y>=0&&a.transform.pos.y<=r&&this.stampShrapnel(a),t.push(s))}),t.forEach(e=>this.shrapnel.delete(e))}drawShrapnel(){this.ui.ctx&&0!==this.shrapnel.size&&this.shrapnel.forEach(e=>{if(!this.ui.ctx)return;if(!this.camera.isVisible(e.transform.pos))return;const t=this.camera.worldToScreen(e.transform.pos);let a=this.renderingManager.characterImages.get(e.image);(a||(a=new Image,a.src=e.image,this.renderingManager.characterImages.set(e.image,a),a.complete))&&a.complete&&0!==a.naturalWidth&&(this.ui.ctx.save(),this.ui.ctx.translate(t.x,t.y),this.ui.ctx.rotate(e.transform.rot),this.ui.ctx.drawImage(a,-e.size/2,-e.size/2,e.size,e.size),this.ui.ctx.restore())})}stampShrapnel(e){if(!this.ui.decalCtx)return;if(!this.camera.isVisible(e.transform.pos))return;const t=this.camera.worldToScreen(e.transform.pos);let a=this.renderingManager.characterImages.get(e.image);a&&a.complete&&0!==a.naturalWidth&&(this.ui.decalCtx.save(),this.ui.decalCtx.translate(t.x,t.y),this.ui.decalCtx.rotate(e.transform.rot),this.ui.decalCtx.drawImage(a,-e.size/2,-e.size/2,e.size,e.size),this.ui.decalCtx.restore(),this.decalsManager.dynamicDecals.set(`shrapnel_${e.id}`,{params:null,pos:{x:e.transform.pos.x,y:e.transform.pos.y}}))}}class R{constructor(e,t,a,s,i,r,o,n){this.animator=e,this.camera=t,this.charManager=a,this.lobbyManager=s,this.objectsManager=i,this.playerConfig=r,this.ui=o,this.userId=n,this.characterImages=new Map,this.ammoBoxImages={},this.initEventListeners()}clearCtx(e){e?e.clearRect(0,0,n,l):this.ui.decalCtx&&this.ui.ctx&&(this.ui.ctx.clearRect(0,0,n,l),this.ui.decalCtx.clearRect(0,0,i,r))}drawCharacter(e){const{player:t,context:a}=e;if(a&&t){if("stats"in t){if(t.stats.health.value<=0)return;if(this.renderUniqueEffects(e),t.flags.hidden)return;if(!this.camera.isVisible(t.transform.pos))return;const s=this.camera.worldToScreen(t.transform.pos);a.fillStyle="#fff",a.font="12px Arial",a.textAlign="center";const i=t.id===this.userId?"You":t.id.substring(0,6);a.fillText(i,s.x,s.y-this.playerConfig.default.data.idOffset)}this.drawCharacterLayers(e)}}drawCharacterLayers(e){const t=e.player;t&&(this.drawCharacterLayer(e,"body",t.rig.body),this.drawCharacterLayer(e,"weapon",t.rig.weapon),this.drawCharacterLayer(e,"head",t.rig.head),this.drawCharacterLayer(e,"headwear",t.rig.headwear),"stats"in t&&this.drawUpgradeLayers(e))}drawCharacterLayer(e,t,a){if(!e)return;const s=this.charManager.getCharacterAsset(t,a);"string"==typeof s?this.drawCharacterPart(e,s,t):Array.isArray(s)&&s.forEach((a,s)=>{this.drawCharacterPart(e,a,t,s)})}drawCharacterPart(e,t,a,s){const{context:i,player:r}=e;if(!i||!r)return;let o=this.characterImages.get(t);if(!o&&(o=new Image,o.src=t,this.characterImages.set(t,o),o.onload=()=>{this.renderLobbyPlayer()},!o.complete))return;if(!o.complete||0===o.naturalWidth)return;const n="stats"in r?d.CHARACTER_SIZE*(r.stats.size/d.CHARACTER_SIZE):.35*d.CHARACTER_SIZE,l=r.transform?.pos?.x??0,h=r.transform?.pos?.y??0,m="stats"in r&&void 0!==r.transform.rot,c=m?this.camera.worldToScreen({x:l,y:h}).x:l,y=m?this.camera.worldToScreen({x:l,y:h}).y:h;if(i.save(),m){const e=`${r.id}_${a}_${s||0}`,t=this.animator.characterOffsets?.get(e)||{x:0,y:0};i.translate(c,y),i.rotate(r.transform.rot),i.translate(t.x,t.y),i.drawImage(o,-n/2,-n/2,n,n)}else i.drawImage(o,c-n/2,y-n/2,n,n);i.restore()}drawUpgradeLayers(e){const{player:t}=e;"unique"in t&&(t.unique.forEach(t=>{const a=this.charManager.getUpgradeVisual(t);a&&this.drawCharacterPart(e,a,"upgrades")}),t.equipment.forEach(t=>{const a=this.charManager.getUpgradeVisual(t);a&&this.drawCharacterPart(e,a,"upgrades")}))}renderUniqueEffects(e){const{player:t}=e;t&&"unique"in t&&t.unique.includes("spectral_image")&&this.renderSpectralImage(e)}renderSpectralImage(e){const{context:t,player:a}=e;if(!t||!a||!("stats"in a))return;const s=this._spectralGhosts??(this._spectralGhosts={lastHidden:new Map,flashes:[]}),i=Date.now(),r=s.lastHidden.get(a.id)??!1,o=a.flags.hidden;!r&&o&&s.flashes.push({x:a.transform.pos.x,y:a.transform.pos.y,t:i,type:"start",playerId:a.id}),r&&!o&&s.flashes.push({x:a.transform.pos.x,y:a.transform.pos.y,t:i,type:"end",playerId:a.id}),s.lastHidden.set(a.id,o);for(const e of s.flashes){if(e.playerId!==a.id)continue;const s=i-e.t;if(s>a.actions.dash.time)continue;const r=this.camera.worldToScreen({x:e.x,y:e.y}),o="start"===e.type?1-s/a.actions.dash.time:s/a.actions.dash.time;t.save(),t.globalAlpha=.8*o,t.globalCompositeOperation="difference",t.filter="saturate(100) contrast(2)";const n={...a,transform:{...a.transform,pos:{x:r.x,y:r.y}}};this.drawCharacterLayers({player:n,context:t}),t.restore()}}renderLobbyPlayer(){if(!this.lobbyManager.inLobby)return;const e=this.lobbyManager.lobbyPlayers.get(this.userId);if(!e||!this.ui.charCustomizeCanvas)return;const t=this.ui.charCustomizeCanvas.getContext("2d");t&&(t.clearRect(0,0,this.ui.charCustomizeCanvas.width,this.ui.charCustomizeCanvas.height),this.drawCharacter({player:e,context:t}))}drawObjects(){this.ui.ctx&&this.objectsManager.ammoBoxes.forEach(e=>{if(!this.ui.ctx)return;if(!this.camera.isVisible(e.transform.pos))return;this.ammoBoxImages||(this.ammoBoxImages={});const t=["BASE","BULLETS","LID"];if(t.forEach(e=>{if(!this.ammoBoxImages[e]){const t=new Image;t.src=s[e],this.ammoBoxImages[e]=t}}),!t.every(e=>this.ammoBoxImages[e]?.complete&&this.ammoBoxImages[e]?.naturalWidth>0))return;const a=35,i=this.camera.worldToScreen(e.transform.pos);e.isOpen&&(e.lid.velocity.x*=.85,e.lid.velocity.y*=.85,e.lid.torque*=.85,e.lid.pos.x+=e.lid.velocity.x,e.lid.pos.y+=e.lid.velocity.y,e.lid.rot+=e.lid.torque),this.ui.ctx.save(),this.ui.ctx.translate(i.x,i.y),this.ui.ctx.rotate(e.transform.rot||0),this.ui.ctx.drawImage(this.ammoBoxImages.BASE,-17.5,-17.5,a,a),e.isOpen||(this.ui.ctx.drawImage(this.ammoBoxImages.BULLETS,-17.5,-17.5,a,a),this.ui.ctx.drawImage(this.ammoBoxImages.LID,-17.5,-17.5,a,a)),this.ui.ctx.restore(),e.isOpen&&(this.ui.ctx.save(),this.ui.ctx.translate(i.x+e.lid.pos.x,i.y+e.lid.pos.y),this.ui.ctx.rotate((e.transform.rot||0)+e.lid.rot),this.ui.ctx.drawImage(this.ammoBoxImages.LID,-17.5,-17.5,a,a),this.ui.ctx.restore())})}drawProjectile(e){if(!this.ui.ctx)return;if(!this.camera.isVisible(e.transform.pos))return;const t=this.camera.worldToScreen(e.transform.pos),a=Math.sqrt(e.velocity.x*e.velocity.x+e.velocity.y*e.velocity.y),s=e.velocity.x/a,i=e.velocity.y/a,r=t.x+s*(e.length/2),o=t.y+i*(e.length/2),n=t.x-s*(e.length/2),l=t.y-i*(e.length/2);this.ui.ctx.fillStyle=e.color,this.ui.ctx.strokeStyle=e.color,this.ui.ctx.lineWidth=e.size,this.ui.ctx.lineCap="round",this.ui.ctx.beginPath(),this.ui.ctx.moveTo(n,l),this.ui.ctx.lineTo(r,o),this.ui.ctx.stroke()}initEventListeners(){window.addEventListener("customEvent_renderCharacter",()=>this.renderLobbyPlayer())}}class B{constructor(e,t,a,s,i,r,o,n,l){this.gameState=e,this.lobbyManager=t,this.playerState=a,this.roomManager=s,this.ui=i,this.upgradeManager=r,this.userId=o,this.utility=n,this.wsManager=l}showRoomControls(){this.ui.updateDisplay(this.lobbyManager,"room")}hostRoom(){if(this.wsManager.getWebSocket()){const e=this.roomManager.createRoom();if(!e)return;this.playerState.isHost=!0,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:e,userId:this.userId})}else this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{const e=this.roomManager.createRoom();e&&(this.playerState.isHost=!0,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:e,userId:this.userId}))},d.CONNECTION_TIMEOUT)}joinRoom(){this.ui.showJoinRoomModal(e=>{this.joinRoomById(e)})}joinRoomById(e){e&&(this.wsManager.getWebSocket()?this.roomManager.joinRoom(e):(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(e)},d.CONNECTION_TIMEOUT)))}quickPlay(){fetch("/quickplay").then(e=>{if(!e.ok)throw new Error("No available rooms");return e.json()}).then(e=>{this.wsManager.getWebSocket()?this.roomManager.joinRoom(e.roomId):(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(e.roomId)},d.CONNECTION_TIMEOUT))}).catch(e=>{this.ui.modal&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalContent&&this.ui.modalText&&this.ui.modalInput&&this.ui.modalErrorDiv&&this.ui.modalButtons&&(this.ui.modal.classList.remove("hidden"),this.ui.modalInput.style.display="none",this.ui.modalErrorDiv.textContent=" ",this.ui.modalButtons.style.display="flex",this.ui.modalCancelButton.style.display="none",this.ui.modalText.textContent="No available games found.",this.ui.modalConfirmButton.textContent="Confirm",this.ui.modalConfirmButton.onclick=()=>{this.ui.modal&&this.ui.modalInput&&this.ui.modalCancelButton&&this.ui.modalText&&this.ui.modalConfirmButton&&(this.ui.modal.classList.add("hidden"),this.ui.modalInput.style.display="flex",this.ui.modalText.textContent="Join Room",this.ui.modalCancelButton.style.display="flex",this.ui.modalConfirmButton.onclick=null)})})}leaveRoom(){this.roomManager.leaveRoom(),window.dispatchEvent(new CustomEvent("customEvent_resetGameState",{detail:{resetType:"Room"}})),this.showRoomControls()}checkForRoomInURL(){const e=this.getRoomIdFromURL();e&&(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(e)},d.CONNECTION_TIMEOUT))}getRoomIdFromURL(){return new URLSearchParams(window.location.search).get("room")}copyRoomCode(){const e=this.lobbyManager.inLobby?this.ui.roomIdDisplay?.textContent:this.ui.gameRoomIdDisplay?.textContent;e&&navigator.clipboard.writeText(e).then(()=>{if(!(this.ui.modal&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalContent&&this.ui.modalText&&this.ui.modalInput&&this.ui.modalErrorDiv&&this.ui.modalButtons))return;this.ui.modal.classList.remove("hidden"),this.ui.modalInput.style.display="none",this.ui.modalErrorDiv.textContent=" ",this.ui.modalButtons.style.display="flex",this.ui.modalCancelButton.style.display="none",this.ui.modalText.textContent="Room code copied!",this.ui.modalConfirmButton.textContent="Confirm";const e=()=>{this.ui.modal&&this.ui.modalInput&&this.ui.modalCancelButton&&this.ui.modalText&&this.ui.modalConfirmButton&&(this.ui.modal.classList.add("hidden"),this.ui.modalInput.style.display="flex",this.ui.modalText.textContent="Join Room",this.ui.modalCancelButton.style.display="flex",this.ui.modalConfirmButton.onclick=null)};this.ui.modalConfirmButton.onclick=e,this.utility.safeTimeout(()=>{this.ui.modal&&!this.ui.modal.classList.contains("hidden")&&e()},3e3)}).catch(()=>{alert("Could not copy. Please copy manually.")})}}class T{constructor(e,t){this.userId=e,this.utility=t,this.currentRoom=null,this.ws=null,this.messageHandlers=[],this.isPrivateRoom=!1}setWebSocket(e){this.ws=e,this.setupMessageHandler()}createRoom(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return alert("Cannot create room: Not connected to server. Please refresh the page."),null;const e=this.utility.generateUID(10,"room_");return this.joinRoom(e,!0),e}joinRoom(e,t=!1){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void alert("Cannot join room: Not connected to server. Please refresh the page.");const a={type:t?"create-room":"join-room",roomId:e,userId:this.userId};this.ws.send(JSON.stringify(a)),this.currentRoom=e,this.utility.generateLink(e,"room")}leaveRoom(){if(!this.currentRoom||!this.ws)return;const e={type:"leave-room",roomId:this.currentRoom,userId:this.userId};this.ws.send(JSON.stringify(e)),this.currentRoom=null,window.history.pushState({},"",window.location.origin)}sendMessage(e){if(!this.currentRoom||!this.ws)return;if(this.ws.readyState!==WebSocket.OPEN)return void alert("Cannot send message: Not connected to server. Please refresh the page.");const t={type:"room-message",roomId:this.currentRoom,userId:this.userId,message:e};this.ws.send(JSON.stringify(t))}sendAdminCommand(e,t){if(!this.ws)return;const a={type:"admin-command",id:e,key:t,userId:this.userId};this.ws.send(JSON.stringify(a))}getCurrentRoom(){return this.currentRoom}getRoomLink(e){return this.currentRoom?this.utility.generateLink(this.currentRoom,e):null}onMessage(e){this.messageHandlers.push(e)}setupMessageHandler(){this.ws&&(this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);this.messageHandlers.forEach(e=>e(t))}catch(t){const a={type:"room-message",userId:"server",message:e.data};this.messageHandlers.forEach(e=>e(a))}})}}class L{constructor(e,t){this.audioConfig=e,this.cacheManager=t,this.gameSettings=this.initSettings()}initSettings(){return{audio:{mixer:{master:this.audioConfig.mixer.master,interface:this.audioConfig.mixer.interface,music:this.audioConfig.mixer.music,sfx:this.audioConfig.mixer.sfx,voice:this.audioConfig.mixer.voice}},controls:{keybinds:{attack:d.CONTROLS.KEYBINDS.ATTACK,dash:d.CONTROLS.KEYBINDS.DASH,melee:d.CONTROLS.KEYBINDS.MELEE,moveDown:d.CONTROLS.KEYBINDS.MOVE_DOWN,moveLeft:d.CONTROLS.KEYBINDS.MOVE_LEFT,moveRight:d.CONTROLS.KEYBINDS.MOVE_RIGHT,moveUp:d.CONTROLS.KEYBINDS.MOVE_UP,reload:d.CONTROLS.KEYBINDS.RELOAD,sprint:d.CONTROLS.KEYBINDS.SPRINT},gamepad:{attack:d.CONTROLS.GAMEPAD.ATTACK,dash:d.CONTROLS.GAMEPAD.DASH,deadzone:d.CONTROLS.GAMEPAD.DEADZONE,melee:d.CONTROLS.GAMEPAD.MELEE,reload:d.CONTROLS.GAMEPAD.RELOAD,sprint:d.CONTROLS.GAMEPAD.SPRINT}},graphics:{physics:{ammoReserves:d.GRAPHICS.PHYSICS.AMMORESERVES},renderBackgroundParticles:d.GRAPHICS.BACKGROUND_PARTICLES,showStaticOverlay:d.GRAPHICS.STATIC_OVERLAY}}}getSettings(){return this.gameSettings}updateSettings(e){const t=(e,a)=>{for(const s in a)a[s]&&"object"==typeof a[s]&&!Array.isArray(a[s])?(e[s]||(e[s]={}),t(e[s],a[s])):e[s]=a[s]};t(this.gameSettings,e),this.cacheManager.write("gameSettings",this.gameSettings)}async loadSettings(){const e=await this.cacheManager.read("gameSettings");e&&(this.gameSettings=e)}}var A=a(152);const D={equipment:["switch"],resource:["carepackage"],stats:["bioregulator","damagebuffer","hemoglobinsaturator","locomotionmodule"],unique:["clustermodule","kineticbrain","muzzlesplitter","phoenixmodule","projectilearray","spatialtargeting","spectralimage"]};class _{constructor(e,t,a,s){this.playerConfig=e,this.playerState=t,this.ui=a,this.utility=s,this.takenUniques=new Set,this.upgradesCompleted=new Set,this.isUpgradesEnabled=!0,this.rarityConfig={[A._8.COMMON]:{weight:35,color:"#7e7e7e"},[A._8.UNCOMMON]:{weight:20,color:"#61b6d5"},[A._8.SPECIAL]:{weight:15,color:"#58d688"},[A._8.SUPERIOR]:{weight:12,color:"#ffc233"},[A._8.RARE]:{weight:8,color:"#0077ff"},[A._8.EXCEPTIONAL]:{weight:5,color:"#00ff62"},[A._8.LEGENDARY]:{weight:2.5,color:"#f6ff00"},[A._8.MYTHICAL]:{weight:1.5,color:"#ff0000"},[A._8.ENLIGHTENED]:{weight:.9,color:"#9500ff"},[A._8.HOLY]:{weight:.1,color:"#ff00f7"}},this.upgrades=[],this.initUpgrades()}initUpgrades(){const e={playerState:this.playerState,ui:this.ui,utility:this.utility};D.equipment.forEach(t=>{const s=a(854)(`./${t}/${t}`).create(e);this.upgrades.push(s)}),D.resource.forEach(t=>{const s=a(136)(`./${t}/${t}`).create(e);this.upgrades.push(s)}),D.stats.forEach(t=>{const s=a(823)(`./${t}/${t}`).create(e);this.upgrades.push(s)}),D.unique.forEach(t=>{const s=a(65)(`./${t}/${t}`).create(e);this.upgrades.push(s)})}getUpgrades(e,t){const a=this.upgrades.filter(e=>!(e.unique&&this.takenUniques.has(e.id)||e.type===A.Tq.EQUIPMENT&&t.equipment.includes(e.id))),s=[];for(let t=0;t<Math.min(e,a.length)&&0!==a.length;t++){const e=a.reduce((e,t)=>e+this.getRarityWeight(t.rarity),0);let t=Math.random()*e,i=null;for(const e of a)if(t-=this.getRarityWeight(e.rarity),t<=0){i=e;break}if(i){s.push(i);const e=a.indexOf(i);a.splice(e,1)}}return s}applyUpgrade(e,t){const a=this.upgrades.find(t=>t.id===e);return!(!a||(a.unique&&this.takenUniques.has(e)?(console.warn(`Unique upgrade ${e} already taken globally`),1):a.type===A.Tq.EQUIPMENT&&this.hasEquipment(t,e)?(console.warn(`Equipment ${e} already owned by player`),1):(a.unique&&this.takenUniques.add(e),a.func(t),0)))}removeUpgradeFromPool(e){this.takenUniques.add(e)}resetUpgrades(e){this.takenUniques.clear(),e.equipment=this.playerConfig.default.equipment,e.unique=this.playerConfig.default.unique}hasEquipment(e,t){return e.equipment.includes(t)}hasUnique(e,t){return e.unique.includes(t)}getRarityColor(e){return this.rarityConfig[e].color}getRarityWeight(e){return this.rarityConfig[e].weight}}class z{constructor(e,t,a){this.settings=e,this.ui=t,this.utility=a,this.ammoReserveIcon=null,this.projectileIcon=null,this.reserveBulletParticles=[]}initAmmoReserveCanvas(){this.ammoReserveIcon=new Image,this.ammoReserveIcon.src="/assets/img/icon/inventory/ammobox.png",this.ammoReserveIcon.onload=()=>{this.renderAmmoReserves()},this.projectileIcon=new Image,this.projectileIcon.src="/assets/img/icon/inventory/9mm.png",this.settings.getSettings().graphics.physics.ammoReserves&&requestAnimationFrame(()=>this.updateAmmoReservePhysics())}spawnAmmoInReserveUI(e=1){if(!this.ui.ammoReservesCtx||!this.projectileIcon)return;const t=this.settings.getSettings().graphics.physics.ammoReserves,{collisionHeight:a,collisionWidth:s,collisionX:i,collisionY:r}=this.getAmmoReserveCollisionZone();for(let o=0;o<e;o++)this.utility.safeTimeout(()=>{if(t){const e=i+s,t=r+a/2,o=2+8*Math.random(),n=(Math.random()-.5)*(Math.PI/3),l=Math.cos(n)*o,h=Math.sin(n)*o,d=Math.random()*Math.PI*2,m=.1*(Math.random()-.5);this.reserveBulletParticles.push({transform:{pos:{x:e,y:t},rot:d},velocity:{x:l,y:h},torque:m,width:2.75,height:7})}else{const e=i+Math.random()*s,t=r+Math.random()*a,o=Math.random()*Math.PI*2;this.reserveBulletParticles.push({transform:{pos:{x:e,y:t},rot:o},velocity:{x:0,y:0},torque:0,width:2.75,height:7}),this.renderAmmoReserves()}},100*o)}removeAmmoFromReserveUI(e=1){for(let t=0;t<e;t++)this.utility.safeTimeout(()=>{this.reserveBulletParticles.length>0&&this.reserveBulletParticles.shift(),this.settings.getSettings().graphics.physics.ammoReserves||this.renderAmmoReserves()},100*t)}updateAmmoReservePhysics(){if(!this.settings.getSettings().graphics.physics.ammoReserves)return;if(!this.ui.ammoReservesCtx||!this.ammoReserveIcon)return;const{collisionHeight:e,collisionWidth:t,collisionX:a,collisionY:s}=this.getAmmoReserveCollisionZone();this.ui.ammoReservesCtx.clearRect(0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),this.ui.ammoReservesCtx.drawImage(this.ammoReserveIcon,0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height);for(let i of this.reserveBulletParticles)i.transform.pos.x+=i.velocity.x,i.transform.pos.y+=i.velocity.y,i.transform.rot+=i.torque,i.velocity.x*=.9,i.velocity.y*=.9,i.torque*=.9,i.transform.pos.x-i.width/2<a&&(i.transform.pos.x=a+i.width/2,i.velocity.x*=-.5),i.transform.pos.x+i.width/2>a+t&&(i.transform.pos.x=a+t-i.width/2,i.velocity.x*=-.5),i.transform.pos.y-i.height/2<s&&(i.transform.pos.y=s+i.height/2,i.velocity.y*=-.5),i.transform.pos.y+i.height/2>s+e&&(i.transform.pos.y=s+e-i.height/2,i.velocity.y*=-.5);for(let e=0;e<this.reserveBulletParticles.length;e++)for(let t=e+1;t<this.reserveBulletParticles.length;t++){const a=this.reserveBulletParticles[e],s=this.reserveBulletParticles[t],i=a.transform.pos.x-s.transform.pos.x,r=a.transform.pos.y-s.transform.pos.y,o=Math.sqrt(i*i+r*r),n=(a.width+s.width)/2;if(o<n){const e=Math.atan2(r,i),t=n-o,l=Math.cos(e)*t/2,h=Math.sin(e)*t/2;a.transform.pos.x+=l,a.transform.pos.y+=h,s.transform.pos.x-=l,s.transform.pos.y-=h;const d=a.velocity.x*Math.cos(e)+a.velocity.y*Math.sin(e),m=s.velocity.x*Math.cos(e)+s.velocity.y*Math.sin(e),c=(d+m)/2;a.velocity.x+=.5*(c-d),s.velocity.x+=.5*(c-m)}}for(let e of this.reserveBulletParticles)this.ui.ammoReservesCtx.save(),this.ui.ammoReservesCtx.translate(e.transform.pos.x,e.transform.pos.y),this.ui.ammoReservesCtx.rotate(e.transform.rot),this.ui.ammoReservesCtx.drawImage(this.projectileIcon,-e.width/2,-e.height/2,e.width,e.height),this.ui.ammoReservesCtx.restore();requestAnimationFrame(()=>this.updateAmmoReservePhysics())}renderAmmoReserves(){if(this.ui.ammoReservesCtx&&this.ammoReserveIcon&&this.ammoReserveIcon.complete&&(this.ui.ammoReservesCtx.clearRect(0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),this.ui.ammoReservesCtx.drawImage(this.ammoReserveIcon,0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),!this.settings.getSettings().graphics.physics.ammoReserves))for(let e of this.reserveBulletParticles)this.ui.ammoReservesCtx.save(),this.ui.ammoReservesCtx.translate(e.transform.pos.x,e.transform.pos.y),this.ui.ammoReservesCtx.rotate(e.transform.rot),this.ui.ammoReservesCtx.drawImage(this.projectileIcon,-e.width/2,-e.height/2,e.width,e.height),this.ui.ammoReservesCtx.restore()}getAmmoReserveCollisionZone(){return{collisionHeight:27,collisionWidth:63,collisionX:(this.ui.ammoReservesCanvas.width-63)/2-3,collisionY:(this.ui.ammoReservesCanvas.height-27)/2-1}}}class N{constructor(e,t,a){this.playerState=e,this.settingsManager=t,this.utility=a,this.ammoReservesCanvas=null,this.ammoReservesCtx=null,this.canvas=null,this.ctx=null,this.decalCanvas=null,this.decalCtx=null,this.worldCanvas=null,this.worldCtx=null,this.gameContainer=null,this.gameOptionsContainer=null,this.lobbyContainer=null,this.roomControls=null,this.upgradeContainer=null,this.gameRoomIdDisplay=null,this.lobbyPlayersList=null,this.roomIdDisplay=null,this.userIdDisplay=null,this.gameCodeButton=null,this.gameLeaveButton=null,this.hostButton=null,this.joinButton=null,this.lobbyCodeButton=null,this.lobbyLeaveButton=null,this.quickplayButton=null,this.startGameBtn=null,this.playersInput=null,this.privateToggle=null,this.upgradesToggle=null,this.winsInput=null,this.chatContainer=null,this.chatInput=null,this.chatMessages=null,this.chatSendBtn=null,this.charCustomizeContainer=null,this.charCustomizeCanvas=null,this.charCustomizeCtx=null,this.headwearArrowLeft=null,this.headArrowLeft=null,this.bodyArrowLeft=null,this.headwearArrowRight=null,this.headArrowRight=null,this.bodyArrowRight=null,this.modal=null,this.modalButtons=null,this.modalCancelButton=null,this.modalConfirmButton=null,this.modalContent=null,this.modalErrorDiv=null,this.modalInput=null,this.modalText=null,this.leaderboard=new Map,this.leaderboardBody=null,this.leaderboardContainer=null,this.settingsContainer=null,this.settingsButton=null,this.settingsCloseButton=null,this.controlsTab=null,this.graphicsTab=null,this.soundTab=null,this.controlsBody=null,this.graphicsBody=null,this.soundBody=null,this.masterSlider=null,this.masterFill=null,this.masterValue=null,this.interfaceSlider=null,this.interfaceFill=null,this.interfaceValue=null,this.musicSlider=null,this.musicFill=null,this.musicValue=null,this.sfxSlider=null,this.sfxFill=null,this.sfxValue=null,this.voiceSlider=null,this.voiceFill=null,this.voiceValue=null,this.deadzoneInput=null,this.particleJSToggle=null,this.staticVfxToggle=null,this.ammoReservesPhysicsToggle=null,this.accuracyStat=null,this.damageStat=null,this.luckStat=null,this.rangeStat=null,this.shotSpeedStat=null,this.speedStat=null,this.ammoReservesUIController=new z(this.settingsManager,this,this.utility),this.initInterfaceListeners()}initInterface(){if(this.canvas=document.getElementById("gameCanvas"),this.decalCanvas=document.createElement("canvas"),this.worldCanvas=document.createElement("canvas"),this.ammoReservesCanvas=document.getElementById("ammoReservesCanvas"),this.charCustomizeCanvas=document.getElementById("charCustomizeCanvas"),this.roomControls=document.getElementById("roomControls"),this.gameContainer=document.getElementById("gameContainer"),this.lobbyContainer=document.getElementById("lobbyContainer"),this.lobbyPlayersList=document.getElementById("lobbyPlayersList"),this.startGameBtn=document.getElementById("startGameBtn"),this.gameOptionsContainer=document.getElementById("gameOptionsContainer"),this.userIdDisplay=document.getElementById("userId"),this.roomIdDisplay=document.getElementById("roomId"),this.gameRoomIdDisplay=document.getElementById("gameRoomId"),this.chatContainer=document.getElementById("chatContainer"),this.chatMessages=document.getElementById("chatMessages"),this.chatInput=document.getElementById("chatInput"),this.chatSendBtn=document.getElementById("chatSendBtn"),this.charCustomizeContainer=document.getElementById("charCustomizeContainer"),this.headwearArrowLeft=document.getElementById("headwearArrowLeft"),this.headArrowLeft=document.getElementById("headArrowLeft"),this.bodyArrowLeft=document.getElementById("bodyArrowLeft"),this.headwearArrowRight=document.getElementById("headwearArrowRight"),this.headArrowRight=document.getElementById("headArrowRight"),this.bodyArrowRight=document.getElementById("bodyArrowRight"),this.privateToggle=document.getElementById("privateToggle"),this.upgradesToggle=document.getElementById("upgradesToggle"),this.winsInput=document.getElementById("winsInput"),this.playersInput=document.getElementById("playersInput"),this.upgradeContainer=document.getElementById("upgradeContainer"),this.leaderboardContainer=document.getElementById("leaderboardContainer"),this.leaderboardBody=document.getElementById("leaderboardBody"),this.hostButton=document.getElementById("atomHost"),this.joinButton=document.getElementById("atomJoin"),this.quickplayButton=document.getElementById("atomQuickplay"),this.lobbyLeaveButton=document.getElementById("lobbyLeaveBtn"),this.lobbyCodeButton=document.getElementById("lobbyCodeBtn"),this.gameLeaveButton=document.getElementById("gameLeaveBtn"),this.gameCodeButton=document.getElementById("gameCodeBtn"),this.modal=document.getElementById("modal"),this.modalInput=document.getElementById("joinRoomInput"),this.modalButtons=document.getElementById("modalButtons"),this.modalConfirmButton=document.getElementById("joinRoomConfirmBtn"),this.modalCancelButton=document.getElementById("joinRoomCancelBtn"),this.modalErrorDiv=document.getElementById("joinRoomError"),this.modalContent=document.getElementById("modalContent"),this.modalText=document.getElementById("modalText"),this.settingsContainer=document.getElementById("settingsContainer"),this.settingsButton=document.getElementById("atomSettings"),this.settingsCloseButton=document.getElementById("settingsCloseButton"),this.controlsTab=document.getElementById("controlsTab"),this.graphicsTab=document.getElementById("graphicsTab"),this.soundTab=document.getElementById("soundTab"),this.controlsBody=document.getElementById("controlsBody"),this.graphicsBody=document.getElementById("graphicsBody"),this.soundBody=document.getElementById("soundBody"),this.masterSlider=document.getElementById("masterSlider"),this.masterFill=document.getElementById("masterFill"),this.masterValue=document.getElementById("masterValue"),this.interfaceSlider=document.getElementById("interfaceSlider"),this.interfaceFill=document.getElementById("interfaceFill"),this.interfaceValue=document.getElementById("interfaceValue"),this.musicSlider=document.getElementById("musicSlider"),this.musicFill=document.getElementById("musicFill"),this.musicValue=document.getElementById("musicValue"),this.sfxSlider=document.getElementById("sfxSlider"),this.sfxFill=document.getElementById("sfxFill"),this.sfxValue=document.getElementById("sfxValue"),this.voiceSlider=document.getElementById("voiceSlider"),this.voiceFill=document.getElementById("voiceFill"),this.voiceValue=document.getElementById("voiceValue"),this.deadzoneInput=document.getElementById("deadzoneInput"),this.particleJSToggle=document.getElementById("particleJSToggle"),this.staticVfxToggle=document.getElementById("staticToggle"),this.ammoReservesPhysicsToggle=document.getElementById("ammoReservesPhysicsToggle"),this.accuracyStat=document.getElementById("accuracyValue"),this.damageStat=document.getElementById("damageValue"),this.luckStat=document.getElementById("luckValue"),this.rangeStat=document.getElementById("rangeValue"),this.shotSpeedStat=document.getElementById("shotSpeedValue"),this.speedStat=document.getElementById("speedValue"),!(this.canvas&&this.decalCanvas&&this.ammoReservesCanvas&&this.charCustomizeCanvas&&this.worldCanvas&&this.roomControls&&this.gameContainer&&this.lobbyContainer&&this.userIdDisplay&&this.roomIdDisplay&&this.gameRoomIdDisplay&&this.lobbyPlayersList&&this.startGameBtn&&this.gameOptionsContainer&&this.chatContainer&&this.chatMessages&&this.chatInput&&this.chatSendBtn&&this.privateToggle&&this.upgradesToggle&&this.winsInput&&this.playersInput&&this.upgradeContainer&&this.leaderboardContainer&&this.leaderboardBody&&this.hostButton&&this.joinButton&&this.quickplayButton&&this.lobbyLeaveButton&&this.lobbyCodeButton&&this.gameLeaveButton&&this.gameCodeButton&&this.settingsButton&&this.settingsCloseButton&&this.settingsContainer&&this.controlsTab&&this.graphicsTab&&this.soundTab&&this.controlsBody&&this.graphicsBody&&this.soundBody&&this.masterSlider&&this.masterFill&&this.interfaceSlider&&this.interfaceFill&&this.musicSlider&&this.musicFill&&this.sfxSlider&&this.sfxFill&&this.voiceSlider&&this.voiceFill&&this.masterValue&&this.interfaceValue&&this.musicValue&&this.sfxValue&&this.voiceValue&&this.accuracyStat&&this.damageStat&&this.luckStat&&this.rangeStat&&this.shotSpeedStat&&this.speedStat&&this.deadzoneInput&&this.particleJSToggle&&this.staticVfxToggle&&this.ammoReservesPhysicsToggle&&this.charCustomizeContainer&&this.headwearArrowLeft&&this.headArrowLeft&&this.bodyArrowLeft&&this.headwearArrowRight&&this.headArrowRight&&this.bodyArrowRight))throw alert("Failed to load game. Please refresh the page."),new Error("Critical error: Required DOM elements are missing.");if(this.canvas.width=n,this.canvas.height=l,this.decalCanvas.width=i,this.decalCanvas.height=r,this.worldCanvas.width=i,this.worldCanvas.height=r,this.ammoReservesCanvas.width=100,this.ammoReservesCanvas.height=64,this.charCustomizeCanvas.width=200,this.charCustomizeCanvas.height=200,this.ctx=this.canvas.getContext("2d"),this.decalCtx=this.decalCanvas.getContext("2d"),this.worldCtx=this.worldCanvas.getContext("2d"),this.ammoReservesCtx=this.ammoReservesCanvas.getContext("2d"),this.charCustomizeCtx=this.charCustomizeCanvas.getContext("2d"),!(this.ctx&&this.decalCtx&&this.worldCtx&&this.ammoReservesCtx&&this.charCustomizeCtx))throw alert("Failed to load game. Please refresh the page."),new Error("Could not get canvas context")}updateDisplay(e,t,a){if(this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer&&this.charCustomizeContainer)switch(this.clearDisplay(),t){case"lobby":this.lobbyContainer.style.display="flex",this.chatContainer.style.display="flex",this.charCustomizeContainer.style.display="flex",a&&this.roomIdDisplay&&(this.roomIdDisplay.textContent=a),e.inLobby=!0;break;case"room":this.roomControls.style.display="flex";break;case"game":if(this.gameContainer.style.display="flex",this.chatContainer.style.display="flex",this.leaderboardContainer.style.display="flex",a){const e=this.gameRoomIdDisplay;e&&(e.textContent=a)}e.inLobby=!1}}updateHostDisplay(e,t){this.startGameBtn&&this.gameOptionsContainer&&(this.startGameBtn.style.display=e?"block":"none",this.startGameBtn.disabled=t.lobbyPlayers.size<1,this.gameOptionsContainer.style.display=e?"flex":"none")}displayLobbyPlayers(e,t,a){this.lobbyPlayersList&&(this.lobbyPlayersList.innerHTML="",Array.from(t.lobbyPlayers.values()).sort((e,t)=>e.isHost&&!t.isHost?-1:!e.isHost&&t.isHost?1:0).forEach(s=>{const i=document.createElement("div");i.className="lobby_player";const r=document.createElement("div");r.className="player_color",r.style.backgroundColor=s.color;const o=document.createElement("div");o.className="player_name",o.textContent=`${s.id}${s.isHost?" (Host)":""}`;const n=document.createElement("div");if(n.className="player_controls",e&&s.id!==a){const e=document.createElement("button");e.textContent="Promote",e.onclick=()=>t.promotePlayer(s.id);const a=document.createElement("button");a.textContent="Kick",a.className="danger",a.onclick=()=>t.kickPlayer(s.id),n.appendChild(e),n.appendChild(a)}i.appendChild(r),i.appendChild(o),i.appendChild(n),this.lobbyPlayersList&&this.lobbyPlayersList.appendChild(i)}))}clearDisplay(){this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer&&this.upgradeContainer&&this.charCustomizeContainer&&(this.roomControls.style.display="none",this.lobbyContainer.style.display="none",this.gameContainer.style.display="none",this.chatContainer.style.display="none",this.leaderboardContainer.style.display="none",this.upgradeContainer.style.display="none",this.charCustomizeContainer.style.display="none")}closeModal(){this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalText&&(this.modal.classList.add("hidden"),this.modalInput.style.display="flex",this.modalText.textContent="Join Room",this.modalConfirmButton.onclick=null,this.modalCancelButton.onclick=null,this.modalInput.onkeydown=null)}showJoinRoomModal(e){this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalErrorDiv&&(this.modal.classList.remove("hidden"),this.modalConfirmButton.classList.remove("hidden"),this.modalInput.value="",this.modalErrorDiv.textContent="",this.modalConfirmButton.textContent="Join",this.modalInput.focus(),this.modalConfirmButton.onclick=()=>{if(!this.modalInput||!this.modalErrorDiv)return;const t=this.modalInput.value.trim();if(!t)return void(this.modalErrorDiv.textContent="Invalid code...");let a=null;try{const e=new URL(t,window.location.origin);a=e.pathname.startsWith("/room_")?e.pathname.replace("/",""):new URLSearchParams(e.search).get("room")}catch{t.startsWith("room_")&&(a=t)}a?(this.closeModal(),e(a)):this.modalErrorDiv.textContent="Invalid code..."},this.modalCancelButton.onclick=()=>this.closeModal())}soloGameWarning(e){this.modal&&this.modalConfirmButton&&this.modalCancelButton&&this.modalContent&&this.modalText&&this.modalInput&&this.modalErrorDiv&&this.modalButtons&&(this.modal.classList.remove("hidden"),this.modalConfirmButton.classList.remove("hidden"),this.modalInput.style.display="none",this.modalErrorDiv.textContent=" ",this.modalButtons.style.display="flex",this.modalCancelButton.style.display="flex",this.modalText.textContent="Start game as only player? Other players will be unable to join until you return to the lobby.",this.modalConfirmButton.textContent="Start Game",this.modalCancelButton.textContent="Cancel",this.modalConfirmButton.onclick=()=>{this.closeModal(),e()},this.modalCancelButton.onclick=()=>this.closeModal())}showSettingsPage(){this.settingsContainer&&this.settingsContainer.classList.remove("hidden")}hideSettingsPage(){this.settingsContainer&&this.settingsContainer.classList.add("hidden")}switchSettingsPage(e){if(this.controlsBody&&this.graphicsBody&&this.soundBody&&this.controlsTab&&this.graphicsTab&&this.soundTab)switch(this.controlsTab.classList.remove("settings_tab_active"),this.graphicsTab.classList.remove("settings_tab_active"),this.soundTab.classList.remove("settings_tab_active"),this.controlsBody.classList.remove("settings_page_hidden"),this.graphicsBody.classList.remove("settings_page_hidden"),this.soundBody.classList.remove("settings_page_hidden"),e){case"controls":this.controlsTab.classList.add("settings_tab_active"),this.graphicsBody.classList.add("settings_page_hidden"),this.soundBody.classList.add("settings_page_hidden");break;case"graphics":this.graphicsTab.classList.add("settings_tab_active"),this.controlsBody.classList.add("settings_page_hidden"),this.soundBody.classList.add("settings_page_hidden");break;case"sound":this.soundTab.classList.add("settings_tab_active"),this.controlsBody.classList.add("settings_page_hidden"),this.graphicsBody.classList.add("settings_page_hidden")}}updateSettingsSlider(e,t,a){const s=Math.max(0,Math.min(100,100*a));e.style.width=`${s}%`,t.textContent=`${Math.round(s)}%`}calculateSliderValue(e,t){const a=e.getBoundingClientRect(),s=t-a.left,i=a.width;return Math.max(0,Math.min(1,s/i))}initSoundSliders(e){const t=e.audio.mixer;this.masterFill&&this.masterValue&&this.updateSettingsSlider(this.masterFill,this.masterValue,t.master),this.interfaceFill&&this.interfaceValue&&this.updateSettingsSlider(this.interfaceFill,this.interfaceValue,t.interface),this.musicFill&&this.musicValue&&this.updateSettingsSlider(this.musicFill,this.musicValue,t.music),this.sfxFill&&this.sfxValue&&this.updateSettingsSlider(this.sfxFill,this.sfxValue,t.sfx),this.voiceFill&&this.voiceValue&&this.updateSettingsSlider(this.voiceFill,this.voiceValue,t.voice)}initSettingsInputs(e){this.deadzoneInput&&(this.deadzoneInput.value=e.controls.gamepad.deadzone.toString())}initSettingsToggles(e){this.particleJSToggle&&this.utility.setToggle({toggleId:"particleJSToggle",value:e.graphics.renderBackgroundParticles}),this.staticVfxToggle&&this.utility.setToggle({toggleId:"staticToggle",value:e.graphics.showStaticOverlay}),this.ammoReservesPhysicsToggle&&this.utility.setToggle({toggleId:"ammoReservesPhysicsToggle",value:e.graphics.physics.ammoReserves})}initKeybindsInterface(e,t){Object.keys(e.keybinds).forEach(a=>{const s=`${a}Keybind`,i=document.getElementById(s);if(i){const s=e.keybinds[a];i.textContent=" "===s?"SPACE":s.toUpperCase(),i.addEventListener("click",()=>{this.showRebindModal(a,"keybind",e=>{t(a,"keybind",e)})})}}),Object.keys(e.gamepad).forEach(a=>{const s=`${a}Gamepad`,i=document.getElementById(s);if(i&&void 0!==e.gamepad[a]){const s=e.gamepad[a],r=Object.keys(h).find(e=>"number"==typeof h[e]&&h[e]===s);i.textContent=r||s.toString(),i.addEventListener("click",()=>{this.showRebindModal(a,"gamepad",e=>{t(a,"gamepad",e)})})}})}showRebindModal(e,t,a){if(!(this.modal&&this.modalText&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalErrorDiv))return;const s=["Binding already assigned!","Binding already in use!","That binding is assigned already!","Binding already being used!","Already bound to another action!"];let i=0;if("gamepad"===t){const e=navigator.getGamepads();if(!Array.from(e).some(e=>null!==e))return this.modal.classList.remove("hidden"),this.modalErrorDiv.textContent="",this.modalText.textContent="No gamepad detected",this.modalInput.style.display="none",this.modalConfirmButton.classList.add("hidden"),this.modalCancelButton.textContent="Close",this.modalCancelButton.onclick=()=>this.closeModal(),void this.utility.safeTimeout(()=>{this.closeModal()},3e3)}this.modal.classList.remove("hidden"),this.modalErrorDiv.textContent="",this.modalInput.style.display="none",this.modalText.textContent=`Press any ${"keybind"===t?"key":"button"} for ${e.toUpperCase()}`,this.modalConfirmButton.classList.add("hidden"),this.modalCancelButton.textContent="Cancel";const r=a=>"keybind"===t?Object.entries(this.settingsManager?.getSettings().controls.keybinds||{}).some(([t,s])=>t!==e&&s===a):Object.entries(this.settingsManager?.getSettings().controls.gamepad||{}).some(([t,s])=>t!==e&&s===a),o=e=>{if(e.preventDefault(),"Escape"===e.key)return h(),void this.closeModal();const t=e.key.toLowerCase();if(r(t)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],void i++}h(),a(t),this.closeModal()},n=e=>{if(e.target===this.modalCancelButton||this.modalCancelButton?.contains(e.target))return;e.preventDefault(),e.stopPropagation();let t="";if(0===e.button?t="mouse1":1===e.button?t="mouse3":2===e.button&&(t="mouse2"),t){if(r(t)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],void i++}h(),a(t),this.closeModal()}},l=()=>{const e=navigator.getGamepads();for(const t of e)if(t)for(let e=0;e<t.buttons.length;e++)if(t.buttons[e].pressed){if(r(e)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],i++,void requestAnimationFrame(l)}return h(),a(e),void this.closeModal()}requestAnimationFrame(l)},h=()=>{"keybind"===t&&(document.removeEventListener("keydown",o),document.removeEventListener("mousedown",n)),this.modalCancelButton.onclick=null};"keybind"===t?(document.addEventListener("keydown",o),document.addEventListener("mousedown",n)):requestAnimationFrame(l),this.modalCancelButton.onclick=()=>{h(),this.closeModal()}}createLeaderboard(e,t,a){const s=new Set;s.add(a),t.forEach((e,t)=>{s.add(t)}),e.lobbyPlayers.forEach((e,t)=>{s.add(t)}),s.forEach(e=>{this.leaderboard.has(e)||(this.leaderboard.set(e,{playerId:e,wins:0,kills:0,deaths:0}),console.log(`Created leaderboard entry for ${e}`))}),this.updateLeaderboardDisplay(a),console.log("Leaderboard created/updated:",Array.from(this.leaderboard.entries()))}updateLeaderboardDisplay(e){this.leaderboardBody&&(this.leaderboardBody.innerHTML="",Array.from(this.leaderboard.entries()).sort((e,t)=>{const[,a]=e,[,s]=t;return s.wins!==a.wins?s.wins-a.wins:s.kills-a.kills}).forEach(([t,a])=>{const s=document.createElement("tr");s.className="leaderboard_row",t===e&&s.classList.add("current-player");const i=document.createElement("td");i.textContent=t===e?"You":t.substring(0,8),i.className="player_name",s.appendChild(i);const r=document.createElement("td");r.textContent=a.wins.toString(),r.className="wins",s.appendChild(r);const o=document.createElement("td");o.textContent=a.kills.toString(),o.className="kills",s.appendChild(o);const n=document.createElement("td");n.textContent=a.deaths.toString(),n.className="deaths",s.appendChild(n),this.leaderboardBody&&this.leaderboardBody.appendChild(s)}))}clearLeaderboard(){this.leaderboard.clear(),this.leaderboardBody&&(this.leaderboardBody.innerHTML="")}initInterfaceListeners(){const e=500,t=20,a="#00ff00",s="#ff0000",i=200;this.playerState.onStatChange("actions.primary.projectile.spread",r=>{if(!this.accuracyStat)return;const o=parseFloat(this.accuracyStat.textContent||"0"),n=r<o;this.utility.animateTextInElement({element:this.accuracyStat,oldValue:o,newValue:r,decimals:2,animTime:e,steps:t,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.damage",r=>{if(!this.damageStat)return;const o=parseFloat(this.damageStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.damageStat,oldValue:o,newValue:Math.round(r),decimals:2,animTime:e,steps:t,color:n?a:s,timeout:i})}),this.playerState.onStatChange("stats.speed",r=>{if(!this.speedStat)return;const o=parseFloat(this.speedStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.speedStat,oldValue:o,newValue:r,decimals:2,animTime:e,steps:t,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.range",r=>{if(!this.rangeStat)return;const o=parseFloat(this.rangeStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.rangeStat,oldValue:o,newValue:r,decimals:2,animTime:e,steps:t,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.speed",r=>{if(!this.shotSpeedStat)return;const o=parseFloat(this.shotSpeedStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.shotSpeedStat,oldValue:o,newValue:r,decimals:2,animTime:e,steps:t,color:n?a:s,timeout:i})}),this.playerState.onStatChange("stats.luck",r=>{if(!this.luckStat)return;const o=parseFloat(this.luckStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.luckStat,oldValue:o,newValue:r,decimals:2,animTime:e,steps:t,color:n?a:s,timeout:i})})}}class O{constructor(){this.lastFrameTime=performance.now(),this.simplexTable=this.generateSimplexTable(),this.activeTimeouts=new Set}deepMerge(e,t){for(const a in t)null===t[a]||"object"!=typeof t[a]||Array.isArray(t[a])?e[a]=t[a]:(e[a]||(e[a]={}),this.deepMerge(e[a],t[a]))}async yield(e){console.log(`[Yield] ${e??"(no message)"}`),e?document.dispatchEvent(new CustomEvent("yieldMessage",{detail:{message:e}})):document.dispatchEvent(new CustomEvent("yieldProgress")),await new Promise(e=>requestAnimationFrame(()=>e()))}deltaTime(){const e=performance.now(),t=e-this.lastFrameTime;return this.lastFrameTime=e,Math.min(t,100)/16.67}safeTimeout(e,t){const a=window.setTimeout(()=>{this.activeTimeouts.delete(a),e()},t);return this.activeTimeouts.add(a),a}clearTimeoutCache(){this.activeTimeouts.forEach(e=>window.clearTimeout(e)),this.activeTimeouts.clear()}getRandomNum(e,t,a){const s=Math.random()*(t-e)+e;return void 0!==a?parseFloat(s.toFixed(a)):s}getRandomInt(e,t){return Math.floor(Math.random()*(t-e+1))+e}getRandomInArray(e){return e[Math.floor(Math.random()*e.length)]}getShuffledArray(e){return e.slice().sort(()=>Math.random()-.5)}getDotProduct(e,t){return e.x*t.x+e.y*t.y}getReflection(e,t){const a=this.getDotProduct(e,t);return{x:e.x-2*a*t.x,y:e.y-2*a*t.y}}forward(e){return{x:Math.cos(e),y:Math.sin(e)}}getDirection(e){const t=e.targetPos.x-e.rootPos.x,a=e.targetPos.y-e.rootPos.y,s=Math.sqrt(t*t+a*a);return 0===s?{x:0,y:0}:{x:t/s,y:a/s}}getRandomDirection(e){const t=Math.random()*(e*Math.PI/180);return{x:Math.cos(t),y:Math.sin(t)}}getRandomColor(e){const t=e?.format??"hex";let a;switch(e?.mode??"any"){case"primary":const e=["#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF"];a=this.getRandomInArray(e);break;case"pastel":const t=this.getRandomInt(127,254),s=this.getRandomInt(127,254),i=this.getRandomInt(127,254);a=`#${t.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;break;case"vibrant":const r=[255,this.getRandomInt(0,255),this.getRandomInt(0,255)];r.sort(()=>Math.random()-.5),a=`#${r[0].toString(16).padStart(2,"0")}${r[1].toString(16).padStart(2,"0")}${r[2].toString(16).padStart(2,"0")}`;break;case"dark":const o=this.getRandomInt(0,127),n=this.getRandomInt(0,127),l=this.getRandomInt(0,127);a=`#${o.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`;break;case"light":const h=this.getRandomInt(128,255),d=this.getRandomInt(128,255),m=this.getRandomInt(128,255);a=`#${h.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}`;break;case"grayscale":const c=this.getRandomInt(0,255);a=`#${c.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`;break;default:a="#"+this.getRandomInt(0,16777215).toString(16).padStart(6,"0")}if("rgb"===t){const e=this.hexToRgb(a);return e?`rgb(${e.r}, ${e.g}, ${e.b})`:a}return a}getLightestColor(e){let t=e[0],a=0;for(const s of e){const e=.299*parseInt(s.slice(1,3),16)+.587*parseInt(s.slice(3,5),16)+.114*parseInt(s.slice(5,7),16);e>a&&(a=e,t=s)}return t}hexToRgb(e){const t=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(e);return t?{r:parseInt(t[1],16),g:parseInt(t[2],16),b:parseInt(t[3],16)}:null}generateSimplexTable(){const e=new Uint8Array(512);for(let t=0;t<256;t++)e[t]=t;for(let t=0;t<256;t++){const a=t+this.getRandomInt(0,255-t);[e[t],e[a]]=[e[a],e[t]]}for(let t=0;t<256;t++)e[256+t]=e[t];return e}simplexNoise2D(e,t,a=!1){a&&(this.simplexTable=this.generateSimplexTable());const s=this.simplexTable,i=.5*(Math.sqrt(3)-1),r=(3-Math.sqrt(3))/6,o=(e+t)*i,n=Math.floor(e+o),l=Math.floor(t+o),h=(n+l)*r,d=e-(n-h),m=t-(l-h),c=d>m?1:0,y=d>m?0:1,u=d-c+r,p=m-y+r,g=d-1+2*r,f=m-1+2*r,w=255&n,S=255&l,b=s[w+s[S]]%12,C=s[w+c+s[S+y]]%12,x=s[w+1+s[S+1]]%12,v=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],M=(e,t,a)=>e[0]*t+e[1]*a;let P=.5-d*d-m*m,I=.5-u*u-p*p,k=.5-g*g-f*f;return 70*((P<0?0:Math.pow(P,4)*M(v[b],d,m))+(I<0?0:Math.pow(I,4)*M(v[C],u,p))+(k<0?0:Math.pow(k,4)*M(v[x],g,f)))}getNoise(e,t,a,s,i){switch(e){case A.VA.Perlin:return this.perlinNoise(t,a,s,i?.octaves??1,i?.persistence??.5);case A.VA.Ridged:return this.ridgedNoise(t,a,s,i?.octaves??1,i?.persistence??.5);case A.VA.Worley:return this.worleyNoise(t,a,s,Math.max(1,Math.floor(i?.octaves??1)));case A.VA.Voronoi:return this.voronoiNoise(t,a,s);default:return this.perlinNoise(t,a,s)}}perlinNoise(e,t,a,s=1,i=1){let r=0,o=1,n=1,l=0;for(let h=0;h<s;h++)r+=this.interpolateNoise(e*o,t*o,a+1e3*h)*n,l+=n,n*=i,o*=2;return r/l}ridgedNoise(e,t,a,s=1,i=.5){let r=0,o=1,n=1,l=0;for(let h=0;h<s;h++){let s=this.interpolateNoise(e*o,t*o,a+1e3*h);s=1-Math.abs(s),r+=s*n,l+=n,n*=i,o*=2}return r/l}worleyNoise(e,t,a,s=1){const i=Math.floor(e),r=Math.floor(t);let o=1/0;for(let n=-1;n<=1;n++)for(let l=-1;l<=1;l++){const h=i+n,d=r+l;for(let i=0;i<s;i++){const s=e-(h+this.hash2D(h,d,a+1e4*i)),r=t-(d+this.hash2D(h,d,a+1e4*i+1)),n=Math.sqrt(s*s+r*r);n<o&&(o=n)}}return this.normalize(o/1.5)}voronoiNoise(e,t,a){return this.worleyNoise(e,t,a,1)}hash2D(e,t,a){const s=374761393*e+668265263*t+a,i=1274126177*(s^s>>13);return(2147483647&(i^i>>16))/2147483647}interpolateNoise(e,t,a){const s=Math.floor(e),i=e-s,r=Math.floor(t),o=t-r,n=this.hash2D(s,r,a),l=this.hash2D(s+1,r,a),h=this.hash2D(s,r+1,a),d=this.hash2D(s+1,r+1,a),m=this.smoothstep(i),c=this.smoothstep(o),y=this.lerp(n,l,m),u=this.lerp(h,d,m);return this.lerp(y,u,c)}smoothstep(e){return e*e*(3-2*e)}lerp(e,t,a){return e+(t-e)*a}normalize(e){return Math.max(0,Math.min(1,e))}generateUID(e,t){let a=t??"";for(let t=0;t<e;t++)a+="0123456789abcdefghijklmnopqrstuvwxyz"[this.getRandomInt(0,35)];return a}generateLink(e,t){const a=window.location.origin;return t?`${a}?${t}=${e}`:`${a}?${e}`}setInput(e){const t=document.getElementById(e.inputId);t&&(t.value=e.value.toString())}setSlider(e){const{sliderId:t,targetValue:a,maxValue:s,lerpTime:i=0}=e,r=document.getElementById(t),o=r?.querySelector("div");if(!r||!o)return void console.warn(`Slider not found: ${t}...`);if(0===s)return void console.warn("maxValue cannot be 0...");const n=Math.max(0,Math.min(s,a))/s*100,l=o.style.width||"100%",h=parseFloat(l.replace("%",""));if(!(Math.abs(h-n)<.1)){if(i<=0)return o.style.transition="none",void(o.style.width=`${n}%`);o.style.transition=`width ${i}ms ease-out`,o.style.width=`${n}%`,setTimeout(()=>{o&&(o.style.transition="")},i)}}setSpan(e){const t=document.getElementById(e.spanId);t?t.textContent=e.value.toString():console.warn(`Span not found: ${e.spanId}`)}setToggle(e){const t=document.getElementById(e.toggleId);t&&(e.value?(t.setAttribute("checked","true"),t.setAttribute("aria-checked","true")):(t.removeAttribute("checked"),t.setAttribute("aria-checked","false")))}animateTextInElement(e){const t=(e.newValue-e.oldValue)/e.steps,a=e.animTime/e.steps;let s=0,i=e.oldValue;e.element.style.color=e.color;const r=setInterval(()=>{s++,i+=t,s>=e.steps?(e.element.textContent=e.newValue.toFixed(e.decimals),clearInterval(r),setTimeout(()=>{e.element.style.color=""},e.timeout)):e.element.textContent=i.toFixed(e.decimals)},a)}}class j{constructor(e,t,a){this.gameState=e,this.roomManager=t,this.utility=a,this.ws=null}connectWebSocket(){const e="https:"===location.protocol?"wss:":"ws:";let t;"8888"===location.port?(t="localhost:8080",this.ws=new WebSocket(`ws://${t}`)):"9999"===location.port?(t="saltpeter.xyz",this.ws=new WebSocket(`wss://${t}`)):(t="localhost"===location.hostname?"localhost:8080":location.host,this.ws=new WebSocket(`${e}//${t}`)),this.ws.onopen=()=>{console.log("Connected to WebSocket"),this.roomManager.setWebSocket(this.ws)},this.ws.onclose=()=>{console.log("Disconnected from WebSocket"),this.gameState.gameInProgress=!1,this.utility.safeTimeout(()=>this.connectWebSocket(),d.RECONNECT_DELAY)},this.ws.onerror=e=>{console.error("WebSocket error:",e)}}getWebSocket(){return this.ws}}class ${constructor(e,t,a,s,i,r,o,n,l,h,d,m,c,y,u){this.animator=e,this.audioConfig=t,this.audioManager=a,this.collisionsManager=s,this.decalsManager=i,this.gameState=r,this.luckController=o,this.particlesManager=n,this.playerController=l,this.playerState=h,this.roomManager=d,this.ui=m,this.userId=c,this.utility=y,this.world=u,this.projectiles=new Map}triggerAttack(e){switch(e){case"melee":this.startMelee();break;case"ranged":this.startBurst();break;default:console.warn(`Unknown attack type: ${e}`)}}updateAttack(e){if(!this.gameState.gameInProgress||this.playerState.myPlayer.stats.health.value<=0)return;const t=Date.now();if(this.playerState.isReloading)t>=this.playerState.reloadStartTime+this.playerState.myPlayer.actions.primary.reload.time&&this.finishReload();else if(this.playerState.isBurstActive&&t>=this.playerState.nextBurstShotTime){const e=this.playerState.myPlayer.actions.primary.burst.amount;if(this.playerState.myPlayer.actions.primary.magazine.currentAmmo>0&&this.playerState.currentBurstShot<e){const a=this.playerState.myPlayer.transform.rot-Math.PI/2,s={x:Math.cos(a),y:Math.sin(a)};0===this.triggerBurstUniques().length&&this.launchProjectile(s),this.playerState.currentBurstShot++,this.playerState.myPlayer.actions.primary.magazine.currentAmmo--,console.log(`Burst shot ${this.playerState.currentBurstShot}! Magazine: ${this.playerState.myPlayer.actions.primary.magazine.currentAmmo}/${this.playerState.myPlayer.actions.primary.magazine.size}, Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`),this.playerState.currentBurstShot>=e||0===this.playerState.myPlayer.actions.primary.magazine.currentAmmo?(this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0):this.playerState.nextBurstShotTime=t+this.playerState.myPlayer.actions.primary.burst.delay}else this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0}}canMelee(){const e=Date.now();return!this.playerState.isMelee&&e>=this.playerState.lastMeleeTime+this.playerState.myPlayer.actions.melee.cooldown&&this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)&&!this.playerState.isBurstActive&&!this.playerState.isReloading}startMelee(){this.playerState.isMelee=!0,this.playerState.lastMeleeTime=Date.now(),this.playerState.myPlayer.rig.weapon=this.playerState.myPlayer.inventory.melee,this.roomManager.sendMessage(JSON.stringify({type:"weapon-change",playerId:this.userId,weapon:this.playerState.myPlayer.inventory.melee}));const t=this.playerState.myPlayer.transform.rot,a=this.playerState.myPlayer.actions.melee.range,s=this.playerState.myPlayer.actions.melee.size,i=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+this.playerState.myPlayer.actions.primary.projectile.size+this.playerState.myPlayer.actions.primary.offset,r=this.playerState.myPlayer.transform.pos.x+Math.cos(t-Math.PI/2)*i,o=this.playerState.myPlayer.transform.pos.y+Math.sin(t-Math.PI/2)*i,n={x:Math.cos(t-Math.PI/2)*a,y:Math.sin(t-Math.PI/2)*a},l={id:this.utility.generateUID(e),transform:{pos:{x:r,y:o},rot:t},timestamp:Date.now(),color:"rgba(255, 255, 255, 0)",damage:this.playerState.myPlayer.actions.melee.damage,distanceTraveled:0,length:s,ownerId:this.userId,range:a,size:s,velocity:n};this.projectiles.set(l.id,l),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:l})),this.utility.safeTimeout(()=>{this.projectiles.delete(l.id),this.playerState.isMelee=!1,this.playerState.myPlayer.rig.weapon=this.playerState.myPlayer.inventory.primary,this.roomManager.sendMessage(JSON.stringify({type:"weapon-change",playerId:this.userId,weapon:this.playerState.myPlayer.inventory.primary}))},this.playerState.myPlayer.actions.melee.duration)}startBurst(){if(this.playerState.isBurstActive||!this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)||this.playerState.isReloading)return;const e=Date.now();if(e<this.playerState.lastShotTime+this.playerState.myPlayer.actions.primary.buffer)return;this.playerState.lastShotTime=e;const t=this.playerState.myPlayer.actions.primary.burst.amount,a=Math.min(t,this.playerState.myPlayer.actions.primary.magazine.currentAmmo);if(0===a)return console.log("Out of ammo! Magazine empty."),this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:8}},duration:0,partIndex:1}),void this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.empty),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}});this.playerState.isBurstActive=!0,this.playerState.currentBurstShot=0;const s=this.playerState.myPlayer.transform.rot-Math.PI/2,i={x:Math.cos(s),y:Math.sin(s)};0===this.triggerBurstUniques().length&&this.launchProjectile(i),this.playerState.currentBurstShot++,this.playerState.myPlayer.actions.primary.magazine.currentAmmo--;const r=1-this.playerState.myPlayer.actions.primary.magazine.currentAmmo/this.playerState.myPlayer.actions.primary.magazine.size;if(r>.5){const e=2*(r-.5)*.5;this.audioManager.playAudio({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.empty),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},volume:{min:e,max:e}})}this.playerState.myPlayer.actions.primary.burst.amount>1&&this.playerState.myPlayer.actions.primary.magazine.currentAmmo>0&&this.playerState.currentBurstShot<a?this.playerState.nextBurstShotTime=Date.now()+this.playerState.myPlayer.actions.primary.burst.delay:(this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0,0===this.playerState.myPlayer.actions.primary.magazine.currentAmmo&&this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:8}},duration:0,partIndex:1}))}launchProjectile(t,a){console.log("Fired shot!");const s=Math.sqrt(t.x*t.x+t.y*t.y);if(0===s)return;const o=t.x/s,n=t.y/s;this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:0},.5:{x:0,y:20},1:{x:0,y:0}},duration:175,partIndex:1});const l=a?.canTriggerUnique??!0,h=a?.amount??this.playerState.myPlayer.actions.primary.projectile.amount,d=a?.color??this.playerState.myPlayer.actions.primary.projectile.color,m=a?.damage??this.playerState.myPlayer.actions.primary.projectile.damage,c=a?.length??this.playerState.myPlayer.actions.primary.projectile.length,y=a?.range??this.playerState.myPlayer.actions.primary.projectile.range,u=a?.size??this.playerState.myPlayer.actions.primary.projectile.size,p=a?.speed??this.playerState.myPlayer.actions.primary.projectile.speed,g=a?.spread??this.playerState.myPlayer.actions.primary.projectile.spread,f=Math.atan2(n,o),w=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+u+this.playerState.myPlayer.actions.primary.offset,S=this.playerState.myPlayer.transform.pos.x+Math.cos(f)*w,b=this.playerState.myPlayer.transform.pos.y+Math.sin(f)*w,C=-n,x=o,v={id:`muzzle_${Date.now()}`,pos:{x:S,y:b},particleParams:this.particlesManager.particlesConfig.particles.glock.muzzle.flash,direction:{x:o,y:n}};this.particlesManager.createParticles(v);const M={id:`smoke_${Date.now()}`,pos:{x:S,y:b},particleParams:this.particlesManager.particlesConfig.particles.glock.muzzle.smoke,direction:{x:.3*o,y:.3*n}};this.particlesManager.createParticles(M);const P={id:`shell_${Date.now()}`,pos:{x:S-5,y:b-5},particleParams:this.particlesManager.particlesConfig.particles.glock.projectile.shell,direction:{x:.8*C+-.2*o,y:.8*x+-.2*n}};this.particlesManager.createParticles(P),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.attack),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rolloff:{distance:Math.max(i,r)/2,factor:.5,type:"logarithmic"}},volume:{min:.965,max:1}}),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.shell),delay:{min:.25,max:.5},listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.375,max:.85}});for(let t=0;t<h;t++){if(this.playerState.myPlayer.unique.length>0&&l){const e=this.utility.getShuffledArray(this.playerState.myPlayer.unique);for(const t of e)if(this.luckController.luckRoll()){this.triggerUnique(t);break}}const t=(Math.random()-.5)*(g/100),a=Math.atan2(n,o)+t,s=this.utility.forward(a),i={id:this.utility.generateUID(e),transform:{pos:{x:S,y:b},rot:a},timestamp:Date.now(),color:d,damage:m,distanceTraveled:0,length:c,ownerId:this.userId,range:100*y,size:u,velocity:{x:s.x*p,y:s.y*p}};this.projectiles.set(i.id,i),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:i}))}}updateProjectiles(e){const t=[];this.projectiles.forEach((a,s)=>{if(a.ownerId===this.userId&&this.playerState.myPlayer.unique.includes("spatial_targeting")){const e=this.playerState.myPlayer.transform.rot-Math.PI/2,t=Math.cos(e),s=Math.sin(e),i=Math.sqrt(a.velocity.x**2+a.velocity.y**2),r=a.velocity.x/i,o=a.velocity.y/i,n=.05,l=r+(t-r)*n,h=o+(s-o)*n,d=Math.sqrt(l**2+h**2);a.velocity.x=l/d*i,a.velocity.y=h/d*i,a.transform.rot=Math.atan2(a.velocity.y,a.velocity.x)}a.transform.pos.x+=a.velocity.x*e,a.transform.pos.y+=a.velocity.y*e;const o=Math.sqrt(a.velocity.x*a.velocity.x+a.velocity.y*a.velocity.y)*e;if(a.distanceTraveled+=o,this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)){const e=a.transform.pos.x-this.playerState.myPlayer.transform.pos.x,i=a.transform.pos.y-this.playerState.myPlayer.transform.pos.y,r=Math.sqrt(e*e+i*i),o=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer);if(this.playerState.myPlayer.unique.includes("kinetic_brain")&&r<=4*o&&r>o+a.size&&a.ownerId!==this.userId&&this.luckController.luckRoll()){console.log("Kinetic Brain activated! Deflecting projectile.");const e={x:(a.transform.pos.x-this.playerState.myPlayer.transform.pos.x)/r,y:(a.transform.pos.y-this.playerState.myPlayer.transform.pos.y)/r},t=this.utility.getRandomNum(.85,.95),s=this.utility.getReflection(a.velocity,e);return a.velocity.x=s.x*t,a.velocity.y=.85*s.y,a.ownerId=this.userId,a.color=this.playerState.myPlayer.actions.primary.projectile.color,a.transform.rot=Math.atan2(a.velocity.y,a.velocity.x),void this.roomManager.sendMessage(JSON.stringify({type:"projectile-update",projectileId:a.id,newOwnerId:this.userId,velocity:a.velocity,color:a.color}))}if(r<=o+a.size){t.push(s);const e=Math.max(0,a.damage-this.playerState.myPlayer.stats.defense);this.playerState.myPlayer.stats.health.value=Math.max(0,this.playerState.myPlayer.stats.health.value-e);const i={target:this.playerState.myPlayer,shooterId:a.ownerId,damage:a.damage,newHealth:this.playerState.myPlayer.stats.health.value,source:a,wasKill:this.playerState.myPlayer.stats.health.value<=0};this.playerController.playerHit(i)}}if(a.ownerId===this.userId&&this.playerState.players.forEach((e,i)=>{if(this.collisionsManager.collisionsEnabled(e)){const i=a.transform.pos.x-e.transform.pos.x,r=a.transform.pos.y-e.transform.pos.y;if(Math.sqrt(i*i+r*r)<=this.collisionsManager.getPlayerCollider(e)+a.size){t.push(s);const i=Math.max(0,a.damage-e.stats.defense),r=Math.max(0,e.stats.health.value-i);e.stats.health.value=r;const o={target:e,shooterId:this.userId,damage:a.damage,newHealth:r,source:a,wasKill:r<=0};this.playerController.playerHit(o)}}}),(a.distanceTraveled>=a.range||a.transform.pos.x<0||a.transform.pos.x>i||a.transform.pos.y<0||a.transform.pos.y>r)&&(t.push(s),a.ownerId===this.userId)){const e=a.transform.pos.x,t=a.transform.pos.y;if(this.triggerCollisionUniques(a.transform.pos),e>=0&&e<=i&&t>=0&&t<=r){if(a.distanceTraveled>=a.range){const e={id:`impact_${s}`,pos:{x:a.transform.pos.x,y:a.transform.pos.y},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.projectile};this.decalsManager.createDecal(e)}const e={id:`sparks_${s}`,pos:{x:a.transform.pos.x,y:a.transform.pos.y},particleParams:this.particlesManager.particlesConfig.particles.glock.projectile.sparks};this.particlesManager.createParticles(e);const t={src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.impact.metal.bullet),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:a.transform.pos.x,y:a.transform.pos.y}},volume:{min:.965,max:1}};this.audioManager.playAudioNetwork(t),this.world.worldEdit.requestCraterAt(a.transform.pos)}this.roomManager.sendMessage(JSON.stringify({type:"projectile-remove",projectileId:s}))}}),t.forEach(e=>{this.projectiles.delete(e)})}toggleAutoFire(e){this.playerState.canAutoFire=!0;const t=this.playerState.myPlayer.actions.primary.buffer;this.playerState.myPlayer.actions.primary.buffer*=.5,console.log(`Auto-fire enabled until ${e}`),this.utility.safeTimeout(()=>{this.playerState.canAutoFire=!1,this.playerState.myPlayer.actions.primary.buffer=t,console.log("Auto-fire disabled.")},e-Date.now())}triggerUnique(e,a){if("cluster_module"===e&&a){const e=this.utility.getRandomInt(3,6),s=[];for(let a=0;a<e;a++)s.push(this.utility.getRandomInArray(t));const i={amount:e,damage:.1*this.playerState.myPlayer.actions.primary.projectile.damage,images:s,lifetime:{min:100,max:500},pos:{x:a.x,y:a.y},size:{min:8,max:14},speed:{min:10,max:15},torque:{min:-360,max:360}};this.particlesManager.spawnShrapnel(i)}if("projectile_array"===e){const e=this.utility.getRandomInt(1,3);for(let t=0;t<e;t++){const e=this.utility.getRandomDirection(360),t={canTriggerUnique:!1,damage:this.playerState.myPlayer.actions.primary.projectile.damage/2,range:this.utility.getRandomNum(this.playerState.myPlayer.actions.primary.projectile.range/2,this.playerState.myPlayer.actions.primary.projectile.range),spread:this.utility.getRandomNum(this.playerState.myPlayer.actions.primary.projectile.spread,2*this.playerState.myPlayer.actions.primary.projectile.spread)};this.launchProjectile(e,t)}}console.log(`Triggered Unique: ${e}`)}triggerBurstUniques(){const e=[];if(this.playerState.myPlayer.unique.includes("muzzle_splitter")&&this.luckController.luckRoll()){const t=this.playerState.myPlayer.transform.rot-Math.PI/2,a=Math.PI/180*10,s={x:Math.cos(t-a),y:Math.sin(t-a)},i={x:Math.cos(t+a),y:Math.sin(t+a)},r={canTriggerUnique:!1,damage:this.playerState.myPlayer.actions.primary.projectile.damage,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,color:this.playerState.myPlayer.actions.primary.projectile.color,length:this.playerState.myPlayer.actions.primary.projectile.length,spread:this.playerState.myPlayer.actions.primary.projectile.spread};this.launchProjectile(s,r),this.launchProjectile(i,r),console.log("Triggered burst unique: muzzle_splitter"),e.push("muzzle_splitter")}return e}triggerCollisionUniques(e){if(0===this.playerState.myPlayer.unique.length)return[];const t=[];for(const a of this.playerState.myPlayer.unique)"cluster_module"===a&&this.luckController.luckRoll()&&(this.triggerUnique(a,e),t.push("cluster_module"));return t}canReload(){return!this.playerState.isReloading&&this.playerState.myPlayer.actions.primary.magazine.currentAmmo<this.playerState.myPlayer.actions.primary.magazine.size&&this.playerState.myPlayer.actions.primary.magazine.currentReserve>0&&!this.playerState.isMelee}startReload(){this.canReload()&&(console.log("Reloading..."),this.playerState.isReloading=!0,this.playerState.reloadStartTime=Date.now(),this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0,this.decalsManager.spawnMagazineDecal(),this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:8}},duration:0,partIndex:1}),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.reload.start),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}}))}finishReload(){const e=this.playerState.myPlayer.actions.primary.magazine.size-this.playerState.myPlayer.actions.primary.magazine.currentAmmo,t=Math.min(e,this.playerState.myPlayer.actions.primary.magazine.currentReserve);this.playerState.myPlayer.actions.primary.magazine.currentAmmo+=t,this.playerState.myPlayer.actions.primary.magazine.currentReserve-=t,this.playerState.isReloading=!1,this.ui.ammoReservesUIController.removeAmmoFromReserveUI(t),this.animator.animateCharacterPart({playerId:this.userId,part:"weapon",frames:{0:{x:0,y:20},1:{x:0,y:0}},duration:175,partIndex:1}),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.reload.end),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}}),console.log("Reload complete...")}}class q{constructor(e,t,a,s,i,r,o){this.collisionsManager=e,this.combatController=t,this.moveController=a,this.playerState=s,this.roomManager=i,this.staminaController=r,this.userId=o}startDash(){if(this.playerState.isDashing||!this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)||!this.moveController.isMoving())return;const e=Date.now();if(e<this.playerState.lastDashTime+this.playerState.myPlayer.actions.dash.cooldown)return void console.log("Dash on cooldown");let{inputX:t,inputY:a,inputLength:s}=this.moveController.getMoveInput();if(!this.moveController.isMoving())return void console.log("No movement input for dash");if(t/=s,a/=s,!this.staminaController.requestStamina(this.playerState.myPlayer.actions.dash.drain))return void console.log("Not enough stamina to dash");this.playerState.myPlayer.unique.includes("spectral_image")&&(this.playerState.myPlayer.flags.hidden=!0,this.playerState.myPlayer.flags.invulnerable=!0,this.roomManager.sendMessage(JSON.stringify({type:"partial-state",userId:this.userId,flags:{hidden:!0,invulnerable:!0}}))),this.playerState.isDashing=!0,this.playerState.dashStartTime=e,this.playerState.lastDashTime=e;const i=this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.dash.multiplier;this.playerState.playerVelocityX=t*i,this.playerState.playerVelocityY=a*i,console.log(`Dashing! Speed: ${i}`)}updateDash(e){if(!this.playerState.isDashing)return;const t=Date.now();let a=this.playerState.myPlayer.transform.pos.x+this.playerState.playerVelocityX*e,s=this.playerState.myPlayer.transform.pos.y+this.playerState.playerVelocityY*e;this.playerState.myPlayer.transform.pos.x=a,this.playerState.myPlayer.transform.pos.y=s;let i=0!==this.playerState.playerVelocityX||0!==this.playerState.playerVelocityY;const r=Math.sqrt((this.playerState.myPlayer.transform.pos.x-this.playerState.lastSentX)**2+(this.playerState.myPlayer.transform.pos.y-this.playerState.lastSentY)**2);i&&r>2&&t-this.playerState.lastSentMoveTime>=10&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}}})),this.playerState.lastSentX=this.playerState.myPlayer.transform.pos.x,this.playerState.lastSentY=this.playerState.myPlayer.transform.pos.y,this.playerState.lastSentMoveTime=t),t>=this.playerState.dashStartTime+this.playerState.myPlayer.actions.dash.time&&(this.playerState.myPlayer.unique.includes("spectral_image")&&(this.playerState.myPlayer.flags.hidden=!1,this.playerState.myPlayer.flags.invulnerable=!1,this.roomManager.sendMessage(JSON.stringify({type:"partial-state",userId:this.userId,flags:{hidden:!1,invulnerable:!1}}))),this.playerState.isDashing=!1,this.playerState.myPlayer.equipment.includes("switch")&&this.combatController.toggleAutoFire(Date.now()+this.playerState.myPlayer.actions.dash.cooldown),console.log("Dash ended"))}}class U{constructor(e){this.playerState=e}luckRoll(e=1){const t=this.playerState.myPlayer.stats.luck*e,a=.1+.35*Math.tanh(t/10);return Math.random()<a}}class H{constructor(e,t){this.controlsManager=e,this.settingsManager=t}getMoveInput(){let e=0,t=0;this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveUp)&&(t-=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveDown)&&(t+=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveLeft)&&(e-=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveRight)&&(e+=1);const a=Math.sqrt(e*e+t*t);return a>0&&(e/=a,t/=a),{inputX:e,inputY:t,inputLength:a}}isMoving(){return this.getMoveInput().inputLength>0}}class V{constructor(e,t){this.playerState=e,this.utility=t,this.ammoBoxes=new Map}spawnObject(t){const a={id:this.utility.generateUID(e),transform:t.transform,timestamp:Date.now()};if("AmmoBox"===t.type)return{id:a.id,transform:a.transform,timestamp:a.timestamp,ammoAmount:t.data?.amount||10,isOpen:!1,lid:{pos:{x:0,y:0},rot:0,velocity:{x:0,y:0},torque:0}};throw new Error(`Unknown object type: ${t.type}`)}spawnAmmoBox(e){return this.spawnObject({type:"AmmoBox",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},data:{amount:e}})}}class F{constructor(e,t,a,s,i,r,o,n,l,h,d,m,c){this.audioConfig=e,this.audioManager=t,this.decalsManager=a,this.gameState=s,this.luckController=i,this.moveController=r,this.objectsManager=o,this.particlesManager=n,this.playerState=l,this.roomManager=h,this.ui=d,this.userId=m,this.utility=c,this.setupEventListeners()}setupEventListeners(){window.addEventListener("customEvent_playerHitRelay",e=>{console.log("Player hit event received:",e.detail.params),this.playerHit(e.detail.params)})}updatePlayerPosition(e){if(!this.gameState.gameInProgress||this.playerState.myPlayer.stats.health.value<=0||this.playerState.isDashing)return;const t=Date.now(),{inputX:a,inputY:s}=this.moveController.getMoveInput(),i=this.playerState.isSprinting&&this.playerState.myPlayer.stats.stamina.value>0&&this.moveController.isMoving()?this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.sprint.multiplier:this.playerState.myPlayer.stats.speed;if(this.playerState.isSprinting&&this.playerState.myPlayer.stats.stamina.value<=0&&(this.playerState.isSprinting=!1,console.log("Out of stamina, stopped sprinting")),this.playerState.playerVelocityX*=Math.pow(this.playerState.myPlayer.physics.friction,e),this.playerState.playerVelocityY*=Math.pow(this.playerState.myPlayer.physics.friction,e),this.moveController.isMoving()){const t=a*i,r=s*i;this.playerState.playerVelocityX+=(t-this.playerState.playerVelocityX)*this.playerState.myPlayer.physics.acceleration*e,this.playerState.playerVelocityY+=(r-this.playerState.playerVelocityY)*this.playerState.myPlayer.physics.acceleration*e}let r=this.playerState.myPlayer.transform.pos.x+this.playerState.playerVelocityX*e,o=this.playerState.myPlayer.transform.pos.y+this.playerState.playerVelocityY*e;this.playerState.myPlayer.transform.pos.x=r,this.playerState.myPlayer.transform.pos.y=o;let n=0!==this.playerState.playerVelocityX||0!==this.playerState.playerVelocityY;const l=Math.sqrt((this.playerState.myPlayer.transform.pos.x-this.playerState.lastSentX)**2+(this.playerState.myPlayer.transform.pos.y-this.playerState.lastSentY)**2);n&&l>2&&t-this.playerState.lastSentMoveTime>=10&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}}})),this.playerState.lastSentX=this.playerState.myPlayer.transform.pos.x,this.playerState.lastSentY=this.playerState.myPlayer.transform.pos.y,this.playerState.lastSentMoveTime=t),Math.abs(this.playerState.playerVelocityX)<.01&&(this.playerState.playerVelocityX=0),Math.abs(this.playerState.playerVelocityY)<.01&&(this.playerState.playerVelocityY=0)}playerHit(e){const t={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:300};if(this.utility.setSlider(t),e.target.id===this.userId){if(this.utility.getRandomNum(0,1)<.2){const e={src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.player.male.grunt),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"voice",pitch:{min:.95,max:1.075},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.9,max:1}};this.audioManager.playAudioNetwork(e)}}else{const t={src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.impact.flesh.bullet),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.925,max:1.15},spatial:{blend:1,pos:{x:e.source.transform.pos.x,y:e.source.transform.pos.y}},volume:{min:.95,max:1}};this.audioManager.playAudioNetwork(t);const a={id:`blood_${e.source.id}`,pos:{x:e.source.transform.pos.x,y:e.source.transform.pos.y},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.blood};this.decalsManager.createDecal(a);const s={x:-e.source.velocity.x/Math.sqrt(e.source.velocity.x**2+e.source.velocity.y**2),y:-e.source.velocity.y/Math.sqrt(e.source.velocity.x**2+e.source.velocity.y**2)},i={id:`blood_${e.source.id}`,pos:{x:e.source.transform.pos.x,y:e.source.transform.pos.y},particleParams:this.particlesManager.particlesConfig.particles.blood.spray,direction:s};this.particlesManager.createParticles(i);const r={id:`particle_emitter_${e.target.id}_${Date.now()}`,interval:this.utility.getRandomNum(200,400),lifetime:this.utility.getRandomNum(1e3,3e3),offset:{x:e.target.transform.pos.x,y:e.target.transform.pos.y},particleType:this.particlesManager.particlesConfig.particles.blood.drip,playerId:e.target.id,pos:{x:e.source.transform.pos.x,y:e.source.transform.pos.y}};if(this.particlesManager.createEmitter(r),e.newHealth<=0){console.log(`I killed ${e.target.id}!`);const t=this.ui.leaderboard.get(this.userId);t&&t.kills++;const a=this.ui.leaderboard.get(e.target.id);a&&a.deaths++,this.ui.updateLeaderboardDisplay(this.userId)}}const a={type:"player-hit",targetId:e.target.id,shooterId:e.shooterId,damage:e.damage,newHealth:e.newHealth,projectileId:e.source.id,wasKill:e.wasKill};this.roomManager.sendMessage(JSON.stringify(a))}playerDeath(){this.triggerUniques(),console.log("I died! Waiting for round to end..."),this.playerState.resetPlayerState();const e=this.objectsManager.spawnAmmoBox(10);this.objectsManager.ammoBoxes.set(e.id,e);const t={gore:{amount:this.utility.getRandomInt(2,5)},blood:{amount:this.utility.getRandomInt(1,3)},ownerId:this.userId,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},radius:this.playerState.myPlayer.stats.size};this.particlesManager.generateGore(t),this.roomManager.sendMessage(JSON.stringify({type:"player-death",playerId:this.userId,x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y,size:this.playerState.myPlayer.stats.size,ammoBox:e}))}triggerUniques(){if(0===this.playerState.myPlayer.unique.length)return[];const e=[];for(const t of this.playerState.myPlayer.unique)if("phoenix_module"===t&&this.luckController.luckRoll(1.5)){console.log("Phoenix Module activated!"),this.playerState.myPlayer.actions.primary.projectile.damage*=2;const t=this.playerState.myPlayer.unique.indexOf("phoenix_module");t>-1&&this.playerState.myPlayer.unique.splice(t,1),e.push("phoenix_module")}return e}}class W{constructor(e,t,a){this.playerConfig=e,this.userId=t,this.utility=a,this.players=new Map,this.isHost=!1,this.canShoot=!0,this.canAutoFire=!1,this.isBurstActive=!1,this.isReloading=!1,this.isMelee=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.lastSentX=0,this.lastSentY=0,this.lastSentRotation=0,this.lastSentRotationTime=0,this.lastSentMoveTime=0,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastShotTime=0,this.lastMeleeTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0,this.statListeners=new Map,this.myPlayer=this.initPlayer(this.userId)}initPlayer(e){return this.myPlayer={id:e,transform:{pos:{x:3170*Math.random()+o,y:2370*Math.random()+o},rot:0},timestamp:Date.now(),color:this.utility.getRandomColor(),actions:{dash:{cooldown:this.playerConfig.default.actions.dash.cooldown,drain:this.playerConfig.default.actions.dash.drain,multiplier:this.playerConfig.default.actions.dash.multiplier,time:this.playerConfig.default.actions.dash.time},melee:{cooldown:this.playerConfig.default.actions.melee.cooldown,damage:this.playerConfig.default.actions.melee.damage,duration:this.playerConfig.default.actions.melee.duration,range:this.playerConfig.default.actions.melee.range,size:this.playerConfig.default.actions.melee.size},primary:{buffer:this.playerConfig.default.actions.primary.buffer,burst:{amount:this.playerConfig.default.actions.primary.burst.amount,delay:this.playerConfig.default.actions.primary.burst.delay},magazine:{currentAmmo:this.playerConfig.default.actions.primary.magazine.size,currentReserve:this.playerConfig.default.actions.primary.magazine.startingReserve,maxReserve:this.playerConfig.default.actions.primary.magazine.maxReserve,size:this.playerConfig.default.actions.primary.magazine.size},offset:this.playerConfig.default.actions.primary.offset,projectile:{amount:this.playerConfig.default.actions.primary.projectile.amount,color:this.playerConfig.default.actions.primary.projectile.color,damage:this.playerConfig.default.actions.primary.projectile.damage,length:this.playerConfig.default.actions.primary.projectile.length,range:this.playerConfig.default.actions.primary.projectile.range,size:this.playerConfig.default.actions.primary.projectile.size,speed:this.playerConfig.default.actions.primary.projectile.speed,spread:this.playerConfig.default.actions.primary.projectile.spread},reload:{time:this.playerConfig.default.actions.primary.reload.time}},sprint:{drain:this.playerConfig.default.actions.sprint.drain,multiplier:this.playerConfig.default.actions.sprint.multiplier}},equipment:this.playerConfig.default.equipment,flags:{hidden:this.playerConfig.default.flags.hidden,invulnerable:this.playerConfig.default.flags.invulnerable},inventory:{primary:this.playerConfig.default.inventory.primary,melee:this.playerConfig.default.inventory.melee},physics:{acceleration:this.playerConfig.default.physics.acceleration,friction:this.playerConfig.default.physics.friction},rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon},stats:{defense:this.playerConfig.default.stats.defense,health:{max:this.playerConfig.default.stats.health.max,value:this.playerConfig.default.stats.health.max},luck:this.playerConfig.default.stats.luck,size:this.playerConfig.default.stats.size,speed:this.playerConfig.default.stats.speed,stamina:{max:this.playerConfig.default.stats.stamina.max,recovery:{delay:this.playerConfig.default.stats.stamina.recovery.delay,rate:this.playerConfig.default.stats.stamina.recovery.rate},value:this.playerConfig.default.stats.stamina.max}},unique:this.playerConfig.default.unique}}resetPlayerState(){this.canShoot=!0,this.isBurstActive=!1,this.isReloading=!1,this.isMelee=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastMeleeTime=0,this.lastShotTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0,this.lastSentX=0,this.lastSentY=0,this.lastSentRotation=0,this.lastSentRotationTime=0,this.lastSentMoveTime=0}onStatChange(e,t){this.statListeners.set(e,t)}notifyChange(e,t){const a=this.statListeners.get(e);a&&a(t)}updateStat(e,t){const a=e.split(".");let s=this.myPlayer;for(let e=0;e<a.length-1;e++)s=s[a[e]];const i=a[a.length-1];s[i]=t,console.log(`${i}: ${t}`),this.notifyChange(e,t)}}class G{constructor(e){this.playerState=e}requestStamina(e){return this.playerState.myPlayer.stats.stamina.value<e?(console.log(`Insufficient stamina! Need: ${e}, Have: ${this.playerState.myPlayer.stats.stamina}`),!1):(this.playerState.myPlayer.stats.stamina.value-=e,this.playerState.isStaminaRecoveryBlocked=!0,this.playerState.staminaRecoveryBlockedUntil=Date.now()+this.playerState.myPlayer.stats.stamina.recovery.delay,console.log(`Stamina drained: -${e}, Remaining: ${this.playerState.myPlayer.stats.stamina}`),!0)}updateStamina(e){const t=Date.now();if(this.playerState.isSprinting&&t>=this.playerState.lastStaminaDrainTime+100&&(this.requestStamina(this.playerState.myPlayer.actions.sprint.drain)||(this.playerState.isSprinting=!1,console.log("Out of stamina, stopped sprinting")),this.playerState.lastStaminaDrainTime=t),(!this.playerState.isStaminaRecoveryBlocked||t>=this.playerState.staminaRecoveryBlockedUntil)&&(this.playerState.isStaminaRecoveryBlocked=!1,this.playerState.myPlayer.stats.stamina.value<this.playerState.myPlayer.stats.stamina.max&&!this.playerState.isSprinting)){const t=this.playerState.myPlayer.stats.stamina.recovery.rate/1e3*16.67*e;this.playerState.myPlayer.stats.stamina.value=Math.min(this.playerState.myPlayer.stats.stamina.max,this.playerState.myPlayer.stats.stamina.value+t)}}}class K{constructor(){this.default={actions:{dash:{cooldown:1e3,drain:40,multiplier:3,time:150},melee:{cooldown:250,damage:10,duration:100,range:10,size:2},primary:{buffer:250,burst:{amount:1,delay:75},magazine:{size:10,startingReserve:20,maxReserve:50},offset:10,projectile:{amount:1,color:"#fff5beff",damage:25,length:15,range:5,size:1,speed:35,spread:10},reload:{time:750}},sprint:{drain:5,multiplier:1.75}},data:{idLength:12,idOffset:25},equipment:[],flags:{hidden:!1,invulnerable:!1},inventory:{primary:"glock",melee:"knife"},physics:{acceleration:.65,friction:.8},rig:{body:"default",head:"default",headwear:"default",weapon:"glock"},stats:{defense:0,health:{max:100},luck:1,size:100,speed:6,stamina:{max:100,recovery:{delay:1e3,rate:25}}},unique:[]}}}class Y{constructor(){this.mixer={master:1,interface:.85,music:.75,sfx:.9,voice:1},this.resources={sfx:{impact:{flesh:{bullet:["/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_00.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_01.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_02.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_03.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_04.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_05.ogg"]},metal:{bullet:["/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_00.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_01.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_02.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_03.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_04.ogg"]}},player:{male:{grunt:["/assets/audio/sfx/player/voice/male/player_male_hit_00.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_01.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_02.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_03.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_04.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_05.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_06.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_07.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_08.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_09.ogg"]}},weapon:{glock:{attack:["/assets/audio/sfx/weapons/glock/glock_attack_00.ogg","/assets/audio/sfx/weapons/glock/glock_attack_01.ogg","/assets/audio/sfx/weapons/glock/glock_attack_02.ogg","/assets/audio/sfx/weapons/glock/glock_attack_03.ogg","/assets/audio/sfx/weapons/glock/glock_attack_04.ogg","/assets/audio/sfx/weapons/glock/glock_attack_05.ogg"],empty:["/assets/audio/sfx/weapons/glock/glock_empty_00.ogg"],reload:{end:["/assets/audio/sfx/weapons/glock/glock_reload_end_00.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_01.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_02.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_03.ogg"],start:["/assets/audio/sfx/weapons/glock/glock_reload_start_00.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_01.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_02.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_03.ogg"]},shell:["/assets/audio/sfx/weapons/glock/glock_shell_00.ogg","/assets/audio/sfx/weapons/glock/glock_shell_01.ogg","/assets/audio/sfx/weapons/glock/glock_shell_02.ogg","/assets/audio/sfx/weapons/glock/glock_shell_03.ogg","/assets/audio/sfx/weapons/glock/glock_shell_04.ogg","/assets/audio/sfx/weapons/glock/glock_shell_05.ogg","/assets/audio/sfx/weapons/glock/glock_shell_06.ogg","/assets/audio/sfx/weapons/glock/glock_shell_07.ogg","/assets/audio/sfx/weapons/glock/glock_shell_08.ogg","/assets/audio/sfx/weapons/glock/glock_shell_09.ogg","/assets/audio/sfx/weapons/glock/glock_shell_10.ogg","/assets/audio/sfx/weapons/glock/glock_shell_11.ogg","/assets/audio/sfx/weapons/glock/glock_shell_12.ogg","/assets/audio/sfx/weapons/glock/glock_shell_13.ogg","/assets/audio/sfx/weapons/glock/glock_shell_14.ogg"]}}}},this.settings={maxConcurrent:5,poolSize:10,preloadSounds:!0}}}class J{constructor(e,t){this.playerState=e,this.utility=t,this.pos={x:0,y:0},this.targetPos={x:0,y:0},this.config={followSpeed:.1,lookAhead:100}}update(e){const t=this.playerState.myPlayer.transform.rot-Math.PI/2,a=this.utility.forward(t),s=a.x*this.config.lookAhead,i=a.y*this.config.lookAhead;this.targetPos.x=this.playerState.myPlayer.transform.pos.x+s-400,this.targetPos.y=this.playerState.myPlayer.transform.pos.y+i-300,this.targetPos.x=Math.max(0,Math.min(2400,this.targetPos.x)),this.targetPos.y=Math.max(0,Math.min(1800,this.targetPos.y)),this.pos.x+=(this.targetPos.x-this.pos.x)*this.config.followSpeed*e,this.pos.y+=(this.targetPos.y-this.pos.y)*this.config.followSpeed*e}worldToScreen(e){return{x:e.x-this.pos.x,y:e.y-this.pos.y}}screenToWorld(e){return{x:e.x+this.pos.x,y:e.y+this.pos.y}}isVisible(e,t=50){return e.x>=this.pos.x-t&&e.x<=this.pos.x+n+t&&e.y>=this.pos.y-t&&e.y<=this.pos.y+l+t}}class X{constructor(e,t,a,s,i){this.version=0,this.pos={x:0,y:0},this.size=0,this.pixelData=t,this.heightData=a,this.waterData=s,this.chosenBiomeName=e,this.worldConfig=i}getColorAt(e,t,a){const s=t*a+e,i=this.pixelData[s],r=i>>2,o=3&i;return Object.values(this.worldConfig.materials)[r].colors[o]}getHeightAt(e,t,a){const s=t*a+e;return this.heightData[s]/255}getWaterAt(e,t,a){const s=t*a+e;return this.waterData[s]/255}}class Q{constructor(){this.worldgenParams={general:{chunk:{size:128},cell:{size:2},options:{island:!1,valley:!1},seed:0},terrain:{noiseType:A.VA.Perlin,intensity:2,octaves:6,scale:5e-4,persistence:.55,heightCurve:1.5,seaLevel:.18,lowestDepth:.1},material:{noiseType:A.VA.Perlin,scale:.005,detail:{noiseType:A.VA.Perlin,scale:1},colorVariation:.75},degen:{noiseType:A.VA.Perlin,scale:1e-4,intensity:.35,minHeight:.1,threshold:.55,hardness:.5,detail:{noiseType:A.VA.Perlin,scale:.005}},hydration:{noiseType:A.VA.Perlin,intensity:.5,scale:.001,multiplier:1},render:{water:{opacityBase:.55,opacityMultiplier:.975,foamIntensity:1,foamScale:.035,noiseScale:.001,shoreBlend:.0275,shimmerStrength:.15,depthDarkness:1},grid:{enabled:!1,lineWidth:1,chunkBorderColor:"#a1a1a1",worldBorderColor:"#9747ff",layerBorderColor:"#ff4343",borderWidth:3}}},this.worldLayers={foundation:{name:"foundation",height:.05,materials:[{material:"bedrock",weight:10,blend:.1},{material:"granite",weight:6,blend:.2},{material:"basalt",weight:3,blend:.2}]},substrate:{name:"substrate",height:.07,materials:[{material:"granite",weight:6,blend:.3},{material:"limestone",weight:4,blend:.5},{material:"shale",weight:3,blend:.4},{material:"slate",weight:2,blend:.4}]},sediment:{name:"sediment",height:.12,materials:[{material:"silt",weight:4,blend:.9},{material:"sand",weight:5,blend:.9},{material:"gravel",weight:2,blend:.6},{material:"dirt",weight:1,blend:.4}]},alluvium:{name:"alluvium",height:.18,materials:[{material:"silt",weight:3,blend:.95},{material:"sand",weight:6,blend:.9},{material:"gravel",weight:3,blend:.6},{material:"stone",weight:1,blend:.2}]},soil:{name:"soil",height:.3,materials:[{material:"grass",weight:7,blend:.8},{material:"dirt",weight:2,blend:.6},{material:"gravel",weight:2,blend:.7},{material:"stone",weight:1,blend:.3}]},topsoil:{name:"topsoil",height:.45,materials:[{material:"grass",weight:7,blend:.8},{material:"dirt",weight:2,blend:.6},{material:"gravel",weight:1,blend:.4}]},cliffs:{name:"cliffs",height:.7,materials:[{material:"stone",weight:6,blend:.3},{material:"gravel",weight:3,blend:.5},{material:"dirt",weight:1,blend:.6},{material:"snow",weight:1,blend:.8}]},mountains:{name:"mountains",height:.9,materials:[{material:"stone",weight:2,blend:.3},{material:"gravel",weight:1,blend:.4},{material:"snow",weight:4,blend:.8},{material:"ice",weight:3,blend:.9}]}},this.materials={basalt:{name:"basalt",type:"terrain",colors:["#2e2e2e","#3e3e3e","#4e4e4e","#5e5e5e"],physics:{type:A.wr.Solid,simulate:!1,durability:.8,friction:.88,density:.88}},bedrock:{name:"bedrock",type:"terrain",colors:["#2f3236","#3a3e44","#454a52","#50565f"],physics:{type:A.wr.Solid,simulate:!1,durability:1,friction:.9,density:.95}},clay:{name:"clay",type:"terrain",colors:["#6f5a4a","#7c6755","#897461","#96816e"],physics:{type:A.wr.Solid,simulate:!1,durability:.2,friction:.75,density:.4}},dirt:{name:"dirt",type:"terrain",colors:["#5b3a1f","#6b4a2f","#7b5a3f","#8b6a4f"],physics:{type:A.wr.Solid,simulate:!1,durability:.2,friction:.8,density:.5}},granite:{name:"granite",type:"terrain",colors:["#6e6e6e","#7e7e7e","#8e8e8e","#9e9e9e"],physics:{type:A.wr.Solid,simulate:!1,durability:.9,friction:.9,density:.9}},grass:{name:"grass",type:"terrain",colors:["#3a5f3e","#4a6f4e","#5a7f5e","#6a8f6e"],physics:{type:A.wr.Solid,simulate:!1,durability:.2,friction:.8,density:.5}},gravel:{name:"gravel",type:"terrain",colors:["#606060","#707070","#808080","#909090"],physics:{type:A.wr.Solid,simulate:!0,durability:.1,friction:.6,density:.3}},ice:{name:"ice",type:"terrain",colors:["#a9d5ff","#8fc5ff","#6fb5ff","#5aa4f2"],physics:{type:A.wr.Solid,simulate:!1,durability:.3,friction:.4,density:.5}},permafrost:{name:"permafrost",type:"terrain",colors:["#a4b5ef","#7aabeb","#9bc6f5","#7d92f9"],physics:{type:A.wr.Solid,simulate:!1,durability:.7,friction:.85,density:.8}},loam:{name:"loam",type:"terrain",colors:["#2d1f12","#3a2918","#4a361f","#5a4328"],physics:{type:A.wr.Solid,simulate:!1,durability:.2,friction:.8,density:.55}},limestone:{name:"limestone",type:"terrain",colors:["#c0b8a0","#b0a890","#a09880","#908870"],physics:{type:A.wr.Solid,simulate:!1,durability:.5,friction:.8,density:.7}},moss:{name:"moss",type:"terrain",colors:["#264a2f","#2f5a3a","#376a45","#3f7a50"],physics:{type:A.wr.Solid,simulate:!1,durability:.1,friction:.8,density:.4}},peat:{name:"peat",type:"terrain",colors:["#1a150f","#241e16","#2e271e","#383024"],physics:{type:A.wr.Solid,simulate:!1,durability:.1,friction:.6,density:.3}},sand:{name:"sand",type:"terrain",colors:["#b2a280","#c2b290","#d2c2a0","#e2d2b0"],physics:{type:A.wr.Solid,simulate:!0,durability:.1,friction:.6,density:.2}},sandstone:{name:"sandstone",type:"terrain",colors:["#c2b290","#b2a280","#a29270","#928260"],physics:{type:A.wr.Solid,simulate:!1,durability:.4,friction:.75,density:.65}},scree:{name:"scree",type:"terrain",colors:["#868680","#8f8f88","#999990","#a3a399"],physics:{type:A.wr.Solid,simulate:!1,durability:.4,friction:.75,density:.65}},shale:{name:"shale",type:"terrain",colors:["#4f555d","#5a616a","#656d77","#707a85"],physics:{type:A.wr.Solid,simulate:!1,durability:.4,friction:.75,density:.7}},silt:{name:"silt",type:"terrain",colors:["#7a7362","#777165","#6b6965","#6d6755"],physics:{type:A.wr.Solid,simulate:!0,durability:.1,friction:.5,density:.3}},slate:{name:"slate",type:"terrain",colors:["#4a4f55","#555a60","#60656b","#6b7076"],physics:{type:A.wr.Solid,simulate:!1,durability:.6,friction:.82,density:.75}},snow:{name:"snow",type:"terrain",colors:["#ffffff","#e6eef5","#dfe8f2","#cfdceb"],physics:{type:A.wr.Solid,simulate:!1,durability:.2,friction:.9,density:.4}},stone:{name:"stone",type:"terrain",colors:["#707070","#808080","#909090","#a0a0a0"],physics:{type:A.wr.Solid,simulate:!1,durability:.5,friction:.85,density:.75}},coal:{name:"coal",type:"mineral",colors:["#0a0a0a","#1a1a1a","#2a2a2a","#3a3a3a"],physics:{type:A.wr.Solid,simulate:!1,durability:.6,friction:.85,density:.55}},iron:{name:"iron",type:"mineral",colors:["#7b3716","#8b4726","#9b5736","#ab6746"],physics:{type:A.wr.Solid,simulate:!1,durability:.7,friction:.85,density:.9}},gold:{name:"gold",type:"mineral",colors:["#eec700","#fed700","#ffe700","#fff74c"],physics:{type:A.wr.Solid,simulate:!1,durability:.8,friction:.85,density:.8}},silver:{name:"silver",type:"mineral",colors:["#b0b0b0","#c0c0c0","#d0d0d0","#e0e0e0"],physics:{type:A.wr.Solid,simulate:!1,durability:.7,friction:.85,density:.75}},copper:{name:"copper",type:"mineral",colors:["#a86323","#b87333","#c88343","#d89353"],physics:{type:A.wr.Solid,simulate:!1,durability:.6,friction:.85,density:.7}},wood:{name:"wood",type:"surface",colors:["#7b3503","#8b4513","#9b5523","#ab6533"],physics:{type:A.wr.Solid,simulate:!1,durability:.4,friction:.85,density:.5}},concrete:{name:"concrete",type:"surface",colors:["#2a2a2a","#3a3a3a","#4a4a4a","#5a5a5a"],physics:{type:A.wr.Solid,simulate:!1,durability:.8,friction:.85,density:.65}},metal:{name:"metal",type:"surface",colors:["#4a4a4a","#6a6a6a","#7a7a7a","#8a8a8a"],physics:{type:A.wr.Solid,simulate:!1,durability:.9,friction:.85,density:.8}},asphalt:{name:"asphalt",type:"surface",colors:["#1b1b1b","#2b2b2b","#3b3b3b","#4b4b4b"],physics:{type:A.wr.Solid,simulate:!1,durability:.8,friction:.85,density:.7}},water:{name:"water",type:"liquid",colors:["#2d6bc9","#2450a6","#1f3f8a","#1a2f6e"],physics:{type:A.wr.Liquid,simulate:!0,viscosity:.2}}}}}class Z{constructor(e,t,a,s,i){this.camera=e,this.controlsManager=t,this.ui=a,this.utility=s,this.world=i,this.hoveredChunk=null,this.overlayMode=0,this.overlayNames=["Grid","Heightmap","Contours"],this.listenForDebugShortcuts()}listenForDebugShortcuts(){window.addEventListener("keydown",e=>{if(e.ctrlKey&&e.altKey)switch(e.code){case"Numpad0":e.preventDefault(),console.log("Opening generation menu..."),this.world.showGenerationMenu().then(async e=>{await this.world.generateWorld(e)});break;case"NumpadDecimal":e.preventDefault(),console.log("Refreshing world rendering..."),this.world.renderMenu();break;case"NumpadEnter":e.preventDefault(),this.world.worldConfig.worldgenParams.render.grid.enabled=!this.world.worldConfig.worldgenParams.render.grid.enabled,this.world.worldConfig.worldgenParams.render.grid.enabled||(this.hoveredChunk=null),console.log("Overlay "+(this.world.worldConfig.worldgenParams.render.grid.enabled?"enabled":"disabled")+" (mode: "+this.overlayNames[this.overlayMode]+")")}this.world.worldConfig.worldgenParams.render.grid.enabled&&e.ctrlKey&&e.altKey&&("["!==e.key&&"BracketLeft"!==e.code||(e.preventDefault(),this.overlayMode=(this.overlayMode-1+this.overlayNames.length)%this.overlayNames.length,console.log("Overlay mode: "+this.overlayNames[this.overlayMode])),"]"!==e.key&&"BracketRight"!==e.code||(e.preventDefault(),this.overlayMode=(this.overlayMode+1)%this.overlayNames.length,console.log("Overlay mode: "+this.overlayNames[this.overlayMode])))})}drawDebug(){if(this.ui.ctx&&this.world.isGenerated&&this.world.worldConfig.worldgenParams.render.grid.enabled){switch(this.overlayMode){case 0:this.drawGrid();break;case 1:this.drawHeightmap();break;case 2:this.drawContours()}this.drawInfoPanels()}}drawInfoPanels(){const e=this.world.updateHoveredChunk();if(!e||!this.hoveredChunk)return;const t=this.world.worldConfig.worldgenParams.general.chunk.size,[a,s]=this.hoveredChunk.split(",").map(Number),i=Math.floor(e.worldX),r=Math.floor(e.worldY),o={x:i,y:r},n=`${a},${s}`,l=this.world.chunks.get(n),h=this.world.chunkLayers.get(n);if(!l)return;const d=i-a*t,m=r-s*t,c=m*t+d,y=l.pixelData[c],u=y>>2,p=3&y,g=l.getHeightAt(d,m,t),f=Object.values(this.world.worldConfig.materials)[u],w=this.world.getWaterData(o);let S=10;const b=[`Layer: ${h?h.name:"N/A"}`,`Chunk: ${a}, ${s} (${t}x${t})`,`Pixel: ${i}, ${r}`,`Height: ${g.toFixed(3)}`];if(S+=this.drawPanel("Main",b,S,10,"#888888",null)+10,f&&f.physics.type===A.wr.Solid){const e=this.utility.getLightestColor(f.colors),t=[`Material: ${f.name} [${u}]`,`Type: ${f.type}`,`Color Var: ${p}`,`Simulate: ${f.physics.simulate}`,`Durability: ${f.physics.durability.toFixed(2)}`,`Friction: ${f.physics.friction.toFixed(2)}`,`Density: ${f.physics.density.toFixed(2)}`];S+=this.drawPanel("Solid",t,S,10,e,e)+10}if(w&&w.hasWater){const e=w.material.physics;if(e.type===A.wr.Liquid){const t=this.utility.getLightestColor(w.material.colors),a=[`Material: ${w.material.name}`,`Depth: ${w.depth.toFixed(3)}`,`Simulate: ${e.simulate}`,`Viscosity: ${e.viscosity.toFixed(2)}`];S+=this.drawPanel("Liquid",a,S,10,t,t)+10}}}drawPanel(e,t,a,s,i,r){const o=this.ui.ctx;if(!o)return 0;o.font="11px monospace",o.textAlign="left";let n=o.measureText(e).width;t.forEach(e=>{n=Math.max(n,o.measureText(e).width)});const l=n+16,h=24+14*t.length+8;return o.fillStyle="rgba(0, 0, 0, 0.85)",o.fillRect(a,s,l,h),o.strokeStyle=i,o.lineWidth=2,o.strokeRect(a,s,l,h),r&&(o.fillStyle=r,o.fillRect(a,s,l,20)),o.font="bold 12px monospace",o.fillStyle=r?"#000000":i,o.fillText(e,a+8,s+8+10),o.fillStyle=r?i:"#ffffff",o.font="11px monospace",t.forEach((e,t)=>{o.fillText(e,a+8,s+20+4+8+14*t)}),l}drawGrid(){if(!this.ui.ctx||!this.world.isGenerated)return;const e=this.ui.ctx,t=this.world.worldConfig.worldgenParams.general.chunk.size,a=this.camera.pos.x,s=this.camera.pos.y,o=Math.floor(a/t),h=Math.ceil((a+n)/t),d=Math.floor(s/t),m=Math.ceil((s+l)/t);if(e.save(),this.hoveredChunk){const[i,r]=this.hoveredChunk.split(",").map(Number),o=i*t-a,n=r*t-s,l=this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor.slice(1),h=parseInt(l.slice(0,2),16),d=parseInt(l.slice(2,4),16),m=parseInt(l.slice(4,6),16);e.fillStyle=`rgba(${h}, ${d}, ${m}, 0.2)`,e.fillRect(o,n,t,t)}for(let i=o;i<h;i++)for(let r=d;r<m;r++){const o=i*t-a,n=r*t-s,l=this.world.getChunkLayer(i,r),h=this.world.getChunkLayer(i+1,r)||l,d=this.world.getChunkLayer(i,r+1)||l,m=!(!l||!h||l.name===h.name),c=!(!l||!d||l.name===d.name);e.beginPath(),e.moveTo(o+t,n),e.lineTo(o+t,n+t),e.lineWidth=m?this.world.worldConfig.worldgenParams.render.grid.borderWidth:this.world.worldConfig.worldgenParams.render.grid.lineWidth,e.strokeStyle=m?this.world.worldConfig.worldgenParams.render.grid.layerBorderColor:this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor,e.stroke(),e.beginPath(),e.moveTo(o,n+t),e.lineTo(o+t,n+t),e.lineWidth=c?this.world.worldConfig.worldgenParams.render.grid.borderWidth:this.world.worldConfig.worldgenParams.render.grid.lineWidth,e.strokeStyle=c?this.world.worldConfig.worldgenParams.render.grid.layerBorderColor:this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor,e.stroke()}e.strokeStyle=this.world.worldConfig.worldgenParams.render.grid.worldBorderColor,e.lineWidth=this.world.worldConfig.worldgenParams.render.grid.borderWidth,e.strokeRect(0-a,0-s,i,r),e.restore()}drawHeightmap(){const e=this.ui.ctx;if(!e||!this.world.isGenerated)return;const t=this.camera.pos.x,a=this.camera.pos.y,s=this.world.worldConfig.worldgenParams.general.chunk.size,{seaLevel:i,lowestDepth:r}=this.world.worldConfig.worldgenParams.terrain,o=this.world.worldConfig.worldLayers;e.save(),e.globalAlpha=.6;const h=Math.floor(t/s),d=Math.ceil((t+n)/s),m=Math.floor(a/s),c=Math.ceil((a+l)/s),y=(e,t,a)=>[Math.floor(this.utility.lerp(e[0],t[0],a)),Math.floor(this.utility.lerp(e[1],t[1],a)),Math.floor(this.utility.lerp(e[2],t[2],a))],u=[];u.push([r,[0,0,90]]),u.push([.5*i,[0,60,170]]),u.push([i-.05,[0,120,220]]),u.push([i+.05,[0,200,140]]);for(const e of Object.values(o)){const t=e.height;if(t<=i)continue;const a=Object.keys(o).indexOf(e.name)/(Object.keys(o).length-1);let s;s=a<.25?[60,220,80]:a<.5?[230,230,60]:a<.75?[240,140,50]:a<.95?[255,70,40]:[255,255,255],u.push([t,s])}u.sort((e,t)=>e[0]-t[0]);for(let i=h;i<d;i++)for(let r=m;r<c;r++){const o=`${i},${r}`,n=this.world.chunks.get(o);if(!n)continue;const l=i*s-t,h=r*s-a;for(let t=0;t<s;t+=4)for(let a=0;a<s;a+=4){const i=n.getHeightAt(a,t,s);let r=u[0],o=u[u.length-1];for(let e=0;e<u.length-1;e++)if(i>=u[e][0]&&i<=u[e+1][0]){r=u[e],o=u[e+1];break}const d=o[0]-r[0];let m=d>0?(i-r[0])/d:0;m=this.utility.smoothstep(m);const[c,p,g]=y(r[1],o[1],m);e.fillStyle=`rgb(${c},${p},${g})`,e.fillRect(l+a,h+t,4,4)}}e.restore()}drawContours(){const e=this.ui.ctx;if(!e||!this.world.isGenerated)return;const t=this.camera.pos.x,a=this.camera.pos.y,s=this.world.worldConfig.worldgenParams.general.chunk.size,i=.02;e.save(),e.lineWidth=1,e.strokeStyle="rgba(0,0,0,0.35)";const r=Math.floor(t/s),o=Math.ceil((t+n)/s),h=Math.floor(a/s),d=Math.ceil((a+l)/s),m=(e,t,a)=>e.getHeightAt(t,a,s);for(let n=r;n<o;n++)for(let r=h;r<d;r++){const o=`${n},${r}`,l=this.world.chunks.get(o);if(!l)continue;const h=n*s-t,d=r*s-a;for(let t=0;t<s-2;t+=2)for(let a=0;a<s-2;a+=2){const s=m(l,a,t),r=m(l,a+2,t),o=m(l,a,t+2),n=m(l,a+2,t+2),c=Math.min(s,r,o,n),y=Math.max(s,r,o,n);for(let l=Math.floor(c/i)*i;l<=y;l+=i)if(l>=c&&l<=y){e.beginPath();const i=(e,t,a)=>{const s=(a-e)/(t-e);return Math.max(0,Math.min(1,s))},m=[];if((l-s)*(l-r)<0&&m.push({x:h+a+2*i(s,r,l),y:d+t}),(l-r)*(l-n)<0&&m.push({x:h+a+2,y:d+t+2*i(r,n,l)}),(l-n)*(l-o)<0&&m.push({x:h+a+2*(1-i(n,o,l)),y:d+t+2}),(l-o)*(l-s)<0&&m.push({x:h+a,y:d+t+2*(1-i(o,s,l))}),m.length>=2){e.moveTo(m[0].x,m[0].y);for(let t=1;t<m.length;t++)e.lineTo(m[t].x,m[t].y);e.stroke()}}}}e.restore()}}class ee{constructor(e,t,a,s){this.world=e,this.roomManager=t,this.ui=a,this.utility=s}requestCraterAt(e){const t=this.world.worldConfig.worldgenParams.general.chunk.size,a=Math.floor(e.x/t),s=Math.floor(e.y/t),i=`${a},${s}`,r=this.world.chunks.get(i);if(!r)return;const o=Math.floor(e.x)%t,n=Math.floor(e.y)%t,l=this.world.worldConfig.materials.bedrock,h=Object.keys(this.world.worldConfig.materials).indexOf("bedrock");for(let e=-10;e<=10;e++)for(let a=-10;a<=10;a++){const s=o+a,i=n+e;if(s<0||s>=t||i<0||i>=t)continue;const d=i*t+s,m=h<<2|Math.floor(Math.random()*l.colors.length);r.pixelData[d]=m,r.heightData[d]=Math.max(0,r.heightData[d]-1)}this.world.renderChunk(a,s,r);const d={pos:{x:a,y:s},version:Date.now(),size:t,layer:this.world.chunkLayers.get(i)?.name||"unknown",cellData:{worldPixelData:r.pixelData,worldHeightData:r.heightData,worldWaterData:r.waterData,cellLayerGrid:[]}};this.roomManager.sendMessage(JSON.stringify({type:"chunk-update",chunk:d})),console.log(`Crater applied: ${e.x},${e.y}`)}}class te{constructor(e,t,a,s,i,r){this.camera=e,this.controlsManager=t,this.playerState=a,this.roomManager=s,this.ui=i,this.utility=r,this.chunks=new Map,this.chunkLayers=new Map,this.isGenerated=!1,this.currentSeed=0,this.erosionTemplate=null,this.chunkBuffer=[],this.worldBuffer=null,this.streamingComplete=!1,this.YIELD_RATE=10,this.CHUNK_LOAD_RADIUS=2*Math.max(n,l),this.WORLDGEN_PHASES=["cells","degen","hydration"],this.worldConfig=new Q,this.worldDebug=new Z(this.camera,this.controlsManager,this.ui,this.utility,this),this.worldEdit=new ee(this,this.roomManager,this.ui,this.utility),this.initLoadingProgressEvents()}clear(){this.chunks.clear(),this.chunkLayers.clear(),this.worldDebug.hoveredChunk=null,this.isGenerated=!1,this.chunkBuffer=[],this.worldBuffer=null,this.ui.worldCtx&&this.ui.worldCanvas&&this.ui.worldCtx.clearRect(0,0,i,r)}handleChunkUpdate(e){if(!e||!e.pos)return;const t=`${e.pos.x},${e.pos.y}`,a=this.chunks.get(t);if(a&&(e.version??0)<=a.version)return;const s=new X(e.layer,e.cellData.worldPixelData,e.cellData.worldHeightData,e.cellData.worldWaterData,this.worldConfig);s.version=e.version,s.pos=e.pos,s.size=e.size,this.chunks.set(t,s),this.chunkLayers.set(t,this.worldConfig.worldLayers[e.layer]||Object.values(this.worldConfig.worldLayers)[0]),console.log(` Synced chunk ${t} (v${e.version})`),this.renderChunk(e.pos.x,e.pos.y,s)}async showGenerationMenu(){await this.worldgenMenu();const e=this.worldConfig.worldgenParams,t=e.general.seed||Date.now();return e.general.seed=t,this.currentSeed=t,{seed:t,params:e}}async generateWorld(e){this.showLoadingMenu(),this.worldConfig.worldgenParams=e.params,this.currentSeed=e.seed,this.clear();const t=await this.generateCells(e.seed),a=await this.applyDegen(t,e.seed),s=await this.applyHydration(a,e.seed);await this.bakeChunksFromCells(s),this.isGenerated=!0,this.hideLoadingMenu(),console.log(`World generated: ${e.seed}`)}async generateCells(e){const t=this.worldConfig.worldgenParams.general.cell.size,a=this.worldConfig.worldgenParams.terrain.lowestDepth,s=Object.keys(this.worldConfig.worldLayers),o=Object.keys(this.worldConfig.materials),n=Math.ceil(i/t),l=Math.ceil(r/t),h=new Uint8Array(768e4),d=new Uint8Array(768e4),m=Array.from({length:l},()=>new Array(n).fill(0)),c=["building cells...","placing pixels...","spawning pixels...","creating cells..."],y=c[Math.floor(Math.random()*c.length)];await this.utility.yield(y);const u=n*l;let p=0;for(let c=0;c<l;c++)for(let l=0;l<n;l++){p++,p%Math.floor(u/this.YIELD_RATE)===0&&await this.utility.yield();let n=this.utility.getNoise(this.worldConfig.worldgenParams.terrain.noiseType,(l+.5)*this.worldConfig.worldgenParams.terrain.scale,(c+.5)*this.worldConfig.worldgenParams.terrain.scale,e,{octaves:this.worldConfig.worldgenParams.terrain.octaves,persistence:this.worldConfig.worldgenParams.terrain.persistence});n<0?n=0:n>1&&(n=1);const y=.5;n=y+(n-y)*this.worldConfig.worldgenParams.terrain.intensity,n<0?n=0:n>1&&(n=1),n=Math.pow(n,this.worldConfig.worldgenParams.terrain.heightCurve),n<0?n=0:n>1&&(n=1);const g=this.worldConfig.worldgenParams.general.options;if(g.island||g.valley){const a=this.worldConfig.worldgenParams.terrain.seaLevel,s=this.worldConfig.worldgenParams.terrain.lowestDepth,o=Math.min(l*t,i-(l*t+t)),h=Math.min(c*t,r-(c*t+t)),d=Math.min(o,h),m=.5*Math.min(i,r);let y=Math.min(1,d/m);y=y*y*(3-2*y);const u=.1*this.utility.getNoise(this.worldConfig.worldgenParams.terrain.noiseType,.002*l,.002*c,e+9100,{octaves:2,persistence:.5});if(g.island){Math.pow(1-y,1.5*this.worldConfig.worldgenParams.terrain.heightCurve);const e=.5*a;n=this.utility.lerp(e,n,y+u),n<s?n=s:n>1&&(n=1)}else if(g.valley){const e=Math.pow(1-y,1.5*this.worldConfig.worldgenParams.terrain.heightCurve),t=1;n=this.utility.lerp(n,t,e+u),n<s?n=s:n>1&&(n=1)}}n<a&&(n=a);const f=this.pickLayerForHeight(n),w=s.indexOf(f.name);m[c][l]=w;const S=l*t,b=c*t;for(let a=0;a<t;a++)for(let s=0;s<t;s++){const t={x:S+s,y:b+a};if(t.x>=i||t.y>=r)continue;const l=this.samplePixelData(t,e,f),m=o.indexOf(l.material.name),c=(m>=0?m:0)<<2|l.materialColorIndex,y=t.y*i+t.x;h[y]=c,d[y]=Math.round(255*n)}}return{worldPixelData:h,worldHeightData:d,cellLayerGrid:m}}samplePixelData(e,t,a){const s=this.utility.getNoise(this.worldConfig.worldgenParams.material.noiseType,e.x*this.worldConfig.worldgenParams.material.scale,e.y*this.worldConfig.worldgenParams.material.scale,t+1e3,{octaves:this.worldConfig.worldgenParams.terrain.octaves,persistence:this.worldConfig.worldgenParams.terrain.persistence}),i=a.materials;let r=s*i.reduce((e,t)=>e+t.weight,0),o=this.worldConfig.materials.stone;for(const e of i)if(r-=e.weight,r<=0){const t=this.worldConfig.materials[e.material];t&&(o=t);break}const n=this.utility.getNoise(this.worldConfig.worldgenParams.material.detail.noiseType,e.x*this.worldConfig.worldgenParams.material.detail.scale,e.y*this.worldConfig.worldgenParams.material.detail.scale,t+3e3,{octaves:this.worldConfig.worldgenParams.terrain.octaves,persistence:this.worldConfig.worldgenParams.terrain.persistence});return{material:o,materialColorIndex:Math.floor(n*o.colors.length),layer:a}}pickLayerForHeight(e){const t=Object.values(this.worldConfig.worldLayers);let a=t[0],s=Math.abs(e-a.height);for(let i=1;i<t.length;i++){const r=Math.abs(e-t[i].height);r<s&&(a=t[i],s=r)}return a}async applyDegen(e,t){console.log("Applying degeneration pass...");const{worldPixelData:a,worldHeightData:s,cellLayerGrid:o}=e,n=new Uint8Array(a),l=new Uint8Array(s),h=this.worldConfig.worldgenParams.degen,d=this.getErosionTemplate(),m=["eroding terrain...","wearing down surfaces...","carving material layers...","degenerating terrain...","exposing layers..."],c=m[Math.floor(Math.random()*m.length)];await this.utility.yield(c);let y=0;for(let e=0;e<r;e++)for(let r=0;r<i;r++){const o=e*i+r;y++,y%Math.floor(768e4/this.YIELD_RATE)===0&&await this.utility.yield();const m=s[o]/255;if(m<h.minHeight){n[o]=a[o],l[o]=s[o];continue}const c=.7*this.utility.getNoise(h.noiseType,r*h.scale,e*h.scale,t+6e3,{octaves:this.worldConfig.worldgenParams.degen.scale,persistence:this.worldConfig.worldgenParams.degen.hardness})+.3*this.utility.getNoise(h.detail.noiseType,r*h.detail.scale,e*h.detail.scale,t+7e3,{octaves:this.worldConfig.worldgenParams.degen.detail.scale,persistence:this.worldConfig.worldgenParams.degen.hardness});if(c<h.threshold){n[o]=a[o],l[o]=s[o];continue}const u=(c-h.threshold)/(1-h.threshold)*h.intensity,p=a[o],g=p>>2,f=Object.values(this.worldConfig.materials)[g];let w=.5;f.physics.type===A.wr.Solid&&(w=f.physics.durability);let S=m-u*(1-w)*h.hardness;S<0&&(S=0);const b=Math.round(255*S);l[o]=b;const C=(m-S)/Math.max(.01,m),x=f.physics.type===A.wr.Solid?f.physics.durability:.5,v=Object.values(this.worldConfig.materials),M=d.filter(e=>{const t=v[e.index];return!!t&&(t.physics.type===A.wr.Solid?t.physics.durability:.5)>=x});let P,I;if(0===M.length)P=g,I=3&p;else{const a=Math.min(1,C),s=Math.floor(a*(M.length-1));P=M[Math.min(s,M.length-1)].index;const i=this.utility.getNoise(this.worldConfig.worldgenParams.material.detail.noiseType,r*this.worldConfig.worldgenParams.material.detail.scale,e*this.worldConfig.worldgenParams.material.detail.scale,t+8e3,{octaves:this.worldConfig.worldgenParams.degen.detail.scale,persistence:this.worldConfig.worldgenParams.degen.hardness}),o=Object.values(this.worldConfig.materials)[P].colors.length;I=Math.floor(i*o)%o}const k=P<<2|3&I;n[o]=k}return console.log("Degeneration pass complete."),{worldPixelData:n,worldHeightData:l,cellLayerGrid:o}}getErosionTemplate(){if(this.erosionTemplate)return this.erosionTemplate;const e=Object.keys(this.worldConfig.materials),t=["silt","sand","gravel","dirt","clay","shale","limestone","stone","slate","basalt","granite","bedrock"].map(t=>({name:t,index:e.indexOf(t)})).filter(e=>e.index>=0);return this.erosionTemplate=t,console.log("Cached erosion materials..."),t}async applyHydration(e,t){console.log("Applying hydration pass...");const{worldPixelData:a,worldHeightData:s,cellLayerGrid:i}=e,r=new Uint8Array(a.length),o=this.worldConfig.worldgenParams.terrain.seaLevel,n=o-this.worldConfig.worldgenParams.terrain.lowestDepth,l=["hydrating terrain...","filling water basins...","flooding valleys...","hydrating cells...","hydrating pixels...","creating water..."],h=l[Math.floor(Math.random()*l.length)];await this.utility.yield(h);const d=s.length;let m=0;for(let e=0;e<s.length;e++){m++,m%Math.floor(d/this.YIELD_RATE)===0&&await this.utility.yield();const t=s[e]/255;if(t<o){let a=(o-t)/n;a<0?a=0:a>1&&(a=1),r[e]=Math.round(255*a)}else r[e]=0}return console.log("Hydration pass complete."),{worldPixelData:a,worldHeightData:s,worldWaterData:r,cellLayerGrid:i}}getWaterData(e){const t=this.worldConfig.worldgenParams.general.chunk.size,a=Math.floor(e.x/t),s=Math.floor(e.y/t),i=`${a},${s}`,r=this.chunks.get(i);if(!r)return null;const o=e.x-a*t,n=e.y-s*t,l=r.getWaterAt(o,n,t);if(l<=0)return null;const h=r.getHeightAt(o,n,t);return{hasWater:!0,waterLevel:l,depth:this.worldConfig.worldgenParams.terrain.seaLevel-h,material:this.worldConfig.materials.water}}async bakeChunksFromCells(e){const t=this.worldConfig.worldgenParams.general.chunk.size,a=Object.values(this.worldConfig.worldLayers);if(this.worldBuffer=e,!e.worldHeightData||!e.worldPixelData||!e.worldWaterData)return;const s=Math.ceil(i/t),o=Math.ceil(r/t),n=s*o,l=this.worldConfig.worldgenParams.general.cell.size,h=Math.ceil(i/l),d=Math.ceil(r/l),m=["baking chunks...","baking pixels into chunks...","assembling chunks...","chunkifying... is that a word?","packing pixels into chunks...","arranging cells into chunks..."],c=["getting close...","thanks for waiting...","almost done...","still chunking...","about 50% of chunks baked...","still baking pixels into chunks...","almost all pixels baked..."],y=m[Math.floor(Math.random()*m.length)],u=c[Math.floor(Math.random()*c.length)];await this.utility.yield(y);const p=this.playerState.myPlayer.transform.pos.x,g=this.playerState.myPlayer.transform.pos.y,f=[];for(let e=0;e<s;e++)for(let a=0;a<o;a++){const s=(e+.5)*t-p,i=(a+.5)*t-g;f.push({cx:e,cy:a,dist:Math.sqrt(s*s+i*i)})}f.sort((e,t)=>e.dist-t.dist);const w=Math.floor(.25*n),S=Math.floor(.5*n);for(let s=0;s<f.length;s++){const{cx:o,cy:m}=f[s];if(s===w&&await this.utility.yield(u),s===S)return this.chunkBuffer=f.slice(s).map(e=>({cx:e.cx,cy:e.cy,loaded:!1})),this.isGenerated=!0,this.hideLoadingMenu(),console.log(`Returned early after ${s}/${n} chunks baked. Buffered ${this.chunkBuffer.length} chunks for streaming.`),void this.backgroundStreamAllChunks();await this.utility.yield();const c=new Uint8Array(t*t),y=new Uint8Array(t*t),p=new Uint8Array(t*t);for(let a=0;a<t;a++)for(let s=0;s<t;s++){const n=o*t+s,l=m*t+a;if(n>=i||l>=r)continue;const h=l*i+n,d=a*t+s;c[d]=e.worldPixelData[h],y[d]=e.worldHeightData[h],p[d]=e.worldWaterData[h]}const g={},b=Math.floor(o*t/l),C=Math.floor(((o+1)*t-1)/l),x=Math.floor(m*t/l),v=Math.floor(((m+1)*t-1)/l);for(let t=x;t<=v;t++)if(!(t<0||t>=d))for(let a=b;a<=C;a++){if(a<0||a>=h)continue;if(!e.cellLayerGrid)continue;const s=e.cellLayerGrid[t][a];g[s]=(g[s]||0)+1}let M=0,P=-1;for(const e in g){const t=g[e];t>P&&(P=t,M=parseInt(e,10))}const I=a[M]||a[0],k=new X(I.name,c,y,p,this.worldConfig),E=`${o},${m}`;this.chunks.set(E,k),this.chunkLayers.set(E,I),this.renderChunk(o,m,k)}}drawWorld(){this.ui.ctx&&this.ui.worldCanvas&&this.isGenerated&&this.ui.ctx.drawImage(this.ui.worldCanvas,this.camera.pos.x,this.camera.pos.y,n,l,0,0,n,l)}renderChunk(e,t,a){if(!this.ui.worldCtx)return;const s=this.worldConfig.worldgenParams.general.chunk.size,o=e*s,n=t*s;for(let e=0;e<s;e++)for(let t=0;t<s;t++){const l=o+t,h=n+e;if(l>=i||h>=r)continue;const d=a.getColorAt(t,e,s),m=this.utility.getNoise(this.worldConfig.worldgenParams.material.detail.noiseType,l*this.worldConfig.worldgenParams.material.detail.scale,h*this.worldConfig.worldgenParams.material.detail.scale,this.currentSeed+3e3,{octaves:this.worldConfig.worldgenParams.terrain.octaves,persistence:this.worldConfig.worldgenParams.terrain.persistence}),c=this.adjustPixelColor(d,m);this.ui.worldCtx.fillStyle=c,this.ui.worldCtx.fillRect(l,h,1,1)}this.renderWater(e,t,a)}renderWater(e,t,a){if(!this.ui.worldCtx)return;const s=this.ui.worldCtx,o=this.worldConfig.worldgenParams.general.chunk.size,n=e*o,l=t*o,h=this.worldConfig.worldgenParams.terrain.seaLevel,d=this.worldConfig.worldgenParams.render.water,m=this.worldConfig.materials.water.colors,c=this.currentSeed+9100,y=d.noiseScale,u=d.foamScale,p=d.shoreBlend;for(let e=0;e<o;e++)for(let t=0;t<o;t++){const g=n+t,f=l+e;if(g>=i||f>=r)continue;const w=a.getHeightAt(t,e,o);if(a.getWaterAt(t,e,o)<=0)continue;const S=h-w,b=Math.max(0,Math.min(1,S/h)),C=m[Math.floor((1-b)*(m.length-1))],x=parseInt(C.slice(1,3),16),v=parseInt(C.slice(3,5),16),M=parseInt(C.slice(5,7),16),P=this.utility.getNoise(A.VA.Perlin,g*y,f*y,c,{octaves:4,persistence:.55}),I=this.utility.getNoise(A.VA.Ridged,g*u,f*u,c+3e3,{octaves:2,persistence:.5});let k=0;if(w>h-p){const e=(h-w)/p;k=this.utility.smoothstep(1-Math.max(0,Math.min(1,e)))*I*d.foamIntensity}const E=1-b*d.depthDarkness,R=(.5+.5*(1-b)+P*d.shimmerStrength)*E,B=.25+.25*P,T=Math.max(0,Math.min(255,x*R+200*k+30*B)),L=Math.max(0,Math.min(255,v*R+220*k+50*B)),D=Math.max(0,Math.min(255,M*R+255*k+60*B)),_=Math.min(1,d.opacityBase+b*d.opacityMultiplier);s.fillStyle=`rgba(${T},${L},${D},${_})`,s.fillRect(g,f,1,1)}}adjustPixelColor(e,t){const a=1+(t-.5)*this.worldConfig.worldgenParams.material.colorVariation,s=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16),o=Math.max(0,Math.min(255,Math.floor(s*a))),n=Math.max(0,Math.min(255,Math.floor(i*a))),l=Math.max(0,Math.min(255,Math.floor(r*a)));return`#${o.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`}getMaterialAt(e,t){const a=this.worldConfig.worldgenParams.general.chunk.size,s=Math.floor(e/a),i=Math.floor(t/a),r=`${s},${i}`,o=this.chunks.get(r);if(!o)return null;const n=(t-i*a)*a+(e-s*a),l=o.pixelData[n]>>2;return Object.values(this.worldConfig.materials)[l]||null}getHeightAt(e,t){const a=this.worldConfig.worldgenParams.general.chunk.size,s=Math.floor(e/a),i=Math.floor(t/a),r=`${s},${i}`,o=this.chunks.get(r);if(!o)return null;const n=e-s*a,l=t-i*a;return o.getHeightAt(n,l,a)}getPhysicsAt(e,t){const a=this.getMaterialAt(e,t);return a?a.physics:null}getChunkLayer(e,t){const a=`${e},${t}`;return this.chunkLayers.get(a)||null}updateHoveredChunk(){const e=this.controlsManager.getMousePos(),t=e.x+this.camera.pos.x,a=e.y+this.camera.pos.y;if(t<0||t>=i||a<0||a>=r)return this.worldDebug.hoveredChunk=null,null;const s=this.worldConfig.worldgenParams.general.chunk.size,o=Math.floor(t/s),n=Math.floor(a/s);return this.worldDebug.hoveredChunk=`${o},${n}`,{worldX:t,worldY:a}}async worldgenMenu(){return new Promise(e=>{const t=document.createElement("div");t.className="config_popup_container";const a=document.createElement("h3");a.textContent="World Generation Config";const s=document.createElement("div");s.className="config_popup";const i=document.createElement("form"),r=Object.values(A.VA).map(e=>`<option value="${e}" ${this.worldConfig.worldgenParams.terrain.noiseType===e?"selected":""}>${e.charAt(0).toUpperCase()+e.slice(1)}</option>`).join("");i.innerHTML=`\n            \x3c!-- GENERAL --\x3e\n            <fieldset id="generalFieldset">\n                <legend>General</legend>\n                <div class="form_grid">\n                    <label id="seedLabel">\n                        <span>Seed:</span>\n                        <input type="text" name="general.seed" placeholder="enter seed or leave blank...">\n                    </label>\n                    <div id="generalFormDiv">\n                        <label>\n                            <span>Chunk Size (px):</span>\n                            <input type="number" name="general.chunk.size" value="${this.worldConfig.worldgenParams.general.chunk.size}" min="1" step="1">\n                        </label>\n                        <label>\n                            <span>Cell Size (px):</span>\n                            <input type="number" name="general.cell.size" value="${this.worldConfig.worldgenParams.general.cell.size}" min="1" step="1">\n                        </label>\n                    </div>\n                </div>\n            </fieldset>\n\n            \x3c!-- TERRAIN --\x3e\n            <fieldset id="terrainFieldset">\n                <legend>Terrain</legend>\n                <div class="form_grid">\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="terrain.noiseType">${r}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="terrain.scale" value="${this.worldConfig.worldgenParams.terrain.scale}" step="any">\n                    </label>\n                    <label>\n                        <span>Intensity:</span>\n                        <input type="number" name="terrain.intensity" value="${this.worldConfig.worldgenParams.terrain.intensity}" step="any" min="0">\n                    </label>\n                    <label>\n                        <span>Octaves:</span>\n                        <input type="number" name="terrain.octaves" value="${this.worldConfig.worldgenParams.terrain.octaves}" min="1" max="12" step="1">\n                    </label>\n                    <label>\n                        <span>Persistence:</span>\n                        <input type="number" name="terrain.persistence" value="${this.worldConfig.worldgenParams.terrain.persistence}" step="any" min="0" max="1">\n                    </label>\n                    <label>\n                        <span>Height Curve:</span>\n                        <input type="number" name="terrain.heightCurve" value="${this.worldConfig.worldgenParams.terrain.heightCurve}" step="any" min="0.1">\n                    </label>\n                    <label>\n                        <span>Sea Level:</span>\n                        <input type="number" name="terrain.seaLevel" value="${this.worldConfig.worldgenParams.terrain.seaLevel}" step="any" min="0" max="1">\n                    </label>\n                    <label>\n                        <span>Lowest Depth:</span>\n                        <input type="number" name="terrain.lowestDepth" value="${this.worldConfig.worldgenParams.terrain.lowestDepth}" step="any" min="0" max="1">\n                    </label>\n                </div>\n            </fieldset>\n\n            \x3c!-- MATERIALS --\x3e\n            <fieldset id="materialsFieldset">\n                <legend>Materials</legend>\n                <div class="form_grid">\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="material.noiseType">${r}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="material.scale" value="${this.worldConfig.worldgenParams.material.scale}" step="any">\n                    </label>\n                    <label>\n                        <span>Color Variation:</span>\n                        <input type="number" name="material.colorVariation" value="${this.worldConfig.worldgenParams.material.colorVariation}" step="any" min="0" max="1">\n                    </label>\n                </div>\n                <div class="form_grid form_grid_detail">\n                <h4>Detail</h4>\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="material.detail.noiseType">${r}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="material.detail.scale" value="${this.worldConfig.worldgenParams.material.detail.scale}" step="any">\n                    </label>\n                </div>\n            </fieldset>\n\n            \x3c!-- DEGENERATION --\x3e\n            <fieldset id="degenerationFieldset">\n                <legend>Degeneration</legend>\n                <div class="form_grid">\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="degen.noiseType">${r}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="degen.scale" value="${this.worldConfig.worldgenParams.degen.scale}" step="any" min="0">\n                    </label>\n                    <label>\n                        <span>Intensity:</span>\n                        <input type="number" name="degen.intensity" value="${this.worldConfig.worldgenParams.degen.intensity}" step="any" min="0" max="2">\n                    </label>\n                    <label>\n                        <span>Min Height:</span>\n                        <input type="number" name="degen.minHeight" value="${this.worldConfig.worldgenParams.degen.minHeight}" step="any" min="0" max="1">\n                    </label>\n                    <label>\n                        <span>Threshold:</span>\n                        <input type="number" name="degen.threshold" value="${this.worldConfig.worldgenParams.degen.threshold}" step="any" min="0" max="1">\n                    </label>\n                    <label>\n                        <span>Hardness:</span>\n                        <input type="number" name="degen.hardness" value="${this.worldConfig.worldgenParams.degen.hardness}" step="any" min="0" max="1">\n                    </label>\n                </div>\n                <div class="form_grid form_grid_detail">\n                <h4>Detail</h4>\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="degen.detail.noiseType">${r}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="degen.detail.scale" value="${this.worldConfig.worldgenParams.degen.detail.scale}" step="any" min="0">\n                    </label>\n                </div>\n            </fieldset>\n\n            \x3c!-- HYDRATION\n            <fieldset id="hydrationFieldset">\n                <legend>Hydration</legend>\n                <div class="form_grid">\n                    <label>\n                        <span>Noise Type:</span>\n                        <select name="hydration.noiseType">${r}</select>\n                    </label>\n                    <label>\n                        <span>Scale:</span>\n                        <input type="number" name="hydration.scale" value="${this.worldConfig.worldgenParams.hydration.scale}" step="any" min="0">\n                    </label>\n                    <label>\n                        <span>Intensity:</span>\n                        <input type="number" name="hydration.intensity" value="${this.worldConfig.worldgenParams.hydration.intensity}" step="any" min="0" max="5">\n                    </label>\n                    <label>\n                        <span>Multiplier:</span>\n                        <input type="number" name="hydration.multiplier" value="${this.worldConfig.worldgenParams.hydration.multiplier}" step="any" min="0" max="10">\n                    </label>\n                </div>\n            </fieldset> --\x3e\n\n            <div class="form_submit">\n                <button type="submit">Generate (Enter)</button>\n            </div>\n        `,i.onsubmit=a=>{a.preventDefault();const s=new FormData(i),r=e=>parseFloat(s.get(e)),o=e=>parseInt(s.get(e));this.worldConfig.worldgenParams.general.chunk.size=o("general.chunk.size"),this.worldConfig.worldgenParams.general.cell.size=o("general.cell.size"),this.worldConfig.worldgenParams.general.seed=o("general.seed"),this.worldConfig.worldgenParams.terrain.noiseType=s.get("terrain.noiseType"),this.worldConfig.worldgenParams.terrain.scale=r("terrain.scale"),this.worldConfig.worldgenParams.terrain.intensity=r("terrain.intensity"),this.worldConfig.worldgenParams.terrain.octaves=o("terrain.octaves"),this.worldConfig.worldgenParams.terrain.persistence=r("terrain.persistence"),this.worldConfig.worldgenParams.terrain.heightCurve=r("terrain.heightCurve"),this.worldConfig.worldgenParams.terrain.seaLevel=r("terrain.seaLevel"),this.worldConfig.worldgenParams.terrain.lowestDepth=r("terrain.lowestDepth"),this.worldConfig.worldgenParams.material.noiseType=s.get("material.noiseType"),this.worldConfig.worldgenParams.material.scale=r("material.scale"),this.worldConfig.worldgenParams.material.colorVariation=r("material.colorVariation"),this.worldConfig.worldgenParams.material.detail.noiseType=s.get("material.detail.noiseType"),this.worldConfig.worldgenParams.material.detail.scale=r("material.detail.scale"),this.worldConfig.worldgenParams.degen.noiseType=s.get("degen.noiseType"),this.worldConfig.worldgenParams.degen.scale=r("degen.scale"),this.worldConfig.worldgenParams.degen.intensity=r("degen.intensity"),this.worldConfig.worldgenParams.degen.minHeight=r("degen.minHeight"),this.worldConfig.worldgenParams.degen.threshold=r("degen.threshold"),this.worldConfig.worldgenParams.degen.hardness=r("degen.hardness"),this.worldConfig.worldgenParams.degen.detail.noiseType=s.get("degen.detail.noiseType"),this.worldConfig.worldgenParams.degen.detail.scale=r("degen.detail.scale"),document.body.removeChild(t),e()},s.appendChild(i),t.appendChild(a),t.appendChild(s),document.body.appendChild(t),i.querySelector("input")?.focus()})}async renderMenu(){return new Promise(e=>{const t=document.createElement("div");t.className="config_popup";const a=document.createElement("form"),s=this.worldConfig.worldgenParams.render.water;a.innerHTML=`\n        <h3>Render Config</h3>\n\n        <fieldset>\n            <legend>Water Rendering</legend>\n            <div class="form_grid">\n                <label><span>Base Opacity:</span>\n                    <input type="number" name="opacityBase" value="${s.opacityBase}" step="any" min="0" max="1">\n                </label>\n                <label><span>Opacity Multiplier:</span>\n                    <input type="number" name="opacityMultiplier" value="${s.opacityMultiplier}" step="any" min="0" max="2">\n                </label>\n                <label><span>Foam Intensity:</span>\n                    <input type="number" name="foamIntensity" value="${s.foamIntensity}" step="any" min="0" max="2">\n                </label>\n                <label><span>Foam Scale:</span>\n                    <input type="number" name="foamScale" value="${s.foamScale}" step="any" min="0">\n                </label>\n                <label><span>Noise Scale:</span>\n                    <input type="number" name="noiseScale" value="${s.noiseScale}" step="any" min="0">\n                </label>\n                <label><span>Shore Blend:</span>\n                    <input type="number" name="shoreBlend" value="${s.shoreBlend}" step="any" min="0" max="1">\n                </label>\n                <label><span>Shimmer Strength:</span>\n                    <input type="number" name="shimmerStrength" value="${s.shimmerStrength}" step="any" min="0" max="1">\n                </label>\n                <label><span>Depth Darkness:</span>\n                    <input type="number" name="depthDarkness" value="${s.depthDarkness}" step="any" min="0" max="2">\n                </label>\n            </div>\n        </fieldset>\n\n        <div class="form_submit">\n            <button type="submit">Apply (Enter)</button>\n        </div>\n        `,a.onsubmit=o=>{o.preventDefault();const n=new FormData(a),l=e=>parseFloat(n.get(e));s.opacityBase=l("opacityBase"),s.opacityMultiplier=l("opacityMultiplier"),s.foamIntensity=l("foamIntensity"),s.foamScale=l("foamScale"),s.noiseScale=l("noiseScale"),s.shoreBlend=l("shoreBlend"),s.shimmerStrength=l("shimmerStrength"),s.depthDarkness=l("depthDarkness"),console.log(" Re-rendering world (no regeneration)..."),this.ui.worldCtx&&this.ui.worldCtx.clearRect(0,0,i,r);for(const[e,t]of this.chunks.entries()){const[a,s]=e.split(",").map(Number);this.renderChunk(a,s,t)}document.body.removeChild(t),e()},t.appendChild(a),document.body.appendChild(t),a.querySelector("input")?.focus()})}showLoadingMenu(){const e=document.getElementById("worldLoadingMenu");e&&e.remove();const t=document.createElement("div");t.id="worldLoadingMenu",t.innerHTML='\n        <div class="loading_wrapper">\n            <span id="loadingMessage">Initializing world...</span>\n            <div class="loading_bar">\n                <div id="loadingBarFill"></div>\n            </div>\n        </div>\n    ',document.body.appendChild(t)}hideLoadingMenu(){const e=document.getElementById("worldLoadingMenu");e&&(e.style.opacity="0",setTimeout(()=>e.remove(),300))}initLoadingProgressEvents(){document.addEventListener("yieldMessage",e=>{const t=e,a=document.getElementById("loadingMessage");a&&(a.textContent=t.detail.message)}),document.addEventListener("yieldProgress",()=>{const e=document.getElementById("loadingBarFill");if(!e)return;const t=parseFloat(e.style.width||"0"),a=Math.min(100,t+100/this.totalYieldSteps());e.style.width=`${a}%`})}totalYieldSteps(){const e=this.YIELD_RATE,t=Math.ceil(i/this.worldConfig.worldgenParams.general.chunk.size)*Math.ceil(r/this.worldConfig.worldgenParams.general.chunk.size),a=Math.floor(.5*t);return e*this.WORLDGEN_PHASES.length+a}async backgroundStreamAllChunks(){console.log("Starting background chunk streaming...");for(let e=0;e<this.chunkBuffer.length;e++){const t=this.chunkBuffer[e];t.loaded||(this.loadChunk(t.cx,t.cy),t.loaded=!0,await this.utility.yield())}console.log(" Background streaming complete. All chunks loaded."),this.chunkBuffer=[],this.worldBuffer=null,this.streamingComplete=!0}async streamUnloadedChunks(){if(!this.isGenerated||!this.playerState?.myPlayer||this.streamingComplete)return;if(!this.chunkBuffer.length||this.chunkBuffer.every(e=>e.loaded))return console.log("All chunks streamed. Cleaning up temporary world data..."),this.chunkBuffer=[],this.worldBuffer=null,void(this.streamingComplete=!0);const e=this.playerState.myPlayer.transform.pos,t=this.worldConfig.worldgenParams.general.chunk.size,a=this.CHUNK_LOAD_RADIUS;for(let s=0;s<this.chunkBuffer.length;s++){const i=this.chunkBuffer[s];if(i.loaded)continue;const r=(i.cx+.5)*t,o=(i.cy+.5)*t,n=r-e.x,l=o-e.y;if(Math.sqrt(n*n+l*l)<a){i.loaded=!0,this.loadChunk(i.cx,i.cy),await this.utility.yield();break}}}loadChunk(e,t){if(!this.worldBuffer||!this.worldBuffer.cellLayerGrid||!this.worldBuffer.worldWaterData)return;const a=Object.values(this.worldConfig.worldLayers),s=this.worldConfig.worldgenParams.general.chunk.size,o=this.worldConfig.worldgenParams.general.cell.size,n=new Uint8Array(s*s),l=new Uint8Array(s*s),h=new Uint8Array(s*s);for(let a=0;a<s;a++)for(let o=0;o<s;o++){const d=e*s+o,m=t*s+a;if(d>=i||m>=r)continue;const c=m*i+d,y=a*s+o;n[y]=this.worldBuffer.worldPixelData[c],l[y]=this.worldBuffer.worldHeightData[c],h[y]=this.worldBuffer.worldWaterData[c]}const d={},m=Math.ceil(i/o),c=Math.ceil(r/o),y=Math.floor(e*s/o),u=Math.floor(((e+1)*s-1)/o),p=Math.floor(t*s/o),g=Math.floor(((t+1)*s-1)/o);for(let e=p;e<=g;e++)if(!(e<0||e>=c))for(let t=y;t<=u;t++){if(t<0||t>=m)continue;const a=this.worldBuffer.cellLayerGrid[e][t];d[a]=(d[a]||0)+1}let f=0,w=-1;for(const e in d){const t=d[e];t>w&&(w=t,f=parseInt(e,10))}const S=a[f]||a[0],b=new X(S.name,n,l,h,this.worldConfig),C=`${e},${t}`;this.chunks.set(C,b),this.chunkLayers.set(C,S),this.renderChunk(e,t,b)}}class ae{constructor(){this.isRoundInProgress=!1,this.roundWinner=null,this.gameWinner=null,this.cacheManager=new g,this.utility=new O,this.gameState=new P,this.audioConfig=new Y,this.settingsManager=new L(this.audioConfig,this.cacheManager),this.controlsManager=new b(this.settingsManager),this.charConfig=new f,this.charManager=new w(this.charConfig),this.playerConfig=new K,this.userId=this.utility.generateUID(this.playerConfig.default.data.idLength),this.playerState=new W(this.playerConfig,this.userId,this.utility),this.camera=new J(this.playerState,this.utility),this.ui=new N(this.playerState,this.settingsManager,this.utility),this.admin=new c(this.cacheManager,this.ui),this.objectsManager=new V(this.playerState,this.utility),this.roomManager=new T(this.userId,this.utility),this.lobbyManager=new I(this.charManager,this.playerConfig,this.playerState,this.roomManager,this.ui,this.utility),this.wsManager=new j(this.gameState,this.roomManager,this.utility),this.chatManager=new S(this.roomManager,this.ui),this.world=new te(this.camera,this.controlsManager,this.playerState,this.roomManager,this.ui,this.utility),this.upgradeManager=new _(this.playerConfig,this.playerState,this.ui,this.utility),this.roomController=new B(this.gameState,this.lobbyManager,this.playerState,this.roomManager,this.ui,this.upgradeManager,this.userId,this.utility,this.wsManager),this.collisionsManager=new C(this.objectsManager,this.playerState,this.roomManager,this.ui,this.userId),this.moveController=new H(this.controlsManager,this.settingsManager),this.staminaController=new G(this.playerState),this.luckController=new U(this.playerState),this.audioManager=new p(this.audioConfig,this.roomManager,this.settingsManager,this.utility),this.animator=new y(this.playerState,this.roomManager,this.userId),this.renderingManager=new R(this.animator,this.camera,this.charManager,this.lobbyManager,this.objectsManager,this.playerConfig,this.ui,this.userId),this.decalsManager=new v(this.camera,this.charConfig,this.playerState,this.roomManager,this.ui,this.userId,this.utility),this.particlesManager=new E(this.camera,this.charConfig,this.collisionsManager,this.decalsManager,this.playerState,this.renderingManager,this.roomManager,this.ui,this.userId,this.utility),this.playerController=new F(this.audioConfig,this.audioManager,this.decalsManager,this.gameState,this.luckController,this.moveController,this.objectsManager,this.particlesManager,this.playerState,this.roomManager,this.ui,this.userId,this.utility),this.combatController=new $(this.animator,this.audioConfig,this.audioManager,this.collisionsManager,this.decalsManager,this.gameState,this.luckController,this.particlesManager,this.playerController,this.playerState,this.roomManager,this.ui,this.userId,this.utility,this.world),this.dashController=new q(this.collisionsManager,this.combatController,this.moveController,this.playerState,this.roomManager,this.staminaController,this.userId),this.eventsManager=new M(this.animator,this.camera,this.chatManager,this.controlsManager,this.gameState,this.roomController,this.playerState,this.settingsManager,this.ui,this.userId),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initClient()}):this.initClient(),document.addEventListener("keydown",e=>{if("Escape"===e.key&&this.gameState.gameInProgress&&!this.lobbyManager.inLobby){e.preventDefault();const t=20;this.playerState.myPlayer.actions.primary.magazine.currentReserve+=t,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(t)}})}async initClient(){this.ui.initInterface(),this.eventsManager.initEventListeners(),this.initGlobalEvents(),this.roomController.checkForRoomInURL(),this.roomController.showRoomControls();const e={spanId:"userId",value:this.userId};this.utility.setSpan(e),await this.settingsManager.loadSettings();const t=this.settingsManager.getSettings();this.ui.initSoundSliders(t),this.ui.initSettingsInputs(t),this.ui.initSettingsToggles(t),this.ui.ammoReservesUIController.initAmmoReserveCanvas(),this.eventsManager.initKeybindListeners(),this.audioConfig.settings.preloadSounds&&this.audioManager.preloadAudioAssets(this.audioConfig.resources.sfx,".ogg"),this.watchForInputs(),this.admin.onAdminCommand=(e,t)=>{this.roomManager.sendAdminCommand(e,t)}}initGlobalEvents(){window.addEventListener("customEvent_startGame",()=>this.startGame()),window.addEventListener("customEvent_resetGameState",e=>{const t=e;this.resetGameState(t.detail.resetType)}),this.roomManager.onMessage(e=>this.handleRoomMessage(e))}handleRoomMessage(e){switch(e.type){case"room-created":console.log("Room created");break;case"room-joined":console.log("Joined room - lobby"),this.playerState.isHost=!1,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId}),this.roomManager.sendMessage(JSON.stringify({type:"lobby-join",color:this.playerState.myPlayer.color,rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon}}));const t=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,a=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyManager.lobbyPlayers.set(this.userId,{id:this.userId,color:this.playerState.myPlayer.color,isHost:this.playerState.isHost,rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon},transform:{pos:{x:t,y:a},rot:0}}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),0===this.lobbyManager.lobbyPlayers.size&&(this.playerState.isHost=!0,this.lobbyManager.lobbyPlayers.get(this.userId).isHost=!0,this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),console.log("I am the only player in the room..."));break;case"user-left":console.log(`User ${e.userId} left`),this.lobbyManager.lobbyPlayers.delete(e.userId),this.playerState.players.delete(e.userId),this.ui.leaderboard.delete(e.userId),this.ui.updateLeaderboardDisplay(this.userId),console.log(`Removed ${e.userId} from leaderboard`),this.combatController.projectiles.forEach((t,a)=>{t.ownerId===e.userId&&this.combatController.projectiles.delete(a)}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId);break;case"room-message":this.handleGameMessage(e);break;case"room-error":alert(`Error: ${e.message}`)}}async handleGameMessage(e){if(e.message)try{const t=JSON.parse(e.message);switch(t.type){case"lobby-join":const a=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,s=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyManager.lobbyPlayers.set(e.userId,{id:e.userId,color:t.color,isHost:!1,rig:t.rig,transform:{pos:{x:a,y:s},rot:0}}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.playerState.isHost&&this.roomManager.sendMessage(JSON.stringify({type:"lobby-state",players:Array.from(this.lobbyManager.lobbyPlayers.values()),options:{privateRoom:this.roomManager.isPrivateRoom,maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,upgradesEnabled:this.upgradeManager.isUpgradesEnabled}}));break;case"lobby-state":this.lobbyManager.lobbyPlayers.clear(),t.players.forEach(e=>{this.lobbyManager.lobbyPlayers.set(e.id,e)}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),t.options&&this.lobbyManager.syncLobbyOptions(t.options);break;case"lobby-options":this.lobbyManager.syncLobbyOptions(t);break;case"promote-player":this.lobbyManager.lobbyPlayers.forEach((e,a)=>{e.isHost=a===t.targetPlayerId}),this.playerState.isHost=t.targetPlayerId===this.userId,this.playerState.isHost&&"host-migration"===t.reason&&console.log("I am now the host due to host migration"),this.lobbyManager.setupLobbyOptions({maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager);break;case"return-to-lobby":console.log("Returning to lobby - last player or game ended"),t.newHostId===this.userId&&(this.playerState.isHost=!0,console.log("I am now the host as the last remaining player")),this.resetGameState("Lobby"),this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId});break;case"kick-player":t.targetPlayerId===this.userId&&(alert("You have been kicked from the lobby"),this.roomController.leaveRoom());break;case"chat-message":e.userId!==this.userId&&this.chatManager.displayChatMessage({senderId:e.userId,message:t.message,isOwn:!1});break;case"player-state":console.log("Player State for player",t.id,":",t),this.playerState.players.set(e.userId,{id:e.userId,transform:{pos:{x:t.transform?.pos.x,y:t.transform?.pos.y},rot:t.transform?.rot},timestamp:t.timestamp,color:t.color,actions:{dash:{cooldown:t.actions?.dash.cooldown||this.playerConfig.default.actions.dash.cooldown,drain:t.actions?.dash.drain||this.playerConfig.default.actions.dash.drain,multiplier:t.actions?.dash.multiplier||this.playerConfig.default.actions.dash.multiplier,time:t.actions?.dash.time||this.playerConfig.default.actions.dash.time},melee:{cooldown:t.actions?.melee.cooldown||this.playerConfig.default.actions.melee.cooldown,damage:t.actions?.melee.damage||this.playerConfig.default.actions.melee.damage,duration:t.actions?.melee.duration||this.playerConfig.default.actions.melee.duration,range:t.actions?.melee.range||this.playerConfig.default.actions.melee.range,size:t.actions?.melee.size||this.playerConfig.default.actions.melee.size},primary:{buffer:t.actions?.primary.buffer||this.playerConfig.default.actions.primary.buffer,burst:{amount:t.actions?.primary.burst.amount||this.playerConfig.default.actions.primary.burst.amount,delay:t.actions?.primary.burst.delay||this.playerConfig.default.actions.primary.burst.delay},magazine:{currentAmmo:t.actions?.primary.magazine.currentAmmo,currentReserve:t.actions?.primary.magazine.currentReserve,maxReserve:t.actions?.primary.magazine.maxReserve,size:t.actions?.primary.magazine.size||this.playerConfig.default.actions.primary.magazine.size},offset:t.actions?.primary.offset||this.playerConfig.default.actions.primary.offset,projectile:{amount:t.actions?.primary.projectile.amount||this.playerConfig.default.actions.primary.projectile.amount,color:t.actions?.primary.projectile.color||this.playerConfig.default.actions.primary.projectile.color,damage:t.actions?.primary.projectile.damage||this.playerConfig.default.actions.primary.projectile.damage,length:t.actions?.primary.projectile.length||this.playerConfig.default.actions.primary.projectile.length,range:t.actions?.primary.projectile.range||this.playerConfig.default.actions.primary.projectile.range,size:t.actions?.primary.projectile.size||this.playerConfig.default.actions.primary.projectile.size,speed:t.actions?.primary.projectile.speed||this.playerConfig.default.actions.primary.projectile.speed,spread:t.actions?.primary.projectile.spread||this.playerConfig.default.actions.primary.projectile.spread},reload:{time:t.actions?.primary.reload.time||this.playerConfig.default.actions.primary.reload.time}},sprint:{drain:t.actions?.sprint.drain||this.playerConfig.default.actions.sprint.drain,multiplier:t.actions?.sprint.multiplier||this.playerConfig.default.actions.sprint.multiplier}},equipment:t.equipment||this.playerConfig.default.equipment,flags:{hidden:t.flags?.hidden||this.playerConfig.default.flags.hidden,invulnerable:t.flags?.invulnerable||this.playerConfig.default.flags.invulnerable},inventory:{primary:t.inventory?.primary||this.playerConfig.default.inventory.primary,melee:t.inventory?.melee||this.playerConfig.default.inventory.melee},physics:{acceleration:t.physics?.acceleration||this.playerConfig.default.physics.acceleration,friction:t.physics?.friction||this.playerConfig.default.physics.friction},rig:{body:t.rig?.body||this.playerConfig.default.rig.body,head:t.rig?.head||this.playerConfig.default.rig.head,headwear:t.rig?.headwear||this.playerConfig.default.rig.headwear,weapon:t.rig?.weapon||this.playerConfig.default.rig.weapon},stats:{defense:t.stats?.defense||this.playerConfig.default.stats.defense,health:{max:t.stats?.health.max||this.playerConfig.default.stats.health.max,value:t.stats?.health.value||this.playerConfig.default.stats.health.max},luck:t.stats?.luck||this.playerConfig.default.stats.luck,size:t.stats?.size||this.playerConfig.default.stats.size,speed:t.stats?.speed||this.playerConfig.default.stats.speed,stamina:{max:t.stats?.stamina.max||this.playerConfig.default.stats.stamina.max,recovery:{delay:t.stats?.stamina.recovery.delay||this.playerConfig.default.stats.stamina.recovery.delay,rate:t.stats?.stamina.recovery.rate||this.playerConfig.default.stats.stamina.recovery.rate},value:t.stats?.stamina.value||this.playerConfig.default.stats.stamina.max}},unique:t.unique||this.playerConfig.default.unique}),t.leaderboard&&t.leaderboard.forEach(([e,t])=>{this.ui.leaderboard.set(e,t)}),this.ui.createLeaderboard(this.lobbyManager,this.playerState.players,this.userId);break;case"partial-state":{if(e.userId===this.userId)return;const a=this.playerState.players.get(e.userId);if(!a)break;console.log("Partial State update for player",e.userId,":",t),this.utility.deepMerge(a,t);break}case"player-move":if(!this.lobbyManager.inLobby&&this.playerState.players.has(e.userId)){const a=this.playerState.players.get(e.userId);if(!a)break;t.transform.pos&&(a.transform.pos.x=t.transform.pos.x,a.transform.pos.y=t.transform.pos.y),void 0!==t.transform.rot&&(a.transform.rot=t.transform.rot)}break;case"player-hit":if(t.projectileId&&this.combatController.projectiles.delete(t.projectileId),t.targetId===this.userId){this.playerState.myPlayer.stats.health.value=t.newHealth;const e=300,a={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:e};this.utility.setSlider(a),this.playerState.myPlayer.stats.health.value<=0&&this.playerController.playerDeath()}else if(this.playerState.players.has(t.targetId)){const e=this.playerState.players.get(t.targetId);if(!e)break;e.stats.health.value=t.newHealth,e.stats.health.value<=0&&console.log(`Player ${e.id} died`)}if(t.wasKill){const e=this.ui.leaderboard.get(t.shooterId);e&&e.kills++;const a=this.ui.leaderboard.get(t.targetId);a&&a.deaths++,this.ui.updateLeaderboardDisplay(this.userId)}break;case"player-death":e.userId!==this.userId&&t.ammoBox&&(this.objectsManager.ammoBoxes.set(t.ammoBox.id,t.ammoBox),console.log(`Ammo box spawned at death of ${e.userId}`));const i={gore:{amount:this.utility.getRandomInt(2,5)},blood:{amount:this.utility.getRandomInt(1,3)},ownerId:e.userId,pos:{x:t.x,y:t.y},radius:t.size};this.particlesManager.generateGore(i),console.log(`Generated gore for ${e.userId}`);break;case"ammo-pickup":if(t.playerId===this.userId)break;if(this.objectsManager.ammoBoxes.has(t.ammoBoxId)){const e=this.objectsManager.ammoBoxes.get(t.ammoBoxId);if(!e)break;e.isOpen=t.boxState.isOpen,e.lid=t.boxState.lid,console.log(`Ammo box opened by ${t.playerId}`)}break;case"weapon-change":if(e.userId!==this.userId&&this.playerState.players.has(e.userId)){const a=this.playerState.players.get(e.userId);if(!a)break;a.rig.weapon=t.weapon,console.log(`${e.userId} switched to ${t.weapon}`)}break;case"projectile-launch":this.lobbyManager.inLobby||e.userId===this.userId||this.combatController.projectiles.set(t.projectile.id,t.projectile);break;case"projectile-remove":this.lobbyManager.inLobby||this.combatController.projectiles.delete(t.projectileId);break;case"projectile-update":if(!this.lobbyManager.inLobby&&this.combatController.projectiles.has(t.projectileId)){const e=this.combatController.projectiles.get(t.projectileId);if(!e)break;e.ownerId=t.newOwnerId,e.velocity=t.velocity,e.color=t.color,e.transform.rot=Math.atan2(e.velocity.y,e.velocity.x),console.log(`Projectile ${t.projectileId} data updated by ${t.newOwnerId}`)}break;case"start-game":t.spawnMap&&t.spawnMap[this.userId]&&(this.playerState.myPlayer.transform.pos.x=t.spawnMap[this.userId].x,this.playerState.myPlayer.transform.pos.y=t.spawnMap[this.userId].y,console.log("My Player Spawn:",t.spawnMap[this.userId].x,t.spawnMap[this.userId].y)),t.spawnMap&&this.playerState.players.forEach((e,a)=>{t.spawnMap[a]&&(e.transform.pos.x=t.spawnMap[a].x,e.transform.pos.y=t.spawnMap[a].y,console.log(`Player ${a} spawn:`,t.spawnMap[a].x,t.spawnMap[a].y))}),t.worldData&&await this.world.generateWorld(t.worldData),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop();break;case"game-end":console.log(`Game ended! Winner: ${t.winnerId}`),this.gameWinner=t.winnerId;break;case"round-end":console.log(`Round ended! Winner: ${t.winnerId||"No one"}`),this.endRound(t.winnerId);break;case"new-round":if(!t.spawnMap)return;console.log(t.spawnMap),this.ui.upgradeContainer&&(this.ui.upgradeContainer.style.display="none"),console.log("New round started! Everyone respawning..."),this.isRoundInProgress=!0,this.roundWinner=null,this.playerState.myPlayer.stats.health.value=this.playerState.myPlayer.stats.health.max;const r=300,o={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:r},n={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:r};this.utility.setSlider(o),this.utility.setSlider(n),this.playerState.myPlayer.transform.pos.x=t.spawnMap[this.userId].x,this.playerState.myPlayer.transform.pos.y=t.spawnMap[this.userId].y,this.resumeGame(),this.playerState.players.forEach((e,a)=>{t.spawnMap[a]&&(e.transform.pos.x=t.spawnMap[e.id].x,e.transform.pos.y=t.spawnMap[e.id].y,e.transform.rot=0,e.stats.health.value=e.stats.health.max,e.stats.stamina.value=e.stats.stamina.max)});break;case"upgrade-taken":t.upgradeId&&t.isUnique&&(this.upgradeManager.removeUpgradeFromPool(t.upgradeId),console.log(`Unique upgrade ${t.upgradeId} taken by ${e.userId}`)),this.roundWinner===this.userId&&(this.upgradeManager.upgradesCompleted.add(e.userId),console.log(`${e.userId} completed upgrade. ${this.upgradeManager.upgradesCompleted.size}/${this.playerState.players.size} done`),this.upgradeManager.upgradesCompleted.size>=this.playerState.players.size&&this.showWinnerContinueButton());break;case"play-audio":e.userId!==this.userId&&this.audioManager.playAudio(t.params);break;case"add-decal":e.userId!==this.userId&&this.decalsManager.createDecalNetwork(t.params);break;case"add-particles":e.userId!==this.userId&&this.particlesManager.createParticlesNetwork(t.params);break;case"particle-emitter":if(e.userId!==this.userId){const e={id:t.id,interval:t.interval,lifetime:t.lifetime,offset:{x:t.offset.x,y:t.offset.y},particleType:t.particleType,playerId:t.playerId,pos:{x:t.pos.x,y:t.pos.y}};this.particlesManager.generateEmitter(e)}break;case"character-animation":t.params.playerId!==this.userId&&this.animator.animateCharacterPartNetwork(t.params);break;case"shrapnel-spawn":e.userId!==this.userId&&this.particlesManager.generateShrapnel(t.pieces);break;case"chunk-update":t.chunk&&this.world.handleChunkUpdate(t.chunk)}}catch(e){console.error("Error parsing game message:",e)}}returnToLobby(){this.resetGameState("Lobby"),this.roomManager.sendMessage(JSON.stringify({type:"return-to-lobby",reason:"game-ended"})),this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId})}endRound(e){if(this.isRoundInProgress){if(console.log(`Server confirmed round end. Winner: ${e||"No one"}`),this.isRoundInProgress=!1,this.roundWinner=e,!e)return console.log("Round ended with no survivors!"),void(this.playerState.isHost&&this.utility.safeTimeout(()=>{this.startNewRound()},d.ROUND_END_DELAY));if(e&&this.ui.leaderboard.has(e)){const t=this.ui.leaderboard.get(e);if(!t)return;if(t.wins++,console.log(`${e} won the round! Total wins: ${t.wins}`),t.wins>=this.gameState.gameMaxWins)return void this.endGame(e);this.ui.updateLeaderboardDisplay(this.userId)}this.utility.safeTimeout(()=>{this.pauseGame()},d.ROUND_END_DELAY/6),this.utility.safeTimeout(()=>{this.startUpgradePhase(e)},d.ROUND_END_DELAY)}else console.log("Ignoring endRound - round already ended")}endGame(e){this.gameWinner=e,console.log(`${e} won the game with ${this.gameState.gameMaxWins} wins!`),this.roomManager.sendMessage(JSON.stringify({type:"game-end",winnerId:e})),this.utility.safeTimeout(()=>{this.returnToLobby()},d.GAME_END_DELAY)}startNewRound(){console.log("Starting new round..."),this.playerState.players.forEach(e=>{e.transform.rot=0,e.timestamp=e.timestamp||Date.now(),e.actions.dash.cooldown=e.actions.dash.cooldown||this.playerConfig.default.actions.dash.cooldown,e.actions.dash.drain=e.actions.dash.drain||this.playerConfig.default.actions.dash.drain,e.actions.dash.multiplier=e.actions.dash.multiplier||this.playerConfig.default.actions.dash.multiplier,e.actions.dash.time=e.actions.dash.time||this.playerConfig.default.actions.dash.time,e.actions.melee.cooldown=e.actions.melee.cooldown||this.playerConfig.default.actions.melee.cooldown,e.actions.melee.damage=e.actions.melee.damage||this.playerConfig.default.actions.melee.damage,e.actions.melee.duration=e.actions.melee.duration||this.playerConfig.default.actions.melee.duration,e.actions.melee.range=e.actions.melee.range||this.playerConfig.default.actions.melee.range,e.actions.melee.size=e.actions.melee.size||this.playerConfig.default.actions.melee.size,e.actions.primary.buffer=e.actions.primary.buffer||this.playerConfig.default.actions.primary.buffer,e.actions.primary.burst.amount=e.actions.primary.burst.amount||this.playerConfig.default.actions.primary.burst.amount,e.actions.primary.burst.delay=e.actions.primary.burst.delay||this.playerConfig.default.actions.primary.burst.delay,e.actions.primary.magazine.currentAmmo=e.actions.primary.magazine.currentAmmo||this.playerConfig.default.actions.primary.magazine.size,e.actions.primary.magazine.currentReserve=e.actions.primary.magazine.currentReserve||this.playerConfig.default.actions.primary.magazine.startingReserve,e.actions.primary.magazine.maxReserve=e.actions.primary.magazine.maxReserve||this.playerConfig.default.actions.primary.magazine.maxReserve,e.actions.primary.magazine.size=e.actions.primary.magazine.size||this.playerConfig.default.actions.primary.magazine.size,e.actions.primary.offset=e.actions.primary.offset||this.playerConfig.default.actions.primary.offset,e.actions.primary.projectile.amount=e.actions.primary.projectile.amount||this.playerConfig.default.actions.primary.projectile.amount,e.actions.primary.projectile.color=e.actions.primary.projectile.color||this.playerConfig.default.actions.primary.projectile.color,e.actions.primary.projectile.damage=e.actions.primary.projectile.damage||this.playerConfig.default.actions.primary.projectile.damage,e.actions.primary.projectile.length=e.actions.primary.projectile.length||this.playerConfig.default.actions.primary.projectile.length,e.actions.primary.projectile.range=e.actions.primary.projectile.range||this.playerConfig.default.actions.primary.projectile.range,e.actions.primary.projectile.size=e.actions.primary.projectile.size||this.playerConfig.default.actions.primary.projectile.size,e.actions.primary.projectile.speed=e.actions.primary.projectile.speed||this.playerConfig.default.actions.primary.projectile.speed,e.actions.primary.projectile.spread=e.actions.primary.projectile.spread||this.playerConfig.default.actions.primary.projectile.spread,e.actions.primary.reload.time=e.actions.primary.reload.time||this.playerConfig.default.actions.primary.reload.time,e.actions.sprint.drain=e.actions.sprint.drain||this.playerConfig.default.actions.sprint.drain,e.actions.sprint.multiplier=e.actions.sprint.multiplier||this.playerConfig.default.actions.sprint.multiplier,e.equipment=e.equipment||this.playerConfig.default.equipment,e.flags.hidden=e.flags.hidden||this.playerConfig.default.flags.hidden,e.flags.invulnerable=e.flags.invulnerable||this.playerConfig.default.flags.invulnerable,e.inventory.primary=e.inventory.primary||this.playerConfig.default.inventory.primary,e.inventory.melee=e.inventory.melee||this.playerConfig.default.inventory.melee,e.physics.acceleration=e.physics.acceleration||this.playerConfig.default.physics.acceleration,e.physics.friction=e.physics.friction||this.playerConfig.default.physics.friction,e.rig.body=e.rig.body||this.playerConfig.default.rig.body,e.rig.head=e.rig.head||this.playerConfig.default.rig.head,e.rig.headwear=e.rig.headwear||this.playerConfig.default.rig.headwear,e.rig.weapon=e.rig.weapon||this.playerConfig.default.rig.weapon,e.stats.defense=e.stats.defense||this.playerConfig.default.stats.defense,e.stats.health.max=e.stats.health.max||this.playerConfig.default.stats.health.max,e.stats.health.value=e.stats.health.max||this.playerConfig.default.stats.health.max,e.stats.luck=e.stats.luck||this.playerConfig.default.stats.luck,e.stats.size=e.stats.size||this.playerConfig.default.stats.size,e.stats.speed=e.stats.speed||this.playerConfig.default.stats.speed,e.stats.stamina.max=e.stats.stamina.max||this.playerConfig.default.stats.stamina.max,e.stats.stamina.recovery.delay=e.stats.stamina.recovery.delay||this.playerConfig.default.stats.stamina.recovery.delay,e.stats.stamina.recovery.rate=e.stats.stamina.recovery.rate||this.playerConfig.default.stats.stamina.recovery.rate,e.stats.stamina.value=e.stats.stamina.value||this.playerConfig.default.stats.stamina.max,e.unique=e.unique||this.playerConfig.default.unique}),this.roomManager.sendMessage(JSON.stringify({type:"new-round",reservedSpawn:{x:3170*Math.random()+o,y:2370*Math.random()+o}}))}showGameControls(e){this.ui.updateDisplay(this.lobbyManager,"game",e)}startGame(){this.playerState.isHost&&(1!==this.lobbyManager.lobbyPlayers.size?this.executeStartGame():this.ui.soloGameWarning(()=>this.executeStartGame()))}async executeStartGame(){const e=await this.world.showGenerationMenu();this.roomManager.sendMessage(JSON.stringify({type:"start-game",reservedSpawn:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},worldData:e})),await this.world.generateWorld(e),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop()}startGameLoop(){this.gameState.gameInProgress=!0,this.isRoundInProgress=!0,this.playerState.myPlayer.actions.primary.magazine.currentReserve=Math.floor(this.playerConfig.default.actions.primary.magazine.maxReserve/2),this.playerState.myPlayer.actions.primary.magazine.currentAmmo=this.playerState.myPlayer.actions.primary.magazine.size,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(this.playerState.myPlayer.actions.primary.magazine.currentReserve),this.playerState.isReloading=!1,this.ui.createLeaderboard(this.lobbyManager,this.playerState.players,this.userId),this.upgradeManager.resetUpgrades(this.playerState.myPlayer);const e=this.lobbyManager.lobbyPlayers.get(this.userId);e&&(console.log("Found lobby rig for my player: ",e.rig),this.playerState.myPlayer.rig.body=e.rig.body,this.playerState.myPlayer.rig.head=e.rig.head,this.playerState.myPlayer.rig.headwear=e.rig.headwear,this.playerState.myPlayer.rig.weapon=e.rig.weapon),this.roomManager.sendMessage(JSON.stringify({type:"player-state",id:this.playerState.myPlayer.id,timestamp:this.playerState.myPlayer.timestamp,color:this.playerState.myPlayer.color,transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},actions:{dash:{cooldown:this.playerState.myPlayer.actions.dash.cooldown,drain:this.playerState.myPlayer.actions.dash.drain,multiplier:this.playerState.myPlayer.actions.dash.multiplier,time:this.playerState.myPlayer.actions.dash.time},melee:{cooldown:this.playerState.myPlayer.actions.melee.cooldown,damage:this.playerState.myPlayer.actions.melee.damage,duration:this.playerState.myPlayer.actions.melee.duration,range:this.playerState.myPlayer.actions.melee.range,size:this.playerState.myPlayer.actions.melee.size},primary:{buffer:this.playerState.myPlayer.actions.primary.buffer,burst:{amount:this.playerState.myPlayer.actions.primary.burst.amount,delay:this.playerState.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.playerState.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.playerState.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.playerState.myPlayer.actions.primary.magazine.maxReserve,size:this.playerState.myPlayer.actions.primary.magazine.size},offset:this.playerState.myPlayer.actions.primary.offset,projectile:{amount:this.playerState.myPlayer.actions.primary.projectile.amount,color:this.playerState.myPlayer.actions.primary.projectile.color,damage:this.playerState.myPlayer.actions.primary.projectile.damage,length:this.playerState.myPlayer.actions.primary.projectile.length,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,spread:this.playerState.myPlayer.actions.primary.projectile.spread},reload:{time:this.playerState.myPlayer.actions.primary.reload.time}},sprint:{drain:this.playerState.myPlayer.actions.sprint.drain,multiplier:this.playerState.myPlayer.actions.sprint.multiplier}},equipment:this.playerState.myPlayer.equipment,flags:{hidden:this.playerState.myPlayer.flags.hidden,invulnerable:this.playerState.myPlayer.flags.invulnerable},inventory:{primary:this.playerState.myPlayer.inventory.primary,melee:this.playerState.myPlayer.inventory.melee},physics:{acceleration:this.playerState.myPlayer.physics.acceleration,friction:this.playerState.myPlayer.physics.friction},rig:{body:this.playerState.myPlayer.rig.body,head:this.playerState.myPlayer.rig.head,headwear:this.playerState.myPlayer.rig.headwear,weapon:this.playerState.myPlayer.rig.weapon},stats:{defense:this.playerState.myPlayer.stats.defense,health:{max:this.playerState.myPlayer.stats.health.max,value:this.playerState.myPlayer.stats.health.value},luck:this.playerState.myPlayer.stats.luck,size:this.playerState.myPlayer.stats.size,speed:this.playerState.myPlayer.stats.speed,stamina:{max:this.playerState.myPlayer.stats.stamina.max,recovery:{delay:this.playerState.myPlayer.stats.stamina.recovery.delay,rate:this.playerState.myPlayer.stats.stamina.recovery.rate},value:this.playerState.myPlayer.stats.stamina.value}},unique:this.playerState.myPlayer.unique})),this.gameLoop();const t={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:300},a={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:300};this.utility.setSlider(t),this.utility.setSlider(a)}gameLoop(){if(!(this.gameState.gameInProgress&&this.ui.ctx&&this.ui.canvas&&this.ui.decalCtx&&this.ui.decalCanvas))return;if(this.gameState.isPaused)return void requestAnimationFrame(()=>this.gameLoop());const e=this.utility.deltaTime();this.camera.update(e),this.playerController.updatePlayerPosition(e),this.combatController.updateAttack(e),this.combatController.updateProjectiles(e),this.particlesManager.updateParticles(e),this.particlesManager.updateEmitters(e),this.particlesManager.updateShrapnel(e),this.animator.updateCharacterAnimations(e),this.staminaController.updateStamina(e),this.dashController.updateDash(e),this.collisionsManager.checkCollisions(e);const t={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:300};this.utility.setSlider(t),this.renderingManager.clearCtx(this.ui.ctx),this.world.drawWorld(),this.world.worldDebug.drawDebug(),this.ui.ctx.drawImage(this.ui.decalCanvas,this.camera.pos.x,this.camera.pos.y,n,l,0,0,n,l),this.renderingManager.drawObjects(),this.combatController.projectiles.forEach(e=>{this.renderingManager.drawProjectile(e)}),this.playerState.players.forEach(e=>{if(!this.ui.ctx)return;const t={player:e,context:this.ui.ctx};this.renderingManager.drawCharacter(t)});const a={player:this.playerState.myPlayer,context:this.ui.ctx};this.renderingManager.drawCharacter(a),this.particlesManager.drawParticles(),this.particlesManager.drawShrapnel(),requestAnimationFrame(()=>this.gameLoop()),this.world.streamUnloadedChunks()}pauseGame(){this.gameState.gameInProgress&&(this.gameState.isPaused=!0,console.log("Game paused"),this.controlsManager.clearActiveKeys(),this.playerState.isSprinting=!1,this.playerState.isDashing=!1,this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0)}resumeGame(){this.gameState.gameInProgress&&(this.gameState.isPaused=!1,console.log("Game resumed"))}resetGameState(e){this.gameState.gameInProgress=!1,this.gameState.isPaused=!1,this.isRoundInProgress=!1,this.gameWinner=null,this.roundWinner=null,this.gameState.gameMaxWins=d.MAX_WINS,this.gameState.gameMaxPlayers=d.MAX_PLAYERS,"Room"===e&&(this.lobbyManager.inLobby=!1,this.playerState.isHost=!1),this.playerState.players.clear(),this.combatController.projectiles.clear(),this.objectsManager.ammoBoxes.clear(),this.decalsManager.dynamicDecals.clear(),this.particlesManager.particles.clear(),this.particlesManager.emitters.clear(),this.particlesManager.shrapnel.clear(),this.upgradeManager.upgradesCompleted.clear(),this.ui.ammoReservesUIController.reserveBulletParticles=[],"Room"===e&&this.lobbyManager.lobbyPlayers.clear(),this.renderingManager.clearCtx(),this.chatManager.clearChat(),this.ui.clearLeaderboard(),this.playerState.resetPlayerState(),this.playerState.initPlayer(this.userId),this.controlsManager.clearActiveKeys(),this.animator.clearAllAnimations(),this.utility.clearTimeoutCache(),this.upgradeManager.resetUpgrades(this.playerState.myPlayer)}watchForInputs(){const e=()=>{this.controlsManager.gamepadConnectionEnabled&&this.controlsManager.pollGamepad(),this.checkActions(),requestAnimationFrame(e)};e()}checkActions(){if(!this.gameState.gameInProgress||this.gameState.isPaused)return;const e=this.settingsManager.getSettings().controls.keybinds;this.controlsManager.triggered(e.dash)&&this.dashController.startDash(),this.controlsManager.triggered(e.melee)&&this.combatController.canMelee()&&this.combatController.triggerAttack("melee"),this.controlsManager.triggered(e.reload)&&this.combatController.startReload(),this.controlsManager.held(e.sprint)?this.moveController.isMoving()&&(this.playerState.isSprinting=!0):this.playerState.isSprinting=!1,this.controlsManager.triggered(e.attack)&&(!this.playerState.canShoot||this.playerState.isBurstActive||this.playerState.isMelee||this.combatController.triggerAttack("ranged")),this.controlsManager.held(e.attack)&&this.playerState.canAutoFire&&this.combatController.triggerAttack("ranged");const t=this.controlsManager.getGamepadRAxis();null!==t&&this.animator.rotateCharacterPart(this.userId,t),this.controlsManager.updatePreviousKeys()}startUpgradePhase(e){console.log("Starting upgrade phase..."),this.upgradeManager.upgradesCompleted.clear(),e===this.userId?this.showWinnerWaitScreen():this.showUpgradeSelection(2)}showWinnerWaitScreen(){if(!this.ui.upgradeContainer)return;this.ui.upgradeContainer.innerHTML="";const e=document.createElement("div");e.className="upgrade_waiting",e.textContent="Waiting for other players...",this.ui.upgradeContainer.appendChild(e),this.ui.upgradeContainer.style.display="flex"}showWinnerContinueButton(){if(!this.ui.upgradeContainer)return;this.ui.upgradeContainer.innerHTML="";const e=document.createElement("div");e.className="upgrade_waiting",e.textContent="Upgrade phase complete.";const t=document.createElement("button");t.textContent="Continue",t.onclick=()=>{this.ui.upgradeContainer&&(console.log("Winner pressed continue..."),this.ui.upgradeContainer.style.display="none",this.utility.safeTimeout(()=>{this.startNewRound()},d.NEW_ROUND_DELAY))},this.ui.upgradeContainer.appendChild(e),this.ui.upgradeContainer.appendChild(t),this.ui.upgradeContainer.style.display="flex"}showUpgradeSelection(e){this.ui.upgradeContainer&&(this.ui.upgradeContainer.innerHTML="",this.upgradeManager.getUpgrades(e,this.playerState.myPlayer).forEach(e=>{const t=document.createElement("div");t.className="upgrade_card container",t.setAttribute("data-rarity",e.rarity.toString());const a=document.createElement("div");a.className="upgrade_image";const s=document.createElement("img");s.src=e.icon,s.alt=e.name,s.className="upgrade_icon",s.onerror=()=>{console.warn(`Failed to load upgrade image: ${e.icon}`),s.style.display="none"},a.appendChild(s);const i=document.createElement("div");i.className="upgrade_name",i.textContent=e.name;const r=document.createElement("div");r.className="upgrade_subtitle",r.textContent=e.subtitle,t.appendChild(a),t.appendChild(i),t.appendChild(r),t.addEventListener("click",()=>{console.log("Selected upgrade: ",e.name),this.selectUpgrade(e.id)}),this.ui.upgradeContainer&&this.ui.upgradeContainer.appendChild(t)}),this.ui.upgradeContainer.style.display="flex")}selectUpgrade(e){this.upgradeManager.applyUpgrade(e,this.playerState.myPlayer)?this.finishUpgrade(e):console.error("Failed to apply upgrade")}finishUpgrade(e){this.ui.upgradeContainer&&(this.ui.upgradeContainer.style.display="none"),this.roomManager.sendMessage(JSON.stringify({type:"upgrade-taken",upgradeId:e,userId:this.userId,isUnique:this.upgradeManager.upgrades.find(t=>t.id===e)?.unique||!1})),this.roomManager.sendMessage(JSON.stringify({type:"player-state",id:this.playerState.myPlayer.id,timestamp:this.playerState.myPlayer.timestamp,color:this.playerState.myPlayer.color,transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},actions:{dash:{cooldown:this.playerState.myPlayer.actions.dash.cooldown,drain:this.playerState.myPlayer.actions.dash.drain,multiplier:this.playerState.myPlayer.actions.dash.multiplier,time:this.playerState.myPlayer.actions.dash.time},melee:{cooldown:this.playerState.myPlayer.actions.melee.cooldown,damage:this.playerState.myPlayer.actions.melee.damage,duration:this.playerState.myPlayer.actions.melee.duration,range:this.playerState.myPlayer.actions.melee.range,size:this.playerState.myPlayer.actions.melee.size},primary:{buffer:this.playerState.myPlayer.actions.primary.buffer,burst:{amount:this.playerState.myPlayer.actions.primary.burst.amount,delay:this.playerState.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.playerState.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.playerState.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.playerState.myPlayer.actions.primary.magazine.maxReserve,size:this.playerState.myPlayer.actions.primary.magazine.size},offset:this.playerState.myPlayer.actions.primary.offset,projectile:{amount:this.playerState.myPlayer.actions.primary.projectile.amount,color:this.playerState.myPlayer.actions.primary.projectile.color,damage:this.playerState.myPlayer.actions.primary.projectile.damage,length:this.playerState.myPlayer.actions.primary.projectile.length,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,spread:this.playerState.myPlayer.actions.primary.projectile.spread},reload:{time:this.playerState.myPlayer.actions.primary.reload.time}},sprint:{drain:this.playerState.myPlayer.actions.sprint.drain,multiplier:this.playerState.myPlayer.actions.sprint.multiplier}},equipment:this.playerState.myPlayer.equipment,flags:{hidden:this.playerState.myPlayer.flags.hidden,invulnerable:this.playerState.myPlayer.flags.invulnerable},inventory:{primary:this.playerState.myPlayer.inventory.primary,melee:this.playerState.myPlayer.inventory.melee},physics:{acceleration:this.playerState.myPlayer.physics.acceleration,friction:this.playerState.myPlayer.physics.friction},rig:{body:this.playerState.myPlayer.rig.body,head:this.playerState.myPlayer.rig.head,headwear:this.playerState.myPlayer.rig.headwear,weapon:this.playerState.myPlayer.rig.weapon},stats:{defense:this.playerState.myPlayer.stats.defense,health:{max:this.playerState.myPlayer.stats.health.max,value:this.playerState.myPlayer.stats.health.max},luck:this.playerState.myPlayer.stats.luck,size:this.playerState.myPlayer.stats.size,speed:this.playerState.myPlayer.stats.speed,stamina:{max:this.playerState.myPlayer.stats.stamina.max,recovery:{delay:this.playerState.myPlayer.stats.stamina.recovery.delay,rate:this.playerState.myPlayer.stats.stamina.recovery.rate},value:this.playerState.myPlayer.stats.stamina.max}},unique:this.playerState.myPlayer.unique})),console.log("Upgrade selected, waiting for others...")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new ae}):new ae})()})();
//# sourceMappingURL=app.js.map