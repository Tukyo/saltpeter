(()=>{"use strict";const t={ACTIONS:{DASH:{COOLDOWN:1e3,DRAIN:40,MULTIPLIER:3,TIME:150},MELEE:{COOLDOWN:250,DAMAGE:10,DURATION:100,RANGE:10,SIZE:2},PRIMARY:{BUFFER:100,BURST:{AMOUNT:1,DELAY:75},MAGAZINE:{SIZE:10,STARTING_RESERVE:20,MAX_RESERVE:50},OFFSET:10,PROJECTILE:{AMOUNT:1,COLOR:"#fff5beff",DAMAGE:25,LENGTH:15,RANGE:5,SIZE:1,SPEED:35,SPREAD:10,UNIQUE:[]},RELOAD:{TIME:750}},SPRINT:{DRAIN:5,MULTIPLIER:1.75}},DATA:{ID_LENGTH:12},EQUIPMENT:[],PHYSICS:{ACCELERATION:.55,FRICTION:.85},RIG:{BODY:"DEFAULT",HEAD:"DEFAULT",HEADWEAR:"DEFAULT",WEAPON:"GLOCK"},STATS:{HEALTH:{MAX:100},LUCK:1,SIZE:100,SPEED:6,STAMINA:{MAX:100,RECOVERY:{DELAY:1e3,RATE:25}}},UNIQUE:[],VISUAL:{ID_DISPLAY_OFFSET:25}},e=8,a={RADIUS:{MIN:4,MAX:8},DENSITY:{MIN:.175,MAX:.35},OPACITY:{MIN:.15,MAX:.25},VARIATION:.215,COLOR:"#000000"},s={RADIUS:{MIN:5,MAX:17.5},DENSITY:{MIN:.1,MAX:.175},OPACITY:{MIN:.275,MAX:.315},VARIATION:.5,COLOR:"#781414"},r={COUNT:{MIN:1,MAX:4},LIFETIME:{MIN:800,MAX:1e3},NOISE:{STRENGTH:{MIN:0,MAX:0},SCALE:{MIN:0,MAX:0}},OPACITY:{MIN:.25,MAX:.75},SPEED:{MIN:.25,MAX:.75},SIZE_OVER_LIFETIME:{MIN:0,MAX:0},SIZE:{MIN:.125,MAX:2.275},TORQUE:{MIN:-720,MAX:720},COLLIDE:!0,FADE:!0,PAINT:!1,SPREAD:.25,STAIN:!0,COLOR:"#8b1a1a"},i={COUNT:{MIN:4,MAX:12},LIFETIME:{MIN:150,MAX:1200},NOISE:{STRENGTH:{MIN:0,MAX:0},SCALE:{MIN:0,MAX:0}},OPACITY:{MIN:.425,MAX:.775},SPEED:{MIN:1.5,MAX:4.75},SIZE_OVER_LIFETIME:{MIN:0,MAX:0},SIZE:{MIN:.75,MAX:3.5},TORQUE:{MIN:-720,MAX:720},COLLIDE:!0,FADE:!1,PAINT:!0,SPREAD:.425,STAIN:!0,COLOR:"#8b1a1a"},o={COUNT:{MIN:8,MAX:15},LIFETIME:{MIN:150,MAX:300},NOISE:{STRENGTH:{MIN:0,MAX:0},SCALE:{MIN:0,MAX:0}},OPACITY:{MIN:.4,MAX:.8},SPEED:{MIN:4,MAX:10},SIZE_OVER_LIFETIME:{MIN:0,MAX:0},SIZE:{MIN:1,MAX:3},TORQUE:{MIN:0,MAX:0},COLLIDE:!1,FADE:!0,PAINT:!1,SPREAD:.6,STAIN:!1,COLOR:"#ffaa00"},n={COUNT:{MIN:1,MAX:1},LIFETIME:{MIN:250,MAX:550},NOISE:{STRENGTH:{MIN:0,MAX:0},SCALE:{MIN:0,MAX:0}},OPACITY:{MIN:1,MAX:1},SPEED:{MIN:5,MAX:8},SIZE_OVER_LIFETIME:{MIN:0,MAX:0},SIZE:{MIN:2,MAX:2},TORQUE:{MIN:-720,MAX:720},COLLIDE:!0,FADE:!1,PAINT:!0,SPREAD:.4,STAIN:!1,COLOR:"#d4af37"},l={COUNT:{MIN:3,MAX:6},LIFETIME:{MIN:800,MAX:1400},NOISE:{STRENGTH:{MIN:.1,MAX:.3},SCALE:{MIN:40,MAX:80}},OPACITY:{MIN:.15,MAX:.35},SPEED:{MIN:.5,MAX:1.5},SIZE:{MIN:4,MAX:8},SIZE_OVER_LIFETIME:{MIN:2,MAX:3},TORQUE:{MIN:-180,MAX:180},COLLIDE:!1,FADE:!0,PAINT:!1,SPREAD:.4,STAIN:!1,COLOR:"#5a5a5a"},h={COUNT:{MIN:8,MAX:16},LIFETIME:{MIN:150,MAX:300},NOISE:{STRENGTH:{MIN:.25,MAX:5},SCALE:{MIN:.25,MAX:1.5}},OPACITY:{MIN:.4,MAX:.8},SPEED:{MIN:4,MAX:10},SIZE:{MIN:1,MAX:3},SIZE_OVER_LIFETIME:{MIN:0,MAX:0},TORQUE:{MIN:-720,MAX:720},COLLIDE:!1,FADE:!0,PAINT:!1,SPREAD:.6,STAIN:!1,COLOR:"#ffaa00"},m={BASE:"/assets/img/object/ammobox/base.png",BULLETS:"/assets/img/object/ammobox/bullets.png",LID:"/assets/img/object/ammobox/lid.png"},y=800,c=600,p=15,d=1e3,u={MELEE:"f",MOVE_UP:"w",MOVE_LEFT:"a",MOVE_DOWN:"s",MOVE_RIGHT:"d",RELOAD:"r",SPRINT:"shift",ATTACK:"mouse1",DASH:" "},g=3e3,S=1,M=.5,I=5,f=10,P=!0,E={IMPACT:{FLESH:{BULLET:["/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_00.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_01.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_02.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_03.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_04.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_05.ogg"]},METAL:{BULLET:["/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_00.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_01.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_02.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_03.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_04.ogg"]}},WEAPON:{GLOCK:{ATTACK:["/assets/audio/sfx/weapons/glock/glock_attack_00.ogg","/assets/audio/sfx/weapons/glock/glock_attack_01.ogg","/assets/audio/sfx/weapons/glock/glock_attack_02.ogg","/assets/audio/sfx/weapons/glock/glock_attack_03.ogg","/assets/audio/sfx/weapons/glock/glock_attack_04.ogg","/assets/audio/sfx/weapons/glock/glock_attack_05.ogg"],SHELL:["/assets/audio/sfx/weapons/glock/glock_shell_00.ogg","/assets/audio/sfx/weapons/glock/glock_shell_01.ogg","/assets/audio/sfx/weapons/glock/glock_shell_02.ogg","/assets/audio/sfx/weapons/glock/glock_shell_03.ogg","/assets/audio/sfx/weapons/glock/glock_shell_04.ogg","/assets/audio/sfx/weapons/glock/glock_shell_05.ogg","/assets/audio/sfx/weapons/glock/glock_shell_06.ogg","/assets/audio/sfx/weapons/glock/glock_shell_07.ogg","/assets/audio/sfx/weapons/glock/glock_shell_08.ogg","/assets/audio/sfx/weapons/glock/glock_shell_09.ogg","/assets/audio/sfx/weapons/glock/glock_shell_10.ogg","/assets/audio/sfx/weapons/glock/glock_shell_11.ogg","/assets/audio/sfx/weapons/glock/glock_shell_12.ogg","/assets/audio/sfx/weapons/glock/glock_shell_13.ogg","/assets/audio/sfx/weapons/glock/glock_shell_14.ogg"],EMPTY:["/assets/audio/sfx/weapons/glock/glock_empty_00.ogg"]}}},C={GLOCK:["/assets/img/weapon/glock/body.png","/assets/img/weapon/glock/slide.png"],KNIFE:["/assets/img/weapon/melee/knife_00.png"]},A={DEFAULT:"/assets/img/char/default/body.png"},x={DEFAULT:"/assets/img/char/default/head.png"},b={DEFAULT:"/assets/img/char/default/headwear.png"},v={BLOOD:["/assets/img/effects/blood/blood_00.png","/assets/img/effects/blood/blood_01.png","/assets/img/effects/blood/blood_02.png","/assets/img/effects/blood/blood_03.png","/assets/img/effects/blood/blood_04.png"],GORE:["/assets/img/effects/gore/gore_00.png","/assets/img/effects/gore/gore_01.png","/assets/img/effects/gore/gore_02.png","/assets/img/effects/gore/gore_03.png","/assets/img/effects/gore/gore_04.png","/assets/img/effects/gore/gore_05.png","/assets/img/effects/gore/gore_06.png","/assets/img/effects/gore/gore_07.png","/assets/img/effects/gore/gore_08.png","/assets/img/effects/gore/gore_09.png","/assets/img/effects/gore/gore_10.png","/assets/img/effects/gore/gore_11.png","/assets/img/effects/gore/gore_12.png","/assets/img/effects/gore/gore_13.png"]};class R{constructor(t,e,a){this.playerState=t,this.roomController=e,this.userId=a,this.characterAnimations=new Map,this.characterOffsets=new Map}animateCharacterPart(t){this.generateCharacterAnimation(t),this.roomController.sendMessage(JSON.stringify({type:"character-animation",params:t}))}rotateCharacterPart(t,e){if(t===this.userId)this.playerState.myPlayer.transform.rot=e;else{const a=this.playerState.players.get(t);if(!a)return;a.transform.rot=e}}animateCharacterPartNetwork(t){this.generateCharacterAnimation(t)}generateCharacterAnimation(t){const{playerId:e,part:a,frames:s,duration:r,partIndex:i}=t,o=`${e}_${a}_${i||0}`;this.characterAnimations.set(o,{playerId:e,part:a,partIndex:i,frames:s,duration:r,startTime:Date.now(),originalOffset:{x:0,y:0}})}updateCharacterAnimations(t){const e=[],a=Date.now();this.characterAnimations.forEach((t,s)=>{const r=(a-t.startTime)/t.duration;if(0!==t.duration&&r>=1)return void e.push(s);const i=Object.keys(t.frames).map(Number).sort((t,e)=>t-e);let o,n,l=0;for(let t=0;t<i.length-1;t++){const e=i[t],a=i[t+1];if(r>=e&&r<a){l=t;break}}if(r>=1){const e=t.frames[i[i.length-1]];o=e.x,n=e.y}else{const e=t.frames[i[l]],a=t.frames[i[l+1]]||e,s=(r-i[l])/(i[l+1]-i[l])||0;o=e.x+(a.x-e.x)*s,n=e.y+(a.y-e.y)*s}this.characterOffsets.set(s,{x:o,y:n})}),e.forEach(t=>{this.characterAnimations.delete(t),this.characterOffsets&&this.characterOffsets.delete(t)})}}class T{constructor(t=10,e=5){this.poolSize=t,this.maxConcurrent=e,this.pools=new Map,this.activeAudio=new Map}createPool(t){const e=[];for(let a=0;a<this.poolSize;a++){const a=new Audio(t);a.preload="auto",a.addEventListener("ended",()=>this.returnToPool(t,a)),a.addEventListener("pause",()=>this.returnToPool(t,a)),e.push(a)}return e}returnToPool(t,e){const a=this.activeAudio.get(t);if(a){const t=a.indexOf(e);t>-1&&a.splice(t,1)}const s=this.pools.get(t);s&&!s.includes(e)&&s.push(e)}getAudio(t){const e=this.activeAudio.get(t)||[];if(e.length>=this.maxConcurrent)return null;let a=this.pools.get(t);a||(a=this.createPool(t),this.pools.set(t,a),this.activeAudio.set(t,[]));const s=a.pop();return s?(s.currentTime=0,s.volume=1,s.playbackRate=1,s.loop=!1,e.push(s),s):null}preloadSound(t){if(!this.pools.has(t)){const e=this.createPool(t);this.pools.set(t,e),this.activeAudio.set(t,[])}}}class w{constructor(t,e){this.roomManager=t,this.settingsManager=e,this.audioPool=new T(f,I)}playAudio(t){const e=this.audioPool.getAudio(t.src);if(!e)return void console.warn(`Audio pool exhausted or max concurrent reached for: ${t.src}`);let a=1;t.volume&&(a=t.volume.min+Math.random()*(t.volume.max-t.volume.min));const s=t.spatial?.blend??0;if(s>0&&t.spatial?.pos){const e=t.spatial.pos.x-t.listener.x,r=t.spatial.pos.y-t.listener.y,i=Math.sqrt(e*e+r*r);let o;if(t.spatial.rolloff){const e=t.spatial.rolloff.type||"linear",a=t.spatial.rolloff.factor,s=t.spatial.rolloff.distance;if("logarithmic"===e){const t=s*a;if(i<t)o=1;else{const e=(i-t)/(s-t);o=Math.max(0,1-Math.pow(e,.5))}}else o=Math.max(0,1-i/s*a)}else{const t=Math.max(y,c);o=Math.max(0,1-i/t)}a*=1-s+o*s}const r=t.output?.toLowerCase()||null,i=this.settingsManager.getSettings().audio.mixer;if(r&&void 0!==i[r]&&(a*=i[r]),a*=this.settingsManager.getSettings().audio.mixer.master,e.volume=Math.max(0,Math.min(1,a)),t.pitch){const a=t.pitch.min+Math.random()*(t.pitch.max-t.pitch.min);e.playbackRate=Math.max(.25,Math.min(4,a))}void 0!==t.loop&&(e.loop=t.loop);let o=0;t.delay&&(o=1e3*(t.delay.min+Math.random()*(t.delay.max-t.delay.min))),setTimeout(()=>{e.play().catch(t=>{console.warn("Audio play failed:",t)})},o)}playAudioNetwork(t){this.playAudio(t),this.roomManager.sendMessage(JSON.stringify({type:"play-audio",params:t}))}preloadAudioAssets(t,e){this.preloadSFX(t,e)}preloadSFX(t,e){for(const a in t){const s=t[a];Array.isArray(s)?s.forEach(t=>{"string"==typeof t&&t.endsWith(e)&&this.audioPool.preloadSound(t)}):"object"==typeof s&&null!==s&&this.preloadSFX(s,e)}}}class N{constructor(){this.activeKeys=new Set,this.mousePos={x:0,y:0}}getActiveKeys(){return this.activeKeys}addKey(t){this.activeKeys.add(t)}removeKey(t){this.activeKeys.delete(t)}clearActiveKeys(){this.activeKeys.clear()}getMousePos(){return this.mousePos}setMousePos(t){this.mousePos.x=t.x,this.mousePos.y=t.y}}class O{constructor(t,e,a,s,r){this.ammoReservesUIController=t,this.objectsManager=e,this.playerState=a,this.roomManager=s,this.userId=r}checkCollisions(t){this.playerState.myPlayer.transform.pos.x=Math.max(15,Math.min(785,this.playerState.myPlayer.transform.pos.x)),this.playerState.myPlayer.transform.pos.y=Math.max(15,Math.min(585,this.playerState.myPlayer.transform.pos.y)),this.checkObjectCollisions(t),this.checkPlayersCollisions(t)}checkObjectCollisions(t){if(this.playerState.myPlayer.stats.health.value<=0)return;const e=this.getPlayerCollider(this.playerState.myPlayer,5);this.objectsManager.ammoBoxes.forEach((t,a)=>{if(t.isOpen)return;const s=this.playerState.myPlayer.transform.pos.x-t.transform.pos.x,r=this.playerState.myPlayer.transform.pos.y-t.transform.pos.y;if(Math.sqrt(s*s+r*r)<=e){const e=this.playerState.myPlayer.actions.primary.magazine.currentReserve,s=this.playerState.myPlayer.actions.primary.magazine.maxReserve,r=Math.min(t.ammoAmount,s-e);if(r>0){this.playerState.myPlayer.actions.primary.magazine.currentReserve+=r,this.ammoReservesUIController.spawnAmmoInReserveUI(r),console.log(`Picked up ammo box! +${r} bullets. Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`);const e=Math.random()*Math.PI*2,s=2+3*Math.random();t.isOpen=!0,t.lid.velocity={x:Math.cos(e)*s,y:Math.sin(e)*s},t.lid.torque=.3*(Math.random()-.5),this.roomManager.sendMessage(JSON.stringify({type:"ammo-pickup",ammoBoxId:a,playerId:this.userId,boxState:{isOpen:!0,lid:t.lid}}))}}})}checkPlayersCollisions(t){this.playerState.myPlayer.stats.health.value<=0||this.playerState.players.forEach(t=>{if(t.stats.health.value<=0)return;const e=this.playerState.myPlayer.transform.pos.x-t.transform.pos.x,a=this.playerState.myPlayer.transform.pos.y-t.transform.pos.y,s=Math.sqrt(e*e+a*a),r=this.getPlayerCollider(this.playerState.myPlayer)+this.getPlayerCollider(t);if(s<r&&s>.01){const t=r-s,i=e/s*t,o=a/s*t;this.playerState.myPlayer.transform.pos.x+=i,this.playerState.myPlayer.transform.pos.y+=o}})}getPlayerCollider(t,e){let a=t.stats.size/4;return e&&e>0&&(a=t.stats.size/4+e),a}}class L{constructor(t,e,a){this.roomManager=t,this.ui=e,this.utility=a,this.decals=new Map}createDecal(t,e,s,r=a){this.generateDecal(t,e,s,r),this.roomManager.sendMessage(JSON.stringify({type:"add-decal",decalId:s,x:t,y:e,params:r}))}createDecalNetwork(t,e,a,s){this.decals.has(a)||this.generateDecal(t,e,a,s)}generateDecal(t,e,a,s){if(!this.ui.decalCtx)return;if(t<0||t>y||e<0||e>c)return;const r=s.RADIUS.MIN+Math.random()*(s.RADIUS.MAX-s.RADIUS.MIN),i=s.DENSITY.MIN+Math.random()*(s.DENSITY.MAX-s.DENSITY.MIN),o=s.OPACITY.MIN+Math.random()*(s.OPACITY.MAX-s.OPACITY.MIN),n=Math.floor(r*r*Math.PI*i),l=this.utility.hexToRgb(s.COLOR);if(l){this.ui.decalCtx.save(),this.ui.decalCtx.globalCompositeOperation="source-over";for(let a=0;a<n;a++){const a=Math.random()*Math.PI*2,i=Math.random()*r,n=t+Math.cos(a)*i,h=e+Math.sin(a)*i;if(n<0||n>=y||h<0||h>=c)continue;const m=o+(Math.random()-.5)*s.VARIATION,p=Math.max(.05,Math.min(.6,m));this.ui.decalCtx.fillStyle=`rgba(${l.r}, ${l.g}, ${l.b}, ${p})`,this.ui.decalCtx.fillRect(Math.floor(n),Math.floor(h),1,1)}this.ui.decalCtx.restore(),this.decals.set(a,{params:s,pos:{x:t,y:e}})}else console.error(`Invalid hex color: ${s.COLOR}`)}}class D{constructor(t,e,a){this.utility=t,this.ui=e,this.roomManager=a,this.inLobby=!1,this.lobbyPlayers=new Map}showLobbyControls(t,e,a,s,r,i,o,n,l){this.ui.updateDisplay(i,"lobby",n),this.lobbyPlayers.set(l,{id:l,color:o.color,isHost:a}),this.setupLobbyOptions(t,e,a,s,r);const h={inputId:"winsInput",value:e},m={toggleId:"privateToggle",value:s},y={toggleId:"upgradesToggle",value:r};this.utility.setToggle(m),this.utility.setToggle(y),this.utility.setInput(h),this.ui.displayLobbyPlayers(a,i,l),this.ui.updateHostDisplay(a,i)}setupLobbyOptions(t,e,a,s,r){this.setupLobbyToggle("privateToggle",a,"privateRoom",()=>s,t=>s=t),this.setupLobbyToggle("upgradesToggle",a,"upgradesEnabled",()=>r,t=>r=t),this.setupLobbyInput("winsInput",a,"maxWins",()=>e,t=>e=t),this.setupLobbyInput("playersInput",a,"maxPlayers",()=>t,e=>t=e)}setupLobbyToggle(t,e,a,s,r){const i=this.ui[t];if(!i)return;const o=`${t}Handler`;this[o]&&i.removeEventListener("click",this[o]);const n=()=>{if(!e)return;const i=!s();r(i);const o={toggleId:t,value:i};this.utility.setToggle(o),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",[a]:i})),console.log(`${a} changed to: ${i}`)};this[o]=n,i.addEventListener("click",n)}setupLobbyInput(t,e,a,s,r){const i=this.ui[t];if(!i)return;const o=`${t}Handler`;this[o]&&i.removeEventListener("change",this[o]);const n=()=>{if(!e)return;const o=parseInt(i.value);if(isNaN(o)||o<1)return void(i.value=s().toString());r(o);const n={inputId:t,value:o};this.utility.setInput(n),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",[a]:o})),console.log(`${a} changed to: ${o}`)};this[o]=n,i.addEventListener("change",n)}syncLobbyOptions(t){this.syncOption(t,"privateRoom","isPrivateRoom","privateToggle",this.utility.setToggle.bind(this.utility),"Lobby privacy",t=>t?"Private":"Public"),this.syncOption(t,"maxWins","gameMaxWins","winsInput",this.utility.setInput.bind(this.utility),"Game max wins"),this.syncOption(t,"maxPlayers","gameMaxPlayers","playersInput",this.utility.setInput.bind(this.utility),"Game max players"),this.syncOption(t,"upgradesEnabled","isUpgradesEnabled","upgradesToggle",this.utility.setToggle.bind(this.utility),"Game upgrades toggled")}syncOption(t,e,a,s,r,i,o){if(void 0===t[e])return;this[a]=t[e],r(s.includes("Input")?{inputId:s,value:t[e]}:{toggleId:s,value:t[e]});const n=o?o(t[e]):t[e];console.log(`${i} synced to: ${n}`)}promotePlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"promote-player",targetPlayerId:t}))}kickPlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"kick-player",targetPlayerId:t}))}}class B{constructor(t,e,a,s,r,i,o,n,l,h,m,y,c,p){this.animator=t,this.chatManager=e,this.combatController=a,this.controlsManager=s,this.dashController=r,this.gameState=i,this.lobbyManager=o,this.moveController=n,this.roomController=l,this.roomManager=h,this.playerState=m,this.settingsManager=y,this.ui=c,this.userId=p}initEventListeners(){this.ui.canvas&&this.ui.hostButton&&this.ui.joinButton&&this.ui.quickplayButton&&this.ui.lobbyLeaveButton&&this.ui.lobbyCodeButton&&this.ui.gameLeaveButton&&this.ui.gameCodeButton&&this.ui.startGameBtn&&this.ui.chatSendBtn&&this.ui.chatInput&&(this.ui.hostButton.addEventListener("click",()=>this.roomController.hostRoom()),this.ui.joinButton.addEventListener("click",()=>this.roomController.joinRoom()),this.ui.quickplayButton.addEventListener("click",()=>this.roomController.quickPlay()),this.ui.lobbyLeaveButton.addEventListener("click",()=>this.roomController.leaveRoom()),this.ui.lobbyCodeButton.addEventListener("click",()=>this.roomController.copyRoomCode()),this.ui.gameLeaveButton.addEventListener("click",()=>this.roomController.leaveRoom()),this.ui.gameCodeButton.addEventListener("click",()=>this.roomController.copyRoomCode()),this.ui.startGameBtn.addEventListener("click",()=>this.onStartButtonClick()),this.ui.chatSendBtn.addEventListener("click",()=>this.chatManager.sendChatMessage(this.userId)),this.ui.chatInput.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.chatManager.sendChatMessage(this.userId))}),this.ui.chatInput.addEventListener("focus",()=>{this.controlsManager.clearActiveKeys(),this.playerState.canShoot=!1,this.playerState.isSprinting=!1,this.playerState.isDashing=!1,this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0}),this.ui.chatInput.addEventListener("blur",()=>{this.controlsManager.clearActiveKeys(),this.playerState.canShoot=!0,this.playerState.isSprinting=!1,this.playerState.isDashing=!1}),document.addEventListener("keydown",t=>this.onKeyDown(t)),document.addEventListener("keyup",t=>this.onKeyUp(t)),document.addEventListener("keydown",t=>{"Escape"===t.key&&this.gameState.gameInProgress&&!this.lobbyManager.inLobby&&t.preventDefault()}),document.addEventListener("mouseup",t=>this.onMouseUp(t)),document.addEventListener("mousemove",t=>this.onMouseMove(t)),this.ui.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)))}onKeyDown(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress||this.gameState.isPaused)return;const e=t.key.toLowerCase(),a=this.settingsManager.getSettings().controls.keybinds;if(Object.values(a).includes(e))switch(t.preventDefault(),this.controlsManager.addKey(e),e){case a.dash:this.dashController.startDash();break;case a.melee:this.combatController.canMelee()&&this.combatController.triggerAttack("melee");break;case a.reload:this.combatController.startReload();break;case a.sprint:this.moveController.isMoving()&&(this.playerState.isSprinting=!0)}}onKeyUp(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress)return;const e=t.key.toLowerCase(),a=this.settingsManager.getSettings().controls.keybinds;Object.values(a).includes(e)&&(t.preventDefault(),this.controlsManager.removeKey(e),e===a.sprint&&(this.playerState.isSprinting=!1))}onMouseDown(t){this.ui.chatInput!==document.activeElement&&this.gameState.gameInProgress&&!this.gameState.isPaused&&this.ui.canvas&&(0!==t.button||!this.playerState.canShoot||this.playerState.isBurstActive||this.playerState.isMelee||(this.updateMouse(t),this.combatController.triggerAttack("ranged"),this.playerState.canShoot=!1))}onMouseUp(t){this.ui.chatInput!==document.activeElement&&this.gameState.gameInProgress&&0===t.button&&(this.playerState.canShoot=!0)}onMouseMove(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress||this.gameState.isPaused)return;this.updateMouse(t);const e=this.controlsManager.getMousePos(),a=e.x-this.playerState.myPlayer.transform.pos.x,s=e.y-this.playerState.myPlayer.transform.pos.y,r=Math.atan2(s,a)+Math.PI/2;this.animator.rotateCharacterPart(this.userId,r);const i=Date.now();Math.abs(r-this.playerState.lastSentRotation)>.1&&i-this.playerState.lastSentRotationTime>=25&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{rot:this.playerState.myPlayer.transform.rot}})),this.playerState.lastSentRotation=r,this.playerState.lastSentRotationTime=i)}updateMouse(t){if(this.ui.chatInput===document.activeElement)return;if(!this.ui.canvas)return;const e=this.ui.canvas.getBoundingClientRect(),a=t.clientX-e.left,s=t.clientY-e.top;this.controlsManager.setMousePos({x:a,y:s})}onStartButtonClick(){const t=new CustomEvent("customEvent_startGame");window.dispatchEvent(t)}}class k{constructor(t,e,a,s,r,i,o){this.decalsManager=t,this.playerState=e,this.renderdingManager=a,this.roomManager=s,this.ui=r,this.userId=i,this.utility=o,this.particles=new Map,this.emitters=new Map}createParticles(t,e,a,s,r){this.generateParticles(t,e,a,s,r),this.roomManager.sendMessage(JSON.stringify({type:"add-particles",particleId:a,x:t,y:e,params:s,direction:r}))}generateParticles(t,e,a,s,r){const i=Math.floor(s.COUNT.MIN+Math.random()*(s.COUNT.MAX-s.COUNT.MIN));for(let o=0;o<i;o++){const i=s.LIFETIME.MIN+Math.random()*(s.LIFETIME.MAX-s.LIFETIME.MIN),n=s.SPEED.MIN+Math.random()*(s.SPEED.MAX-s.SPEED.MIN),l=s.SIZE.MIN+Math.random()*(s.SIZE.MAX-s.SIZE.MIN),h=s.OPACITY.MIN+Math.random()*(s.OPACITY.MAX-s.OPACITY.MIN),m=s.TORQUE.MIN+Math.random()*(s.TORQUE.MAX-s.TORQUE.MIN),y=s.NOISE?s.NOISE.STRENGTH.MIN+Math.random()*(s.NOISE.STRENGTH.MAX-s.NOISE.STRENGTH.MIN):0,c=s.NOISE?s.NOISE.SCALE.MIN+Math.random()*(s.NOISE.SCALE.MAX-s.NOISE.SCALE.MIN):0,p=s.SIZE_OVER_LIFETIME?s.SIZE_OVER_LIFETIME.MIN+Math.random()*(s.SIZE_OVER_LIFETIME.MAX-s.SIZE_OVER_LIFETIME.MIN):0;let d;d=r?Math.atan2(r.y,r.x)+(Math.random()-.5)*s.SPREAD:Math.random()*Math.PI*2;const u={age:0,collide:s.COLLIDE,color:s.COLOR,fade:s.FADE,hasCollided:!1,id:`${a}_${o}`,initialSize:l,lifetime:i,maxOpacity:h,noiseScale:c,noiseStrength:y,opacity:h,paint:s.PAINT,pos:{x:t,y:e},size:l,stain:s.STAIN,torque:m,rotation:Math.random()*Math.PI*2,sizeOverLifetime:p,velocity:{x:Math.cos(d)*n,y:Math.sin(d)*n}};this.particles.set(u.id,u)}}updateParticles(t){const e=[];this.particles.forEach((a,s)=>{if(a.noiseStrength>0&&a.noiseScale>0){const e=.001*Date.now(),s=this.utility.simplexNoise2D(a.pos.x/a.noiseScale,e),r=this.utility.simplexNoise2D(a.pos.y/a.noiseScale,e+100);a.velocity.x+=s*a.noiseStrength*t,a.velocity.y+=r*a.noiseStrength*t}if(a.sizeOverLifetime>0){const t=a.age/a.lifetime;a.size=a.initialSize*(1+t*a.sizeOverLifetime)}if(a.pos.x+=a.velocity.x*t,a.pos.y+=a.velocity.y*t,a.age+=16.67*t,a.rotation+=a.torque*Math.PI/180*t,a.fade){const t=a.age/a.lifetime;a.opacity=a.maxOpacity*(1-t)}if(a.hasCollided&&a.stain){this.stampParticle(`stain_${s}_${Date.now()}`,a);const t=(a.age-(a.lifetime-.5*a.lifetime))/(.5*a.lifetime);t>0&&(a.size=Math.max(.5,a.size*(1-.1*t)),a.opacity=a.opacity*(1-t))}if(a.age>=a.lifetime||a.pos.x<-10||a.pos.x>810||a.pos.y<-10||a.pos.y>610){if(a.collide&&a.age>=a.lifetime&&a.pos.x>=0&&a.pos.x<=y&&a.pos.y>=0&&a.pos.y<=c&&!a.hasCollided){a.hasCollided=!0;const t=.875+.1*Math.random();a.velocity.x*=1-t,a.velocity.y*=1-t;const e=.5*a.lifetime;return void(a.lifetime+=e)}a.paint&&!a.stain&&a.age>=a.lifetime&&a.pos.x>=0&&a.pos.x<=y&&a.pos.y>=0&&a.pos.y<=c&&this.stampParticle(`stamp_${s}`,a),e.push(s)}}),e.forEach(t=>this.particles.delete(t))}stampParticle(t,e){if(!this.ui.decalCtx)return;const a=this.utility.hexToRgb(e.color);a&&(this.ui.decalCtx.save(),this.ui.decalCtx.globalCompositeOperation="source-over",0!==e.torque?(this.ui.decalCtx.translate(e.x+e.size/2,e.y+e.size/2),this.ui.decalCtx.rotate(e.rotation),this.ui.decalCtx.fillStyle=`rgba(${a.r}, ${a.g}, ${a.b}, ${e.opacity})`,this.ui.decalCtx.fillRect(-e.size/2,-e.size/2,e.size,e.size)):(this.ui.decalCtx.fillStyle=`rgba(${a.r}, ${a.g}, ${a.b}, ${e.opacity})`,this.ui.decalCtx.fillRect(Math.floor(e.x),Math.floor(e.y),e.size,e.size)),this.ui.decalCtx.restore(),this.decalsManager.decals.set(t,{params:null,pos:{x:e.x,y:e.y}}))}createEmitter(t,e,a,s,r){const i=`particle_emitter_${t}_${Date.now()}`,o=1e3+2e3*Math.random();this.generateEmitter(i,t,e,a,s,r,o),this.roomManager.sendMessage(JSON.stringify({type:"particle-emitter",emitterId:i,playerId:t,hitX:e,hitY:a,centerX:s,centerY:r,lifetime:o})),console.log(`Emitter created on ${t} for ${o}ms`)}generateEmitter(t,e,a,s,r,i,o){const n=a-r,l=s-i,h=Math.atan2(l,n);this.emitters.set(t,{age:0,direction:h,emissionInterval:200+300*Math.random(),lastEmission:0,lifetime:o,offset:{x:n,y:l},playerId:e})}updateEmitters(t){const e=[];this.emitters.forEach((a,i)=>{a.age+=16.67*t;const o=a.playerId===this.userId?this.playerState.myPlayer:this.playerState.players.get(a.playerId);if(!o||o.stats.health.value<=0)return void e.push(i);const n=o.transform.pos.x+a.offset.x,l=o.transform.pos.y+a.offset.y;if(a.age>=a.lastEmission+a.emissionInterval){const t=.6*Math.PI,e=(Math.random()-.5)*t,s=a.direction+e,o=3,h=4*(Math.random()-.5),m=Math.max(.5,o+h);this.generateParticles(n+8*(Math.random()-.5),l+8*(Math.random()-.5),`emitter_particles_${i}_${a.age}`,r,{x:Math.cos(s)*m,y:Math.sin(s)*m}),a.lastEmission=a.age,a.emissionInterval=120+180*Math.random()}a.age>=a.lifetime&&(this.decalsManager.generateDecal(n,l,`emitter_decal_${i}`,s),e.push(i))}),e.forEach(t=>this.emitters.delete(t))}generateGore(t,e,a,s){const r=2+Math.floor(4*Math.random()),i=[...v.GORE];for(let o=0;o<r&&i.length>0;o++){const r=Math.floor(Math.random()*i.length),n=i.splice(r,1)[0],l=Math.random()*Math.PI*2,h=Math.random()*s,m={type:"gore",assetPath:n,x:e+Math.cos(l)*h,y:a+Math.sin(l)*h,rotation:Math.random()*Math.PI*2,scale:.65+.4*Math.random()},y=`death_gore_${t}_${Date.now()}_${o}`;this.stampGore(m),this.decalsManager.decals.set(y,{params:null,pos:{x:m.x,y:m.y}})}const o=1+Math.floor(2*Math.random()),n=[...v.BLOOD];for(let r=0;r<o&&n.length>0;r++){const i=Math.floor(Math.random()*n.length),o=n.splice(i,1)[0],l=Math.random()*Math.PI*2,h=Math.random()*(.7*s),m={type:"blood",assetPath:o,x:e+Math.cos(l)*h,y:a+Math.sin(l)*h,rotation:Math.random()*Math.PI*2,scale:1.25+.2*Math.random()},y=`death_blood_${t}_${Date.now()}_${r}`;this.stampGore(m),this.decalsManager.decals.set(y,{params:null,pos:{x:m.x,y:m.y}})}}stampGore(t){if(!this.ui.decalCtx)return;let e=this.renderdingManager.characterImages.get(t.assetPath);if(!e&&(e=new Image,e.src=t.assetPath,this.renderdingManager.characterImages.set(t.assetPath,e),!e.complete))return void(e.onload=()=>{this.stampGore(t)});if(!e.complete||0===e.naturalWidth)return;this.ui.decalCtx.save(),this.ui.decalCtx.translate(t.x,t.y),this.ui.decalCtx.rotate(t.rotation);const a=32*t.scale;this.ui.decalCtx.drawImage(e,-a/2,-a/2,a,a),this.ui.decalCtx.restore()}}class _{constructor(t,e){this.utility=e,this.players=new Map,this.isHost=!1,this.canShoot=!0,this.isBurstActive=!1,this.isReloading=!1,this.isMelee=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.lastSentX=0,this.lastSentY=0,this.lastSentRotation=0,this.lastSentRotationTime=0,this.lastSentMoveTime=0,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastShotTime=0,this.lastMeleeTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0,this.myPlayer=this.initPlayer(t)}initPlayer(e){return this.myPlayer={id:e,transform:{pos:{x:770*Math.random()+p,y:570*Math.random()+p},rot:0},timestamp:Date.now(),color:this.utility.getRandomColor(),actions:{dash:{cooldown:t.ACTIONS.DASH.COOLDOWN,drain:t.ACTIONS.DASH.DRAIN,multiplier:t.ACTIONS.DASH.MULTIPLIER,time:t.ACTIONS.DASH.TIME},melee:{cooldown:t.ACTIONS.MELEE.COOLDOWN,damage:t.ACTIONS.MELEE.DAMAGE,duration:t.ACTIONS.MELEE.DURATION,range:t.ACTIONS.MELEE.RANGE,size:t.ACTIONS.MELEE.SIZE},primary:{buffer:t.ACTIONS.PRIMARY.BUFFER,burst:{amount:t.ACTIONS.PRIMARY.BURST.AMOUNT,delay:t.ACTIONS.PRIMARY.BURST.DELAY},magazine:{currentAmmo:t.ACTIONS.PRIMARY.MAGAZINE.SIZE,currentReserve:t.ACTIONS.PRIMARY.MAGAZINE.STARTING_RESERVE,maxReserve:t.ACTIONS.PRIMARY.MAGAZINE.MAX_RESERVE,size:t.ACTIONS.PRIMARY.MAGAZINE.SIZE},offset:t.ACTIONS.PRIMARY.OFFSET,projectile:{amount:t.ACTIONS.PRIMARY.PROJECTILE.AMOUNT,color:t.ACTIONS.PRIMARY.PROJECTILE.COLOR,damage:t.ACTIONS.PRIMARY.PROJECTILE.DAMAGE,length:t.ACTIONS.PRIMARY.PROJECTILE.LENGTH,range:t.ACTIONS.PRIMARY.PROJECTILE.RANGE,size:t.ACTIONS.PRIMARY.PROJECTILE.SIZE,speed:t.ACTIONS.PRIMARY.PROJECTILE.SPEED,spread:t.ACTIONS.PRIMARY.PROJECTILE.SPREAD},reload:{time:t.ACTIONS.PRIMARY.RELOAD.TIME}},sprint:{drain:t.ACTIONS.SPRINT.DRAIN,multiplier:t.ACTIONS.SPRINT.MULTIPLIER}},equipment:t.EQUIPMENT,physics:{acceleration:t.PHYSICS.ACCELERATION,friction:t.PHYSICS.FRICTION},rig:{body:t.RIG.BODY,head:t.RIG.HEAD,headwear:t.RIG.HEADWEAR,weapon:t.RIG.WEAPON},stats:{health:{max:t.STATS.HEALTH.MAX,value:t.STATS.HEALTH.MAX},luck:t.STATS.LUCK,size:t.STATS.SIZE,speed:t.STATS.SPEED,stamina:{max:t.STATS.STAMINA.MAX,recovery:{delay:t.STATS.STAMINA.RECOVERY.DELAY,rate:t.STATS.STAMINA.RECOVERY.RATE},value:t.STATS.STAMINA.MAX}},unique:t.UNIQUE}}resetPlayerState(){this.canShoot=!0,this.isBurstActive=!1,this.isReloading=!1,this.isMelee=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastMeleeTime=0,this.lastShotTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0}}class U{constructor(t,e,a,s,r,i,o,n){this.gameState=t,this.lobbyManager=e,this.playerState=a,this.roomManager=s,this.ui=r,this.upgradeManager=i,this.userId=o,this.wsManager=n}showRoomControls(){this.ui.updateDisplay(this.lobbyManager,"room")}hostRoom(){if(this.wsManager.getWebSocket()){const t=this.roomManager.createRoom();this.playerState.isHost=!0,this.lobbyManager.showLobbyControls(this.gameState.gameMaxPlayers,this.gameState.gameMaxWins,this.playerState.isHost,this.roomManager.isPrivateRoom,this.upgradeManager.isUpgradesEnabled,this.lobbyManager,this.playerState.myPlayer,t,this.userId)}else this.wsManager.connectWebSocket(),setTimeout(()=>{const t=this.roomManager.createRoom();this.playerState.isHost=!0,this.lobbyManager.showLobbyControls(this.gameState.gameMaxPlayers,this.gameState.gameMaxWins,this.playerState.isHost,this.roomManager.isPrivateRoom,this.upgradeManager.isUpgradesEnabled,this.lobbyManager,this.playerState.myPlayer,t,this.userId)},d)}joinRoom(){this.ui.showJoinRoomModal(t=>{this.joinRoomById(t)})}joinRoomById(t){t&&(this.wsManager.getWebSocket()?this.roomManager.joinRoom(t):(this.wsManager.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(t)},d)))}quickPlay(){fetch("/quickplay").then(t=>{if(!t.ok)throw new Error("No available rooms");return t.json()}).then(t=>{this.wsManager.getWebSocket()?this.roomManager.joinRoom(t.roomId):(this.wsManager.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(t.roomId)},d))}).catch(t=>{this.ui.modal&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalContent&&this.ui.modalText&&this.ui.modalInput&&this.ui.modalErrorDiv&&this.ui.modalButtons&&(this.ui.modal.classList.remove("hidden"),this.ui.modalInput.style.display="none",this.ui.modalErrorDiv.textContent=" ",this.ui.modalButtons.style.display="flex",this.ui.modalCancelButton.style.display="none",this.ui.modalText.textContent="No available games found.",this.ui.modalConfirmButton.textContent="Confirm",this.ui.modalConfirmButton.onclick=()=>{this.ui.modal&&this.ui.modalInput&&this.ui.modalCancelButton&&this.ui.modalText&&this.ui.modalConfirmButton&&(this.ui.modal.classList.add("hidden"),this.ui.modalInput.style.display="flex",this.ui.modalText.textContent="Join Room",this.ui.modalCancelButton.style.display="flex",this.ui.modalConfirmButton.onclick=null)})})}leaveRoom(){this.roomManager.leaveRoom(),window.dispatchEvent(new CustomEvent("customEvent_resetGameState",{detail:{resetType:"Room"}})),this.showRoomControls()}checkForRoomInURL(){const t=this.getRoomIdFromURL();t&&(this.wsManager.connectWebSocket(),setTimeout(()=>{this.roomManager.joinRoom(t)},d))}getRoomIdFromURL(){return new URLSearchParams(window.location.search).get("room")}copyRoomCode(){const t=this.lobbyManager.inLobby?this.ui.roomIdDisplay?.textContent:this.ui.gameRoomIdDisplay?.textContent;t&&navigator.clipboard.writeText(t).then(()=>{if(!(this.ui.modal&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalContent&&this.ui.modalText&&this.ui.modalInput&&this.ui.modalErrorDiv&&this.ui.modalButtons))return;this.ui.modal.classList.remove("hidden"),this.ui.modalInput.style.display="none",this.ui.modalErrorDiv.textContent=" ",this.ui.modalButtons.style.display="flex",this.ui.modalCancelButton.style.display="none",this.ui.modalText.textContent="Room code copied!",this.ui.modalConfirmButton.textContent="Confirm";const t=()=>{this.ui.modal&&this.ui.modalInput&&this.ui.modalCancelButton&&this.ui.modalText&&this.ui.modalConfirmButton&&(this.ui.modal.classList.add("hidden"),this.ui.modalInput.style.display="flex",this.ui.modalText.textContent="Join Room",this.ui.modalCancelButton.style.display="flex",this.ui.modalConfirmButton.onclick=null)};this.ui.modalConfirmButton.onclick=t,setTimeout(()=>{this.ui.modal&&!this.ui.modal.classList.contains("hidden")&&t()},3e3)}).catch(()=>{alert("Could not copy. Please copy manually.")})}}class j{constructor(t,e){this.userId=t,this.utility=e,this.currentRoom=null,this.ws=null,this.messageHandlers=[],this.isPrivateRoom=!1}setWebSocket(t){this.ws=t,this.setupMessageHandler()}createRoom(){const t=this.utility.generateUID(10,"room_");return this.joinRoom(t,!0),t}joinRoom(t,e=!1){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void console.error("WebSocket not connected");const a={type:e?"create-room":"join-room",roomId:t,userId:this.userId};this.ws.send(JSON.stringify(a)),this.currentRoom=t,this.utility.generateLink(t,"room")}leaveRoom(){if(!this.currentRoom||!this.ws)return;const t={type:"leave-room",roomId:this.currentRoom,userId:this.userId};this.ws.send(JSON.stringify(t)),this.currentRoom=null,window.history.pushState({},"",window.location.origin)}sendMessage(t){if(!this.currentRoom||!this.ws)return;const e={type:"room-message",roomId:this.currentRoom,userId:this.userId,message:t};this.ws.send(JSON.stringify(e))}getCurrentRoom(){return this.currentRoom}getRoomLink(t){return this.currentRoom?this.utility.generateLink(this.currentRoom,t):null}onMessage(t){this.messageHandlers.push(t)}setupMessageHandler(){this.ws&&(this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);this.messageHandlers.forEach(t=>t(e))}catch(e){const a={type:"room-message",userId:"server",message:t.data};this.messageHandlers.forEach(t=>t(a))}})}}class z{constructor(){this.gameSettings=this.initSettings()}initSettings(){return{audio:{mixer:{master:S,sfx:M}},controls:{keybinds:{dash:u.DASH,melee:u.MELEE,moveDown:u.MOVE_DOWN,moveLeft:u.MOVE_LEFT,moveRight:u.MOVE_RIGHT,moveUp:u.MOVE_UP,reload:u.RELOAD,sprint:u.SPRINT}}}}getSettings(){return this.gameSettings}}var $,H;!function(t){t[t.COMMON=0]="COMMON",t[t.UNCOMMON=1]="UNCOMMON",t[t.RARE=2]="RARE",t[t.EPIC=3]="EPIC",t[t.LEGENDARY=4]="LEGENDARY"}($||($={})),function(t){t.STAT="stat",t.UNIQUE="unique",t.EQUIPMENT="equipment"}(H||(H={}));class Y{constructor(){this.takenUniques=new Set,this.upgradesCompleted=new Set,this.isUpgradesEnabled=!0,this.rarityConfig={[$.COMMON]:{weight:70,color:"#ffffff"},[$.UNCOMMON]:{weight:20,color:"#1eff00"},[$.RARE]:{weight:7,color:"#0099ff"},[$.EPIC]:{weight:2,color:"#9d00ff"},[$.LEGENDARY]:{weight:1,color:"#ff9500"}},this.upgrades=[{id:"damage_buffer",name:"Damage Buffer",subtitle:"Type D125 buffer, which improves the damage at a small cost. ",icon:"/assets/img/icon/upgrades/damageup.png",type:H.STAT,rarity:$.COMMON,unique:!1,func:t=>{t.actions.primary.projectile.damage*=1.25,t.actions.primary.buffer*=1.1,console.log(`Damage Buffer installed. New damage: ${t.actions.primary.projectile.damage} - New Buffer: ${t.actions.primary.buffer}`)}},{id:"locomotion_module",name:"Locomotion Module",subtitle:"Primitave locomotion module installed on the user's footwear.",icon:"/assets/img/icon/upgrades/speedup.png",type:H.STAT,rarity:$.COMMON,unique:!1,func:t=>{t.stats.speed+=1,t.actions.dash.cooldown*=1.5,console.log(`Locomotion Module installed. New Speed: ${t.stats.speed} - New Dash Cooldown: ${t.actions.dash.cooldown}`)}},{id:"projectile_array",name:"Projectile Array",subtitle:"Chance to fire an array of extra projectiles.",icon:"/assets/img/icon/upgrades/projectilearray.png",type:H.UNIQUE,rarity:$.UNCOMMON,unique:!0,func:t=>{t.unique.includes("projectile_array")||t.unique.push("projectile_array")}}]}getUpgrades(t,e){const a=this.upgrades.filter(t=>!(t.unique&&this.takenUniques.has(t.id)||t.type===H.EQUIPMENT&&e.equipment.includes(t.id))),s=[];for(let e=0;e<Math.min(t,a.length)&&0!==a.length;e++){const t=a.reduce((t,e)=>t+this.getRarityWeight(e.rarity),0);let e=Math.random()*t,r=null;for(const t of a)if(e-=this.getRarityWeight(t.rarity),e<=0){r=t;break}if(r){s.push(r);const t=a.indexOf(r);a.splice(t,1)}}return s}applyUpgrade(t,e){const a=this.upgrades.find(e=>e.id===t);return!(!a||(a.unique&&this.takenUniques.has(t)?(console.warn(`Unique upgrade ${t} already taken globally`),1):a.type===H.EQUIPMENT&&this.hasEquipment(e,t)?(console.warn(`Equipment ${t} already owned by player`),1):(a.unique&&this.takenUniques.add(t),a.func(e),0)))}removeUpgradeFromPool(t){this.takenUniques.add(t)}resetUpgrades(t){this.takenUniques.clear(),t.equipment=[]}hasEquipment(t,e){return t.equipment.includes(e)}hasUnique(t,e){return t.unique.includes(e)}getRarityColor(t){return this.rarityConfig[t].color}getRarityWeight(t){return this.rarityConfig[t].weight}}class G{constructor(){this.canvas=null,this.ctx=null,this.decalCanvas=null,this.decalCtx=null,this.ammoReservesCanvas=null,this.ammoReservesCtx=null,this.roomControls=null,this.gameContainer=null,this.userIdDisplay=null,this.roomIdDisplay=null,this.gameRoomIdDisplay=null,this.lobbyContainer=null,this.lobbyPlayersList=null,this.startGameBtn=null,this.gameOptionsContainer=null,this.chatContainer=null,this.chatMessages=null,this.chatInput=null,this.chatSendBtn=null,this.privateToggle=null,this.upgradesToggle=null,this.winsInput=null,this.playersInput=null,this.upgradeContainer=null,this.modal=null,this.modalInput=null,this.modalButtons=null,this.modalConfirmButton=null,this.modalCancelButton=null,this.modalErrorDiv=null,this.modalContent=null,this.modalText=null,this.hostButton=null,this.joinButton=null,this.quickplayButton=null,this.lobbyLeaveButton=null,this.lobbyCodeButton=null,this.gameLeaveButton=null,this.gameCodeButton=null,this.leaderboardContainer=null,this.leaderboardBody=null,this.leaderboard=new Map}initInterface(){if(this.canvas=document.getElementById("gameCanvas"),this.decalCanvas=document.createElement("canvas"),this.ammoReservesCanvas=document.getElementById("ammoReservesCanvas"),this.roomControls=document.getElementById("roomControls"),this.gameContainer=document.getElementById("gameContainer"),this.lobbyContainer=document.getElementById("lobbyContainer"),this.lobbyPlayersList=document.getElementById("lobbyPlayersList"),this.startGameBtn=document.getElementById("startGameBtn"),this.gameOptionsContainer=document.getElementById("gameOptionsContainer"),this.userIdDisplay=document.getElementById("userId"),this.roomIdDisplay=document.getElementById("roomId"),this.gameRoomIdDisplay=document.getElementById("gameRoomId"),this.chatContainer=document.getElementById("chatContainer"),this.chatMessages=document.getElementById("chatMessages"),this.chatInput=document.getElementById("chatInput"),this.chatSendBtn=document.getElementById("chatSendBtn"),this.privateToggle=document.getElementById("privateToggle"),this.upgradesToggle=document.getElementById("upgradesToggle"),this.winsInput=document.getElementById("winsInput"),this.playersInput=document.getElementById("playersInput"),this.upgradeContainer=document.getElementById("upgradeContainer"),this.leaderboardContainer=document.getElementById("leaderboardContainer"),this.leaderboardBody=document.getElementById("leaderboardBody"),this.hostButton=document.getElementById("atomHost"),this.joinButton=document.getElementById("atomJoin"),this.quickplayButton=document.getElementById("atomQuickplay"),this.lobbyLeaveButton=document.getElementById("lobbyLeaveBtn"),this.lobbyCodeButton=document.getElementById("lobbyCodeBtn"),this.gameLeaveButton=document.getElementById("gameLeaveBtn"),this.gameCodeButton=document.getElementById("gameCodeBtn"),this.modal=document.getElementById("modal"),this.modalInput=document.getElementById("joinRoomInput"),this.modalButtons=document.getElementById("modalButtons"),this.modalConfirmButton=document.getElementById("joinRoomConfirmBtn"),this.modalCancelButton=document.getElementById("joinRoomCancelBtn"),this.modalErrorDiv=document.getElementById("joinRoomError"),this.modalContent=document.getElementById("modalContent"),this.modalText=document.getElementById("modalText"),!(this.canvas&&this.decalCanvas&&this.ammoReservesCanvas&&this.roomControls&&this.gameContainer&&this.lobbyContainer&&this.userIdDisplay&&this.roomIdDisplay&&this.gameRoomIdDisplay&&this.lobbyPlayersList&&this.startGameBtn&&this.gameOptionsContainer&&this.chatContainer&&this.chatMessages&&this.chatInput&&this.chatSendBtn&&this.privateToggle&&this.upgradesToggle&&this.winsInput&&this.playersInput&&this.upgradeContainer&&this.leaderboardContainer&&this.leaderboardBody&&this.hostButton&&this.joinButton&&this.quickplayButton&&this.lobbyLeaveButton&&this.lobbyCodeButton&&this.gameLeaveButton&&this.gameCodeButton))throw alert("Failed to load game. Please refresh the page."),new Error("Critical error: Required DOM elements are missing.");if(this.canvas.width=y,this.canvas.height=c,this.decalCanvas.width=y,this.decalCanvas.height=c,this.ammoReservesCanvas.width=100,this.ammoReservesCanvas.height=64,this.ctx=this.canvas.getContext("2d"),this.decalCtx=this.decalCanvas.getContext("2d"),this.ammoReservesCtx=this.ammoReservesCanvas.getContext("2d"),!this.ctx||!this.decalCtx||!this.ammoReservesCtx)throw alert("Failed to load game. Please refresh the page."),new Error("Could not get canvas context")}updateDisplay(t,e,a){if(this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer)switch(this.clearDisplay(),e){case"lobby":this.lobbyContainer.style.display="flex",this.chatContainer.style.display="flex",a&&this.roomIdDisplay&&(this.roomIdDisplay.textContent=a),t.inLobby=!0;break;case"room":this.roomControls.style.display="flex";break;case"game":if(this.gameContainer.style.display="flex",this.chatContainer.style.display="flex",this.leaderboardContainer.style.display="flex",a){const t=this.gameRoomIdDisplay;t&&(t.textContent=a)}t.inLobby=!1}}updateHostDisplay(t,e){this.startGameBtn&&this.gameOptionsContainer&&(this.startGameBtn.style.display=t?"block":"none",this.startGameBtn.disabled=e.lobbyPlayers.size<1,this.gameOptionsContainer.style.display=t?"flex":"none")}displayLobbyPlayers(t,e,a){this.lobbyPlayersList&&(this.lobbyPlayersList.innerHTML="",Array.from(e.lobbyPlayers.values()).sort((t,e)=>t.isHost&&!e.isHost?-1:!t.isHost&&e.isHost?1:0).forEach(s=>{const r=document.createElement("div");r.className="lobby_player";const i=document.createElement("div");i.className="player_color",i.style.backgroundColor=s.color;const o=document.createElement("div");o.className="player_name",o.textContent=`${s.id}${s.isHost?" (Host)":""}`;const n=document.createElement("div");if(n.className="player_controls",t&&s.id!==a){const t=document.createElement("button");t.textContent="Promote",t.onclick=()=>e.promotePlayer(s.id);const a=document.createElement("button");a.textContent="Kick",a.className="danger",a.onclick=()=>e.kickPlayer(s.id),n.appendChild(t),n.appendChild(a)}r.appendChild(i),r.appendChild(o),r.appendChild(n),this.lobbyPlayersList&&this.lobbyPlayersList.appendChild(r)}))}clearDisplay(){this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer&&this.upgradeContainer&&(this.roomControls.style.display="none",this.lobbyContainer.style.display="none",this.gameContainer.style.display="none",this.chatContainer.style.display="none",this.leaderboardContainer.style.display="none",this.upgradeContainer.style.display="none")}showJoinRoomModal(t){if(!(this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalErrorDiv))return;this.modal.classList.remove("hidden"),this.modalInput.value="",this.modalErrorDiv.textContent="",this.modalInput.focus();const e=()=>{this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalErrorDiv&&(this.modal.classList.add("hidden"),this.modalConfirmButton.onclick=null,this.modalCancelButton.onclick=null,this.modalInput.onkeydown=null)};this.modalConfirmButton.onclick=()=>{if(!this.modalInput||!this.modalErrorDiv)return;const a=this.modalInput.value.trim();if(!a)return void(this.modalErrorDiv.textContent="Invalid code...");let s=null;try{const t=new URL(a,window.location.origin);s=t.pathname.startsWith("/room_")?t.pathname.replace("/",""):new URLSearchParams(t.search).get("room")}catch{a.startsWith("room_")&&(s=a)}s?(e(),t(s)):this.modalErrorDiv.textContent="Invalid code..."},this.modalCancelButton.onclick=e}soloGameWarning(t){if(!(this.modal&&this.modalConfirmButton&&this.modalCancelButton&&this.modalContent&&this.modalText&&this.modalInput&&this.modalErrorDiv&&this.modalButtons))return;this.modal.classList.remove("hidden"),this.modalInput.style.display="none",this.modalErrorDiv.textContent=" ",this.modalButtons.style.display="flex",this.modalCancelButton.style.display="flex",this.modalText.textContent="Start game as only player? Other players will be unable to join until you return to the lobby.",this.modalConfirmButton.textContent="Start Game",this.modalCancelButton.textContent="Cancel";const e=()=>{this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalText&&(this.modal.classList.add("hidden"),this.modalInput.style.display="flex",this.modalText.textContent="Join Room",this.modalConfirmButton.onclick=null,this.modalCancelButton.onclick=null)};this.modalConfirmButton.onclick=()=>{e(),t()},this.modalCancelButton.onclick=e}createLeaderboard(t,e,a){const s=new Set;s.add(a),e.forEach((t,e)=>{s.add(e)}),t.lobbyPlayers.forEach((t,e)=>{s.add(e)}),s.forEach(t=>{this.leaderboard.has(t)||(this.leaderboard.set(t,{playerId:t,wins:0,kills:0,deaths:0}),console.log(`Created leaderboard entry for ${t}`))}),this.updateLeaderboardDisplay(a),console.log("Leaderboard created/updated:",Array.from(this.leaderboard.entries()))}updateLeaderboardDisplay(t){this.leaderboardBody&&(this.leaderboardBody.innerHTML="",Array.from(this.leaderboard.entries()).sort((t,e)=>{const[,a]=t,[,s]=e;return s.wins!==a.wins?s.wins-a.wins:s.kills-a.kills}).forEach(([e,a])=>{const s=document.createElement("tr");s.className="leaderboard_row",e===t&&s.classList.add("current-player");const r=document.createElement("td");r.textContent=e===t?"You":e.substring(0,8),r.className="player_name",s.appendChild(r);const i=document.createElement("td");i.textContent=a.wins.toString(),i.className="wins",s.appendChild(i);const o=document.createElement("td");o.textContent=a.kills.toString(),o.className="kills",s.appendChild(o);const n=document.createElement("td");n.textContent=a.deaths.toString(),n.className="deaths",s.appendChild(n),this.leaderboardBody&&this.leaderboardBody.appendChild(s)}))}clearLeaderboard(){this.leaderboard.clear(),this.leaderboardBody&&(this.leaderboardBody.innerHTML="")}}class X{constructor(){this.lastFrameTime=performance.now(),this.simplexTable=this.generateSimplexTable()}deltaTime(){const t=performance.now(),e=t-this.lastFrameTime;return this.lastFrameTime=t,Math.min(e,100)/16.67}getRandomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}getRandomInArray(t){return t[Math.floor(Math.random()*t.length)]}getShuffledArray(t){return t.slice().sort(()=>Math.random()-.5)}forward(t){return{x:Math.cos(t),y:Math.sin(t)}}getDirection(t){const e=t.targetPos.x-t.rootPos.x,a=t.targetPos.y-t.rootPos.y,s=Math.sqrt(e*e+a*a);return 0===s?{x:0,y:0}:{x:e/s,y:a/s}}getRandomDirection(t){const e=Math.random()*(t*Math.PI/180);return{x:Math.cos(e),y:Math.sin(e)}}getRandomColor(t){const e=t?.format??"hex";let a;switch(t?.mode??"any"){case"primary":const t=["#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF"];a=t[Math.floor(Math.random()*t.length)];break;case"pastel":const e=Math.floor(128*Math.random()+127),s=Math.floor(128*Math.random()+127),r=Math.floor(128*Math.random()+127);a=`#${e.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${r.toString(16).padStart(2,"0")}`;break;case"vibrant":const i=[255,Math.floor(256*Math.random()),Math.floor(256*Math.random())];i.sort(()=>Math.random()-.5),a=`#${i[0].toString(16).padStart(2,"0")}${i[1].toString(16).padStart(2,"0")}${i[2].toString(16).padStart(2,"0")}`;break;case"dark":const o=Math.floor(128*Math.random()),n=Math.floor(128*Math.random()),l=Math.floor(128*Math.random());a=`#${o.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`;break;case"light":const h=Math.floor(128*Math.random()+128),m=Math.floor(128*Math.random()+128),y=Math.floor(128*Math.random()+128);a=`#${h.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}${y.toString(16).padStart(2,"0")}`;break;case"grayscale":const c=Math.floor(256*Math.random());a=`#${c.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`;break;default:a="#"+Math.floor(16777215*Math.random()).toString(16).padStart(6,"0")}if("rgb"===e){const t=this.hexToRgb(a);return t?`rgb(${t.r}, ${t.g}, ${t.b})`:a}return a}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}generateSimplexTable(){const t=new Uint8Array(512);for(let e=0;e<256;e++)t[e]=e;for(let e=0;e<256;e++){const a=e+Math.floor(Math.random()*(256-e));[t[e],t[a]]=[t[a],t[e]]}for(let e=0;e<256;e++)t[256+e]=t[e];return t}simplexNoise2D(t,e,a=!1){a&&(this.simplexTable=this.generateSimplexTable());const s=this.simplexTable,r=.5*(Math.sqrt(3)-1),i=(3-Math.sqrt(3))/6,o=(t+e)*r,n=Math.floor(t+o),l=Math.floor(e+o),h=(n+l)*i,m=t-(n-h),y=e-(l-h),c=m>y?1:0,p=m>y?0:1,d=m-c+i,u=y-p+i,g=m-1+2*i,S=y-1+2*i,M=255&n,I=255&l,f=s[M+s[I]]%12,P=s[M+c+s[I+p]]%12,E=s[M+1+s[I+1]]%12,C=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],A=(t,e,a)=>t[0]*e+t[1]*a;let x=.5-m*m-y*y,b=.5-d*d-u*u,v=.5-g*g-S*S;return 70*((x<0?0:Math.pow(x,4)*A(C[f],m,y))+(b<0?0:Math.pow(b,4)*A(C[P],d,u))+(v<0?0:Math.pow(v,4)*A(C[E],g,S)))}generateUID(t,e){let a=e??"";for(let e=0;e<t;e++)a+="0123456789abcdefghijklmnopqrstuvwxyz"[Math.floor(36*Math.random())];return a}generateLink(t,e){const a=window.location.origin;return e?`${a}?${e}=${t}`:`${a}?${t}`}setInput(t){const e=document.getElementById(t.inputId);e&&(e.value=t.value.toString())}setSlider(t){const{sliderId:e,targetValue:a,maxValue:s,lerpTime:r=0}=t,i=document.getElementById(e),o=i?.querySelector("div");if(!i||!o)return void console.warn(`Slider not found: ${e}...`);if(0===s)return void console.warn("maxValue cannot be 0...");const n=Math.max(0,Math.min(s,a))/s*100,l=o.style.width||"100%",h=parseFloat(l.replace("%",""));if(!(Math.abs(h-n)<.1)){if(r<=0)return o.style.transition="none",void(o.style.width=`${n}%`);o.style.transition=`width ${r}ms ease-out`,o.style.width=`${n}%`,setTimeout(()=>{o&&(o.style.transition="")},r)}}setSpan(t){const e=document.getElementById(t.spanId);e?e.textContent=t.value.toString():console.warn(`Span not found: ${t.spanId}`)}setToggle(t){const e=document.getElementById(t.toggleId);e&&(t.value?(e.setAttribute("checked","true"),e.setAttribute("aria-checked","true")):(e.removeAttribute("checked"),e.setAttribute("aria-checked","false")))}}class F{constructor(){this.isPaused=!1,this.gameInProgress=!1,this.gameMaxWins=5,this.gameMaxPlayers=4}}class q{constructor(t,e){this.roomManager=t,this.ui=e}sendChatMessage(t){if(!this.ui.chatInput||!this.ui.chatInput.value.trim())return;const e=this.ui.chatInput.value.trim();e.length>200?alert("Message too long! Max 200 characters."):(this.roomManager.sendMessage(JSON.stringify({type:"chat-message",message:e,timestamp:Date.now()})),this.displayChatMessage(t,e,!0),this.ui.chatInput.value="")}displayChatMessage(t,e,a=!1){if(!this.ui.chatMessages)return;const s=document.createElement("div");s.className="chat_message "+(a?"own":"other");const r=document.createElement("span");r.className="sender",r.textContent=a?"You:":`${t}:`;const i=document.createElement("span");for(i.className="content",i.textContent=e,s.appendChild(r),s.appendChild(i),this.ui.chatMessages.appendChild(s),this.ui.chatMessages.scrollTop=this.ui.chatMessages.scrollHeight;this.ui.chatMessages.children.length>100;)this.ui.chatMessages.removeChild(this.ui.chatMessages.firstChild)}clearChat(){this.ui.chatMessages&&(this.ui.chatMessages.innerHTML=""),this.ui.chatInput&&(this.ui.chatInput.value="")}}class W{constructor(t,e){this.gameState=t,this.roomManager=e,this.ws=null}connectWebSocket(){const t="https:"===location.protocol?"wss:":"ws:";this.ws=new WebSocket(`${t}//${location.host}`),this.ws.onopen=()=>{console.log("Connected to WebSocket"),this.roomManager.setWebSocket(this.ws)},this.ws.onclose=()=>{console.log("Disconnected from WebSocket"),this.gameState.gameInProgress=!1,setTimeout(()=>this.connectWebSocket(),3e3)},this.ws.onerror=t=>{console.error("WebSocket error:",t)}}getWebSocket(){return this.ws}}class V{constructor(t,e,a,s){this.moveController=t,this.playerState=e,this.roomManager=a,this.staminaController=s}startDash(){if(this.playerState.isDashing||this.playerState.myPlayer.stats.health.value<=0||!this.moveController.isMoving())return;const t=Date.now();if(t<this.playerState.lastDashTime+this.playerState.myPlayer.actions.dash.cooldown)return void console.log("Dash on cooldown");let{inputX:e,inputY:a,inputLength:s}=this.moveController.getMoveInput();if(!this.moveController.isMoving())return void console.log("No movement input for dash");if(e/=s,a/=s,!this.staminaController.requestStamina(this.playerState.myPlayer.actions.dash.drain))return void console.log("Not enough stamina to dash");this.playerState.isDashing=!0,this.playerState.dashStartTime=t,this.playerState.lastDashTime=t;const r=this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.dash.multiplier;this.playerState.playerVelocityX=e*r,this.playerState.playerVelocityY=a*r,console.log(`Dashing! Speed: ${r}`)}updateDash(t){if(!this.playerState.isDashing)return;const e=Date.now();let a=this.playerState.myPlayer.transform.pos.x+this.playerState.playerVelocityX*t,s=this.playerState.myPlayer.transform.pos.y+this.playerState.playerVelocityY*t;this.playerState.myPlayer.transform.pos.x=a,this.playerState.myPlayer.transform.pos.y=s;let r=0!==this.playerState.playerVelocityX||0!==this.playerState.playerVelocityY;const i=Math.sqrt((this.playerState.myPlayer.transform.pos.x-this.playerState.lastSentX)**2+(this.playerState.myPlayer.transform.pos.y-this.playerState.lastSentY)**2);r&&i>2&&e-this.playerState.lastSentMoveTime>=10&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}}})),this.playerState.lastSentX=this.playerState.myPlayer.transform.pos.x,this.playerState.lastSentY=this.playerState.myPlayer.transform.pos.y,this.playerState.lastSentMoveTime=e),e>=this.playerState.dashStartTime+this.playerState.myPlayer.actions.dash.time&&(this.playerState.isDashing=!1,console.log("Dash ended"))}}class J{constructor(t,e){this.controlsManager=t,this.settingsManager=e}getMoveInput(){let t=0,e=0;this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveUp)&&(e-=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveDown)&&(e+=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveLeft)&&(t-=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveRight)&&(t+=1);const a=Math.sqrt(t*t+e*e);return a>0&&(t/=a,e/=a),{inputX:t,inputY:e,inputLength:a}}isMoving(){return this.getMoveInput().inputLength>0}}class Z{constructor(t){this.playerState=t}requestStamina(t){return this.playerState.myPlayer.stats.stamina.value<t?(console.log(`Insufficient stamina! Need: ${t}, Have: ${this.playerState.myPlayer.stats.stamina}`),!1):(this.playerState.myPlayer.stats.stamina.value-=t,this.playerState.isStaminaRecoveryBlocked=!0,this.playerState.staminaRecoveryBlockedUntil=Date.now()+this.playerState.myPlayer.stats.stamina.recovery.delay,console.log(`Stamina drained: -${t}, Remaining: ${this.playerState.myPlayer.stats.stamina}`),!0)}updateStamina(t){const e=Date.now();if(this.playerState.isSprinting&&e>=this.playerState.lastStaminaDrainTime+100&&(this.requestStamina(this.playerState.myPlayer.actions.sprint.drain)||(this.playerState.isSprinting=!1,console.log("Out of stamina, stopped sprinting")),this.playerState.lastStaminaDrainTime=e),(!this.playerState.isStaminaRecoveryBlocked||e>=this.playerState.staminaRecoveryBlockedUntil)&&(this.playerState.isStaminaRecoveryBlocked=!1,this.playerState.myPlayer.stats.stamina.value<this.playerState.myPlayer.stats.stamina.max&&!this.playerState.isSprinting)){const e=this.playerState.myPlayer.stats.stamina.recovery.rate/1e3*16.67*t;this.playerState.myPlayer.stats.stamina.value=Math.min(this.playerState.myPlayer.stats.stamina.max,this.playerState.myPlayer.stats.stamina.value+e)}}}class K{constructor(t,e,a,s,r,i,o,n,l,h,m,y,c,p){this.ammoReservesUIController=t,this.animator=e,this.audioManager=a,this.collisionsManager=s,this.controlsManager=r,this.decalsManager=i,this.gameState=o,this.luckController=n,this.particlesManager=l,this.playerState=h,this.roomManager=m,this.ui=y,this.userId=c,this.utility=p,this.projectiles=new Map}triggerAttack(t){switch(t){case"melee":this.startMelee();break;case"ranged":this.startBurst();break;default:console.warn(`Unknown attack type: ${t}`)}}updateAttack(t){if(!this.gameState.gameInProgress||this.playerState.myPlayer.stats.health.value<=0)return;const e=Date.now();if(this.playerState.isReloading)e>=this.playerState.reloadStartTime+this.playerState.myPlayer.actions.primary.reload.time&&this.finishReload();else if(this.playerState.isBurstActive&&e>=this.playerState.nextBurstShotTime){const t=this.playerState.myPlayer.actions.primary.burst.amount;if(this.playerState.myPlayer.actions.primary.magazine.currentAmmo>0&&this.playerState.currentBurstShot<t){const a=this.controlsManager.getMousePos(),s={rootPos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},targetPos:{x:a.x,y:a.y}},r=this.utility.getDirection(s);if(0===r.x&&0===r.y)return;this.launchProjectile(r,!0),this.playerState.currentBurstShot++,this.playerState.myPlayer.actions.primary.magazine.currentAmmo--,console.log(`Burst shot ${this.playerState.currentBurstShot}! Magazine: ${this.playerState.myPlayer.actions.primary.magazine.currentAmmo}/${this.playerState.myPlayer.actions.primary.magazine.size}, Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`),this.playerState.currentBurstShot>=t||0===this.playerState.myPlayer.actions.primary.magazine.currentAmmo?(this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0):this.playerState.nextBurstShotTime=e+this.playerState.myPlayer.actions.primary.burst.delay}else this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0}}canMelee(){const t=Date.now();return!this.playerState.isMelee&&t>=this.playerState.lastMeleeTime+this.playerState.myPlayer.actions.melee.cooldown&&this.playerState.myPlayer.stats.health.value>0&&!this.playerState.isBurstActive&&!this.playerState.isReloading}startMelee(){this.playerState.isMelee=!0,this.playerState.lastMeleeTime=Date.now(),this.playerState.myPlayer.rig.weapon="KNIFE",this.roomManager.sendMessage(JSON.stringify({type:"weapon-change",playerId:this.userId,weapon:"KNIFE"}));const t=this.playerState.myPlayer.transform.rot,a=this.playerState.myPlayer.actions.melee.range,s=this.playerState.myPlayer.actions.melee.size,r=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+this.playerState.myPlayer.actions.primary.projectile.size+this.playerState.myPlayer.actions.primary.offset,i=this.playerState.myPlayer.transform.pos.x+Math.cos(t-Math.PI/2)*r,o=this.playerState.myPlayer.transform.pos.y+Math.sin(t-Math.PI/2)*r,n={x:Math.cos(t-Math.PI/2)*a,y:Math.sin(t-Math.PI/2)*a},l={id:this.utility.generateUID(e),transform:{pos:{x:i,y:o},rot:t},timestamp:Date.now(),color:"rgba(255, 255, 255, 0)",damage:this.playerState.myPlayer.actions.melee.damage,distanceTraveled:0,length:s,ownerId:this.userId,range:a,size:s,velocity:n};this.projectiles.set(l.id,l),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:l})),setTimeout(()=>{this.projectiles.delete(l.id),this.playerState.isMelee=!1,this.playerState.myPlayer.rig.weapon="GLOCK",this.roomManager.sendMessage(JSON.stringify({type:"weapon-change",playerId:this.userId,weapon:"GLOCK"}))},this.playerState.myPlayer.actions.melee.duration)}startBurst(){if(this.playerState.isBurstActive||this.playerState.myPlayer.stats.health.value<=0||this.playerState.isReloading)return;const t=Date.now();if(t<this.playerState.lastShotTime+this.playerState.myPlayer.actions.primary.buffer)return;this.playerState.lastShotTime=t;const e=this.playerState.myPlayer.actions.primary.burst.amount,a=Math.min(e,this.playerState.myPlayer.actions.primary.magazine.currentAmmo);if(0===a)return console.log("Out of ammo! Magazine empty."),this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:8}},duration:0,partIndex:1}),void this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(E.WEAPON.GLOCK.EMPTY),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}});this.playerState.isBurstActive=!0,this.playerState.currentBurstShot=0;const s=this.controlsManager.getMousePos(),r={rootPos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},targetPos:{x:s.x,y:s.y}},i=this.utility.getDirection(r);if(0===i.x&&0===i.y)return;this.launchProjectile(i,!0),this.playerState.currentBurstShot++,this.playerState.myPlayer.actions.primary.magazine.currentAmmo--;const o=1-this.playerState.myPlayer.actions.primary.magazine.currentAmmo/this.playerState.myPlayer.actions.primary.magazine.size;if(o>.5){const t=2*(o-.5)*.5;this.audioManager.playAudio({src:this.utility.getRandomInArray(E.WEAPON.GLOCK.EMPTY),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},volume:{min:t,max:t}})}this.playerState.myPlayer.actions.primary.burst.amount>1&&this.playerState.myPlayer.actions.primary.magazine.currentAmmo>0&&this.playerState.currentBurstShot<a?this.playerState.nextBurstShotTime=Date.now()+this.playerState.myPlayer.actions.primary.burst.delay:(this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0,0===this.playerState.myPlayer.actions.primary.magazine.currentAmmo&&this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:8}},duration:0,partIndex:1}))}launchProjectile(t,a){console.log("Fired shot!");const s=Math.sqrt(t.x*t.x+t.y*t.y);if(0===s)return;const r=t.x/s,i=t.y/s;this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:0},.5:{x:0,y:20},1:{x:0,y:0}},duration:175,partIndex:1});const h=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+this.playerState.myPlayer.actions.primary.projectile.size+this.playerState.myPlayer.actions.primary.offset,m=this.playerState.myPlayer.transform.pos.x+r*h,p=this.playerState.myPlayer.transform.pos.y+i*h,d=-i,u=r;this.particlesManager.createParticles(m,p,`muzzle_${Date.now()}`,o,{x:r,y:i}),this.particlesManager.createParticles(m,p,`smoke_${Date.now()}`,l,{x:.3*r,y:.3*i}),this.particlesManager.createParticles(m-5,p-5,`shell_${Date.now()}`,n,{x:.8*d+-.2*r,y:.8*u+-.2*i}),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(E.WEAPON.GLOCK.ATTACK),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rolloff:{distance:2*Math.max(y,c),factor:.5,type:"logarithmic"}},volume:{min:.965,max:1}}),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(E.WEAPON.GLOCK.SHELL),delay:{min:.25,max:.5},listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.675,max:1}});for(let t=0;t<this.playerState.myPlayer.actions.primary.projectile.amount;t++){if(this.playerState.myPlayer.unique.length>0&&a){const t=this.utility.getShuffledArray(this.playerState.myPlayer.unique);for(const e of t)if(this.luckController.luckRoll()){this.triggerUnique(e);break}}const t=(Math.random()-.5)*(this.playerState.myPlayer.actions.primary.projectile.spread/100),s=Math.atan2(i,r)+t,o=this.utility.forward(s),n={id:this.utility.generateUID(e),transform:{pos:{x:this.playerState.myPlayer.transform.pos.x+Math.cos(s)*h,y:this.playerState.myPlayer.transform.pos.y+Math.sin(s)*h},rot:s},timestamp:Date.now(),color:this.playerState.myPlayer.actions.primary.projectile.color,damage:this.playerState.myPlayer.actions.primary.projectile.damage,distanceTraveled:0,length:this.playerState.myPlayer.actions.primary.projectile.length,ownerId:this.userId,range:100*this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,velocity:{x:o.x*this.playerState.myPlayer.actions.primary.projectile.speed,y:o.y*this.playerState.myPlayer.actions.primary.projectile.speed}};this.projectiles.set(n.id,n),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:n}))}}updateProjectiles(t){const e=[];this.projectiles.forEach((r,o)=>{r.transform.pos.x+=r.velocity.x*t,r.transform.pos.y+=r.velocity.y*t;const n=Math.sqrt(r.velocity.x*r.velocity.x+r.velocity.y*r.velocity.y)*t;if(r.distanceTraveled+=n,this.playerState.myPlayer.stats.health.value>0){const t=r.transform.pos.x-this.playerState.myPlayer.transform.pos.x,a=r.transform.pos.y-this.playerState.myPlayer.transform.pos.y;if(Math.sqrt(t*t+a*a)<=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+r.size){e.push(o),this.playerState.myPlayer.stats.health.value-=r.damage;const t=300,a={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:t};this.utility.setSlider(a),this.roomManager.sendMessage(JSON.stringify({type:"player-hit",targetId:this.userId,shooterId:r.ownerId,damage:r.damage,newHealth:this.playerState.myPlayer.stats.health.value,projectileId:o}))}}r.ownerId===this.userId&&this.playerState.players.forEach((t,a)=>{if(t.stats.health.value>0){const n=r.transform.pos.x-t.transform.pos.x,l=r.transform.pos.y-t.transform.pos.y;if(Math.sqrt(n*n+l*l)<=this.collisionsManager.getPlayerCollider(t)+r.size){e.push(o);const n=Math.max(0,t.stats.health.value-r.damage);t.stats.health.value=n;const l={x:-r.velocity.x/Math.sqrt(r.velocity.x**2+r.velocity.y**2),y:-r.velocity.y/Math.sqrt(r.velocity.x**2+r.velocity.y**2)};if(this.decalsManager.createDecal(r.transform.pos.x,r.transform.pos.y,`blood_${o}`,s),this.particlesManager.createParticles(r.transform.pos.x,r.transform.pos.y,`blood_${o}`,i,l),this.particlesManager.createEmitter(a,r.transform.pos.x,r.transform.pos.y,t.transform.pos.x,t.transform.pos.y),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(E.IMPACT.FLESH.BULLET),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.925,max:1.15},spatial:{blend:1,pos:{x:r.transform.pos.x,y:r.transform.pos.y}},volume:{min:.95,max:1}}),n<=0){console.log(`I killed ${a}!`);const t=this.ui.leaderboard.get(this.userId);t&&t.kills++;const e=this.ui.leaderboard.get(a);e&&e.deaths++,this.ui.updateLeaderboardDisplay(this.userId)}this.roomManager.sendMessage(JSON.stringify({type:"player-hit",targetId:a,shooterId:this.userId,damage:r.damage,newHealth:n,projectileId:o,wasKill:n<=0})),n<=0&&window.dispatchEvent(new CustomEvent("customEvent_checkRoundEnd"))}}}),(r.distanceTraveled>=r.range||r.transform.pos.x<0||r.transform.pos.x>y||r.transform.pos.y<0||r.transform.pos.y>c)&&(e.push(o),r.ownerId===this.userId&&(r.distanceTraveled>=r.range&&this.decalsManager.createDecal(r.transform.pos.x,r.transform.pos.y,`impact_${o}`,a),this.particlesManager.createParticles(r.transform.pos.x,r.transform.pos.y,`sparks_${o}`,h),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(E.IMPACT.METAL.BULLET),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:r.transform.pos.x,y:r.transform.pos.y}},volume:{min:.965,max:1}}),this.roomManager.sendMessage(JSON.stringify({type:"projectile-remove",projectileId:o}))))}),e.forEach(t=>{this.projectiles.delete(t)})}triggerUnique(t){if("projectile_array"===t){const t=this.utility.getRandomInt(1,3);for(let e=0;e<t;e++){const t=this.utility.getRandomDirection(360);this.launchProjectile(t,!1)}}}canReload(){return!this.playerState.isReloading&&this.playerState.myPlayer.actions.primary.magazine.currentAmmo<this.playerState.myPlayer.actions.primary.magazine.size&&this.playerState.myPlayer.actions.primary.magazine.currentReserve>0&&!this.playerState.isMelee}startReload(){this.canReload()&&(console.log("Reloading..."),this.playerState.isReloading=!0,this.playerState.reloadStartTime=Date.now(),this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0,this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:8}},duration:0,partIndex:1}))}finishReload(){const t=this.playerState.myPlayer.actions.primary.magazine.size-this.playerState.myPlayer.actions.primary.magazine.currentAmmo,e=Math.min(t,this.playerState.myPlayer.actions.primary.magazine.currentReserve);this.playerState.myPlayer.actions.primary.magazine.currentAmmo+=e,this.playerState.myPlayer.actions.primary.magazine.currentReserve-=e,this.playerState.isReloading=!1,this.ammoReservesUIController.removeAmmoFromReserveUI(e),this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:20},1:{x:0,y:0}},duration:175,partIndex:1}),console.log("Reload complete...")}}class Q{constructor(t){this.ui=t,this.ammoReserveIcon=null,this.projectileIcon=null,this.reserveBulletParticles=[]}initAmmoReserveCanvas(){this.ammoReserveIcon=new Image,this.ammoReserveIcon.src="/assets/img/icon/inventory/ammobox.png",this.ammoReserveIcon.onload=()=>{this.renderAmmoReserves()},this.projectileIcon=new Image,this.projectileIcon.src="/assets/img/icon/inventory/9mm.png",requestAnimationFrame(()=>this.updateAmmoReservePhysics())}spawnAmmoInReserveUI(t=1){if(!this.ui.ammoReservesCtx||!this.projectileIcon)return;const{collisionHeight:e,collisionWidth:a,collisionX:s,collisionY:r}=this.getAmmoReserveCollisionZone(),i=s+a,o=r+e/2;for(let e=0;e<t;e++)setTimeout(()=>{const t=2+8*Math.random(),e=(Math.random()-.5)*(Math.PI/3),a=Math.cos(e)*t,s=Math.sin(e)*t,r=Math.random()*Math.PI*2,n=.1*(Math.random()-.5);this.reserveBulletParticles.push({transform:{pos:{x:i,y:o},rot:r},velocity:{x:a,y:s},torque:n,width:2.75,height:7})},100*e)}removeAmmoFromReserveUI(t=1){for(let e=0;e<t;e++)setTimeout(()=>{this.reserveBulletParticles.length>0&&this.reserveBulletParticles.shift()},100*e)}updateAmmoReservePhysics(){if(!this.ui.ammoReservesCtx||!this.ammoReserveIcon)return;const{collisionHeight:t,collisionWidth:e,collisionX:a,collisionY:s}=this.getAmmoReserveCollisionZone();this.ui.ammoReservesCtx.clearRect(0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),this.ui.ammoReservesCtx.drawImage(this.ammoReserveIcon,0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height);for(let r of this.reserveBulletParticles)r.transform.pos.x+=r.velocity.x,r.transform.pos.y+=r.velocity.y,r.transform.rot+=r.torque,r.velocity.x*=.9,r.velocity.y*=.9,r.torque*=.9,r.transform.pos.x-r.width/2<a&&(r.transform.pos.x=a+r.width/2,r.velocity.x*=-.5),r.transform.pos.x+r.width/2>a+e&&(r.transform.pos.x=a+e-r.width/2,r.velocity.x*=-.5),r.transform.pos.y-r.height/2<s&&(r.transform.pos.y=s+r.height/2,r.velocity.y*=-.5),r.transform.pos.y+r.height/2>s+t&&(r.transform.pos.y=s+t-r.height/2,r.velocity.y*=-.5);for(let t=0;t<this.reserveBulletParticles.length;t++)for(let e=t+1;e<this.reserveBulletParticles.length;e++){const a=this.reserveBulletParticles[t],s=this.reserveBulletParticles[e],r=a.transform.pos.x-s.transform.pos.x,i=a.transform.pos.y-s.transform.pos.y,o=Math.sqrt(r*r+i*i),n=(a.width+s.width)/2;if(o<n){const t=Math.atan2(i,r),e=n-o,l=Math.cos(t)*e/2,h=Math.sin(t)*e/2;a.transform.pos.x+=l,a.transform.pos.y+=h,s.transform.pos.x-=l,s.transform.pos.y-=h;const m=a.velocity.x*Math.cos(t)+a.velocity.y*Math.sin(t),y=s.velocity.x*Math.cos(t)+s.velocity.y*Math.sin(t),c=(m+y)/2;a.velocity.x+=.5*(c-m),s.velocity.x+=.5*(c-y)}}for(let t of this.reserveBulletParticles)this.ui.ammoReservesCtx.save(),this.ui.ammoReservesCtx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.ammoReservesCtx.rotate(t.transform.rot),this.ui.ammoReservesCtx.drawImage(this.projectileIcon,-t.width/2,-t.height/2,t.width,t.height),this.ui.ammoReservesCtx.restore();requestAnimationFrame(()=>this.updateAmmoReservePhysics())}renderAmmoReserves(){this.ui.ammoReservesCtx&&this.ammoReserveIcon&&this.ammoReserveIcon.complete&&(this.ui.ammoReservesCtx.clearRect(0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),this.ui.ammoReservesCtx.drawImage(this.ammoReserveIcon,0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height))}getAmmoReserveCollisionZone(){return{collisionHeight:27,collisionWidth:63,collisionX:(this.ui.ammoReservesCanvas.width-63)/2-3,collisionY:(this.ui.ammoReservesCanvas.height-27)/2-1}}}class tt{constructor(t){this.playerState=t}luckRoll(){const t=.5+.45*Math.tanh(this.playerState.myPlayer.stats.luck/10);return Math.random()<t}}class et{constructor(){this.ammoBoxes=new Map}}class at{constructor(){this.characterImages=new Map,this.ammoBoxImages={}}}class st{constructor(){this.isRoundInProgress=!1,this.roundWinner=null,this.gameWinner=null,this.settingsManager=new z,this.utility=new X,this.ui=new G,this.upgradeManager=new Y,this.controlsManager=new N,this.gameState=new F,this.objectsManager=new et,this.renderingManager=new at,this.userId=this.utility.generateUID(t.DATA.ID_LENGTH),this.playerState=new _(this.userId,this.utility),this.settingsManager.initSettings(),this.roomManager=new j(this.userId,this.utility),this.lobbyManager=new D(this.utility,this.ui,this.roomManager),this.wsManager=new W(this.gameState,this.roomManager),this.roomController=new U(this.gameState,this.lobbyManager,this.playerState,this.roomManager,this.ui,this.upgradeManager,this.userId,this.wsManager),this.chatManager=new q(this.roomManager,this.ui),this.ammoReservesUIController=new Q(this.ui),this.collisionsManager=new O(this.ammoReservesUIController,this.objectsManager,this.playerState,this.roomManager,this.userId),this.moveController=new J(this.controlsManager,this.settingsManager),this.staminaController=new Z(this.playerState),this.dashController=new V(this.moveController,this.playerState,this.roomManager,this.staminaController),this.luckController=new tt(this.playerState),this.decalsManager=new L(this.roomManager,this.ui,this.utility),this.particlesManager=new k(this.decalsManager,this.playerState,this.renderingManager,this.roomManager,this.ui,this.userId,this.utility),this.audioManager=new w(this.roomManager,this.settingsManager),this.animator=new R(this.playerState,this.roomManager,this.userId),this.combatController=new K(this.ammoReservesUIController,this.animator,this.audioManager,this.collisionsManager,this.controlsManager,this.decalsManager,this.gameState,this.luckController,this.particlesManager,this.playerState,this.roomManager,this.ui,this.userId,this.utility),this.eventsManager=new B(this.animator,this.chatManager,this.combatController,this.controlsManager,this.dashController,this.gameState,this.lobbyManager,this.moveController,this.roomController,this.roomManager,this.playerState,this.settingsManager,this.ui,this.userId),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initClient()}):this.initClient()}initClient(){this.ui.initInterface(),this.eventsManager.initEventListeners(),this.initGlobalEvents(),this.roomController.checkForRoomInURL(),this.ammoReservesUIController.initAmmoReserveCanvas(),this.roomController.showRoomControls();const t={spanId:"userId",value:this.userId};this.utility.setSpan(t),P&&this.audioManager.preloadAudioAssets(E,".ogg")}initGlobalEvents(){window.addEventListener("customEvent_startGame",()=>this.startGame()),window.addEventListener("customEvent_resetGameState",t=>{const e=t;this.resetGameState(e.detail.resetType)}),window.addEventListener("customEvent_checkRoundEnd",()=>this.checkRoundEnd()),this.roomManager.onMessage(t=>this.handleRoomMessage(t))}handleRoomMessage(t){switch(t.type){case"room-created":console.log("Room created");break;case"room-joined":console.log("Joined room - lobby"),this.playerState.isHost=!1,this.lobbyManager.showLobbyControls(this.gameState.gameMaxPlayers,this.gameState.gameMaxWins,this.playerState.isHost,this.roomManager.isPrivateRoom,this.upgradeManager.isUpgradesEnabled,this.lobbyManager,this.playerState.myPlayer,this.roomManager.getCurrentRoom()||"",this.userId),this.roomManager.sendMessage(JSON.stringify({type:"lobby-join",color:this.playerState.myPlayer.color})),this.lobbyManager.lobbyPlayers.set(this.userId,{id:this.userId,color:this.playerState.myPlayer.color,isHost:this.playerState.isHost}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),0===this.lobbyManager.lobbyPlayers.size&&(this.playerState.isHost=!0,this.lobbyManager.lobbyPlayers.get(this.userId).isHost=!0,this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),console.log("I am the only player in the room..."));break;case"user-left":console.log(`User ${t.userId} left`),this.lobbyManager.lobbyPlayers.delete(t.userId),this.playerState.players.delete(t.userId),this.ui.leaderboard.delete(t.userId),this.ui.updateLeaderboardDisplay(this.userId),console.log(`Removed ${t.userId} from leaderboard`),this.combatController.projectiles.forEach((e,a)=>{e.ownerId===t.userId&&this.combatController.projectiles.delete(a)}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId);break;case"room-message":this.handleGameMessage(t);break;case"room-error":alert(`Error: ${t.message}`)}}handleGameMessage(e){if(e.message)try{const a=JSON.parse(e.message);switch(a.type){case"lobby-join":this.lobbyManager.lobbyPlayers.set(e.userId,{id:e.userId,color:a.color,isHost:!1}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.playerState.isHost&&this.roomManager.sendMessage(JSON.stringify({type:"lobby-state",players:Array.from(this.lobbyManager.lobbyPlayers.values()),options:{privateRoom:this.roomManager.isPrivateRoom,maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,upgradesEnabled:this.upgradeManager.isUpgradesEnabled}}));break;case"lobby-state":this.lobbyManager.lobbyPlayers.clear(),a.players.forEach(t=>{this.lobbyManager.lobbyPlayers.set(t.id,t)}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),a.options&&this.lobbyManager.syncLobbyOptions(a.options);break;case"lobby-options":this.lobbyManager.syncLobbyOptions(a);break;case"promote-player":this.lobbyManager.lobbyPlayers.forEach((t,e)=>{t.isHost=e===a.targetPlayerId}),this.playerState.isHost=a.targetPlayerId===this.userId,this.playerState.isHost&&"host-migration"===a.reason&&console.log("I am now the host due to host migration"),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager);break;case"return-to-lobby":console.log("Returning to lobby - last player or game ended"),a.newHostId===this.userId&&(this.playerState.isHost=!0,console.log("I am now the host as the last remaining player")),this.resetGameState("Lobby"),this.lobbyManager.showLobbyControls(this.gameState.gameMaxPlayers,this.gameState.gameMaxWins,this.playerState.isHost,this.roomManager.isPrivateRoom,this.upgradeManager.isUpgradesEnabled,this.lobbyManager,this.playerState.myPlayer,this.roomManager.getCurrentRoom()||"",this.userId);break;case"kick-player":a.targetPlayerId===this.userId&&(alert("You have been kicked from the lobby"),this.roomController.leaveRoom());break;case"chat-message":e.userId!==this.userId&&this.chatManager.displayChatMessage(e.userId,a.message,!1);break;case"player-state":console.log("Player State for player",a.id,":",a),this.lobbyManager.inLobby||this.playerState.players.set(e.userId,{id:e.userId,transform:{pos:{x:a.transform?.pos.x,y:a.transform?.pos.y},rot:a.transform?.rot},timestamp:a.timestamp,color:a.color,actions:{dash:{cooldown:a.actions?.dash.cooldown||t.ACTIONS.DASH.COOLDOWN,drain:a.actions?.dash.drain||t.ACTIONS.DASH.DRAIN,multiplier:a.actions?.dash.multiplier||t.ACTIONS.DASH.MULTIPLIER,time:a.actions?.dash.time||t.ACTIONS.DASH.TIME},melee:{cooldown:a.actions?.melee.cooldown||t.ACTIONS.MELEE.COOLDOWN,damage:a.actions?.melee.damage||t.ACTIONS.MELEE.DAMAGE,duration:a.actions?.melee.duration||t.ACTIONS.MELEE.DURATION,range:a.actions?.melee.range||t.ACTIONS.MELEE.RANGE,size:a.actions?.melee.size||t.ACTIONS.MELEE.SIZE},primary:{buffer:a.actions?.primary.buffer||t.ACTIONS.PRIMARY.BUFFER,burst:{amount:a.actions?.primary.burst.amount||t.ACTIONS.PRIMARY.BURST.AMOUNT,delay:a.actions?.primary.burst.delay||t.ACTIONS.PRIMARY.BURST.DELAY},magazine:{currentAmmo:a.actions?.primary.magazine.currentAmmo,currentReserve:a.actions?.primary.magazine.currentReserve,maxReserve:a.actions?.primary.magazine.maxReserve,size:a.actions?.primary.magazine.size||t.ACTIONS.PRIMARY.MAGAZINE.SIZE},offset:a.actions?.primary.offset||t.ACTIONS.PRIMARY.OFFSET,projectile:{amount:a.actions?.primary.projectile.amount||t.ACTIONS.PRIMARY.PROJECTILE.AMOUNT,color:a.actions?.primary.projectile.color||t.ACTIONS.PRIMARY.PROJECTILE.COLOR,damage:a.actions?.primary.projectile.damage||t.ACTIONS.PRIMARY.PROJECTILE.DAMAGE,length:a.actions?.primary.projectile.length||t.ACTIONS.PRIMARY.PROJECTILE.LENGTH,range:a.actions?.primary.projectile.range||t.ACTIONS.PRIMARY.PROJECTILE.RANGE,size:a.actions?.primary.projectile.size||t.ACTIONS.PRIMARY.PROJECTILE.SIZE,speed:a.actions?.primary.projectile.speed||t.ACTIONS.PRIMARY.PROJECTILE.SPEED,spread:a.actions?.primary.projectile.spread||t.ACTIONS.PRIMARY.PROJECTILE.SPREAD},reload:{time:a.actions?.primary.reload.time||t.ACTIONS.PRIMARY.RELOAD.TIME}},sprint:{drain:a.actions?.sprint.drain||t.ACTIONS.SPRINT.DRAIN,multiplier:a.actions?.sprint.multiplier||t.ACTIONS.SPRINT.MULTIPLIER}},equipment:a.equipment||t.EQUIPMENT,physics:{acceleration:a.physics?.acceleration||t.PHYSICS.ACCELERATION,friction:a.physics?.friction||t.PHYSICS.FRICTION},rig:{body:a.rig?.body||t.RIG.BODY,head:a.rig?.head||t.RIG.HEAD,headwear:a.rig?.headwear||t.RIG.HEADWEAR,weapon:a.rig?.weapon||t.RIG.WEAPON},stats:{health:{max:a.stats?.health.max||t.STATS.HEALTH.MAX,value:a.stats?.health.value||t.STATS.HEALTH.MAX},luck:a.stats?.luck||t.STATS.LUCK,size:a.stats?.size||t.STATS.SIZE,speed:a.stats?.speed||t.STATS.SPEED,stamina:{max:a.stats?.stamina.max||t.STATS.STAMINA.MAX,recovery:{delay:a.stats?.stamina.recovery.delay||t.STATS.STAMINA.RECOVERY.DELAY,rate:a.stats?.stamina.recovery.rate||t.STATS.STAMINA.RECOVERY.RATE},value:a.stats?.stamina.value||t.STATS.STAMINA.MAX}},unique:a.unique||t.UNIQUE}),a.leaderboard&&a.leaderboard.forEach(([t,e])=>{this.ui.leaderboard.set(t,e)}),this.ui.createLeaderboard(this.lobbyManager,this.playerState.players,this.userId);break;case"player-move":if(!this.lobbyManager.inLobby&&this.playerState.players.has(e.userId)){const t=this.playerState.players.get(e.userId);a.transform.pos&&(t.transform.pos.x=a.transform.pos.x,t.transform.pos.y=a.transform.pos.y),void 0!==a.transform.rot&&(t.transform.rot=a.transform.rot)}break;case"player-hit":if(a.projectileId&&this.combatController.projectiles.delete(a.projectileId),a.targetId===this.userId){this.playerState.myPlayer.stats.health.value=a.newHealth;const t=300,e={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:t};this.utility.setSlider(e),this.playerState.myPlayer.stats.health.value<=0&&(this.recordDeath(),this.checkRoundEnd())}else if(this.playerState.players.has(a.targetId)){const t=this.playerState.players.get(a.targetId);t.stats.health.value=a.newHealth,t.stats.health.value<=0&&(console.log(`Player ${t.id} died`),this.checkRoundEnd())}if(a.wasKill){const t=this.ui.leaderboard.get(a.shooterId);t&&t.kills++;const e=this.ui.leaderboard.get(a.targetId);e&&e.deaths++,this.ui.updateLeaderboardDisplay(this.userId)}break;case"player-death":e.userId!==this.userId&&a.ammoBox&&(this.objectsManager.ammoBoxes.set(a.ammoBox.id,a.ammoBox),console.log(`Ammo box spawned at death of ${e.userId}`)),this.particlesManager.generateGore(e.userId,a.x,a.y,a.size),console.log(`Generated gore for ${e.userId}`);break;case"ammo-pickup":if(a.playerId===this.userId)break;if(this.objectsManager.ammoBoxes.has(a.ammoBoxId)){const t=this.objectsManager.ammoBoxes.get(a.ammoBoxId);t.isOpen=a.boxState.isOpen,t.lid=a.boxState.lid,console.log(`Ammo box opened by ${a.playerId}`)}break;case"weapon-change":e.userId!==this.userId&&this.playerState.players.has(e.userId)&&(this.playerState.players.get(e.userId).rig.weapon=a.weapon,console.log(`${e.userId} switched to ${a.weapon}`));break;case"projectile-launch":this.lobbyManager.inLobby||e.userId===this.userId||this.combatController.projectiles.set(a.projectile.id,a.projectile);break;case"projectile-remove":this.lobbyManager.inLobby||this.combatController.projectiles.delete(a.projectileId);break;case"start-game":a.spawnMap&&a.spawnMap[this.userId]&&(this.playerState.myPlayer.transform.pos.x=a.spawnMap[this.userId].x,this.playerState.myPlayer.transform.pos.y=a.spawnMap[this.userId].y,console.log("My Player Spawn:",a.spawnMap[this.userId].x,a.spawnMap[this.userId].y)),a.spawnMap&&this.playerState.players.forEach((t,e)=>{a.spawnMap[e]&&(t.transform.pos.x=a.spawnMap[e].x,t.transform.pos.y=a.spawnMap[e].y,console.log(`Player ${e} spawn:`,a.spawnMap[e].x,a.spawnMap[e].y))}),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop();break;case"game-end":console.log(`Game ended! Winner: ${a.winnerId}`),this.gameWinner=a.winnerId;break;case"round-end":console.log(`Round ended! Winner: ${a.winnerId||"No one"}`),this.isRoundInProgress=!1,this.roundWinner=a.winnerId;break;case"new-round":if(!a.spawnMap)return;console.log(a.spawnMap),this.ui.upgradeContainer&&(this.ui.upgradeContainer.style.display="none"),console.log("New round started! Everyone respawning..."),this.isRoundInProgress=!0,this.roundWinner=null,this.playerState.myPlayer.stats.health.value=this.playerState.myPlayer.stats.health.max;const s=300,r={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:s},i={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:s};this.utility.setSlider(r),this.utility.setSlider(i),this.playerState.myPlayer.transform.pos.x=a.spawnMap[this.userId].x,this.playerState.myPlayer.transform.pos.y=a.spawnMap[this.userId].y,this.resumeGame(),this.playerState.players.forEach((t,e)=>{a.spawnMap[e]&&(t.transform.pos.x=a.spawnMap[t.id].x,t.transform.pos.y=a.spawnMap[t.id].y,t.transform.rot=0,t.stats.health.value=t.stats.health.max,t.stats.stamina.value=t.stats.stamina.max)});break;case"upgrade-taken":a.upgradeId&&a.isUnique&&(this.upgradeManager.removeUpgradeFromPool(a.upgradeId),console.log(`Unique upgrade ${a.upgradeId} taken by ${e.userId}`)),this.roundWinner===this.userId&&(this.upgradeManager.upgradesCompleted.add(e.userId),console.log(`${e.userId} completed upgrade. ${this.upgradeManager.upgradesCompleted.size}/${this.playerState.players.size} done`),this.upgradeManager.upgradesCompleted.size>=this.playerState.players.size&&this.showWinnerContinueButton());break;case"play-audio":e.userId!==this.userId&&this.audioManager.playAudio(a.params);break;case"add-decal":e.userId!==this.userId&&this.decalsManager.createDecalNetwork(a.x,a.y,a.decalId,a.params);break;case"add-particles":e.userId!==this.userId&&this.particlesManager.generateParticles(a.x,a.y,a.particleId,a.params,a.direction);break;case"particle-emitter":e.userId!==this.userId&&this.particlesManager.emitters.set(a.emitterId,{age:0,direction:a.direction||0,emissionInterval:200+300*Math.random(),lastEmission:0,lifetime:a.lifetime,offset:{x:a.offsetX,y:a.offsetY},playerId:a.playerId});break;case"character-animation":a.params.playerId!==this.userId&&this.animator.animateCharacterPartNetwork(a.params)}}catch(t){console.error("Error parsing game message:",t)}}returnToLobby(){this.resetGameState("Lobby"),this.roomManager.sendMessage(JSON.stringify({type:"return-to-lobby",reason:"game-ended"})),this.lobbyManager.showLobbyControls(this.gameState.gameMaxPlayers,this.gameState.gameMaxWins,this.playerState.isHost,this.roomManager.isPrivateRoom,this.upgradeManager.isUpgradesEnabled,this.lobbyManager,this.playerState.myPlayer,this.roomManager.getCurrentRoom()||"",this.userId)}checkRoundEnd(){if(!this.isRoundInProgress)return;let t=this.playerState.myPlayer.stats.health.value>0?1:0,e=this.playerState.myPlayer.stats.health.value>0?this.userId:null;this.playerState.players.forEach(a=>{a.stats.health.value>0&&(t++,e=a.id)}),t<=1&&this.endRound(e)}endRound(t){if(this.isRoundInProgress){if(this.isRoundInProgress=!1,this.roundWinner=t,!t)return console.log("Round ended with no survivors!"),void setTimeout(()=>{this.startNewRound()},g);if(this.ui.leaderboard.has(t)){const e=this.ui.leaderboard.get(t);if(e.wins++,console.log(`${t} won the round! Total wins: ${e.wins}`),e.wins>=this.gameState.gameMaxWins)return void this.endGame(t);this.ui.updateLeaderboardDisplay(this.userId)}setTimeout(()=>{this.pauseGame()},500),setTimeout(()=>{this.startUpgradePhase(t)},g)}}endGame(t){this.gameWinner=t,console.log(`${t} won the game with ${this.gameState.gameMaxWins} wins!`),this.roomManager.sendMessage(JSON.stringify({type:"game-end",winnerId:t})),setTimeout(()=>{this.returnToLobby()},5e3)}startNewRound(){console.log("Starting new round..."),this.resumeGame(),this.isRoundInProgress=!0,this.roundWinner=null,this.playerState.myPlayer.stats.health.value=this.playerState.myPlayer.stats.health.max;const e={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:300},a={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:300};this.utility.setSlider(e),this.utility.setSlider(a),this.playerState.myPlayer.transform.pos.x=770*Math.random()+p,this.playerState.myPlayer.transform.pos.y=570*Math.random()+p;const s=this.getSpawnMap(120);this.playerState.players.forEach(e=>{const a=s[e.id];e.transform.pos.x=a.x,e.transform.pos.y=a.y,e.transform.rot=e.transform.rot||0,e.timestamp=e.timestamp||Date.now(),e.actions.dash.cooldown=e.actions.dash.cooldown||t.ACTIONS.DASH.COOLDOWN,e.actions.dash.drain=e.actions.dash.drain||t.ACTIONS.DASH.DRAIN,e.actions.dash.multiplier=e.actions.dash.multiplier||t.ACTIONS.DASH.MULTIPLIER,e.actions.dash.time=e.actions.dash.time||t.ACTIONS.DASH.TIME,e.actions.melee.cooldown=e.actions.melee.cooldown||t.ACTIONS.MELEE.COOLDOWN,e.actions.melee.damage=e.actions.melee.damage||t.ACTIONS.MELEE.DAMAGE,e.actions.melee.duration=e.actions.melee.duration||t.ACTIONS.MELEE.DURATION,e.actions.melee.range=e.actions.melee.range||t.ACTIONS.MELEE.RANGE,e.actions.melee.size=e.actions.melee.size||t.ACTIONS.MELEE.SIZE,e.actions.primary.buffer=e.actions.primary.buffer||t.ACTIONS.PRIMARY.BUFFER,e.actions.primary.burst.amount=e.actions.primary.burst.amount||t.ACTIONS.PRIMARY.BURST.AMOUNT,e.actions.primary.burst.delay=e.actions.primary.burst.delay||t.ACTIONS.PRIMARY.BURST.DELAY,e.actions.primary.magazine.currentAmmo=e.actions.primary.magazine.currentAmmo||t.ACTIONS.PRIMARY.MAGAZINE.SIZE,e.actions.primary.magazine.currentReserve=e.actions.primary.magazine.currentReserve||t.ACTIONS.PRIMARY.MAGAZINE.STARTING_RESERVE,e.actions.primary.magazine.maxReserve=e.actions.primary.magazine.maxReserve||t.ACTIONS.PRIMARY.MAGAZINE.MAX_RESERVE,e.actions.primary.magazine.size=e.actions.primary.magazine.size||t.ACTIONS.PRIMARY.MAGAZINE.SIZE,e.actions.primary.offset=e.actions.primary.offset||t.ACTIONS.PRIMARY.OFFSET,e.actions.primary.projectile.amount=e.actions.primary.projectile.amount||t.ACTIONS.PRIMARY.PROJECTILE.AMOUNT,e.actions.primary.projectile.color=e.actions.primary.projectile.color||t.ACTIONS.PRIMARY.PROJECTILE.COLOR,e.actions.primary.projectile.damage=e.actions.primary.projectile.damage||t.ACTIONS.PRIMARY.PROJECTILE.DAMAGE,e.actions.primary.projectile.length=e.actions.primary.projectile.length||t.ACTIONS.PRIMARY.PROJECTILE.LENGTH,e.actions.primary.projectile.range=e.actions.primary.projectile.range||t.ACTIONS.PRIMARY.PROJECTILE.RANGE,e.actions.primary.projectile.size=e.actions.primary.projectile.size||t.ACTIONS.PRIMARY.PROJECTILE.SIZE,e.actions.primary.projectile.speed=e.actions.primary.projectile.speed||t.ACTIONS.PRIMARY.PROJECTILE.SPEED,e.actions.primary.projectile.spread=e.actions.primary.projectile.spread||t.ACTIONS.PRIMARY.PROJECTILE.SPREAD,e.actions.primary.reload.time=e.actions.primary.reload.time||t.ACTIONS.PRIMARY.RELOAD.TIME,e.actions.sprint.drain=e.actions.sprint.drain||t.ACTIONS.SPRINT.DRAIN,e.actions.sprint.multiplier=e.actions.sprint.multiplier||t.ACTIONS.SPRINT.MULTIPLIER,e.equipment=e.equipment||t.EQUIPMENT,e.physics.acceleration=e.physics.acceleration||t.PHYSICS.ACCELERATION,e.physics.friction=e.physics.friction||t.PHYSICS.FRICTION,e.rig.body=e.rig.body||t.RIG.BODY,e.rig.head=e.rig.head||t.RIG.HEAD,e.rig.headwear=e.rig.headwear||t.RIG.HEADWEAR,e.rig.weapon=e.rig.weapon||t.RIG.WEAPON,e.stats.health.max=e.stats.health.max||t.STATS.HEALTH.MAX,e.stats.health.value=e.stats.health.max||t.STATS.HEALTH.MAX,e.stats.luck=e.stats.luck||t.STATS.LUCK,e.stats.size=e.stats.size||t.STATS.SIZE,e.stats.speed=e.stats.speed||t.STATS.SPEED,e.stats.stamina.max=e.stats.stamina.max||t.STATS.STAMINA.MAX,e.stats.stamina.recovery.delay=e.stats.stamina.recovery.delay||t.STATS.STAMINA.RECOVERY.DELAY,e.stats.stamina.recovery.rate=e.stats.stamina.recovery.rate||t.STATS.STAMINA.RECOVERY.RATE,e.stats.stamina.value=e.stats.stamina.value||t.STATS.STAMINA.MAX,e.unique=e.unique||t.UNIQUE}),this.roomManager.sendMessage(JSON.stringify({type:"new-round",spawnMap:s}))}getSpawnMap(t){const e={},a=[];return e[this.userId]={x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},a.push(e[this.userId]),this.playerState.players.forEach(s=>{let r,i=0;do{r={x:770*Math.random()+p,y:570*Math.random()+p},i++}while(a.some(e=>Math.hypot(e.x-r.x,e.y-r.y)<t)&&i<1e3);a.push(r),e[s.id]=r}),e}updatePlayerPosition(t){if(!this.gameState.gameInProgress||this.playerState.myPlayer.stats.health.value<=0||this.playerState.isDashing)return;const e=Date.now(),{inputX:a,inputY:s}=this.moveController.getMoveInput(),r=this.playerState.isSprinting&&this.playerState.myPlayer.stats.stamina.value>0&&this.moveController.isMoving()?this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.sprint.multiplier:this.playerState.myPlayer.stats.speed;this.playerState.isSprinting&&this.playerState.myPlayer.stats.stamina.value<=0&&(this.playerState.isSprinting=!1,console.log("Out of stamina, stopped sprinting"));const i=a*r,o=s*r;this.playerState.playerVelocityX+=(i-this.playerState.playerVelocityX)*this.playerState.myPlayer.physics.acceleration*t,this.playerState.playerVelocityY+=(o-this.playerState.playerVelocityY)*this.playerState.myPlayer.physics.acceleration*t,this.moveController.isMoving()||(this.playerState.playerVelocityX*=Math.pow(this.playerState.myPlayer.physics.friction,t),this.playerState.playerVelocityY*=Math.pow(this.playerState.myPlayer.physics.friction,t));let n=this.playerState.myPlayer.transform.pos.x+this.playerState.playerVelocityX*t,l=this.playerState.myPlayer.transform.pos.y+this.playerState.playerVelocityY*t;this.playerState.myPlayer.transform.pos.x=n,this.playerState.myPlayer.transform.pos.y=l;let h=0!==this.playerState.playerVelocityX||0!==this.playerState.playerVelocityY;const m=Math.sqrt((this.playerState.myPlayer.transform.pos.x-this.playerState.lastSentX)**2+(this.playerState.myPlayer.transform.pos.y-this.playerState.lastSentY)**2);h&&m>2&&e-this.playerState.lastSentMoveTime>=10&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}}})),this.playerState.lastSentX=this.playerState.myPlayer.transform.pos.x,this.playerState.lastSentY=this.playerState.myPlayer.transform.pos.y,this.playerState.lastSentMoveTime=e),Math.abs(this.playerState.playerVelocityX)<.01&&(this.playerState.playerVelocityX=0),Math.abs(this.playerState.playerVelocityY)<.01&&(this.playerState.playerVelocityY=0)}recordDeath(){console.log("I died! Waiting for round to end..."),this.playerState.resetPlayerState();const t=this.spawnAmmoBox(10);this.objectsManager.ammoBoxes.set(t.id,t),this.particlesManager.generateGore(this.userId,this.playerState.myPlayer.transform.pos.x,this.playerState.myPlayer.transform.pos.y,this.playerState.myPlayer.stats.size),this.roomManager.sendMessage(JSON.stringify({type:"player-death",playerId:this.userId,x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y,size:this.playerState.myPlayer.stats.size,ammoBox:t}))}spawnObject(t){const a={id:this.utility.generateUID(e),transform:t.transform,timestamp:Date.now()};if("AmmoBox"===t.type)return{id:a.id,transform:a.transform,timestamp:a.timestamp,ammoAmount:t.data?.amount||10,isOpen:!1,lid:{pos:{x:0,y:0},rot:0,velocity:{x:0,y:0},torque:0}};throw new Error(`Unknown object type: ${t.type}`)}spawnAmmoBox(t){return this.spawnObject({type:"AmmoBox",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},data:{amount:t}})}showGameControls(t){this.ui.updateDisplay(this.lobbyManager,"game",t)}startGame(){this.playerState.isHost&&(1!==this.lobbyManager.lobbyPlayers.size?this.executeStartGame():this.ui.soloGameWarning(()=>this.executeStartGame()))}executeStartGame(){this.roomManager.sendMessage(JSON.stringify({type:"start-game",hostSpawn:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}})),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop()}startGameLoop(){this.gameState.gameInProgress=!0,this.isRoundInProgress=!0,this.playerState.myPlayer.actions.primary.magazine.currentReserve=Math.floor(t.ACTIONS.PRIMARY.MAGAZINE.MAX_RESERVE/2),this.playerState.myPlayer.actions.primary.magazine.currentAmmo=this.playerState.myPlayer.actions.primary.magazine.size,this.ammoReservesUIController.spawnAmmoInReserveUI(this.playerState.myPlayer.actions.primary.magazine.currentReserve),this.playerState.isReloading=!1,this.ui.createLeaderboard(this.lobbyManager,this.playerState.players,this.userId),this.upgradeManager.resetUpgrades(this.playerState.myPlayer),this.roomManager.sendMessage(JSON.stringify({type:"player-state",id:this.playerState.myPlayer.id,timestamp:this.playerState.myPlayer.timestamp,color:this.playerState.myPlayer.color,transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},actions:{dash:{cooldown:this.playerState.myPlayer.actions.dash.cooldown,drain:this.playerState.myPlayer.actions.dash.drain,multiplier:this.playerState.myPlayer.actions.dash.multiplier,time:this.playerState.myPlayer.actions.dash.time},melee:{cooldown:this.playerState.myPlayer.actions.melee.cooldown,damage:this.playerState.myPlayer.actions.melee.damage,duration:this.playerState.myPlayer.actions.melee.duration,range:this.playerState.myPlayer.actions.melee.range,size:this.playerState.myPlayer.actions.melee.size},primary:{buffer:this.playerState.myPlayer.actions.primary.buffer,burst:{amount:this.playerState.myPlayer.actions.primary.burst.amount,delay:this.playerState.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.playerState.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.playerState.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.playerState.myPlayer.actions.primary.magazine.maxReserve,size:this.playerState.myPlayer.actions.primary.magazine.size},offset:this.playerState.myPlayer.actions.primary.offset,projectile:{amount:this.playerState.myPlayer.actions.primary.projectile.amount,color:this.playerState.myPlayer.actions.primary.projectile.color,damage:this.playerState.myPlayer.actions.primary.projectile.damage,length:this.playerState.myPlayer.actions.primary.projectile.length,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,spread:this.playerState.myPlayer.actions.primary.projectile.spread},reload:{time:this.playerState.myPlayer.actions.primary.reload.time}},sprint:{drain:this.playerState.myPlayer.actions.sprint.drain,multiplier:this.playerState.myPlayer.actions.sprint.multiplier}},equipment:this.playerState.myPlayer.equipment,physics:{acceleration:this.playerState.myPlayer.physics.acceleration,friction:this.playerState.myPlayer.physics.friction},rig:{body:this.playerState.myPlayer.rig.body,head:this.playerState.myPlayer.rig.head,headwear:this.playerState.myPlayer.rig.headwear,weapon:this.playerState.myPlayer.rig.weapon},stats:{health:{max:this.playerState.myPlayer.stats.health.max,value:this.playerState.myPlayer.stats.health.value},luck:this.playerState.myPlayer.stats.luck,size:this.playerState.myPlayer.stats.size,speed:this.playerState.myPlayer.stats.speed,stamina:{max:this.playerState.myPlayer.stats.stamina.max,recovery:{delay:this.playerState.myPlayer.stats.stamina.recovery.delay,rate:this.playerState.myPlayer.stats.stamina.recovery.rate},value:this.playerState.myPlayer.stats.stamina.value}},unique:this.playerState.myPlayer.unique})),this.gameLoop();const e={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:300},a={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:300};this.utility.setSlider(e),this.utility.setSlider(a)}gameLoop(){if(!(this.gameState.gameInProgress&&this.ui.ctx&&this.ui.canvas&&this.ui.decalCtx&&this.ui.decalCanvas))return;if(this.gameState.isPaused)return void requestAnimationFrame(()=>this.gameLoop());const t=this.utility.deltaTime();this.updatePlayerPosition(t),this.combatController.updateAttack(t),this.combatController.updateProjectiles(t),this.particlesManager.updateParticles(t),this.particlesManager.updateEmitters(t),this.animator.updateCharacterAnimations(t),this.staminaController.updateStamina(t),this.dashController.updateDash(t),this.collisionsManager.checkCollisions(t);const e={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:300};this.utility.setSlider(e),this.clearCtx(this.ui.ctx),this.ui.ctx.drawImage(this.ui.decalCanvas,0,0),this.drawObjects(),this.combatController.projectiles.forEach(t=>{this.drawProjectile(t)}),this.playerState.players.forEach(t=>{this.drawCharacter(t)}),this.drawCharacter(this.playerState.myPlayer,!0),this.drawParticles(),requestAnimationFrame(()=>this.gameLoop())}pauseGame(){this.gameState.gameInProgress&&(this.gameState.isPaused=!0,console.log("Game paused"),this.controlsManager.clearActiveKeys(),this.playerState.isSprinting=!1,this.playerState.isDashing=!1,this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0)}resumeGame(){this.gameState.gameInProgress&&(this.gameState.isPaused=!1,console.log("Game resumed"))}resetGameState(t){this.gameState.gameInProgress=!1,this.isRoundInProgress=!1,this.gameWinner=null,this.roundWinner=null,this.gameState.gameMaxWins=5,this.gameState.gameMaxPlayers=4,"Room"===t&&(this.lobbyManager.inLobby=!1,this.playerState.isHost=!1),this.playerState.players.clear(),this.combatController.projectiles.clear(),this.objectsManager.ammoBoxes.clear(),this.decalsManager.decals.clear(),this.particlesManager.particles.clear(),this.particlesManager.emitters.clear(),this.upgradeManager.upgradesCompleted.clear(),this.ammoReservesUIController.reserveBulletParticles=[],"Room"===t&&this.lobbyManager.lobbyPlayers.clear(),this.clearCtx(),this.chatManager.clearChat(),this.ui.clearLeaderboard(),this.playerState.resetPlayerState(),this.playerState.initPlayer(this.userId),this.upgradeManager.resetUpgrades(this.playerState.myPlayer)}startUpgradePhase(t){console.log("Starting upgrade phase..."),this.upgradeManager.upgradesCompleted.clear(),t===this.userId?this.showWinnerWaitScreen():this.showUpgradeSelection()}showWinnerWaitScreen(){if(!this.ui.upgradeContainer)return;this.ui.upgradeContainer.innerHTML="";const t=document.createElement("div");t.className="upgrade_waiting",t.textContent="Waiting for other players...",this.ui.upgradeContainer.appendChild(t),this.ui.upgradeContainer.style.display="flex"}showWinnerContinueButton(){if(!this.ui.upgradeContainer)return;this.ui.upgradeContainer.innerHTML="";const t=document.createElement("div");t.className="upgrade_waiting",t.textContent="Upgrade phase complete.";const e=document.createElement("button");e.textContent="Continue",e.onclick=()=>{this.ui.upgradeContainer&&(console.log("Winner pressed continue..."),this.ui.upgradeContainer.style.display="none",setTimeout(()=>{this.startNewRound()},500))},this.ui.upgradeContainer.appendChild(t),this.ui.upgradeContainer.appendChild(e),this.ui.upgradeContainer.style.display="flex"}showUpgradeSelection(){this.ui.upgradeContainer&&(this.ui.upgradeContainer.innerHTML="",this.upgradeManager.getUpgrades(3,this.playerState.myPlayer).forEach(t=>{const e=document.createElement("div");e.className="upgrade_card",e.setAttribute("data-rarity",t.rarity.toString());const a=document.createElement("div");a.className="upgrade_image";const s=document.createElement("img");s.src=t.icon,s.alt=t.name,s.className="upgrade_icon",s.onerror=()=>{console.warn(`Failed to load upgrade image: ${t.icon}`),s.style.display="none"},a.appendChild(s);const r=document.createElement("div");r.className="upgrade_name",r.textContent=t.name;const i=document.createElement("div");i.className="upgrade_subtitle",i.textContent=t.subtitle,e.appendChild(a),e.appendChild(r),e.appendChild(i),e.addEventListener("click",()=>{console.log("Selected upgrade: ",t.name),this.selectUpgrade(t.id)}),this.ui.upgradeContainer&&this.ui.upgradeContainer.appendChild(e)}),this.ui.upgradeContainer.style.display="flex")}selectUpgrade(t){this.upgradeManager.applyUpgrade(t,this.playerState.myPlayer)?this.finishUpgrade(t):console.error("Failed to apply upgrade")}finishUpgrade(t){this.ui.upgradeContainer&&(this.ui.upgradeContainer.style.display="none"),this.roomManager.sendMessage(JSON.stringify({type:"upgrade-taken",upgradeId:t,userId:this.userId,isUnique:this.upgradeManager.upgrades.find(e=>e.id===t)?.unique||!1})),this.roomManager.sendMessage(JSON.stringify({type:"player-state",id:this.playerState.myPlayer.id,timestamp:this.playerState.myPlayer.timestamp,color:this.playerState.myPlayer.color,transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},actions:{dash:{cooldown:this.playerState.myPlayer.actions.dash.cooldown,drain:this.playerState.myPlayer.actions.dash.drain,multiplier:this.playerState.myPlayer.actions.dash.multiplier,time:this.playerState.myPlayer.actions.dash.time},melee:{cooldown:this.playerState.myPlayer.actions.melee.cooldown,damage:this.playerState.myPlayer.actions.melee.damage,duration:this.playerState.myPlayer.actions.melee.duration,range:this.playerState.myPlayer.actions.melee.range,size:this.playerState.myPlayer.actions.melee.size},primary:{buffer:this.playerState.myPlayer.actions.primary.buffer,burst:{amount:this.playerState.myPlayer.actions.primary.burst.amount,delay:this.playerState.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.playerState.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.playerState.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.playerState.myPlayer.actions.primary.magazine.maxReserve,size:this.playerState.myPlayer.actions.primary.magazine.size},offset:this.playerState.myPlayer.actions.primary.offset,projectile:{amount:this.playerState.myPlayer.actions.primary.projectile.amount,color:this.playerState.myPlayer.actions.primary.projectile.color,damage:this.playerState.myPlayer.actions.primary.projectile.damage,length:this.playerState.myPlayer.actions.primary.projectile.length,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,spread:this.playerState.myPlayer.actions.primary.projectile.spread},reload:{time:this.playerState.myPlayer.actions.primary.reload.time}},sprint:{drain:this.playerState.myPlayer.actions.sprint.drain,multiplier:this.playerState.myPlayer.actions.sprint.multiplier}},equipment:this.playerState.myPlayer.equipment,physics:{acceleration:this.playerState.myPlayer.physics.acceleration,friction:this.playerState.myPlayer.physics.friction},rig:{body:this.playerState.myPlayer.rig.body,head:this.playerState.myPlayer.rig.head,headwear:this.playerState.myPlayer.rig.headwear,weapon:this.playerState.myPlayer.rig.weapon},stats:{health:{max:this.playerState.myPlayer.stats.health.max,value:this.playerState.myPlayer.stats.health.max},luck:this.playerState.myPlayer.stats.luck,size:this.playerState.myPlayer.stats.size,speed:this.playerState.myPlayer.stats.speed,stamina:{max:this.playerState.myPlayer.stats.stamina.max,recovery:{delay:this.playerState.myPlayer.stats.stamina.recovery.delay,rate:this.playerState.myPlayer.stats.stamina.recovery.rate},value:this.playerState.myPlayer.stats.stamina.max}},unique:this.playerState.myPlayer.unique})),console.log("Upgrade selected, waiting for others...")}toggleEquipment(t){this.upgradeManager.hasEquipment(this.playerState.myPlayer,t)&&("test_equipment_id"===t||console.warn(`Unknown equipment: ${t}`))}clearCtx(t){t?t.clearRect(0,0,y,c):this.ui.decalCtx&&this.ui.ctx&&(this.ui.ctx.clearRect(0,0,y,c),this.ui.decalCtx.clearRect(0,0,y,c))}drawCharacter(e,a=!1){if(!this.ui.ctx)return;if(e.stats.health.value<=0)return;this.drawCharacterLayer(e,"BODY",e.rig.body),this.drawCharacterLayer(e,"WEAPON",e.rig.weapon),this.drawCharacterLayer(e,"HEAD",e.rig.head),this.drawCharacterLayer(e,"HEADWEAR",e.rig.headwear),this.ui.ctx.fillStyle="#fff",this.ui.ctx.font="12px Arial",this.ui.ctx.textAlign="center";const s=a?"You":e.id.substring(0,6);this.ui.ctx.fillText(s,e.transform.pos.x,e.transform.pos.y-t.VISUAL.ID_DISPLAY_OFFSET)}drawCharacterLayer(t,e,a){if(!this.ui.ctx)return;const s=function(t,e){switch(t){case"BODY":return A[e]||A.DEFAULT;case"WEAPON":return C[e]||C.GLOCK;case"HEAD":return x[e]||x.DEFAULT;case"HEADWEAR":return b[e]||b.DEFAULT;default:throw new Error(`Unknown character layer: ${t}`)}}(e,a);"string"==typeof s?this.drawCharacterPart(t,s,e):Array.isArray(s)&&s.forEach((a,s)=>{this.drawCharacterPart(t,a,e,s)})}drawCharacterPart(t,e,a,s){if(!this.ui.ctx)return;let r=this.renderingManager.characterImages.get(e);if(!r&&(r=new Image,r.src=e,this.renderingManager.characterImages.set(e,r),!r.complete))return;if(!r.complete||0===r.naturalWidth)return;const i=t.stats.size/650*650,o=`${t.id}_${a}_${s||0}`,n=this.animator.characterOffsets?.get(o)||{x:0,y:0};this.ui.ctx.save(),void 0!==t.transform.rot?(this.ui.ctx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.ctx.rotate(t.transform.rot),this.ui.ctx.translate(n.x,n.y),this.ui.ctx.drawImage(r,-i/2,-i/2,i,i)):this.ui.ctx.drawImage(r,t.transform.pos.x-i/2+n.x,t.transform.pos.y-i/2+n.y,i,i),this.ui.ctx.restore()}drawObjects(){this.ui.ctx&&this.objectsManager.ammoBoxes.forEach(t=>{if(!this.ui.ctx)return;this.renderingManager.ammoBoxImages||(this.renderingManager.ammoBoxImages={});const e=["BASE","BULLETS","LID"];if(e.forEach(t=>{if(!this.renderingManager.ammoBoxImages[t]){const e=new Image;e.src=m[t],this.renderingManager.ammoBoxImages[t]=e}}),!e.every(t=>this.renderingManager.ammoBoxImages[t]?.complete&&this.renderingManager.ammoBoxImages[t]?.naturalWidth>0))return;const a=35,s=t.transform.pos.x,r=t.transform.pos.y;t.isOpen&&(t.lid.velocity.x*=.85,t.lid.velocity.y*=.85,t.lid.torque*=.85,t.lid.pos.x+=t.lid.velocity.x,t.lid.pos.y+=t.lid.velocity.y,t.lid.rot+=t.lid.torque),this.ui.ctx.save(),this.ui.ctx.translate(s,r),this.ui.ctx.rotate(t.transform.rot||0),this.ui.ctx.drawImage(this.renderingManager.ammoBoxImages.BASE,-17.5,-17.5,a,a),t.isOpen||(this.ui.ctx.drawImage(this.renderingManager.ammoBoxImages.BULLETS,-17.5,-17.5,a,a),this.ui.ctx.drawImage(this.renderingManager.ammoBoxImages.LID,-17.5,-17.5,a,a)),this.ui.ctx.restore(),t.isOpen&&(this.ui.ctx.save(),this.ui.ctx.translate(s+t.lid.pos.x,r+t.lid.pos.y),this.ui.ctx.rotate((t.transform.rot||0)+t.lid.rot),this.ui.ctx.drawImage(this.renderingManager.ammoBoxImages.LID,-17.5,-17.5,a,a),this.ui.ctx.restore())})}drawProjectile(t){if(!this.ui.ctx)return;const e=Math.sqrt(t.velocity.x*t.velocity.x+t.velocity.y*t.velocity.y),a=t.velocity.x/e,s=t.velocity.y/e,r=t.transform.pos.x+a*(t.length/2),i=t.transform.pos.y+s*(t.length/2),o=t.transform.pos.x-a*(t.length/2),n=t.transform.pos.y-s*(t.length/2);this.ui.ctx.fillStyle=t.color,this.ui.ctx.strokeStyle=t.color,this.ui.ctx.lineWidth=t.size,this.ui.ctx.lineCap="round",this.ui.ctx.beginPath(),this.ui.ctx.moveTo(o,n),this.ui.ctx.lineTo(r,i),this.ui.ctx.stroke()}drawParticles(){this.ui.ctx&&this.particlesManager.particles.forEach(t=>{const e=this.utility.hexToRgb(t.color);e&&this.ui.ctx&&(this.ui.ctx.save(),this.ui.ctx.globalAlpha=t.opacity,0!==t.torque?(this.ui.ctx.translate(t.pos.x+t.size/2,t.pos.y+t.size/2),this.ui.ctx.rotate(t.rotation),this.ui.ctx.fillStyle=`rgb(${e.r}, ${e.g}, ${e.b})`,this.ui.ctx.fillRect(-t.size/2,-t.size/2,t.size,t.size)):(this.ui.ctx.fillStyle=`rgb(${e.r}, ${e.g}, ${e.b})`,this.ui.ctx.fillRect(Math.floor(t.pos.x),Math.floor(t.pos.y),t.size,t.size)),this.ui.ctx.restore())})}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new st}):new st})();