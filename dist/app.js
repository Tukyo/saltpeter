(()=>{var t={65:(t,e,a)=>{var s={"./clustermodule/clustermodule":224,"./clustermodule/clustermodule.ts":224,"./kineticbrain/kineticbrain":748,"./kineticbrain/kineticbrain.ts":748,"./muzzlesplitter/muzzlesplitter":358,"./muzzlesplitter/muzzlesplitter.ts":358,"./phoenixmodule/phoenixmodule":96,"./phoenixmodule/phoenixmodule.ts":96,"./projectilearray/projectilearray":800,"./projectilearray/projectilearray.ts":800,"./spatialtargeting/spatialtargeting":88,"./spatialtargeting/spatialtargeting.ts":88,"./spectralimage/spectralimage":368,"./spectralimage/spectralimage.ts":368};function i(t){var e=r(t);return a(e)}function r(t){if(!a.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}i.keys=function(){return Object.keys(s)},i.resolve=r,t.exports=i,i.id=65},88:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"spatial_targeting",name:"Spatial Targeting",subtitle:"Projectile upgrade that syncs its spatial awareness with the user.",icon:"/assets/img/icon/upgrades/unique/spatialtargeting.png",type:s.T.UNIQUE,rarity:s._.SUPERIOR,unique:!0,func:t=>{t.unique.includes("spatial_targeting")||t.unique.push("spatial_targeting")}}}},96:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"phoenix_module",name:"Phoenix Module",subtitle:"Return from the flames with vengeance.",icon:"/assets/img/icon/upgrades/unique/phoenixmodule.png",type:s.T.UNIQUE,rarity:s._.LEGENDARY,unique:!0,func:t=>{t.unique.includes("phoenix_module")||t.unique.push("phoenix_module")}}}},136:(t,e,a)=>{var s={"./carepackage/carepackage":751,"./carepackage/carepackage.ts":751};function i(t){var e=r(t);return a(e)}function r(t){if(!a.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}i.keys=function(){return Object.keys(s)},i.resolve=r,t.exports=i,i.id=136},152:(t,e,a)=>{"use strict";var s,i;a.d(e,{T:()=>i,_:()=>s}),function(t){t[t.COMMON=0]="COMMON",t[t.UNCOMMON=1]="UNCOMMON",t[t.SPECIAL=2]="SPECIAL",t[t.SUPERIOR=3]="SUPERIOR",t[t.RARE=4]="RARE",t[t.EXCEPTIONAL=5]="EXCEPTIONAL",t[t.LEGENDARY=6]="LEGENDARY",t[t.MYTHICAL=7]="MYTHICAL",t[t.ENLIGHTENED=8]="ENLIGHTENED",t[t.HOLY=9]="HOLY"}(s||(s={})),function(t){t.EQUIPMENT="equipment",t.RESOURCE="resource",t.STAT="stat",t.UNIQUE="unique"}(i||(i={}))},168:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"hemoglobin_saturator",name:"Hemoglobin Saturator",subtitle:"Increases red blood cell density for extended durability.",icon:"/assets/img/icon/upgrades/stats/hemoglobinsaturator.png",type:s.T.STAT,rarity:s._.UNCOMMON,unique:!1,func:e=>{t.playerState.updateStat("stats.health.max",e.stats.health.max+10),t.playerState.updateStat("stats.health.value",e.stats.health.max)}}}},204:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"locomotion_module",name:"Locomotion Module",subtitle:"Primitave locomotion module installed on the user's footwear.",icon:"/assets/img/icon/upgrades/stats/locomotionmodule.png",type:s.T.STAT,rarity:s._.COMMON,unique:!1,func:e=>{t.playerState.updateStat("stats.speed",e.stats.speed+1),t.playerState.updateStat("actions.dash.cooldown",1.5*e.actions.dash.cooldown)}}}},224:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"cluster_module",name:"Cluster Module",subtitle:"Cluster enhancement module for primary attacks.",icon:"/assets/img/icon/upgrades/unique/clustermodule.png",type:s.T.UNIQUE,rarity:s._.RARE,unique:!0,func:t=>{t.unique.includes("cluster_module")||t.unique.push("cluster_module")}}}},358:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"muzzle_splitter",name:"Muzzle Splitter",subtitle:"Muzzle modification for primary attacks, requires certain skillset.",icon:"/assets/img/icon/upgrades/unique/muzzlesplitter.png",type:s.T.UNIQUE,rarity:s._.SPECIAL,unique:!0,func:t=>{t.unique.includes("muzzle_splitter")||t.unique.push("muzzle_splitter")}}}},368:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"spectral_image",name:"Spectral Image",subtitle:"Forward imaging coordinate transponder.",icon:"/assets/img/icon/upgrades/unique/spectralimage.png",type:s.T.UNIQUE,rarity:s._.EXCEPTIONAL,unique:!0,func:e=>{e.unique.includes("spectral_image")||(e.unique.push("spectral_image"),t.playerState.updateStat("actions.dash.time",e.actions.dash.time+50))}}}},528:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"bioregulator",name:"Bioregulator",subtitle:"Increases energy regulation efficiency, with a small boot overhead.",icon:"/assets/img/icon/upgrades/stats/bioregulator.png",type:s.T.STAT,rarity:s._.COMMON,unique:!1,func:e=>{t.playerState.updateStat("stats.stamina.max",1.1*e.stats.stamina.max),t.playerState.updateStat("stats.stamina.recovery.rate",e.stats.stamina.recovery.rate+1),t.playerState.updateStat("stats.stamina.recovery.delay",1.25*e.stats.stamina.recovery.delay)}}}},612:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"damage_buffer",name:"Damage Buffer",subtitle:"Type D125 buffer, which improves damage at a small cost. ",icon:"/assets/img/icon/upgrades/stats/damagebuffer.png",type:s.T.STAT,rarity:s._.UNCOMMON,unique:!1,func:e=>{t.playerState.updateStat("actions.primary.projectile.damage",1.1*e.actions.primary.projectile.damage),t.playerState.updateStat("actions.primary.buffer",1.1*e.actions.primary.buffer)}}}},617:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"switch",name:"Switch",subtitle:"Completely legal and completely functional.",icon:"/assets/img/icon/upgrades/equipment/switch.png",type:s.T.EQUIPMENT,rarity:s._.RARE,unique:!1,func:e=>{e.equipment.includes("switch")||(e.equipment.push("switch"),t.playerState.updateStat("actions.primary.projectile.spread",e.actions.primary.projectile.spread*=1.15))}}}},748:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"kinetic_brain",name:"Kinetic Brain",subtitle:"Cerebral kinetic stem implant, unable to function at maximum capacity.",icon:"/assets/img/icon/upgrades/unique/kineticbrain.png",type:s.T.UNIQUE,rarity:s._.EXCEPTIONAL,unique:!0,func:t=>{t.unique.includes("kinetic_brain")||t.unique.push("kinetic_brain")}}}},751:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"care_package",name:"Care Package",subtitle:"These are hard to come by.",icon:"/assets/img/icon/upgrades/resource/carepackage.png",type:s.T.RESOURCE,rarity:s._.COMMON,unique:!1,func:e=>{e.actions.primary.magazine.currentReserve+=20,t.ui.ammoReservesUIController.spawnAmmoInReserveUI(20)}}}},800:(t,e,a)=>{"use strict";a.r(e),a.d(e,{create:()=>i});var s=a(152);function i(t){return{id:"projectile_array",name:"Projectile Array",subtitle:"Chance to fire an array of extra projectiles.",icon:"/assets/img/icon/upgrades/unique/projectilearray.png",type:s.T.UNIQUE,rarity:s._.RARE,unique:!0,func:t=>{t.unique.includes("projectile_array")||t.unique.push("projectile_array")}}}},823:(t,e,a)=>{var s={"./bioregulator/bioregulator":528,"./bioregulator/bioregulator.ts":528,"./damagebuffer/damagebuffer":612,"./damagebuffer/damagebuffer.ts":612,"./hemoglobinsaturator/hemoglobinsaturator":168,"./hemoglobinsaturator/hemoglobinsaturator.ts":168,"./locomotionmodule/locomotionmodule":204,"./locomotionmodule/locomotionmodule.ts":204};function i(t){var e=r(t);return a(e)}function r(t){if(!a.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}i.keys=function(){return Object.keys(s)},i.resolve=r,t.exports=i,i.id=823},854:(t,e,a)=>{var s={"./switch/switch":617,"./switch/switch.ts":617};function i(t){var e=r(t);return a(e)}function r(t){if(!a.o(s,t)){var e=new Error("Cannot find module '"+t+"'");throw e.code="MODULE_NOT_FOUND",e}return s[t]}i.keys=function(){return Object.keys(s)},i.resolve=r,t.exports=i,i.id=854}},e={};function a(s){var i=e[s];if(void 0!==i)return i.exports;var r=e[s]={exports:{}};return t[s](r,r.exports,a),r.exports}a.d=(t,e)=>{for(var s in e)a.o(e,s)&&!a.o(t,s)&&Object.defineProperty(t,s,{enumerable:!0,get:e[s]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),a.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},(()=>{"use strict";const t=8,e=["/assets/img/effects/shrapnel/shrapnel_00.png","/assets/img/effects/shrapnel/shrapnel_01.png","/assets/img/effects/shrapnel/shrapnel_02.png","/assets/img/effects/shrapnel/shrapnel_03.png","/assets/img/effects/shrapnel/shrapnel_04.png","/assets/img/effects/shrapnel/shrapnel_05.png"],s={BASE:"/assets/img/object/ammobox/base.png",BULLETS:"/assets/img/object/ammobox/bullets.png",LID:"/assets/img/object/ammobox/lid.png"},i=800,r=600,o=15,n={A:0,B:1,X:2,Y:3,LB:4,RB:5,LT:6,RT:7,SELECT:8,START:9,L_STICK:10,R_STICK:11,DPAD_UP:12,DPAD_DOWN:13,DPAD_LEFT:14,DPAD_RIGHT:15,HOME:16,AXES:{LEFT_STICK_X:0,LEFT_STICK_Y:1,RIGHT_STICK_X:2,RIGHT_STICK_Y:3}},l={CHARACTER_SIZE:650,CONNECTION_TIMEOUT:1e3,CONTROLS:{KEYBINDS:{MELEE:"mouse2",MOVE_UP:"w",MOVE_LEFT:"a",MOVE_DOWN:"s",MOVE_RIGHT:"d",RELOAD:"r",SPRINT:"shift",ATTACK:"mouse1",DASH:" "},GAMEPAD:{MELEE:n.RB,DASH:n.LB,DEADZONE:.2,RELOAD:n.A,SPRINT:n.LT,ATTACK:n.RT}},GAME_END_DELAY:5e3,GRAPHICS:{PHYSICS:{AMMORESERVES:!0},STATIC_OVERLAY:!0,BACKGROUND_PARTICLES:!0},MAX_PLAYERS:4,MAX_WINS:5,RECONNECT_DELAY:3e3,ROUND_END_DELAY:3e3,NEW_ROUND_DELAY:500},h={KEYS:["Control","Shift","Alt","-","+"],REQUIRED_COUNT:5};class m{constructor(t,e){this.cacheManager=t,this.ui=e,this.adminKeysHeld=new Set,this.initKeyListener(),this.initConsoleKeybinds()}initKeyListener(){window.addEventListener("keydown",t=>{this.adminKeysHeld.add(t.key),this.checkAdminCombo()}),window.addEventListener("keyup",t=>{this.adminKeysHeld.delete(t.key)})}checkAdminCombo(){h.KEYS.every(t=>this.adminKeysHeld.has(t))&&this.adminKeysHeld.size===h.REQUIRED_COUNT&&(this.adminKeysHeld.clear(),this.showAdminModal())}showAdminModal(){this.ui.modal&&this.ui.modalInput&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalErrorDiv&&this.ui.modalText&&(this.ui.modal.classList.remove("hidden"),this.ui.modalConfirmButton.classList.remove("hidden"),this.ui.modalInput.value="",this.ui.modalInput.style.display="block",this.ui.modalErrorDiv.textContent="",this.ui.modalText.textContent="Enter Admin Command.",this.ui.modalConfirmButton.textContent="Execute",this.ui.modalCancelButton.textContent="Cancel",this.ui.modalInput.focus(),this.ui.modalConfirmButton.onclick=()=>{if(!this.ui.modalInput||!this.ui.modalErrorDiv)return;const t=this.ui.modalInput.value.trim();if(!t.includes(":"))return void(this.ui.modalErrorDiv.textContent="Invalid format.");const[e,a]=t.split(":");e&&a?(this.executeAdminCommand(e.trim(),a.trim()),this.ui.closeModal()):this.ui.modalErrorDiv.textContent="Invalid format."},this.ui.modalCancelButton.onclick=()=>this.ui.closeModal())}executeAdminCommand(t,e){console.log(`Admin command: ${t} with key: ${e}`),this.onAdminCommand?.(t,e)}initConsoleKeybinds(){document.addEventListener("keydown",t=>{t.getModifierState("Control")&&"`"===t.key&&(t.preventDefault(),this.clearCacheCommand())})}clearCacheCommand(){this.cacheManager.clear().then(()=>{console.log("Cache cleared! Reload the page."),location.reload()})}}class c{constructor(t,e,a){this.playerState=t,this.roomManager=e,this.userId=a,this.characterAnimations=new Map,this.characterOffsets=new Map}animateCharacterPart(t){this.generateCharacterAnimation(t),this.roomManager.sendMessage(JSON.stringify({type:"character-animation",params:t}))}rotateCharacterPart(t,e){if(t===this.userId)this.playerState.myPlayer.transform.rot=e;else{const a=this.playerState.players.get(t);if(!a)return;a.transform.rot=e}const a=Date.now();Math.abs(e-this.playerState.lastSentRotation)>.1&&a-this.playerState.lastSentRotationTime>=25&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{rot:this.playerState.myPlayer.transform.rot}})),this.playerState.lastSentRotation=e,this.playerState.lastSentRotationTime=a)}animateCharacterPartNetwork(t){this.generateCharacterAnimation(t)}generateCharacterAnimation(t){const{playerId:e,part:a,frames:s,duration:i,partIndex:r}=t,o=`${e}_${a}_${r||0}`;this.characterAnimations.set(o,{playerId:e,part:a,partIndex:r,frames:s,duration:i,startTime:Date.now(),originalOffset:{x:0,y:0}})}updateCharacterAnimations(t){const e=[],a=Date.now();this.characterAnimations.forEach((t,s)=>{const i=(a-t.startTime)/t.duration;if(0!==t.duration&&i>=1)return void e.push(s);const r=Object.keys(t.frames).map(Number).sort((t,e)=>t-e);let o,n,l=0;for(let t=0;t<r.length-1;t++){const e=r[t],a=r[t+1];if(i>=e&&i<a){l=t;break}}if(i>=1){const e=t.frames[r[r.length-1]];o=e.x,n=e.y}else{const e=t.frames[r[l]],a=t.frames[r[l+1]]||e,s=(i-r[l])/(r[l+1]-r[l])||0;o=e.x+(a.x-e.x)*s,n=e.y+(a.y-e.y)*s}this.characterOffsets.set(s,{x:o,y:n})}),e.forEach(t=>{this.characterAnimations.delete(t),this.characterOffsets&&this.characterOffsets.delete(t)})}clearAllAnimations(){this.characterAnimations.clear(),this.characterOffsets.clear()}}class d{constructor(t=10,e=5){this.poolSize=t,this.maxConcurrent=e,this.pools=new Map,this.activeAudio=new Map}createPool(t){const e=[];for(let a=0;a<this.poolSize;a++){const a=new Audio(t);a.preload="auto",a.addEventListener("ended",()=>this.returnToPool(t,a)),a.addEventListener("pause",()=>this.returnToPool(t,a)),e.push(a)}return e}returnToPool(t,e){const a=this.activeAudio.get(t);if(a){const t=a.indexOf(e);t>-1&&a.splice(t,1)}const s=this.pools.get(t);s&&!s.includes(e)&&s.push(e)}getAudio(t){const e=this.activeAudio.get(t)||[];if(e.length>=this.maxConcurrent)return null;let a=this.pools.get(t);a||(a=this.createPool(t),this.pools.set(t,a),this.activeAudio.set(t,[]));const s=a.pop();return s?(s.currentTime=0,s.volume=1,s.playbackRate=1,s.loop=!1,e.push(s),s):null}preloadSound(t){if(!this.pools.has(t)){const e=this.createPool(t);this.pools.set(t,e),this.activeAudio.set(t,[])}}}class y{constructor(t,e,a,s){this.audioConfig=t,this.roomManager=e,this.settingsManager=a,this.utility=s,this.audioPool=new d(this.audioConfig.settings.poolSize,this.audioConfig.settings.maxConcurrent)}playAudio(t){const e=this.audioPool.getAudio(t.src);if(!e)return void console.warn(`Audio pool exhausted or max concurrent reached for: ${t.src}`);let a=1;t.volume&&(a=t.volume.min+Math.random()*(t.volume.max-t.volume.min));const s=t.spatial?.blend??0;if(s>0&&t.spatial?.pos){const e=t.spatial.pos.x-t.listener.x,o=t.spatial.pos.y-t.listener.y,n=Math.sqrt(e*e+o*o);let l;if(t.spatial.rolloff){const e=t.spatial.rolloff.type||"linear",a=t.spatial.rolloff.factor,s=t.spatial.rolloff.distance;if("logarithmic"===e){const t=s*a;if(n<t)l=1;else{const e=(n-t)/(s-t);l=Math.max(0,1-Math.pow(e,.5))}}else l=Math.max(0,1-n/s*a)}else{const t=Math.max(i,r);l=Math.max(0,1-n/t)}a*=1-s+l*s}const o=t.output?.toLowerCase()||null,n=this.settingsManager.getSettings().audio.mixer;if(o&&void 0!==n[o]&&(a*=n[o]),a*=this.settingsManager.getSettings().audio.mixer.master,e.volume=Math.max(0,Math.min(1,a)),t.pitch){const a=t.pitch.min+Math.random()*(t.pitch.max-t.pitch.min);e.playbackRate=Math.max(.25,Math.min(4,a))}void 0!==t.loop&&(e.loop=t.loop);let l=0;t.delay&&(l=1e3*(t.delay.min+Math.random()*(t.delay.max-t.delay.min))),this.utility.safeTimeout(()=>{e.play().catch(t=>{console.warn("Audio play failed:",t)})},l)}playAudioNetwork(t){this.playAudio(t),this.roomManager.sendMessage(JSON.stringify({type:"play-audio",params:t}))}preloadAudioAssets(t,e){this.preloadSFX(t,e)}preloadSFX(t,e){for(const a in t){const s=t[a];Array.isArray(s)?s.forEach(t=>{"string"==typeof t&&t.endsWith(e)&&this.audioPool.preloadSound(t)}):"object"==typeof s&&null!==s&&this.preloadSFX(s,e)}}}class u{constructor(){this.dbName="SaltpeterCache",this.dbVersion=1,this.db=null,this.initDB()}async initDB(){return new Promise((t,e)=>{const a=indexedDB.open(this.dbName,this.dbVersion);a.onerror=()=>e(a.error),a.onsuccess=()=>{this.db=a.result,t()},a.onupgradeneeded=t=>{const e=t.target.result;e.objectStoreNames.contains("settings")||e.createObjectStore("settings")}})}async write(t,e){return this.db||await this.initDB(),new Promise((a,s)=>{const i=this.db.transaction(["settings"],"readwrite").objectStore("settings").put(e,t);i.onerror=()=>s(i.error),i.onsuccess=()=>a()})}async read(t){return this.db||await this.initDB(),new Promise((e,a)=>{const s=this.db.transaction(["settings"],"readonly").objectStore("settings").get(t);s.onerror=()=>a(s.error),s.onsuccess=()=>e(s.result)})}async delete(t){return this.db||await this.initDB(),new Promise((e,a)=>{const s=this.db.transaction(["settings"],"readwrite").objectStore("settings").delete(t);s.onerror=()=>a(s.error),s.onsuccess=()=>e()})}async clear(){return this.db||await this.initDB(),new Promise((t,e)=>{const a=this.db.transaction(["settings"],"readwrite").objectStore("settings").clear();a.onerror=()=>e(a.error),a.onsuccess=()=>t()})}}class p{constructor(){this.weapon={glock:["/assets/img/weapon/glock/body.png","/assets/img/weapon/glock/slide.png"],knife:["/assets/img/weapon/melee/knife_00.png"]},this.magazine={glock:{empty:"/assets/img/object/weapons/glock/magazine_empty.png",full:"/assets/img/object/weapons/glock/magazine_full.png"}},this.body={default:"/assets/img/char/body/default.png"},this.head={default:"/assets/img/char/head/default.png",blondeAfro:"/assets/img/char/head/blonde_afro.png"},this.headwear={default:"/assets/img/char/headwear/default.png",fez:"/assets/img/char/headwear/fez.png",strawHat:"/assets/img/char/headwear/straw_hat.png",trucker:"/assets/img/char/headwear/trucker.png"},this.upgrades={kineticBrain:"/assets/img/char/upgrades/kineticbrain.png"},this.characterDecals={default:{blood:["/assets/img/effects/blood/blood_00.png","/assets/img/effects/blood/blood_01.png","/assets/img/effects/blood/blood_02.png","/assets/img/effects/blood/blood_03.png","/assets/img/effects/blood/blood_04.png"],gore:["/assets/img/effects/gore/gore_00.png","/assets/img/effects/gore/gore_01.png","/assets/img/effects/gore/gore_02.png","/assets/img/effects/gore/gore_03.png","/assets/img/effects/gore/gore_04.png","/assets/img/effects/gore/gore_05.png","/assets/img/effects/gore/gore_06.png","/assets/img/effects/gore/gore_07.png","/assets/img/effects/gore/gore_08.png","/assets/img/effects/gore/gore_09.png","/assets/img/effects/gore/gore_10.png","/assets/img/effects/gore/gore_11.png","/assets/img/effects/gore/gore_12.png","/assets/img/effects/gore/gore_13.png"]}}}}class g{constructor(t){this.charConfig=t}getCharacterAsset(t,e){switch(t){case"BODY":return this.charConfig.body[e]||this.charConfig.body.default;case"WEAPON":return this.charConfig.weapon[e]||this.charConfig.weapon.glock;case"HEAD":return this.charConfig.head[e]||this.charConfig.head.default;case"HEADWEAR":return this.charConfig.headwear[e]||this.charConfig.headwear.default;case"UPGRADES":return e;default:throw new Error(`Unknown character layer: ${t}`)}}getUpgradeVisual(t){const e=t.toLowerCase();return this.charConfig.upgrades[e]||null}}class f{constructor(t,e){this.roomManager=t,this.ui=e}sendChatMessage(t){if(!this.ui.chatInput||!this.ui.chatInput.value.trim())return;const e=this.ui.chatInput.value.trim();e.length>200?alert("Message too long! Max 200 characters."):(this.roomManager.sendMessage(JSON.stringify({type:"chat-message",message:e,timestamp:Date.now()})),this.displayChatMessage({senderId:t,message:e,isOwn:!0}),this.ui.chatInput.value="")}displayChatMessage(t){if(!this.ui.chatMessages)return;const{senderId:e,message:a,isOwn:s=!1}=t,i=document.createElement("div");i.className="chat_message "+(s?"own":"other");const r=document.createElement("span");r.className="sender",r.textContent=s?"You:":`${e}:`;const o=document.createElement("span");for(o.className="content",o.textContent=a,i.appendChild(r),i.appendChild(o),this.ui.chatMessages.appendChild(i),this.ui.chatMessages.scrollTop=this.ui.chatMessages.scrollHeight;this.ui.chatMessages.children.length>100;)this.ui.chatMessages.removeChild(this.ui.chatMessages.firstChild)}clearChat(){this.ui.chatMessages&&(this.ui.chatMessages.innerHTML=""),this.ui.chatInput&&(this.ui.chatInput.value="")}}class S{constructor(t){this.settingsManager=t,this.activeKeys=new Set,this.gamepadKeys=new Set,this.previousKeys=new Set,this.mousePos={x:0,y:0},this.gamepadConnected=!1,this.gamepadConnectionEnabled=!0,this.gamepadRAxis=null,this.initGamepad()}held(t){return this.activeKeys.has(t)}triggered(t){return this.activeKeys.has(t)&&!this.previousKeys.has(t)}getActiveKeys(){return this.activeKeys}addKey(t){this.activeKeys.add(t)}removeKey(t){this.activeKeys.delete(t)}clearActiveKeys(){this.activeKeys.clear()}updatePreviousKeys(){this.previousKeys=new Set(this.activeKeys)}getMousePos(){return this.mousePos}setMousePos(t){this.mousePos.x=t.x,this.mousePos.y=t.y}initGamepad(){window.addEventListener("gamepadconnected",()=>{console.log("Gamepad connected!"),this.gamepadConnected=!0}),window.addEventListener("gamepaddisconnected",()=>{console.log("Gamepad disconnected!"),this.gamepadConnected=!1})}pollGamepad(){if(!this.gamepadConnected)return;const t=navigator.getGamepads()[0];if(!t)return;const e=this.settingsManager.getSettings(),a=e.controls.keybinds,s=e.controls.gamepad,i=s.deadzone;this.gamepadKeys.forEach(t=>this.activeKeys.delete(t)),this.gamepadKeys.clear();const r=t.axes[0],o=t.axes[1];r>i&&(this.activeKeys.add(a.moveRight),this.gamepadKeys.add(a.moveRight)),r<-i&&(this.activeKeys.add(a.moveLeft),this.gamepadKeys.add(a.moveLeft)),o>i&&(this.activeKeys.add(a.moveDown),this.gamepadKeys.add(a.moveDown)),o<-i&&(this.activeKeys.add(a.moveUp),this.gamepadKeys.add(a.moveUp)),t.buttons[s.melee].pressed&&(this.activeKeys.add(a.melee),this.gamepadKeys.add(a.melee)),t.buttons[s.dash].pressed&&(this.activeKeys.add(a.dash),this.gamepadKeys.add(a.dash)),t.buttons[s.reload].pressed&&(this.activeKeys.add(a.reload),this.gamepadKeys.add(a.reload)),t.buttons[s.attack].pressed&&(this.activeKeys.add(a.attack),this.gamepadKeys.add(a.attack)),t.buttons[s.sprint].pressed&&(this.activeKeys.add(a.sprint),this.gamepadKeys.add(a.sprint));const n=t.axes[2],l=t.axes[3],h=Math.sqrt(n*n+l*l);this.gamepadRAxis=h>i?Math.atan2(l,n)+Math.PI/2:null}getGamepadRAxis(){return this.gamepadRAxis}}class x{constructor(t,e,a,s,i){this.objectsManager=t,this.playerState=e,this.roomManager=a,this.ui=s,this.userId=i}checkCollisions(t){this.playerState.myPlayer.transform.pos.x=Math.max(15,Math.min(785,this.playerState.myPlayer.transform.pos.x)),this.playerState.myPlayer.transform.pos.y=Math.max(15,Math.min(585,this.playerState.myPlayer.transform.pos.y)),this.checkObjectCollisions(t),this.checkPlayersCollisions(t)}checkObjectCollisions(t){if(!this.collisionsEnabled(this.playerState.myPlayer))return;const e=this.getPlayerCollider(this.playerState.myPlayer,5);this.objectsManager.ammoBoxes.forEach((t,a)=>{if(t.isOpen)return;const s=this.playerState.myPlayer.transform.pos.x-t.transform.pos.x,i=this.playerState.myPlayer.transform.pos.y-t.transform.pos.y;if(Math.sqrt(s*s+i*i)<=e){const e=this.playerState.myPlayer.actions.primary.magazine.currentReserve,s=this.playerState.myPlayer.actions.primary.magazine.maxReserve,i=Math.min(t.ammoAmount,s-e);if(i>0){this.playerState.myPlayer.actions.primary.magazine.currentReserve+=i,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(i),console.log(`Picked up ammo box! +${i} bullets. Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`);const e=Math.random()*Math.PI*2,s=2+3*Math.random();t.isOpen=!0,t.lid.velocity={x:Math.cos(e)*s,y:Math.sin(e)*s},t.lid.torque=.3*(Math.random()-.5),this.roomManager.sendMessage(JSON.stringify({type:"ammo-pickup",ammoBoxId:a,playerId:this.userId,boxState:{isOpen:!0,lid:t.lid}}))}}})}checkPlayersCollisions(t){this.collisionsEnabled(this.playerState.myPlayer)&&this.playerState.players.forEach(t=>{if(!this.collisionsEnabled(t))return;const e=this.playerState.myPlayer.transform.pos.x-t.transform.pos.x,a=this.playerState.myPlayer.transform.pos.y-t.transform.pos.y,s=Math.sqrt(e*e+a*a),i=this.getPlayerCollider(this.playerState.myPlayer)+this.getPlayerCollider(t);if(s<i&&s>.01){const t=i-s,r=e/s*t,o=a/s*t;this.playerState.myPlayer.transform.pos.x+=r,this.playerState.myPlayer.transform.pos.y+=o}})}getPlayerCollider(t,e){let a=t.stats.size/4;return e&&e>0&&(a=t.stats.size/4+e),a}collisionsEnabled(t){return!(t.stats.health.value<=0||t.flags.hidden&&t.flags.invulnerable)}}class C{constructor(){this.decals={projectile:{radius:{min:4,max:8},density:{min:.175,max:.35},opacity:{min:.15,max:.25},variation:.215,colors:["#000000","#191919","#39362d"]},blood:{radius:{min:5,max:17.5},density:{min:.1,max:.175},opacity:{min:.275,max:.315},variation:.5,colors:["#781414","#710606","#a10101"]},explosion:{radius:{min:25,max:40},density:{min:.375,max:.575},opacity:{min:.35,max:.525},variation:.2,colors:["#434343","#2a2a2a","#3b1d1d"]}}}}class b{constructor(t,e,a,s,i,r){this.charConfig=t,this.playerState=e,this.roomManager=a,this.ui=s,this.userId=i,this.utility=r,this.dynamicDecals=new Map,this.staticDecalData=null,this.decalsConfig=new C}createDecal(t){this.generateDecal(t),this.roomManager.sendMessage(JSON.stringify({type:"add-decal",params:t}))}createDecalNetwork(t){this.dynamicDecals.has(t.id)||this.generateDecal(t)}generateDecal(t){if(!this.ui.decalCtx)return;const{x:e,y:a}=t.pos;e<0||e>i||a<0||a>r||("parametric"===t.type&&t.parametric?this.generateParametricDecal(t.pos,t.parametric):"image"===t.type&&t.image&&this.generateImageDecal(t.pos,t.image),this.dynamicDecals.set(t.id,{params:t,pos:{x:e,y:a}}))}generateParametricDecal(t,e){if(!this.ui.decalCtx)return;const a=e.radius.min+Math.random()*(e.radius.max-e.radius.min),s=e.density.min+Math.random()*(e.density.max-e.density.min),o=e.opacity.min+Math.random()*(e.opacity.max-e.opacity.min),n=Math.floor(a*a*Math.PI*s);this.ui.decalCtx.save(),this.ui.decalCtx.globalCompositeOperation="source-over";for(let s=0;s<n;s++){const s=Math.random()*Math.PI*2,n=Math.random()*a,l=t.x+Math.cos(s)*n,h=t.y+Math.sin(s)*n;if(l<0||l>=i||h<0||h>=r)continue;const m=e.colors[Math.floor(Math.random()*e.colors.length)],c=this.utility.hexToRgb(m);if(!c)continue;const d=o+(Math.random()-.5)*e.variation,y=Math.max(.05,Math.min(.6,d));this.ui.decalCtx.fillStyle=`rgba(${c.r}, ${c.g}, ${c.b}, ${y})`,this.ui.decalCtx.fillRect(Math.floor(l),Math.floor(h),1,1)}this.ui.decalCtx.restore()}generateImageDecal(t,e){if(!this.ui.decalCtx)return;let a=new Image;a.src=e.src;const s=()=>{if(!this.ui.decalCtx)return;if(!a.complete||0===a.naturalWidth)return;this.ui.decalCtx.save(),this.ui.decalCtx.translate(t.x,t.y),this.ui.decalCtx.rotate(e.rotation);const s=32*e.scale;this.ui.decalCtx.drawImage(a,-s/2,-s/2,s,s),this.ui.decalCtx.restore()};a.complete?s():a.onload=s}bakeDecals(){if(!this.ui.decalCtx)return;const t=this.ui.decalCtx.getImageData(0,0,i,r);if(this.staticDecalData)for(let e=0;e<t.data.length;e+=4){const a=t.data[e+3];if(a>0){const s=a/255,i=this.staticDecalData.data[e+3]/255;this.staticDecalData.data[e]=t.data[e]*s+this.staticDecalData.data[e]*i*(1-s),this.staticDecalData.data[e+1]=t.data[e+1]*s+this.staticDecalData.data[e+1]*i*(1-s),this.staticDecalData.data[e+2]=t.data[e+2]*s+this.staticDecalData.data[e+2]*i*(1-s),this.staticDecalData.data[e+3]=Math.min(255,a+this.staticDecalData.data[e+3])}}else this.staticDecalData=t;this.dynamicDecals.clear(),this.ui.decalCtx.clearRect(0,0,i,r)}renderBakedDecals(){this.staticDecalData&&this.ui.decalCtx&&this.ui.decalCtx.putImageData(this.staticDecalData,0,0)}spawnMagazineDecal(){setTimeout(()=>{const t=this.playerState.myPlayer.actions.primary.magazine.currentAmmo,e=t>0?this.charConfig.magazine.glock.full:this.charConfig.magazine.glock.empty,a=this.utility.getRandomNum(0,2*Math.PI),s=this.utility.getRandomNum(8,24),i=this.playerState.myPlayer.transform.pos.x+Math.cos(a)*s,r=this.playerState.myPlayer.transform.pos.y+Math.sin(a)*s,o=this.utility.getRandomNum(0,2*Math.PI),n=this.utility.getRandomNum(.65,.75),l={id:`magazine_${this.userId}_${Date.now()}`,pos:{x:i,y:r},type:"image",image:{src:e,scale:n,rotation:o}};this.createDecal(l),console.log(`Spawned ${t>0?"full":"empty"} magazine at reload`)},150)}}class v{constructor(t,e,a,s,i,r,o,n,l){this.animator=t,this.chatManager=e,this.controlsManager=a,this.gameState=s,this.roomController=i,this.playerState=r,this.settingsManager=o,this.ui=n,this.userId=l}initEventListeners(){this.ui.canvas&&this.ui.hostButton&&this.ui.joinButton&&this.ui.quickplayButton&&this.ui.lobbyLeaveButton&&this.ui.lobbyCodeButton&&this.ui.gameLeaveButton&&this.ui.gameCodeButton&&this.ui.startGameBtn&&this.ui.chatSendBtn&&this.ui.chatInput&&(this.ui.hostButton.addEventListener("click",()=>this.roomController.hostRoom()),this.ui.joinButton.addEventListener("click",()=>this.roomController.joinRoom()),this.ui.quickplayButton.addEventListener("click",()=>this.roomController.quickPlay()),this.ui.lobbyLeaveButton.addEventListener("click",()=>this.roomController.leaveRoom()),this.ui.lobbyCodeButton.addEventListener("click",()=>this.roomController.copyRoomCode()),this.ui.gameLeaveButton.addEventListener("click",()=>this.roomController.leaveRoom()),this.ui.gameCodeButton.addEventListener("click",()=>this.roomController.copyRoomCode()),this.ui.startGameBtn.addEventListener("click",()=>this.onStartButtonClick()),this.ui.chatSendBtn.addEventListener("click",()=>this.chatManager.sendChatMessage(this.userId)),this.ui.chatInput.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.chatManager.sendChatMessage(this.userId))}),this.ui.chatInput.addEventListener("focus",()=>{this.controlsManager.clearActiveKeys(),this.playerState.canShoot=!1,this.playerState.isSprinting=!1,this.playerState.isDashing=!1,this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0}),this.ui.chatInput.addEventListener("blur",()=>{this.controlsManager.clearActiveKeys(),this.playerState.canShoot=!0,this.playerState.isSprinting=!1,this.playerState.isDashing=!1}),this.ui.settingsButton?.addEventListener("click",()=>{this.ui.showSettingsPage()}),this.ui.settingsCloseButton?.addEventListener("click",()=>{this.ui.hideSettingsPage()}),window.addEventListener("contextmenu",t=>{t.preventDefault()}),document.addEventListener("keydown",t=>this.onKeyDown(t)),document.addEventListener("keyup",t=>this.onKeyUp(t)),document.addEventListener("mouseup",t=>this.onMouseUp(t)),document.addEventListener("mousemove",t=>this.onMouseMove(t)),this.ui.canvas.addEventListener("mousedown",t=>this.onMouseDown(t)),this.ui.switchSettingsPage("sound"),this.ui.controlsTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("controls")}),this.ui.graphicsTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("graphics")}),this.ui.soundTab?.addEventListener("click",()=>{this.ui.switchSettingsPage("sound")}),this.ui.controlsBody?.addEventListener("click",()=>{this.ui.controlsBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("controls")}),this.ui.graphicsBody?.addEventListener("click",()=>{this.ui.graphicsBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("graphics")}),this.ui.soundBody?.addEventListener("click",()=>{this.ui.soundBody?.classList.contains("settings_page_hidden")&&this.ui.switchSettingsPage("sound")}),this.initSettingsAudioSliders(),this.initSettingsInputListeners(),this.initSettingsToggleListeners())}onKeyDown(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress||this.gameState.isPaused)return;const e=t.key.toLowerCase(),a=this.settingsManager.getSettings().controls.keybinds;Object.values(a).includes(e)&&(t.preventDefault(),this.controlsManager.addKey(e))}onKeyUp(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress)return;const e=t.key.toLowerCase(),a=this.settingsManager.getSettings().controls.keybinds;Object.values(a).includes(e)&&(t.preventDefault(),this.controlsManager.removeKey(e))}onMouseDown(t){this.ui.chatInput!==document.activeElement&&this.gameState.gameInProgress&&!this.gameState.isPaused&&this.ui.canvas&&(0===t.button?(this.updateMouse(t),this.controlsManager.addKey("mouse1")):1===t.button?this.controlsManager.addKey("mouse3"):2===t.button&&(this.updateMouse(t),this.controlsManager.addKey("mouse2")))}onMouseUp(t){this.ui.chatInput!==document.activeElement&&this.gameState.gameInProgress&&(0===t.button?this.controlsManager.removeKey("mouse1"):1===t.button?this.controlsManager.addKey("mouse3"):2===t.button&&this.controlsManager.removeKey("mouse2"))}onMouseMove(t){if(this.ui.chatInput===document.activeElement)return;if(!this.gameState.gameInProgress||this.gameState.isPaused)return;this.updateMouse(t);const e=this.controlsManager.getMousePos(),a=e.x-this.playerState.myPlayer.transform.pos.x,s=e.y-this.playerState.myPlayer.transform.pos.y,i=Math.atan2(s,a)+Math.PI/2;this.animator.rotateCharacterPart(this.userId,i)}updateMouse(t){if(this.ui.chatInput===document.activeElement)return;if(!this.ui.canvas)return;const e=this.ui.canvas.getBoundingClientRect(),a=t.clientX-e.left,s=t.clientY-e.top;this.controlsManager.setMousePos({x:a,y:s})}onStartButtonClick(){const t=new CustomEvent("customEvent_startGame");window.dispatchEvent(t)}initSettingsAudioSliders(){[{slider:this.ui.masterSlider,fill:this.ui.masterFill,value:this.ui.masterValue,channel:"master"},{slider:this.ui.interfaceSlider,fill:this.ui.interfaceFill,value:this.ui.interfaceValue,channel:"interface"},{slider:this.ui.musicSlider,fill:this.ui.musicFill,value:this.ui.musicValue,channel:"music"},{slider:this.ui.sfxSlider,fill:this.ui.sfxFill,value:this.ui.sfxValue,channel:"sfx"},{slider:this.ui.voiceSlider,fill:this.ui.voiceFill,value:this.ui.voiceValue,channel:"voice"}].forEach(({slider:t,fill:e,value:a,channel:s})=>{t&&e&&a&&t.addEventListener("mousedown",i=>{const r=i=>{const r=this.ui.calculateSliderValue(t,i.clientX);this.ui.updateSettingsSlider(e,a,r),this.settingsManager.updateSettings({audio:{mixer:{[s]:r}}})},o=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",o)};r(i),document.addEventListener("mousemove",r),document.addEventListener("mouseup",o),i.preventDefault()})})}initSettingsInputListeners(){[{input:this.ui.deadzoneInput,settingPath:"controls.gamepad.deadzone",parse:parseFloat}].forEach(({input:t,settingPath:e,parse:a})=>{t&&t.addEventListener("change",()=>{const s=t.value,i=a(s);if(isNaN(i))return;const r=e.split("."),o={};let n=o;for(let t=0;t<r.length-1;t++)n[r[t]]={},n=n[r[t]];n[r[r.length-1]]=i,this.settingsManager.updateSettings(o)})})}initSettingsToggleListeners(){[{toggle:this.ui.particleJSToggle,settingPath:"graphics.renderBackgroundParticles"},{toggle:this.ui.staticVfxToggle,settingPath:"graphics.showStaticOverlay"},{toggle:this.ui.ammoReservesPhysicsToggle,settingPath:"graphics.physics.ammoReserves"}].forEach(({toggle:t,settingPath:e})=>{t&&t.addEventListener("click",()=>{const a=!("true"===t.getAttribute("aria-checked"));a?(t.setAttribute("checked","true"),t.setAttribute("aria-checked","true")):(t.removeAttribute("checked"),t.setAttribute("aria-checked","false"));const s=e.split("."),i={};let r=i;for(let t=0;t<s.length-1;t++)r[s[t]]={},r=r[s[t]];r[s[s.length-1]]=a,this.settingsManager.updateSettings(i)})})}initKeybindListeners(){const t=this.settingsManager.getSettings().controls;this.ui.initKeybindsInterface(t,(t,e,a)=>this.onBindingChange(t,e,a))}onBindingChange(t,e,a){if("keybind"===e){this.settingsManager.updateSettings({controls:{keybinds:{[t]:a}}});const e=document.getElementById(`${t}Keybind`);e&&(e.textContent=" "===a?"SPACE":a.toUpperCase())}else{this.settingsManager.updateSettings({controls:{gamepad:{[t]:a}}});const e=document.getElementById(`${t}Gamepad`);if(e){const t=Object.keys(n).find(t=>"number"==typeof n[t]&&n[t]===a);e.textContent=t||a.toString()}}}}class M{constructor(){this.isPaused=!1,this.gameInProgress=!1,this.gameMaxWins=l.MAX_WINS,this.gameMaxPlayers=l.MAX_PLAYERS}}class I{constructor(t,e,a,s,i,r){this.characterManager=t,this.playerConfig=e,this.playerState=a,this.roomManager=s,this.ui=i,this.utility=r,this.inLobby=!1,this.lobbyPlayers=new Map,this.charCustomizeHandlers=[]}showLobbyControls(t){const{lobby:e,lobbyOptions:a,myPlayer:s,roomId:i,userId:r}=t,{isHost:o,maxWins:n,privateRoom:l,upgradesEnabled:h}=a;this.ui.updateDisplay(e,"lobby",i);const m=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,c=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyPlayers.set(r,{id:r,color:s.color,isHost:o,rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon},transform:{pos:{x:m,y:c},rot:0}}),this.setupLobbyOptions(a);const d={inputId:"winsInput",value:n},y={toggleId:"privateToggle",value:l},u={toggleId:"upgradesToggle",value:h};this.utility.setToggle(y),this.utility.setToggle(u),this.utility.setInput(d),this.ui.displayLobbyPlayers(o,e,r),this.ui.updateHostDisplay(o,e),window.dispatchEvent(new CustomEvent("customEvent_renderCharacter")),this.setupCharacterCustomization()}setupLobbyOptions(t){this.setupLobbyToggle("privateToggle",t.isHost,"privateRoom",()=>t.privateRoom,e=>t.privateRoom=e),this.setupLobbyToggle("upgradesToggle",t.isHost,"upgradesEnabled",()=>t.upgradesEnabled,e=>t.upgradesEnabled=e),this.setupLobbyInput("winsInput",t.isHost,"maxWins",()=>t.maxWins,e=>t.maxWins=e),this.setupLobbyInput("playersInput",t.isHost,"maxPlayers",()=>t.maxPlayers,e=>t.maxPlayers=e)}setupLobbyToggle(t,e,a,s,i){const r=this.ui[t];if(!r)return;const o=`${t}Handler`;this[o]&&r.removeEventListener("click",this[o]);const n=()=>{if(!e)return;const r=!s();i(r);const o={toggleId:t,value:r};this.utility.setToggle(o),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",[a]:r})),console.log(`${a} changed to: ${r}`)};this[o]=n,r.addEventListener("click",n)}setupLobbyInput(t,e,a,s,i){const r=this.ui[t];if(!r)return;const o=`${t}Handler`;this[o]&&r.removeEventListener("change",this[o]);const n=()=>{if(!e)return;const o=parseInt(r.value);if(isNaN(o)||o<1)return void(r.value=s().toString());i(o);const n={inputId:t,value:o};this.utility.setInput(n),this.roomManager.sendMessage(JSON.stringify({type:"lobby-options",[a]:o})),console.log(`${a} changed to: ${o}`)};this[o]=n,r.addEventListener("change",n)}syncLobbyOptions(t){this.syncOption(t,"privateRoom","isPrivateRoom","privateToggle",this.utility.setToggle.bind(this.utility),"Lobby privacy",t=>t?"Private":"Public"),this.syncOption(t,"maxWins","gameMaxWins","winsInput",this.utility.setInput.bind(this.utility),"Game max wins"),this.syncOption(t,"maxPlayers","gameMaxPlayers","playersInput",this.utility.setInput.bind(this.utility),"Game max players"),this.syncOption(t,"upgradesEnabled","isUpgradesEnabled","upgradesToggle",this.utility.setToggle.bind(this.utility),"Game upgrades toggled")}syncOption(t,e,a,s,i,r,o){if(void 0===t[e])return;this[a]=t[e],i(s.includes("Input")?{inputId:s,value:t[e]}:{toggleId:s,value:t[e]});const n=o?o(t[e]):t[e];console.log(`${r} synced to: ${n}`)}promotePlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"promote-player",targetPlayerId:t}))}kickPlayer(t){this.roomManager.sendMessage(JSON.stringify({type:"kick-player",targetPlayerId:t}))}setupCharacterCustomization(){if(!(this.ui.bodyArrowLeft&&this.ui.bodyArrowRight&&this.ui.headArrowLeft&&this.ui.headArrowRight&&this.ui.headwearArrowLeft&&this.ui.headwearArrowRight))return;if(!this.lobbyPlayers.get(this.playerState.myPlayer.id))return;this.charCustomizeHandlers.forEach(({element:t,handler:e})=>{t.removeEventListener("click",e)}),this.charCustomizeHandlers=[];const t=(t,e)=>{this.charCustomizeHandlers.push({element:t,handler:e}),t.addEventListener("click",e)};t(this.ui.bodyArrowLeft,()=>this.cycleRigVariant("body",-1)),t(this.ui.bodyArrowRight,()=>this.cycleRigVariant("body",1)),t(this.ui.headArrowLeft,()=>this.cycleRigVariant("head",-1)),t(this.ui.headArrowRight,()=>this.cycleRigVariant("head",1)),t(this.ui.headwearArrowLeft,()=>this.cycleRigVariant("headwear",-1)),t(this.ui.headwearArrowRight,()=>this.cycleRigVariant("headwear",1))}cycleRigVariant(t,e){const a=this.lobbyPlayers.get(this.playerState.myPlayer.id);if(!a)return;const s=Object.keys(this.characterManager.charConfig[t]),i=a.rig[t];let r=s.indexOf(i)+e;r<0?r=s.length-1:r>=s.length&&(r=0),a.rig[t]=s[r],window.dispatchEvent(new CustomEvent("customEvent_renderCharacter"))}}class P{constructor(){this.particles={blood:{drip:{count:{min:1,max:4},lifetime:{min:800,max:1e3},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.25,max:.75},speed:{min:.25,max:.75},sizeOverLifetime:{min:0,max:0},size:{min:.125,max:2.275},torque:{min:-720,max:720},collide:!0,fade:!0,paint:!1,spread:.25,stain:!0,colors:["#690303","#820c0c","#a70707"]},spray:{count:{min:4,max:12},lifetime:{min:150,max:1200},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.425,max:.775},speed:{min:1.5,max:4.75},sizeOverLifetime:{min:0,max:0},size:{min:.75,max:3.5},torque:{min:-720,max:720},collide:!0,fade:!1,paint:!0,spread:.425,stain:!0,colors:["#7e0a0a","#941414","#b51a1a"]}},glock:{muzzle:{smoke:{count:{min:3,max:6},lifetime:{min:800,max:1400},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.15,max:.35},speed:{min:.5,max:1.5},size:{min:4,max:8},sizeOverLifetime:{min:2,max:3},torque:{min:-180,max:180},collide:!1,fade:!0,paint:!1,spread:.4,stain:!1,colors:["#5a5a5a","#7a7a7a"]},flash:{count:{min:8,max:15},lifetime:{min:150,max:300},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:.4,max:.8},speed:{min:4,max:10},sizeOverLifetime:{min:0,max:0},size:{min:1,max:3},torque:{min:0,max:0},collide:!1,fade:!0,paint:!1,spread:.6,stain:!1,colors:["#ffaa00","#f3b02a","#edbe60"]}},projectile:{shell:{count:{min:1,max:1},lifetime:{min:250,max:550},noise:{strength:{min:0,max:0},scale:{min:0,max:0}},opacity:{min:1,max:1},speed:{min:5,max:8},sizeOverLifetime:{min:0,max:0},size:{min:2,max:2},torque:{min:-720,max:720},collide:!0,fade:!1,paint:!0,spread:.4,stain:!1,colors:["#d4af37","#c69e1c","#dcb01f"]},sparks:{count:{min:8,max:16},lifetime:{min:150,max:300},noise:{strength:{min:.25,max:5},scale:{min:.25,max:1.5}},opacity:{min:.4,max:.8},speed:{min:4,max:10},size:{min:1,max:3},sizeOverLifetime:{min:0,max:0},torque:{min:-720,max:720},collide:!1,fade:!0,paint:!1,spread:.6,stain:!1,colors:["#ffaa00","#ffcf70","#f9dea7"]}}}}}}class w{constructor(t,e,a,s,i,r,o,n,l){this.charConfig=t,this.collisionsManager=e,this.decalsManager=a,this.playerState=s,this.renderingManager=i,this.roomManager=r,this.ui=o,this.userId=n,this.utility=l,this.particles=new Map,this.emitters=new Map,this.shrapnel=new Map,this.particlesConfig=new P}createParticles(t){this.generateParticles(t),this.roomManager.sendMessage(JSON.stringify({type:"add-particles",params:t}))}createParticlesNetwork(t){this.particles.has(t.id)||this.generateParticles(t)}generateParticles(t){const e=t.particleParams,a=Math.floor(this.utility.getRandomNum(e.count.min,e.count.max));for(let s=0;s<a;s++){const a=this.utility.getRandomNum(e.lifetime.min,e.lifetime.max),i=this.utility.getRandomNum(e.speed.min,e.speed.max),r=this.utility.getRandomNum(e.size.min,e.size.max),o=this.utility.getRandomNum(e.opacity.min,e.opacity.max),n=this.utility.getRandomNum(e.torque.min,e.torque.max),l=this.utility.getRandomNum(e.noise.strength.min,e.noise.strength.max),h=this.utility.getRandomNum(e.noise.scale.min,e.noise.scale.max),m=this.utility.getRandomNum(e.sizeOverLifetime.min,e.sizeOverLifetime.max),c=this.utility.getRandomInArray(e.colors);let d;d=t.direction?Math.atan2(t.direction.y,t.direction.x)+(this.utility.getRandomNum(0,1)-.5)*e.spread:this.utility.getRandomNum(0,2*Math.PI);const y={age:0,collide:e.collide,color:c,fade:e.fade,hasCollided:!1,id:`${t.id}_${s}`,initialSize:r,lifetime:a,maxOpacity:o,noiseScale:h,noiseStrength:l,opacity:o,paint:e.paint,pos:{x:t.pos.x,y:t.pos.y},size:r,stain:e.stain,torque:n,rotation:this.utility.getRandomNum(0,2*Math.PI),sizeOverLifetime:m,velocity:{x:Math.cos(d)*i,y:Math.sin(d)*i}};this.particles.set(y.id,y)}}updateParticles(t){const e=[];this.particles.forEach((a,s)=>{if(a.noiseStrength>0&&a.noiseScale>0){const e=.001*Date.now(),s=this.utility.simplexNoise2D(a.pos.x/a.noiseScale,e),i=this.utility.simplexNoise2D(a.pos.y/a.noiseScale,e+100);a.velocity.x+=s*a.noiseStrength*t,a.velocity.y+=i*a.noiseStrength*t}if(a.sizeOverLifetime>0){const t=a.age/a.lifetime;a.size=a.initialSize*(1+t*a.sizeOverLifetime)}if(a.pos.x+=a.velocity.x*t,a.pos.y+=a.velocity.y*t,a.age+=16.67*t,a.rotation+=a.torque*Math.PI/180*t,a.fade){const t=a.age/a.lifetime;a.opacity=a.maxOpacity*(1-t)}if(a.hasCollided&&a.stain){this.stampParticle(a);const t=(a.age-(a.lifetime-.5*a.lifetime))/(.5*a.lifetime);t>0&&(a.size=Math.max(.5,a.size*(1-.1*t)),a.opacity=a.opacity*(1-t))}if(a.age>=a.lifetime||a.pos.x<-10||a.pos.x>810||a.pos.y<-10||a.pos.y>610){if(a.collide&&a.age>=a.lifetime&&a.pos.x>=0&&a.pos.x<=i&&a.pos.y>=0&&a.pos.y<=r&&!a.hasCollided){a.hasCollided=!0;const t=.875+.1*Math.random();a.velocity.x*=1-t,a.velocity.y*=1-t;const e=.5*a.lifetime;return void(a.lifetime+=e)}a.paint&&!a.stain&&a.age>=a.lifetime&&a.pos.x>=0&&a.pos.x<=i&&a.pos.y>=0&&a.pos.y<=r&&this.stampParticle(a),e.push(s)}}),e.forEach(t=>this.particles.delete(t))}drawParticles(){this.ui.ctx&&this.particles.forEach(t=>{const e=this.utility.hexToRgb(t.color);e&&this.ui.ctx&&(this.ui.ctx.save(),this.ui.ctx.globalAlpha=t.opacity,0!==t.torque?(this.ui.ctx.translate(t.pos.x+t.size/2,t.pos.y+t.size/2),this.ui.ctx.rotate(t.rotation),this.ui.ctx.fillStyle=`rgb(${e.r}, ${e.g}, ${e.b})`,this.ui.ctx.fillRect(-t.size/2,-t.size/2,t.size,t.size)):(this.ui.ctx.fillStyle=`rgb(${e.r}, ${e.g}, ${e.b})`,this.ui.ctx.fillRect(Math.floor(t.pos.x),Math.floor(t.pos.y),t.size,t.size)),this.ui.ctx.restore())})}stampParticle(t){if(!this.ui.decalCtx)return;const e=this.utility.hexToRgb(t.color);if(!e)return;this.ui.decalCtx.save(),this.ui.decalCtx.globalCompositeOperation="source-over",0!==t.torque?(this.ui.decalCtx.translate(t.pos.x+t.size/2,t.pos.y+t.size/2),this.ui.decalCtx.rotate(t.rotation),this.ui.decalCtx.fillStyle=`rgba(${e.r}, ${e.g}, ${e.b}, ${t.opacity})`,this.ui.decalCtx.fillRect(-t.size/2,-t.size/2,t.size,t.size)):(this.ui.decalCtx.fillStyle=`rgba(${e.r}, ${e.g}, ${e.b}, ${t.opacity})`,this.ui.decalCtx.fillRect(Math.floor(t.pos.x),Math.floor(t.pos.y),t.size,t.size)),this.ui.decalCtx.restore();const a=`stamp_${Date.now()}`;this.decalsManager.dynamicDecals.set(a,{params:null,pos:{x:t.pos.x,y:t.pos.y}})}createEmitter(t){this.generateEmitter(t);const e={type:"particle-emitter",id:t.id,interval:t.interval,lifetime:t.lifetime,offset:{x:t.offset.x,y:t.offset.y},pos:{x:t.pos.x,y:t.pos.y},particleType:t.particleType,playerId:t.playerId};this.roomManager.sendMessage(JSON.stringify(e)),console.log(`Emitter created on ${t.playerId} for ${t.lifetime}ms`)}generateEmitter(t){const e=t.pos.x-t.offset.x,a=t.pos.y-t.offset.y,s=Math.atan2(a,e);this.emitters.set(t.id,{age:0,direction:s,emissionInterval:t.interval,lastEmission:0,lifetime:t.lifetime,offset:{x:e,y:a},particleType:t.particleType,playerId:t.playerId})}updateEmitters(t){const e=[];this.emitters.forEach((a,s)=>{a.age+=16.67*t;const i=a.playerId===this.userId?this.playerState.myPlayer:this.playerState.players.get(a.playerId);if(!i||i.stats.health.value<=0)return void e.push(s);const r=i.transform.pos.x+a.offset.x,o=i.transform.pos.y+a.offset.y;if(a.age>=a.lastEmission+a.emissionInterval){const t=.6*Math.PI,e=(Math.random()-.5)*t,i=a.direction+e,n=3,l=4*(Math.random()-.5),h=Math.max(.5,n+l),m={id:`emitter_particles_${s}_${a.age}`,pos:{x:r+8*(Math.random()-.5),y:o+8*(Math.random()-.5)},particleParams:a.particleType,direction:{x:Math.cos(i)*h,y:Math.sin(i)*h}};this.generateParticles(m),a.lastEmission=a.age,a.emissionInterval=120+180*Math.random()}if(a.age>=a.lifetime){const t={id:`emitter_decal_${s}`,pos:{x:r,y:o},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.blood};this.decalsManager.generateDecal(t),e.push(s)}}),e.forEach(t=>this.emitters.delete(t))}generateGore(t){const e=[...this.charConfig.characterDecals.default.gore];for(let a=0;a<t.gore.amount&&e.length>0;a++){const s=this.utility.getRandomInArray(e);e.splice(e.indexOf(s),1);const i=this.utility.getRandomNum(0,2*Math.PI),r=this.utility.getRandomNum(0,t.radius),o={type:"gore",src:s,transform:{pos:{x:t.pos.x+Math.cos(i)*r,y:t.pos.y+Math.sin(i)*r},rot:this.utility.getRandomNum(0,2*Math.PI)},scale:this.utility.getRandomNum(.65,1.05)},n=`death_gore_${t.ownerId}_${Date.now()}_${a}`;this.stampGore(o),this.decalsManager.dynamicDecals.set(n,{params:null,pos:{x:o.transform.pos.x,y:o.transform.pos.y}})}const a=[...this.charConfig.characterDecals.default.blood];for(let e=0;e<t.blood.amount&&a.length>0;e++){const s=this.utility.getRandomInArray(a);a.splice(a.indexOf(s),1);const i=this.utility.getRandomNum(0,2*Math.PI),r=this.utility.getRandomNum(0,.7*t.radius),o={type:"blood",src:s,transform:{pos:{x:t.pos.x+Math.cos(i)*r,y:t.pos.y+Math.sin(i)*r},rot:this.utility.getRandomNum(0,2*Math.PI)},scale:this.utility.getRandomNum(1.25,1.45)},n=`death_blood_${t.ownerId}_${Date.now()}_${e}`;this.stampGore(o),this.decalsManager.dynamicDecals.set(n,{params:null,pos:{x:o.transform.pos.x,y:o.transform.pos.y}})}}stampGore(t){if(!this.ui.decalCtx)return;let e=this.renderingManager.characterImages.get(t.src);if(!e&&(e=new Image,e.src=t.src,this.renderingManager.characterImages.set(t.src,e),!e.complete))return void(e.onload=()=>{this.stampGore(t)});if(!e.complete||0===e.naturalWidth)return;this.ui.decalCtx.save(),this.ui.decalCtx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.decalCtx.rotate(t.transform.rot);const a=32*t.scale;this.ui.decalCtx.drawImage(e,-a/2,-a/2,a,a),this.ui.decalCtx.restore()}spawnShrapnel(e){const a=[];for(let s=0;s<e.amount;s++){const i=this.utility.getRandomNum(0,2*Math.PI),r=this.utility.getRandomNum(e.speed.min,e.speed.max),o=this.utility.getRandomNum(e.lifetime.min,e.lifetime.max),n=this.utility.getRandomNum(e.size.min,e.size.max),l=this.utility.getRandomNum(e.torque.min,e.torque.max)*(Math.PI/180),h={id:this.utility.generateUID(t),image:e.images[s],transform:{pos:{x:e.pos.x,y:e.pos.y},rot:this.utility.getRandomNum(0,2*Math.PI)},velocity:{x:Math.cos(i)*r,y:Math.sin(i)*r},rotationSpeed:l,size:n,age:0,lifetime:o,ownerId:this.userId,damage:e.damage};a.push(h),this.shrapnel.set(h.id,h)}this.roomManager.sendMessage(JSON.stringify({type:"shrapnel-spawn",pieces:a})),console.log(`Spawned ${a.length} shrapnel pieces`)}generateShrapnel(t){t.forEach(t=>{this.shrapnel.set(t.id,t)}),console.log(`Received ${t.length} shrapnel pieces from network`)}updateShrapnel(t){if(0===this.shrapnel.size)return;const e=[];this.shrapnel.forEach((a,s)=>{a.transform.pos.x+=a.velocity.x*t,a.transform.pos.y+=a.velocity.y*t,a.transform.rot+=a.rotationSpeed*t,a.age+=16.67*t,a.velocity.x*=.98,a.velocity.y*=.98,a.ownerId===this.userId&&this.playerState.players.forEach((t,i)=>{if(t.stats.health.value>0){const r=a.transform.pos.x-t.transform.pos.x,o=a.transform.pos.y-t.transform.pos.y;if(Math.sqrt(r*r+o*o)<=this.collisionsManager.getPlayerCollider(t,a.size)){const r=Math.max(0,a.damage-t.stats.defense),o=Math.max(0,t.stats.health.value-r);t.stats.health.value=o,e.push(s),console.log(`Shrapnel hit ${i} for ${a.damage} damage`);const n={target:t,shooterId:this.userId,damage:a.damage,newHealth:o,source:a,wasKill:o<=0};window.dispatchEvent(new CustomEvent("customEvent_playerHitRelay",{detail:{params:n}}))}}}),(a.age>=a.lifetime||a.transform.pos.x<0||a.transform.pos.x>i||a.transform.pos.y<0||a.transform.pos.y>r)&&(a.transform.pos.x>=0&&a.transform.pos.x<=i&&a.transform.pos.y>=0&&a.transform.pos.y<=r&&this.stampShrapnel(a),e.push(s))}),e.forEach(t=>this.shrapnel.delete(t))}drawShrapnel(){this.ui.ctx&&0!==this.shrapnel.size&&this.shrapnel.forEach(t=>{if(!this.ui.ctx)return;let e=this.renderingManager.characterImages.get(t.image);(e||(e=new Image,e.src=t.image,this.renderingManager.characterImages.set(t.image,e),e.complete))&&e.complete&&0!==e.naturalWidth&&(this.ui.ctx.save(),this.ui.ctx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.ctx.rotate(t.transform.rot),this.ui.ctx.drawImage(e,-t.size/2,-t.size/2,t.size,t.size),this.ui.ctx.restore())})}stampShrapnel(t){if(!this.ui.decalCtx)return;let e=this.renderingManager.characterImages.get(t.image);e&&e.complete&&0!==e.naturalWidth&&(this.ui.decalCtx.save(),this.ui.decalCtx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.decalCtx.rotate(t.transform.rot),this.ui.decalCtx.drawImage(e,-t.size/2,-t.size/2,t.size,t.size),this.ui.decalCtx.restore(),this.decalsManager.dynamicDecals.set(`shrapnel_${t.id}`,{params:null,pos:{x:t.transform.pos.x,y:t.transform.pos.y}}))}}class E{constructor(t,e,a,s,i,r,o){this.animator=t,this.charManager=e,this.lobbyManager=a,this.objectsManager=s,this.playerConfig=i,this.ui=r,this.userId=o,this.characterImages=new Map,this.ammoBoxImages={},this.initEventListeners()}clearCtx(t){t?t.clearRect(0,0,i,r):this.ui.decalCtx&&this.ui.ctx&&(this.ui.ctx.clearRect(0,0,i,r),this.ui.decalCtx.clearRect(0,0,i,r))}drawCharacter(t){const{player:e,context:a}=t;if(a&&e){if("stats"in e){if(e.stats.health.value<=0)return;if(this.renderUniqueEffects(t),e.flags.hidden)return;a.fillStyle="#fff",a.font="12px Arial",a.textAlign="center";const s=e.id===this.userId?"You":e.id.substring(0,6);a.fillText(s,e.transform.pos.x,e.transform.pos.y-this.playerConfig.default.data.idOffset)}this.drawCharacterLayers(t)}}drawCharacterLayers(t){const e=t.player;e&&(this.drawCharacterLayer(t,"BODY",e.rig.body),this.drawCharacterLayer(t,"WEAPON",e.rig.weapon),this.drawCharacterLayer(t,"HEAD",e.rig.head),this.drawCharacterLayer(t,"HEADWEAR",e.rig.headwear),"stats"in e&&this.drawUpgradeLayers(t))}drawCharacterLayer(t,e,a){if(!t)return;const s=this.charManager.getCharacterAsset(e,a);"string"==typeof s?this.drawCharacterPart(t,s,e):Array.isArray(s)&&s.forEach((a,s)=>{this.drawCharacterPart(t,a,e,s)})}drawCharacterPart(t,e,a,s){const{context:i,player:r}=t;if(!i||!r)return;let o=this.characterImages.get(e);if(!o&&(o=new Image,o.src=e,this.characterImages.set(e,o),o.onload=()=>{this.renderLobbyPlayer()},!o.complete))return;if(!o.complete||0===o.naturalWidth)return;const n="stats"in r?l.CHARACTER_SIZE*(r.stats.size/l.CHARACTER_SIZE):.35*l.CHARACTER_SIZE,h=r.transform?.pos?.x??0,m=r.transform?.pos?.y??0;if(i.save(),"stats"in r&&void 0!==r.transform.rot){const t=`${r.id}_${a}_${s||0}`,e=this.animator.characterOffsets?.get(t)||{x:0,y:0};i.translate(h,m),i.rotate(r.transform.rot),i.translate(e.x,e.y),i.drawImage(o,-n/2,-n/2,n,n)}else i.drawImage(o,h-n/2,m-n/2,n,n);i.restore()}drawUpgradeLayers(t){const{player:e}=t;"unique"in e&&(e.unique.forEach(e=>{const a=this.charManager.getUpgradeVisual(e);a&&this.drawCharacterPart(t,a,"UPGRADES")}),e.equipment.forEach(e=>{const a=this.charManager.getUpgradeVisual(e);a&&this.drawCharacterPart(t,a,"UPGRADES")}))}renderUniqueEffects(t){const{player:e}=t;e&&"unique"in e&&e.unique.includes("spectral_image")&&this.renderSpectralImage(t)}renderSpectralImage(t){const{context:e,player:a}=t;if(!e||!a||!("stats"in a))return;const s=this._spectralGhosts??(this._spectralGhosts={lastHidden:new Map,flashes:[]}),i=Date.now(),r=s.lastHidden.get(a.id)??!1,o=a.flags.hidden;!r&&o&&s.flashes.push({x:a.transform.pos.x,y:a.transform.pos.y,t:i,type:"start",playerId:a.id}),r&&!o&&s.flashes.push({x:a.transform.pos.x,y:a.transform.pos.y,t:i,type:"end",playerId:a.id}),s.lastHidden.set(a.id,o);for(const t of s.flashes){if(t.playerId!==a.id)continue;const s=i-t.t;if(s>a.actions.dash.time)continue;const r="start"===t.type?1-s/a.actions.dash.time:s/a.actions.dash.time;e.save(),e.globalAlpha=.8*r,e.globalCompositeOperation="difference",e.filter="saturate(100) contrast(2)";const o={...a,transform:{...a.transform,pos:{x:t.x,y:t.y}}};this.drawCharacterLayers({player:o,context:e}),e.restore()}}renderLobbyPlayer(){if(!this.lobbyManager.inLobby)return;const t=this.lobbyManager.lobbyPlayers.get(this.userId);if(!t||!this.ui.charCustomizeCanvas)return;const e=this.ui.charCustomizeCanvas.getContext("2d");e&&(e.clearRect(0,0,this.ui.charCustomizeCanvas.width,this.ui.charCustomizeCanvas.height),this.drawCharacter({player:t,context:e}))}drawObjects(){this.ui.ctx&&this.objectsManager.ammoBoxes.forEach(t=>{if(!this.ui.ctx)return;this.ammoBoxImages||(this.ammoBoxImages={});const e=["BASE","BULLETS","LID"];if(e.forEach(t=>{if(!this.ammoBoxImages[t]){const e=new Image;e.src=s[t],this.ammoBoxImages[t]=e}}),!e.every(t=>this.ammoBoxImages[t]?.complete&&this.ammoBoxImages[t]?.naturalWidth>0))return;const a=35,i=t.transform.pos.x,r=t.transform.pos.y;t.isOpen&&(t.lid.velocity.x*=.85,t.lid.velocity.y*=.85,t.lid.torque*=.85,t.lid.pos.x+=t.lid.velocity.x,t.lid.pos.y+=t.lid.velocity.y,t.lid.rot+=t.lid.torque),this.ui.ctx.save(),this.ui.ctx.translate(i,r),this.ui.ctx.rotate(t.transform.rot||0),this.ui.ctx.drawImage(this.ammoBoxImages.BASE,-17.5,-17.5,a,a),t.isOpen||(this.ui.ctx.drawImage(this.ammoBoxImages.BULLETS,-17.5,-17.5,a,a),this.ui.ctx.drawImage(this.ammoBoxImages.LID,-17.5,-17.5,a,a)),this.ui.ctx.restore(),t.isOpen&&(this.ui.ctx.save(),this.ui.ctx.translate(i+t.lid.pos.x,r+t.lid.pos.y),this.ui.ctx.rotate((t.transform.rot||0)+t.lid.rot),this.ui.ctx.drawImage(this.ammoBoxImages.LID,-17.5,-17.5,a,a),this.ui.ctx.restore())})}drawProjectile(t){if(!this.ui.ctx)return;const e=Math.sqrt(t.velocity.x*t.velocity.x+t.velocity.y*t.velocity.y),a=t.velocity.x/e,s=t.velocity.y/e,i=t.transform.pos.x+a*(t.length/2),r=t.transform.pos.y+s*(t.length/2),o=t.transform.pos.x-a*(t.length/2),n=t.transform.pos.y-s*(t.length/2);this.ui.ctx.fillStyle=t.color,this.ui.ctx.strokeStyle=t.color,this.ui.ctx.lineWidth=t.size,this.ui.ctx.lineCap="round",this.ui.ctx.beginPath(),this.ui.ctx.moveTo(o,n),this.ui.ctx.lineTo(i,r),this.ui.ctx.stroke()}initEventListeners(){window.addEventListener("customEvent_renderCharacter",()=>this.renderLobbyPlayer())}}class R{constructor(t,e,a,s,i,r,o,n,l){this.gameState=t,this.lobbyManager=e,this.playerState=a,this.roomManager=s,this.ui=i,this.upgradeManager=r,this.userId=o,this.utility=n,this.wsManager=l}showRoomControls(){this.ui.updateDisplay(this.lobbyManager,"room")}hostRoom(){if(this.wsManager.getWebSocket()){const t=this.roomManager.createRoom();if(!t)return;this.playerState.isHost=!0,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:t,userId:this.userId})}else this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{const t=this.roomManager.createRoom();t&&(this.playerState.isHost=!0,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:t,userId:this.userId}))},l.CONNECTION_TIMEOUT)}joinRoom(){this.ui.showJoinRoomModal(t=>{this.joinRoomById(t)})}joinRoomById(t){t&&(this.wsManager.getWebSocket()?this.roomManager.joinRoom(t):(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(t)},l.CONNECTION_TIMEOUT)))}quickPlay(){fetch("/quickplay").then(t=>{if(!t.ok)throw new Error("No available rooms");return t.json()}).then(t=>{this.wsManager.getWebSocket()?this.roomManager.joinRoom(t.roomId):(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(t.roomId)},l.CONNECTION_TIMEOUT))}).catch(t=>{this.ui.modal&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalContent&&this.ui.modalText&&this.ui.modalInput&&this.ui.modalErrorDiv&&this.ui.modalButtons&&(this.ui.modal.classList.remove("hidden"),this.ui.modalInput.style.display="none",this.ui.modalErrorDiv.textContent=" ",this.ui.modalButtons.style.display="flex",this.ui.modalCancelButton.style.display="none",this.ui.modalText.textContent="No available games found.",this.ui.modalConfirmButton.textContent="Confirm",this.ui.modalConfirmButton.onclick=()=>{this.ui.modal&&this.ui.modalInput&&this.ui.modalCancelButton&&this.ui.modalText&&this.ui.modalConfirmButton&&(this.ui.modal.classList.add("hidden"),this.ui.modalInput.style.display="flex",this.ui.modalText.textContent="Join Room",this.ui.modalCancelButton.style.display="flex",this.ui.modalConfirmButton.onclick=null)})})}leaveRoom(){this.roomManager.leaveRoom(),window.dispatchEvent(new CustomEvent("customEvent_resetGameState",{detail:{resetType:"Room"}})),this.showRoomControls()}checkForRoomInURL(){const t=this.getRoomIdFromURL();t&&(this.wsManager.connectWebSocket(),this.utility.safeTimeout(()=>{this.roomManager.joinRoom(t)},l.CONNECTION_TIMEOUT))}getRoomIdFromURL(){return new URLSearchParams(window.location.search).get("room")}copyRoomCode(){const t=this.lobbyManager.inLobby?this.ui.roomIdDisplay?.textContent:this.ui.gameRoomIdDisplay?.textContent;t&&navigator.clipboard.writeText(t).then(()=>{if(!(this.ui.modal&&this.ui.modalConfirmButton&&this.ui.modalCancelButton&&this.ui.modalContent&&this.ui.modalText&&this.ui.modalInput&&this.ui.modalErrorDiv&&this.ui.modalButtons))return;this.ui.modal.classList.remove("hidden"),this.ui.modalInput.style.display="none",this.ui.modalErrorDiv.textContent=" ",this.ui.modalButtons.style.display="flex",this.ui.modalCancelButton.style.display="none",this.ui.modalText.textContent="Room code copied!",this.ui.modalConfirmButton.textContent="Confirm";const t=()=>{this.ui.modal&&this.ui.modalInput&&this.ui.modalCancelButton&&this.ui.modalText&&this.ui.modalConfirmButton&&(this.ui.modal.classList.add("hidden"),this.ui.modalInput.style.display="flex",this.ui.modalText.textContent="Join Room",this.ui.modalCancelButton.style.display="flex",this.ui.modalConfirmButton.onclick=null)};this.ui.modalConfirmButton.onclick=t,this.utility.safeTimeout(()=>{this.ui.modal&&!this.ui.modal.classList.contains("hidden")&&t()},3e3)}).catch(()=>{alert("Could not copy. Please copy manually.")})}}class k{constructor(t,e){this.userId=t,this.utility=e,this.currentRoom=null,this.ws=null,this.messageHandlers=[],this.isPrivateRoom=!1}setWebSocket(t){this.ws=t,this.setupMessageHandler()}createRoom(){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return alert("Cannot create room: Not connected to server. Please refresh the page."),null;const t=this.utility.generateUID(10,"room_");return this.joinRoom(t,!0),t}joinRoom(t,e=!1){if(!this.ws||this.ws.readyState!==WebSocket.OPEN)return void alert("Cannot join room: Not connected to server. Please refresh the page.");const a={type:e?"create-room":"join-room",roomId:t,userId:this.userId};this.ws.send(JSON.stringify(a)),this.currentRoom=t,this.utility.generateLink(t,"room")}leaveRoom(){if(!this.currentRoom||!this.ws)return;const t={type:"leave-room",roomId:this.currentRoom,userId:this.userId};this.ws.send(JSON.stringify(t)),this.currentRoom=null,window.history.pushState({},"",window.location.origin)}sendMessage(t){if(!this.currentRoom||!this.ws)return;if(this.ws.readyState!==WebSocket.OPEN)return void alert("Cannot send message: Not connected to server. Please refresh the page.");const e={type:"room-message",roomId:this.currentRoom,userId:this.userId,message:t};this.ws.send(JSON.stringify(e))}sendAdminCommand(t,e){if(!this.ws)return;const a={type:"admin-command",id:t,key:e,userId:this.userId};this.ws.send(JSON.stringify(a))}getCurrentRoom(){return this.currentRoom}getRoomLink(t){return this.currentRoom?this.utility.generateLink(this.currentRoom,t):null}onMessage(t){this.messageHandlers.push(t)}setupMessageHandler(){this.ws&&(this.ws.onmessage=t=>{try{const e=JSON.parse(t.data);this.messageHandlers.forEach(t=>t(e))}catch(e){const a={type:"room-message",userId:"server",message:t.data};this.messageHandlers.forEach(t=>t(a))}})}}class B{constructor(t,e){this.audioConfig=t,this.cacheManager=e,this.gameSettings=this.initSettings()}initSettings(){return{audio:{mixer:{master:this.audioConfig.mixer.master,interface:this.audioConfig.mixer.interface,music:this.audioConfig.mixer.music,sfx:this.audioConfig.mixer.sfx,voice:this.audioConfig.mixer.voice}},controls:{keybinds:{attack:l.CONTROLS.KEYBINDS.ATTACK,dash:l.CONTROLS.KEYBINDS.DASH,melee:l.CONTROLS.KEYBINDS.MELEE,moveDown:l.CONTROLS.KEYBINDS.MOVE_DOWN,moveLeft:l.CONTROLS.KEYBINDS.MOVE_LEFT,moveRight:l.CONTROLS.KEYBINDS.MOVE_RIGHT,moveUp:l.CONTROLS.KEYBINDS.MOVE_UP,reload:l.CONTROLS.KEYBINDS.RELOAD,sprint:l.CONTROLS.KEYBINDS.SPRINT},gamepad:{attack:l.CONTROLS.GAMEPAD.ATTACK,dash:l.CONTROLS.GAMEPAD.DASH,deadzone:l.CONTROLS.GAMEPAD.DEADZONE,melee:l.CONTROLS.GAMEPAD.MELEE,reload:l.CONTROLS.GAMEPAD.RELOAD,sprint:l.CONTROLS.GAMEPAD.SPRINT}},graphics:{physics:{ammoReserves:l.GRAPHICS.PHYSICS.AMMORESERVES},renderBackgroundParticles:l.GRAPHICS.BACKGROUND_PARTICLES,showStaticOverlay:l.GRAPHICS.STATIC_OVERLAY}}}getSettings(){return this.gameSettings}updateSettings(t){const e=(t,a)=>{for(const s in a)a[s]&&"object"==typeof a[s]&&!Array.isArray(a[s])?(t[s]||(t[s]={}),e(t[s],a[s])):t[s]=a[s]};e(this.gameSettings,t),this.cacheManager.write("gameSettings",this.gameSettings)}async loadSettings(){const t=await this.cacheManager.read("gameSettings");t&&(this.gameSettings=t)}}var _=a(152);const T={equipment:["switch"],resource:["carepackage"],stats:["bioregulator","damagebuffer","hemoglobinsaturator","locomotionmodule"],unique:["clustermodule","kineticbrain","muzzlesplitter","phoenixmodule","projectilearray","spatialtargeting","spectralimage"]};class A{constructor(t,e,a,s){this.playerConfig=t,this.playerState=e,this.ui=a,this.utility=s,this.takenUniques=new Set,this.upgradesCompleted=new Set,this.isUpgradesEnabled=!0,this.rarityConfig={[_._.COMMON]:{weight:35,color:"#7e7e7e"},[_._.UNCOMMON]:{weight:20,color:"#61b6d5"},[_._.SPECIAL]:{weight:15,color:"#58d688"},[_._.SUPERIOR]:{weight:12,color:"#ffc233"},[_._.RARE]:{weight:8,color:"#0077ff"},[_._.EXCEPTIONAL]:{weight:5,color:"#00ff62"},[_._.LEGENDARY]:{weight:2.5,color:"#f6ff00"},[_._.MYTHICAL]:{weight:1.5,color:"#ff0000"},[_._.ENLIGHTENED]:{weight:.9,color:"#9500ff"},[_._.HOLY]:{weight:.1,color:"#ff00f7"}},this.upgrades=[],this.initUpgrades()}initUpgrades(){const t={playerState:this.playerState,ui:this.ui,utility:this.utility};T.equipment.forEach(e=>{const s=a(854)(`./${e}/${e}`).create(t);this.upgrades.push(s)}),T.resource.forEach(e=>{const s=a(136)(`./${e}/${e}`).create(t);this.upgrades.push(s)}),T.stats.forEach(e=>{const s=a(823)(`./${e}/${e}`).create(t);this.upgrades.push(s)}),T.unique.forEach(e=>{const s=a(65)(`./${e}/${e}`).create(t);this.upgrades.push(s)})}getUpgrades(t,e){const a=this.upgrades.filter(t=>!(t.unique&&this.takenUniques.has(t.id)||t.type===_.T.EQUIPMENT&&e.equipment.includes(t.id))),s=[];for(let e=0;e<Math.min(t,a.length)&&0!==a.length;e++){const t=a.reduce((t,e)=>t+this.getRarityWeight(e.rarity),0);let e=Math.random()*t,i=null;for(const t of a)if(e-=this.getRarityWeight(t.rarity),e<=0){i=t;break}if(i){s.push(i);const t=a.indexOf(i);a.splice(t,1)}}return s}applyUpgrade(t,e){const a=this.upgrades.find(e=>e.id===t);return!(!a||(a.unique&&this.takenUniques.has(t)?(console.warn(`Unique upgrade ${t} already taken globally`),1):a.type===_.T.EQUIPMENT&&this.hasEquipment(e,t)?(console.warn(`Equipment ${t} already owned by player`),1):(a.unique&&this.takenUniques.add(t),a.func(e),0)))}removeUpgradeFromPool(t){this.takenUniques.add(t)}resetUpgrades(t){this.takenUniques.clear(),t.equipment=this.playerConfig.default.equipment,t.unique=this.playerConfig.default.unique}hasEquipment(t,e){return t.equipment.includes(e)}hasUnique(t,e){return t.unique.includes(e)}getRarityColor(t){return this.rarityConfig[t].color}getRarityWeight(t){return this.rarityConfig[t].weight}}class L{constructor(t,e,a){this.settings=t,this.ui=e,this.utility=a,this.ammoReserveIcon=null,this.projectileIcon=null,this.reserveBulletParticles=[]}initAmmoReserveCanvas(){this.ammoReserveIcon=new Image,this.ammoReserveIcon.src="/assets/img/icon/inventory/ammobox.png",this.ammoReserveIcon.onload=()=>{this.renderAmmoReserves()},this.projectileIcon=new Image,this.projectileIcon.src="/assets/img/icon/inventory/9mm.png",this.settings.getSettings().graphics.physics.ammoReserves&&requestAnimationFrame(()=>this.updateAmmoReservePhysics())}spawnAmmoInReserveUI(t=1){if(!this.ui.ammoReservesCtx||!this.projectileIcon)return;const e=this.settings.getSettings().graphics.physics.ammoReserves,{collisionHeight:a,collisionWidth:s,collisionX:i,collisionY:r}=this.getAmmoReserveCollisionZone();for(let o=0;o<t;o++)this.utility.safeTimeout(()=>{if(e){const t=i+s,e=r+a/2,o=2+8*Math.random(),n=(Math.random()-.5)*(Math.PI/3),l=Math.cos(n)*o,h=Math.sin(n)*o,m=Math.random()*Math.PI*2,c=.1*(Math.random()-.5);this.reserveBulletParticles.push({transform:{pos:{x:t,y:e},rot:m},velocity:{x:l,y:h},torque:c,width:2.75,height:7})}else{const t=i+Math.random()*s,e=r+Math.random()*a,o=Math.random()*Math.PI*2;this.reserveBulletParticles.push({transform:{pos:{x:t,y:e},rot:o},velocity:{x:0,y:0},torque:0,width:2.75,height:7}),this.renderAmmoReserves()}},100*o)}removeAmmoFromReserveUI(t=1){for(let e=0;e<t;e++)this.utility.safeTimeout(()=>{this.reserveBulletParticles.length>0&&this.reserveBulletParticles.shift(),this.settings.getSettings().graphics.physics.ammoReserves||this.renderAmmoReserves()},100*e)}updateAmmoReservePhysics(){if(!this.settings.getSettings().graphics.physics.ammoReserves)return;if(!this.ui.ammoReservesCtx||!this.ammoReserveIcon)return;const{collisionHeight:t,collisionWidth:e,collisionX:a,collisionY:s}=this.getAmmoReserveCollisionZone();this.ui.ammoReservesCtx.clearRect(0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),this.ui.ammoReservesCtx.drawImage(this.ammoReserveIcon,0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height);for(let i of this.reserveBulletParticles)i.transform.pos.x+=i.velocity.x,i.transform.pos.y+=i.velocity.y,i.transform.rot+=i.torque,i.velocity.x*=.9,i.velocity.y*=.9,i.torque*=.9,i.transform.pos.x-i.width/2<a&&(i.transform.pos.x=a+i.width/2,i.velocity.x*=-.5),i.transform.pos.x+i.width/2>a+e&&(i.transform.pos.x=a+e-i.width/2,i.velocity.x*=-.5),i.transform.pos.y-i.height/2<s&&(i.transform.pos.y=s+i.height/2,i.velocity.y*=-.5),i.transform.pos.y+i.height/2>s+t&&(i.transform.pos.y=s+t-i.height/2,i.velocity.y*=-.5);for(let t=0;t<this.reserveBulletParticles.length;t++)for(let e=t+1;e<this.reserveBulletParticles.length;e++){const a=this.reserveBulletParticles[t],s=this.reserveBulletParticles[e],i=a.transform.pos.x-s.transform.pos.x,r=a.transform.pos.y-s.transform.pos.y,o=Math.sqrt(i*i+r*r),n=(a.width+s.width)/2;if(o<n){const t=Math.atan2(r,i),e=n-o,l=Math.cos(t)*e/2,h=Math.sin(t)*e/2;a.transform.pos.x+=l,a.transform.pos.y+=h,s.transform.pos.x-=l,s.transform.pos.y-=h;const m=a.velocity.x*Math.cos(t)+a.velocity.y*Math.sin(t),c=s.velocity.x*Math.cos(t)+s.velocity.y*Math.sin(t),d=(m+c)/2;a.velocity.x+=.5*(d-m),s.velocity.x+=.5*(d-c)}}for(let t of this.reserveBulletParticles)this.ui.ammoReservesCtx.save(),this.ui.ammoReservesCtx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.ammoReservesCtx.rotate(t.transform.rot),this.ui.ammoReservesCtx.drawImage(this.projectileIcon,-t.width/2,-t.height/2,t.width,t.height),this.ui.ammoReservesCtx.restore();requestAnimationFrame(()=>this.updateAmmoReservePhysics())}renderAmmoReserves(){if(this.ui.ammoReservesCtx&&this.ammoReserveIcon&&this.ammoReserveIcon.complete&&(this.ui.ammoReservesCtx.clearRect(0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),this.ui.ammoReservesCtx.drawImage(this.ammoReserveIcon,0,0,this.ui.ammoReservesCanvas.width,this.ui.ammoReservesCanvas.height),!this.settings.getSettings().graphics.physics.ammoReserves))for(let t of this.reserveBulletParticles)this.ui.ammoReservesCtx.save(),this.ui.ammoReservesCtx.translate(t.transform.pos.x,t.transform.pos.y),this.ui.ammoReservesCtx.rotate(t.transform.rot),this.ui.ammoReservesCtx.drawImage(this.projectileIcon,-t.width/2,-t.height/2,t.width,t.height),this.ui.ammoReservesCtx.restore()}getAmmoReserveCollisionZone(){return{collisionHeight:27,collisionWidth:63,collisionX:(this.ui.ammoReservesCanvas.width-63)/2-3,collisionY:(this.ui.ammoReservesCanvas.height-27)/2-1}}}class D{constructor(t,e,a){this.playerState=t,this.settingsManager=e,this.utility=a,this.ammoReservesCanvas=null,this.ammoReservesCtx=null,this.canvas=null,this.ctx=null,this.decalCanvas=null,this.decalCtx=null,this.gameContainer=null,this.gameOptionsContainer=null,this.lobbyContainer=null,this.roomControls=null,this.upgradeContainer=null,this.gameRoomIdDisplay=null,this.lobbyPlayersList=null,this.roomIdDisplay=null,this.userIdDisplay=null,this.gameCodeButton=null,this.gameLeaveButton=null,this.hostButton=null,this.joinButton=null,this.lobbyCodeButton=null,this.lobbyLeaveButton=null,this.quickplayButton=null,this.startGameBtn=null,this.playersInput=null,this.privateToggle=null,this.upgradesToggle=null,this.winsInput=null,this.chatContainer=null,this.chatInput=null,this.chatMessages=null,this.chatSendBtn=null,this.charCustomizeContainer=null,this.charCustomizeCanvas=null,this.charCustomizeCtx=null,this.headwearArrowLeft=null,this.headArrowLeft=null,this.bodyArrowLeft=null,this.headwearArrowRight=null,this.headArrowRight=null,this.bodyArrowRight=null,this.modal=null,this.modalButtons=null,this.modalCancelButton=null,this.modalConfirmButton=null,this.modalContent=null,this.modalErrorDiv=null,this.modalInput=null,this.modalText=null,this.leaderboard=new Map,this.leaderboardBody=null,this.leaderboardContainer=null,this.settingsContainer=null,this.settingsButton=null,this.settingsCloseButton=null,this.controlsTab=null,this.graphicsTab=null,this.soundTab=null,this.controlsBody=null,this.graphicsBody=null,this.soundBody=null,this.masterSlider=null,this.masterFill=null,this.masterValue=null,this.interfaceSlider=null,this.interfaceFill=null,this.interfaceValue=null,this.musicSlider=null,this.musicFill=null,this.musicValue=null,this.sfxSlider=null,this.sfxFill=null,this.sfxValue=null,this.voiceSlider=null,this.voiceFill=null,this.voiceValue=null,this.deadzoneInput=null,this.particleJSToggle=null,this.staticVfxToggle=null,this.ammoReservesPhysicsToggle=null,this.accuracyStat=null,this.damageStat=null,this.luckStat=null,this.rangeStat=null,this.shotSpeedStat=null,this.speedStat=null,this.ammoReservesUIController=new L(this.settingsManager,this,this.utility),this.initInterfaceListeners()}initInterface(){if(this.canvas=document.getElementById("gameCanvas"),this.decalCanvas=document.createElement("canvas"),this.ammoReservesCanvas=document.getElementById("ammoReservesCanvas"),this.charCustomizeCanvas=document.getElementById("charCustomizeCanvas"),this.roomControls=document.getElementById("roomControls"),this.gameContainer=document.getElementById("gameContainer"),this.lobbyContainer=document.getElementById("lobbyContainer"),this.lobbyPlayersList=document.getElementById("lobbyPlayersList"),this.startGameBtn=document.getElementById("startGameBtn"),this.gameOptionsContainer=document.getElementById("gameOptionsContainer"),this.userIdDisplay=document.getElementById("userId"),this.roomIdDisplay=document.getElementById("roomId"),this.gameRoomIdDisplay=document.getElementById("gameRoomId"),this.chatContainer=document.getElementById("chatContainer"),this.chatMessages=document.getElementById("chatMessages"),this.chatInput=document.getElementById("chatInput"),this.chatSendBtn=document.getElementById("chatSendBtn"),this.charCustomizeContainer=document.getElementById("charCustomizeContainer"),this.headwearArrowLeft=document.getElementById("headwearArrowLeft"),this.headArrowLeft=document.getElementById("headArrowLeft"),this.bodyArrowLeft=document.getElementById("bodyArrowLeft"),this.headwearArrowRight=document.getElementById("headwearArrowRight"),this.headArrowRight=document.getElementById("headArrowRight"),this.bodyArrowRight=document.getElementById("bodyArrowRight"),this.privateToggle=document.getElementById("privateToggle"),this.upgradesToggle=document.getElementById("upgradesToggle"),this.winsInput=document.getElementById("winsInput"),this.playersInput=document.getElementById("playersInput"),this.upgradeContainer=document.getElementById("upgradeContainer"),this.leaderboardContainer=document.getElementById("leaderboardContainer"),this.leaderboardBody=document.getElementById("leaderboardBody"),this.hostButton=document.getElementById("atomHost"),this.joinButton=document.getElementById("atomJoin"),this.quickplayButton=document.getElementById("atomQuickplay"),this.lobbyLeaveButton=document.getElementById("lobbyLeaveBtn"),this.lobbyCodeButton=document.getElementById("lobbyCodeBtn"),this.gameLeaveButton=document.getElementById("gameLeaveBtn"),this.gameCodeButton=document.getElementById("gameCodeBtn"),this.modal=document.getElementById("modal"),this.modalInput=document.getElementById("joinRoomInput"),this.modalButtons=document.getElementById("modalButtons"),this.modalConfirmButton=document.getElementById("joinRoomConfirmBtn"),this.modalCancelButton=document.getElementById("joinRoomCancelBtn"),this.modalErrorDiv=document.getElementById("joinRoomError"),this.modalContent=document.getElementById("modalContent"),this.modalText=document.getElementById("modalText"),this.settingsContainer=document.getElementById("settingsContainer"),this.settingsButton=document.getElementById("atomSettings"),this.settingsCloseButton=document.getElementById("settingsCloseButton"),this.controlsTab=document.getElementById("controlsTab"),this.graphicsTab=document.getElementById("graphicsTab"),this.soundTab=document.getElementById("soundTab"),this.controlsBody=document.getElementById("controlsBody"),this.graphicsBody=document.getElementById("graphicsBody"),this.soundBody=document.getElementById("soundBody"),this.masterSlider=document.getElementById("masterSlider"),this.masterFill=document.getElementById("masterFill"),this.masterValue=document.getElementById("masterValue"),this.interfaceSlider=document.getElementById("interfaceSlider"),this.interfaceFill=document.getElementById("interfaceFill"),this.interfaceValue=document.getElementById("interfaceValue"),this.musicSlider=document.getElementById("musicSlider"),this.musicFill=document.getElementById("musicFill"),this.musicValue=document.getElementById("musicValue"),this.sfxSlider=document.getElementById("sfxSlider"),this.sfxFill=document.getElementById("sfxFill"),this.sfxValue=document.getElementById("sfxValue"),this.voiceSlider=document.getElementById("voiceSlider"),this.voiceFill=document.getElementById("voiceFill"),this.voiceValue=document.getElementById("voiceValue"),this.deadzoneInput=document.getElementById("deadzoneInput"),this.particleJSToggle=document.getElementById("particleJSToggle"),this.staticVfxToggle=document.getElementById("staticToggle"),this.ammoReservesPhysicsToggle=document.getElementById("ammoReservesPhysicsToggle"),this.accuracyStat=document.getElementById("accuracyValue"),this.damageStat=document.getElementById("damageValue"),this.luckStat=document.getElementById("luckValue"),this.rangeStat=document.getElementById("rangeValue"),this.shotSpeedStat=document.getElementById("shotSpeedValue"),this.speedStat=document.getElementById("speedValue"),!(this.canvas&&this.decalCanvas&&this.ammoReservesCanvas&&this.charCustomizeCanvas&&this.roomControls&&this.gameContainer&&this.lobbyContainer&&this.userIdDisplay&&this.roomIdDisplay&&this.gameRoomIdDisplay&&this.lobbyPlayersList&&this.startGameBtn&&this.gameOptionsContainer&&this.chatContainer&&this.chatMessages&&this.chatInput&&this.chatSendBtn&&this.privateToggle&&this.upgradesToggle&&this.winsInput&&this.playersInput&&this.upgradeContainer&&this.leaderboardContainer&&this.leaderboardBody&&this.hostButton&&this.joinButton&&this.quickplayButton&&this.lobbyLeaveButton&&this.lobbyCodeButton&&this.gameLeaveButton&&this.gameCodeButton&&this.settingsButton&&this.settingsCloseButton&&this.settingsContainer&&this.controlsTab&&this.graphicsTab&&this.soundTab&&this.controlsBody&&this.graphicsBody&&this.soundBody&&this.masterSlider&&this.masterFill&&this.interfaceSlider&&this.interfaceFill&&this.musicSlider&&this.musicFill&&this.sfxSlider&&this.sfxFill&&this.voiceSlider&&this.voiceFill&&this.masterValue&&this.interfaceValue&&this.musicValue&&this.sfxValue&&this.voiceValue&&this.accuracyStat&&this.damageStat&&this.luckStat&&this.rangeStat&&this.shotSpeedStat&&this.speedStat&&this.deadzoneInput&&this.particleJSToggle&&this.staticVfxToggle&&this.ammoReservesPhysicsToggle&&this.charCustomizeContainer&&this.headwearArrowLeft&&this.headArrowLeft&&this.bodyArrowLeft&&this.headwearArrowRight&&this.headArrowRight&&this.bodyArrowRight))throw alert("Failed to load game. Please refresh the page."),new Error("Critical error: Required DOM elements are missing.");if(this.canvas.width=i,this.canvas.height=r,this.decalCanvas.width=i,this.decalCanvas.height=r,this.ammoReservesCanvas.width=100,this.ammoReservesCanvas.height=64,this.charCustomizeCanvas.width=200,this.charCustomizeCanvas.height=200,this.ctx=this.canvas.getContext("2d"),this.decalCtx=this.decalCanvas.getContext("2d"),this.ammoReservesCtx=this.ammoReservesCanvas.getContext("2d"),this.charCustomizeCtx=this.charCustomizeCanvas.getContext("2d"),!(this.ctx&&this.decalCtx&&this.ammoReservesCtx&&this.charCustomizeCtx))throw alert("Failed to load game. Please refresh the page."),new Error("Could not get canvas context")}updateDisplay(t,e,a){if(this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer&&this.charCustomizeContainer)switch(this.clearDisplay(),e){case"lobby":this.lobbyContainer.style.display="flex",this.chatContainer.style.display="flex",this.charCustomizeContainer.style.display="flex",a&&this.roomIdDisplay&&(this.roomIdDisplay.textContent=a),t.inLobby=!0;break;case"room":this.roomControls.style.display="flex";break;case"game":if(this.gameContainer.style.display="flex",this.chatContainer.style.display="flex",this.leaderboardContainer.style.display="flex",a){const t=this.gameRoomIdDisplay;t&&(t.textContent=a)}t.inLobby=!1}}updateHostDisplay(t,e){this.startGameBtn&&this.gameOptionsContainer&&(this.startGameBtn.style.display=t?"block":"none",this.startGameBtn.disabled=e.lobbyPlayers.size<1,this.gameOptionsContainer.style.display=t?"flex":"none")}displayLobbyPlayers(t,e,a){this.lobbyPlayersList&&(this.lobbyPlayersList.innerHTML="",Array.from(e.lobbyPlayers.values()).sort((t,e)=>t.isHost&&!e.isHost?-1:!t.isHost&&e.isHost?1:0).forEach(s=>{const i=document.createElement("div");i.className="lobby_player";const r=document.createElement("div");r.className="player_color",r.style.backgroundColor=s.color;const o=document.createElement("div");o.className="player_name",o.textContent=`${s.id}${s.isHost?" (Host)":""}`;const n=document.createElement("div");if(n.className="player_controls",t&&s.id!==a){const t=document.createElement("button");t.textContent="Promote",t.onclick=()=>e.promotePlayer(s.id);const a=document.createElement("button");a.textContent="Kick",a.className="danger",a.onclick=()=>e.kickPlayer(s.id),n.appendChild(t),n.appendChild(a)}i.appendChild(r),i.appendChild(o),i.appendChild(n),this.lobbyPlayersList&&this.lobbyPlayersList.appendChild(i)}))}clearDisplay(){this.roomControls&&this.lobbyContainer&&this.gameContainer&&this.chatContainer&&this.leaderboardContainer&&this.upgradeContainer&&this.charCustomizeContainer&&(this.roomControls.style.display="none",this.lobbyContainer.style.display="none",this.gameContainer.style.display="none",this.chatContainer.style.display="none",this.leaderboardContainer.style.display="none",this.upgradeContainer.style.display="none",this.charCustomizeContainer.style.display="none")}closeModal(){this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalText&&(this.modal.classList.add("hidden"),this.modalInput.style.display="flex",this.modalText.textContent="Join Room",this.modalConfirmButton.onclick=null,this.modalCancelButton.onclick=null,this.modalInput.onkeydown=null)}showJoinRoomModal(t){this.modal&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalErrorDiv&&(this.modal.classList.remove("hidden"),this.modalConfirmButton.classList.remove("hidden"),this.modalInput.value="",this.modalErrorDiv.textContent="",this.modalConfirmButton.textContent="Join",this.modalInput.focus(),this.modalConfirmButton.onclick=()=>{if(!this.modalInput||!this.modalErrorDiv)return;const e=this.modalInput.value.trim();if(!e)return void(this.modalErrorDiv.textContent="Invalid code...");let a=null;try{const t=new URL(e,window.location.origin);a=t.pathname.startsWith("/room_")?t.pathname.replace("/",""):new URLSearchParams(t.search).get("room")}catch{e.startsWith("room_")&&(a=e)}a?(this.closeModal(),t(a)):this.modalErrorDiv.textContent="Invalid code..."},this.modalCancelButton.onclick=()=>this.closeModal())}soloGameWarning(t){this.modal&&this.modalConfirmButton&&this.modalCancelButton&&this.modalContent&&this.modalText&&this.modalInput&&this.modalErrorDiv&&this.modalButtons&&(this.modal.classList.remove("hidden"),this.modalConfirmButton.classList.remove("hidden"),this.modalInput.style.display="none",this.modalErrorDiv.textContent=" ",this.modalButtons.style.display="flex",this.modalCancelButton.style.display="flex",this.modalText.textContent="Start game as only player? Other players will be unable to join until you return to the lobby.",this.modalConfirmButton.textContent="Start Game",this.modalCancelButton.textContent="Cancel",this.modalConfirmButton.onclick=()=>{this.closeModal(),t()},this.modalCancelButton.onclick=()=>this.closeModal())}showSettingsPage(){this.settingsContainer&&this.settingsContainer.classList.remove("hidden")}hideSettingsPage(){this.settingsContainer&&this.settingsContainer.classList.add("hidden")}switchSettingsPage(t){if(this.controlsBody&&this.graphicsBody&&this.soundBody&&this.controlsTab&&this.graphicsTab&&this.soundTab)switch(this.controlsTab.classList.remove("settings_tab_active"),this.graphicsTab.classList.remove("settings_tab_active"),this.soundTab.classList.remove("settings_tab_active"),this.controlsBody.classList.remove("settings_page_hidden"),this.graphicsBody.classList.remove("settings_page_hidden"),this.soundBody.classList.remove("settings_page_hidden"),t){case"controls":this.controlsTab.classList.add("settings_tab_active"),this.graphicsBody.classList.add("settings_page_hidden"),this.soundBody.classList.add("settings_page_hidden");break;case"graphics":this.graphicsTab.classList.add("settings_tab_active"),this.controlsBody.classList.add("settings_page_hidden"),this.soundBody.classList.add("settings_page_hidden");break;case"sound":this.soundTab.classList.add("settings_tab_active"),this.controlsBody.classList.add("settings_page_hidden"),this.graphicsBody.classList.add("settings_page_hidden")}}updateSettingsSlider(t,e,a){const s=Math.max(0,Math.min(100,100*a));t.style.width=`${s}%`,e.textContent=`${Math.round(s)}%`}calculateSliderValue(t,e){const a=t.getBoundingClientRect(),s=e-a.left,i=a.width;return Math.max(0,Math.min(1,s/i))}initSoundSliders(t){const e=t.audio.mixer;this.masterFill&&this.masterValue&&this.updateSettingsSlider(this.masterFill,this.masterValue,e.master),this.interfaceFill&&this.interfaceValue&&this.updateSettingsSlider(this.interfaceFill,this.interfaceValue,e.interface),this.musicFill&&this.musicValue&&this.updateSettingsSlider(this.musicFill,this.musicValue,e.music),this.sfxFill&&this.sfxValue&&this.updateSettingsSlider(this.sfxFill,this.sfxValue,e.sfx),this.voiceFill&&this.voiceValue&&this.updateSettingsSlider(this.voiceFill,this.voiceValue,e.voice)}initSettingsInputs(t){this.deadzoneInput&&(this.deadzoneInput.value=t.controls.gamepad.deadzone.toString())}initSettingsToggles(t){this.particleJSToggle&&this.utility.setToggle({toggleId:"particleJSToggle",value:t.graphics.renderBackgroundParticles}),this.staticVfxToggle&&this.utility.setToggle({toggleId:"staticToggle",value:t.graphics.showStaticOverlay}),this.ammoReservesPhysicsToggle&&this.utility.setToggle({toggleId:"ammoReservesPhysicsToggle",value:t.graphics.physics.ammoReserves})}initKeybindsInterface(t,e){Object.keys(t.keybinds).forEach(a=>{const s=`${a}Keybind`,i=document.getElementById(s);if(i){const s=t.keybinds[a];i.textContent=" "===s?"SPACE":s.toUpperCase(),i.addEventListener("click",()=>{this.showRebindModal(a,"keybind",t=>{e(a,"keybind",t)})})}}),Object.keys(t.gamepad).forEach(a=>{const s=`${a}Gamepad`,i=document.getElementById(s);if(i&&void 0!==t.gamepad[a]){const s=t.gamepad[a],r=Object.keys(n).find(t=>"number"==typeof n[t]&&n[t]===s);i.textContent=r||s.toString(),i.addEventListener("click",()=>{this.showRebindModal(a,"gamepad",t=>{e(a,"gamepad",t)})})}})}showRebindModal(t,e,a){if(!(this.modal&&this.modalText&&this.modalInput&&this.modalConfirmButton&&this.modalCancelButton&&this.modalErrorDiv))return;const s=["Binding already assigned!","Binding already in use!","That binding is assigned already!","Binding already being used!","Already bound to another action!"];let i=0;if("gamepad"===e){const t=navigator.getGamepads();if(!Array.from(t).some(t=>null!==t))return this.modal.classList.remove("hidden"),this.modalErrorDiv.textContent="",this.modalText.textContent="No gamepad detected",this.modalInput.style.display="none",this.modalConfirmButton.classList.add("hidden"),this.modalCancelButton.textContent="Close",this.modalCancelButton.onclick=()=>this.closeModal(),void this.utility.safeTimeout(()=>{this.closeModal()},3e3)}this.modal.classList.remove("hidden"),this.modalErrorDiv.textContent="",this.modalInput.style.display="none",this.modalText.textContent=`Press any ${"keybind"===e?"key":"button"} for ${t.toUpperCase()}`,this.modalConfirmButton.classList.add("hidden"),this.modalCancelButton.textContent="Cancel";const r=a=>"keybind"===e?Object.entries(this.settingsManager?.getSettings().controls.keybinds||{}).some(([e,s])=>e!==t&&s===a):Object.entries(this.settingsManager?.getSettings().controls.gamepad||{}).some(([e,s])=>e!==t&&s===a),o=t=>{if(t.preventDefault(),"Escape"===t.key)return h(),void this.closeModal();const e=t.key.toLowerCase();if(r(e)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],void i++}h(),a(e),this.closeModal()},n=t=>{if(t.target===this.modalCancelButton||this.modalCancelButton?.contains(t.target))return;t.preventDefault(),t.stopPropagation();let e="";if(0===t.button?e="mouse1":1===t.button?e="mouse3":2===t.button&&(e="mouse2"),e){if(r(e)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],void i++}h(),a(e),this.closeModal()}},l=()=>{const t=navigator.getGamepads();for(const e of t)if(e)for(let t=0;t<e.buttons.length;t++)if(e.buttons[t].pressed){if(r(t)){if(!this.modalErrorDiv)return;return this.modalErrorDiv.textContent=s[i%s.length],i++,void requestAnimationFrame(l)}return h(),a(t),void this.closeModal()}requestAnimationFrame(l)},h=()=>{"keybind"===e&&(document.removeEventListener("keydown",o),document.removeEventListener("mousedown",n)),this.modalCancelButton.onclick=null};"keybind"===e?(document.addEventListener("keydown",o),document.addEventListener("mousedown",n)):requestAnimationFrame(l),this.modalCancelButton.onclick=()=>{h(),this.closeModal()}}createLeaderboard(t,e,a){const s=new Set;s.add(a),e.forEach((t,e)=>{s.add(e)}),t.lobbyPlayers.forEach((t,e)=>{s.add(e)}),s.forEach(t=>{this.leaderboard.has(t)||(this.leaderboard.set(t,{playerId:t,wins:0,kills:0,deaths:0}),console.log(`Created leaderboard entry for ${t}`))}),this.updateLeaderboardDisplay(a),console.log("Leaderboard created/updated:",Array.from(this.leaderboard.entries()))}updateLeaderboardDisplay(t){this.leaderboardBody&&(this.leaderboardBody.innerHTML="",Array.from(this.leaderboard.entries()).sort((t,e)=>{const[,a]=t,[,s]=e;return s.wins!==a.wins?s.wins-a.wins:s.kills-a.kills}).forEach(([e,a])=>{const s=document.createElement("tr");s.className="leaderboard_row",e===t&&s.classList.add("current-player");const i=document.createElement("td");i.textContent=e===t?"You":e.substring(0,8),i.className="player_name",s.appendChild(i);const r=document.createElement("td");r.textContent=a.wins.toString(),r.className="wins",s.appendChild(r);const o=document.createElement("td");o.textContent=a.kills.toString(),o.className="kills",s.appendChild(o);const n=document.createElement("td");n.textContent=a.deaths.toString(),n.className="deaths",s.appendChild(n),this.leaderboardBody&&this.leaderboardBody.appendChild(s)}))}clearLeaderboard(){this.leaderboard.clear(),this.leaderboardBody&&(this.leaderboardBody.innerHTML="")}initInterfaceListeners(){const t=500,e=20,a="#00ff00",s="#ff0000",i=200;this.playerState.onStatChange("actions.primary.projectile.spread",r=>{if(!this.accuracyStat)return;const o=parseFloat(this.accuracyStat.textContent||"0"),n=r<o;this.utility.animateTextInElement({element:this.accuracyStat,oldValue:o,newValue:r,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.damage",r=>{if(!this.damageStat)return;const o=parseFloat(this.damageStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.damageStat,oldValue:o,newValue:Math.round(r),decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("stats.speed",r=>{if(!this.speedStat)return;const o=parseFloat(this.speedStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.speedStat,oldValue:o,newValue:r,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.range",r=>{if(!this.rangeStat)return;const o=parseFloat(this.rangeStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.rangeStat,oldValue:o,newValue:r,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("actions.primary.projectile.speed",r=>{if(!this.shotSpeedStat)return;const o=parseFloat(this.shotSpeedStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.shotSpeedStat,oldValue:o,newValue:r,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})}),this.playerState.onStatChange("stats.luck",r=>{if(!this.luckStat)return;const o=parseFloat(this.luckStat.textContent||"0"),n=r>o;this.utility.animateTextInElement({element:this.luckStat,oldValue:o,newValue:r,decimals:2,animTime:t,steps:e,color:n?a:s,timeout:i})})}}class z{constructor(){this.lastFrameTime=performance.now(),this.simplexTable=this.generateSimplexTable(),this.activeTimeouts=new Set}deepMerge(t,e){for(const a in e)null===e[a]||"object"!=typeof e[a]||Array.isArray(e[a])?t[a]=e[a]:(t[a]||(t[a]={}),this.deepMerge(t[a],e[a]))}deltaTime(){const t=performance.now(),e=t-this.lastFrameTime;return this.lastFrameTime=t,Math.min(e,100)/16.67}safeTimeout(t,e){const a=window.setTimeout(()=>{this.activeTimeouts.delete(a),t()},e);return this.activeTimeouts.add(a),a}clearTimeoutCache(){this.activeTimeouts.forEach(t=>window.clearTimeout(t)),this.activeTimeouts.clear()}getRandomNum(t,e,a){const s=Math.random()*(e-t)+t;return void 0!==a?parseFloat(s.toFixed(a)):s}getRandomInt(t,e){return Math.floor(Math.random()*(e-t+1))+t}getRandomInArray(t){return t[Math.floor(Math.random()*t.length)]}getShuffledArray(t){return t.slice().sort(()=>Math.random()-.5)}getDotProduct(t,e){return t.x*e.x+t.y*e.y}getReflection(t,e){const a=this.getDotProduct(t,e);return{x:t.x-2*a*e.x,y:t.y-2*a*e.y}}forward(t){return{x:Math.cos(t),y:Math.sin(t)}}getDirection(t){const e=t.targetPos.x-t.rootPos.x,a=t.targetPos.y-t.rootPos.y,s=Math.sqrt(e*e+a*a);return 0===s?{x:0,y:0}:{x:e/s,y:a/s}}getRandomDirection(t){const e=Math.random()*(t*Math.PI/180);return{x:Math.cos(e),y:Math.sin(e)}}getRandomColor(t){const e=t?.format??"hex";let a;switch(t?.mode??"any"){case"primary":const t=["#FF0000","#00FF00","#0000FF","#FFFF00","#00FFFF","#FF00FF"];a=this.getRandomInArray(t);break;case"pastel":const e=this.getRandomInt(127,254),s=this.getRandomInt(127,254),i=this.getRandomInt(127,254);a=`#${e.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`;break;case"vibrant":const r=[255,this.getRandomInt(0,255),this.getRandomInt(0,255)];r.sort(()=>Math.random()-.5),a=`#${r[0].toString(16).padStart(2,"0")}${r[1].toString(16).padStart(2,"0")}${r[2].toString(16).padStart(2,"0")}`;break;case"dark":const o=this.getRandomInt(0,127),n=this.getRandomInt(0,127),l=this.getRandomInt(0,127);a=`#${o.toString(16).padStart(2,"0")}${n.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}`;break;case"light":const h=this.getRandomInt(128,255),m=this.getRandomInt(128,255),c=this.getRandomInt(128,255);a=`#${h.toString(16).padStart(2,"0")}${m.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}`;break;case"grayscale":const d=this.getRandomInt(0,255);a=`#${d.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}${d.toString(16).padStart(2,"0")}`;break;default:a="#"+this.getRandomInt(0,16777215).toString(16).padStart(6,"0")}if("rgb"===e){const t=this.hexToRgb(a);return t?`rgb(${t.r}, ${t.g}, ${t.b})`:a}return a}hexToRgb(t){const e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16),g:parseInt(e[2],16),b:parseInt(e[3],16)}:null}generateSimplexTable(){const t=new Uint8Array(512);for(let e=0;e<256;e++)t[e]=e;for(let e=0;e<256;e++){const a=e+this.getRandomInt(0,255-e);[t[e],t[a]]=[t[a],t[e]]}for(let e=0;e<256;e++)t[256+e]=t[e];return t}simplexNoise2D(t,e,a=!1){a&&(this.simplexTable=this.generateSimplexTable());const s=this.simplexTable,i=.5*(Math.sqrt(3)-1),r=(3-Math.sqrt(3))/6,o=(t+e)*i,n=Math.floor(t+o),l=Math.floor(e+o),h=(n+l)*r,m=t-(n-h),c=e-(l-h),d=m>c?1:0,y=m>c?0:1,u=m-d+r,p=c-y+r,g=m-1+2*r,f=c-1+2*r,S=255&n,x=255&l,C=s[S+s[x]]%12,b=s[S+d+s[x+y]]%12,v=s[S+1+s[x+1]]%12,M=[[1,1,0],[-1,1,0],[1,-1,0],[-1,-1,0],[1,0,1],[-1,0,1],[1,0,-1],[-1,0,-1],[0,1,1],[0,-1,1],[0,1,-1],[0,-1,-1]],I=(t,e,a)=>t[0]*e+t[1]*a;let P=.5-m*m-c*c,w=.5-u*u-p*p,E=.5-g*g-f*f;return 70*((P<0?0:Math.pow(P,4)*I(M[C],m,c))+(w<0?0:Math.pow(w,4)*I(M[b],u,p))+(E<0?0:Math.pow(E,4)*I(M[v],g,f)))}generateUID(t,e){let a=e??"";for(let e=0;e<t;e++)a+="0123456789abcdefghijklmnopqrstuvwxyz"[this.getRandomInt(0,35)];return a}generateLink(t,e){const a=window.location.origin;return e?`${a}?${e}=${t}`:`${a}?${t}`}setInput(t){const e=document.getElementById(t.inputId);e&&(e.value=t.value.toString())}setSlider(t){const{sliderId:e,targetValue:a,maxValue:s,lerpTime:i=0}=t,r=document.getElementById(e),o=r?.querySelector("div");if(!r||!o)return void console.warn(`Slider not found: ${e}...`);if(0===s)return void console.warn("maxValue cannot be 0...");const n=Math.max(0,Math.min(s,a))/s*100,l=o.style.width||"100%",h=parseFloat(l.replace("%",""));if(!(Math.abs(h-n)<.1)){if(i<=0)return o.style.transition="none",void(o.style.width=`${n}%`);o.style.transition=`width ${i}ms ease-out`,o.style.width=`${n}%`,setTimeout(()=>{o&&(o.style.transition="")},i)}}setSpan(t){const e=document.getElementById(t.spanId);e?e.textContent=t.value.toString():console.warn(`Span not found: ${t.spanId}`)}setToggle(t){const e=document.getElementById(t.toggleId);e&&(t.value?(e.setAttribute("checked","true"),e.setAttribute("aria-checked","true")):(e.removeAttribute("checked"),e.setAttribute("aria-checked","false")))}animateTextInElement(t){const e=(t.newValue-t.oldValue)/t.steps,a=t.animTime/t.steps;let s=0,i=t.oldValue;t.element.style.color=t.color;const r=setInterval(()=>{s++,i+=e,s>=t.steps?(t.element.textContent=t.newValue.toFixed(t.decimals),clearInterval(r),setTimeout(()=>{t.element.style.color=""},t.timeout)):t.element.textContent=i.toFixed(t.decimals)},a)}}class O{constructor(t,e,a){this.gameState=t,this.roomManager=e,this.utility=a,this.ws=null}connectWebSocket(){const t="https:"===location.protocol?"wss:":"ws:";let e;"8888"===location.port?(e="localhost:8080",this.ws=new WebSocket(`ws://${e}`)):"9999"===location.port?(e="saltpeter.xyz",this.ws=new WebSocket(`wss://${e}`)):(e="localhost"===location.hostname?"localhost:8080":location.host,this.ws=new WebSocket(`${t}//${e}`)),this.ws.onopen=()=>{console.log("Connected to WebSocket"),this.roomManager.setWebSocket(this.ws)},this.ws.onclose=()=>{console.log("Disconnected from WebSocket"),this.gameState.gameInProgress=!1,this.utility.safeTimeout(()=>this.connectWebSocket(),l.RECONNECT_DELAY)},this.ws.onerror=t=>{console.error("WebSocket error:",t)}}getWebSocket(){return this.ws}}class N{constructor(t,e,a,s,i,r,o,n,l,h,m,c,d,y){this.animator=t,this.audioConfig=e,this.audioManager=a,this.collisionsManager=s,this.decalsManager=i,this.gameState=r,this.luckController=o,this.particlesManager=n,this.playerController=l,this.playerState=h,this.roomManager=m,this.ui=c,this.userId=d,this.utility=y,this.projectiles=new Map}triggerAttack(t){switch(t){case"melee":this.startMelee();break;case"ranged":this.startBurst();break;default:console.warn(`Unknown attack type: ${t}`)}}updateAttack(t){if(!this.gameState.gameInProgress||this.playerState.myPlayer.stats.health.value<=0)return;const e=Date.now();if(this.playerState.isReloading)e>=this.playerState.reloadStartTime+this.playerState.myPlayer.actions.primary.reload.time&&this.finishReload();else if(this.playerState.isBurstActive&&e>=this.playerState.nextBurstShotTime){const t=this.playerState.myPlayer.actions.primary.burst.amount;if(this.playerState.myPlayer.actions.primary.magazine.currentAmmo>0&&this.playerState.currentBurstShot<t){const a=this.playerState.myPlayer.transform.rot-Math.PI/2,s={x:Math.cos(a),y:Math.sin(a)};0===this.triggerBurstUniques().length&&this.launchProjectile(s),this.playerState.currentBurstShot++,this.playerState.myPlayer.actions.primary.magazine.currentAmmo--,console.log(`Burst shot ${this.playerState.currentBurstShot}! Magazine: ${this.playerState.myPlayer.actions.primary.magazine.currentAmmo}/${this.playerState.myPlayer.actions.primary.magazine.size}, Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`),this.playerState.currentBurstShot>=t||0===this.playerState.myPlayer.actions.primary.magazine.currentAmmo?(this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0):this.playerState.nextBurstShotTime=e+this.playerState.myPlayer.actions.primary.burst.delay}else this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0}}canMelee(){const t=Date.now();return!this.playerState.isMelee&&t>=this.playerState.lastMeleeTime+this.playerState.myPlayer.actions.melee.cooldown&&this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)&&!this.playerState.isBurstActive&&!this.playerState.isReloading}startMelee(){this.playerState.isMelee=!0,this.playerState.lastMeleeTime=Date.now(),this.playerState.myPlayer.rig.weapon=this.playerState.myPlayer.inventory.melee,this.roomManager.sendMessage(JSON.stringify({type:"weapon-change",playerId:this.userId,weapon:this.playerState.myPlayer.inventory.melee}));const e=this.playerState.myPlayer.transform.rot,a=this.playerState.myPlayer.actions.melee.range,s=this.playerState.myPlayer.actions.melee.size,i=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+this.playerState.myPlayer.actions.primary.projectile.size+this.playerState.myPlayer.actions.primary.offset,r=this.playerState.myPlayer.transform.pos.x+Math.cos(e-Math.PI/2)*i,o=this.playerState.myPlayer.transform.pos.y+Math.sin(e-Math.PI/2)*i,n={x:Math.cos(e-Math.PI/2)*a,y:Math.sin(e-Math.PI/2)*a},l={id:this.utility.generateUID(t),transform:{pos:{x:r,y:o},rot:e},timestamp:Date.now(),color:"rgba(255, 255, 255, 0)",damage:this.playerState.myPlayer.actions.melee.damage,distanceTraveled:0,length:s,ownerId:this.userId,range:a,size:s,velocity:n};this.projectiles.set(l.id,l),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:l})),this.utility.safeTimeout(()=>{this.projectiles.delete(l.id),this.playerState.isMelee=!1,this.playerState.myPlayer.rig.weapon=this.playerState.myPlayer.inventory.primary,this.roomManager.sendMessage(JSON.stringify({type:"weapon-change",playerId:this.userId,weapon:this.playerState.myPlayer.inventory.primary}))},this.playerState.myPlayer.actions.melee.duration)}startBurst(){if(this.playerState.isBurstActive||!this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)||this.playerState.isReloading)return;const t=Date.now();if(t<this.playerState.lastShotTime+this.playerState.myPlayer.actions.primary.buffer)return;this.playerState.lastShotTime=t;const e=this.playerState.myPlayer.actions.primary.burst.amount,a=Math.min(e,this.playerState.myPlayer.actions.primary.magazine.currentAmmo);if(0===a)return console.log("Out of ammo! Magazine empty."),this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:8}},duration:0,partIndex:1}),void this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.empty),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}});this.playerState.isBurstActive=!0,this.playerState.currentBurstShot=0;const s=this.playerState.myPlayer.transform.rot-Math.PI/2,i={x:Math.cos(s),y:Math.sin(s)};0===this.triggerBurstUniques().length&&this.launchProjectile(i),this.playerState.currentBurstShot++,this.playerState.myPlayer.actions.primary.magazine.currentAmmo--;const r=1-this.playerState.myPlayer.actions.primary.magazine.currentAmmo/this.playerState.myPlayer.actions.primary.magazine.size;if(r>.5){const t=2*(r-.5)*.5;this.audioManager.playAudio({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.empty),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},volume:{min:t,max:t}})}this.playerState.myPlayer.actions.primary.burst.amount>1&&this.playerState.myPlayer.actions.primary.magazine.currentAmmo>0&&this.playerState.currentBurstShot<a?this.playerState.nextBurstShotTime=Date.now()+this.playerState.myPlayer.actions.primary.burst.delay:(this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0,0===this.playerState.myPlayer.actions.primary.magazine.currentAmmo&&this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:8}},duration:0,partIndex:1}))}launchProjectile(e,a){console.log("Fired shot!");const s=Math.sqrt(e.x*e.x+e.y*e.y);if(0===s)return;const o=e.x/s,n=e.y/s;this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:0},.5:{x:0,y:20},1:{x:0,y:0}},duration:175,partIndex:1});const l=a?.canTriggerUnique??!0,h=a?.amount??this.playerState.myPlayer.actions.primary.projectile.amount,m=a?.color??this.playerState.myPlayer.actions.primary.projectile.color,c=a?.damage??this.playerState.myPlayer.actions.primary.projectile.damage,d=a?.length??this.playerState.myPlayer.actions.primary.projectile.length,y=a?.range??this.playerState.myPlayer.actions.primary.projectile.range,u=a?.size??this.playerState.myPlayer.actions.primary.projectile.size,p=a?.speed??this.playerState.myPlayer.actions.primary.projectile.speed,g=a?.spread??this.playerState.myPlayer.actions.primary.projectile.spread,f=Math.atan2(n,o),S=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer)+u+this.playerState.myPlayer.actions.primary.offset,x=this.playerState.myPlayer.transform.pos.x+Math.cos(f)*S,C=this.playerState.myPlayer.transform.pos.y+Math.sin(f)*S,b=-n,v=o,M={id:`muzzle_${Date.now()}`,pos:{x,y:C},particleParams:this.particlesManager.particlesConfig.particles.glock.muzzle.flash,direction:{x:o,y:n}};this.particlesManager.createParticles(M);const I={id:`smoke_${Date.now()}`,pos:{x,y:C},particleParams:this.particlesManager.particlesConfig.particles.glock.muzzle.smoke,direction:{x:.3*o,y:.3*n}};this.particlesManager.createParticles(I);const P={id:`shell_${Date.now()}`,pos:{x:x-5,y:C-5},particleParams:this.particlesManager.particlesConfig.particles.glock.projectile.shell,direction:{x:.8*b+-.2*o,y:.8*v+-.2*n}};this.particlesManager.createParticles(P),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.attack),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rolloff:{distance:2*Math.max(i,r),factor:.5,type:"logarithmic"}},volume:{min:.965,max:1}}),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.shell),delay:{min:.25,max:.5},listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.375,max:.85}});for(let e=0;e<h;e++){if(this.playerState.myPlayer.unique.length>0&&l){const t=this.utility.getShuffledArray(this.playerState.myPlayer.unique);for(const e of t)if(this.luckController.luckRoll()){this.triggerUnique(e);break}}const e=(Math.random()-.5)*(g/100),a=Math.atan2(n,o)+e,s=this.utility.forward(a),i={id:this.utility.generateUID(t),transform:{pos:{x,y:C},rot:a},timestamp:Date.now(),color:m,damage:c,distanceTraveled:0,length:d,ownerId:this.userId,range:100*y,size:u,velocity:{x:s.x*p,y:s.y*p}};this.projectiles.set(i.id,i),this.roomManager.sendMessage(JSON.stringify({type:"projectile-launch",projectile:i}))}}updateProjectiles(t){const e=[];this.projectiles.forEach((a,s)=>{if(a.ownerId===this.userId&&this.playerState.myPlayer.unique.includes("spatial_targeting")){const t=this.playerState.myPlayer.transform.rot-Math.PI/2,e=Math.cos(t),s=Math.sin(t),i=Math.sqrt(a.velocity.x**2+a.velocity.y**2),r=a.velocity.x/i,o=a.velocity.y/i,n=.05,l=r+(e-r)*n,h=o+(s-o)*n,m=Math.sqrt(l**2+h**2);a.velocity.x=l/m*i,a.velocity.y=h/m*i,a.transform.rot=Math.atan2(a.velocity.y,a.velocity.x)}a.transform.pos.x+=a.velocity.x*t,a.transform.pos.y+=a.velocity.y*t;const o=Math.sqrt(a.velocity.x*a.velocity.x+a.velocity.y*a.velocity.y)*t;if(a.distanceTraveled+=o,this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)){const t=a.transform.pos.x-this.playerState.myPlayer.transform.pos.x,i=a.transform.pos.y-this.playerState.myPlayer.transform.pos.y,r=Math.sqrt(t*t+i*i),o=this.collisionsManager.getPlayerCollider(this.playerState.myPlayer);if(this.playerState.myPlayer.unique.includes("kinetic_brain")&&r<=4*o&&r>o+a.size&&a.ownerId!==this.userId&&this.luckController.luckRoll()){console.log("Kinetic Brain activated! Deflecting projectile.");const t={x:(a.transform.pos.x-this.playerState.myPlayer.transform.pos.x)/r,y:(a.transform.pos.y-this.playerState.myPlayer.transform.pos.y)/r},e=this.utility.getRandomNum(.85,.95),s=this.utility.getReflection(a.velocity,t);return a.velocity.x=s.x*e,a.velocity.y=.85*s.y,a.ownerId=this.userId,a.color=this.playerState.myPlayer.actions.primary.projectile.color,a.transform.rot=Math.atan2(a.velocity.y,a.velocity.x),void this.roomManager.sendMessage(JSON.stringify({type:"projectile-update",projectileId:a.id,newOwnerId:this.userId,velocity:a.velocity,color:a.color}))}if(r<=o+a.size){e.push(s);const t=Math.max(0,a.damage-this.playerState.myPlayer.stats.defense);this.playerState.myPlayer.stats.health.value=Math.max(0,this.playerState.myPlayer.stats.health.value-t);const i={target:this.playerState.myPlayer,shooterId:a.ownerId,damage:a.damage,newHealth:this.playerState.myPlayer.stats.health.value,source:a,wasKill:this.playerState.myPlayer.stats.health.value<=0};this.playerController.playerHit(i)}}if(a.ownerId===this.userId&&this.playerState.players.forEach((t,i)=>{if(this.collisionsManager.collisionsEnabled(t)){const i=a.transform.pos.x-t.transform.pos.x,r=a.transform.pos.y-t.transform.pos.y;if(Math.sqrt(i*i+r*r)<=this.collisionsManager.getPlayerCollider(t)+a.size){e.push(s);const i=Math.max(0,a.damage-t.stats.defense),r=Math.max(0,t.stats.health.value-i);t.stats.health.value=r;const o={target:t,shooterId:this.userId,damage:a.damage,newHealth:r,source:a,wasKill:r<=0};this.playerController.playerHit(o)}}}),(a.distanceTraveled>=a.range||a.transform.pos.x<0||a.transform.pos.x>i||a.transform.pos.y<0||a.transform.pos.y>r)&&(e.push(s),a.ownerId===this.userId)){if(this.triggerCollisionUniques(a.transform.pos),a.distanceTraveled>=a.range){const t={id:`impact_${s}`,pos:{x:a.transform.pos.x,y:a.transform.pos.y},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.projectile};this.decalsManager.createDecal(t)}const t={id:`sparks_${s}`,pos:{x:a.transform.pos.x,y:a.transform.pos.y},particleParams:this.particlesManager.particlesConfig.particles.glock.projectile.sparks};this.particlesManager.createParticles(t);const e={src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.impact.metal.bullet),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.125},spatial:{blend:1,pos:{x:a.transform.pos.x,y:a.transform.pos.y}},volume:{min:.965,max:1}};this.audioManager.playAudioNetwork(e),this.roomManager.sendMessage(JSON.stringify({type:"projectile-remove",projectileId:s}))}}),e.forEach(t=>{this.projectiles.delete(t)})}toggleAutoFire(t){this.playerState.canAutoFire=!0;const e=this.playerState.myPlayer.actions.primary.buffer;this.playerState.myPlayer.actions.primary.buffer*=.5,console.log(`Auto-fire enabled until ${t}`),this.utility.safeTimeout(()=>{this.playerState.canAutoFire=!1,this.playerState.myPlayer.actions.primary.buffer=e,console.log("Auto-fire disabled.")},t-Date.now())}triggerUnique(t,a){if("cluster_module"===t&&a){const t=this.utility.getRandomInt(3,6),s=[];for(let a=0;a<t;a++)s.push(this.utility.getRandomInArray(e));const i={amount:t,damage:.1*this.playerState.myPlayer.actions.primary.projectile.damage,images:s,lifetime:{min:100,max:500},pos:{x:a.x,y:a.y},size:{min:8,max:14},speed:{min:10,max:15},torque:{min:-360,max:360}};this.particlesManager.spawnShrapnel(i)}if("projectile_array"===t){const t=this.utility.getRandomInt(1,3);for(let e=0;e<t;e++){const t=this.utility.getRandomDirection(360),e={canTriggerUnique:!1,damage:this.playerState.myPlayer.actions.primary.projectile.damage/2,range:this.utility.getRandomNum(this.playerState.myPlayer.actions.primary.projectile.range/2,this.playerState.myPlayer.actions.primary.projectile.range),spread:this.utility.getRandomNum(this.playerState.myPlayer.actions.primary.projectile.spread,2*this.playerState.myPlayer.actions.primary.projectile.spread)};this.launchProjectile(t,e)}}console.log(`Triggered Unique: ${t}`)}triggerBurstUniques(){const t=[];if(this.playerState.myPlayer.unique.includes("muzzle_splitter")&&this.luckController.luckRoll()){const e=this.playerState.myPlayer.transform.rot-Math.PI/2,a=Math.PI/180*10,s={x:Math.cos(e-a),y:Math.sin(e-a)},i={x:Math.cos(e+a),y:Math.sin(e+a)},r={canTriggerUnique:!1,damage:this.playerState.myPlayer.actions.primary.projectile.damage,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,color:this.playerState.myPlayer.actions.primary.projectile.color,length:this.playerState.myPlayer.actions.primary.projectile.length,spread:this.playerState.myPlayer.actions.primary.projectile.spread};this.launchProjectile(s,r),this.launchProjectile(i,r),console.log("Triggered burst unique: muzzle_splitter"),t.push("muzzle_splitter")}return t}triggerCollisionUniques(t){if(0===this.playerState.myPlayer.unique.length)return[];const e=[];for(const a of this.playerState.myPlayer.unique)"cluster_module"===a&&this.luckController.luckRoll()&&(this.triggerUnique(a,t),e.push("cluster_module"));return e}canReload(){return!this.playerState.isReloading&&this.playerState.myPlayer.actions.primary.magazine.currentAmmo<this.playerState.myPlayer.actions.primary.magazine.size&&this.playerState.myPlayer.actions.primary.magazine.currentReserve>0&&!this.playerState.isMelee}startReload(){this.canReload()&&(console.log("Reloading..."),this.playerState.isReloading=!0,this.playerState.reloadStartTime=Date.now(),this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0,this.decalsManager.spawnMagazineDecal(),this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:8}},duration:0,partIndex:1}),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.reload.start),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}}))}finishReload(){const t=this.playerState.myPlayer.actions.primary.magazine.size-this.playerState.myPlayer.actions.primary.magazine.currentAmmo,e=Math.min(t,this.playerState.myPlayer.actions.primary.magazine.currentReserve);this.playerState.myPlayer.actions.primary.magazine.currentAmmo+=e,this.playerState.myPlayer.actions.primary.magazine.currentReserve-=e,this.playerState.isReloading=!1,this.ui.ammoReservesUIController.removeAmmoFromReserveUI(e),this.animator.animateCharacterPart({playerId:this.userId,part:"WEAPON",frames:{0:{x:0,y:20},1:{x:0,y:0}},duration:175,partIndex:1}),this.audioManager.playAudioNetwork({src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon.glock.reload.end),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.975,max:1.05},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.985,max:1}}),console.log("Reload complete...")}}class j{constructor(t,e,a,s,i,r,o){this.collisionsManager=t,this.combatController=e,this.moveController=a,this.playerState=s,this.roomManager=i,this.staminaController=r,this.userId=o}startDash(){if(this.playerState.isDashing||!this.collisionsManager.collisionsEnabled(this.playerState.myPlayer)||!this.moveController.isMoving())return;const t=Date.now();if(t<this.playerState.lastDashTime+this.playerState.myPlayer.actions.dash.cooldown)return void console.log("Dash on cooldown");let{inputX:e,inputY:a,inputLength:s}=this.moveController.getMoveInput();if(!this.moveController.isMoving())return void console.log("No movement input for dash");if(e/=s,a/=s,!this.staminaController.requestStamina(this.playerState.myPlayer.actions.dash.drain))return void console.log("Not enough stamina to dash");this.playerState.myPlayer.unique.includes("spectral_image")&&(this.playerState.myPlayer.flags.hidden=!0,this.playerState.myPlayer.flags.invulnerable=!0,this.roomManager.sendMessage(JSON.stringify({type:"partial-state",userId:this.userId,flags:{hidden:!0,invulnerable:!0}}))),this.playerState.isDashing=!0,this.playerState.dashStartTime=t,this.playerState.lastDashTime=t;const i=this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.dash.multiplier;this.playerState.playerVelocityX=e*i,this.playerState.playerVelocityY=a*i,console.log(`Dashing! Speed: ${i}`)}updateDash(t){if(!this.playerState.isDashing)return;const e=Date.now();let a=this.playerState.myPlayer.transform.pos.x+this.playerState.playerVelocityX*t,s=this.playerState.myPlayer.transform.pos.y+this.playerState.playerVelocityY*t;this.playerState.myPlayer.transform.pos.x=a,this.playerState.myPlayer.transform.pos.y=s;let i=0!==this.playerState.playerVelocityX||0!==this.playerState.playerVelocityY;const r=Math.sqrt((this.playerState.myPlayer.transform.pos.x-this.playerState.lastSentX)**2+(this.playerState.myPlayer.transform.pos.y-this.playerState.lastSentY)**2);i&&r>2&&e-this.playerState.lastSentMoveTime>=10&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}}})),this.playerState.lastSentX=this.playerState.myPlayer.transform.pos.x,this.playerState.lastSentY=this.playerState.myPlayer.transform.pos.y,this.playerState.lastSentMoveTime=e),e>=this.playerState.dashStartTime+this.playerState.myPlayer.actions.dash.time&&(this.playerState.myPlayer.unique.includes("spectral_image")&&(this.playerState.myPlayer.flags.hidden=!1,this.playerState.myPlayer.flags.invulnerable=!1,this.roomManager.sendMessage(JSON.stringify({type:"partial-state",userId:this.userId,flags:{hidden:!1,invulnerable:!1}}))),this.playerState.isDashing=!1,this.playerState.myPlayer.equipment.includes("switch")&&this.combatController.toggleAutoFire(Date.now()+this.playerState.myPlayer.actions.dash.cooldown),console.log("Dash ended"))}}class q{constructor(t){this.playerState=t}luckRoll(t=1){const e=this.playerState.myPlayer.stats.luck*t,a=.1+.35*Math.tanh(e/10);return Math.random()<a}}class U{constructor(t,e){this.controlsManager=t,this.settingsManager=e}getMoveInput(){let t=0,e=0;this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveUp)&&(e-=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveDown)&&(e+=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveLeft)&&(t-=1),this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveRight)&&(t+=1);const a=Math.sqrt(t*t+e*e);return a>0&&(t/=a,e/=a),{inputX:t,inputY:e,inputLength:a}}isMoving(){return this.getMoveInput().inputLength>0}}class ${constructor(t,e){this.playerState=t,this.utility=e,this.ammoBoxes=new Map}spawnObject(e){const a={id:this.utility.generateUID(t),transform:e.transform,timestamp:Date.now()};if("AmmoBox"===e.type)return{id:a.id,transform:a.transform,timestamp:a.timestamp,ammoAmount:e.data?.amount||10,isOpen:!1,lid:{pos:{x:0,y:0},rot:0,velocity:{x:0,y:0},torque:0}};throw new Error(`Unknown object type: ${e.type}`)}spawnAmmoBox(t){return this.spawnObject({type:"AmmoBox",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},data:{amount:t}})}}class H{constructor(t,e,a,s,i,r,o,n,l,h,m,c,d){this.audioConfig=t,this.audioManager=e,this.decalsManager=a,this.gameState=s,this.luckController=i,this.moveController=r,this.objectsManager=o,this.particlesManager=n,this.playerState=l,this.roomManager=h,this.ui=m,this.userId=c,this.utility=d,this.setupEventListeners()}setupEventListeners(){window.addEventListener("customEvent_playerHitRelay",t=>{console.log("Player hit event received:",t.detail.params),this.playerHit(t.detail.params)})}updatePlayerPosition(t){if(!this.gameState.gameInProgress||this.playerState.myPlayer.stats.health.value<=0||this.playerState.isDashing)return;const e=Date.now(),{inputX:a,inputY:s}=this.moveController.getMoveInput(),i=this.playerState.isSprinting&&this.playerState.myPlayer.stats.stamina.value>0&&this.moveController.isMoving()?this.playerState.myPlayer.stats.speed*this.playerState.myPlayer.actions.sprint.multiplier:this.playerState.myPlayer.stats.speed;if(this.playerState.isSprinting&&this.playerState.myPlayer.stats.stamina.value<=0&&(this.playerState.isSprinting=!1,console.log("Out of stamina, stopped sprinting")),this.playerState.playerVelocityX*=Math.pow(this.playerState.myPlayer.physics.friction,t),this.playerState.playerVelocityY*=Math.pow(this.playerState.myPlayer.physics.friction,t),this.moveController.isMoving()){const e=a*i,r=s*i;this.playerState.playerVelocityX+=(e-this.playerState.playerVelocityX)*this.playerState.myPlayer.physics.acceleration*t,this.playerState.playerVelocityY+=(r-this.playerState.playerVelocityY)*this.playerState.myPlayer.physics.acceleration*t}let r=this.playerState.myPlayer.transform.pos.x+this.playerState.playerVelocityX*t,o=this.playerState.myPlayer.transform.pos.y+this.playerState.playerVelocityY*t;this.playerState.myPlayer.transform.pos.x=r,this.playerState.myPlayer.transform.pos.y=o;let n=0!==this.playerState.playerVelocityX||0!==this.playerState.playerVelocityY;const l=Math.sqrt((this.playerState.myPlayer.transform.pos.x-this.playerState.lastSentX)**2+(this.playerState.myPlayer.transform.pos.y-this.playerState.lastSentY)**2);n&&l>2&&e-this.playerState.lastSentMoveTime>=10&&(this.roomManager.sendMessage(JSON.stringify({type:"player-move",transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}}})),this.playerState.lastSentX=this.playerState.myPlayer.transform.pos.x,this.playerState.lastSentY=this.playerState.myPlayer.transform.pos.y,this.playerState.lastSentMoveTime=e),Math.abs(this.playerState.playerVelocityX)<.01&&(this.playerState.playerVelocityX=0),Math.abs(this.playerState.playerVelocityY)<.01&&(this.playerState.playerVelocityY=0)}playerHit(t){const e={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:300};if(this.utility.setSlider(e),t.target.id===this.userId){if(this.utility.getRandomNum(0,1)<.2){const t={src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.player.male.grunt),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.95,max:1.075},spatial:{blend:1,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}},volume:{min:.9,max:1}};this.audioManager.playAudioNetwork(t)}}else{const e={src:this.utility.getRandomInArray(this.audioConfig.resources.sfx.impact.flesh.bullet),listener:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},output:"sfx",pitch:{min:.925,max:1.15},spatial:{blend:1,pos:{x:t.source.transform.pos.x,y:t.source.transform.pos.y}},volume:{min:.95,max:1}};this.audioManager.playAudioNetwork(e);const a={id:`blood_${t.source.id}`,pos:{x:t.source.transform.pos.x,y:t.source.transform.pos.y},type:"parametric",parametric:this.decalsManager.decalsConfig.decals.blood};this.decalsManager.createDecal(a);const s={x:-t.source.velocity.x/Math.sqrt(t.source.velocity.x**2+t.source.velocity.y**2),y:-t.source.velocity.y/Math.sqrt(t.source.velocity.x**2+t.source.velocity.y**2)},i={id:`blood_${t.source.id}`,pos:{x:t.source.transform.pos.x,y:t.source.transform.pos.y},particleParams:this.particlesManager.particlesConfig.particles.blood.spray,direction:s};this.particlesManager.createParticles(i);const r={id:`particle_emitter_${t.target.id}_${Date.now()}`,interval:this.utility.getRandomNum(200,400),lifetime:this.utility.getRandomNum(1e3,3e3),offset:{x:t.target.transform.pos.x,y:t.target.transform.pos.y},particleType:this.particlesManager.particlesConfig.particles.blood.drip,playerId:t.target.id,pos:{x:t.source.transform.pos.x,y:t.source.transform.pos.y}};if(this.particlesManager.createEmitter(r),t.newHealth<=0){console.log(`I killed ${t.target.id}!`);const e=this.ui.leaderboard.get(this.userId);e&&e.kills++;const a=this.ui.leaderboard.get(t.target.id);a&&a.deaths++,this.ui.updateLeaderboardDisplay(this.userId)}}const a={type:"player-hit",targetId:t.target.id,shooterId:t.shooterId,damage:t.damage,newHealth:t.newHealth,projectileId:t.source.id,wasKill:t.wasKill};this.roomManager.sendMessage(JSON.stringify(a))}playerDeath(){this.triggerUniques(),console.log("I died! Waiting for round to end..."),this.playerState.resetPlayerState();const t=this.objectsManager.spawnAmmoBox(10);this.objectsManager.ammoBoxes.set(t.id,t);const e={gore:{amount:this.utility.getRandomInt(2,5)},blood:{amount:this.utility.getRandomInt(1,3)},ownerId:this.userId,pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},radius:this.playerState.myPlayer.stats.size};this.particlesManager.generateGore(e),this.roomManager.sendMessage(JSON.stringify({type:"player-death",playerId:this.userId,x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y,size:this.playerState.myPlayer.stats.size,ammoBox:t}))}triggerUniques(){if(0===this.playerState.myPlayer.unique.length)return[];const t=[];for(const e of this.playerState.myPlayer.unique)if("phoenix_module"===e&&this.luckController.luckRoll(1.5)){console.log("Phoenix Module activated!"),this.playerState.myPlayer.actions.primary.projectile.damage*=2;const e=this.playerState.myPlayer.unique.indexOf("phoenix_module");e>-1&&this.playerState.myPlayer.unique.splice(e,1),t.push("phoenix_module")}return t}}class V{constructor(t,e,a){this.playerConfig=t,this.userId=e,this.utility=a,this.players=new Map,this.isHost=!1,this.canShoot=!0,this.canAutoFire=!1,this.isBurstActive=!1,this.isReloading=!1,this.isMelee=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.lastSentX=0,this.lastSentY=0,this.lastSentRotation=0,this.lastSentRotationTime=0,this.lastSentMoveTime=0,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastShotTime=0,this.lastMeleeTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0,this.statListeners=new Map,this.myPlayer=this.initPlayer(this.userId)}initPlayer(t){return this.myPlayer={id:t,transform:{pos:{x:770*Math.random()+o,y:570*Math.random()+o},rot:0},timestamp:Date.now(),color:this.utility.getRandomColor(),actions:{dash:{cooldown:this.playerConfig.default.actions.dash.cooldown,drain:this.playerConfig.default.actions.dash.drain,multiplier:this.playerConfig.default.actions.dash.multiplier,time:this.playerConfig.default.actions.dash.time},melee:{cooldown:this.playerConfig.default.actions.melee.cooldown,damage:this.playerConfig.default.actions.melee.damage,duration:this.playerConfig.default.actions.melee.duration,range:this.playerConfig.default.actions.melee.range,size:this.playerConfig.default.actions.melee.size},primary:{buffer:this.playerConfig.default.actions.primary.buffer,burst:{amount:this.playerConfig.default.actions.primary.burst.amount,delay:this.playerConfig.default.actions.primary.burst.delay},magazine:{currentAmmo:this.playerConfig.default.actions.primary.magazine.size,currentReserve:this.playerConfig.default.actions.primary.magazine.startingReserve,maxReserve:this.playerConfig.default.actions.primary.magazine.maxReserve,size:this.playerConfig.default.actions.primary.magazine.size},offset:this.playerConfig.default.actions.primary.offset,projectile:{amount:this.playerConfig.default.actions.primary.projectile.amount,color:this.playerConfig.default.actions.primary.projectile.color,damage:this.playerConfig.default.actions.primary.projectile.damage,length:this.playerConfig.default.actions.primary.projectile.length,range:this.playerConfig.default.actions.primary.projectile.range,size:this.playerConfig.default.actions.primary.projectile.size,speed:this.playerConfig.default.actions.primary.projectile.speed,spread:this.playerConfig.default.actions.primary.projectile.spread},reload:{time:this.playerConfig.default.actions.primary.reload.time}},sprint:{drain:this.playerConfig.default.actions.sprint.drain,multiplier:this.playerConfig.default.actions.sprint.multiplier}},equipment:this.playerConfig.default.equipment,flags:{hidden:this.playerConfig.default.flags.hidden,invulnerable:this.playerConfig.default.flags.invulnerable},inventory:{primary:this.playerConfig.default.inventory.primary,melee:this.playerConfig.default.inventory.melee},physics:{acceleration:this.playerConfig.default.physics.acceleration,friction:this.playerConfig.default.physics.friction},rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon},stats:{defense:this.playerConfig.default.stats.defense,health:{max:this.playerConfig.default.stats.health.max,value:this.playerConfig.default.stats.health.max},luck:this.playerConfig.default.stats.luck,size:this.playerConfig.default.stats.size,speed:this.playerConfig.default.stats.speed,stamina:{max:this.playerConfig.default.stats.stamina.max,recovery:{delay:this.playerConfig.default.stats.stamina.recovery.delay,rate:this.playerConfig.default.stats.stamina.recovery.rate},value:this.playerConfig.default.stats.stamina.max}},unique:this.playerConfig.default.unique}}resetPlayerState(){this.canShoot=!0,this.isBurstActive=!1,this.isReloading=!1,this.isMelee=!1,this.isSprinting=!1,this.isDashing=!1,this.isStaminaRecoveryBlocked=!1,this.playerVelocityX=0,this.playerVelocityY=0,this.dashStartTime=0,this.lastDashTime=0,this.reloadStartTime=0,this.lastMeleeTime=0,this.lastShotTime=0,this.nextBurstShotTime=0,this.currentBurstShot=0,this.lastStaminaDrainTime=0,this.staminaRecoveryBlockedUntil=0,this.lastSentX=0,this.lastSentY=0,this.lastSentRotation=0,this.lastSentRotationTime=0,this.lastSentMoveTime=0}onStatChange(t,e){this.statListeners.set(t,e)}notifyChange(t,e){const a=this.statListeners.get(t);a&&a(e)}updateStat(t,e){const a=t.split(".");let s=this.myPlayer;for(let t=0;t<a.length-1;t++)s=s[a[t]];const i=a[a.length-1];s[i]=e,console.log(`${i}: ${e}`),this.notifyChange(t,e)}}class F{constructor(t){this.playerState=t}requestStamina(t){return this.playerState.myPlayer.stats.stamina.value<t?(console.log(`Insufficient stamina! Need: ${t}, Have: ${this.playerState.myPlayer.stats.stamina}`),!1):(this.playerState.myPlayer.stats.stamina.value-=t,this.playerState.isStaminaRecoveryBlocked=!0,this.playerState.staminaRecoveryBlockedUntil=Date.now()+this.playerState.myPlayer.stats.stamina.recovery.delay,console.log(`Stamina drained: -${t}, Remaining: ${this.playerState.myPlayer.stats.stamina}`),!0)}updateStamina(t){const e=Date.now();if(this.playerState.isSprinting&&e>=this.playerState.lastStaminaDrainTime+100&&(this.requestStamina(this.playerState.myPlayer.actions.sprint.drain)||(this.playerState.isSprinting=!1,console.log("Out of stamina, stopped sprinting")),this.playerState.lastStaminaDrainTime=e),(!this.playerState.isStaminaRecoveryBlocked||e>=this.playerState.staminaRecoveryBlockedUntil)&&(this.playerState.isStaminaRecoveryBlocked=!1,this.playerState.myPlayer.stats.stamina.value<this.playerState.myPlayer.stats.stamina.max&&!this.playerState.isSprinting)){const e=this.playerState.myPlayer.stats.stamina.recovery.rate/1e3*16.67*t;this.playerState.myPlayer.stats.stamina.value=Math.min(this.playerState.myPlayer.stats.stamina.max,this.playerState.myPlayer.stats.stamina.value+e)}}}class K{constructor(){this.default={actions:{dash:{cooldown:1e3,drain:40,multiplier:3,time:150},melee:{cooldown:250,damage:10,duration:100,range:10,size:2},primary:{buffer:250,burst:{amount:1,delay:75},magazine:{size:10,startingReserve:20,maxReserve:50},offset:10,projectile:{amount:1,color:"#fff5beff",damage:25,length:15,range:5,size:1,speed:35,spread:10},reload:{time:750}},sprint:{drain:5,multiplier:1.75}},data:{idLength:12,idOffset:25},equipment:[],flags:{hidden:!1,invulnerable:!1},inventory:{primary:"glock",melee:"knife"},physics:{acceleration:.65,friction:.8},rig:{body:"default",head:"default",headwear:"default",weapon:"glock"},stats:{defense:0,health:{max:100},luck:1,size:100,speed:6,stamina:{max:100,recovery:{delay:1e3,rate:25}}},unique:[]}}}class W{constructor(){this.mixer={master:1,interface:.85,music:.75,sfx:.9,voice:1},this.resources={sfx:{impact:{flesh:{bullet:["/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_00.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_01.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_02.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_03.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_04.ogg","/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_05.ogg"]},metal:{bullet:["/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_00.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_01.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_02.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_03.ogg","/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_04.ogg"]}},player:{male:{grunt:["/assets/audio/sfx/player/voice/male/player_male_hit_00.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_01.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_02.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_03.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_04.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_05.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_06.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_07.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_08.ogg","/assets/audio/sfx/player/voice/male/player_male_hit_09.ogg"]}},weapon:{glock:{attack:["/assets/audio/sfx/weapons/glock/glock_attack_00.ogg","/assets/audio/sfx/weapons/glock/glock_attack_01.ogg","/assets/audio/sfx/weapons/glock/glock_attack_02.ogg","/assets/audio/sfx/weapons/glock/glock_attack_03.ogg","/assets/audio/sfx/weapons/glock/glock_attack_04.ogg","/assets/audio/sfx/weapons/glock/glock_attack_05.ogg"],empty:["/assets/audio/sfx/weapons/glock/glock_empty_00.ogg"],reload:{end:["/assets/audio/sfx/weapons/glock/glock_reload_end_00.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_01.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_02.ogg","/assets/audio/sfx/weapons/glock/glock_reload_end_03.ogg"],start:["/assets/audio/sfx/weapons/glock/glock_reload_start_00.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_01.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_02.ogg","/assets/audio/sfx/weapons/glock/glock_reload_start_03.ogg"]},shell:["/assets/audio/sfx/weapons/glock/glock_shell_00.ogg","/assets/audio/sfx/weapons/glock/glock_shell_01.ogg","/assets/audio/sfx/weapons/glock/glock_shell_02.ogg","/assets/audio/sfx/weapons/glock/glock_shell_03.ogg","/assets/audio/sfx/weapons/glock/glock_shell_04.ogg","/assets/audio/sfx/weapons/glock/glock_shell_05.ogg","/assets/audio/sfx/weapons/glock/glock_shell_06.ogg","/assets/audio/sfx/weapons/glock/glock_shell_07.ogg","/assets/audio/sfx/weapons/glock/glock_shell_08.ogg","/assets/audio/sfx/weapons/glock/glock_shell_09.ogg","/assets/audio/sfx/weapons/glock/glock_shell_10.ogg","/assets/audio/sfx/weapons/glock/glock_shell_11.ogg","/assets/audio/sfx/weapons/glock/glock_shell_12.ogg","/assets/audio/sfx/weapons/glock/glock_shell_13.ogg","/assets/audio/sfx/weapons/glock/glock_shell_14.ogg"]}}}},this.settings={maxConcurrent:5,poolSize:10,preloadSounds:!0}}}class G{constructor(){this.isRoundInProgress=!1,this.roundWinner=null,this.gameWinner=null,this.cacheManager=new u,this.utility=new z,this.gameState=new M,this.audioConfig=new W,this.settingsManager=new B(this.audioConfig,this.cacheManager),this.controlsManager=new S(this.settingsManager),this.charConfig=new p,this.charManager=new g(this.charConfig),this.playerConfig=new K,this.userId=this.utility.generateUID(this.playerConfig.default.data.idLength),this.playerState=new V(this.playerConfig,this.userId,this.utility),this.ui=new D(this.playerState,this.settingsManager,this.utility),this.admin=new m(this.cacheManager,this.ui),this.objectsManager=new $(this.playerState,this.utility),this.roomManager=new k(this.userId,this.utility),this.lobbyManager=new I(this.charManager,this.playerConfig,this.playerState,this.roomManager,this.ui,this.utility),this.wsManager=new O(this.gameState,this.roomManager,this.utility),this.chatManager=new f(this.roomManager,this.ui),this.upgradeManager=new A(this.playerConfig,this.playerState,this.ui,this.utility),this.roomController=new R(this.gameState,this.lobbyManager,this.playerState,this.roomManager,this.ui,this.upgradeManager,this.userId,this.utility,this.wsManager),this.collisionsManager=new x(this.objectsManager,this.playerState,this.roomManager,this.ui,this.userId),this.moveController=new U(this.controlsManager,this.settingsManager),this.staminaController=new F(this.playerState),this.luckController=new q(this.playerState),this.audioManager=new y(this.audioConfig,this.roomManager,this.settingsManager,this.utility),this.animator=new c(this.playerState,this.roomManager,this.userId),this.renderingManager=new E(this.animator,this.charManager,this.lobbyManager,this.objectsManager,this.playerConfig,this.ui,this.userId),this.decalsManager=new b(this.charConfig,this.playerState,this.roomManager,this.ui,this.userId,this.utility),this.particlesManager=new w(this.charConfig,this.collisionsManager,this.decalsManager,this.playerState,this.renderingManager,this.roomManager,this.ui,this.userId,this.utility),this.playerController=new H(this.audioConfig,this.audioManager,this.decalsManager,this.gameState,this.luckController,this.moveController,this.objectsManager,this.particlesManager,this.playerState,this.roomManager,this.ui,this.userId,this.utility),this.combatController=new N(this.animator,this.audioConfig,this.audioManager,this.collisionsManager,this.decalsManager,this.gameState,this.luckController,this.particlesManager,this.playerController,this.playerState,this.roomManager,this.ui,this.userId,this.utility),this.dashController=new j(this.collisionsManager,this.combatController,this.moveController,this.playerState,this.roomManager,this.staminaController,this.userId),this.eventsManager=new v(this.animator,this.chatManager,this.controlsManager,this.gameState,this.roomController,this.playerState,this.settingsManager,this.ui,this.userId),"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{this.initClient()}):this.initClient(),document.addEventListener("keydown",t=>{if("Escape"===t.key&&this.gameState.gameInProgress&&!this.lobbyManager.inLobby){t.preventDefault();const e=20;this.playerState.myPlayer.actions.primary.magazine.currentReserve+=e,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(e)}})}async initClient(){this.ui.initInterface(),this.eventsManager.initEventListeners(),this.initGlobalEvents(),this.roomController.checkForRoomInURL(),this.roomController.showRoomControls();const t={spanId:"userId",value:this.userId};this.utility.setSpan(t),await this.settingsManager.loadSettings();const e=this.settingsManager.getSettings();this.ui.initSoundSliders(e),this.ui.initSettingsInputs(e),this.ui.initSettingsToggles(e),this.ui.ammoReservesUIController.initAmmoReserveCanvas(),this.eventsManager.initKeybindListeners(),this.audioConfig.settings.preloadSounds&&this.audioManager.preloadAudioAssets(this.audioConfig.resources.sfx,".ogg"),this.watchForInputs(),this.admin.onAdminCommand=(t,e)=>{this.roomManager.sendAdminCommand(t,e)}}initGlobalEvents(){window.addEventListener("customEvent_startGame",()=>this.startGame()),window.addEventListener("customEvent_resetGameState",t=>{const e=t;this.resetGameState(e.detail.resetType)}),this.roomManager.onMessage(t=>this.handleRoomMessage(t))}handleRoomMessage(t){switch(t.type){case"room-created":console.log("Room created");break;case"room-joined":console.log("Joined room - lobby"),this.playerState.isHost=!1,this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId}),this.roomManager.sendMessage(JSON.stringify({type:"lobby-join",color:this.playerState.myPlayer.color,rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon}}));const e=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,a=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyManager.lobbyPlayers.set(this.userId,{id:this.userId,color:this.playerState.myPlayer.color,isHost:this.playerState.isHost,rig:{body:this.playerConfig.default.rig.body,head:this.playerConfig.default.rig.head,headwear:this.playerConfig.default.rig.headwear,weapon:this.playerConfig.default.rig.weapon},transform:{pos:{x:e,y:a},rot:0}}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),0===this.lobbyManager.lobbyPlayers.size&&(this.playerState.isHost=!0,this.lobbyManager.lobbyPlayers.get(this.userId).isHost=!0,this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),console.log("I am the only player in the room..."));break;case"user-left":console.log(`User ${t.userId} left`),this.lobbyManager.lobbyPlayers.delete(t.userId),this.playerState.players.delete(t.userId),this.ui.leaderboard.delete(t.userId),this.ui.updateLeaderboardDisplay(this.userId),console.log(`Removed ${t.userId} from leaderboard`),this.combatController.projectiles.forEach((e,a)=>{e.ownerId===t.userId&&this.combatController.projectiles.delete(a)}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId);break;case"room-message":this.handleGameMessage(t);break;case"room-error":alert(`Error: ${t.message}`)}}handleGameMessage(t){if(t.message)try{const e=JSON.parse(t.message);switch(e.type){case"lobby-join":const a=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.width/2:0,s=this.ui.charCustomizeCanvas?this.ui.charCustomizeCanvas.height/2:0;this.lobbyManager.lobbyPlayers.set(t.userId,{id:t.userId,color:e.color,isHost:!1,rig:e.rig,transform:{pos:{x:a,y:s},rot:0}}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.playerState.isHost&&this.roomManager.sendMessage(JSON.stringify({type:"lobby-state",players:Array.from(this.lobbyManager.lobbyPlayers.values()),options:{privateRoom:this.roomManager.isPrivateRoom,maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,upgradesEnabled:this.upgradeManager.isUpgradesEnabled}}));break;case"lobby-state":this.lobbyManager.lobbyPlayers.clear(),e.players.forEach(t=>{this.lobbyManager.lobbyPlayers.set(t.id,t)}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager),e.options&&this.lobbyManager.syncLobbyOptions(e.options);break;case"lobby-options":this.lobbyManager.syncLobbyOptions(e);break;case"promote-player":this.lobbyManager.lobbyPlayers.forEach((t,a)=>{t.isHost=a===e.targetPlayerId}),this.playerState.isHost=e.targetPlayerId===this.userId,this.playerState.isHost&&"host-migration"===e.reason&&console.log("I am now the host due to host migration"),this.lobbyManager.setupLobbyOptions({maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled}),this.ui.displayLobbyPlayers(this.playerState.isHost,this.lobbyManager,this.userId),this.ui.updateHostDisplay(this.playerState.isHost,this.lobbyManager);break;case"return-to-lobby":console.log("Returning to lobby - last player or game ended"),e.newHostId===this.userId&&(this.playerState.isHost=!0,console.log("I am now the host as the last remaining player")),this.resetGameState("Lobby"),this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId});break;case"kick-player":e.targetPlayerId===this.userId&&(alert("You have been kicked from the lobby"),this.roomController.leaveRoom());break;case"chat-message":t.userId!==this.userId&&this.chatManager.displayChatMessage({senderId:t.userId,message:e.message,isOwn:!1});break;case"player-state":console.log("Player State for player",e.id,":",e),this.lobbyManager.inLobby||this.playerState.players.set(t.userId,{id:t.userId,transform:{pos:{x:e.transform?.pos.x,y:e.transform?.pos.y},rot:e.transform?.rot},timestamp:e.timestamp,color:e.color,actions:{dash:{cooldown:e.actions?.dash.cooldown||this.playerConfig.default.actions.dash.cooldown,drain:e.actions?.dash.drain||this.playerConfig.default.actions.dash.drain,multiplier:e.actions?.dash.multiplier||this.playerConfig.default.actions.dash.multiplier,time:e.actions?.dash.time||this.playerConfig.default.actions.dash.time},melee:{cooldown:e.actions?.melee.cooldown||this.playerConfig.default.actions.melee.cooldown,damage:e.actions?.melee.damage||this.playerConfig.default.actions.melee.damage,duration:e.actions?.melee.duration||this.playerConfig.default.actions.melee.duration,range:e.actions?.melee.range||this.playerConfig.default.actions.melee.range,size:e.actions?.melee.size||this.playerConfig.default.actions.melee.size},primary:{buffer:e.actions?.primary.buffer||this.playerConfig.default.actions.primary.buffer,burst:{amount:e.actions?.primary.burst.amount||this.playerConfig.default.actions.primary.burst.amount,delay:e.actions?.primary.burst.delay||this.playerConfig.default.actions.primary.burst.delay},magazine:{currentAmmo:e.actions?.primary.magazine.currentAmmo,currentReserve:e.actions?.primary.magazine.currentReserve,maxReserve:e.actions?.primary.magazine.maxReserve,size:e.actions?.primary.magazine.size||this.playerConfig.default.actions.primary.magazine.size},offset:e.actions?.primary.offset||this.playerConfig.default.actions.primary.offset,projectile:{amount:e.actions?.primary.projectile.amount||this.playerConfig.default.actions.primary.projectile.amount,color:e.actions?.primary.projectile.color||this.playerConfig.default.actions.primary.projectile.color,damage:e.actions?.primary.projectile.damage||this.playerConfig.default.actions.primary.projectile.damage,length:e.actions?.primary.projectile.length||this.playerConfig.default.actions.primary.projectile.length,range:e.actions?.primary.projectile.range||this.playerConfig.default.actions.primary.projectile.range,size:e.actions?.primary.projectile.size||this.playerConfig.default.actions.primary.projectile.size,speed:e.actions?.primary.projectile.speed||this.playerConfig.default.actions.primary.projectile.speed,spread:e.actions?.primary.projectile.spread||this.playerConfig.default.actions.primary.projectile.spread},reload:{time:e.actions?.primary.reload.time||this.playerConfig.default.actions.primary.reload.time}},sprint:{drain:e.actions?.sprint.drain||this.playerConfig.default.actions.sprint.drain,multiplier:e.actions?.sprint.multiplier||this.playerConfig.default.actions.sprint.multiplier}},equipment:e.equipment||this.playerConfig.default.equipment,flags:{hidden:e.flags?.hidden||this.playerConfig.default.flags.hidden,invulnerable:e.flags?.invulnerable||this.playerConfig.default.flags.invulnerable},inventory:{primary:e.inventory?.primary||this.playerConfig.default.inventory.primary,melee:e.inventory?.melee||this.playerConfig.default.inventory.melee},physics:{acceleration:e.physics?.acceleration||this.playerConfig.default.physics.acceleration,friction:e.physics?.friction||this.playerConfig.default.physics.friction},rig:{body:e.rig?.body||this.playerConfig.default.rig.body,head:e.rig?.head||this.playerConfig.default.rig.head,headwear:e.rig?.headwear||this.playerConfig.default.rig.headwear,weapon:e.rig?.weapon||this.playerConfig.default.rig.weapon},stats:{defense:e.stats?.defense||this.playerConfig.default.stats.defense,health:{max:e.stats?.health.max||this.playerConfig.default.stats.health.max,value:e.stats?.health.value||this.playerConfig.default.stats.health.max},luck:e.stats?.luck||this.playerConfig.default.stats.luck,size:e.stats?.size||this.playerConfig.default.stats.size,speed:e.stats?.speed||this.playerConfig.default.stats.speed,stamina:{max:e.stats?.stamina.max||this.playerConfig.default.stats.stamina.max,recovery:{delay:e.stats?.stamina.recovery.delay||this.playerConfig.default.stats.stamina.recovery.delay,rate:e.stats?.stamina.recovery.rate||this.playerConfig.default.stats.stamina.recovery.rate},value:e.stats?.stamina.value||this.playerConfig.default.stats.stamina.max}},unique:e.unique||this.playerConfig.default.unique}),e.leaderboard&&e.leaderboard.forEach(([t,e])=>{this.ui.leaderboard.set(t,e)}),this.ui.createLeaderboard(this.lobbyManager,this.playerState.players,this.userId);break;case"partial-state":{if(t.userId===this.userId)return;const a=this.playerState.players.get(t.userId);if(!a)break;console.log("Partial State update for player",t.userId,":",e),this.utility.deepMerge(a,e);break}case"player-move":if(!this.lobbyManager.inLobby&&this.playerState.players.has(t.userId)){const a=this.playerState.players.get(t.userId);if(!a)break;e.transform.pos&&(a.transform.pos.x=e.transform.pos.x,a.transform.pos.y=e.transform.pos.y),void 0!==e.transform.rot&&(a.transform.rot=e.transform.rot)}break;case"player-hit":if(e.projectileId&&this.combatController.projectiles.delete(e.projectileId),e.targetId===this.userId){this.playerState.myPlayer.stats.health.value=e.newHealth;const t=300,a={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:t};this.utility.setSlider(a),this.playerState.myPlayer.stats.health.value<=0&&this.playerController.playerDeath()}else if(this.playerState.players.has(e.targetId)){const t=this.playerState.players.get(e.targetId);if(!t)break;t.stats.health.value=e.newHealth,t.stats.health.value<=0&&console.log(`Player ${t.id} died`)}if(e.wasKill){const t=this.ui.leaderboard.get(e.shooterId);t&&t.kills++;const a=this.ui.leaderboard.get(e.targetId);a&&a.deaths++,this.ui.updateLeaderboardDisplay(this.userId)}break;case"player-death":t.userId!==this.userId&&e.ammoBox&&(this.objectsManager.ammoBoxes.set(e.ammoBox.id,e.ammoBox),console.log(`Ammo box spawned at death of ${t.userId}`));const i={gore:{amount:this.utility.getRandomInt(2,5)},blood:{amount:this.utility.getRandomInt(1,3)},ownerId:t.userId,pos:{x:e.x,y:e.y},radius:e.size};this.particlesManager.generateGore(i),console.log(`Generated gore for ${t.userId}`);break;case"ammo-pickup":if(e.playerId===this.userId)break;if(this.objectsManager.ammoBoxes.has(e.ammoBoxId)){const t=this.objectsManager.ammoBoxes.get(e.ammoBoxId);if(!t)break;t.isOpen=e.boxState.isOpen,t.lid=e.boxState.lid,console.log(`Ammo box opened by ${e.playerId}`)}break;case"weapon-change":if(t.userId!==this.userId&&this.playerState.players.has(t.userId)){const a=this.playerState.players.get(t.userId);if(!a)break;a.rig.weapon=e.weapon,console.log(`${t.userId} switched to ${e.weapon}`)}break;case"projectile-launch":this.lobbyManager.inLobby||t.userId===this.userId||this.combatController.projectiles.set(e.projectile.id,e.projectile);break;case"projectile-remove":this.lobbyManager.inLobby||this.combatController.projectiles.delete(e.projectileId);break;case"projectile-update":if(!this.lobbyManager.inLobby&&this.combatController.projectiles.has(e.projectileId)){const t=this.combatController.projectiles.get(e.projectileId);if(!t)break;t.ownerId=e.newOwnerId,t.velocity=e.velocity,t.color=e.color,t.transform.rot=Math.atan2(t.velocity.y,t.velocity.x),console.log(`Projectile ${e.projectileId} data updated by ${e.newOwnerId}`)}break;case"start-game":e.spawnMap&&e.spawnMap[this.userId]&&(this.playerState.myPlayer.transform.pos.x=e.spawnMap[this.userId].x,this.playerState.myPlayer.transform.pos.y=e.spawnMap[this.userId].y,console.log("My Player Spawn:",e.spawnMap[this.userId].x,e.spawnMap[this.userId].y)),e.spawnMap&&this.playerState.players.forEach((t,a)=>{e.spawnMap[a]&&(t.transform.pos.x=e.spawnMap[a].x,t.transform.pos.y=e.spawnMap[a].y,console.log(`Player ${a} spawn:`,e.spawnMap[a].x,e.spawnMap[a].y))}),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop();break;case"game-end":console.log(`Game ended! Winner: ${e.winnerId}`),this.gameWinner=e.winnerId;break;case"round-end":console.log(`Round ended! Winner: ${e.winnerId||"No one"}`),this.endRound(e.winnerId);break;case"new-round":if(!e.spawnMap)return;console.log(e.spawnMap),this.ui.upgradeContainer&&(this.ui.upgradeContainer.style.display="none"),console.log("New round started! Everyone respawning..."),this.isRoundInProgress=!0,this.roundWinner=null,this.playerState.myPlayer.stats.health.value=this.playerState.myPlayer.stats.health.max;const r=300,o={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:r},n={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:r};this.utility.setSlider(o),this.utility.setSlider(n),this.playerState.myPlayer.transform.pos.x=e.spawnMap[this.userId].x,this.playerState.myPlayer.transform.pos.y=e.spawnMap[this.userId].y,this.resumeGame(),this.playerState.players.forEach((t,a)=>{e.spawnMap[a]&&(t.transform.pos.x=e.spawnMap[t.id].x,t.transform.pos.y=e.spawnMap[t.id].y,t.transform.rot=0,t.stats.health.value=t.stats.health.max,t.stats.stamina.value=t.stats.stamina.max)});break;case"upgrade-taken":e.upgradeId&&e.isUnique&&(this.upgradeManager.removeUpgradeFromPool(e.upgradeId),console.log(`Unique upgrade ${e.upgradeId} taken by ${t.userId}`)),this.roundWinner===this.userId&&(this.upgradeManager.upgradesCompleted.add(t.userId),console.log(`${t.userId} completed upgrade. ${this.upgradeManager.upgradesCompleted.size}/${this.playerState.players.size} done`),this.upgradeManager.upgradesCompleted.size>=this.playerState.players.size&&this.showWinnerContinueButton());break;case"play-audio":t.userId!==this.userId&&this.audioManager.playAudio(e.params);break;case"add-decal":t.userId!==this.userId&&this.decalsManager.createDecalNetwork(e.params);break;case"add-particles":t.userId!==this.userId&&this.particlesManager.createParticlesNetwork(e.params);break;case"particle-emitter":if(t.userId!==this.userId){const t={id:e.id,interval:e.interval,lifetime:e.lifetime,offset:{x:e.offset.x,y:e.offset.y},particleType:e.particleType,playerId:e.playerId,pos:{x:e.pos.x,y:e.pos.y}};this.particlesManager.generateEmitter(t)}break;case"character-animation":e.params.playerId!==this.userId&&this.animator.animateCharacterPartNetwork(e.params);break;case"shrapnel-spawn":t.userId!==this.userId&&this.particlesManager.generateShrapnel(e.pieces)}}catch(t){console.error("Error parsing game message:",t)}}returnToLobby(){this.resetGameState("Lobby"),this.roomManager.sendMessage(JSON.stringify({type:"return-to-lobby",reason:"game-ended"})),this.lobbyManager.showLobbyControls({lobby:this.lobbyManager,lobbyOptions:{maxPlayers:this.gameState.gameMaxPlayers,maxWins:this.gameState.gameMaxWins,isHost:this.playerState.isHost,privateRoom:this.roomManager.isPrivateRoom,upgradesEnabled:this.upgradeManager.isUpgradesEnabled},myPlayer:this.playerState.myPlayer,roomId:this.roomManager.getCurrentRoom()||"",userId:this.userId})}endRound(t){if(this.isRoundInProgress){if(console.log(`Server confirmed round end. Winner: ${t||"No one"}`),this.isRoundInProgress=!1,this.roundWinner=t,!t)return console.log("Round ended with no survivors!"),void(this.playerState.isHost&&this.utility.safeTimeout(()=>{this.startNewRound()},l.ROUND_END_DELAY));if(t&&this.ui.leaderboard.has(t)){const e=this.ui.leaderboard.get(t);if(!e)return;if(e.wins++,console.log(`${t} won the round! Total wins: ${e.wins}`),e.wins>=this.gameState.gameMaxWins)return void this.endGame(t);this.ui.updateLeaderboardDisplay(this.userId)}this.utility.safeTimeout(()=>{this.pauseGame()},l.ROUND_END_DELAY/6),this.utility.safeTimeout(()=>{this.startUpgradePhase(t)},l.ROUND_END_DELAY)}else console.log("Ignoring endRound - round already ended")}endGame(t){this.gameWinner=t,console.log(`${t} won the game with ${this.gameState.gameMaxWins} wins!`),this.roomManager.sendMessage(JSON.stringify({type:"game-end",winnerId:t})),this.utility.safeTimeout(()=>{this.returnToLobby()},l.GAME_END_DELAY)}startNewRound(){console.log("Starting new round..."),this.playerState.players.forEach(t=>{t.transform.rot=0,t.timestamp=t.timestamp||Date.now(),t.actions.dash.cooldown=t.actions.dash.cooldown||this.playerConfig.default.actions.dash.cooldown,t.actions.dash.drain=t.actions.dash.drain||this.playerConfig.default.actions.dash.drain,t.actions.dash.multiplier=t.actions.dash.multiplier||this.playerConfig.default.actions.dash.multiplier,t.actions.dash.time=t.actions.dash.time||this.playerConfig.default.actions.dash.time,t.actions.melee.cooldown=t.actions.melee.cooldown||this.playerConfig.default.actions.melee.cooldown,t.actions.melee.damage=t.actions.melee.damage||this.playerConfig.default.actions.melee.damage,t.actions.melee.duration=t.actions.melee.duration||this.playerConfig.default.actions.melee.duration,t.actions.melee.range=t.actions.melee.range||this.playerConfig.default.actions.melee.range,t.actions.melee.size=t.actions.melee.size||this.playerConfig.default.actions.melee.size,t.actions.primary.buffer=t.actions.primary.buffer||this.playerConfig.default.actions.primary.buffer,t.actions.primary.burst.amount=t.actions.primary.burst.amount||this.playerConfig.default.actions.primary.burst.amount,t.actions.primary.burst.delay=t.actions.primary.burst.delay||this.playerConfig.default.actions.primary.burst.delay,t.actions.primary.magazine.currentAmmo=t.actions.primary.magazine.currentAmmo||this.playerConfig.default.actions.primary.magazine.size,t.actions.primary.magazine.currentReserve=t.actions.primary.magazine.currentReserve||this.playerConfig.default.actions.primary.magazine.startingReserve,t.actions.primary.magazine.maxReserve=t.actions.primary.magazine.maxReserve||this.playerConfig.default.actions.primary.magazine.maxReserve,t.actions.primary.magazine.size=t.actions.primary.magazine.size||this.playerConfig.default.actions.primary.magazine.size,t.actions.primary.offset=t.actions.primary.offset||this.playerConfig.default.actions.primary.offset,t.actions.primary.projectile.amount=t.actions.primary.projectile.amount||this.playerConfig.default.actions.primary.projectile.amount,t.actions.primary.projectile.color=t.actions.primary.projectile.color||this.playerConfig.default.actions.primary.projectile.color,t.actions.primary.projectile.damage=t.actions.primary.projectile.damage||this.playerConfig.default.actions.primary.projectile.damage,t.actions.primary.projectile.length=t.actions.primary.projectile.length||this.playerConfig.default.actions.primary.projectile.length,t.actions.primary.projectile.range=t.actions.primary.projectile.range||this.playerConfig.default.actions.primary.projectile.range,t.actions.primary.projectile.size=t.actions.primary.projectile.size||this.playerConfig.default.actions.primary.projectile.size,t.actions.primary.projectile.speed=t.actions.primary.projectile.speed||this.playerConfig.default.actions.primary.projectile.speed,t.actions.primary.projectile.spread=t.actions.primary.projectile.spread||this.playerConfig.default.actions.primary.projectile.spread,t.actions.primary.reload.time=t.actions.primary.reload.time||this.playerConfig.default.actions.primary.reload.time,t.actions.sprint.drain=t.actions.sprint.drain||this.playerConfig.default.actions.sprint.drain,t.actions.sprint.multiplier=t.actions.sprint.multiplier||this.playerConfig.default.actions.sprint.multiplier,t.equipment=t.equipment||this.playerConfig.default.equipment,t.flags.hidden=t.flags.hidden||this.playerConfig.default.flags.hidden,t.flags.invulnerable=t.flags.invulnerable||this.playerConfig.default.flags.invulnerable,t.inventory.primary=t.inventory.primary||this.playerConfig.default.inventory.primary,t.inventory.melee=t.inventory.melee||this.playerConfig.default.inventory.melee,t.physics.acceleration=t.physics.acceleration||this.playerConfig.default.physics.acceleration,t.physics.friction=t.physics.friction||this.playerConfig.default.physics.friction,t.rig.body=t.rig.body||this.playerConfig.default.rig.body,t.rig.head=t.rig.head||this.playerConfig.default.rig.head,t.rig.headwear=t.rig.headwear||this.playerConfig.default.rig.headwear,t.rig.weapon=t.rig.weapon||this.playerConfig.default.rig.weapon,t.stats.defense=t.stats.defense||this.playerConfig.default.stats.defense,t.stats.health.max=t.stats.health.max||this.playerConfig.default.stats.health.max,t.stats.health.value=t.stats.health.max||this.playerConfig.default.stats.health.max,t.stats.luck=t.stats.luck||this.playerConfig.default.stats.luck,t.stats.size=t.stats.size||this.playerConfig.default.stats.size,t.stats.speed=t.stats.speed||this.playerConfig.default.stats.speed,t.stats.stamina.max=t.stats.stamina.max||this.playerConfig.default.stats.stamina.max,t.stats.stamina.recovery.delay=t.stats.stamina.recovery.delay||this.playerConfig.default.stats.stamina.recovery.delay,t.stats.stamina.recovery.rate=t.stats.stamina.recovery.rate||this.playerConfig.default.stats.stamina.recovery.rate,t.stats.stamina.value=t.stats.stamina.value||this.playerConfig.default.stats.stamina.max,t.unique=t.unique||this.playerConfig.default.unique}),this.roomManager.sendMessage(JSON.stringify({type:"new-round",reservedSpawn:{x:770*Math.random()+o,y:570*Math.random()+o}}))}showGameControls(t){this.ui.updateDisplay(this.lobbyManager,"game",t)}startGame(){this.playerState.isHost&&(1!==this.lobbyManager.lobbyPlayers.size?this.executeStartGame():this.ui.soloGameWarning(()=>this.executeStartGame()))}executeStartGame(){this.roomManager.sendMessage(JSON.stringify({type:"start-game",reservedSpawn:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y}})),this.showGameControls(this.roomManager.getCurrentRoom()||""),this.startGameLoop()}startGameLoop(){this.gameState.gameInProgress=!0,this.isRoundInProgress=!0,this.playerState.myPlayer.actions.primary.magazine.currentReserve=Math.floor(this.playerConfig.default.actions.primary.magazine.maxReserve/2),this.playerState.myPlayer.actions.primary.magazine.currentAmmo=this.playerState.myPlayer.actions.primary.magazine.size,this.ui.ammoReservesUIController.spawnAmmoInReserveUI(this.playerState.myPlayer.actions.primary.magazine.currentReserve),this.playerState.isReloading=!1,this.ui.createLeaderboard(this.lobbyManager,this.playerState.players,this.userId),this.upgradeManager.resetUpgrades(this.playerState.myPlayer);const t=this.lobbyManager.lobbyPlayers.get(this.userId);t&&(console.log("Found lobby rig for my player: ",t.rig),this.playerState.myPlayer.rig.body=t.rig.body,this.playerState.myPlayer.rig.head=t.rig.head,this.playerState.myPlayer.rig.headwear=t.rig.headwear,this.playerState.myPlayer.rig.weapon=t.rig.weapon),this.roomManager.sendMessage(JSON.stringify({type:"player-state",id:this.playerState.myPlayer.id,timestamp:this.playerState.myPlayer.timestamp,color:this.playerState.myPlayer.color,transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},actions:{dash:{cooldown:this.playerState.myPlayer.actions.dash.cooldown,drain:this.playerState.myPlayer.actions.dash.drain,multiplier:this.playerState.myPlayer.actions.dash.multiplier,time:this.playerState.myPlayer.actions.dash.time},melee:{cooldown:this.playerState.myPlayer.actions.melee.cooldown,damage:this.playerState.myPlayer.actions.melee.damage,duration:this.playerState.myPlayer.actions.melee.duration,range:this.playerState.myPlayer.actions.melee.range,size:this.playerState.myPlayer.actions.melee.size},primary:{buffer:this.playerState.myPlayer.actions.primary.buffer,burst:{amount:this.playerState.myPlayer.actions.primary.burst.amount,delay:this.playerState.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.playerState.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.playerState.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.playerState.myPlayer.actions.primary.magazine.maxReserve,size:this.playerState.myPlayer.actions.primary.magazine.size},offset:this.playerState.myPlayer.actions.primary.offset,projectile:{amount:this.playerState.myPlayer.actions.primary.projectile.amount,color:this.playerState.myPlayer.actions.primary.projectile.color,damage:this.playerState.myPlayer.actions.primary.projectile.damage,length:this.playerState.myPlayer.actions.primary.projectile.length,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,spread:this.playerState.myPlayer.actions.primary.projectile.spread},reload:{time:this.playerState.myPlayer.actions.primary.reload.time}},sprint:{drain:this.playerState.myPlayer.actions.sprint.drain,multiplier:this.playerState.myPlayer.actions.sprint.multiplier}},equipment:this.playerState.myPlayer.equipment,flags:{hidden:this.playerState.myPlayer.flags.hidden,invulnerable:this.playerState.myPlayer.flags.invulnerable},inventory:{primary:this.playerState.myPlayer.inventory.primary,melee:this.playerState.myPlayer.inventory.melee},physics:{acceleration:this.playerState.myPlayer.physics.acceleration,friction:this.playerState.myPlayer.physics.friction},rig:{body:this.playerState.myPlayer.rig.body,head:this.playerState.myPlayer.rig.head,headwear:this.playerState.myPlayer.rig.headwear,weapon:this.playerState.myPlayer.rig.weapon},stats:{defense:this.playerState.myPlayer.stats.defense,health:{max:this.playerState.myPlayer.stats.health.max,value:this.playerState.myPlayer.stats.health.value},luck:this.playerState.myPlayer.stats.luck,size:this.playerState.myPlayer.stats.size,speed:this.playerState.myPlayer.stats.speed,stamina:{max:this.playerState.myPlayer.stats.stamina.max,recovery:{delay:this.playerState.myPlayer.stats.stamina.recovery.delay,rate:this.playerState.myPlayer.stats.stamina.recovery.rate},value:this.playerState.myPlayer.stats.stamina.value}},unique:this.playerState.myPlayer.unique})),this.gameLoop();const e={sliderId:"healthBar",targetValue:this.playerState.myPlayer.stats.health.value,maxValue:this.playerState.myPlayer.stats.health.max,lerpTime:300},a={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:300};this.utility.setSlider(e),this.utility.setSlider(a)}gameLoop(){if(!(this.gameState.gameInProgress&&this.ui.ctx&&this.ui.canvas&&this.ui.decalCtx&&this.ui.decalCanvas))return;if(this.gameState.isPaused)return void requestAnimationFrame(()=>this.gameLoop());const t=this.utility.deltaTime();this.playerController.updatePlayerPosition(t),this.combatController.updateAttack(t),this.combatController.updateProjectiles(t),this.particlesManager.updateParticles(t),this.particlesManager.updateEmitters(t),this.particlesManager.updateShrapnel(t),this.animator.updateCharacterAnimations(t),this.staminaController.updateStamina(t),this.dashController.updateDash(t),this.collisionsManager.checkCollisions(t);const e={sliderId:"staminaBar",targetValue:this.playerState.myPlayer.stats.stamina.value,maxValue:this.playerState.myPlayer.stats.stamina.max,lerpTime:300};this.utility.setSlider(e),this.renderingManager.clearCtx(this.ui.ctx),this.ui.ctx.drawImage(this.ui.decalCanvas,0,0),this.renderingManager.drawObjects(),this.combatController.projectiles.forEach(t=>{this.renderingManager.drawProjectile(t)}),this.playerState.players.forEach(t=>{if(!this.ui.ctx)return;const e={player:t,context:this.ui.ctx};this.renderingManager.drawCharacter(e)});const a={player:this.playerState.myPlayer,context:this.ui.ctx};this.renderingManager.drawCharacter(a),this.particlesManager.drawParticles(),this.particlesManager.drawShrapnel(),requestAnimationFrame(()=>this.gameLoop())}pauseGame(){this.gameState.gameInProgress&&(this.gameState.isPaused=!0,console.log("Game paused"),this.controlsManager.clearActiveKeys(),this.playerState.isSprinting=!1,this.playerState.isDashing=!1,this.playerState.isBurstActive=!1,this.playerState.currentBurstShot=0)}resumeGame(){this.gameState.gameInProgress&&(this.gameState.isPaused=!1,console.log("Game resumed"))}resetGameState(t){this.gameState.gameInProgress=!1,this.gameState.isPaused=!1,this.isRoundInProgress=!1,this.gameWinner=null,this.roundWinner=null,this.gameState.gameMaxWins=l.MAX_WINS,this.gameState.gameMaxPlayers=l.MAX_PLAYERS,"Room"===t&&(this.lobbyManager.inLobby=!1,this.playerState.isHost=!1),this.playerState.players.clear(),this.combatController.projectiles.clear(),this.objectsManager.ammoBoxes.clear(),this.decalsManager.dynamicDecals.clear(),this.particlesManager.particles.clear(),this.particlesManager.emitters.clear(),this.particlesManager.shrapnel.clear(),this.upgradeManager.upgradesCompleted.clear(),this.ui.ammoReservesUIController.reserveBulletParticles=[],"Room"===t&&this.lobbyManager.lobbyPlayers.clear(),this.renderingManager.clearCtx(),this.chatManager.clearChat(),this.ui.clearLeaderboard(),this.playerState.resetPlayerState(),this.playerState.initPlayer(this.userId),this.controlsManager.clearActiveKeys(),this.animator.clearAllAnimations(),this.utility.clearTimeoutCache(),this.upgradeManager.resetUpgrades(this.playerState.myPlayer)}watchForInputs(){const t=()=>{this.controlsManager.gamepadConnectionEnabled&&this.controlsManager.pollGamepad(),this.checkActions(),requestAnimationFrame(t)};t()}checkActions(){if(!this.gameState.gameInProgress||this.gameState.isPaused)return;const t=this.settingsManager.getSettings().controls.keybinds;this.controlsManager.triggered(t.dash)&&this.dashController.startDash(),this.controlsManager.triggered(t.melee)&&this.combatController.canMelee()&&this.combatController.triggerAttack("melee"),this.controlsManager.triggered(t.reload)&&this.combatController.startReload(),this.controlsManager.held(t.sprint)?this.moveController.isMoving()&&(this.playerState.isSprinting=!0):this.playerState.isSprinting=!1,this.controlsManager.triggered(t.attack)&&(!this.playerState.canShoot||this.playerState.isBurstActive||this.playerState.isMelee||this.combatController.triggerAttack("ranged")),this.controlsManager.held(t.attack)&&this.playerState.canAutoFire&&this.combatController.triggerAttack("ranged");const e=this.controlsManager.getGamepadRAxis();null!==e&&this.animator.rotateCharacterPart(this.userId,e),this.controlsManager.updatePreviousKeys()}startUpgradePhase(t){console.log("Starting upgrade phase..."),this.upgradeManager.upgradesCompleted.clear(),t===this.userId?this.showWinnerWaitScreen():this.showUpgradeSelection(2)}showWinnerWaitScreen(){if(!this.ui.upgradeContainer)return;this.ui.upgradeContainer.innerHTML="";const t=document.createElement("div");t.className="upgrade_waiting",t.textContent="Waiting for other players...",this.ui.upgradeContainer.appendChild(t),this.ui.upgradeContainer.style.display="flex"}showWinnerContinueButton(){if(!this.ui.upgradeContainer)return;this.ui.upgradeContainer.innerHTML="";const t=document.createElement("div");t.className="upgrade_waiting",t.textContent="Upgrade phase complete.";const e=document.createElement("button");e.textContent="Continue",e.onclick=()=>{this.ui.upgradeContainer&&(console.log("Winner pressed continue..."),this.ui.upgradeContainer.style.display="none",this.utility.safeTimeout(()=>{this.startNewRound()},l.NEW_ROUND_DELAY))},this.ui.upgradeContainer.appendChild(t),this.ui.upgradeContainer.appendChild(e),this.ui.upgradeContainer.style.display="flex"}showUpgradeSelection(t){this.ui.upgradeContainer&&(this.ui.upgradeContainer.innerHTML="",this.upgradeManager.getUpgrades(t,this.playerState.myPlayer).forEach(t=>{const e=document.createElement("div");e.className="upgrade_card container",e.setAttribute("data-rarity",t.rarity.toString());const a=document.createElement("div");a.className="upgrade_image";const s=document.createElement("img");s.src=t.icon,s.alt=t.name,s.className="upgrade_icon",s.onerror=()=>{console.warn(`Failed to load upgrade image: ${t.icon}`),s.style.display="none"},a.appendChild(s);const i=document.createElement("div");i.className="upgrade_name",i.textContent=t.name;const r=document.createElement("div");r.className="upgrade_subtitle",r.textContent=t.subtitle,e.appendChild(a),e.appendChild(i),e.appendChild(r),e.addEventListener("click",()=>{console.log("Selected upgrade: ",t.name),this.selectUpgrade(t.id)}),this.ui.upgradeContainer&&this.ui.upgradeContainer.appendChild(e)}),this.ui.upgradeContainer.style.display="flex")}selectUpgrade(t){this.upgradeManager.applyUpgrade(t,this.playerState.myPlayer)?this.finishUpgrade(t):console.error("Failed to apply upgrade")}finishUpgrade(t){this.ui.upgradeContainer&&(this.ui.upgradeContainer.style.display="none"),this.roomManager.sendMessage(JSON.stringify({type:"upgrade-taken",upgradeId:t,userId:this.userId,isUnique:this.upgradeManager.upgrades.find(e=>e.id===t)?.unique||!1})),this.roomManager.sendMessage(JSON.stringify({type:"player-state",id:this.playerState.myPlayer.id,timestamp:this.playerState.myPlayer.timestamp,color:this.playerState.myPlayer.color,transform:{pos:{x:this.playerState.myPlayer.transform.pos.x,y:this.playerState.myPlayer.transform.pos.y},rot:this.playerState.myPlayer.transform.rot},actions:{dash:{cooldown:this.playerState.myPlayer.actions.dash.cooldown,drain:this.playerState.myPlayer.actions.dash.drain,multiplier:this.playerState.myPlayer.actions.dash.multiplier,time:this.playerState.myPlayer.actions.dash.time},melee:{cooldown:this.playerState.myPlayer.actions.melee.cooldown,damage:this.playerState.myPlayer.actions.melee.damage,duration:this.playerState.myPlayer.actions.melee.duration,range:this.playerState.myPlayer.actions.melee.range,size:this.playerState.myPlayer.actions.melee.size},primary:{buffer:this.playerState.myPlayer.actions.primary.buffer,burst:{amount:this.playerState.myPlayer.actions.primary.burst.amount,delay:this.playerState.myPlayer.actions.primary.burst.delay},magazine:{currentAmmo:this.playerState.myPlayer.actions.primary.magazine.currentAmmo,currentReserve:this.playerState.myPlayer.actions.primary.magazine.currentReserve,maxReserve:this.playerState.myPlayer.actions.primary.magazine.maxReserve,size:this.playerState.myPlayer.actions.primary.magazine.size},offset:this.playerState.myPlayer.actions.primary.offset,projectile:{amount:this.playerState.myPlayer.actions.primary.projectile.amount,color:this.playerState.myPlayer.actions.primary.projectile.color,damage:this.playerState.myPlayer.actions.primary.projectile.damage,length:this.playerState.myPlayer.actions.primary.projectile.length,range:this.playerState.myPlayer.actions.primary.projectile.range,size:this.playerState.myPlayer.actions.primary.projectile.size,speed:this.playerState.myPlayer.actions.primary.projectile.speed,spread:this.playerState.myPlayer.actions.primary.projectile.spread},reload:{time:this.playerState.myPlayer.actions.primary.reload.time}},sprint:{drain:this.playerState.myPlayer.actions.sprint.drain,multiplier:this.playerState.myPlayer.actions.sprint.multiplier}},equipment:this.playerState.myPlayer.equipment,flags:{hidden:this.playerState.myPlayer.flags.hidden,invulnerable:this.playerState.myPlayer.flags.invulnerable},inventory:{primary:this.playerState.myPlayer.inventory.primary,melee:this.playerState.myPlayer.inventory.melee},physics:{acceleration:this.playerState.myPlayer.physics.acceleration,friction:this.playerState.myPlayer.physics.friction},rig:{body:this.playerState.myPlayer.rig.body,head:this.playerState.myPlayer.rig.head,headwear:this.playerState.myPlayer.rig.headwear,weapon:this.playerState.myPlayer.rig.weapon},stats:{defense:this.playerState.myPlayer.stats.defense,health:{max:this.playerState.myPlayer.stats.health.max,value:this.playerState.myPlayer.stats.health.max},luck:this.playerState.myPlayer.stats.luck,size:this.playerState.myPlayer.stats.size,speed:this.playerState.myPlayer.stats.speed,stamina:{max:this.playerState.myPlayer.stats.stamina.max,recovery:{delay:this.playerState.myPlayer.stats.stamina.recovery.delay,rate:this.playerState.myPlayer.stats.stamina.recovery.rate},value:this.playerState.myPlayer.stats.stamina.max}},unique:this.playerState.myPlayer.unique})),console.log("Upgrade selected, waiting for others...")}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new G}):new G})()})();
//# sourceMappingURL=app.js.map