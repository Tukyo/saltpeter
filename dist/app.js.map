{"version":3,"file":"app.js","mappings":"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C,SAAU,CACN,yEACA,yEACA,yEACA,yEACA,yEACA,yEACA,0EAEJC,KAAM,CACF,qEACA,qEACA,qEACA,qEACA,qEACA,qEACA,sEAEJC,SAAU,CACN,yEACA,yEACA,yEACA,yEACA,yEACA,yEACA,0EAEJC,KAAM,CACF,qEACA,qEACA,qEACA,qEACA,qEACA,qEACA,qEACA,sEAEJC,MAAO,CACH,sEACA,sEACA,sEACA,sEACA,sEACA,sEACA,uEAEJC,MAAO,CACHC,MAAO,CACH,4EACA,4EACA,4EACA,4EACA,4EACA,6EAEJC,OAAQ,CACJ,6EACA,6EACA,6EACA,6EACA,6EACA,iFAKhBvW,MAAO,CACHwW,SAAU,CACNC,MAAO,CACH,+DACA,+DACA,+DACA,+DACA,+DACA,+DACA,+DACA,+DACA,+DACA,iEAGRC,SAAU,CACND,MAAO,CACH,+DACA,+DACA,+DACA,+DACA,+DACA,+DACA,mEAKhB/3B,OAAQ,CACJC,MAAO,CACHiE,OAAQ,CACJ,6DACA,6DACA,6DACA,6DACA,6DACA,8DAEJ/D,MAAO,CACH,4DAEJ5G,OAAQ,CACJ0+B,IAAK,CACD,iEACA,iEACA,iEACA,kEAGJC,MAAO,CACH,mEACA,mEACA,mEACA,qEAGRC,MAAO,CACHC,KAAM,CACF,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,iEAEJC,KAAM,CACF,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,gEACA,iEAEJV,MAAO,CACH,iEACA,iEACA,iEACA,iEACA,iEACA,sEAMpBxW,SAAU,CACNmX,KAAM,CACFC,IAAK,CAAC,8CACNC,OAAQ,CAAC,iDACTC,UAAW,CAAC,oDACZC,MAAO,CAAC,gDACRC,OAAQ,CAAC,iDACTC,MAAO,CAAC,kDAKJ,EC5Pb,MAAMC,EAQT,WAAAliC,CACY8C,EACAmI,EACAjD,GAFA,KAAAlF,YAAAA,EACA,KAAAmI,gBAAAA,EACA,KAAAjD,QAAAA,EARJ,KAAAm6B,QAAoC,IAAIl/B,IACxC,KAA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","sources":["webpack://saltpeter/./src/client/upgrades/unique/ sync ^\\.\\/.*\\/.*$","webpack://saltpeter/./src/client/upgrades/unique/spatialtargeting/spatialtargeting.ts","webpack://saltpeter/./src/client/upgrades/unique/phoenixmodule/phoenixmodule.ts","webpack://saltpeter/./src/client/upgrades/resource/ sync ^\\.\\/.*\\/.*$","webpack://saltpeter/./src/client/Types.ts","webpack://saltpeter/./src/client/upgrades/stats/hemoglobinsaturator/hemoglobinsaturator.ts","webpack://saltpeter/./src/client/upgrades/stats/locomotionmodule/locomotionmodule.ts","webpack://saltpeter/./src/client/upgrades/unique/clustermodule/clustermodule.ts","webpack://saltpeter/./src/client/upgrades/unique/muzzlesplitter/muzzlesplitter.ts","webpack://saltpeter/./src/client/upgrades/unique/spectralimage/spectralimage.ts","webpack://saltpeter/./src/client/upgrades/stats/bioregulator/bioregulator.ts","webpack://saltpeter/./src/client/upgrades/stats/damagebuffer/damagebuffer.ts","webpack://saltpeter/./src/client/upgrades/equipment/switch/switch.ts","webpack://saltpeter/./src/client/upgrades/unique/kineticbrain/kineticbrain.ts","webpack://saltpeter/./src/client/upgrades/resource/carepackage/carepackage.ts","webpack://saltpeter/./src/client/upgrades/unique/projectilearray/projectilearray.ts","webpack://saltpeter/./src/client/upgrades/stats/ sync ^\\.\\/.*\\/.*$","webpack://saltpeter/./src/client/upgrades/equipment/ sync ^\\.\\/.*\\/.*$","webpack://saltpeter/webpack/bootstrap","webpack://saltpeter/webpack/runtime/define property getters","webpack://saltpeter/webpack/runtime/hasOwnProperty shorthand","webpack://saltpeter/webpack/runtime/make namespace object","webpack://saltpeter/./src/client/Config.ts","webpack://saltpeter/./src/client/Admin.ts","webpack://saltpeter/./src/client/Animator.ts","webpack://saltpeter/./src/client/CacheManager.ts","webpack://saltpeter/./src/client/Camera.ts","webpack://saltpeter/./src/client/CharacterConfig.ts","webpack://saltpeter/./src/client/CharacterManager.ts","webpack://saltpeter/./src/client/ControlsManager.ts","webpack://saltpeter/./src/client/CollisionsManager.ts","webpack://saltpeter/./src/client/DecalsConfig.ts","webpack://saltpeter/./src/client/DecalsManager.ts","webpack://saltpeter/./src/client/EventsManager.ts","webpack://saltpeter/./src/client/GameState.ts","webpack://saltpeter/./src/client/LobbyManager.ts","webpack://saltpeter/./src/client/ObjectsManager.ts","webpack://saltpeter/./src/client/RenderingManager.ts","webpack://saltpeter/./src/client/RoomController.ts","webpack://saltpeter/./src/client/RoomManager.ts","webpack://saltpeter/./src/client/SettingsManager.ts","webpack://saltpeter/./src/client/upgrades/equipment/index.ts","webpack://saltpeter/./src/client/upgrades/index.ts","webpack://saltpeter/./src/client/upgrades/resource/index.ts","webpack://saltpeter/./src/client/upgrades/stats/index.ts","webpack://saltpeter/./src/client/upgrades/unique/index.ts","webpack://saltpeter/./src/client/UpgradeManager.ts","webpack://saltpeter/./src/client/player/AmmoReservesUIController.ts","webpack://saltpeter/./src/client/UserInterface.ts","webpack://saltpeter/./src/client/Utility.ts","webpack://saltpeter/./src/client/WebsocketManager.ts","webpack://saltpeter/./src/client/audio/AudioConfig.ts","webpack://saltpeter/./src/client/audio/AudioManager.ts","webpack://saltpeter/./src/client/chat/ChatConfig.ts","webpack://saltpeter/./src/client/chat/ChatManager.ts","webpack://saltpeter/./src/client/particles/ParticlesConfig.ts","webpack://saltpeter/./src/client/particles/ParticlesManager.ts","webpack://saltpeter/./src/client/player/CombatController.ts","webpack://saltpeter/./src/client/player/DashController.ts","webpack://saltpeter/./src/client/player/LuckController.ts","webpack://saltpeter/./src/client/player/MoveController.ts","webpack://saltpeter/./src/client/player/PlayerConfig.ts","webpack://saltpeter/./src/client/player/PlayerController.ts","webpack://saltpeter/./src/client/player/PlayerState.ts","webpack://saltpeter/./src/client/player/StaminaController.ts","webpack://saltpeter/./src/client/world/WorldChunk.ts","webpack://saltpeter/./src/client/world/WorldConfig.ts","webpack://saltpeter/./src/client/world/WorldDebug.ts","webpack://saltpeter/./src/client/world/WorldEdit.ts","webpack://saltpeter/./src/client/world/World.ts","webpack://saltpeter/./src/client/particles/ParticlesController.ts","webpack://saltpeter/./src/client/client.ts"],"sourcesContent":["var map = {\n\t\"./clustermodule/clustermodule\": 224,\n\t\"./clustermodule/clustermodule.ts\": 224,\n\t\"./kineticbrain/kineticbrain\": 748,\n\t\"./kineticbrain/kineticbrain.ts\": 748,\n\t\"./muzzlesplitter/muzzlesplitter\": 358,\n\t\"./muzzlesplitter/muzzlesplitter.ts\": 358,\n\t\"./phoenixmodule/phoenixmodule\": 96,\n\t\"./phoenixmodule/phoenixmodule.ts\": 96,\n\t\"./projectilearray/projectilearray\": 800,\n\t\"./projectilearray/projectilearray.ts\": 800,\n\t\"./spatialtargeting/spatialtargeting\": 88,\n\t\"./spatialtargeting/spatialtargeting.ts\": 88,\n\t\"./spectralimage/spectralimage\": 368,\n\t\"./spectralimage/spectralimage.ts\": 368\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 65;","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Allows player's rotation to slightly influence projectile direction.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"spatial_targeting\",\r\n        name: \"Spatial Targeting\",\r\n        subtitle: \"Projectile upgrade that syncs its spatial awareness with the user.\",\r\n        icon: \"/assets/img/icon/upgrades/unique/spatialtargeting.png\",\r\n        type: UpgradeType.UNIQUE,\r\n        rarity: UpgradeRarity.SUPERIOR,\r\n        unique: true,\r\n        func: (player: Player) => {\r\n            if (!player.unique.includes('spatial_targeting')) {\r\n                player.unique.push('spatial_targeting');\r\n            }\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Luck based * 1.5, on death chance to trigger.\r\n// One-time use, double damage received permanently on trigger.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"phoenix_module\",\r\n        name: \"Phoenix Module\",\r\n        subtitle: \"Return from the flames with vengeance.\",\r\n        icon: \"/assets/img/icon/upgrades/unique/phoenixmodule.png\",\r\n        type: UpgradeType.UNIQUE,\r\n        rarity: UpgradeRarity.LEGENDARY,\r\n        unique: true,\r\n        func: (player: Player) => {\r\n            if (!player.unique.includes('phoenix_module')) {\r\n                player.unique.push('phoenix_module');\r\n            }\r\n        }\r\n    };\r\n}","var map = {\n\t\"./carepackage/carepackage\": 751,\n\t\"./carepackage/carepackage.ts\": 751\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 136;","import { LobbyManager } from \"./LobbyManager\";\r\nimport { UserInterface } from \"./UserInterface\";\r\nimport { Utility } from \"./Utility\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\n\r\n// #region [ Core ]\r\n//\r\n/**\r\n * Represents a 2D vector with x and y coordinates.\r\n */\r\nexport type Vec2 = { x: number, y: number }\r\n\r\n/**\r\n * Represents an object's position and rotation in 2D space.\r\n */\r\nexport type Transform = {\r\n  pos: Vec2;\r\n  rot: number;\r\n}\r\n\r\n/**\r\n * Represents a directional relationship between two points in 2D space.\r\n */\r\nexport type Direction = { rootPos: Vec2; targetPos: Vec2; };\r\n\r\nexport enum NoiseType {\r\n  Perlin = \"perlin\",\r\n  Worley = \"worley\",\r\n  Voronoi = \"voronoi\",\r\n  Ridged = \"ridged\"\r\n}\r\n//\r\n// #endregion\r\n\r\n// #region [ Game Object ]\r\n/**\r\n * Base interface for all game world entities.\r\n * Includes a unique ID, transform data, and a timestamp for synchronization.\r\n */\r\nexport interface GameObject {\r\n  id: string;\r\n  transform: Transform;\r\n  timestamp: number;\r\n}\r\n\r\n/**\r\n * All gameobject types.\r\n */\r\nexport type GameObjects = 'AmmoBox' | 'Player' | 'Projectile';\r\n\r\n/**\r\n * Mapping definition for stored player objects.\r\n */\r\nexport type Players = Map<string, Player>;\r\n\r\n/**\r\n * Full representation of the player object. Extends GameObject.\r\n */\r\nexport interface Player extends GameObject {\r\n  actions: {\r\n    dash: {\r\n      drain: number;\r\n      cooldown: number;\r\n      multiplier: number;\r\n      time: number;\r\n    }\r\n    melee: {\r\n      cooldown: number;\r\n      damage: number;\r\n      duration: number;\r\n      range: number;\r\n      size: number;\r\n    }\r\n    primary: {\r\n      buffer: number;\r\n      burst: {\r\n        amount: number;\r\n        delay: number;\r\n      }\r\n      magazine: {\r\n        currentAmmo: number;\r\n        currentReserve: number;\r\n        maxReserve: number;\r\n        size: number;\r\n      }\r\n      offset: number;\r\n      projectile: {\r\n        amount: number;\r\n        color: string;\r\n        damage: number;\r\n        length: number;\r\n        range: number;\r\n        size: number;\r\n        speed: number;\r\n        spread: number;\r\n      }\r\n      reload: { time: number; }\r\n    }\r\n    sprint: {\r\n      drain: number;\r\n      multiplier: number;\r\n    }\r\n  }\r\n  color: string;\r\n  equipment: string[],\r\n  flags: {\r\n    hidden: boolean;\r\n    invulnerable: boolean;\r\n  }\r\n  inventory: {\r\n    primary: string;\r\n    melee: string;\r\n  }\r\n  physics: {\r\n    acceleration: number;\r\n    friction: number;\r\n  }\r\n  rig: {\r\n    body: string;\r\n    head: string;\r\n    headwear: string;\r\n    weapon: string;\r\n  }\r\n  stats: {\r\n    defense: number;\r\n    health: {\r\n      max: number;\r\n      value: number;\r\n    }\r\n    luck: number;\r\n    size: number;\r\n    speed: number;\r\n    stamina: {\r\n      max: number;\r\n      recovery: {\r\n        delay: number;\r\n        rate: number;\r\n      }\r\n      value: number;\r\n    }\r\n  }\r\n  unique: string[];\r\n}\r\n\r\nexport interface DamageEntity extends GameObject {\r\n  color: string;\r\n  damage: number;\r\n  distanceTraveled: number;\r\n  length: number;\r\n  ownerId: string;\r\n  range: number;\r\n  size: number;\r\n  type: AttackType;\r\n  velocity: Vec2;\r\n}\r\n\r\nexport type ProjectileOverrides = {\r\n  bypassDefault?: boolean;\r\n  canTriggerUnique?: boolean;\r\n  color?: string;\r\n  damage?: number;\r\n  length?: number;\r\n  range?: number;\r\n  size?: number;\r\n  speed?: number;\r\n  spread?: number;\r\n  amount?: number;\r\n};\r\n\r\nexport interface AmmoBox extends GameObject {\r\n  ammoAmount: number;\r\n  isOpen: boolean;\r\n  lid: {\r\n    pos: Vec2;\r\n    rot: number;\r\n    velocity: Vec2;\r\n    torque: number;\r\n  };\r\n}\r\n\r\nexport interface SpawnObjectParams {\r\n  transform: Transform;\r\n  type: GameObjects;\r\n  data?: any;\r\n}\r\n//\r\n// #endregion\r\n\r\n// #region [ Animation ]\r\n//\r\nexport interface PlayerPartAnimParams {\r\n  playerId: string;\r\n  part: string;\r\n  frames: { [key: number]: { x: number, y: number } };\r\n  duration: number;\r\n  partIndex?: number;\r\n}\r\n\r\nexport type TextAnimParams = {\r\n  element: HTMLElement;\r\n  oldValue: number;\r\n  newValue: number;\r\n  decimals: number;\r\n  animTime: number;\r\n  steps: number;\r\n  color: string;\r\n  timeout: number;\r\n}\r\n//\r\n// #endregion\r\n\r\n// #region [ Audio ]\r\n//\r\nexport type AudioFileType =\r\n  | \".ogg\";\r\n\r\nexport type AudioMixerName =\r\n  | \"master\"\r\n  | \"ambience\"\r\n  | \"music\"\r\n  | \"sfx\"\r\n  | \"voice\";\r\n\r\nexport interface AudioMixer {\r\n  out: AudioMixerName | null;\r\n  volume: number;\r\n}\r\n\r\nexport interface ActiveAudio {\r\n  setVolume: (volume: number) => void;\r\n  stop: () => void;\r\n}\r\n\r\nexport interface AudioParams {\r\n  delay?: {\r\n    min: number;\r\n    max: number;\r\n  }\r\n  listener?: Vec2;\r\n  loop?: boolean;\r\n  output?: AudioMixerName;\r\n  priority?: number;\r\n  pitch?: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  spatial?: {\r\n    blend?: number;\r\n    pos?: Vec2;\r\n    rolloff?: {\r\n      distance: number;\r\n      factor: number;\r\n      type?: 'linear' | 'logarithmic';\r\n    }\r\n  }\r\n  src: string;\r\n  startTime?: {\r\n    min: number;\r\n    max: number;\r\n  }\r\n  volume?: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n}\r\n\r\nexport type AudioZone = {\r\n  region: WorldRegion;\r\n  center: Vec2;\r\n  audioParams: AudioParams;\r\n  audioElement?: ActiveAudio;\r\n  isActive: boolean;\r\n}\r\n\r\nexport interface WeaponSFX {\r\n  [weaponName: string]: {\r\n    attack: string[];\r\n    empty?: string[];\r\n    reload?: {\r\n      start: string[];\r\n      end: string[];\r\n    };\r\n    shell?: {\r\n      hard: string[];\r\n      soft: string[];\r\n      water: string[];\r\n    }\r\n  };\r\n}\r\n\r\nexport interface ImpactSFX {\r\n  [surface: string]: {\r\n    ranged: string[];\r\n    melee: string[];\r\n  }\r\n}\r\n//\r\n// #endregion\r\n\r\n// #region [ Lobby & Room ]\r\n//\r\nexport type ResetType = 'Room' | 'Lobby'\r\n\r\nexport interface RoomMessage {\r\n  type: 'join-room' | 'create-room' | 'leave-room' | 'room-message' | 'room-created' | 'room-joined' | 'room-joined-game' | 'room-error' | 'user-joined' | 'user-left';\r\n  roomId?: string;\r\n  userId: string;\r\n  message?: string;\r\n  data?: any;\r\n  gameActive?: boolean;\r\n}\r\n\r\nexport interface LobbyPlayer {\r\n  id: string;\r\n  color: string;\r\n  isHost: boolean;\r\n  rig: {\r\n    body: string;\r\n    head: string;\r\n    headwear: string;\r\n    weapon: string;\r\n  }\r\n  transform: Transform;\r\n}\r\n\r\nexport type LobbyControlsParams = {\r\n  lobby: LobbyManager;\r\n  lobbyOptions: LobbyOptionsParams;\r\n  myPlayer: Player;\r\n  roomId: string;\r\n  userId: string;\r\n}\r\n\r\nexport type LobbyOptionsParams = {\r\n  maxPlayers: number;\r\n  maxWins: number;\r\n  isHost: boolean;\r\n  privateRoom: boolean;\r\n  upgradesEnabled: boolean;\r\n}\r\n\r\nexport type ChatMessage = {\r\n  senderId: string;\r\n  message: string;\r\n  isOwn?: boolean;\r\n};\r\n//\r\n// #endregion\r\n\r\n// #region [ Settings ]\r\n//\r\nexport interface GameSettings {\r\n  audio: {\r\n    mixer: {\r\n      master: AudioMixer;\r\n      ambience: AudioMixer;\r\n      music: AudioMixer;\r\n      sfx: AudioMixer;\r\n      voice: AudioMixer;\r\n    }\r\n  }\r\n  controls: {\r\n    keybinds: {\r\n      attack: string;\r\n      dash: string;\r\n      melee: string;\r\n      moveDown: string;\r\n      moveLeft: string;\r\n      moveRight: string;\r\n      moveUp: string;\r\n      reload: string;\r\n      sprint: string;\r\n    },\r\n    gamepad: {\r\n      attack: number;\r\n      dash: number;\r\n      deadzone: number;\r\n      melee: number;\r\n      reload: number;\r\n      sprint: number;\r\n    }\r\n  }\r\n  character: {\r\n    rig: {\r\n      body: string;\r\n      head: string;\r\n      headwear: string;\r\n      weapon: string;\r\n    }\r\n  }\r\n  graphics: {\r\n    physics: {\r\n      ammoReserves: boolean;\r\n    }\r\n    renderBackgroundParticles: boolean;\r\n    showStaticOverlay: boolean;\r\n  }\r\n}\r\n//\r\n// #endregion\r\n\r\n// #region [ Params ]\r\n//\r\nexport type RandomColorParams = {\r\n  format: 'hex' | 'rgb';\r\n  mode: 'any' | 'primary' | 'pastel' | 'vibrant' | 'dark' | 'light' | 'grayscale';\r\n\r\n}\r\n\r\nexport type SetInputParams = {\r\n  inputId: string;\r\n  value: number;\r\n}\r\n\r\nexport type SetSliderParams = {\r\n  sliderId: string;\r\n  targetValue: number;\r\n  maxValue: number;\r\n  lerpTime?: number;\r\n}\r\n\r\nexport type SetSpanParams = {\r\n  spanId: string;\r\n  value: string | number;\r\n}\r\n\r\nexport type SetToggleParams = {\r\n  toggleId: string;\r\n  value: boolean;\r\n}\r\n\r\nexport type PlayerHitParams = {\r\n  target: Player;\r\n  shooterId: string;\r\n  damage: number;\r\n  newHealth: number;\r\n  source: DamageEntity | ShrapnelPiece;\r\n  wasKill: boolean;\r\n}\r\n\r\nexport type FootstepParams = {\r\n  pos: Vec2;\r\n  material: string;\r\n  waterRatio: number;\r\n  isWet: boolean;\r\n  speedRatio: number;\r\n}\r\n//\r\n// #endregion\r\n\r\n// #region [ Leaderboard ]\r\n//\r\nexport interface LeaderboardEntry {\r\n  playerId: string;\r\n  kills: number;\r\n  deaths: number;\r\n  wins: number;\r\n}\r\n\r\nexport type Leaderboard = Map<string, LeaderboardEntry>;\r\n//\r\n// #endregion\r\n\r\n// #region [ Combat ]\r\n//\r\nexport type AttackType = 'melee' | 'ranged';\r\n//\r\n// #endregion\r\n\r\n// #region [ Visual ]\r\n//\r\nexport type CreateParticleParams = {\r\n  id: string;\r\n  pos: Vec2;\r\n  particleParams: ParticleParams;\r\n  direction?: Vec2;\r\n}\r\n\r\nexport type ParticleParams = {\r\n  count: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  lifetime: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  noise: {\r\n    strength: {\r\n      min: number;\r\n      max: number;\r\n    };\r\n    scale: {\r\n      min: number;\r\n      max: number;\r\n    };\r\n  };\r\n  opacity: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  speed: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  sizeOverLifetime: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  size: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  torque: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  collide: boolean;\r\n  fade: boolean;\r\n  paint: boolean;\r\n  spread: number;\r\n  stain: boolean;\r\n  colors: string[];\r\n};\r\n\r\nexport type Particle = {\r\n  age: number;\r\n  collide: boolean;\r\n  color: string;\r\n  fade: boolean;\r\n  hasCollided: boolean;\r\n  id: string;\r\n  initialSize: number;\r\n  lifetime: number;\r\n  maxOpacity: number;\r\n  noiseStrength: number;\r\n  noiseScale: number;\r\n  opacity: number;\r\n  paint: boolean;\r\n  pos: Vec2;\r\n  rotation: number;\r\n  size: number;\r\n  sizeOverLifetime: number;\r\n  stain: boolean;\r\n  torque: number;\r\n  velocity: Vec2\r\n}\r\n\r\nexport type EmitterParams = {\r\n  type?: string;\r\n  id: string;\r\n  interval: number;\r\n  lifetime: number;\r\n  offset: Vec2;\r\n  playerId: string;\r\n  pos: Vec2;\r\n  particleType: ParticleParams;\r\n}\r\n\r\nexport type Emitter = {\r\n  age: number;\r\n  direction: number;\r\n  emissionInterval: number;\r\n  lastEmission: number;\r\n  lifetime: number;\r\n  offset: Vec2;\r\n  playerId: string;\r\n  particleType: ParticleParams;\r\n}\r\n\r\nexport interface GoreParticles {\r\n  drip: ParticleParams;\r\n  spray: ParticleParams;\r\n}\r\n\r\nexport interface WeaponParticles {\r\n  muzzle: {\r\n    smoke: ParticleParams;\r\n    flash: ParticleParams;\r\n  };\r\n  projectile: {\r\n    shell: ParticleParams;\r\n  };\r\n}\r\n\r\nexport interface MaterialParticles {\r\n  ranged?: ParticleParams;\r\n  melee?: ParticleParams;\r\n}\r\n\r\nexport type Decal = {\r\n  params: DecalParams | null;\r\n  pos: Vec2;\r\n};\r\n\r\nexport type DecalParams = {\r\n  id: string;\r\n  pos: Vec2;\r\n  type: 'parametric' | 'image';\r\n  parametric?: ParametricDecalParams;\r\n  image?: ImageDecalParams;\r\n};\r\n\r\nexport type ParametricDecalParams = {\r\n  radius: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  density: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  opacity: {\r\n    min: number;\r\n    max: number;\r\n  };\r\n  variation: number;\r\n  colors: string[];\r\n};\r\n\r\nexport type ImageDecalParams = {\r\n  src: string;\r\n  scale: number;\r\n  rotation: number;\r\n};\r\n\r\nexport interface MaterialDecals {\r\n  ranged?: ParametricDecalParams;\r\n  melee?: ParametricDecalParams;\r\n}\r\n\r\nexport type Shrapnel = {\r\n  amount: number;\r\n  damage: number;\r\n  images: string[];\r\n  lifetime: { min: number, max: number };\r\n  pos: Vec2;\r\n  size: { min: number, max: number };\r\n  speed: { min: number, max: number };\r\n  torque: { min: number, max: number };\r\n}\r\n\r\nexport type ShrapnelPiece = {\r\n  id: string;\r\n  image: string;\r\n  transform: Transform;\r\n  velocity: Vec2;\r\n  rotationSpeed: number;\r\n  size: number;\r\n  age: number;\r\n  lifetime: number;\r\n  ownerId: string;\r\n  damage: number;\r\n}\r\n\r\nexport type DeathDecal = { // TODO: Somehow pass the pool based on current charConfig\r\n  gore: {\r\n    amount: number;\r\n    // pool: string;\r\n  }\r\n  blood: {\r\n    amount: number;\r\n    // pool: string;\r\n  }\r\n  ownerId: string;\r\n  pos: Vec2;\r\n  radius: number;\r\n}\r\n\r\nexport type DeathStamp = {\r\n  transform: Transform;\r\n  type: string;\r\n  scale: number;\r\n  src: string;\r\n}\r\n\r\nexport type WeaponMagazine = {\r\n  empty: string;\r\n  full: string;\r\n};\r\n\r\nexport type ReserveBulletParticle = {\r\n  transform: Transform;\r\n  velocity: Vec2;\r\n  torque: number;\r\n  width: number;\r\n  height: number;\r\n}\r\n\r\nexport type RenderCharacterParams = {\r\n  player: Player | LobbyPlayer;\r\n  context: CanvasRenderingContext2D;\r\n}\r\n\r\nexport type CharacterAnimation = Map<string, {\r\n  playerId: string;\r\n  part: string;\r\n  partIndex?: number;\r\n  frames: { [key: number]: { x: number, y: number } };\r\n  duration: number;\r\n  startTime: number;\r\n  originalOffset: { x: number, y: number };\r\n}>\r\n\r\nexport type CharacterLayer = 'body' | 'weapon' | 'head' | 'headwear' | 'upgrades';\r\n//\r\n// #endregion\r\n\r\n// #region [ Upgrades ]\r\n//\r\nexport enum UpgradeRarity {\r\n  COMMON = 0,\r\n  UNCOMMON = 1,\r\n  SPECIAL = 2,\r\n  SUPERIOR = 3,\r\n  RARE = 4,\r\n  EXCEPTIONAL = 5,\r\n  LEGENDARY = 6,\r\n  MYTHICAL = 7,\r\n  ENLIGHTENED = 8,\r\n  HOLY = 9\r\n}\r\n\r\nexport enum UpgradeType {\r\n  EQUIPMENT = 'equipment',\r\n  RESOURCE = 'resource',\r\n  STAT = 'stat',\r\n  UNIQUE = 'unique',\r\n}\r\n\r\nexport interface Upgrade {\r\n  id: string;\r\n  icon: string;\r\n  name: string;\r\n  rarity: UpgradeRarity;\r\n  subtitle: string;\r\n  type: UpgradeType;\r\n  unique: boolean;\r\n  func: (player: Player) => void;\r\n}\r\n\r\nexport type UpgradeParams = {\r\n  playerState: PlayerState;\r\n  ui: UserInterface;\r\n  utility: Utility;\r\n}\r\n//\r\n// #endregion\r\n\r\n// #region [ World ]\r\n//\r\nexport type WorldData = {\r\n  params: WorldParams;\r\n  seed: number;\r\n}\r\n\r\nexport type WorldParams = {\r\n  general: {\r\n    chunk: { size: number };\r\n    cell: { size: number };\r\n    options: { island: boolean; valley: boolean; }\r\n    seed: number;\r\n  }\r\n  terrain: {\r\n    noiseType: NoiseType;\r\n    intensity: number;\r\n    octaves: number;\r\n    scale: number;\r\n    persistence: number;\r\n    heightCurve: number;\r\n    seaLevel: number;\r\n    lowestDepth: number;\r\n  }\r\n  material: {\r\n    noiseType: NoiseType;\r\n    scale: number;\r\n    detail: {\r\n      noiseType: NoiseType;\r\n      scale: number;\r\n    }\r\n    colorVariation: number;\r\n  }\r\n  degen: {\r\n    noiseType: NoiseType;\r\n    scale: number;\r\n    intensity: number;\r\n    minHeight: number;\r\n    threshold: number;\r\n    hardness: number;\r\n    detail: {\r\n      noiseType: NoiseType;\r\n      scale: number;\r\n    }\r\n  }\r\n  hydration: {\r\n    noiseType: NoiseType;\r\n    intensity: number;\r\n    scale: number;\r\n    multiplier: number;\r\n  }\r\n  render: {\r\n    water: {\r\n      opacityBase: number;\r\n      opacityMultiplier: number;\r\n      foamIntensity: number;\r\n      foamScale: number;\r\n      noiseScale: number;\r\n      shoreBlend: number;\r\n      shimmerStrength: number;\r\n      depthDarkness: number;\r\n    }\r\n    grid: {\r\n      active: boolean;\r\n      lineWidth: number;\r\n      chunkBorderColor: string;\r\n      worldBorderColor: string;\r\n      layerBorderColor: string;\r\n      borderWidth: number;\r\n    }\r\n  }\r\n}\r\n\r\nexport type RegionName =\r\n  | \"shore\"\r\n  | \"cliffs\"\r\n  | \"mountains\"\r\n  | \"ocean\"\r\n  | \"plains\"\r\n\r\nexport interface WorldRegion {\r\n  id: number;\r\n  name: RegionName;\r\n  layerName: string;\r\n  bounds: { minX: number; minY: number; maxX: number; maxY: number };\r\n  chunkCoords: { cx: number; cy: number }[];\r\n  area: number;\r\n}\r\n\r\nexport type WorldLayerName =\r\n  | \"foundation\"\r\n  | \"substrate\"\r\n  | \"sediment\"\r\n  | \"alluvium\"\r\n  | \"soil\"\r\n  | \"topsoil\"\r\n  | \"colluvium\"\r\n  | \"summit\"\r\n\r\nexport interface WorldLayer extends MaterialLayer {\r\n  height: number;\r\n  name: WorldLayerName;\r\n}\r\n\r\nexport interface NetworkChunk {\r\n  pos: Vec2;\r\n  version: number;\r\n  size: number;\r\n  cellData: CellData;\r\n  layer: WorldLayerName;\r\n}\r\n\r\nexport type CellData = {\r\n  worldPixelData: Uint8Array;\r\n  worldHeightData: Uint8Array;\r\n  worldWaterData?: Uint8Array;\r\n  cellLayerGrid?: number[][];\r\n}\r\n\r\nexport type PixelData = {\r\n  layer: WorldLayer\r\n  material: Material;\r\n  materialColorIndex: number;\r\n}\r\n\r\nexport type PixelWaterData = {\r\n  hasWater: boolean;\r\n  waterLevel: number;\r\n  depth: number;\r\n  material: Material;\r\n}\r\n//\r\n// #endregion\r\n\r\n// #region [ Materials ]\r\n//\r\nexport type Material = {\r\n  name: MaterialName;\r\n  type: 'terrain' | 'mineral' | 'surface' | 'liquid' | 'organic';\r\n  colors: string[];\r\n  physics: Liquid | Solid | Gas;\r\n  tags?: MaterialTag[];\r\n  mutations?: Partial<Record<MutationTypes, MaterialName>>;\r\n}\r\n\r\nexport interface MaterialLayer {\r\n  materials: {\r\n    material: MaterialName;\r\n    weight: number;\r\n    blend: number;\r\n  }[];\r\n}\r\n\r\nexport enum PhysicsMaterialTypes { Liquid, Solid, Gas }\r\n\r\nexport type MaterialName =\r\n  | \"basalt\"\r\n  | \"bedrock\"\r\n  | \"clay\"\r\n  | \"clay_wet\"\r\n  | \"dirt\"\r\n  | \"granite\"\r\n  | \"grass\"\r\n  | \"gravel\"\r\n  | \"ice\"\r\n  | \"permafrost\"\r\n  | \"loam\"\r\n  | \"limestone\"\r\n  | \"moss\"\r\n  | \"mud\"\r\n  | \"peat\"\r\n  | \"sand\"\r\n  | \"sand_wet\"\r\n  | \"sandstone\"\r\n  | \"scree\"\r\n  | \"shale\"\r\n  | \"silt\"\r\n  | \"silt_wet\"\r\n  | \"slate\"\r\n  | \"snow\"\r\n  | \"stone\"\r\n  | \"coal\"\r\n  | \"iron\"\r\n  | \"gold\"\r\n  | \"silver\"\r\n  | \"copper\"\r\n  | \"flesh\"\r\n  | \"wood\"\r\n  | \"concrete\"\r\n  | \"metal\"\r\n  | \"asphalt\"\r\n  | \"water\"\r\n\r\nexport enum FrictionTypes {\r\n  Sticky = 0.7,\r\n  Wet = 0.755,\r\n  Soft = 0.8,\r\n  Normal = 0.825,\r\n  Hard = 0.85,\r\n  Slick = 0.9\r\n}\r\n\r\nexport enum LiquidFrictionTypes {\r\n  Water = 0.915\r\n}\r\n\r\ninterface PhysicsMaterial {\r\n  type: PhysicsMaterialTypes;\r\n  simulate: boolean;\r\n}\r\n\r\ninterface Solid extends PhysicsMaterial {\r\n  type: PhysicsMaterialTypes.Solid;\r\n  durability: number;\r\n  friction: FrictionTypes;\r\n  density: number;\r\n}\r\n\r\ninterface Liquid extends PhysicsMaterial {\r\n  type: PhysicsMaterialTypes.Liquid;\r\n  friction: LiquidFrictionTypes;\r\n  viscosity: number; // how fast it flows / spreads\r\n}\r\n\r\ninterface Gas extends PhysicsMaterial {\r\n  type: PhysicsMaterialTypes.Gas;\r\n}\r\n\r\nexport type MaterialTag =\r\n  | \"absorbent\" // Can absorb liquids\r\n  | \"erosion_source\" // This material is in the world erosion template\r\n  | \"imprint_on_footstep\" // Footsteps can be imprinted into the material\r\n  | \"soft\" // If this is present, the material is not hard\r\n  | \"track_on_footstep\" // Material stains after being stepped on\r\n\r\nexport type MutationTypes =\r\n  | \"wet\"\r\n  | \"dry\"\r\n  // | \"frozen\"\r\n  // | \"burnt\"\r\n\r\n//\r\n// #endregion","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Increases the player's max health.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"hemoglobin_saturator\",\r\n        name: \"Hemoglobin Saturator\",\r\n        subtitle: \"Increases red blood cell density for extended durability.\",\r\n        icon: \"/assets/img/icon/upgrades/stats/hemoglobinsaturator.png\",\r\n        type: UpgradeType.STAT,\r\n        rarity: UpgradeRarity.UNCOMMON,\r\n        unique: false,\r\n        func: (player: Player) => {\r\n            params.playerState.updateStat('stats.health.max', player.stats.health.max + 10);\r\n            params.playerState.updateStat('stats.health.value', player.stats.health.max); // Heal to new max\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Increases speed but also increases dash cooldown.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"locomotion_module\",\r\n        name: \"Locomotion Module\",\r\n        subtitle: \"Primitave locomotion module installed on the user's footwear.\",\r\n        icon: \"/assets/img/icon/upgrades/stats/locomotionmodule.png\",\r\n        type: UpgradeType.STAT,\r\n        rarity: UpgradeRarity.COMMON,\r\n        unique: false,\r\n        func: (player: Player) => {\r\n            params.playerState.updateStat('stats.speed', player.stats.speed + 1);\r\n            params.playerState.updateStat('actions.dash.cooldown', player.actions.dash.cooldown * 1.5);\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Luck based, causes projectiles to sometimes break into shrapnel on impact.\r\n// Varying amounts of pieces can spawn, and shrapnel does 1 damage to any enemy hit.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"cluster_module\",\r\n        name: \"Cluster Module\",\r\n        subtitle: \"Cluster enhancement module for primary attacks.\",\r\n        icon: \"/assets/img/icon/upgrades/unique/clustermodule.png\",\r\n        type: UpgradeType.UNIQUE,\r\n        rarity: UpgradeRarity.RARE,\r\n        unique: true,\r\n        func: (player: Player) => {\r\n            if (!player.unique.includes('cluster_module')) {\r\n                player.unique.push('cluster_module');\r\n            }\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Luck based, can replace standard shot with split shot.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"muzzle_splitter\",\r\n        name: \"Muzzle Splitter\",\r\n        subtitle: \"Muzzle modification for primary attacks, requires certain skillset.\",\r\n        icon: \"/assets/img/icon/upgrades/unique/muzzlesplitter.png\",\r\n        type: UpgradeType.UNIQUE,\r\n        rarity: UpgradeRarity.SPECIAL,\r\n        unique: true,\r\n        func: (player: Player) => {\r\n            if (!player.unique.includes('muzzle_splitter')) {\r\n                player.unique.push('muzzle_splitter');\r\n            }\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Dash replaced with spectral teleport, and increased range. No collisions when dashing.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"spectral_image\",\r\n        name: \"Spectral Image\",\r\n        subtitle: \"Forward imaging coordinate transponder.\",\r\n        icon: \"/assets/img/icon/upgrades/unique/spectralimage.png\",\r\n        type: UpgradeType.UNIQUE,\r\n        rarity: UpgradeRarity.EXCEPTIONAL,\r\n        unique: true,\r\n        func: (player: Player) => {\r\n            if (!player.unique.includes('spectral_image')) {\r\n                player.unique.push('spectral_image');\r\n                params.playerState.updateStat('actions.dash.time', player.actions.dash.time + 50);\r\n            }\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Increases stamina, and stamina recovery, but increases regen delay after using.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"bioregulator\",\r\n        name: \"Bioregulator\",\r\n        subtitle: \"Increases energy regulation efficiency, with a small boot overhead.\",\r\n        icon: \"/assets/img/icon/upgrades/stats/bioregulator.png\",\r\n        type: UpgradeType.STAT,\r\n        rarity: UpgradeRarity.COMMON,\r\n        unique: false,\r\n        func: (player: Player) => {\r\n            params.playerState.updateStat('stats.stamina.max', player.stats.stamina.max * 1.1);\r\n            params.playerState.updateStat('stats.stamina.recovery.rate', player.stats.stamina.recovery.rate + 1);\r\n            params.playerState.updateStat('stats.stamina.recovery.delay', player.stats.stamina.recovery.delay * 1.25);\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Increases damage and shot buffer by 10%.\r\n// Bullets hit harder, but can be shot less often each time this is taken. \r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"damage_buffer\",\r\n        name: \"Damage Buffer\",\r\n        subtitle: \"Type D125 buffer, which improves damage at a small cost. \",\r\n        icon: \"/assets/img/icon/upgrades/stats/damagebuffer.png\",\r\n        type: UpgradeType.STAT,\r\n        rarity: UpgradeRarity.UNCOMMON,\r\n        unique: false,\r\n        func: (player: Player) => {\r\n            params.playerState.updateStat('actions.primary.projectile.damage', player.actions.primary.projectile.damage * 1.1);\r\n            params.playerState.updateStat('actions.primary.buffer', player.actions.primary.buffer * 1.1);\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// During dash cooldown, player will be able to hold shoot to auto-fire.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"switch\",\r\n        name: \"Switch\",\r\n        subtitle: \"Completely legal and completely functional.\",\r\n        icon: \"/assets/img/icon/upgrades/equipment/switch.png\",\r\n        type: UpgradeType.EQUIPMENT,\r\n        rarity: UpgradeRarity.RARE,\r\n        unique: false,\r\n        func: (player: Player) => {\r\n            if (!player.equipment.includes('switch')) {\r\n                player.equipment.push('switch');\r\n                params.playerState.updateStat('actions.primary.projectile.spread', player.actions.primary.projectile.spread *= 1.15);\r\n            }\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Luck based, creates visible aura around player.\r\n// Enemy projectiles in radius have a chance to be deflected.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"kinetic_brain\",\r\n        name: \"Kinetic Brain\",\r\n        subtitle: \"Cerebral kinetic stem implant, unable to function at maximum capacity.\",\r\n        icon: \"/assets/img/icon/upgrades/unique/kineticbrain.png\",\r\n        type: UpgradeType.UNIQUE,\r\n        rarity: UpgradeRarity.EXCEPTIONAL,\r\n        unique: true,\r\n        func: (player: Player) => {\r\n            if (!player.unique.includes('kinetic_brain')) {\r\n                player.unique.push('kinetic_brain');\r\n            }\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Gives the player some ammo in their reserves.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"care_package\",\r\n        name: \"Care Package\",\r\n        subtitle: \"These are hard to come by.\",\r\n        icon: \"/assets/img/icon/upgrades/resource/carepackage.png\",\r\n        type: UpgradeType.RESOURCE,\r\n        rarity: UpgradeRarity.COMMON,\r\n        unique: false,\r\n        func: (player: Player) => {\r\n            const ammo = 20;\r\n            player.actions.primary.magazine.currentReserve += ammo;\r\n            params.ui.ammoReservesUIController.spawnAmmoInReserveUI(ammo);\r\n        }\r\n    };\r\n}","import { Upgrade, UpgradeType, UpgradeRarity, Player, UpgradeParams } from '../../../Types';\r\n\r\n// Luck based, chance to add extra projectiles on shot in random direction.\r\n// Extra shots have more spread, less distance and do half damage.\r\n\r\nexport function create(params: UpgradeParams): Upgrade {\r\n    return {\r\n        id: \"projectile_array\",\r\n        name: \"Projectile Array\",\r\n        subtitle: \"Chance to fire an array of extra projectiles.\",\r\n        icon: \"/assets/img/icon/upgrades/unique/projectilearray.png\",\r\n        type: UpgradeType.UNIQUE,\r\n        rarity: UpgradeRarity.RARE,\r\n        unique: true,\r\n        func: (player: Player) => {\r\n            if (!player.unique.includes('projectile_array')) {\r\n                player.unique.push('projectile_array');\r\n            }\r\n        }\r\n    };\r\n}","var map = {\n\t\"./bioregulator/bioregulator\": 528,\n\t\"./bioregulator/bioregulator.ts\": 528,\n\t\"./damagebuffer/damagebuffer\": 612,\n\t\"./damagebuffer/damagebuffer.ts\": 612,\n\t\"./hemoglobinsaturator/hemoglobinsaturator\": 168,\n\t\"./hemoglobinsaturator/hemoglobinsaturator.ts\": 168,\n\t\"./locomotionmodule/locomotionmodule\": 204,\n\t\"./locomotionmodule/locomotionmodule.ts\": 204\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 823;","var map = {\n\t\"./switch/switch\": 617,\n\t\"./switch/switch.ts\": 617\n};\n\n\nfunction webpackContext(req) {\n\tvar id = webpackContextResolve(req);\n\treturn __webpack_require__(id);\n}\nfunction webpackContextResolve(req) {\n\tif(!__webpack_require__.o(map, req)) {\n\t\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\t\te.code = 'MODULE_NOT_FOUND';\n\t\tthrow e;\n\t}\n\treturn map[req];\n}\nwebpackContext.keys = function webpackContextKeys() {\n\treturn Object.keys(map);\n};\nwebpackContext.resolve = webpackContextResolve;\nmodule.exports = webpackContext;\nwebpackContext.id = 854;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","export const SHRAPNEL = {\r\n    PIECE: [\r\n        '/assets/img/effects/shrapnel/shrapnel_00.png',\r\n        '/assets/img/effects/shrapnel/shrapnel_01.png',\r\n        '/assets/img/effects/shrapnel/shrapnel_02.png',\r\n        '/assets/img/effects/shrapnel/shrapnel_03.png',\r\n        '/assets/img/effects/shrapnel/shrapnel_04.png',\r\n        '/assets/img/effects/shrapnel/shrapnel_05.png'\r\n    ]\r\n};\r\n\r\nexport const AMMO_BOX = {\r\n    BASE: '/assets/img/object/ammobox/base.png',\r\n    BULLETS: '/assets/img/object/ammobox/bullets.png',\r\n    LID: '/assets/img/object/ammobox/lid.png',\r\n}\r\n\r\nexport const WORLD = {\r\n    WIDTH: 3200,\r\n    HEIGHT: 2400,\r\n    BORDER_MARGIN: 15\r\n};\r\n\r\nexport const VIEWPORT = {\r\n    WIDTH: 800,\r\n    HEIGHT: 600\r\n};\r\n\r\nexport const GAMEPAD_MAP = {\r\n    // Face buttons\r\n    A: 0,\r\n    B: 1,\r\n    X: 2,\r\n    Y: 3,\r\n\r\n    // Bumpers\r\n    LB: 4,\r\n    RB: 5,\r\n\r\n    // Triggers\r\n    LT: 6,\r\n    RT: 7,\r\n\r\n    // System buttons\r\n    SELECT: 8,\r\n    START: 9,\r\n\r\n    // Stick clicks\r\n    L_STICK: 10,\r\n    R_STICK: 11,\r\n\r\n    // D-Pad\r\n    DPAD_UP: 12,\r\n    DPAD_DOWN: 13,\r\n    DPAD_LEFT: 14,\r\n    DPAD_RIGHT: 15,\r\n\r\n    // Home/Guide button\r\n    HOME: 16,\r\n\r\n    // Axes\r\n    AXES: {\r\n        LEFT_STICK_X: 0,\r\n        LEFT_STICK_Y: 1,\r\n        RIGHT_STICK_X: 2,\r\n        RIGHT_STICK_Y: 3\r\n    }\r\n};\r\n\r\nexport const GAME = {\r\n    CHARACTER_SIZE: 650,\r\n    CONNECTION_TIMEOUT: 1000,\r\n    CONTROLS: {\r\n        KEYBINDS: {\r\n            MELEE: 'mouse2',\r\n            MOVE_UP: 'w',\r\n            MOVE_LEFT: 'a',\r\n            MOVE_DOWN: 's',\r\n            MOVE_RIGHT: 'd',\r\n            RELOAD: 'r',\r\n            SPRINT: 'shift',\r\n            ATTACK: 'mouse1',\r\n            DASH: ' '\r\n        },\r\n        GAMEPAD: {\r\n            MELEE: GAMEPAD_MAP.RB,\r\n            DASH: GAMEPAD_MAP.LB,\r\n            DEADZONE: 0.2,\r\n            RELOAD: GAMEPAD_MAP.A,\r\n            SPRINT: GAMEPAD_MAP.LT,\r\n            ATTACK: GAMEPAD_MAP.RT\r\n        }\r\n    },\r\n    DATA: { ID_LENGTH: 8 },\r\n    GAME_END_DELAY: 5000,\r\n    GRAPHICS: {\r\n        PHYSICS: {\r\n            AMMORESERVES: true\r\n        },\r\n        STATIC_OVERLAY: true,\r\n        BACKGROUND_PARTICLES: true\r\n    },\r\n    MAX_PLAYERS: 4,\r\n    MAX_WINS: 5,\r\n    RECONNECT_DELAY: 3000,\r\n    ROUND_END_DELAY: 3000,\r\n    NEW_ROUND_DELAY: 500\r\n};\r\n\r\nexport const UI = {\r\n    PLAYER_ID_LENGTH: 6,\r\n    FONT: '12px Arial',\r\n    TEXT_COLOR: '#fff'\r\n};\r\n\r\nexport const ROOM = {\r\n    ID_PREFIX: 'room_',\r\n    ID_LENGTH: 10\r\n};\r\n\r\nexport const NETWORK = {\r\n    MOVE_INTERVAL: 10, //ms\r\n    ROTATE_INTERVAL: 25 //ms\r\n}","import { CacheManager } from \"./CacheManager\";\r\nimport { UserInterface } from \"./UserInterface\";\r\n\r\nconst ADMIN_KEYS = {\r\n    KEYS: ['Control', 'Shift', 'Alt', '-', '+'],\r\n    REQUIRED_COUNT: 5\r\n} as const;\r\n\r\nconst CONSOLE_KEY = 'Control';\r\n\r\nexport class Admin {\r\n    private adminKeysHeld: Set<string> = new Set();\r\n\r\n    constructor(private cacheManager: CacheManager, private ui: UserInterface) {\r\n        this.initKeyListener();\r\n        this.initConsoleKeybinds();\r\n    }\r\n\r\n    // #region [ Admin (Locked) ]\r\n    //\r\n    /**\r\n     * Listens for admin key combo and shows modal when detected.\r\n     */\r\n    private initKeyListener(): void {\r\n        window.addEventListener('keydown', (e) => {\r\n            this.adminKeysHeld.add(e.key);\r\n            this.checkAdminCombo();\r\n        });\r\n\r\n        window.addEventListener('keyup', (e) => {\r\n            this.adminKeysHeld.delete(e.key);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Checks held keys against the ADMIN_KEYS configuration.\r\n     */\r\n    private checkAdminCombo(): void {\r\n        const hasAllKeys = ADMIN_KEYS.KEYS.every(key => this.adminKeysHeld.has(key));\r\n\r\n        if (hasAllKeys && this.adminKeysHeld.size === ADMIN_KEYS.REQUIRED_COUNT) {\r\n            this.adminKeysHeld.clear(); // Prevent repeated triggers\r\n            this.showAdminModal();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Shows the admin modal using the general website modal.\r\n     */\r\n    private showAdminModal(): void {\r\n        if (!this.ui.modal || !this.ui.modalInput || !this.ui.modalConfirmButton ||\r\n            !this.ui.modalCancelButton || !this.ui.modalErrorDiv || !this.ui.modalText) return;\r\n\r\n        this.ui.modal.classList.remove('hidden');\r\n        this.ui.modalConfirmButton.classList.remove('hidden');\r\n\r\n        this.ui.modalInput.value = '';\r\n        this.ui.modalInput.style.display = 'block';\r\n        this.ui.modalErrorDiv.textContent = '';\r\n        this.ui.modalText.textContent = 'Enter Admin Command.';\r\n        this.ui.modalConfirmButton.textContent = 'Execute';\r\n        this.ui.modalCancelButton.textContent = 'Cancel';\r\n\r\n        this.ui.modalInput.focus();\r\n\r\n        this.ui.modalConfirmButton.onclick = () => {\r\n            if (!this.ui.modalInput || !this.ui.modalErrorDiv) return;\r\n\r\n            const value = this.ui.modalInput.value.trim();\r\n            if (!value.includes(':')) {\r\n                this.ui.modalErrorDiv.textContent = 'Invalid format.';\r\n                return;\r\n            }\r\n\r\n            const [command, key] = value.split(':');\r\n            if (!command || !key) {\r\n                this.ui.modalErrorDiv.textContent = 'Invalid format.';\r\n                return;\r\n            }\r\n\r\n            this.executeAdminCommand(command.trim(), key.trim());\r\n            this.ui.closeModal();\r\n        };\r\n\r\n        this.ui.modalCancelButton.onclick = () => this.ui.closeModal();\r\n    }\r\n\r\n    /**\r\n     * Executes a command that is in the input field of the admin modal.\r\n     */\r\n    private executeAdminCommand(command: string, key: string): void {\r\n        // This will be called from your main game class with the WebSocket\r\n        console.log(`Admin command: ${command} with key: ${key}`);\r\n\r\n        // You'll expose this via a callback or event system\r\n        this.onAdminCommand?.(command, key);\r\n    }\r\n\r\n    // Public callback for Client.ts\r\n    public onAdminCommand?: (command: string, key: string) => void;\r\n\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Console ]\r\n    //\r\n    /**\r\n     * Clears cache with tilde key\r\n     */\r\n    private initConsoleKeybinds(): void {\r\n        document.addEventListener('keydown', (e) => {\r\n            if (!e.getModifierState(CONSOLE_KEY)) return;\r\n            if (e.key === '`') { e.preventDefault(); this.clearCacheCommand(); }\r\n        });\r\n    }\r\n\r\n    private clearCacheCommand(): void {\r\n        this.cacheManager.clear().then(() => {\r\n            console.log('Cache cleared! Reload the page.');\r\n            location.reload();\r\n        });\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { PlayerPartAnimParams, CharacterAnimation, Vec2 } from \"./Types\";\r\n\r\nimport { RoomManager } from \"./RoomManager\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\nimport { NETWORK } from \"./Config\";\r\n\r\nexport class Animator {\r\n    private characterAnimations: CharacterAnimation = new Map();\r\n    public characterOffsets: Map<string, Vec2> = new Map();\r\n\r\n    constructor(private playerState: PlayerState, private roomManager: RoomManager, private userId: string) { }\r\n\r\n    /**\r\n     * Clears animation state.\r\n     */\r\n    public clear(): void {\r\n        this.characterAnimations.clear();\r\n        this.characterOffsets.clear();\r\n    }\r\n\r\n    // #region [ Animation ]\r\n    /**\r\n     * Animates a specific character part locally with generateCharacterAnimation and broadcasts for other clients to sync animations.\r\n     */\r\n    public animateCharacterPart(params: PlayerPartAnimParams): void {\r\n        this.generateCharacterAnimation(params);\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'character-animation',\r\n            params: params\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Rotates a specific part of a player with the passed rotation.\r\n     */\r\n    public rotateCharacterPart(playerId: string, rotation: number): void {\r\n        if (playerId === this.userId) {\r\n            this.playerState.myPlayer.transform.rot = rotation;\r\n        } else {\r\n            const player = this.playerState.players.get(playerId);\r\n            if (!player) return;\r\n            player.transform.rot = rotation;\r\n        }\r\n\r\n        const now = Date.now();\r\n        const rotationDiff = Math.abs(rotation - this.playerState.lastSentRotation);\r\n        if (rotationDiff > 0.1 && now - this.playerState.lastSentRotationTime >= NETWORK.ROTATE_INTERVAL) {\r\n            this.roomManager.sendMessage(JSON.stringify({\r\n                type: 'player-move',\r\n                transform: {\r\n                    rot: this.playerState.myPlayer.transform.rot\r\n                }\r\n            }));\r\n\r\n            this.playerState.lastSentRotation = rotation;\r\n            this.playerState.lastSentRotationTime = now;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Responds to a network request to process a character animation.\r\n     */\r\n    public animateCharacterPartNetwork(params: PlayerPartAnimParams): void {\r\n        this.generateCharacterAnimation(params);\r\n    }\r\n\r\n    /**\r\n     * Assembles the character animation and adds it to the characterAnimations mapping for playback during update processing.\r\n     */\r\n    private generateCharacterAnimation(params: PlayerPartAnimParams): void {\r\n        const { playerId, part, frames, duration, partIndex } = params;\r\n        const animationId = `${playerId}_${part}_${partIndex || 0}`;\r\n\r\n        this.characterAnimations.set(animationId, {\r\n            playerId: playerId,\r\n            part: part,\r\n            partIndex: partIndex,\r\n            frames: frames,\r\n            duration: duration,\r\n            startTime: Date.now(),\r\n            originalOffset: { x: 0, y: 0 }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Process visual character animations by updating part positions.\r\n     */\r\n    public updateCharacterAnimations(delta: number): void {\r\n        const animationsToRemove: string[] = [];\r\n        const currentTime = Date.now();\r\n\r\n        this.characterAnimations.forEach((animation, animationId) => {\r\n            const elapsed = currentTime - animation.startTime;\r\n            const progress = elapsed / animation.duration;\r\n\r\n            if (animation.duration !== 0 && progress >= 1) {\r\n                // Animation complete, remove it\r\n                animationsToRemove.push(animationId);\r\n                return;\r\n            }\r\n\r\n            // Find current keyframe\r\n            const frameKeys = Object.keys(animation.frames).map(Number).sort((a, b) => a - b);\r\n            let currentFrameIndex = 0;\r\n\r\n            for (let i = 0; i < frameKeys.length - 1; i++) {\r\n                const frameProgress = frameKeys[i];\r\n                const nextFrameProgress = frameKeys[i + 1];\r\n\r\n                if (progress >= frameProgress && progress < nextFrameProgress) {\r\n                    currentFrameIndex = i;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            let lerpedX, lerpedY;\r\n            if (progress >= 1) { // Hold at last keyframe for infinite animation\r\n                const lastFrame = animation.frames[frameKeys[frameKeys.length - 1]];\r\n                lerpedX = lastFrame.x;\r\n                lerpedY = lastFrame.y;\r\n            } else { // Normal animation with no lerp\r\n                const currentFrame = animation.frames[frameKeys[currentFrameIndex]];\r\n                const nextFrame = animation.frames[frameKeys[currentFrameIndex + 1]] || currentFrame;\r\n                const frameProgress = (progress - frameKeys[currentFrameIndex]) / (frameKeys[currentFrameIndex + 1] - frameKeys[currentFrameIndex]) || 0;\r\n                lerpedX = currentFrame.x + (nextFrame.x - currentFrame.x) * frameProgress;\r\n                lerpedY = currentFrame.y + (nextFrame.y - currentFrame.y) * frameProgress;\r\n            }\r\n\r\n            this.characterOffsets.set(animationId, { x: lerpedX, y: lerpedY });\r\n        });\r\n\r\n        // Remove completed animations\r\n        animationsToRemove.forEach(id => {\r\n            this.characterAnimations.delete(id);\r\n            if (this.characterOffsets) {\r\n                this.characterOffsets.delete(id);\r\n            }\r\n        });\r\n    }\r\n    //\r\n    // #endregion\r\n}","export class CacheManager {\r\n    private dbName = 'SaltpeterCache';\r\n    private dbVersion = 3;\r\n    private db: IDBDatabase | null = null;\r\n\r\n    constructor() {\r\n        this.initDB();\r\n    }\r\n\r\n    /**\r\n     * Initializes the IndexedDB database\r\n     */\r\n    private async initDB(): Promise<void> {\r\n        return new Promise((resolve, reject) => {\r\n            const request = indexedDB.open(this.dbName, this.dbVersion);\r\n\r\n            request.onerror = () => reject(request.error);\r\n            request.onsuccess = () => {\r\n                this.db = request.result;\r\n                resolve();\r\n            };\r\n\r\n            request.onupgradeneeded = (event) => {\r\n                const db = (event.target as IDBOpenDBRequest).result;\r\n                if (!db.objectStoreNames.contains('settings')) {\r\n                    db.createObjectStore('settings');\r\n                }\r\n            };\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Writes any value to the cache\r\n     */\r\n    public async write(key: string, value: any): Promise<void> {\r\n        if (!this.db) await this.initDB();\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const transaction = this.db!.transaction(['settings'], 'readwrite');\r\n            const store = transaction.objectStore('settings');\r\n            const request = store.put(value, key);\r\n\r\n            request.onerror = () => reject(request.error);\r\n            request.onsuccess = () => resolve();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Reads a value from the cache\r\n     */\r\n    public async read(key: string): Promise<any> {\r\n        if (!this.db) await this.initDB();\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const transaction = this.db!.transaction(['settings'], 'readonly');\r\n            const store = transaction.objectStore('settings');\r\n            const request = store.get(key);\r\n\r\n            request.onerror = () => reject(request.error);\r\n            request.onsuccess = () => resolve(request.result);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Deletes a value from the cache\r\n     */\r\n    public async delete(key: string): Promise<void> {\r\n        if (!this.db) await this.initDB();\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const transaction = this.db!.transaction(['settings'], 'readwrite');\r\n            const store = transaction.objectStore('settings');\r\n            const request = store.delete(key);\r\n\r\n            request.onerror = () => reject(request.error);\r\n            request.onsuccess = () => resolve();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Clears all cached data\r\n     */\r\n    public async clear(): Promise<void> {\r\n        if (!this.db) await this.initDB();\r\n\r\n        return new Promise((resolve, reject) => {\r\n            const transaction = this.db!.transaction(['settings'], 'readwrite');\r\n            const store = transaction.objectStore('settings');\r\n            const request = store.clear();\r\n\r\n            request.onerror = () => reject(request.error);\r\n            request.onsuccess = () => resolve();\r\n        });\r\n    }\r\n}","import { VIEWPORT, WORLD } from \"./Config\";\r\nimport { Vec2 } from \"./Types\";\r\n\r\nimport { Utility } from \"./Utility\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\n\r\nexport class Camera {\r\n    public pos: Vec2 = { x: 0, y: 0 }\r\n    public targetPos: Vec2 = { x: 0, y: 0 }\r\n\r\n    public config = {\r\n        followSpeed: 0.1,\r\n        lookAhead: 100 // Forward pixel offset based on player rotation\r\n    }\r\n\r\n    constructor(\r\n        private playerState: PlayerState,\r\n        private utility: Utility\r\n    ) { }\r\n\r\n    /**\r\n     * Processes camera updates during gameplay.\r\n     */\r\n    public update(delta: number): void {\r\n        // Get player's forward direction and convert rotation to direction\r\n        const playerRot = this.playerState.myPlayer.transform.rot - Math.PI / 2;\r\n        const forwardDir = this.utility.forward(playerRot);\r\n\r\n        // Calculate look-ahead offset\r\n        const offsetX = forwardDir.x * this.config.lookAhead;\r\n        const offsetY = forwardDir.y * this.config.lookAhead;\r\n\r\n        // Set camera target to follow player with directional offset\r\n        this.targetPos.x = (this.playerState.myPlayer.transform.pos.x + offsetX) - VIEWPORT.WIDTH / 2;\r\n        this.targetPos.y = (this.playerState.myPlayer.transform.pos.y + offsetY) - VIEWPORT.HEIGHT / 2;\r\n\r\n        // Constrain camera to world bounds\r\n        this.targetPos.x = Math.max(0, Math.min(WORLD.WIDTH - VIEWPORT.WIDTH, this.targetPos.x));\r\n        this.targetPos.y = Math.max(0, Math.min(WORLD.HEIGHT - VIEWPORT.HEIGHT, this.targetPos.y));\r\n\r\n        // Smooth camera movement\r\n        this.pos.x += (this.targetPos.x - this.pos.x) * this.config.followSpeed * delta;\r\n        this.pos.y += (this.targetPos.y - this.pos.y) * this.config.followSpeed * delta;\r\n    }\r\n\r\n    /**\r\n     * Convert world coordinates to screen coordinates.\r\n     */\r\n    public worldToScreen(worldPos: Vec2): Vec2 {\r\n        return {\r\n            x: worldPos.x - this.pos.x,\r\n            y: worldPos.y - this.pos.y\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Convert screen coordinates to world coordinates.\r\n     */\r\n    public screenToWorld(screenPos: Vec2): Vec2 {\r\n        return {\r\n            x: screenPos.x + this.pos.x,\r\n            y: screenPos.y + this.pos.y\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Check if world position is visible on screen.\r\n     */\r\n    public isVisible(worldPos: Vec2, margin: number = 50): boolean {\r\n        return worldPos.x >= this.pos.x - margin &&\r\n            worldPos.x <= this.pos.x + VIEWPORT.WIDTH + margin &&\r\n            worldPos.y >= this.pos.y - margin &&\r\n            worldPos.y <= this.pos.y + VIEWPORT.HEIGHT + margin;\r\n    }\r\n}","import { WeaponMagazine } from \"./Types\";\r\n\r\nexport class CharacterConfig {\r\n    public weapon = {\r\n        glock: [\r\n            '/assets/img/weapon/glock/body.png',\r\n            '/assets/img/weapon/glock/slide.png',\r\n        ],\r\n        knife: [\r\n            '/assets/img/weapon/melee/knife_00.png'\r\n        ]\r\n    };\r\n\r\n    public magazine: Record<string, WeaponMagazine> = {\r\n        glock: {\r\n            empty: '/assets/img/object/weapons/glock/magazine_empty.png',\r\n            full: '/assets/img/object/weapons/glock/magazine_full.png'\r\n        }\r\n    };\r\n\r\n    public body = {\r\n        default: '/assets/img/char/body/default.png'\r\n    };\r\n\r\n    public head = {\r\n        default: '/assets/img/char/head/default.png',\r\n        blondeAfro: '/assets/img/char/head/blonde_afro.png'\r\n    };\r\n\r\n    public headwear = {\r\n        default: '/assets/img/char/headwear/default.png',\r\n        fez: '/assets/img/char/headwear/fez.png',\r\n        strawHat: '/assets/img/char/headwear/straw_hat.png',\r\n        trucker: '/assets/img/char/headwear/trucker.png'\r\n    };\r\n\r\n    public upgrades = {\r\n        kineticBrain: '/assets/img/char/upgrades/kineticbrain.png'\r\n    };\r\n\r\n    public characterDecals = {\r\n        default: {\r\n            blood: [\r\n                '/assets/img/effects/blood/blood_00.png',\r\n                '/assets/img/effects/blood/blood_01.png',\r\n                '/assets/img/effects/blood/blood_02.png',\r\n                '/assets/img/effects/blood/blood_03.png',\r\n                '/assets/img/effects/blood/blood_04.png'\r\n            ],\r\n            gore: [\r\n                '/assets/img/effects/gore/gore_00.png',\r\n                '/assets/img/effects/gore/gore_01.png',\r\n                '/assets/img/effects/gore/gore_02.png',\r\n                '/assets/img/effects/gore/gore_03.png',\r\n                '/assets/img/effects/gore/gore_04.png',\r\n                '/assets/img/effects/gore/gore_05.png',\r\n                '/assets/img/effects/gore/gore_06.png',\r\n                '/assets/img/effects/gore/gore_07.png',\r\n                '/assets/img/effects/gore/gore_08.png',\r\n                '/assets/img/effects/gore/gore_09.png',\r\n                '/assets/img/effects/gore/gore_10.png',\r\n                '/assets/img/effects/gore/gore_11.png',\r\n                '/assets/img/effects/gore/gore_12.png',\r\n                '/assets/img/effects/gore/gore_13.png'\r\n            ]\r\n        }\r\n    };\r\n\r\n    constructor() { }\r\n}","import { CharacterConfig } from \"./CharacterConfig\";\r\nimport { CharacterLayer } from \"./Types\";\r\n\r\nexport class CharacterManager {\r\n    constructor(private charConfig: CharacterConfig) { }\r\n\r\n    public getCharacterAsset(layer: CharacterLayer, variant: string): string | string[] {\r\n        switch (layer) {\r\n            case 'body':\r\n                return this.charConfig.body[variant as keyof typeof this.charConfig.body] || this.charConfig.body.default;\r\n            case 'weapon':\r\n                return this.charConfig.weapon[variant as keyof typeof this.charConfig.weapon] || this.charConfig.weapon.glock;\r\n            case 'head':\r\n                return this.charConfig.head[variant as keyof typeof this.charConfig.head] || this.charConfig.head.default;\r\n            case 'headwear':\r\n                return this.charConfig.headwear[variant as keyof typeof this.charConfig.headwear] || this.charConfig.headwear.default;\r\n            case 'upgrades':\r\n                return variant;\r\n            default:\r\n                throw new Error(`Unknown character layer: ${layer}`);\r\n        }\r\n    }\r\n\r\n    public getUpgradeVisual(upgradeName: string): string | null {\r\n        const lowerName = upgradeName.toLowerCase();\r\n        return this.charConfig.upgrades[lowerName as keyof typeof this.charConfig.upgrades] || null;\r\n    }\r\n}","import { Vec2 } from \"./Types\";\r\n\r\nimport { SettingsManager } from \"./SettingsManager\";\r\n\r\nexport class ControlsManager {\r\n    private activeKeys: Set<string> = new Set();\r\n    private gamepadKeys: Set<string> = new Set();\r\n    private previousKeys: Set<string> = new Set();\r\n\r\n    private mousePos: Vec2 = { x: 0, y: 0 };;\r\n\r\n    private gamepadConnected: boolean = false;\r\n    public gamepadConnectionEnabled: boolean = true;\r\n\r\n    private gamepadRAxis: number | null = null;\r\n\r\n    constructor(private settingsManager: SettingsManager) {\r\n        this.initGamepad();\r\n    }\r\n\r\n    /**\r\n     * Clears the internal controls state.\r\n     */\r\n    public clear(): void {\r\n        this.clearActiveKeys();\r\n\r\n        this.gamepadRAxis = null;\r\n\r\n        this.mousePos.x = 0;\r\n        this.mousePos.y = 0;\r\n    }\r\n\r\n    // #region [ Keys ]\r\n    //\r\n    /**\r\n     * Returns true if the key is currently being held down.\r\n     */\r\n    public held(key: string): boolean {\r\n        return this.activeKeys.has(key);\r\n    }\r\n\r\n    /**\r\n     * Returns true if the key was pressed this frame.\r\n     */\r\n    public triggered(key: string): boolean {\r\n        return this.activeKeys.has(key) && !this.previousKeys.has(key);\r\n    }\r\n\r\n    /**\r\n     * Returns a read-only copy of the currently active (pressed) keys.\r\n     */\r\n    public getActiveKeys(): ReadonlySet<string> {\r\n        return this.activeKeys;\r\n    }\r\n\r\n    /**\r\n     * Adds a key to the active key set.\r\n     */\r\n    public addKey(key: string): void {\r\n        this.activeKeys.add(key);\r\n    }\r\n\r\n    /**\r\n     * Removes a key from the active key set.\r\n     */\r\n    public removeKey(key: string): void {\r\n        this.activeKeys.delete(key);\r\n    }\r\n\r\n    /**\r\n     * Clears all currently active (pressed) keys.\r\n     */\r\n    public clearActiveKeys(): void {\r\n        this.activeKeys.clear();\r\n        this.gamepadKeys.clear();\r\n        this.previousKeys.clear();\r\n    }\r\n\r\n    /**\r\n     * Monitors the previous keys set, allowing for action triggers.\r\n     */\r\n    public updatePreviousKeys(): void {\r\n        this.previousKeys = new Set(this.activeKeys);\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Mouse ]\r\n    //\r\n    /**\r\n     * Returns the current mouse position as a read-only Vec2.\r\n     */\r\n    public getMousePos(): Readonly<Vec2> {\r\n        return this.mousePos;\r\n    }\r\n\r\n    /**\r\n     * Updates the stored mouse position.\r\n     */\r\n    public setMousePos(pos: Vec2): void {\r\n        this.mousePos.x = pos.x;\r\n        this.mousePos.y = pos.y;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Gamepad ]\r\n    //\r\n    /**\r\n     * Initializes gamepad connection listeners.\r\n     */\r\n    private initGamepad(): void {\r\n        window.addEventListener(\"gamepadconnected\", () => {\r\n            console.log(\"Gamepad connected!\");\r\n            this.gamepadConnected = true;\r\n        });\r\n\r\n        window.addEventListener(\"gamepaddisconnected\", () => {\r\n            console.log(\"Gamepad disconnected!\");\r\n            this.gamepadConnected = false;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Used to poll for gamepad inputs when one is connected.\r\n     * \r\n     * Gamepad bindings map to the keyboard bindings to trigger actions.\r\n     */\r\n    public pollGamepad(): void {\r\n        if (!this.gamepadConnected) return;\r\n\r\n        const gamepads = navigator.getGamepads();\r\n        const gamepad = gamepads[0];\r\n        if (!gamepad) return;\r\n\r\n        const settings = this.settingsManager.getSettings();\r\n        const keybinds = settings.controls.keybinds;\r\n        const gamepadMap = settings.controls.gamepad;\r\n        const deadzone = gamepadMap.deadzone;\r\n\r\n        // Clear previous gamepad keys\r\n        this.gamepadKeys.forEach(key => this.activeKeys.delete(key));\r\n        this.gamepadKeys.clear();\r\n\r\n        const xAxis = gamepad.axes[0];\r\n        const yAxis = gamepad.axes[1];\r\n\r\n        if (xAxis > deadzone) {\r\n            this.activeKeys.add(keybinds.moveRight);\r\n            this.gamepadKeys.add(keybinds.moveRight);\r\n        }\r\n\r\n        if (xAxis < -deadzone) {\r\n            this.activeKeys.add(keybinds.moveLeft);\r\n            this.gamepadKeys.add(keybinds.moveLeft);\r\n        }\r\n\r\n        if (yAxis > deadzone) {\r\n            this.activeKeys.add(keybinds.moveDown);\r\n            this.gamepadKeys.add(keybinds.moveDown);\r\n        }\r\n\r\n        if (yAxis < -deadzone) {\r\n            this.activeKeys.add(keybinds.moveUp);\r\n            this.gamepadKeys.add(keybinds.moveUp);\r\n        }\r\n\r\n        if (gamepad.buttons[gamepadMap.melee].pressed) {\r\n            this.activeKeys.add(keybinds.melee);\r\n            this.gamepadKeys.add(keybinds.melee);\r\n        }\r\n\r\n        if (gamepad.buttons[gamepadMap.dash].pressed) {\r\n            this.activeKeys.add(keybinds.dash);\r\n            this.gamepadKeys.add(keybinds.dash);\r\n        }\r\n\r\n        if (gamepad.buttons[gamepadMap.reload].pressed) {\r\n            this.activeKeys.add(keybinds.reload);\r\n            this.gamepadKeys.add(keybinds.reload);\r\n        }\r\n\r\n        if (gamepad.buttons[gamepadMap.attack].pressed) {\r\n            this.activeKeys.add(keybinds.attack);\r\n            this.gamepadKeys.add(keybinds.attack);\r\n        }\r\n\r\n        if (gamepad.buttons[gamepadMap.sprint].pressed) {\r\n            this.activeKeys.add(keybinds.sprint);\r\n            this.gamepadKeys.add(keybinds.sprint);\r\n        }\r\n\r\n        // Right stick aiming\r\n        const rightX = gamepad.axes[2];\r\n        const rightY = gamepad.axes[3];\r\n        const aimMagnitude = Math.sqrt(rightX * rightX + rightY * rightY);\r\n\r\n        if (aimMagnitude > deadzone) {\r\n            this.gamepadRAxis = Math.atan2(rightY, rightX) + Math.PI / 2;\r\n        } else {\r\n            this.gamepadRAxis = null;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns the current right axis input.\r\n     */\r\n    public getGamepadRAxis(): number | null {\r\n        return this.gamepadRAxis;\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { WORLD } from \"./Config\";\r\nimport { Player } from \"./Types\";\r\n\r\nimport { ObjectsManager } from \"./ObjectsManager\";\r\nimport { RoomManager } from \"./RoomManager\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\nimport { UserInterface } from \"./UserInterface\";\r\n\r\n\r\nexport class CollisionsManager {\r\n    constructor(\r\n        private objectsManager: ObjectsManager,\r\n        private playerState: PlayerState,\r\n        private roomManager: RoomManager,\r\n        private ui: UserInterface,\r\n        private userId: string\r\n    ) {}\r\n\r\n    /**\r\n     * Responsible for handling all collisions in the game. Routes to other collision functions.\r\n     */\r\n    public checkCollisions(delta: number): void {\r\n        const minX = WORLD.BORDER_MARGIN;\r\n        const maxX = WORLD.WIDTH - WORLD.BORDER_MARGIN;\r\n        const minY = WORLD.BORDER_MARGIN;\r\n        const maxY = WORLD.HEIGHT - WORLD.BORDER_MARGIN;\r\n\r\n        this.playerState.myPlayer.transform.pos.x = Math.max(minX, Math.min(maxX, this.playerState.myPlayer.transform.pos.x));\r\n        this.playerState.myPlayer.transform.pos.y = Math.max(minY, Math.min(maxY, this.playerState.myPlayer.transform.pos.y));\r\n\r\n        this.checkObjectCollisions(delta);\r\n        this.checkPlayersCollisions(delta);\r\n    }\r\n\r\n    /**\r\n     * Checks for my player colliding with objects in the game. \r\n     */\r\n    private checkObjectCollisions(delta: number): void {\r\n        if (!this.collisionsEnabled(this.playerState.myPlayer)) return;\r\n\r\n        const collisionRadius = this.getPlayerCollider(this.playerState.myPlayer, 5);\r\n\r\n        this.objectsManager.ammoBoxes.forEach((ammoBox, boxId) => {\r\n            if (ammoBox.isOpen) return;\r\n\r\n            const dx = this.playerState.myPlayer.transform.pos.x - ammoBox.transform.pos.x;\r\n            const dy = this.playerState.myPlayer.transform.pos.y - ammoBox.transform.pos.y;\r\n            const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n            if (distance <= collisionRadius) {\r\n                // Calculate how much ammo can actually be picked up\r\n                const currentReserve = this.playerState.myPlayer.actions.primary.magazine.currentReserve;\r\n                const maxReserve = this.playerState.myPlayer.actions.primary.magazine.maxReserve;\r\n                const actualAmmoAdded = Math.min(ammoBox.ammoAmount, maxReserve - currentReserve);\r\n\r\n                // Only pick up if we can actually add ammo\r\n                if (actualAmmoAdded > 0) {\r\n                    this.playerState.myPlayer.actions.primary.magazine.currentReserve += actualAmmoAdded;\r\n\r\n                    // Spawn UI bullets based on ACTUAL ammo added, not ammo box amount\r\n                    this.ui.ammoReservesUIController.spawnAmmoInReserveUI(actualAmmoAdded);\r\n\r\n                    console.log(`Picked up ammo box! +${actualAmmoAdded} bullets. Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`);\r\n\r\n                    // Generate random lid physics\r\n                    const angle = Math.random() * Math.PI * 2;\r\n                    const speed = 2 + Math.random() * 3;\r\n\r\n                    ammoBox.isOpen = true;\r\n                    ammoBox.lid.velocity = {\r\n                        x: Math.cos(angle) * speed,\r\n                        y: Math.sin(angle) * speed\r\n                    };\r\n                    ammoBox.lid.torque = (Math.random() - 0.5) * 0.3;\r\n\r\n                    // Broadcast pickup with full box state\r\n                    this.roomManager.sendMessage(JSON.stringify({\r\n                        type: 'ammo-pickup',\r\n                        ammoBoxId: boxId,\r\n                        playerId: this.userId,\r\n                        boxState: {\r\n                            isOpen: true,\r\n                            lid: ammoBox.lid\r\n                        }\r\n                    }));\r\n                }\r\n            }\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Checks for collisions with other players, blocking movement.\r\n     */\r\n    private checkPlayersCollisions(delta: number): void {\r\n        if (!this.collisionsEnabled(this.playerState.myPlayer)) return;\r\n\r\n        this.playerState.players.forEach((player: Player) => {\r\n            if (!this.collisionsEnabled(player)) return;\r\n\r\n            const dx = this.playerState.myPlayer.transform.pos.x - player.transform.pos.x;\r\n            const dy = this.playerState.myPlayer.transform.pos.y - player.transform.pos.y;\r\n            const dist = Math.sqrt(dx * dx + dy * dy);\r\n            const minDist = this.getPlayerCollider(this.playerState.myPlayer) + this.getPlayerCollider(player);\r\n\r\n            if (dist < minDist && dist > 0.01) { // Push myself away from the other player\r\n                const overlap = minDist - dist;\r\n                const pushX = (dx / dist) * overlap;\r\n                const pushY = (dy / dist) * overlap;\r\n\r\n                this.playerState.myPlayer.transform.pos.x += pushX;\r\n                this.playerState.myPlayer.transform.pos.y += pushY;\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Returns the player collider, with padding if needed.\r\n     */\r\n    public getPlayerCollider(player: Player, padding?: number): number {\r\n        let col = player.stats.size / 4\r\n\r\n        if (padding && padding > 0) {\r\n            col = (player.stats.size / 4) + padding\r\n        }\r\n\r\n        return col;\r\n    }\r\n    \r\n    /**\r\n     * Checks if the specific player's collisions are enabled.\r\n     */\r\n    public collisionsEnabled(player: Player): boolean {\r\n        if (player.stats.health.value <= 0) return false\r\n        if (player.flags.hidden && player.flags.invulnerable) return false\r\n        return true\r\n    }\r\n}","import { MaterialDecals, ParametricDecalParams } from \"./Types\";\r\n\r\nexport class DecalsConfig {\r\n    public decals = {\r\n        blood: {\r\n            radius: {\r\n                min: 5,\r\n                max: 17.5\r\n            },\r\n            density: {\r\n                min: 0.1,\r\n                max: 0.175\r\n            },\r\n            opacity: {\r\n                min: 0.275,\r\n                max: 0.315\r\n            },\r\n            variation: 0.5,\r\n            colors: [\"#781414\", \"#710606\", \"#a10101\"]\r\n        } as ParametricDecalParams,\r\n        explosion: {\r\n            radius: {\r\n                min: 25,\r\n                max: 40\r\n            },\r\n            density: {\r\n                min: 0.375,\r\n                max: 0.575\r\n            },\r\n            opacity: {\r\n                min: 0.35,\r\n                max: 0.525\r\n            },\r\n            variation: 0.2,\r\n            colors: [\"#434343\", \"#2a2a2a\", \"#3b1d1d\"]\r\n        } as ParametricDecalParams\r\n    };\r\n\r\n    public materialDecals: Record<string, MaterialDecals> = {\r\n        metal: {\r\n            ranged: {\r\n                radius: { min: 4, max: 8 },\r\n                density: { min: 0.175, max: 0.35 },\r\n                opacity: { min: 0.15, max: 0.25 },\r\n                variation: 0.215,\r\n                colors: [\"#39362d\", \"#2a2823\", \"#4c4638\"]\r\n            }\r\n        },\r\n    };\r\n\r\n    constructor() { }\r\n}","import { WORLD } from \"./Config\";\r\nimport { DeathDecal, DeathStamp, Decal, DecalParams, ImageDecalParams, ParametricDecalParams, Vec2 } from \"./Types\";\r\n\r\nimport { Camera } from \"./Camera\";\r\nimport { CharacterConfig } from \"./CharacterConfig\";\r\nimport { DecalsConfig } from \"./DecalsConfig\";\r\nimport { RoomManager } from \"./RoomManager\";\r\nimport { UserInterface } from \"./UserInterface\";\r\nimport { Utility } from \"./Utility\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\nimport { RenderingManager } from \"./RenderingManager\";\r\n\r\nexport class DecalsManager {\r\n    public decalsConfig: DecalsConfig;\r\n\r\n    public dynamicDecals: Map<string, Decal> = new Map();\r\n    public staticDecalData: ImageData | null = null;\r\n\r\n    constructor(\r\n        private camera: Camera,\r\n        private charConfig: CharacterConfig,\r\n        private playerState: PlayerState,\r\n        private renderingManager: RenderingManager,\r\n        private roomManager: RoomManager,\r\n        private ui: UserInterface,\r\n        private userId: string,\r\n        private utility: Utility\r\n    ) {\r\n        this.decalsConfig = new DecalsConfig();\r\n    }\r\n\r\n    /**\r\n     * Clears static and dynamic decal data.\r\n     */\r\n    public clear(): void {\r\n        this.dynamicDecals.clear();\r\n        this.staticDecalData = null;\r\n    }\r\n\r\n    // #region [ Decals ]\r\n    //\r\n    /**\r\n     * Create a decal and broadcast over the network.\r\n     */\r\n    public createDecal(params: DecalParams): void {\r\n        this.generateDecal(params);\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'add-decal',\r\n            params: params\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Create a decal locally when receiving an 'add-decal' network message.\r\n     */\r\n    public createDecalNetwork(params: DecalParams): void {\r\n        if (this.dynamicDecals.has(params.id)) return; // Don't create duplicate decals\r\n\r\n        this.generateDecal(params);\r\n    }\r\n\r\n    /**\r\n     * Locally generate the decal and stamp it to the decal canvas.\r\n     */\r\n    public generateDecal(params: DecalParams): void {\r\n        if (!this.ui.decalCtx) return;\r\n\r\n        const { x, y } = params.pos;\r\n\r\n        // Check WORLD bounds\r\n        if (x < 0 || x > WORLD.WIDTH || y < 0 || y > WORLD.HEIGHT) return;\r\n\r\n        // Stamp decal at WORLD coordinates (no camera conversion needed)\r\n        if (params.type === 'parametric' && params.parametric) {\r\n            this.generateParametricDecal(params.pos, params.parametric);\r\n        } else if (params.type === 'image' && params.image) {\r\n            this.generateImageDecal(params.pos, params.image);\r\n        }\r\n\r\n        // Store decal with WORLD position\r\n        this.dynamicDecals.set(params.id, { params, pos: { x, y } });\r\n    }\r\n\r\n    /**\r\n     * Generate parametric pixel-based decal.\r\n     * \r\n     * This type of decal does not use an image, but instead paints pixels based on parameters.\r\n     */\r\n    private generateParametricDecal(pos: Vec2, params: ParametricDecalParams): void {\r\n        if (!this.ui.decalCtx) return;\r\n\r\n        const radius = params.radius.min + Math.random() * (params.radius.max - params.radius.min);\r\n        const density = params.density.min + Math.random() * (params.density.max - params.density.min);\r\n        const opacity = params.opacity.min + Math.random() * (params.opacity.max - params.opacity.min);\r\n\r\n        const numPixels = Math.floor((radius * radius * Math.PI) * density);\r\n\r\n        this.ui.decalCtx.save();\r\n        this.ui.decalCtx.globalCompositeOperation = 'source-over';\r\n\r\n        for (let i = 0; i < numPixels; i++) {\r\n            const angle = Math.random() * Math.PI * 2;\r\n            const distance = Math.random() * radius;\r\n            const pixelX = pos.x + Math.cos(angle) * distance;\r\n            const pixelY = pos.y + Math.sin(angle) * distance;\r\n\r\n            // Check WORLD bounds (decal canvas is world-sized)\r\n            if (pixelX < 0 || pixelX >= WORLD.WIDTH || pixelY < 0 || pixelY >= WORLD.HEIGHT) continue;\r\n\r\n            // Pick random color from array\r\n            const chosenColor = params.colors[Math.floor(Math.random() * params.colors.length)];\r\n            const rgb = this.utility.hexToRgb(chosenColor);\r\n            if (!rgb) continue;\r\n\r\n            const pixelOpacity = opacity + (Math.random() - 0.5) * params.variation;\r\n            const clampedOpacity = Math.max(0.05, Math.min(0.6, pixelOpacity));\r\n\r\n            this.ui.decalCtx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${clampedOpacity})`;\r\n            // Draw at world coordinates\r\n            this.ui.decalCtx.fillRect(Math.floor(pixelX), Math.floor(pixelY), 1, 1);\r\n        }\r\n\r\n        this.ui.decalCtx.restore();\r\n    }\r\n\r\n    /**\r\n     * Generate image-based decal (for magazines, gore, etc.).\r\n     */\r\n    private generateImageDecal(pos: Vec2, params: ImageDecalParams): void {\r\n        if (!this.ui.decalCtx) return;\r\n\r\n        let image = new Image();\r\n        image.src = params.src;\r\n\r\n        const drawImage = () => {\r\n            if (!this.ui.decalCtx) return;\r\n            if (!image.complete || image.naturalWidth === 0) return;\r\n\r\n            this.ui.decalCtx.save();\r\n            this.ui.decalCtx.translate(pos.x, pos.y);\r\n            this.ui.decalCtx.rotate(params.rotation);\r\n\r\n            const drawSize = 32 * params.scale;\r\n            this.ui.decalCtx.drawImage(\r\n                image,\r\n                -drawSize / 2,\r\n                -drawSize / 2,\r\n                drawSize,\r\n                drawSize\r\n            );\r\n\r\n            this.ui.decalCtx.restore();\r\n        };\r\n\r\n        if (image.complete) {\r\n            drawImage();\r\n        } else {\r\n            image.onload = drawImage;\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Gore ]\r\n    //\r\n    /**\r\n     * Generates gore particles using the decals for the character object.\r\n     */\r\n    public generateGore(params: DeathDecal): void {\r\n        const gorePool = [...this.charConfig.characterDecals.default.gore]; // TODO: Get current pool for gore\r\n        for (let i = 0; i < params.gore.amount && gorePool.length > 0; i++) {\r\n            const goreAsset = this.utility.getRandomInArray(gorePool);\r\n            gorePool.splice(gorePool.indexOf(goreAsset), 1);\r\n            const angle = this.utility.getRandomNum(0, Math.PI * 2);\r\n            const distance = this.utility.getRandomNum(0, params.radius);\r\n\r\n            const goreDecal: DeathStamp = {\r\n                type: 'gore',\r\n                src: goreAsset,\r\n                transform: {\r\n                    pos: {\r\n                        x: params.pos.x + Math.cos(angle) * distance,\r\n                        y: params.pos.y + Math.sin(angle) * distance\r\n                    },\r\n                    rot: this.utility.getRandomNum(0, Math.PI * 2),\r\n                },\r\n                scale: this.utility.getRandomNum(0.65, 1.05)\r\n            };\r\n\r\n            const decalId = `death_gore_${params.ownerId}_${Date.now()}_${i}`;\r\n            this.stampGore(goreDecal);\r\n            this.dynamicDecals.set(decalId, {\r\n                params: null,\r\n                pos: {\r\n                    x: goreDecal.transform.pos.x,\r\n                    y: goreDecal.transform.pos.y\r\n                }\r\n            });\r\n        }\r\n\r\n        const bloodPool = [...this.charConfig.characterDecals.default.blood]; // TODO: Get current pool for blood\r\n        for (let i = 0; i < params.blood.amount && bloodPool.length > 0; i++) {\r\n            const bloodAsset = this.utility.getRandomInArray(bloodPool);\r\n            bloodPool.splice(bloodPool.indexOf(bloodAsset), 1);\r\n            const angle = this.utility.getRandomNum(0, Math.PI * 2);\r\n            const distance = this.utility.getRandomNum(0, params.radius * 0.7);\r\n\r\n            const bloodDecal: DeathStamp = {\r\n                type: 'blood',\r\n                src: bloodAsset,\r\n                transform: {\r\n                    pos: {\r\n                        x: params.pos.x + Math.cos(angle) * distance,\r\n                        y: params.pos.y + Math.sin(angle) * distance\r\n                    },\r\n                    rot: this.utility.getRandomNum(0, Math.PI * 2),\r\n                },\r\n                scale: this.utility.getRandomNum(1.25, 1.45)\r\n            };\r\n\r\n            const decalId = `death_blood_${params.ownerId}_${Date.now()}_${i}`;\r\n            this.stampGore(bloodDecal);\r\n            this.dynamicDecals.set(decalId, {\r\n                params: null,\r\n                pos: {\r\n                    x: bloodDecal.transform.pos.x,\r\n                    y: bloodDecal.transform.pos.y\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Persists gore on the decal canvas.\r\n     */\r\n    private stampGore(params: DeathStamp): void {\r\n        if (!this.ui.decalCtx) return;\r\n        \r\n        const worldPos = params.transform.pos;\r\n\r\n        this.ui.decalCtx.save();\r\n        this.ui.decalCtx.translate(worldPos.x, worldPos.y);\r\n        this.ui.decalCtx.rotate(params.transform.rot);\r\n\r\n        let image = this.renderingManager.characterImages.get(params.src);\r\n\r\n        if (!image) {\r\n            image = new Image();\r\n            image.src = params.src;\r\n            this.renderingManager.characterImages.set(params.src, image);\r\n\r\n            if (!image.complete) {\r\n                image.onload = () => {\r\n                    this.stampGore(params);\r\n                };\r\n                return;\r\n            }\r\n        }\r\n\r\n        if (!image.complete || image.naturalWidth === 0) return;\r\n\r\n        const drawSize = 32 * params.scale;\r\n\r\n        this.ui.decalCtx.drawImage(\r\n            image,\r\n            -drawSize / 2,\r\n            -drawSize / 2,\r\n            drawSize,\r\n            drawSize\r\n        );\r\n\r\n        this.ui.decalCtx.restore();\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Baking ]\r\n    //\r\n    // TODO: Implement dynamic -> static decal baking as performance requires\r\n    /**\r\n     * Bake all current dynamic decals into static ImageData and clear the dynamic map.\r\n     * This merges all decals into a single pixel buffer that gets composited once per frame.\r\n     */\r\n    private bakeDecals(): void {\r\n        if (!this.ui.decalCtx) return;\r\n\r\n        // Capture current decal canvas state as ImageData\r\n        const currentBaked = this.ui.decalCtx.getImageData(0, 0, WORLD.WIDTH, WORLD.HEIGHT);\r\n\r\n        if (!this.staticDecalData) {\r\n            // First bake - just store it\r\n            this.staticDecalData = currentBaked;\r\n        } else {\r\n            // Merge new decals with existing baked data\r\n            for (let i = 0; i < currentBaked.data.length; i += 4) {\r\n                const alpha = currentBaked.data[i + 3];\r\n                if (alpha > 0) {\r\n                    // Composite new pixel over old (simple alpha blend)\r\n                    const newAlpha = alpha / 255;\r\n                    const oldAlpha = this.staticDecalData.data[i + 3] / 255;\r\n\r\n                    this.staticDecalData.data[i] = currentBaked.data[i] * newAlpha + this.staticDecalData.data[i] * oldAlpha * (1 - newAlpha);\r\n                    this.staticDecalData.data[i + 1] = currentBaked.data[i + 1] * newAlpha + this.staticDecalData.data[i + 1] * oldAlpha * (1 - newAlpha);\r\n                    this.staticDecalData.data[i + 2] = currentBaked.data[i + 2] * newAlpha + this.staticDecalData.data[i + 2] * oldAlpha * (1 - newAlpha);\r\n                    this.staticDecalData.data[i + 3] = Math.min(255, alpha + this.staticDecalData.data[i + 3]);\r\n                }\r\n            }\r\n        }\r\n\r\n        // Clear dynamic decals\r\n        this.dynamicDecals.clear();\r\n        this.ui.decalCtx.clearRect(0, 0, WORLD.WIDTH, WORLD.HEIGHT);\r\n    }\r\n\r\n    /**\r\n     * Render baked decals to the decal canvas (call at start of frame, before dynamic decals)\r\n     */\r\n    private renderBakedDecals(): void {\r\n        if (!this.staticDecalData || !this.ui.decalCtx) return;\r\n        this.ui.decalCtx.putImageData(this.staticDecalData, 0, 0);\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Weapon Magazine ]\r\n    //\r\n    /**\r\n     * Spawns weapon magazine using createDecal function, also being broadcast over the network.\r\n     */\r\n    public spawnMagazineDecal(): void {\r\n        setTimeout(() => {\r\n            const currentAmmo = this.playerState.myPlayer.actions.primary.magazine.currentAmmo;\r\n            const currentWeapon = this.playerState.myPlayer.inventory.primary;\r\n\r\n            // Choose magazine sprite: empty if 0 ammo, full if > 0\r\n            const magazineSrc = currentAmmo > 0\r\n                ? this.charConfig.magazine[currentWeapon].full\r\n                : this.charConfig.magazine[currentWeapon].empty;\r\n\r\n            // Random position in small radius around player (WORLD coordinates)\r\n            const angle = this.utility.getRandomNum(0, Math.PI * 2);\r\n            const distance = this.utility.getRandomNum(8, 24);\r\n\r\n            const x = this.playerState.myPlayer.transform.pos.x + Math.cos(angle) * distance;\r\n            const y = this.playerState.myPlayer.transform.pos.y + Math.sin(angle) * distance;\r\n            const rotation = this.utility.getRandomNum(0, Math.PI * 2);\r\n            const scale = this.utility.getRandomNum(0.65, 0.75);\r\n\r\n            const decalId = `magazine_${this.userId}_${Date.now()}`;\r\n\r\n            const decalParams: DecalParams = {\r\n                id: decalId,\r\n                pos: { x, y }, // World coordinates\r\n                type: 'image',\r\n                image: {\r\n                    src: magazineSrc,\r\n                    scale: scale,\r\n                    rotation: rotation\r\n                }\r\n            };\r\n            this.createDecal(decalParams);\r\n\r\n            console.log(`Spawned ${currentAmmo > 0 ? 'full' : 'empty'} magazine at reload`);\r\n        }, 150);\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { GAMEPAD_MAP } from \"./Config\";\r\nimport { AudioMixerName } from \"./Types\";\r\n\r\nimport { Animator } from \"./Animator\";\r\nimport { Camera } from \"./Camera\";\r\nimport { ControlsManager } from \"./ControlsManager\";\r\nimport { GameState } from \"./GameState\";\r\nimport { RoomController } from \"./RoomController\";\r\nimport { SettingsManager } from \"./SettingsManager\";\r\nimport { UserInterface } from \"./UserInterface\";\r\n\r\nimport { AudioManager } from \"./audio/AudioManager\";\r\n\r\nimport { ChatManager } from \"./chat/ChatManager\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\n\r\nexport class EventsManager {\r\n    constructor(\r\n        private animator: Animator,\r\n        private audioManager: AudioManager,\r\n        private camera: Camera,\r\n        private chatManager: ChatManager,\r\n        private controlsManager: ControlsManager,\r\n        private gameState: GameState,\r\n        private roomController: RoomController,\r\n        private playerState: PlayerState,\r\n        private settingsManager: SettingsManager,\r\n        private ui: UserInterface,\r\n        private userId: string\r\n    ) { }\r\n\r\n    // #region [ Events ]\r\n    //\r\n    /**\r\n     * Initializes all event listeners to the required DOM elements.\r\n     */\r\n    public initEventListeners(): void {\r\n        if (!this.ui.canvas || !this.ui.hostButton || !this.ui.joinButton || !this.ui.quickplayButton ||\r\n            !this.ui.lobbyLeaveButton || !this.ui.lobbyCodeButton || !this.ui.gameLeaveButton ||\r\n            !this.ui.gameCodeButton || !this.ui.startGameBtn || !this.ui.chatSendBtn || !this.ui.chatInput) return;\r\n\r\n        this.ui.hostButton.addEventListener(\"click\", () => this.roomController.hostRoom());\r\n        this.ui.joinButton.addEventListener(\"click\", () => this.roomController.joinRoom());\r\n        this.ui.quickplayButton.addEventListener(\"click\", () => this.roomController.quickPlay());\r\n        this.ui.lobbyLeaveButton.addEventListener(\"click\", () => this.roomController.leaveRoom());\r\n        this.ui.lobbyCodeButton.addEventListener(\"click\", () => this.roomController.copyRoomCode());\r\n        this.ui.gameLeaveButton.addEventListener(\"click\", () => this.roomController.leaveRoom());\r\n        this.ui.gameCodeButton.addEventListener(\"click\", () => this.roomController.copyRoomCode());\r\n        this.ui.startGameBtn.addEventListener(\"click\", () => this.onStartButtonClick());\r\n\r\n        // [ Chat ]\r\n        this.ui.chatSendBtn.addEventListener(\"click\", () => this.chatManager.sendChatMessage(this.userId));\r\n        this.ui.chatInput.addEventListener(\"keypress\", (e) => {\r\n            if (e.key === \"Enter\" && !e.shiftKey) {\r\n                e.preventDefault();\r\n                this.chatManager.sendChatMessage(this.userId);\r\n            }\r\n        });\r\n        this.ui.chatInput.addEventListener(\"focus\", () => {\r\n            this.controlsManager.clearActiveKeys();\r\n\r\n            this.playerState.canShoot = false;\r\n            this.playerState.isSprinting = false;\r\n            this.playerState.isDashing = false;\r\n            this.playerState.isBurstActive = false;\r\n            this.playerState.currentBurstShot = 0;\r\n        });\r\n\r\n        this.ui.chatInput.addEventListener(\"blur\", () => {\r\n            this.controlsManager.clearActiveKeys();\r\n\r\n            this.playerState.canShoot = true;\r\n            this.playerState.isSprinting = false;\r\n            this.playerState.isDashing = false;\r\n        });\r\n\r\n        this.ui.settingsButton?.addEventListener('click', () => {\r\n            this.ui.showSettingsPage();\r\n        });\r\n\r\n        this.ui.settingsCloseButton?.addEventListener('click', () => {\r\n            this.ui.hideSettingsPage();\r\n        })\r\n\r\n        // Prevent right-click context menu on the entire window\r\n        window.addEventListener('contextmenu', (e) => {\r\n            e.preventDefault();\r\n        });\r\n\r\n        // Listen on document for events, not canvas.\r\n        // If this presents issues, swap \"document.\" with \"this.interface.canvas\"\r\n        document.addEventListener('keydown', (e) => this.onKeyDown(e));\r\n        document.addEventListener('keyup', (e) => this.onKeyUp(e));\r\n\r\n        document.addEventListener('mouseup', (e) => this.onMouseUp(e));\r\n        document.addEventListener('mousemove', (e) => this.onMouseMove(e));\r\n\r\n        this.ui.canvas.addEventListener('mousedown', (e) => this.onMouseDown(e)); // Canvas only listening for mouse (shooting mainly)\r\n\r\n        this.ui.switchSettingsPage('sound'); // Init settings page to sound tab on dom load\r\n\r\n        this.ui.controlsTab?.addEventListener('click', () => {\r\n            this.ui.switchSettingsPage('controls');\r\n        });\r\n\r\n        this.ui.graphicsTab?.addEventListener('click', () => {\r\n            this.ui.switchSettingsPage('graphics');\r\n        });\r\n\r\n        this.ui.soundTab?.addEventListener('click', () => {\r\n            this.ui.switchSettingsPage('sound');\r\n        });\r\n\r\n        // Settings page click to open when hidden\r\n        this.ui.controlsBody?.addEventListener('click', () => {\r\n            if (this.ui.controlsBody?.classList.contains('settings_page_hidden')) {\r\n                this.ui.switchSettingsPage('controls');\r\n            }\r\n        });\r\n\r\n        this.ui.graphicsBody?.addEventListener('click', () => {\r\n            if (this.ui.graphicsBody?.classList.contains('settings_page_hidden')) {\r\n                this.ui.switchSettingsPage('graphics');\r\n            }\r\n        });\r\n\r\n        this.ui.soundBody?.addEventListener('click', () => {\r\n            if (this.ui.soundBody?.classList.contains('settings_page_hidden')) {\r\n                this.ui.switchSettingsPage('sound');\r\n            }\r\n        });\r\n\r\n        this.initSettingsAudioSliders();\r\n        this.initSettingsInputListeners();\r\n        this.initSettingsToggleListeners();\r\n    }\r\n\r\n    /**\r\n     * Handles all key press events.\r\n     */\r\n    private onKeyDown(e: KeyboardEvent): void {\r\n        if (this.ui.chatInput === document.activeElement) return;\r\n        if (!this.gameState.gameInProgress || this.gameState.isPaused) return;\r\n\r\n        const key = e.key.toLowerCase();\r\n        const keybinds = this.settingsManager.getSettings().controls.keybinds;\r\n\r\n        const isGameKey = Object.values(keybinds).includes(key);\r\n        if (!isGameKey) return;\r\n\r\n        e.preventDefault();\r\n        this.controlsManager.addKey(key);\r\n    }\r\n\r\n    /**\r\n     * Handles all key release events.\r\n     */\r\n    private onKeyUp(e: KeyboardEvent): void {\r\n        if (this.ui.chatInput === document.activeElement) return;\r\n        if (!this.gameState.gameInProgress) return;\r\n\r\n        const key = e.key.toLowerCase();\r\n        const keybinds = this.settingsManager.getSettings().controls.keybinds;\r\n\r\n        if (!Object.values(keybinds).includes(key)) return;\r\n\r\n        e.preventDefault();\r\n        this.controlsManager.removeKey(key);\r\n    }\r\n\r\n    /**\r\n     * Handles all mouse click events.\r\n     */\r\n    private onMouseDown(e: MouseEvent): void {\r\n        if (this.ui.chatInput === document.activeElement) return;\r\n        if (!this.gameState.gameInProgress || this.gameState.isPaused || !this.ui.canvas) return;\r\n\r\n        if (e.button === 0) {\r\n            this.updateMouse(e);\r\n            this.controlsManager.addKey('mouse1'); // Left Click\r\n        } else if (e.button === 1) {\r\n            this.controlsManager.addKey('mouse3'); // Middle Click\r\n        } else if (e.button === 2) {\r\n            this.updateMouse(e);\r\n            this.controlsManager.addKey('mouse2'); // Right Click\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles all mouse release events.\r\n     */\r\n    private onMouseUp(e: MouseEvent): void {\r\n        if (this.ui.chatInput === document.activeElement) return;\r\n        if (!this.gameState.gameInProgress) return;\r\n\r\n        if (e.button === 0) {\r\n            this.controlsManager.removeKey('mouse1'); // Left Click\r\n        } else if (e.button === 1) {\r\n            this.controlsManager.addKey('mouse3'); // Middle Click\r\n        } else if (e.button === 2) {\r\n            this.controlsManager.removeKey('mouse2'); // Right Click\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles all mouse movement events.\r\n     */\r\n    private onMouseMove(e: MouseEvent): void {\r\n        if (this.ui.chatInput === document.activeElement) return;\r\n        if (!this.gameState.gameInProgress || this.gameState.isPaused) return;\r\n\r\n        this.updateMouse(e);\r\n        const mousePos = this.controlsManager.getMousePos();\r\n\r\n        // Convert mouse screen position to world position\r\n        const worldMousePos = this.camera.screenToWorld(mousePos);\r\n\r\n        // Calculate distance from player\r\n        const dx = worldMousePos.x - this.playerState.myPlayer.transform.pos.x;\r\n        const dy = worldMousePos.y - this.playerState.myPlayer.transform.pos.y;\r\n        const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n        // Calculate target rotation\r\n        const targetRotation = Math.atan2(dy, dx) + Math.PI / 2;\r\n\r\n        // Apply distance-based dampening\r\n        const falloffRadius = 100; // Distance where dampening starts (make this the camera.offset)\r\n        const minIntensity = 0.1; // Minimum rotation speed (10% at player center)\r\n\r\n        let intensity = 1.0;\r\n        if (distance < falloffRadius) {\r\n            // Smooth falloff: 100% at edge  15% at center\r\n            intensity = minIntensity + (1 - minIntensity) * (distance / falloffRadius);\r\n        }\r\n\r\n        // Get current rotation\r\n        const currentRotation = this.playerState.myPlayer.transform.rot;\r\n\r\n        // Lerp between current and target based on intensity\r\n        const newRotation = currentRotation + (targetRotation - currentRotation) * intensity;\r\n\r\n        // Rotate my character\r\n        this.animator.rotateCharacterPart(this.userId, newRotation);\r\n    }\r\n\r\n    /**\r\n     * Processes mouse position and updates.\r\n     */\r\n    private updateMouse(e: MouseEvent): void {\r\n        if (this.ui.chatInput === document.activeElement) return;\r\n        if (!this.ui.canvas) return;\r\n\r\n        const rect = this.ui.canvas.getBoundingClientRect();\r\n        const x = e.clientX - rect.left;\r\n        const y = e.clientY - rect.top;\r\n\r\n        this.controlsManager.setMousePos({ x, y });\r\n    }\r\n\r\n    /**\r\n     * Called when the Start Game button is pressed.\r\n     */\r\n    private onStartButtonClick(): void {\r\n        const event = new CustomEvent(\"customEvent_startGame\");\r\n        window.dispatchEvent(event);\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Settings Page ]\r\n    //\r\n    /**\r\n     * Initializes event listeners for audio sliders on audio settings page.\r\n     */\r\n    private initSettingsAudioSliders(): void {\r\n        const sliders: {\r\n            slider: HTMLDivElement | null;\r\n            fill: HTMLDivElement | null;\r\n            value: HTMLDivElement | null;\r\n            channel: AudioMixerName;\r\n        }[] = [\r\n                { slider: this.ui.masterSlider, fill: this.ui.masterFill, value: this.ui.masterValue, channel: 'master' },\r\n                { slider: this.ui.ambienceSlider, fill: this.ui.ambienceFill, value: this.ui.ambienceValue, channel: 'ambience' },\r\n                { slider: this.ui.musicSlider, fill: this.ui.musicFill, value: this.ui.musicValue, channel: 'music' },\r\n                { slider: this.ui.sfxSlider, fill: this.ui.sfxFill, value: this.ui.sfxValue, channel: 'sfx' },\r\n                { slider: this.ui.voiceSlider, fill: this.ui.voiceFill, value: this.ui.voiceValue, channel: 'voice' }\r\n            ];\r\n\r\n        sliders.forEach(({ slider, fill, value, channel }) => {\r\n            if (!slider || !fill || !value) return;\r\n\r\n            slider.addEventListener('mousedown', (e) => {\r\n                const handleMove = (moveEvent: MouseEvent) => {\r\n                    const sliderValue = this.ui.calculateSliderValue(slider, moveEvent.clientX);\r\n                    this.ui.updateSettingsSlider(fill, value, sliderValue);\r\n\r\n                    this.settingsManager.updateSettings({\r\n                        audio: {\r\n                            mixer: {\r\n                                [channel]: {\r\n                                    ...this.settingsManager.getSettings().audio.mixer[channel],\r\n                                    volume: sliderValue\r\n                                }\r\n                            }\r\n                        }\r\n                    });\r\n                };\r\n\r\n                const handleUp = () => {\r\n                    document.removeEventListener('mousemove', handleMove);\r\n                    document.removeEventListener('mouseup', handleUp);\r\n\r\n                    this.audioManager.updateMixerGains();\r\n                };\r\n\r\n                handleMove(e);\r\n                document.addEventListener('mousemove', handleMove);\r\n                document.addEventListener('mouseup', handleUp);\r\n                e.preventDefault();\r\n            });\r\n        });\r\n    }\r\n\r\n\r\n    /**\r\n     * Initializes event listeners for input fields on all settings pages.\r\n     */\r\n    private initSettingsInputListeners(): void {\r\n        const inputs = [\r\n            { input: this.ui.deadzoneInput, settingPath: 'controls.gamepad.deadzone', parse: parseFloat }\r\n            // Future inputs go here: { input: this.ui.someInput, settingPath: 'path.to.setting', parse: parseFloat }\r\n        ];\r\n\r\n        inputs.forEach(({ input, settingPath, parse }) => {\r\n            if (!input) return;\r\n\r\n            input.addEventListener('change', () => {\r\n                const rawValue = input.value;\r\n                const parsedValue = parse(rawValue);\r\n\r\n                if (isNaN(parsedValue)) return; // Invalid input\r\n\r\n                // Build nested update object\r\n                const pathParts = settingPath.split('.');\r\n                const update: any = {};\r\n                let current = update;\r\n\r\n                for (let i = 0; i < pathParts.length - 1; i++) {\r\n                    current[pathParts[i]] = {};\r\n                    current = current[pathParts[i]];\r\n                }\r\n                current[pathParts[pathParts.length - 1]] = parsedValue;\r\n\r\n                this.settingsManager.updateSettings(update);\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initializes event listeners for toggles on all settings pages.\r\n     */\r\n    private initSettingsToggleListeners(): void {\r\n        const toggles = [\r\n            { toggle: this.ui.particleJSToggle, settingPath: 'graphics.renderBackgroundParticles' },\r\n            { toggle: this.ui.staticVfxToggle, settingPath: 'graphics.showStaticOverlay' },\r\n            { toggle: this.ui.ammoReservesPhysicsToggle, settingPath: 'graphics.physics.ammoReserves' }\r\n        ];\r\n\r\n        toggles.forEach(({ toggle, settingPath }) => {\r\n            if (!toggle) return;\r\n\r\n            toggle.addEventListener('click', () => {\r\n                const currentValue = toggle.getAttribute('aria-checked') === 'true';\r\n                const newValue = !currentValue;\r\n\r\n                // Update toggle visually\r\n                if (newValue) {\r\n                    toggle.setAttribute('checked', 'true');\r\n                    toggle.setAttribute('aria-checked', 'true');\r\n                } else {\r\n                    toggle.removeAttribute('checked');\r\n                    toggle.setAttribute('aria-checked', 'false');\r\n                }\r\n\r\n                // Build nested update object\r\n                const pathParts = settingPath.split('.');\r\n                const update: any = {};\r\n                let current = update;\r\n\r\n                for (let i = 0; i < pathParts.length - 1; i++) {\r\n                    current[pathParts[i]] = {};\r\n                    current = current[pathParts[i]];\r\n                }\r\n                current[pathParts[pathParts.length - 1]] = newValue;\r\n\r\n                this.settingsManager.updateSettings(update);\r\n            });\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Initializes the keybinds interface, with user prefs or defaults.\r\n     * \r\n     * Also sets up keybind change listeners.\r\n     */\r\n    public initKeybindListeners(): void {\r\n        const controlsSettings = this.settingsManager.getSettings().controls;\r\n        this.ui.initKeybindsInterface(\r\n            controlsSettings,\r\n            (action, type, newBinding) => this.onBindingChange(action, type, newBinding)\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Event that fires on keybind or gamepad press when input change modal is visible.\r\n     */\r\n    public onBindingChange(action: string, type: 'keybind' | 'gamepad', newBinding: string | number): void {\r\n        if (type === 'keybind') {\r\n            this.settingsManager.updateSettings({\r\n                controls: {\r\n                    keybinds: {\r\n                        [action]: newBinding as string\r\n                    }\r\n                }\r\n            });\r\n\r\n            const element = document.getElementById(`${action}Keybind`);\r\n            if (element) {\r\n                element.textContent = newBinding === ' ' ? 'SPACE' : (newBinding as string).toUpperCase();\r\n            }\r\n        } else {\r\n            this.settingsManager.updateSettings({\r\n                controls: {\r\n                    gamepad: {\r\n                        [action]: newBinding as number\r\n                    }\r\n                }\r\n            });\r\n\r\n            const element = document.getElementById(`${action}Gamepad`);\r\n            if (element) {\r\n                const buttonName = Object.keys(GAMEPAD_MAP).find(\r\n                    key => typeof GAMEPAD_MAP[key as keyof typeof GAMEPAD_MAP] === 'number'\r\n                        && GAMEPAD_MAP[key as keyof typeof GAMEPAD_MAP] === newBinding\r\n                );\r\n                element.textContent = buttonName || newBinding.toString();\r\n            }\r\n        }\r\n    }\r\n}","import { GAME } from \"./Config\";\r\n\r\nexport class GameState {\r\n    /**\r\n     * Tracks paused state of the application.\r\n     */\r\n    public isPaused = false;\r\n\r\n    /**\r\n     * Becomes true when game loop starts.\r\n     * \r\n     * False when game loop is no longer ongoing (end game, websocket disconnect, leave room)\r\n     */\r\n    public gameInProgress = false;\r\n\r\n    /**\r\n     * Max wins needed for session to end.\r\n     */\r\n    public gameMaxWins = GAME.MAX_WINS;\r\n\r\n    /**\r\n     * Max players allowed in a game.\r\n     */\r\n    public gameMaxPlayers = GAME.MAX_PLAYERS;\r\n\r\n    constructor() {}\r\n\r\n    public clear(): void {\r\n        this.gameInProgress = false;\r\n        this.isPaused = false;\r\n\r\n        this.gameMaxWins = GAME.MAX_WINS;\r\n        this.gameMaxPlayers = GAME.MAX_PLAYERS;\r\n    }\r\n}","import { LobbyControlsParams, LobbyOptionsParams, LobbyPlayer, SetInputParams, SetToggleParams } from \"./Types\";\r\n\r\nimport { CharacterManager } from \"./CharacterManager\";\r\nimport { RoomManager } from \"./RoomManager\";\r\nimport { SettingsManager } from \"./SettingsManager\";\r\nimport { UserInterface } from \"./UserInterface\";\r\nimport { Utility } from \"./Utility\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\nimport { PlayerConfig } from \"./player/PlayerConfig\";\r\n\r\nexport class LobbyManager {\r\n    public inLobby = false;\r\n    public lobbyPlayers: Map<string, LobbyPlayer> = new Map(); // Temporary partial player object used for lobby only information\r\n    private charCustomizeHandlers: Array<{ element: HTMLElement, handler: () => void }> = []; // Event handlers for lobby customization arrows\r\n\r\n    constructor(\r\n        private characterManager: CharacterManager,\r\n        private playerConfig: PlayerConfig,\r\n        private playerState: PlayerState,\r\n        private roomManager: RoomManager,\r\n        private settingsManager: SettingsManager,\r\n        private ui: UserInterface,\r\n        private utility: Utility\r\n    ) { }\r\n\r\n    // #region [ Lobby Controls ]\r\n    //\r\n    /**\r\n     * Calls updateDisplay to show the lobby specific controls.\r\n     */\r\n    public showLobbyControls(params: LobbyControlsParams): void {\r\n        const { lobby, lobbyOptions, myPlayer, roomId, userId } = params;\r\n        const { isHost, maxWins, privateRoom, upgradesEnabled } = lobbyOptions;\r\n\r\n        this.ui.updateDisplay(lobby, \"lobby\", roomId);\r\n\r\n        const centerX = this.ui.charCustomizeCanvas ? this.ui.charCustomizeCanvas.width / 2 : 0;\r\n        const centerY = this.ui.charCustomizeCanvas ? this.ui.charCustomizeCanvas.height / 2 : 0;\r\n\r\n        // Add myself to lobby\r\n        this.lobbyPlayers.set(userId, {\r\n            id: userId,\r\n            color: myPlayer.color,\r\n            isHost: isHost,\r\n            rig: this.settingsManager.getSettings().character.rig,\r\n            transform: {\r\n                pos: { x: centerX, y: centerY },\r\n                rot: 0\r\n            }\r\n        });\r\n\r\n        // Setup lobby inputs/toggles using nested options\r\n        this.setupLobbyOptions(lobbyOptions);\r\n\r\n        const winsInputParams: SetInputParams = {\r\n            inputId: \"winsInput\",\r\n            value: maxWins\r\n        };\r\n        const privateToggleParams: SetToggleParams = {\r\n            toggleId: \"privateToggle\",\r\n            value: privateRoom\r\n        };\r\n        const upgradesToggleParams: SetToggleParams = {\r\n            toggleId: \"upgradesToggle\",\r\n            value: upgradesEnabled\r\n        };\r\n\r\n        this.utility.setToggle(privateToggleParams);\r\n        this.utility.setToggle(upgradesToggleParams);\r\n        this.utility.setInput(winsInputParams);\r\n\r\n        this.ui.displayLobbyPlayers(isHost, lobby, userId);\r\n        this.ui.updateHostDisplay(isHost, lobby);\r\n\r\n        window.dispatchEvent(new CustomEvent(\"customEvent_renderCharacter\"));\r\n        this.setupCharacterCustomization();\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Lobby Options ]\r\n    //\r\n    /**\r\n     * Sets up lobby toggles and input for game settings.\r\n     */\r\n    public setupLobbyOptions(params: LobbyOptionsParams): void {\r\n        this.setupLobbyToggle('privateToggle', params.isHost, 'privateRoom', () => params.privateRoom, (val) => params.privateRoom = val);\r\n        this.setupLobbyToggle('upgradesToggle', params.isHost, 'upgradesEnabled', () => params.upgradesEnabled, (val) => params.upgradesEnabled = val);\r\n        this.setupLobbyInput('winsInput', params.isHost, 'maxWins', () => params.maxWins, (val) => params.maxWins = val);\r\n        this.setupLobbyInput('playersInput', params.isHost, 'maxPlayers', () => params.maxPlayers, (val) => params.maxPlayers = val);\r\n    }\r\n\r\n    /**\r\n     * Called by setupLobbyOptions - Responsible for toggles.\r\n     */\r\n    private setupLobbyToggle(elementProp: 'privateToggle' | 'upgradesToggle', isHost: boolean, messageKey: string, getter: () => boolean, setter: (val: boolean) => void): void {\r\n        const element = this.ui[elementProp];\r\n        if (!element) return;\r\n\r\n        // Store the handler so we can remove it later\r\n        const handlerKey = `${elementProp}Handler` as keyof this;\r\n\r\n        // Remove existing listener if it exists\r\n        if (this[handlerKey]) {\r\n            element.removeEventListener('click', this[handlerKey] as EventListener);\r\n        }\r\n\r\n        // Create and store the new handler\r\n        const handler = () => {\r\n            if (!isHost) return;\r\n\r\n            const newValue = !getter();\r\n            setter(newValue);\r\n\r\n            const toggleParams: SetToggleParams = {\r\n                toggleId: elementProp,\r\n                value: newValue\r\n            }\r\n            this.utility.setToggle(toggleParams);\r\n\r\n            this.roomManager.sendMessage(JSON.stringify({\r\n                type: 'lobby-options',\r\n                [messageKey]: newValue\r\n            }));\r\n\r\n            console.log(`${messageKey} changed to: ${newValue}`);\r\n        };\r\n\r\n        // Store handler for later removal & add listener\r\n        (this as any)[handlerKey] = handler;\r\n        element.addEventListener('click', handler);\r\n    }\r\n\r\n    /**\r\n     * Called by setupLobbyOptions - Responsible for input fields.\r\n     */\r\n    private setupLobbyInput(elementProp: 'winsInput' | 'playersInput', isHost: boolean, messageKey: string, getter: () => number, setter: (val: number) => void): void {\r\n        const element = this.ui[elementProp];\r\n        if (!element) return;\r\n\r\n        // Store the handler so we can remove it later\r\n        const handlerKey = `${elementProp}Handler` as keyof this;\r\n\r\n        // Remove existing listener if it exists\r\n        if (this[handlerKey]) {\r\n            element.removeEventListener('change', this[handlerKey] as EventListener);\r\n        }\r\n\r\n        // Create and store the new handler\r\n        const handler = () => {\r\n            if (!isHost) return;\r\n\r\n            const newValue = parseInt(element.value);\r\n            if (isNaN(newValue) || newValue < 1) {\r\n                element.value = getter().toString();\r\n                return;\r\n            }\r\n\r\n            setter(newValue);\r\n\r\n            const inputParams: SetInputParams = {\r\n                inputId: elementProp,\r\n                value: newValue\r\n            }\r\n            this.utility.setInput(inputParams);\r\n\r\n            this.roomManager.sendMessage(JSON.stringify({\r\n                type: 'lobby-options',\r\n                [messageKey]: newValue\r\n            }));\r\n\r\n            console.log(`${messageKey} changed to: ${newValue}`);\r\n        };\r\n\r\n        // Store handler for later removal & setup listener\r\n        (this as any)[handlerKey] = handler;\r\n        element.addEventListener('change', handler);\r\n    }\r\n\r\n    /**\r\n     * Syncs lobby options when state change messages are received over websocket.\r\n     */\r\n    public syncLobbyOptions(options: any): void {\r\n        this.syncOption(options, 'privateRoom', 'isPrivateRoom', 'privateToggle', this.utility.setToggle.bind(this.utility), 'Lobby privacy', (v) => v ? 'Private' : 'Public');\r\n        this.syncOption(options, 'maxWins', 'gameMaxWins', 'winsInput', this.utility.setInput.bind(this.utility), 'Game max wins');\r\n        this.syncOption(options, 'maxPlayers', 'gameMaxPlayers', 'playersInput', this.utility.setInput.bind(this.utility), 'Game max players');\r\n        this.syncOption(options, 'upgradesEnabled', 'isUpgradesEnabled', 'upgradesToggle', this.utility.setToggle.bind(this.utility), 'Game upgrades toggled');\r\n    }\r\n\r\n    /**\r\n     * [DO NOT CALL] Syncs a lobby option - called by syncLobbyOptions.\r\n     */\r\n    private syncOption<T extends SetInputParams | SetToggleParams>(options: any, key: string, prop: string, elementId: string, fn: (params: T) => void, label: string, format?: (v: any) => string): void {\r\n        if (options[key] === undefined) return;\r\n\r\n        (this as any)[prop] = options[key];\r\n\r\n        // Build params object based on element type\r\n        const params = elementId.includes('Input')\r\n            ? { inputId: elementId, value: options[key] } as T\r\n            : { toggleId: elementId, value: options[key] } as T;\r\n\r\n        fn(params);\r\n\r\n        const displayValue = format ? format(options[key]) : options[key];\r\n        console.log(`${label} synced to: ${displayValue}`);\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Lobby Player Management ]\r\n    //\r\n    /**\r\n     * Promote specific player to host.\r\n     */\r\n    public promotePlayer(playerId: string): void {\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'promote-player',\r\n            targetPlayerId: playerId\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Kick specific  player from the current lobby.\r\n     */\r\n    public kickPlayer(playerId: string): void {\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'kick-player',\r\n            targetPlayerId: playerId\r\n        }));\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Char Customization ]\r\n    //\r\n    /**\r\n     * Initializes the lobby character customization menu buttons.\r\n     */\r\n    public setupCharacterCustomization(): void {\r\n        if (!this.ui.bodyArrowLeft || !this.ui.bodyArrowRight ||\r\n            !this.ui.headArrowLeft || !this.ui.headArrowRight ||\r\n            !this.ui.headwearArrowLeft || !this.ui.headwearArrowRight) return;\r\n\r\n        const myLobbyPlayer = this.lobbyPlayers.get(this.playerState.myPlayer.id);\r\n        if (!myLobbyPlayer) return;\r\n\r\n        // Remove all old listeners\r\n        this.charCustomizeHandlers.forEach(({ element, handler }) => {\r\n            element.removeEventListener('click', handler);\r\n        });\r\n        this.charCustomizeHandlers = [];\r\n\r\n        // Helper to add and track listeners\r\n        const addHandler = (element: HTMLElement, handler: () => void) => {\r\n            this.charCustomizeHandlers.push({ element, handler });\r\n            element.addEventListener('click', handler);\r\n        };\r\n\r\n        // Body arrows\r\n        addHandler(this.ui.bodyArrowLeft, () => this.cycleRigVariant('body', -1));\r\n        addHandler(this.ui.bodyArrowRight, () => this.cycleRigVariant('body', 1));\r\n\r\n        // Head arrows\r\n        addHandler(this.ui.headArrowLeft, () => this.cycleRigVariant('head', -1));\r\n        addHandler(this.ui.headArrowRight, () => this.cycleRigVariant('head', 1));\r\n\r\n        // Headwear arrows\r\n        addHandler(this.ui.headwearArrowLeft, () => this.cycleRigVariant('headwear', -1));\r\n        addHandler(this.ui.headwearArrowRight, () => this.cycleRigVariant('headwear', 1));\r\n    }\r\n\r\n    /**\r\n     * Responsible for swapping layers in the character customizer. Arrow buttons call this, via event handlers.\r\n     */\r\n    private cycleRigVariant(rigProp: 'body' | 'head' | 'headwear' | 'weapon', direction: number): void {\r\n        const myLobbyPlayer = this.lobbyPlayers.get(this.playerState.myPlayer.id);\r\n        if (!myLobbyPlayer) return;\r\n\r\n        // Get all variants for this layer\r\n        const allVariants = Object.keys(this.characterManager['charConfig'][rigProp]);\r\n\r\n        // Find current index\r\n        const currentVariant = myLobbyPlayer.rig[rigProp];\r\n        const currentIndex = allVariants.indexOf(currentVariant);\r\n\r\n        // Calculate new index (with wrapping)\r\n        let newIndex = currentIndex + direction;\r\n        if (newIndex < 0) {\r\n            newIndex = allVariants.length - 1; // Wrap to last\r\n        } else if (newIndex >= allVariants.length) {\r\n            newIndex = 0; // Wrap to first\r\n        }\r\n\r\n        // Update the rig\r\n        myLobbyPlayer.rig[rigProp] = allVariants[newIndex];\r\n\r\n        this.settingsManager.updateSettings({\r\n            character: { rig: myLobbyPlayer.rig }\r\n        });\r\n\r\n        window.dispatchEvent(new CustomEvent(\"customEvent_renderCharacter\"));\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { GAME } from \"./Config\";\r\nimport { AmmoBox, GameObject, SpawnObjectParams } from \"./Types\";\r\n\r\nimport { Utility } from \"./Utility\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\n\r\nexport class ObjectsManager {\r\n    public ammoBoxes: Map<string, AmmoBox> = new Map();\r\n\r\n    constructor(private playerState: PlayerState, private utility: Utility) {}\r\n\r\n    /**\r\n     * Clears all game objects from internal memory.\r\n     */\r\n    public clear(): void {\r\n        this.ammoBoxes.clear();\r\n    }\r\n\r\n    // #region [ Objects ]\r\n    //\r\n    /**\r\n     * Spawns a GameObject in the scene, returning it's properties for the construction.\r\n     */\r\n    private spawnObject(params: SpawnObjectParams): GameObject {\r\n        const baseObject: GameObject = {\r\n            id: this.utility.generateUID(GAME.DATA.ID_LENGTH),\r\n            transform: params.transform,\r\n            timestamp: Date.now()\r\n        };\r\n\r\n        switch (params.type) { //TODO: Spawn the player, projectiles and any other GameObject types here\r\n            case 'AmmoBox':\r\n                return {\r\n                    id: baseObject.id,\r\n                    transform: baseObject.transform,\r\n                    timestamp: baseObject.timestamp,\r\n                    ammoAmount: params.data?.amount || 10,\r\n                    isOpen: false,\r\n                    lid: {\r\n                        pos: { x: 0, y: 0 },\r\n                        rot: 0,\r\n                        velocity: { x: 0, y: 0 },\r\n                        torque: 0\r\n                    }\r\n                } as AmmoBox;\r\n\r\n            default:\r\n                throw new Error(`Unknown object type: ${params.type}`);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Constructs an ammo box and returns the spawned object instantiated through spawnObject.\r\n     */\r\n    public spawnAmmoBox(amount: number): AmmoBox {\r\n        return this.spawnObject({\r\n            type: 'AmmoBox',\r\n            transform: {\r\n                pos: {\r\n                    x: this.playerState.myPlayer.transform.pos.x,\r\n                    y: this.playerState.myPlayer.transform.pos.y\r\n                },\r\n                rot: this.playerState.myPlayer.transform.rot\r\n            },\r\n            data: { amount }\r\n        }) as AmmoBox;\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { AMMO_BOX, VIEWPORT, GAME, UI, WORLD } from \"./Config\";\r\nimport { CharacterLayer, DamageEntity, RenderCharacterParams } from \"./Types\";\r\n\r\nimport { Animator } from \"./Animator\";\r\nimport { CharacterManager } from \"./CharacterManager\";\r\nimport { ObjectsManager } from \"./ObjectsManager\";\r\nimport { UserInterface } from \"./UserInterface\";\r\nimport { LobbyManager } from \"./LobbyManager\";\r\nimport { PlayerConfig } from \"./player/PlayerConfig\";\r\nimport { Camera } from \"./Camera\";\r\n\r\nexport class RenderingManager {\r\n    public characterImages: Map<string, HTMLImageElement> = new Map();\r\n    public ammoBoxImages: { [layer: string]: HTMLImageElement } = {};\r\n\r\n    constructor(\r\n        private animator: Animator,\r\n        private camera: Camera,\r\n        private charManager: CharacterManager,\r\n        private lobbyManager: LobbyManager,\r\n        private objectsManager: ObjectsManager,\r\n        private playerConfig: PlayerConfig,\r\n        private ui: UserInterface,\r\n        private userId: string,\r\n    ) {\r\n        this.initEventListeners();\r\n    }\r\n\r\n    // #region [ General ]\r\n    //\r\n    /**\r\n     * Clear all canvas rendering context in the game.\r\n     * \r\n     * / OR /\r\n     * \r\n     * Pass the specific CanvasRenderingContext2D to clear.\r\n     */\r\n    public clearCtx(customCtx?: CanvasRenderingContext2D): void {\r\n        if (customCtx) {\r\n            customCtx.clearRect(0, 0, VIEWPORT.WIDTH, VIEWPORT.HEIGHT);\r\n            return;\r\n        }\r\n\r\n        if (!this.ui.decalCtx || !this.ui.ctx) return;\r\n\r\n        this.ui.ctx.clearRect(0, 0, VIEWPORT.WIDTH, VIEWPORT.HEIGHT);\r\n        this.ui.decalCtx.clearRect(0, 0, WORLD.WIDTH, WORLD.HEIGHT);\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Character ]\r\n    //\r\n    /**\r\n     * Draws the corresponding character layers defined in the rig to create the player character.\r\n     */\r\n    public drawCharacter(params: RenderCharacterParams): void {\r\n        const { player, context } = params;\r\n        if (!context || !player) return;\r\n\r\n        if ('stats' in player) {\r\n            if (player.stats.health.value <= 0) return;\r\n            this.renderUniqueEffects(params);\r\n            if (player.flags.hidden) return;\r\n\r\n            if (!this.camera.isVisible(player.transform.pos)) return;\r\n            const screenPos = this.camera.worldToScreen(player.transform.pos);\r\n\r\n            context.fillStyle = UI.TEXT_COLOR;\r\n            context.font = UI.FONT;\r\n            context.textAlign = 'center';\r\n\r\n            const displayName = player.id === this.userId ? 'You' : player.id.substring(0, 6);\r\n            context.fillText(\r\n                displayName,\r\n                screenPos.x,\r\n                screenPos.y - this.playerConfig.default.data.idOffset\r\n            );\r\n        }\r\n\r\n        // Main player\r\n        this.drawCharacterLayers(params);\r\n    }\r\n    \r\n    /**\r\n     * Entrypoint for rendering of all character layers.\r\n     */\r\n    private drawCharacterLayers(params: RenderCharacterParams): void {\r\n        const player = params.player;\r\n        if (!player) return;\r\n\r\n        this.drawCharacterLayer(params, 'body', player.rig.body);\r\n        this.drawCharacterLayer(params, 'weapon', player.rig.weapon);\r\n        this.drawCharacterLayer(params, 'head', player.rig.head);\r\n        this.drawCharacterLayer(params, 'headwear', player.rig.headwear);\r\n\r\n        if ('stats' in player) { this.drawUpgradeLayers(params); }\r\n    }\r\n\r\n    /**\r\n     * Retrieves character assets and draws each layer using drawCharacterPart.\r\n     */\r\n    private drawCharacterLayer(params: RenderCharacterParams, layer: CharacterLayer, variant: string): void {\r\n        if (!params) return;\r\n\r\n        const assets = this.charManager.getCharacterAsset(layer, variant);\r\n\r\n        if (typeof assets === 'string') {\r\n            this.drawCharacterPart(params, assets, layer);\r\n        }\r\n        else if (Array.isArray(assets)) {\r\n            assets.forEach((assetPath, index) => {\r\n                this.drawCharacterPart(params, assetPath, layer, index);\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles the actual rendering for all player parts on each layer.\r\n     */\r\n    private drawCharacterPart(params: RenderCharacterParams, assetPath: string, partType: CharacterLayer, partIndex?: number): void {\r\n        const { context, player } = params;\r\n        if (!context || !player) return;\r\n\r\n        let image = this.characterImages.get(assetPath);\r\n\r\n        if (!image) {\r\n            image = new Image();\r\n            image.src = assetPath;\r\n            this.characterImages.set(assetPath, image);\r\n\r\n            image.onload = () => { this.renderLobbyPlayer(); };\r\n\r\n            if (!image.complete) return;\r\n        }\r\n\r\n        if (!image.complete || image.naturalWidth === 0) return;\r\n\r\n        // Determine draw size based on player type\r\n        const drawSize = 'stats' in player\r\n            ? GAME.CHARACTER_SIZE * (player.stats.size / GAME.CHARACTER_SIZE)\r\n            : GAME.CHARACTER_SIZE * 0.35;\r\n\r\n        // UPDATED: Get world position and convert to screen\r\n        const worldX = player.transform?.pos?.x ?? 0;\r\n        const worldY = player.transform?.pos?.y ?? 0;\r\n\r\n        // Only apply camera offset for full players (not lobby)\r\n        const shouldApplyCamera = 'stats' in player && player.transform.rot !== undefined;\r\n\r\n        const posX = shouldApplyCamera ? this.camera.worldToScreen({ x: worldX, y: worldY }).x : worldX;\r\n        const posY = shouldApplyCamera ? this.camera.worldToScreen({ x: worldX, y: worldY }).y : worldY;\r\n\r\n        context.save();\r\n\r\n        // Only apply rotation and animation for full players\r\n        if (shouldApplyCamera) {\r\n            const animationId = `${player.id}_${partType}_${partIndex || 0}`;\r\n            const animationOffset = this.animator.characterOffsets?.get(animationId) || { x: 0, y: 0 };\r\n\r\n            context.translate(posX, posY);\r\n            context.rotate(player.transform.rot);\r\n            context.translate(animationOffset.x, animationOffset.y);\r\n\r\n            context.drawImage(\r\n                image,\r\n                -drawSize / 2,\r\n                -drawSize / 2,\r\n                drawSize,\r\n                drawSize\r\n            );\r\n        } else {\r\n            // Simple centered draw for lobby players\r\n            context.drawImage(\r\n                image,\r\n                posX - drawSize / 2,\r\n                posY - drawSize / 2,\r\n                drawSize,\r\n                drawSize\r\n            );\r\n        }\r\n\r\n        context.restore();\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Uniques & Upgrades ]\r\n    //\r\n    /**\r\n     * Draws the equipment and unique upgrades that have a character layer visual component.\r\n     */\r\n    private drawUpgradeLayers(params: RenderCharacterParams): void {\r\n        const { player } = params;\r\n\r\n        if ('unique' in player) {\r\n            // Check unique upgrades\r\n            player.unique.forEach(uniqueName => {\r\n                const assetPath = this.charManager.getUpgradeVisual(uniqueName);\r\n                if (assetPath) {\r\n                    this.drawCharacterPart(params, assetPath, 'upgrades');\r\n                }\r\n            });\r\n\r\n            // Check equipment upgrades\r\n            player.equipment.forEach(equipmentName => {\r\n                const assetPath = this.charManager.getUpgradeVisual(equipmentName);\r\n                if (assetPath) {\r\n                    this.drawCharacterPart(params, assetPath, 'upgrades');\r\n                }\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Called in main rendering loop, used to override standard rendering when unique effects temporarily need to.\r\n     */\r\n    private renderUniqueEffects(params: RenderCharacterParams): void {\r\n        const { player } = params;\r\n        if (!player) return;\r\n\r\n        if ('unique' in player) {\r\n            if (player.unique.includes(\"spectral_image\")) {\r\n                this.renderSpectralImage(params);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Renders the chosen player as a spectral image.\r\n     */\r\n    private renderSpectralImage(params: RenderCharacterParams): void {\r\n        const { context, player } = params;\r\n        if (!context || !player || !('stats' in player)) return;\r\n\r\n        // Static ghost memory (attached per instance)\r\n        const staticGhosts = (this as any)._spectralGhosts ??= {\r\n            lastHidden: new Map<string, boolean>(),\r\n            flashes: [] as {\r\n                x: number;\r\n                y: number;\r\n                t: number;\r\n                type: 'start' | 'end';\r\n                playerId: string;\r\n            }[]\r\n        };\r\n\r\n        const now = Date.now();\r\n        const wasHidden = staticGhosts.lastHidden.get(player.id) ?? false;\r\n        const isHidden = player.flags.hidden;\r\n\r\n        // Detect start of dash (flash out)\r\n        if (!wasHidden && isHidden) {\r\n            staticGhosts.flashes.push({\r\n                x: player.transform.pos.x,\r\n                y: player.transform.pos.y,\r\n                t: now,\r\n                type: 'start',\r\n                playerId: player.id\r\n            });\r\n        }\r\n\r\n        // Detect end of dash (flash in)\r\n        if (wasHidden && !isHidden) {\r\n            staticGhosts.flashes.push({\r\n                x: player.transform.pos.x,\r\n                y: player.transform.pos.y,\r\n                t: now,\r\n                type: 'end',\r\n                playerId: player.id\r\n            });\r\n        }\r\n\r\n        staticGhosts.lastHidden.set(player.id, isHidden);\r\n\r\n        // Render ghost flashes\r\n        for (const ghost of staticGhosts.flashes) {\r\n            if (ghost.playerId !== player.id) continue;\r\n            const age = now - ghost.t;\r\n            if (age > player.actions.dash.time) continue;\r\n\r\n            // Convert ghost world position to screen position\r\n            const screenPos = this.camera.worldToScreen({ x: ghost.x, y: ghost.y });\r\n\r\n            const alpha = ghost.type === 'start'\r\n                ? 1 - (age / player.actions.dash.time)\r\n                : (age / player.actions.dash.time);\r\n\r\n            context.save();\r\n\r\n            // Invert-style effect via difference + high saturation\r\n            context.globalAlpha = alpha * 0.8;\r\n            context.globalCompositeOperation = 'difference';\r\n            context.filter = 'saturate(100) contrast(2)';\r\n\r\n            const ghostPlayer = {\r\n                ...player,\r\n                transform: {\r\n                    ...player.transform,\r\n                    pos: { x: screenPos.x, y: screenPos.y } // Screen coordinates for rendering\r\n                }\r\n            };\r\n\r\n            this.drawCharacterLayers({\r\n                player: ghostPlayer,\r\n                context: context\r\n            });\r\n            context.restore();\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Lobby Rendering ]\r\n    //\r\n    /**\r\n     * Renders lobby player in customization canvas via character rendering functions.\r\n     */\r\n    private renderLobbyPlayer(): void {\r\n        if (!this.lobbyManager.inLobby) return;\r\n\r\n        const myLobbyPlayer = this.lobbyManager.lobbyPlayers.get(this.userId);\r\n        if (!myLobbyPlayer || !this.ui.charCustomizeCanvas) return;\r\n\r\n        const ctx = this.ui.charCustomizeCanvas.getContext('2d');\r\n        if (!ctx) return;\r\n\r\n        ctx.clearRect(0, 0, this.ui.charCustomizeCanvas.width, this.ui.charCustomizeCanvas.height);\r\n\r\n        this.drawCharacter({\r\n            player: myLobbyPlayer,\r\n            context: ctx\r\n        });\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Objects ]\r\n    //\r\n    /**\r\n     * Draws object entities on the canvas.\r\n     */\r\n    public drawObjects(): void {\r\n        if (!this.ui.ctx) return;\r\n\r\n        //TODO: Use this function to draw all 'objects' in the scene.\r\n\r\n        // Ammo Boxes\r\n        this.objectsManager.ammoBoxes.forEach(ammoBox => {\r\n            if (!this.ui.ctx) return;\r\n            if (!this.camera.isVisible(ammoBox.transform.pos)) return;\r\n\r\n            // Load and cache images\r\n            if (!this.ammoBoxImages) this.ammoBoxImages = {};\r\n            const layers: (keyof typeof AMMO_BOX)[] = ['BASE', 'BULLETS', 'LID'];\r\n            layers.forEach(layer => {\r\n                if (!this.ammoBoxImages[layer]) {\r\n                    const img = new Image();\r\n                    img.src = AMMO_BOX[layer];\r\n                    this.ammoBoxImages[layer] = img;\r\n                }\r\n            });\r\n\r\n            if (!layers.every(layer => this.ammoBoxImages[layer]?.complete && this.ammoBoxImages[layer]?.naturalWidth > 0)) return;\r\n\r\n            const scale = 35;\r\n            const screenPos = this.camera.worldToScreen(ammoBox.transform.pos);\r\n\r\n            // Update lid physics if open\r\n            if (ammoBox.isOpen) {\r\n                ammoBox.lid.velocity.x *= 0.85;\r\n                ammoBox.lid.velocity.y *= 0.85;\r\n                ammoBox.lid.torque *= 0.85;\r\n\r\n                ammoBox.lid.pos.x += ammoBox.lid.velocity.x;\r\n                ammoBox.lid.pos.y += ammoBox.lid.velocity.y;\r\n                ammoBox.lid.rot += ammoBox.lid.torque;\r\n            }\r\n\r\n            this.ui.ctx.save();\r\n            this.ui.ctx.translate(screenPos.x, screenPos.y);\r\n            this.ui.ctx.rotate(ammoBox.transform.rot || 0);\r\n\r\n            // Draw body\r\n            this.ui.ctx.drawImage(this.ammoBoxImages['BASE'], -scale / 2, -scale / 2, scale, scale);\r\n\r\n            // Draw bullets only if NOT open\r\n            if (!ammoBox.isOpen) {\r\n                this.ui.ctx.drawImage(this.ammoBoxImages['BULLETS'], -scale / 2, -scale / 2, scale, scale);\r\n                // Draw closed lid here\r\n                this.ui.ctx.drawImage(this.ammoBoxImages['LID'], -scale / 2, -scale / 2, scale, scale);\r\n            }\r\n\r\n            this.ui.ctx.restore();\r\n\r\n            // Draw flying lid separately if open\r\n            if (ammoBox.isOpen) {\r\n                this.ui.ctx.save();\r\n                this.ui.ctx.translate(screenPos.x + ammoBox.lid.pos.x, screenPos.y + ammoBox.lid.pos.y);\r\n                this.ui.ctx.rotate((ammoBox.transform.rot || 0) + ammoBox.lid.rot);\r\n                this.ui.ctx.drawImage(this.ammoBoxImages['LID'], -scale / 2, -scale / 2, scale, scale);\r\n                this.ui.ctx.restore();\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Draws the rect of the projectile and renders it on the main canvas.\r\n     */\r\n    public drawProjectile(projectile: DamageEntity): void {\r\n        if (!this.ui.ctx) return;\r\n        if (!this.camera.isVisible(projectile.transform.pos)) return;\r\n\r\n        // Convert world position to screen position\r\n        const screenPos = this.camera.worldToScreen(projectile.transform.pos);\r\n\r\n        // Calculate projectile direction\r\n        const speed = Math.sqrt(projectile.velocity.x * projectile.velocity.x + projectile.velocity.y * projectile.velocity.y);\r\n        const dirX = projectile.velocity.x / speed;\r\n        const dirY = projectile.velocity.y / speed;\r\n\r\n        // Calculate front and back points (in screen space)\r\n        const frontX = screenPos.x + dirX * (projectile.length / 2);\r\n        const frontY = screenPos.y + dirY * (projectile.length / 2);\r\n        const backX = screenPos.x - dirX * (projectile.length / 2);\r\n        const backY = screenPos.y - dirY * (projectile.length / 2);\r\n\r\n        // Draw the capsule body (rectangle)\r\n        this.ui.ctx.fillStyle = projectile.color;\r\n        this.ui.ctx.strokeStyle = projectile.color;\r\n        this.ui.ctx.lineWidth = projectile.size;\r\n        this.ui.ctx.lineCap = 'round';\r\n\r\n        this.ui.ctx.beginPath();\r\n        this.ui.ctx.moveTo(backX, backY);\r\n        this.ui.ctx.lineTo(frontX, frontY);\r\n        this.ui.ctx.stroke();\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Events ]\r\n    //\r\n    private initEventListeners(): void {\r\n        window.addEventListener(\"customEvent_renderCharacter\", () => this.renderLobbyPlayer());\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { GAME } from \"./Config\";\r\n\r\nimport { GameState } from \"./GameState\";\r\nimport { LobbyManager } from \"./LobbyManager\";\r\nimport { RoomManager } from \"./RoomManager\";\r\nimport { UpgradeManager } from \"./UpgradeManager\";\r\nimport { UserInterface } from \"./UserInterface\";\r\nimport { Utility } from \"./Utility\";\r\nimport { WebsocketManager } from \"./WebsocketManager\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\n\r\nexport class RoomController {\r\n    constructor(\r\n        private gameState: GameState,\r\n        private lobbyManager: LobbyManager,\r\n        private playerState: PlayerState,\r\n        private roomManager: RoomManager,\r\n        private ui: UserInterface,\r\n        private upgradeManager: UpgradeManager,\r\n        private userId: string,\r\n        private utility: Utility,\r\n        private wsManager: WebsocketManager\r\n    ) { }\r\n\r\n    /**\r\n     * Calls updateDisplay to show the room specific controls.\r\n     */\r\n    public showRoomControls(): void {\r\n        this.ui.updateDisplay(this.lobbyManager, \"room\");\r\n    }\r\n\r\n    /**\r\n     * Creates a websocket connection on the server, and a room with the roomManager.\r\n     */\r\n    public hostRoom(): void {\r\n        if (!this.wsManager.getWebSocket()) {\r\n            this.wsManager.connectWebSocket();\r\n            this.utility.safeTimeout(() => {\r\n                const roomId = this.roomManager.createRoom();\r\n                if (!roomId) return;\r\n\r\n                this.playerState.isHost = true;\r\n\r\n                this.lobbyManager.showLobbyControls({\r\n                    lobby: this.lobbyManager,\r\n                    lobbyOptions: {\r\n                        maxPlayers: this.gameState.gameMaxPlayers,\r\n                        maxWins: this.gameState.gameMaxWins,\r\n                        isHost: this.playerState.isHost,\r\n                        privateRoom: this.roomManager.isPrivateRoom,\r\n                        upgradesEnabled: this.upgradeManager.isUpgradesEnabled\r\n                    },\r\n                    myPlayer: this.playerState.myPlayer,\r\n                    roomId: roomId,\r\n                    userId: this.userId\r\n                });\r\n            }, GAME.CONNECTION_TIMEOUT);\r\n        } else {\r\n            const roomId = this.roomManager.createRoom();\r\n            if (!roomId) return;\r\n\r\n            this.playerState.isHost = true;\r\n\r\n            this.lobbyManager.showLobbyControls({\r\n                lobby: this.lobbyManager,\r\n                lobbyOptions: {\r\n                    maxPlayers: this.gameState.gameMaxPlayers,\r\n                    maxWins: this.gameState.gameMaxWins,\r\n                    isHost: this.playerState.isHost,\r\n                    privateRoom: this.roomManager.isPrivateRoom,\r\n                    upgradesEnabled: this.upgradeManager.isUpgradesEnabled\r\n                },\r\n                myPlayer: this.playerState.myPlayer,\r\n                roomId: roomId,\r\n                userId: this.userId\r\n            });\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Displays the room joining modal, and allows pasting of room code.\r\n     */\r\n    public joinRoom(): void {\r\n        this.ui.showJoinRoomModal((roomId: string) => {\r\n            this.joinRoomById(roomId);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Directly connect to a game with it's room id.\r\n     * \r\n     * Called by the room join modal.\r\n     */\r\n    private joinRoomById(roomId: string): void {\r\n        if (!roomId) return;\r\n        if (!this.wsManager.getWebSocket()) {\r\n            this.wsManager.connectWebSocket();\r\n            this.utility.safeTimeout(() => {\r\n                this.roomManager.joinRoom(roomId!);\r\n            }, GAME.CONNECTION_TIMEOUT);\r\n        } else {\r\n            this.roomManager.joinRoom(roomId);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Calls quickplay endpoint on server to find a random open public room.\r\n     */\r\n    public quickPlay(): void {\r\n        fetch('/quickplay')\r\n            .then(response => {\r\n                if (!response.ok) {\r\n                    throw new Error('No available rooms');\r\n                }\r\n                return response.json();\r\n            })\r\n            .then(data => {\r\n                if (!this.wsManager.getWebSocket()) {\r\n                    this.wsManager.connectWebSocket();\r\n                    this.utility.safeTimeout(() => {\r\n                        this.roomManager.joinRoom(data.roomId);\r\n                    }, GAME.CONNECTION_TIMEOUT);\r\n                } else {\r\n                    this.roomManager.joinRoom(data.roomId);\r\n                }\r\n            })\r\n            .catch(error => {\r\n                if (!this.ui.modal || !this.ui.modalConfirmButton || !this.ui.modalCancelButton ||\r\n                    !this.ui.modalContent || !this.ui.modalText || !this.ui.modalInput ||\r\n                    !this.ui.modalErrorDiv || !this.ui.modalButtons) return;\r\n\r\n                this.ui.modal.classList.remove('hidden');\r\n                this.ui.modalInput.style.display = 'none';\r\n                this.ui.modalErrorDiv.textContent = ' ';\r\n                this.ui.modalButtons.style.display = 'flex';\r\n                this.ui.modalCancelButton.style.display = 'none';\r\n\r\n                this.ui.modalText.textContent = 'No available games found.';\r\n\r\n                this.ui.modalConfirmButton.textContent = 'Confirm';\r\n                this.ui.modalConfirmButton.onclick = () => {\r\n                    if (!this.ui.modal || !this.ui.modalInput || !this.ui.modalCancelButton ||\r\n                        !this.ui.modalText || !this.ui.modalConfirmButton) return;\r\n\r\n                    this.ui.modal.classList.add('hidden');\r\n                    this.ui.modalInput.style.display = 'flex';\r\n                    this.ui.modalText.textContent = 'Join Room';\r\n                    this.ui.modalCancelButton.style.display = 'flex';\r\n                    this.ui.modalConfirmButton.onclick = null;\r\n                };\r\n            });\r\n    }\r\n\r\n    /**\r\n     * Called when leaving the current room - resets game state.\r\n     */\r\n    public leaveRoom(): void {\r\n        this.roomManager.leaveRoom();\r\n\r\n        window.dispatchEvent(new CustomEvent(\"customEvent_resetGameState\", {\r\n            detail: { resetType: \"Room\" }\r\n        }));\r\n\r\n        this.showRoomControls();\r\n    }\r\n\r\n    /**\r\n     * Used to check for a room link in the URL when loading the page.\r\n     */\r\n    public checkForRoomInURL(): void {\r\n        const roomId = this.getRoomIdFromURL();\r\n        if (roomId) {\r\n            this.wsManager.connectWebSocket();\r\n            this.utility.safeTimeout(() => {\r\n                this.roomManager.joinRoom(roomId);\r\n            }, GAME.CONNECTION_TIMEOUT);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * [DO NOT CALL - Call checkForRoomInURL] Directly parses the room ID from the URL if one is found. \r\n     */\r\n    private getRoomIdFromURL(): string | null {\r\n        const urlParams = new URLSearchParams(window.location.search);\r\n        return urlParams.get('room');\r\n    }\r\n\r\n    /**\r\n     * Gets the room ID contextually, and copies it to clipboard.\r\n     */\r\n    public copyRoomCode(): void {\r\n        // Get room ID from either lobby or game container\r\n        const roomId = this.lobbyManager.inLobby\r\n            ? this.ui.roomIdDisplay?.textContent\r\n            : this.ui.gameRoomIdDisplay?.textContent;\r\n\r\n        if (!roomId) return;\r\n\r\n        navigator.clipboard.writeText(roomId).then(() => {\r\n            if (!this.ui.modal || !this.ui.modalConfirmButton || !this.ui.modalCancelButton ||\r\n                !this.ui.modalContent || !this.ui.modalText || !this.ui.modalInput ||\r\n                !this.ui.modalErrorDiv || !this.ui.modalButtons) return;\r\n\r\n            this.ui.modal.classList.remove('hidden');\r\n            this.ui.modalInput.style.display = 'none';\r\n            this.ui.modalErrorDiv.textContent = ' ';\r\n            this.ui.modalButtons.style.display = 'flex';\r\n            this.ui.modalCancelButton.style.display = 'none';\r\n\r\n            this.ui.modalText.textContent = 'Room code copied!';\r\n            this.ui.modalConfirmButton.textContent = 'Confirm';\r\n\r\n            // Define the close function\r\n            const closeModal = () => {\r\n                if (!this.ui.modal || !this.ui.modalInput || !this.ui.modalCancelButton ||\r\n                    !this.ui.modalText || !this.ui.modalConfirmButton) return;\r\n\r\n                this.ui.modal.classList.add('hidden');\r\n                this.ui.modalInput.style.display = 'flex';\r\n                this.ui.modalText.textContent = 'Join Room';\r\n                this.ui.modalCancelButton.style.display = 'flex';\r\n                this.ui.modalConfirmButton.onclick = null;\r\n            };\r\n\r\n            this.ui.modalConfirmButton.onclick = closeModal;\r\n\r\n            // Auto-close after 3 seconds\r\n            this.utility.safeTimeout(() => {\r\n                if (this.ui.modal && !this.ui.modal.classList.contains('hidden')) {\r\n                    closeModal();\r\n                }\r\n            }, 3000);\r\n        }).catch(() => {\r\n            alert(\"Could not copy. Please copy manually.\");\r\n        });\r\n    }\r\n}","import { ROOM } from './Config';\r\nimport { RoomMessage } from './Types';\r\n\r\nimport { Utility } from './Utility';\r\n\r\nexport class RoomManager {\r\n  private currentRoom: string | null = null;\r\n  private ws: WebSocket | null = null;\r\n  private messageHandlers: ((message: RoomMessage) => void)[] = [];\r\n\r\n  public isPrivateRoom = false;\r\n\r\n  constructor(private userId: string, private utility: Utility) { }\r\n\r\n  /**\r\n   * Assigns the active WebSocket connection and sets up message handling.\r\n   */\r\n  public setWebSocket(ws: WebSocket): void {\r\n    this.ws = ws;\r\n    this.setupMessageHandler();\r\n  }\r\n\r\n  /**\r\n   * Creates a new room and automatically joins it as the host.\r\n   */\r\n  public createRoom(): string | null {\r\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {\r\n      alert('Cannot create room: Not connected to server. Please refresh the page.');\r\n      return null;\r\n    }\r\n\r\n    const roomId = this.utility.generateUID(ROOM.ID_LENGTH, ROOM.ID_PREFIX);\r\n    this.joinRoom(roomId, true);\r\n    return roomId;\r\n  }\r\n\r\n  /**\r\n   * Joins an existing room or creates one if isHost is true.\r\n   */\r\n  public joinRoom(roomId: string, isHost: boolean = false): void {\r\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {\r\n      alert('Cannot join room: Not connected to server. Please refresh the page.');\r\n      return;\r\n    }\r\n\r\n    const message: RoomMessage = {\r\n      type: isHost ? 'create-room' : 'join-room',\r\n      roomId,\r\n      userId: this.userId\r\n    };\r\n\r\n    this.ws.send(JSON.stringify(message));\r\n    this.currentRoom = roomId;\r\n    this.utility.generateLink(roomId, 'room');\r\n  }\r\n\r\n  /**\r\n   * Leaves the current room and resets the client state.\r\n   */\r\n  public leaveRoom(): void {\r\n    if (!this.currentRoom || !this.ws) return;\r\n\r\n    const message: RoomMessage = {\r\n      type: 'leave-room',\r\n      roomId: this.currentRoom,\r\n      userId: this.userId\r\n    };\r\n\r\n    this.ws.send(JSON.stringify(message));\r\n    this.currentRoom = null;\r\n    window.history.pushState({}, '', window.location.origin);\r\n  }\r\n\r\n  /**\r\n   * Returns the ID of the current active room.\r\n   */\r\n  public sendMessage(text: string): void {\r\n    if (!this.currentRoom || !this.ws) return;\r\n\r\n    if (this.ws.readyState !== WebSocket.OPEN) {\r\n      alert('Cannot send message: Not connected to server. Please refresh the page.');\r\n      return;\r\n    }\r\n\r\n    const message: RoomMessage = {\r\n      type: 'room-message',\r\n      roomId: this.currentRoom,\r\n      userId: this.userId,\r\n      message: text\r\n    };\r\n\r\n    this.ws.send(JSON.stringify(message));\r\n  }\r\n\r\n  /**\r\n   * Sends an admin command from the frontend to backend.\r\n   */\r\n  public sendAdminCommand(command: string, key: string): void {\r\n    if (!this.ws) return;\r\n\r\n    const message = {\r\n      type: 'admin-command',\r\n      id: command,\r\n      key: key,\r\n      userId: this.userId\r\n    };\r\n\r\n    this.ws.send(JSON.stringify(message));\r\n  }\r\n\r\n  /**\r\n   * Returns the ID of the current active room.\r\n   */\r\n  public getCurrentRoom(): string | null {\r\n    return this.currentRoom;\r\n  }\r\n\r\n  /**\r\n   * Generates a shareable link for the current room.\r\n   */\r\n  public getRoomLink(param?: string): string | null {\r\n    return this.currentRoom ? this.utility.generateLink(this.currentRoom, param) : null;\r\n  }\r\n\r\n  /**\r\n   * Registers a callback to handle incoming room messages.\r\n   */\r\n  public onMessage(handler: (message: RoomMessage) => void): void {\r\n    this.messageHandlers.push(handler);\r\n  }\r\n\r\n  /**\r\n   * Processes incoming WebSocket messages and dispatches them to all handlers.\r\n   */\r\n  private setupMessageHandler(): void {\r\n    if (!this.ws) return;\r\n\r\n    this.ws.onmessage = (event) => {\r\n      try {\r\n        const message: RoomMessage = JSON.parse(event.data);\r\n        this.messageHandlers.forEach(handler => handler(message));\r\n      } catch (error) {\r\n        // Handle plain text messages (backwards compatibility)\r\n        const plainMessage: RoomMessage = {\r\n          type: 'room-message',\r\n          userId: 'server',\r\n          message: event.data\r\n        };\r\n        this.messageHandlers.forEach(handler => handler(plainMessage));\r\n      }\r\n    };\r\n  }\r\n}\r\n","import { GAME } from \"./Config\";\r\nimport { AudioMixerName, GameSettings } from \"./Types\";\r\n\r\nimport { CacheManager } from \"./CacheManager\";\r\n\r\nimport { AudioConfig } from \"./audio/AudioConfig\";\r\nimport { PlayerConfig } from \"./player/PlayerConfig\";\r\n\r\nexport class SettingsManager {\r\n    private gameSettings: GameSettings\r\n\r\n    constructor(private audioConfig: AudioConfig, private cacheManager: CacheManager, private playerConfig: PlayerConfig ) {\r\n        this.gameSettings = this.initSettings();\r\n    }\r\n\r\n    /**\r\n     * Initializes default options when the game starts.\r\n     */\r\n    public initSettings(): GameSettings {\r\n        return { // [ IMPORTANT ] Keep track of the default game options here\r\n            audio: {\r\n                mixer: {\r\n                    master: this.audioConfig.mixer.master,\r\n                    ambience: this.audioConfig.mixer.ambience,\r\n                    music: this.audioConfig.mixer.music,\r\n                    sfx: this.audioConfig.mixer.sfx,\r\n                    voice: this.audioConfig.mixer.voice\r\n                }\r\n            },\r\n            controls: {\r\n                keybinds: {\r\n                    attack: GAME.CONTROLS.KEYBINDS.ATTACK,\r\n                    dash: GAME.CONTROLS.KEYBINDS.DASH,\r\n                    melee: GAME.CONTROLS.KEYBINDS.MELEE,\r\n                    moveDown: GAME.CONTROLS.KEYBINDS.MOVE_DOWN,\r\n                    moveLeft: GAME.CONTROLS.KEYBINDS.MOVE_LEFT,\r\n                    moveRight: GAME.CONTROLS.KEYBINDS.MOVE_RIGHT,\r\n                    moveUp: GAME.CONTROLS.KEYBINDS.MOVE_UP,\r\n                    reload: GAME.CONTROLS.KEYBINDS.RELOAD,\r\n                    sprint: GAME.CONTROLS.KEYBINDS.SPRINT,\r\n                },\r\n                gamepad: {\r\n                    attack: GAME.CONTROLS.GAMEPAD.ATTACK,\r\n                    dash: GAME.CONTROLS.GAMEPAD.DASH,\r\n                    deadzone: GAME.CONTROLS.GAMEPAD.DEADZONE,\r\n                    melee: GAME.CONTROLS.GAMEPAD.MELEE,\r\n                    reload: GAME.CONTROLS.GAMEPAD.RELOAD,\r\n                    sprint: GAME.CONTROLS.GAMEPAD.SPRINT\r\n                }\r\n            },\r\n            character: {\r\n                rig: {\r\n                    body: this.playerConfig.default.rig.body,\r\n                    head: this.playerConfig.default.rig.head,\r\n                    headwear: this.playerConfig.default.rig.headwear,\r\n                    weapon: this.playerConfig.default.rig.weapon\r\n                }\r\n            },\r\n            graphics: {\r\n                physics: {\r\n                    ammoReserves: GAME.GRAPHICS.PHYSICS.AMMORESERVES\r\n                },\r\n                renderBackgroundParticles: GAME.GRAPHICS.BACKGROUND_PARTICLES,\r\n                showStaticOverlay: GAME.GRAPHICS.STATIC_OVERLAY,\r\n            }\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Returns the currently stored gameSettings.\r\n     */\r\n    public getSettings(): GameSettings { return this.gameSettings }\r\n\r\n    /**\r\n     * Recursively updates any setting(s) passed within the stored gameSettings.\r\n     */\r\n    public updateSettings(settings: any): void {\r\n        // Special handling for audio mixer updates\r\n        if (settings.audio?.mixer) {\r\n            const mixerUpdates = settings.audio.mixer;\r\n\r\n            (Object.keys(mixerUpdates) as AudioMixerName[]).forEach((busName) => {\r\n                const update = mixerUpdates[busName];\r\n\r\n                if (update && typeof update.volume === \"number\") {\r\n                    this.gameSettings.audio.mixer[busName].volume = update.volume;\r\n                }\r\n            });\r\n\r\n            this.cacheManager.write('gameSettings', this.gameSettings);\r\n            return;\r\n        }\r\n\r\n        // Fallback: normal deep merge for *non mixer* stuff\r\n        const merge = (target: any, source: any): void => {\r\n            for (const key in source) {\r\n                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {\r\n                    if (!target[key]) target[key] = {};\r\n                    merge(target[key], source[key]);\r\n                } else {\r\n                    target[key] = source[key];\r\n                }\r\n            }\r\n        };\r\n\r\n        merge(this.gameSettings, settings);\r\n        this.cacheManager.write('gameSettings', this.gameSettings);\r\n    }\r\n\r\n\r\n    /**\r\n     * Loads the currently cached gameSettings from the cacheManager.\r\n     */\r\n    public async loadSettings(): Promise<void> {\r\n        const cached = await this.cacheManager.read('gameSettings');\r\n        if (cached) {\r\n            this.gameSettings = cached;\r\n        }\r\n    }\r\n}","export const equipment = [\r\n    'switch'\r\n];","import { equipment } from './equipment';\r\nimport { resource } from './resource';\r\nimport { stats } from './stats';\r\nimport { unique } from './unique';\r\n\r\nexport const upgradeFiles = {\r\n    equipment,\r\n    resource,\r\n    stats,\r\n    unique\r\n};","export const resource = [\r\n    'carepackage'\r\n];","export const stats = [\r\n    'bioregulator',\r\n    'damagebuffer',\r\n    'hemoglobinsaturator',\r\n    'locomotionmodule'\r\n];","export const unique = [\r\n    'clustermodule',\r\n    'kineticbrain',\r\n    'muzzlesplitter',\r\n    'phoenixmodule',\r\n    'projectilearray',\r\n    'spatialtargeting',\r\n    'spectralimage'\r\n];","import { Player, Upgrade, UpgradeParams, UpgradeRarity, UpgradeType } from './Types';\r\n\r\nimport { upgradeFiles } from './upgrades';\r\n\r\nimport { UserInterface } from './UserInterface';\r\nimport { Utility } from './Utility';\r\n\r\nimport { PlayerState } from './player/PlayerState';\r\nimport { PlayerConfig } from './player/PlayerConfig';\r\n\r\nexport class UpgradeManager {\r\n    public takenUniques = new Set<string>(); // Pool of uniques already taken by players during this session\r\n    public upgradesCompleted = new Set<string>(); // Tracks round end upgrade progress\r\n\r\n    public isUpgradesEnabled = true;\r\n\r\n    private rarityConfig = {\r\n        [UpgradeRarity.COMMON]: {\r\n            weight: 35,\r\n            color: '#7e7e7e'\r\n        },\r\n        [UpgradeRarity.UNCOMMON]: {\r\n            weight: 20,\r\n            color: '#61b6d5'\r\n        },\r\n        [UpgradeRarity.SPECIAL]: {\r\n            weight: 15,\r\n            color: '#58d688'\r\n        },\r\n        [UpgradeRarity.SUPERIOR]: {\r\n            weight: 12,\r\n            color: '#ffc233'\r\n        },\r\n        [UpgradeRarity.RARE]: {\r\n            weight: 8,\r\n            color: '#0077ff'\r\n        },\r\n        [UpgradeRarity.EXCEPTIONAL]: {\r\n            weight: 5,\r\n            color: '#00ff62'\r\n        },\r\n        [UpgradeRarity.LEGENDARY]: {\r\n            weight: 2.5,\r\n            color: '#f6ff00'\r\n        },\r\n        [UpgradeRarity.MYTHICAL]: {\r\n            weight: 1.5,\r\n            color: '#ff0000'\r\n        },\r\n        [UpgradeRarity.ENLIGHTENED]: {\r\n            weight: 0.9,\r\n            color: '#9500ff'\r\n        },\r\n        [UpgradeRarity.HOLY]: {\r\n            weight: 0.1,\r\n            color: '#ff00f7'\r\n        }\r\n    };\r\n\r\n    public upgrades: Upgrade[] = []\r\n\r\n    constructor(\r\n        private playerConfig: PlayerConfig,\r\n        private playerState: PlayerState,\r\n        private ui: UserInterface,\r\n        private utility: Utility\r\n    ) { \r\n        this.initUpgrades();\r\n    }\r\n\r\n    /**\r\n     * Initializes upgrades[] by importing the upgradeFiles from the index.ts in the upgrades folder.\r\n     */\r\n    private initUpgrades(): void {\r\n        const params: UpgradeParams = {\r\n            playerState: this.playerState,\r\n            ui: this.ui,\r\n            utility: this.utility\r\n        };\r\n\r\n        upgradeFiles.equipment.forEach(filename => {\r\n            const upgrade = require(`./upgrades/equipment/${filename}/${filename}`).create(params);\r\n            this.upgrades.push(upgrade);\r\n        });\r\n\r\n        upgradeFiles.resource.forEach(filename => {\r\n            const upgrade = require(`./upgrades/resource/${filename}/${filename}`).create(params);\r\n            this.upgrades.push(upgrade);\r\n        });\r\n\r\n        upgradeFiles.stats.forEach(filename => {\r\n            const upgrade = require(`./upgrades/stats/${filename}/${filename}`).create(params);\r\n            this.upgrades.push(upgrade);\r\n        });\r\n\r\n        upgradeFiles.unique.forEach(filename => {\r\n            const upgrade = require(`./upgrades/unique/${filename}/${filename}`).create(params);\r\n            this.upgrades.push(upgrade);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Returns a selected amount of upgrades for a specific player in the game.\r\n     * \r\n     * Used to display upgrades for all round losers after brief roud-end pause.\r\n     */\r\n    public getUpgrades(count: number, player: Player): Upgrade[] {\r\n        // Filter available upgrades based on type restrictions\r\n        const availableUpgrades = this.upgrades.filter(upgrade => {\r\n            // Check if unique upgrade has already been taken globally\r\n            if (upgrade.unique && this.takenUniques.has(upgrade.id)) {\r\n                return false;\r\n            }\r\n\r\n            // Check if equipment is already owned by this player\r\n            if (upgrade.type === UpgradeType.EQUIPMENT && player.equipment.includes(upgrade.id)) {\r\n                return false;\r\n            }\r\n\r\n            return true;\r\n        });\r\n\r\n        // Weighted random selection using rarity config\r\n        const selected: Upgrade[] = [];\r\n\r\n        for (let i = 0; i < Math.min(count, availableUpgrades.length); i++) {\r\n            if (availableUpgrades.length === 0) break;\r\n\r\n            // Calculate weighted random selection using this.rarityConfig\r\n            const totalWeight = availableUpgrades.reduce((sum, upgrade) => {\r\n                return sum + this.getRarityWeight(upgrade.rarity);\r\n            }, 0);\r\n\r\n            let random = Math.random() * totalWeight;\r\n            let selectedUpgrade: Upgrade | null = null;\r\n\r\n            for (const upgrade of availableUpgrades) {\r\n                random -= this.getRarityWeight(upgrade.rarity);\r\n                if (random <= 0) {\r\n                    selectedUpgrade = upgrade;\r\n                    break;\r\n                }\r\n            }\r\n\r\n            if (selectedUpgrade) {\r\n                selected.push(selectedUpgrade);\r\n                // Remove from available pool to prevent duplicates in this selection\r\n                const index = availableUpgrades.indexOf(selectedUpgrade);\r\n                availableUpgrades.splice(index, 1);\r\n            }\r\n        }\r\n\r\n        return selected;\r\n    }\r\n\r\n    /**\r\n     * Applies a specific upgrade to a specific player by mutating their myPlayer object.\r\n     */\r\n    public applyUpgrade(upgradeId: string, player: Player): boolean {\r\n        const upgrade = this.upgrades.find(u => u.id === upgradeId);\r\n        if (!upgrade) return false;\r\n\r\n        // Double-check restrictions\r\n        if (upgrade.unique && this.takenUniques.has(upgradeId)) {\r\n            console.warn(`Unique upgrade ${upgradeId} already taken globally`);\r\n            return false;\r\n        }\r\n\r\n        if (upgrade.type === UpgradeType.EQUIPMENT && this.hasEquipment(player, upgradeId)) {\r\n            console.warn(`Equipment ${upgradeId} already owned by player`);\r\n            return false;\r\n        }\r\n\r\n        // Track unique upgrades globally\r\n        if (upgrade.unique) {\r\n            this.takenUniques.add(upgradeId);\r\n        }\r\n\r\n        // Apply the upgrade to the player object\r\n        upgrade.func(player);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Removes a unique upgrade from the global pool.\r\n     * \r\n     * This process involved adding the unique item to the client's takenUniques array.\r\n     * \r\n     * Network message 'upgrade-taken' broadcasts this to all players.\r\n     */\r\n    public removeUpgradeFromPool(upgradeId: string): void {\r\n        this.takenUniques.add(upgradeId);\r\n    }\r\n\r\n    /**\r\n     * Resets the global uniques pool to a clean slate.\r\n     */\r\n    public resetUpgrades(player: Player): void {\r\n        this.takenUniques.clear();\r\n\r\n        player.equipment = this.playerConfig.default.equipment;\r\n        player.unique = this.playerConfig.default.unique;\r\n    }\r\n\r\n    // #region [ Helpers ]\r\n    //\r\n    /**\r\n     * Returns boolean based on if the selected player has a specific equipment piece or not.\r\n     */\r\n    public hasEquipment(player: Player, equipmentId: string): boolean {\r\n        return player.equipment.includes(equipmentId);\r\n    }\r\n\r\n    /**\r\n     * Returns boolean based on if the selected player has a specific unique item or not.\r\n     */\r\n    private hasUnique(player: Player, uniqueId: string): boolean {\r\n        return player.unique.includes(uniqueId);\r\n    }\r\n\r\n    /**\r\n     * Gets the color associated with a specific rarity.\r\n     */\r\n    private getRarityColor(rarity: UpgradeRarity): string {\r\n        return this.rarityConfig[rarity].color;\r\n    }\r\n\r\n    /**\r\n     * Gets the weight of a specific rarity.\r\n     */\r\n    private getRarityWeight(rarity: UpgradeRarity): number {\r\n        return this.rarityConfig[rarity].weight;\r\n    }\r\n}\r\n\r\n/**\r\n Upgrade Ideas:\r\n ionic compound\r\n randomly chance to combine all nProjeciles into one\r\n explosion on dash\r\n while sprinting, luck doubled\r\n bullet trails\r\n projectile with padding on sides = projectiles that are detonated on reload\r\n on death respawn as 1hp ghost who can melee with .25s invul\r\n chemistry system\r\n volatile upgrades\r\n\r\n on hit, chance to instakill player, destroy one of your equipment, only trigger if enemies damage would kill you\r\n - one time use, destroys itself and another upgrade\r\n \r\n > [ Stats ]\r\n  - Size -- / Speed ++\r\n  - Damage ++ / Buffer ++\r\n  - \r\n > [ Persistent ]\r\n  - Projectile burst into more projectiles on non-player hit.\r\n  - Dash becomes teleport but uses twice as much stamina.\r\n  - Switch, unlocking further firing modes \r\n > [ Luck Based ]\r\n  - Explosive\r\n    > explode on hit\r\n    > stick, then explode after timer\r\n    > only explode on player hit\r\n  - Fire\r\n    > leave behind a flame on ground hit that persists and does damage for some time\r\n    > burn player on hit for timer\r\n  - Oil\r\n    > leave oil puddles on hit, flammable, oil on fire persists much longer\r\n  - Poison\r\n    > decrease player health gradually for timer on player hit\r\n    > leave pool of poison on ground for timer\r\n    > spray poison out on ground hit\r\n  - Bounce\r\n    > chance for projectile to bounce\r\n  - Orbital Laser\r\n    > chance to spawn cluster of lasers on non-boundary hit\r\n*/","import { ReserveBulletParticle } from \"../Types\";\r\n\r\nimport { SettingsManager } from \"../SettingsManager\";\r\nimport { UserInterface } from \"../UserInterface\";\r\nimport { Utility } from \"../Utility\";\r\n\r\nexport class AmmoReservesUIController {\r\n    private ammoReserveIcon: HTMLImageElement | null = null;\r\n    private projectileIcon: HTMLImageElement | null = null;\r\n\r\n    public reserveBulletParticles: ReserveBulletParticle[] = [];\r\n\r\n    constructor(\r\n        private settings: SettingsManager,\r\n        private ui: UserInterface,\r\n        private utility: Utility\r\n    ) { }\r\n\r\n    public clear(): void {\r\n        this.reserveBulletParticles = [];\r\n    }\r\n\r\n    // [ Ammo Reserve Canvas ]\r\n    //\r\n    /**\r\n     * Initializes the ammo reserve canvas in the HUD.\r\n     */\r\n    public initAmmoReserveCanvas(): void { // TODO: Unify where UI element references are stored\r\n        this.ammoReserveIcon = new Image();\r\n        this.ammoReserveIcon.src = '/assets/img/icon/inventory/ammobox.png';\r\n        this.ammoReserveIcon.onload = () => {\r\n            this.renderAmmoReserves();\r\n        };\r\n\r\n        this.projectileIcon = new Image();\r\n        this.projectileIcon.src = '/assets/img/icon/inventory/9mm.png';\r\n\r\n        // Start physics loop if it is enabled in the user's prefs\r\n        if (this.settings.getSettings().graphics.physics.ammoReserves) {\r\n            requestAnimationFrame(() => this.updateAmmoReservePhysics());\r\n        }\r\n    }\r\n\r\n    /**\r\n     * When picking up ammo, this function spawns the casings in the player's ammo reserve UI.\r\n     */\r\n    public spawnAmmoInReserveUI(amount: number = 1): void {\r\n        if (!this.ui.ammoReservesCtx || !this.projectileIcon) return;\r\n\r\n        const physicsEnabled = this.settings.getSettings().graphics.physics.ammoReserves;\r\n\r\n        const spawnDelay = 100;\r\n        const { collisionHeight, collisionWidth, collisionX, collisionY } = this.getAmmoReserveCollisionZone();\r\n\r\n        const scale = 0.25;\r\n        const bulletWidth = 11 * scale;\r\n        const bulletHeight = 28 * scale;\r\n\r\n        for (let i = 0; i < amount; i++) {\r\n            this.utility.safeTimeout(() => {\r\n                if (physicsEnabled) {\r\n                    // Physics mode: spawn with velocity from right side\r\n                    const x = collisionX + collisionWidth;\r\n                    const y = collisionY + collisionHeight / 2;\r\n                    const speed = 2 + Math.random() * 8;\r\n                    const angle = (Math.random() - 0.5) * (Math.PI / 3);\r\n                    const vx = Math.cos(angle) * speed;\r\n                    const vy = Math.sin(angle) * speed;\r\n                    const rotation = Math.random() * Math.PI * 2;\r\n                    const torque = (Math.random() - 0.5) * 0.1;\r\n\r\n                    this.reserveBulletParticles.push({\r\n                        transform: {\r\n                            pos: { x, y },\r\n                            rot: rotation,\r\n                        },\r\n                        velocity: { x: vx, y: vy },\r\n                        torque,\r\n                        width: bulletWidth,\r\n                        height: bulletHeight\r\n                    });\r\n                } else {\r\n                    // Static mode: spawn at random position, no velocity\r\n                    const x = collisionX + Math.random() * collisionWidth;\r\n                    const y = collisionY + Math.random() * collisionHeight;\r\n                    const rotation = Math.random() * Math.PI * 2;\r\n\r\n                    this.reserveBulletParticles.push({\r\n                        transform: {\r\n                            pos: { x, y },\r\n                            rot: rotation,\r\n                        },\r\n                        velocity: { x: 0, y: 0 },\r\n                        torque: 0,\r\n                        width: bulletWidth,\r\n                        height: bulletHeight\r\n                    });\r\n                    this.renderAmmoReserves(); // Render static bullet immediately\r\n                }\r\n            }, i * spawnDelay);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Removes ammo from the reserves UI when ammo is taken from the player's reserves.\r\n     */\r\n    public removeAmmoFromReserveUI(amount: number = 1): void {\r\n        const removeDelay = 100; // ms, match spawnBullet\r\n        for (let i = 0; i < amount; i++) {\r\n            this.utility.safeTimeout(() => {\r\n                if (this.reserveBulletParticles.length > 0) {\r\n                    this.reserveBulletParticles.shift();\r\n                }\r\n                if (!this.settings.getSettings().graphics.physics.ammoReserves) {\r\n                    this.renderAmmoReserves();\r\n                }\r\n            }, i * removeDelay);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Processes ammo reserve physics for the projectiles in the ammo reserve UI.\r\n     */\r\n    private updateAmmoReservePhysics(): void {\r\n        if (!this.settings.getSettings().graphics.physics.ammoReserves) return;\r\n        if (!this.ui.ammoReservesCtx || !this.ammoReserveIcon) return;\r\n\r\n        // TODO: Add sleeping when they come to a stop and end simulation\r\n\r\n        // Physics constants\r\n        const friction = 0.9;\r\n        const bounce = 0.5;\r\n\r\n        const { collisionHeight, collisionWidth, collisionX, collisionY } = this.getAmmoReserveCollisionZone();\r\n\r\n        // Clear\r\n        this.ui.ammoReservesCtx.clearRect(0, 0, this.ui.ammoReservesCanvas!.width, this.ui.ammoReservesCanvas!.height);\r\n\r\n        // Draw background box\r\n        this.ui.ammoReservesCtx.drawImage(\r\n            this.ammoReserveIcon,\r\n            0, 0,\r\n            this.ui.ammoReservesCanvas!.width,\r\n            this.ui.ammoReservesCanvas!.height\r\n        );\r\n\r\n        // Update and draw bullets\r\n        for (let bullet of this.reserveBulletParticles) {\r\n            // Physics\r\n            bullet.transform.pos.x += bullet.velocity.x;\r\n            bullet.transform.pos.y += bullet.velocity.y;\r\n            bullet.transform.rot += bullet.torque;\r\n\r\n            bullet.velocity.x *= friction;\r\n            bullet.velocity.y *= friction;\r\n            bullet.torque *= friction;\r\n\r\n            // Wall collisions\r\n            // Left\r\n            if (bullet.transform.pos.x - bullet.width / 2 < collisionX) {\r\n                bullet.transform.pos.x = collisionX + bullet.width / 2;\r\n                bullet.velocity.x *= -bounce;\r\n            }\r\n            // Right\r\n            if (bullet.transform.pos.x + bullet.width / 2 > collisionX + collisionWidth) {\r\n                bullet.transform.pos.x = collisionX + collisionWidth - bullet.width / 2;\r\n                bullet.velocity.x *= -bounce;\r\n            }\r\n            // Top\r\n            if (bullet.transform.pos.y - bullet.height / 2 < collisionY) {\r\n                bullet.transform.pos.y = collisionY + bullet.height / 2;\r\n                bullet.velocity.y *= -bounce;\r\n            }\r\n            // Bottom\r\n            if (bullet.transform.pos.y + bullet.height / 2 > collisionY + collisionHeight) {\r\n                bullet.transform.pos.y = collisionY + collisionHeight - bullet.height / 2;\r\n                bullet.velocity.y *= -bounce;\r\n            }\r\n        }\r\n\r\n        // Optional: bullet-bullet collisions (efficient, skip if <2 bullets)\r\n        for (let i = 0; i < this.reserveBulletParticles.length; i++) {\r\n            for (let j = i + 1; j < this.reserveBulletParticles.length; j++) {\r\n                const a = this.reserveBulletParticles[i];\r\n                const b = this.reserveBulletParticles[j];\r\n                const dx = a.transform.pos.x - b.transform.pos.x;\r\n                const dy = a.transform.pos.y - b.transform.pos.y;\r\n                const dist = Math.sqrt(dx * dx + dy * dy);\r\n                const minDist = (a.width + b.width) / 2;\r\n                if (dist < minDist) {\r\n                    // Simple elastic collision\r\n                    const angle = Math.atan2(dy, dx);\r\n                    const overlap = minDist - dist;\r\n                    const ax = Math.cos(angle) * overlap / 2;\r\n                    const ay = Math.sin(angle) * overlap / 2;\r\n\r\n                    a.transform.pos.x += ax;\r\n                    a.transform.pos.y += ay;\r\n                    b.transform.pos.x -= ax;\r\n                    b.transform.pos.y -= ay;\r\n\r\n                    // Swap velocities (1D along collision axis)\r\n                    const va = a.velocity.x * Math.cos(angle) + a.velocity.y * Math.sin(angle);\r\n                    const vb = b.velocity.x * Math.cos(angle) + b.velocity.y * Math.sin(angle);\r\n                    const avg = (va + vb) / 2;\r\n                    a.velocity.x += (avg - va) * bounce;\r\n                    b.velocity.x += (avg - vb) * bounce;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Draw bullets\r\n        for (let bullet of this.reserveBulletParticles) {\r\n            this.ui.ammoReservesCtx.save();\r\n            this.ui.ammoReservesCtx.translate(bullet.transform.pos.x, bullet.transform.pos.y);\r\n            this.ui.ammoReservesCtx.rotate(bullet.transform.rot);\r\n            this.ui.ammoReservesCtx.drawImage(\r\n                this.projectileIcon!,\r\n                -bullet.width / 2,\r\n                -bullet.height / 2,\r\n                bullet.width,\r\n                bullet.height\r\n            );\r\n            this.ui.ammoReservesCtx.restore();\r\n        }\r\n\r\n        requestAnimationFrame(() => this.updateAmmoReservePhysics());\r\n    }\r\n\r\n    /**\r\n     * Renders the ammo reserves canvas.\r\n     */\r\n    private renderAmmoReserves(): void {\r\n        if (!this.ui.ammoReservesCtx || !this.ammoReserveIcon || !this.ammoReserveIcon.complete) return;\r\n\r\n        // Clear the canvas\r\n        this.ui.ammoReservesCtx.clearRect(0, 0, this.ui.ammoReservesCanvas!.width, this.ui.ammoReservesCanvas!.height);\r\n\r\n        // Draw the ammobox icon to fill the entire canvas\r\n        this.ui.ammoReservesCtx.drawImage(\r\n            this.ammoReserveIcon,\r\n            0, 0,\r\n            this.ui.ammoReservesCanvas!.width,\r\n            this.ui.ammoReservesCanvas!.height\r\n        );\r\n\r\n        if (!this.settings.getSettings().graphics.physics.ammoReserves) {\r\n            for (let bullet of this.reserveBulletParticles) {\r\n                this.ui.ammoReservesCtx.save();\r\n                this.ui.ammoReservesCtx.translate(bullet.transform.pos.x, bullet.transform.pos.y);\r\n                this.ui.ammoReservesCtx.rotate(bullet.transform.rot);\r\n                this.ui.ammoReservesCtx.drawImage(\r\n                    this.projectileIcon!,\r\n                    -bullet.width / 2,\r\n                    -bullet.height / 2,\r\n                    bullet.width,\r\n                    bullet.height\r\n                );\r\n                this.ui.ammoReservesCtx.restore();\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Returns the ammo reserves collision zone to help with physics calculations for rendered projectiles.\r\n     */\r\n    private getAmmoReserveCollisionZone(): { collisionHeight: number; collisionWidth: number; collisionX: number; collisionY: number } {\r\n        const collisionWidth = 63;\r\n        const collisionHeight = 27;\r\n        const collisionX = (this.ui.ammoReservesCanvas!.width - collisionWidth) / 2 - 3;\r\n        const collisionY = (this.ui.ammoReservesCanvas!.height - collisionHeight) / 2 - 1;\r\n\r\n        const params = { collisionHeight, collisionWidth, collisionX, collisionY };\r\n\r\n        return params;\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { VIEWPORT, GAMEPAD_MAP, WORLD } from \"./Config\";\r\nimport { GameSettings, Leaderboard, Players, SetSliderParams } from \"./Types\";\r\n\r\nimport { LobbyManager } from \"./LobbyManager\";\r\nimport { SettingsManager } from \"./SettingsManager\";\r\nimport { Utility } from \"./Utility\";\r\n\r\nimport { PlayerState } from \"./player/PlayerState\";\r\nimport { AmmoReservesUIController } from \"./player/AmmoReservesUIController\";\r\n\r\nexport class UserInterface {\r\n    public ammoReservesUIController: AmmoReservesUIController;\r\n\r\n    public leaderboard: Leaderboard = new Map();\r\n\r\n    // [ Canvas ]\r\n    //\r\n    public ammoReservesCanvas: HTMLCanvasElement | null = null;\r\n    public ammoReservesCtx: CanvasRenderingContext2D | null = null;\r\n    public canvas: HTMLCanvasElement | null = null;\r\n    public ctx: CanvasRenderingContext2D | null = null;\r\n    public decalCanvas: HTMLCanvasElement | null = null;\r\n    public decalCtx: CanvasRenderingContext2D | null = null;\r\n    public worldCanvas: HTMLCanvasElement | null = null;\r\n    public worldCtx: CanvasRenderingContext2D | null = null;\r\n    public liquidCanvas: HTMLCanvasElement | null = null;\r\n    public liquidCtx: CanvasRenderingContext2D | null = null;\r\n    public postEffectsCanvas: HTMLCanvasElement | null = null;\r\n    public postEffectsCtx: CanvasRenderingContext2D | null = null;\r\n    //\r\n    //\r\n    // [ Containers ]\r\n    //\r\n    public gameContainer: HTMLDivElement | null = null;\r\n    public gameOptionsContainer: HTMLDivElement | null = null;\r\n    public lobbyContainer: HTMLDivElement | null = null;\r\n    public roomControls: HTMLDivElement | null = null;\r\n    public upgradeContainer: HTMLElement | null = null;\r\n    //\r\n    //\r\n    // [ Displays ]\r\n    //\r\n    public gameRoomIdDisplay: HTMLSpanElement | null = null;\r\n    public lobbyPlayersList: HTMLDivElement | null = null;\r\n    public roomIdDisplay: HTMLSpanElement | null = null;\r\n    public userIdDisplay: HTMLSpanElement | null = null;\r\n    //\r\n    //\r\n    // [ Buttons ]\r\n    //\r\n    public gameCodeButton: HTMLButtonElement | null = null;\r\n    public gameLeaveButton: HTMLButtonElement | null = null;\r\n    public hostButton: HTMLButtonElement | null = null;\r\n    public joinButton: HTMLButtonElement | null = null;\r\n    public lobbyCodeButton: HTMLButtonElement | null = null;\r\n    public lobbyLeaveButton: HTMLButtonElement | null = null;\r\n    public quickplayButton: HTMLButtonElement | null = null;\r\n    public startGameBtn: HTMLButtonElement | null = null;\r\n    //\r\n    //\r\n    // [ Inputs / Toggles ]\r\n    //\r\n    public playersInput: HTMLInputElement | null = null;\r\n    public privateToggle: HTMLElement | null = null;\r\n    public upgradesToggle: HTMLElement | null = null;\r\n    public winsInput: HTMLInputElement | null = null;\r\n    //\r\n    //\r\n    // [ Chat ]\r\n    //\r\n    public chatContainer: HTMLDivElement | null = null;\r\n    public chatInput: HTMLInputElement | null = null;\r\n    public chatMessages: HTMLDivElement | null = null;\r\n    public chatSendBtn: HTMLButtonElement | null = null;\r\n    //\r\n    //\r\n    // [ Char Customizer ]\r\n    //\r\n    public charCustomizeContainer: HTMLDivElement | null = null;\r\n    public charCustomizeCanvas: HTMLCanvasElement | null = null;\r\n    public charCustomizeCtx: CanvasRenderingContext2D | null = null;\r\n    public headwearArrowLeft: HTMLDivElement | null = null;\r\n    public headArrowLeft: HTMLDivElement | null = null;\r\n    public bodyArrowLeft: HTMLDivElement | null = null;\r\n    public headwearArrowRight: HTMLDivElement | null = null;\r\n    public headArrowRight: HTMLDivElement | null = null;\r\n    public bodyArrowRight: HTMLDivElement | null = null;\r\n    //\r\n    //\r\n    // [ Modal ]\r\n    //\r\n    public modal: HTMLElement | null = null;\r\n    public modalButtons: HTMLDivElement | null = null;\r\n    public modalCancelButton: HTMLButtonElement | null = null;\r\n    public modalConfirmButton: HTMLButtonElement | null = null;\r\n    public modalContent: HTMLElement | null = null;\r\n    public modalErrorDiv: HTMLElement | null = null;\r\n    public modalInput: HTMLInputElement | null = null;\r\n    public modalText: HTMLSpanElement | null = null;\r\n    //\r\n    //\r\n    // [ Leaderboard ]\r\n    //\r\n    public leaderboardBody: HTMLTableSectionElement | null = null;\r\n    public leaderboardContainer: HTMLDivElement | null = null;\r\n    //\r\n    //\r\n    // [ Settings ]\r\n    public settingsContainer: HTMLDivElement | null = null;\r\n    public settingsButton: HTMLButtonElement | null = null;\r\n    public settingsCloseButton: HTMLButtonElement | null = null;\r\n    public controlsTab: HTMLDivElement | null = null;\r\n    public graphicsTab: HTMLDivElement | null = null;\r\n    public soundTab: HTMLDivElement | null = null;\r\n    public controlsBody: HTMLDivElement | null = null;\r\n    public graphicsBody: HTMLDivElement | null = null;\r\n    public soundBody: HTMLDivElement | null = null;\r\n\r\n    public masterSlider: HTMLDivElement | null = null;\r\n    public masterFill: HTMLDivElement | null = null;\r\n    public masterValue: HTMLDivElement | null = null;\r\n    public ambienceSlider: HTMLDivElement | null = null;\r\n    public ambienceFill: HTMLDivElement | null = null;\r\n    public ambienceValue: HTMLDivElement | null = null;\r\n    public musicSlider: HTMLDivElement | null = null;\r\n    public musicFill: HTMLDivElement | null = null;\r\n    public musicValue: HTMLDivElement | null = null;\r\n    public sfxSlider: HTMLDivElement | null = null;\r\n    public sfxFill: HTMLDivElement | null = null;\r\n    public sfxValue: HTMLDivElement | null = null;\r\n    public voiceSlider: HTMLDivElement | null = null;\r\n    public voiceFill: HTMLDivElement | null = null;\r\n    public voiceValue: HTMLDivElement | null = null;\r\n\r\n    public deadzoneInput: HTMLInputElement | null = null;\r\n\r\n    public particleJSToggle: HTMLElement | null = null;\r\n    public staticVfxToggle: HTMLElement | null = null;\r\n    public ammoReservesPhysicsToggle: HTMLElement | null = null;\r\n    //\r\n    //\r\n    // [ Stats ]\r\n    public accuracyStat: HTMLSpanElement | null = null;\r\n    public damageStat: HTMLSpanElement | null = null;\r\n    public luckStat: HTMLSpanElement | null = null;\r\n    public rangeStat: HTMLSpanElement | null = null;\r\n    public shotSpeedStat: HTMLSpanElement | null = null;\r\n    public speedStat: HTMLSpanElement | null = null;\r\n\r\n    constructor(\r\n        private playerState: PlayerState,\r\n        private settingsManager: SettingsManager,\r\n        private utility: Utility\r\n    ) {\r\n        this.ammoReservesUIController = new AmmoReservesUIController(\r\n            this.settingsManager,\r\n            this,\r\n            this.utility\r\n        );\r\n\r\n        this.initInterfaceListeners();\r\n    }\r\n\r\n    /**\r\n     * Clears internal ui state but not cached DOM elements.\r\n     */\r\n    public clear(): void {\r\n        this.ammoReservesUIController.clear();\r\n        this.clearLeaderboard();\r\n    }\r\n\r\n    // #region [ Init ]\r\n    //\r\n    /**\r\n     * Responsible for initializing all elements defined in the class structure.\r\n     * \r\n     * Do not use \"getElement\" type lookups on runtime. Cache them all on start.\r\n     */\r\n    public initInterface() {\r\n        this.canvas = document.getElementById('gameCanvas') as HTMLCanvasElement;\r\n        this.decalCanvas = document.createElement('canvas') as HTMLCanvasElement;\r\n        this.worldCanvas = document.createElement('canvas') as HTMLCanvasElement;\r\n        this.liquidCanvas = document.createElement('canvas') as HTMLCanvasElement;\r\n        this.postEffectsCanvas = document.createElement('canvas') as HTMLCanvasElement;\r\n        this.ammoReservesCanvas = document.getElementById('ammoReservesCanvas') as HTMLCanvasElement;\r\n        this.charCustomizeCanvas = document.getElementById('charCustomizeCanvas') as HTMLCanvasElement;\r\n\r\n        this.roomControls = document.getElementById('roomControls') as HTMLDivElement;\r\n        this.gameContainer = document.getElementById('gameContainer') as HTMLDivElement;\r\n        this.lobbyContainer = document.getElementById('lobbyContainer') as HTMLDivElement;\r\n        this.lobbyPlayersList = document.getElementById('lobbyPlayersList') as HTMLDivElement;\r\n        this.startGameBtn = document.getElementById('startGameBtn') as HTMLButtonElement;\r\n        this.gameOptionsContainer = document.getElementById('gameOptionsContainer') as HTMLDivElement;\r\n\r\n        this.userIdDisplay = document.getElementById('userId') as HTMLSpanElement;\r\n        this.roomIdDisplay = document.getElementById('roomId') as HTMLSpanElement;\r\n        this.gameRoomIdDisplay = document.getElementById('gameRoomId') as HTMLSpanElement;\r\n\r\n        this.chatContainer = document.getElementById('chatContainer') as HTMLDivElement;\r\n        this.chatMessages = document.getElementById('chatMessages') as HTMLDivElement;\r\n        this.chatInput = document.getElementById('chatInput') as HTMLInputElement;\r\n        this.chatSendBtn = document.getElementById('chatSendBtn') as HTMLButtonElement;\r\n\r\n        this.charCustomizeContainer = document.getElementById('charCustomizeContainer') as HTMLDivElement;\r\n        this.headwearArrowLeft = document.getElementById('headwearArrowLeft') as HTMLDivElement;\r\n        this.headArrowLeft = document.getElementById('headArrowLeft') as HTMLDivElement;\r\n        this.bodyArrowLeft = document.getElementById('bodyArrowLeft') as HTMLDivElement;\r\n        this.headwearArrowRight = document.getElementById('headwearArrowRight') as HTMLDivElement;\r\n        this.headArrowRight = document.getElementById('headArrowRight') as HTMLDivElement;\r\n        this.bodyArrowRight = document.getElementById('bodyArrowRight') as HTMLDivElement;\r\n\r\n        this.privateToggle = document.getElementById('privateToggle') as HTMLElement;\r\n        this.upgradesToggle = document.getElementById('upgradesToggle') as HTMLElement;\r\n        this.winsInput = document.getElementById('winsInput') as HTMLInputElement;\r\n        this.playersInput = document.getElementById('playersInput') as HTMLInputElement;\r\n\r\n        this.upgradeContainer = document.getElementById('upgradeContainer') as HTMLElement;\r\n\r\n        this.leaderboardContainer = document.getElementById('leaderboardContainer') as HTMLDivElement;\r\n        this.leaderboardBody = document.getElementById('leaderboardBody') as HTMLTableSectionElement;\r\n\r\n        this.hostButton = document.getElementById('atomHost') as HTMLButtonElement;\r\n        this.joinButton = document.getElementById('atomJoin') as HTMLButtonElement;\r\n        this.quickplayButton = document.getElementById('atomQuickplay') as HTMLButtonElement;\r\n\r\n        this.lobbyLeaveButton = document.getElementById('lobbyLeaveBtn') as HTMLButtonElement;\r\n        this.lobbyCodeButton = document.getElementById('lobbyCodeBtn') as HTMLButtonElement;\r\n\r\n        this.gameLeaveButton = document.getElementById('gameLeaveBtn') as HTMLButtonElement;\r\n        this.gameCodeButton = document.getElementById('gameCodeBtn') as HTMLButtonElement;\r\n\r\n        this.modal = document.getElementById('modal') as HTMLDivElement;\r\n        this.modalInput = document.getElementById('joinRoomInput') as HTMLInputElement;\r\n        this.modalButtons = document.getElementById('modalButtons') as HTMLDivElement;\r\n        this.modalConfirmButton = document.getElementById('joinRoomConfirmBtn') as HTMLButtonElement;\r\n        this.modalCancelButton = document.getElementById('joinRoomCancelBtn') as HTMLButtonElement;\r\n        this.modalErrorDiv = document.getElementById('joinRoomError') as HTMLDivElement;\r\n        this.modalContent = document.getElementById('modalContent') as HTMLDivElement;\r\n        this.modalText = document.getElementById('modalText') as HTMLSpanElement;\r\n\r\n        this.settingsContainer = document.getElementById('settingsContainer') as HTMLDivElement;\r\n        this.settingsButton = document.getElementById('atomSettings') as HTMLButtonElement;\r\n        this.settingsCloseButton = document.getElementById('settingsCloseButton') as HTMLButtonElement;\r\n        this.controlsTab = document.getElementById('controlsTab') as HTMLDivElement;\r\n        this.graphicsTab = document.getElementById('graphicsTab') as HTMLDivElement;\r\n        this.soundTab = document.getElementById('soundTab') as HTMLDivElement;\r\n        this.controlsBody = document.getElementById('controlsBody') as HTMLDivElement;\r\n        this.graphicsBody = document.getElementById('graphicsBody') as HTMLDivElement;\r\n        this.soundBody = document.getElementById('soundBody') as HTMLDivElement;\r\n\r\n        this.masterSlider = document.getElementById('masterSlider') as HTMLDivElement;\r\n        this.masterFill = document.getElementById('masterFill') as HTMLDivElement;\r\n        this.masterValue = document.getElementById('masterValue') as HTMLDivElement;\r\n        this.ambienceSlider = document.getElementById('ambienceSlider') as HTMLDivElement;\r\n        this.ambienceFill = document.getElementById('ambienceFill') as HTMLDivElement;\r\n        this.ambienceValue = document.getElementById('ambienceValue') as HTMLDivElement;\r\n        this.musicSlider = document.getElementById('musicSlider') as HTMLDivElement;\r\n        this.musicFill = document.getElementById('musicFill') as HTMLDivElement;\r\n        this.musicValue = document.getElementById('musicValue') as HTMLDivElement;\r\n        this.sfxSlider = document.getElementById('sfxSlider') as HTMLDivElement;\r\n        this.sfxFill = document.getElementById('sfxFill') as HTMLDivElement;\r\n        this.sfxValue = document.getElementById('sfxValue') as HTMLDivElement;\r\n        this.voiceSlider = document.getElementById('voiceSlider') as HTMLDivElement;\r\n        this.voiceFill = document.getElementById('voiceFill') as HTMLDivElement;\r\n        this.voiceValue = document.getElementById('voiceValue') as HTMLDivElement;\r\n\r\n        this.deadzoneInput = document.getElementById('deadzoneInput') as HTMLInputElement;\r\n\r\n        this.particleJSToggle = document.getElementById('particleJSToggle') as HTMLElement;\r\n        this.staticVfxToggle = document.getElementById('staticToggle') as HTMLElement;\r\n        this.ammoReservesPhysicsToggle = document.getElementById('ammoReservesPhysicsToggle') as HTMLElement;\r\n\r\n        this.accuracyStat = document.getElementById('accuracyValue') as HTMLSpanElement;\r\n        this.damageStat = document.getElementById('damageValue') as HTMLSpanElement;\r\n        this.luckStat = document.getElementById('luckValue') as HTMLSpanElement;\r\n        this.rangeStat = document.getElementById('rangeValue') as HTMLSpanElement;\r\n        this.shotSpeedStat = document.getElementById('shotSpeedValue') as HTMLSpanElement;\r\n        this.speedStat = document.getElementById('speedValue') as HTMLSpanElement;\r\n\r\n        if (!this.canvas || !this.decalCanvas || !this.postEffectsCanvas || !this.ammoReservesCanvas || !this.charCustomizeCanvas ||\r\n            !this.liquidCanvas || !this.worldCanvas || !this.roomControls || !this.gameContainer || !this.lobbyContainer ||\r\n            !this.userIdDisplay || !this.roomIdDisplay || !this.gameRoomIdDisplay ||\r\n            !this.lobbyPlayersList || !this.startGameBtn || !this.gameOptionsContainer || !this.chatContainer ||\r\n            !this.chatMessages || !this.chatInput || !this.chatSendBtn || !this.privateToggle ||\r\n            !this.upgradesToggle || !this.winsInput || !this.playersInput || !this.upgradeContainer ||\r\n            !this.leaderboardContainer || !this.leaderboardBody || !this.hostButton || !this.joinButton ||\r\n            !this.quickplayButton || !this.lobbyLeaveButton || !this.lobbyCodeButton || !this.gameLeaveButton ||\r\n            !this.gameCodeButton || !this.settingsButton || !this.settingsCloseButton || !this.settingsContainer ||\r\n            !this.controlsTab || !this.graphicsTab || !this.soundTab || !this.controlsBody || !this.graphicsBody ||\r\n            !this.soundBody || !this.masterSlider || !this.masterFill || !this.ambienceSlider ||\r\n            !this.ambienceFill || !this.musicSlider || !this.musicFill || !this.sfxSlider || !this.sfxFill ||\r\n            !this.voiceSlider || !this.voiceFill || !this.masterValue || !this.ambienceValue || !this.musicValue ||\r\n            !this.sfxValue || !this.voiceValue || !this.accuracyStat || !this.damageStat ||\r\n            !this.luckStat || !this.rangeStat || !this.shotSpeedStat || !this.speedStat || !this.deadzoneInput ||\r\n            !this.particleJSToggle || !this.staticVfxToggle || !this.ammoReservesPhysicsToggle ||\r\n            !this.charCustomizeContainer || !this.headwearArrowLeft || !this.headArrowLeft || !this.bodyArrowLeft ||\r\n            !this.headwearArrowRight || !this.headArrowRight || !this.bodyArrowRight\r\n        ) {\r\n            alert('Failed to load game. Please refresh the page.');\r\n            throw new Error('Critical error: Required DOM elements are missing.');\r\n        }\r\n\r\n        this.canvas.width = VIEWPORT.WIDTH;\r\n        this.canvas.height = VIEWPORT.HEIGHT;\r\n        this.postEffectsCanvas.width = VIEWPORT.WIDTH;\r\n        this.postEffectsCanvas.height = VIEWPORT.HEIGHT\r\n\r\n        this.decalCanvas.width = WORLD.WIDTH;\r\n        this.decalCanvas.height = WORLD.HEIGHT;\r\n        this.worldCanvas.width = WORLD.WIDTH;\r\n        this.worldCanvas.height = WORLD.HEIGHT;\r\n        this.liquidCanvas.width = WORLD.WIDTH;\r\n        this.liquidCanvas.height = WORLD.HEIGHT;\r\n\r\n        this.ammoReservesCanvas.width = 100;\r\n        this.ammoReservesCanvas.height = 64;\r\n        this.charCustomizeCanvas.width = 200;\r\n        this.charCustomizeCanvas.height = 200;\r\n\r\n        this.ctx = this.canvas.getContext('2d');\r\n        this.decalCtx = this.decalCanvas.getContext('2d');\r\n        this.worldCtx = this.worldCanvas.getContext('2d');\r\n        this.liquidCtx = this.liquidCanvas.getContext('2d'); \r\n        this.postEffectsCtx = this.postEffectsCanvas.getContext('2d');\r\n        this.ammoReservesCtx = this.ammoReservesCanvas.getContext('2d');\r\n        this.charCustomizeCtx = this.charCustomizeCanvas.getContext('2d')\r\n\r\n        if (!this.ctx || !this.decalCtx || !this.worldCtx || !this.liquidCtx || !this.postEffectsCtx || !this.ammoReservesCtx || !this.charCustomizeCtx) {\r\n            alert('Failed to load game. Please refresh the page.');\r\n            throw new Error('Could not get canvas context');\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Display ]\r\n    //\r\n    /**\r\n     * Updates the display based on the current state.\r\n     */\r\n    public updateDisplay(lobby: LobbyManager, target: \"lobby\" | \"room\" | \"game\", roomId?: string): void {\r\n        if (!this.roomControls || !this.lobbyContainer || !this.gameContainer ||\r\n            !this.chatContainer || !this.leaderboardContainer || !this.charCustomizeContainer) return;\r\n\r\n        this.clearDisplay();\r\n\r\n        switch (target) {\r\n            case \"lobby\":\r\n                this.lobbyContainer.style.display = \"flex\";\r\n                this.chatContainer.style.display = \"flex\";\r\n                this.charCustomizeContainer.style.display = \"flex\";\r\n                if (roomId && this.roomIdDisplay) {\r\n                    this.roomIdDisplay.textContent = roomId;\r\n                }\r\n                lobby.inLobby = true;\r\n                break;\r\n\r\n            case \"room\":\r\n                this.roomControls.style.display = \"flex\";\r\n                break;\r\n\r\n            case \"game\":\r\n                this.gameContainer.style.display = \"flex\";\r\n                this.chatContainer.style.display = \"flex\";\r\n                this.leaderboardContainer.style.display = \"flex\";\r\n                if (roomId) {\r\n                    const gameRoomId = this.gameRoomIdDisplay;\r\n                    if (gameRoomId) gameRoomId.textContent = roomId;\r\n                }\r\n                lobby.inLobby = false;\r\n                break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Shows host controls when called.\r\n     */\r\n    public updateHostDisplay(isHost: boolean, lobby: LobbyManager): void {\r\n        if (!this.startGameBtn || !this.gameOptionsContainer) return;\r\n\r\n        this.startGameBtn.style.display = isHost ? 'block' : 'none';\r\n        this.startGameBtn.disabled = lobby.lobbyPlayers.size < 1;\r\n\r\n        this.gameOptionsContainer.style.display = isHost ? 'flex' : 'none';\r\n    }\r\n\r\n    /**\r\n     * Displays connected players in the lobby interface.\r\n     */\r\n    public displayLobbyPlayers(isHost: boolean, lobby: LobbyManager, userId: string): void {\r\n        if (!this.lobbyPlayersList) return;\r\n\r\n        this.lobbyPlayersList.innerHTML = '';\r\n\r\n        // Sort players: host first, then others\r\n        const sortedPlayers = Array.from(lobby.lobbyPlayers.values()).sort((a, b) => {\r\n            if (a.isHost && !b.isHost) return -1;\r\n            if (!a.isHost && b.isHost) return 1;\r\n            return 0;\r\n        });\r\n\r\n        sortedPlayers.forEach(player => {\r\n            const playerDiv = document.createElement('div');\r\n            playerDiv.className = 'lobby_player';\r\n\r\n            const colorDiv = document.createElement('div');\r\n            colorDiv.className = 'player_color';\r\n            colorDiv.style.backgroundColor = player.color;\r\n\r\n            const nameDiv = document.createElement('div');\r\n            nameDiv.className = 'player_name';\r\n            nameDiv.textContent = `${player.id}${player.isHost ? ' (Host)' : ''}`;\r\n\r\n            const controlsDiv = document.createElement('div');\r\n            controlsDiv.className = 'player_controls';\r\n\r\n            // Only show controls if I'm the host and this isn't me\r\n            if (isHost && player.id !== userId) {\r\n                const promoteBtn = document.createElement('button');\r\n                promoteBtn.textContent = 'Promote';\r\n                promoteBtn.onclick = () => lobby.promotePlayer(player.id);\r\n\r\n                const kickBtn = document.createElement('button');\r\n                kickBtn.textContent = 'Kick';\r\n                kickBtn.className = 'danger';\r\n                kickBtn.onclick = () => lobby.kickPlayer(player.id);\r\n\r\n                controlsDiv.appendChild(promoteBtn);\r\n                controlsDiv.appendChild(kickBtn);\r\n            }\r\n\r\n            playerDiv.appendChild(colorDiv);\r\n            playerDiv.appendChild(nameDiv);\r\n            playerDiv.appendChild(controlsDiv);\r\n\r\n            if (this.lobbyPlayersList) {\r\n                this.lobbyPlayersList.appendChild(playerDiv);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Refreshes the display to a blank slate.\r\n     */\r\n    private clearDisplay(): void {\r\n        if (!this.roomControls || !this.lobbyContainer || !this.gameContainer\r\n            || !this.chatContainer || !this.leaderboardContainer\r\n            || !this.upgradeContainer || !this.charCustomizeContainer) return;\r\n\r\n        this.roomControls.style.display = \"none\";\r\n        this.lobbyContainer.style.display = \"none\";\r\n        this.gameContainer.style.display = \"none\";\r\n        this.chatContainer.style.display = \"none\";\r\n        this.leaderboardContainer.style.display = \"none\";\r\n        this.upgradeContainer.style.display = \"none\";\r\n        this.charCustomizeContainer.style.display = \"none\";\r\n    }\r\n\r\n    /**\r\n     * Unified modal closure function used to close and refresh the modal.\r\n     */\r\n    public closeModal(): void {\r\n        if (!this.modal || !this.modalInput || !this.modalConfirmButton ||\r\n            !this.modalCancelButton || !this.modalText) return;\r\n\r\n        this.modal.classList.add('hidden');\r\n        this.modalInput.style.display = 'flex';\r\n        this.modalText.textContent = 'Join Room';\r\n        this.modalConfirmButton.onclick = null;\r\n        this.modalCancelButton.onclick = null;\r\n        this.modalInput.onkeydown = null;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Room Modal ]\r\n    //\r\n    /**\r\n     * Shows the join room modal for pasting room codes.\r\n     */\r\n    public showJoinRoomModal(onConfirm: (roomId: string) => void): void {\r\n        if (!this.modal || !this.modalInput || !this.modalConfirmButton ||\r\n            !this.modalCancelButton || !this.modalErrorDiv) return;\r\n\r\n        this.modal.classList.remove('hidden');\r\n        this.modalConfirmButton.classList.remove('hidden');\r\n\r\n        this.modalInput.value = '';\r\n        this.modalErrorDiv.textContent = '';\r\n\r\n        this.modalConfirmButton.textContent = 'Join'\r\n\r\n        this.modalInput.focus();\r\n\r\n        this.modalConfirmButton.onclick = () => {\r\n            if (!this.modalInput || !this.modalErrorDiv) return;\r\n\r\n            const value = this.modalInput.value.trim();\r\n            if (!value) {\r\n                this.modalErrorDiv.textContent = 'Invalid code...';\r\n                return;\r\n            }\r\n\r\n            let roomId: string | null = null;\r\n            try {\r\n                const url = new URL(value, window.location.origin);\r\n                if (url.pathname.startsWith(\"/room_\")) {\r\n                    roomId = url.pathname.replace(\"/\", \"\");\r\n                } else {\r\n                    roomId = new URLSearchParams(url.search).get(\"room\");\r\n                }\r\n            } catch {\r\n                if (value.startsWith(\"room_\")) {\r\n                    roomId = value;\r\n                }\r\n            }\r\n\r\n            if (!roomId) {\r\n                this.modalErrorDiv.textContent = 'Invalid code...';\r\n                return;\r\n            }\r\n\r\n            this.closeModal();\r\n            onConfirm(roomId); // pass back the parsed roomId\r\n        };\r\n\r\n        this.modalCancelButton.onclick = () => this.closeModal();\r\n    }\r\n\r\n    /**\r\n     * Displays a wanring modal if the player starts a game alone.\r\n     */\r\n    public soloGameWarning(onConfirm: () => void): void {\r\n        if (!this.modal || !this.modalConfirmButton || !this.modalCancelButton ||\r\n            !this.modalContent || !this.modalText || !this.modalInput ||\r\n            !this.modalErrorDiv || !this.modalButtons) return;\r\n\r\n        this.modal.classList.remove('hidden');\r\n        this.modalConfirmButton.classList.remove('hidden');\r\n\r\n        this.modalInput.style.display = 'none';\r\n        this.modalErrorDiv.textContent = ' ';\r\n        this.modalButtons.style.display = 'flex';\r\n        this.modalCancelButton.style.display = 'flex';\r\n\r\n        this.modalText.textContent = 'Start game as only player? Other players will be unable to join until you return to the lobby.';\r\n        this.modalConfirmButton.textContent = 'Start Game';\r\n        this.modalCancelButton.textContent = 'Cancel';\r\n\r\n        this.modalConfirmButton.onclick = () => {\r\n            this.closeModal();\r\n            onConfirm(); // Proceed with starting the game\r\n        };\r\n\r\n        this.modalCancelButton.onclick = () => this.closeModal();\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Settings Modal ]\r\n    /**\r\n     * Shows the settings modal.\r\n     */\r\n    public showSettingsPage(): void {\r\n        if (!this.settingsContainer) return;\r\n        this.settingsContainer.classList.remove('hidden');\r\n    }\r\n\r\n    /**\r\n     * Hides the settings modal.\r\n     */\r\n    public hideSettingsPage(): void {\r\n        if (!this.settingsContainer) return;\r\n        this.settingsContainer.classList.add('hidden');\r\n    }\r\n\r\n    /**\r\n     * Switches active settings page.\r\n     */\r\n    public switchSettingsPage(page: 'controls' | 'graphics' | 'sound'): void {\r\n        if (!this.controlsBody || !this.graphicsBody || !this.soundBody ||\r\n            !this.controlsTab || !this.graphicsTab || !this.soundTab) return;\r\n\r\n        // Remove active class from all tabs\r\n        this.controlsTab.classList.remove('settings_tab_active');\r\n        this.graphicsTab.classList.remove('settings_tab_active');\r\n        this.soundTab.classList.remove('settings_tab_active');\r\n\r\n        // Remove hidden class from all pages\r\n        this.controlsBody.classList.remove('settings_page_hidden');\r\n        this.graphicsBody.classList.remove('settings_page_hidden');\r\n        this.soundBody.classList.remove('settings_page_hidden');\r\n\r\n        // Hide all pages and activate the selected tab\r\n        switch (page) {\r\n            case 'controls':\r\n                this.controlsTab.classList.add('settings_tab_active');\r\n                this.graphicsBody.classList.add('settings_page_hidden');\r\n                this.soundBody.classList.add('settings_page_hidden');\r\n                break;\r\n            case 'graphics':\r\n                this.graphicsTab.classList.add('settings_tab_active');\r\n                this.controlsBody.classList.add('settings_page_hidden');\r\n                this.soundBody.classList.add('settings_page_hidden');\r\n                break;\r\n            case 'sound':\r\n                this.soundTab.classList.add('settings_tab_active');\r\n                this.controlsBody.classList.add('settings_page_hidden');\r\n                this.graphicsBody.classList.add('settings_page_hidden');\r\n                break;\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Settings Sliders ]\r\n    //\r\n    /**\r\n     * Updates settings specific sliders that also have value elements associated.\r\n     */\r\n    public updateSettingsSlider(fillElement: HTMLDivElement, valueElement: HTMLDivElement, value: number): void {\r\n        const percentage = Math.max(0, Math.min(100, value * 100));\r\n        fillElement.style.width = `${percentage}%`;\r\n        valueElement.textContent = `${Math.round(percentage)}%`;\r\n    }\r\n\r\n    /**\r\n     * Calculates the value of the slider based on the hovered mouse position.\r\n     */\r\n    public calculateSliderValue(sliderElement: HTMLDivElement, mouseX: number): number {\r\n        const rect = sliderElement.getBoundingClientRect();\r\n        const position = mouseX - rect.left;\r\n        const width = rect.width;\r\n        return Math.max(0, Math.min(1, position / width));\r\n    }\r\n\r\n    /**\r\n     * Initializes the sound sliders in the sound settings page with user prefs or defaults.\r\n     */\r\n    public initSoundSliders(settings: GameSettings): void {\r\n        const audioSettings = settings.audio.mixer;\r\n        if (this.masterFill && this.masterValue) this.updateSettingsSlider(this.masterFill, this.masterValue, audioSettings.master.volume);\r\n        if (this.ambienceFill && this.ambienceValue) this.updateSettingsSlider(this.ambienceFill, this.ambienceValue, audioSettings.ambience.volume);\r\n        if (this.musicFill && this.musicValue) this.updateSettingsSlider(this.musicFill, this.musicValue, audioSettings.music.volume);\r\n        if (this.sfxFill && this.sfxValue) this.updateSettingsSlider(this.sfxFill, this.sfxValue, audioSettings.sfx.volume);\r\n        if (this.voiceFill && this.voiceValue) this.updateSettingsSlider(this.voiceFill, this.voiceValue, audioSettings.voice.volume);\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Settings Inputs ]\r\n    //\r\n    /**\r\n     * Initializes all inputs in settings pages with user prefs or defaults.\r\n     */\r\n    public initSettingsInputs(settings: GameSettings): void {\r\n        if (this.deadzoneInput) {\r\n            this.deadzoneInput.value = settings.controls.gamepad.deadzone.toString();\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Settings Toggles ]\r\n    //\r\n    /**\r\n     * Initializes all toggles in settings pages with user prefs or defaults.\r\n     */\r\n    public initSettingsToggles(settings: GameSettings): void {\r\n        if (this.particleJSToggle) {\r\n            this.utility.setToggle({\r\n                toggleId: 'particleJSToggle',\r\n                value: settings.graphics.renderBackgroundParticles\r\n            });\r\n        }\r\n\r\n        if (this.staticVfxToggle) {\r\n            this.utility.setToggle({\r\n                toggleId: 'staticToggle',\r\n                value: settings.graphics.showStaticOverlay\r\n            });\r\n        }\r\n\r\n        if (this.ammoReservesPhysicsToggle) {\r\n            this.utility.setToggle({\r\n                toggleId: 'ammoReservesPhysicsToggle',\r\n                value: settings.graphics.physics.ammoReserves\r\n            });\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Settings Interfaces ]\r\n    //\r\n    /**\r\n     * Initializes the keybinds settings page interface.\r\n     */\r\n    public initKeybindsInterface(controlsSettings: { keybinds: Record<string, string>, gamepad: Record<string, number> }, onBindingChange: (action: string, type: 'keybind' | 'gamepad', newBinding: string | number) => void): void {\r\n        // [ Keys ]\r\n        Object.keys(controlsSettings.keybinds).forEach(action => {\r\n            const elementId = `${action}Keybind`;\r\n            const element = document.getElementById(elementId);\r\n            if (element) {\r\n                const key = controlsSettings.keybinds[action];\r\n                element.textContent = key === ' ' ? 'SPACE' : key.toUpperCase();\r\n\r\n                element.addEventListener('click', () => {\r\n                    this.showRebindModal(action, 'keybind', (newBinding) => {\r\n                        onBindingChange(action, 'keybind', newBinding as string);\r\n                    });\r\n                });\r\n            }\r\n        });\r\n\r\n        // [ Gamepad ]\r\n        Object.keys(controlsSettings.gamepad).forEach(action => {\r\n            const elementId = `${action}Gamepad`;\r\n            const element = document.getElementById(elementId);\r\n\r\n            if (element && controlsSettings.gamepad[action] !== undefined) {\r\n                const buttonValue = controlsSettings.gamepad[action];\r\n                const buttonName = Object.keys(GAMEPAD_MAP).find(\r\n                    key => typeof GAMEPAD_MAP[key as keyof typeof GAMEPAD_MAP] === 'number'\r\n                        && GAMEPAD_MAP[key as keyof typeof GAMEPAD_MAP] === buttonValue\r\n                );\r\n                element.textContent = buttonName || buttonValue.toString();\r\n\r\n                element.addEventListener('click', () => {\r\n                    this.showRebindModal(action, 'gamepad', (newBinding) => {\r\n                        onBindingChange(action, 'gamepad', newBinding as number);\r\n                    });\r\n                });\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Shows the controls rebinding modal when called.\r\n     * \r\n     * Can be used for rebinding keyboard or gamepad.\r\n     */\r\n    public showRebindModal(action: string, type: 'keybind' | 'gamepad', onRebind: (newBinding: string | number) => void): void {\r\n        if (!this.modal || !this.modalText || !this.modalInput || !this.modalConfirmButton || !this.modalCancelButton || !this.modalErrorDiv) return;\r\n\r\n        const duplicateWarnings = [\r\n            \"Binding already assigned!\",\r\n            \"Binding already in use!\",\r\n            \"That binding is assigned already!\",\r\n            \"Binding already being used!\",\r\n            \"Already bound to another action!\"\r\n        ];\r\n        let warningIndex = 0;\r\n\r\n        // Check for gamepad if type is gamepad\r\n        if (type === 'gamepad') {\r\n            const gamepads = navigator.getGamepads();\r\n            const hasGamepad = Array.from(gamepads).some(gp => gp !== null);\r\n\r\n            if (!hasGamepad) {\r\n                this.modal.classList.remove('hidden');\r\n                this.modalErrorDiv.textContent = '';\r\n                this.modalText.textContent = 'No gamepad detected';\r\n                this.modalInput.style.display = 'none';\r\n                this.modalConfirmButton.classList.add('hidden');\r\n                this.modalCancelButton.textContent = 'Close';\r\n\r\n                this.modalCancelButton.onclick = () => this.closeModal();\r\n\r\n                this.utility.safeTimeout(() => {\r\n                    this.closeModal();\r\n                }, 3000);\r\n\r\n                return;\r\n            }\r\n        }\r\n\r\n        this.modal.classList.remove('hidden');\r\n        this.modalErrorDiv.textContent = '';\r\n        this.modalInput.style.display = 'none';\r\n        this.modalText.textContent = `Press any ${type === 'keybind' ? 'key' : 'button'} for ${action.toUpperCase()}`;\r\n        this.modalConfirmButton.classList.add('hidden');\r\n        this.modalCancelButton.textContent = 'Cancel';\r\n\r\n        const checkDuplicate = (binding: string | number): boolean => {\r\n            if (type === 'keybind') {\r\n                const allKeybinds = Object.entries(this.settingsManager?.getSettings().controls.keybinds || {});\r\n                return allKeybinds.some(([key, value]) => key !== action && value === binding);\r\n            } else {\r\n                const allGamepad = Object.entries(this.settingsManager?.getSettings().controls.gamepad || {});\r\n                return allGamepad.some(([key, value]) => key !== action && value === binding);\r\n            }\r\n        };\r\n\r\n        const handleKeyPress = (e: KeyboardEvent) => {\r\n            e.preventDefault();\r\n            if (e.key === 'Escape') {\r\n                cleanup();\r\n                this.closeModal();\r\n                return;\r\n            }\r\n\r\n            const newKey = e.key.toLowerCase();\r\n\r\n            if (checkDuplicate(newKey)) {\r\n                if (!this.modalErrorDiv) return;\r\n                this.modalErrorDiv.textContent = duplicateWarnings[warningIndex % duplicateWarnings.length];\r\n                warningIndex++;\r\n                return;\r\n            }\r\n\r\n            cleanup();\r\n            onRebind(newKey);\r\n            this.closeModal();\r\n        };\r\n\r\n        const handleMouseDown = (e: MouseEvent) => {\r\n            // Check if click is on cancel button\r\n            if (e.target === this.modalCancelButton || this.modalCancelButton?.contains(e.target as Node)) {\r\n                return;\r\n            }\r\n\r\n            e.preventDefault();\r\n            e.stopPropagation();\r\n\r\n            let mouseKey = '';\r\n            if (e.button === 0) mouseKey = 'mouse1';\r\n            else if (e.button === 1) mouseKey = 'mouse3';\r\n            else if (e.button === 2) mouseKey = 'mouse2';\r\n\r\n            if (mouseKey) {\r\n                if (checkDuplicate(mouseKey)) {\r\n                    if (!this.modalErrorDiv) return;\r\n                    this.modalErrorDiv.textContent = duplicateWarnings[warningIndex % duplicateWarnings.length];\r\n                    warningIndex++;\r\n                    return;\r\n                }\r\n\r\n                cleanup();\r\n                onRebind(mouseKey);\r\n                this.closeModal();\r\n            }\r\n        };\r\n\r\n        const handleGamepadPress = () => {\r\n            const gamepads = navigator.getGamepads();\r\n            for (const gamepad of gamepads) {\r\n                if (!gamepad) continue;\r\n\r\n                for (let i = 0; i < gamepad.buttons.length; i++) {\r\n                    if (gamepad.buttons[i].pressed) {\r\n                        if (checkDuplicate(i)) {\r\n                            if (!this.modalErrorDiv) return;\r\n                            this.modalErrorDiv.textContent = duplicateWarnings[warningIndex % duplicateWarnings.length];\r\n                            warningIndex++;\r\n                            requestAnimationFrame(handleGamepadPress);\r\n                            return;\r\n                        }\r\n\r\n                        cleanup();\r\n                        onRebind(i);\r\n                        this.closeModal();\r\n                        return;\r\n                    }\r\n                }\r\n            }\r\n            requestAnimationFrame(handleGamepadPress);\r\n        };\r\n\r\n        const cleanup = () => {\r\n            if (type === 'keybind') {\r\n                document.removeEventListener('keydown', handleKeyPress);\r\n                document.removeEventListener('mousedown', handleMouseDown);\r\n            }\r\n            this.modalCancelButton!.onclick = null;\r\n        };\r\n\r\n        if (type === 'keybind') {\r\n            document.addEventListener('keydown', handleKeyPress);\r\n            document.addEventListener('mousedown', handleMouseDown);\r\n        } else {\r\n            requestAnimationFrame(handleGamepadPress);\r\n        }\r\n\r\n        this.modalCancelButton.onclick = () => {\r\n            cleanup();\r\n            this.closeModal();\r\n        };\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Leaderboard ]\r\n    //\r\n    /**\r\n     * Locally initialize the leaderboard, or update it if it already exists.\r\n     */\r\n    public createLeaderboard(lobby: LobbyManager, players: Players, userId: string): void {\r\n        // Create a set of all players\r\n        const allPlayers = new Set<string>();\r\n        allPlayers.add(userId);\r\n        players.forEach((_, playerId) => {\r\n            allPlayers.add(playerId);\r\n        });\r\n        lobby.lobbyPlayers.forEach((_, playerId) => {\r\n            allPlayers.add(playerId);\r\n        });\r\n\r\n        // Create/update leaderboard entries for all players\r\n        allPlayers.forEach(playerId => {\r\n            if (!this.leaderboard.has(playerId)) {\r\n                this.leaderboard.set(playerId, { // Create new entry with 0 stats\r\n                    playerId: playerId,\r\n                    wins: 0,\r\n                    kills: 0,\r\n                    deaths: 0\r\n                });\r\n                console.log(`Created leaderboard entry for ${playerId}`);\r\n            }\r\n            // If entry already exists, leave it alone (preserves existing stats)\r\n        });\r\n\r\n        this.updateLeaderboardDisplay(userId);\r\n        console.log('Leaderboard created/updated:', Array.from(this.leaderboard.entries()));\r\n    }\r\n\r\n    /**\r\n     * Update the table for the leaderboard to display the current game status.\r\n     */\r\n    public updateLeaderboardDisplay(localPlayer: string): void {\r\n        if (!this.leaderboardBody) return;\r\n\r\n        // Clear existing rows\r\n        this.leaderboardBody.innerHTML = '';\r\n\r\n        // Sort by wins (highest first), then by kills\r\n        const sortedEntries = Array.from(this.leaderboard.entries()).sort((a, b) => {\r\n            const [, entryA] = a;\r\n            const [, entryB] = b;\r\n\r\n            // First sort by wins (descending)\r\n            if (entryB.wins !== entryA.wins) {\r\n                return entryB.wins - entryA.wins;\r\n            }\r\n            // Then by kills (descending)\r\n            return entryB.kills - entryA.kills;\r\n        });\r\n\r\n        // Create table rows\r\n        sortedEntries.forEach(([playerId, entry]) => {\r\n            const row = document.createElement('tr');\r\n            row.className = 'leaderboard_row';\r\n\r\n            // Highlight current player\r\n            if (playerId === localPlayer) {\r\n                row.classList.add('current-player');\r\n            }\r\n\r\n            // Player name\r\n            const nameCell = document.createElement('td');\r\n            nameCell.textContent = playerId === localPlayer ? 'You' : playerId.substring(0, 8);\r\n            nameCell.className = 'player_name';\r\n            row.appendChild(nameCell);\r\n\r\n            // Wins\r\n            const winsCell = document.createElement('td');\r\n            winsCell.textContent = entry.wins.toString();\r\n            winsCell.className = 'wins';\r\n            row.appendChild(winsCell);\r\n\r\n            // Kills\r\n            const killsCell = document.createElement('td');\r\n            killsCell.textContent = entry.kills.toString();\r\n            killsCell.className = 'kills';\r\n            row.appendChild(killsCell);\r\n\r\n            // Deaths\r\n            const deathsCell = document.createElement('td');\r\n            deathsCell.textContent = entry.deaths.toString();\r\n            deathsCell.className = 'deaths';\r\n            row.appendChild(deathsCell);\r\n\r\n            if (this.leaderboardBody) {\r\n                this.leaderboardBody.appendChild(row);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Reset the leaderboard to default state.\r\n     */\r\n    public clearLeaderboard(): void {\r\n        this.leaderboard.clear();\r\n        if (this.leaderboardBody) {\r\n            this.leaderboardBody.innerHTML = '';\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ HUD ]\r\n    //\r\n    private readonly HUD_LERP_TIME = 300; // ms\r\n\r\n    public updateSlider(target: \"stamina\" | \"health\"): void {\r\n        const playerStats = this.playerState.myPlayer.stats;\r\n\r\n        const sliderParams: SetSliderParams = {\r\n            sliderId: target === \"health\" ? \"healthBar\" : \"staminaBar\",\r\n            targetValue: playerStats[target].value,\r\n            maxValue: playerStats[target].max,\r\n            lerpTime: this.HUD_LERP_TIME\r\n        };\r\n        this.utility.setSlider(sliderParams);\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Events ]\r\n    //\r\n    /**\r\n     * Initializes listeners to interface elements, and sets up their animations.\r\n     */\r\n    private initInterfaceListeners(): void {\r\n        const uiDecimals = 2;\r\n        const animTime = 500;\r\n        const steps = 20;\r\n        const increaseColor = '#00ff00';\r\n        const decreaseColor = '#ff0000';\r\n        const timeout = 200;\r\n\r\n        // Accuracy (spread - inverted: lower is better)\r\n        this.playerState.onStatChange('actions.primary.projectile.spread', (value) => {\r\n            if (!this.accuracyStat) return;\r\n            const oldValue = parseFloat(this.accuracyStat.textContent || '0');\r\n            const isIncrease = value < oldValue;\r\n\r\n            this.utility.animateTextInElement({\r\n                element: this.accuracyStat,\r\n                oldValue: oldValue,\r\n                newValue: value,\r\n                decimals: uiDecimals,\r\n                animTime: animTime,\r\n                steps: steps,\r\n                color: isIncrease ? increaseColor : decreaseColor,\r\n                timeout: timeout\r\n            });\r\n        });\r\n\r\n        // Damage\r\n        this.playerState.onStatChange('actions.primary.projectile.damage', (value) => {\r\n            if (!this.damageStat) return;\r\n            const oldValue = parseFloat(this.damageStat.textContent || '0');\r\n            const isIncrease = value > oldValue;\r\n\r\n            this.utility.animateTextInElement({\r\n                element: this.damageStat,\r\n                oldValue: oldValue,\r\n                newValue: Math.round(value),\r\n                decimals: uiDecimals,\r\n                animTime: animTime,\r\n                steps: steps,\r\n                color: isIncrease ? increaseColor : decreaseColor,\r\n                timeout: timeout\r\n            });\r\n        });\r\n\r\n        // Speed\r\n        this.playerState.onStatChange('stats.speed', (value) => {\r\n            if (!this.speedStat) return;\r\n            const oldValue = parseFloat(this.speedStat.textContent || '0');\r\n            const isIncrease = value > oldValue;\r\n\r\n            this.utility.animateTextInElement({\r\n                element: this.speedStat,\r\n                oldValue: oldValue,\r\n                newValue: value,\r\n                decimals: uiDecimals,\r\n                animTime: animTime,\r\n                steps: steps,\r\n                color: isIncrease ? increaseColor : decreaseColor,\r\n                timeout: timeout\r\n            });\r\n        });\r\n\r\n        // Range\r\n        this.playerState.onStatChange('actions.primary.projectile.range', (value) => {\r\n            if (!this.rangeStat) return;\r\n            const oldValue = parseFloat(this.rangeStat.textContent || '0');\r\n            const isIncrease = value > oldValue;\r\n\r\n            this.utility.animateTextInElement({\r\n                element: this.rangeStat,\r\n                oldValue: oldValue,\r\n                newValue: value,\r\n                decimals: uiDecimals,\r\n                animTime: animTime,\r\n                steps: steps,\r\n                color: isIncrease ? increaseColor : decreaseColor,\r\n                timeout: timeout\r\n            });\r\n        });\r\n\r\n        // Shot Speed\r\n        this.playerState.onStatChange('actions.primary.projectile.speed', (value) => {\r\n            if (!this.shotSpeedStat) return;\r\n            const oldValue = parseFloat(this.shotSpeedStat.textContent || '0');\r\n            const isIncrease = value > oldValue;\r\n\r\n            this.utility.animateTextInElement({\r\n                element: this.shotSpeedStat,\r\n                oldValue: oldValue,\r\n                newValue: value,\r\n                decimals: uiDecimals,\r\n                animTime: animTime,\r\n                steps: steps,\r\n                color: isIncrease ? increaseColor : decreaseColor,\r\n                timeout: timeout\r\n            });\r\n        });\r\n\r\n        // Luck\r\n        this.playerState.onStatChange('stats.luck', (value) => {\r\n            if (!this.luckStat) return;\r\n            const oldValue = parseFloat(this.luckStat.textContent || '0');\r\n            const isIncrease = value > oldValue;\r\n\r\n            this.utility.animateTextInElement({\r\n                element: this.luckStat,\r\n                oldValue: oldValue,\r\n                newValue: value,\r\n                decimals: uiDecimals,\r\n                animTime: animTime,\r\n                steps: steps,\r\n                color: isIncrease ? increaseColor : decreaseColor,\r\n                timeout: timeout\r\n            });\r\n        });\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { Direction, NoiseType, RandomColorParams, SetInputParams, SetSliderParams, SetSpanParams, SetToggleParams, TextAnimParams, Vec2 } from './Types';\r\n\r\nexport class Utility {\r\n    private lastFrameTime: number;\r\n    private simplexTable: Uint8Array;\r\n    private activeTimeouts: Set<number>;\r\n\r\n    constructor() {\r\n        this.lastFrameTime = performance.now();\r\n        this.simplexTable = this.generateSimplexTable();\r\n        this.activeTimeouts = new Set();\r\n    }\r\n\r\n    // #region [ General ]\r\n    //\r\n    \r\n    public deepMerge(target: any, source: any): void {\r\n        for (const key in source) {\r\n            if (\r\n                source[key] !== null &&\r\n                typeof source[key] === 'object' &&\r\n                !Array.isArray(source[key])\r\n            ) {\r\n                if (!target[key]) target[key] = {};\r\n                this.deepMerge(target[key], source[key]);\r\n            } else {\r\n                target[key] = source[key];\r\n            }\r\n        }\r\n    }\r\n\r\n    /** Yields to next animation frame (~16ms) allowing UI updates and optional progress message. */\r\n    public async yield(message?: string): Promise<void> {\r\n        console.log(`[Yield] ${message ?? \"(no message)\"}`);\r\n\r\n        if (message) {\r\n            document.dispatchEvent(new CustomEvent(\"yieldMessage\", { detail: { message } }));\r\n        } else {\r\n            document.dispatchEvent(new CustomEvent(\"yieldProgress\"));\r\n        }\r\n\r\n        await new Promise<void>(resolve => requestAnimationFrame(() => resolve()));\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Time ]\r\n    //\r\n    /**\r\n     * Calculates and returns delta time.\r\n     * \r\n     * https://en.wikipedia.org/wiki/Delta_timing\r\n     */\r\n    public deltaTime(): number {\r\n        const now = performance.now();\r\n        const delta = now - this.lastFrameTime;\r\n        this.lastFrameTime = now;\r\n\r\n        // Normalize to 60fps (16.67ms per frame)\r\n        // Cap at 100ms to prevent huge jumps during lag spikes\r\n        return Math.min(delta, 100) / 16.67;\r\n    }\r\n\r\n    /**\r\n     * Overrides 'setTimeout' with safe processing.\r\n     * \r\n     * Timeouts are stored in the 'activeTimeouts' set - allowing stale timeouts to be cleared.\r\n     */\r\n    public safeTimeout(callback: () => void, delay: number): number {\r\n        const id = window.setTimeout(() => {\r\n            this.activeTimeouts.delete(id);\r\n            callback();\r\n        }, delay);\r\n        this.activeTimeouts.add(id);\r\n        return id;\r\n    }\r\n\r\n    /**\r\n     * Clears all active timeouts from the activeTimeouts cache.\r\n     */\r\n    public clearTimeoutCache(): void {\r\n        this.activeTimeouts.forEach(id => window.clearTimeout(id));\r\n        this.activeTimeouts.clear();\r\n    }\r\n    //\r\n    // #endregion\r\n    //\r\n    // #region [ Math ]\r\n    /**\r\n     * Clamps the passed value between the min/max.\r\n     */\r\n    public clamp(value: number, min: number, max: number): number {\r\n        if (value < min) return min;\r\n        if (value > max) return max;\r\n        return value;\r\n    }\r\n    \r\n    /**\r\n     * Returns a random number.\r\n     * \r\n     * Optionally pass the decimals if you want the returned value trimmed.\r\n     */\r\n    public getRandomNum(min: number, max: number, decimals?: number): number {\r\n        const value = Math.random() * (max - min) + min;\r\n\r\n        if (decimals !== undefined) {\r\n            return parseFloat(value.toFixed(decimals));\r\n        }\r\n\r\n        return value;\r\n    }\r\n\r\n    /**\r\n     * Returns a random int between the passed min/max values.\r\n     */\r\n    public getRandomInt(min: number, max: number): number {\r\n        return Math.floor(Math.random() * (max - min + 1)) + min;\r\n    }\r\n\r\n    /**\r\n     * Returns a random position in an array.\r\n     */\r\n    public getRandomInArray<T>(array: T[]): T {\r\n        return array[Math.floor(Math.random() * array.length)];\r\n    }\r\n\r\n    /**\r\n     * Returns a shuffled copy of an array.\r\n     */\r\n    public getShuffledArray<T>(array: T[]): T[] {\r\n        return array.slice().sort(() => Math.random() - 0.5);\r\n    }\r\n\r\n    /**\r\n     * Returns the dot product of two 2D vectors.\r\n     */\r\n    public getDotProduct(v1: Vec2, v2: Vec2): number {\r\n        return v1.x * v2.x + v1.y * v2.y;\r\n    }\r\n\r\n    /**\r\n     * Reflects a velocity vector off a surface normal.\r\n     * Formula: V' = V - 2(VN)N\r\n     */\r\n    public getReflection(velocity: Vec2, normal: Vec2): Vec2 {\r\n        const dot = this.getDotProduct(velocity, normal);\r\n        return {\r\n            x: velocity.x - 2 * dot * normal.x,\r\n            y: velocity.y - 2 * dot * normal.y\r\n        };\r\n    }\r\n    //\r\n    // #endregion\r\n    //\r\n    // #region [ Direction ]\r\n    //\r\n    /**\r\n     * Returns the forward facing direction of the passed rotation.\r\n     */\r\n    public forward(rot: number): Vec2 {\r\n        return { x: Math.cos(rot), y: Math.sin(rot) };\r\n    }\r\n\r\n    /**\r\n     * Gets the current aim direction of the local player.\r\n     */\r\n    public getDirection(params: Direction): Vec2 {\r\n        const dx = params.targetPos.x - params.rootPos.x;\r\n        const dy = params.targetPos.y - params.rootPos.y;\r\n\r\n        const distance = Math.sqrt(dx * dx + dy * dy);\r\n        if (distance === 0) return { x: 0, y: 0 }; // avoid NaN\r\n\r\n        return { x: dx / distance, y: dy / distance };\r\n    }\r\n\r\n    /**\r\n     * Returns a random based on the degree radius.\r\n     */\r\n    public getRandomDirection(degrees: number): Vec2 {\r\n        const randomAngle = Math.random() * (degrees * Math.PI / 180);\r\n        const direction = { x: Math.cos(randomAngle), y: Math.sin(randomAngle) }\r\n        return direction;\r\n    }\r\n    //\r\n    // #endregion\r\n    //\r\n    // #region [ Visual ]\r\n    /**\r\n     * Returns a random color. With no params passed, color will be completely random hex.\r\n     * \r\n     * Params can be used to return color templates in either hex or RGB.\r\n     */\r\n    public getRandomColor(params?: RandomColorParams): string {\r\n        const format = params?.format ?? 'hex';\r\n        const mode = params?.mode ?? 'any';\r\n\r\n        let hexColor: string;\r\n\r\n        switch (mode) {\r\n            case 'primary':\r\n                const primaries = ['#FF0000', '#00FF00', '#0000FF', '#FFFF00', '#00FFFF', '#FF00FF'];\r\n                hexColor = this.getRandomInArray(primaries);\r\n                break;\r\n\r\n            case 'pastel':\r\n                const r = this.getRandomInt(127, 254);\r\n                const g = this.getRandomInt(127, 254);\r\n                const b = this.getRandomInt(127, 254);\r\n                hexColor = `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;\r\n                break;\r\n\r\n            case 'vibrant':\r\n                const channels = [255, this.getRandomInt(0, 255), this.getRandomInt(0, 255)];\r\n                channels.sort(() => Math.random() - 0.5);\r\n                hexColor = `#${channels[0].toString(16).padStart(2, '0')}${channels[1].toString(16).padStart(2, '0')}${channels[2].toString(16).padStart(2, '0')}`;\r\n                break;\r\n\r\n            case 'dark':\r\n                const dr = this.getRandomInt(0, 127);\r\n                const dg = this.getRandomInt(0, 127);\r\n                const db = this.getRandomInt(0, 127);\r\n                hexColor = `#${dr.toString(16).padStart(2, '0')}${dg.toString(16).padStart(2, '0')}${db.toString(16).padStart(2, '0')}`;\r\n                break;\r\n\r\n            case 'light':\r\n                const lr = this.getRandomInt(128, 255);\r\n                const lg = this.getRandomInt(128, 255);\r\n                const lb = this.getRandomInt(128, 255);\r\n                hexColor = `#${lr.toString(16).padStart(2, '0')}${lg.toString(16).padStart(2, '0')}${lb.toString(16).padStart(2, '0')}`;\r\n                break;\r\n\r\n            case 'grayscale':\r\n                const gray = this.getRandomInt(0, 255);\r\n                hexColor = `#${gray.toString(16).padStart(2, '0')}${gray.toString(16).padStart(2, '0')}${gray.toString(16).padStart(2, '0')}`;\r\n                break;\r\n\r\n            case 'any':\r\n            default:\r\n                hexColor = \"#\" + this.getRandomInt(0, 0xFFFFFF).toString(16).padStart(6, \"0\");\r\n                break;\r\n        }\r\n\r\n        // Convert to requested format\r\n        if (format === 'rgb') {\r\n            const rgb = this.hexToRgb(hexColor);\r\n            if (!rgb) return hexColor; // Fallback to hex if conversion fails\r\n            return `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;\r\n        }\r\n\r\n        return hexColor;\r\n    }\r\n\r\n    /**\r\n     * Returns the lightest color from a hex color array.\r\n     */\r\n    public getLightestColor(colors: string[]): string {\r\n        let lightestColor = colors[0];\r\n        let maxBrightness = 0;\r\n\r\n        for (const color of colors) {\r\n            const r = parseInt(color.slice(1, 3), 16);\r\n            const g = parseInt(color.slice(3, 5), 16);\r\n            const b = parseInt(color.slice(5, 7), 16);\r\n\r\n            // Calculate perceived brightness\r\n            const brightness = (r * 0.299 + g * 0.587 + b * 0.114);\r\n\r\n            if (brightness > maxBrightness) {\r\n                maxBrightness = brightness;\r\n                lightestColor = color;\r\n            }\r\n        }\r\n\r\n        return lightestColor;\r\n    }\r\n\r\n    /**\r\n     * Converts hex color code to RGB.\r\n     */\r\n    public hexToRgb(hex: string): { r: number, g: number, b: number } | null {\r\n        const result = /^#?([a-f\\d]{2})([a-f\\d]{2})([a-f\\d]{2})$/i.exec(hex);\r\n        return result ? {\r\n            r: parseInt(result[1], 16),\r\n            g: parseInt(result[2], 16),\r\n            b: parseInt(result[3], 16)\r\n        } : null;\r\n    }\r\n    //\r\n    // #endregion\r\n    //\r\n    // #region [ Noise ]\r\n    //\r\n    // - Simplex\r\n    /**\r\n     * Generates the permutation table for simplex noise.\r\n     */\r\n    private generateSimplexTable(): Uint8Array {\r\n        const table = new Uint8Array(512);\r\n        for (let k = 0; k < 256; k++) table[k] = k;\r\n        for (let k = 0; k < 256; k++) {\r\n            const r = k + this.getRandomInt(0, 255 - k);\r\n            [table[k], table[r]] = [table[r], table[k]];\r\n        }\r\n        for (let k = 0; k < 256; k++) table[256 + k] = table[k];\r\n        return table;\r\n    }\r\n\r\n    /**\r\n     * 2D noise function using Simplex.\r\n     * \r\n     * https://en.wikipedia.org/wiki/Simplex_noise\r\n     */\r\n    public simplexNoise2D(x: number, y: number, override: boolean = false): number {\r\n        if (override) { this.simplexTable = this.generateSimplexTable(); }\r\n\r\n        const perm = this.simplexTable;\r\n\r\n        const F2 = 0.5 * (Math.sqrt(3.0) - 1.0);\r\n        const G2 = (3.0 - Math.sqrt(3.0)) / 6.0;\r\n\r\n        const s = (x + y) * F2;\r\n        const i = Math.floor(x + s);\r\n        const j = Math.floor(y + s);\r\n\r\n        const t = (i + j) * G2;\r\n        const X0 = i - t;\r\n        const Y0 = j - t;\r\n        const x0 = x - X0;\r\n        const y0 = y - Y0;\r\n\r\n        const i1 = x0 > y0 ? 1 : 0;\r\n        const j1 = x0 > y0 ? 0 : 1;\r\n\r\n        const x1 = x0 - i1 + G2;\r\n        const y1 = y0 - j1 + G2;\r\n        const x2 = x0 - 1.0 + 2.0 * G2;\r\n        const y2 = y0 - 1.0 + 2.0 * G2;\r\n\r\n        const ii = i & 255;\r\n        const jj = j & 255;\r\n\r\n        const gi0 = perm[ii + perm[jj]] % 12;\r\n        const gi1 = perm[ii + i1 + perm[jj + j1]] % 12;\r\n        const gi2 = perm[ii + 1 + perm[jj + 1]] % 12;\r\n\r\n        const grad3 = [[1, 1, 0], [-1, 1, 0], [1, -1, 0], [-1, -1, 0],\r\n        [1, 0, 1], [-1, 0, 1], [1, 0, -1], [-1, 0, -1],\r\n        [0, 1, 1], [0, -1, 1], [0, 1, -1], [0, -1, -1]];\r\n\r\n        const dot = (g: number[], x: number, y: number) => g[0] * x + g[1] * y;\r\n\r\n        let t0 = 0.5 - x0 * x0 - y0 * y0;\r\n        let n0 = t0 < 0 ? 0 : Math.pow(t0, 4) * dot(grad3[gi0], x0, y0);\r\n\r\n        let t1 = 0.5 - x1 * x1 - y1 * y1;\r\n        let n1 = t1 < 0 ? 0 : Math.pow(t1, 4) * dot(grad3[gi1], x1, y1);\r\n\r\n        let t2 = 0.5 - x2 * x2 - y2 * y2;\r\n        let n2 = t2 < 0 ? 0 : Math.pow(t2, 4) * dot(grad3[gi2], x2, y2);\r\n\r\n        return 70.0 * (n0 + n1 + n2);\r\n    }\r\n\r\n    // - Seeded\r\n    //\r\n    /**\r\n     * Helper function to switch between noise types\r\n     */\r\n    public getNoise(noiseType: NoiseType, x: number, y: number, seed: number, options?: any): number {\r\n        switch (noiseType) {\r\n            case NoiseType.Perlin:\r\n                return this.perlinNoise(\r\n                    x,\r\n                    y,\r\n                    seed,\r\n                    options?.octaves ?? 1,\r\n                    options?.persistence ?? 0.5\r\n                );\r\n            case NoiseType.Ridged:\r\n                return this.ridgedNoise(x, y, seed, options?.octaves ?? 1, options?.persistence ?? 0.5);\r\n            case NoiseType.Worley:\r\n                return this.worleyNoise(\r\n                    x,\r\n                    y,\r\n                    seed,\r\n                    Math.max(1, Math.floor(options?.octaves ?? 1))\r\n                );\r\n            case NoiseType.Voronoi:\r\n                return this.voronoiNoise(x, y, seed);\r\n            default:\r\n                return this.perlinNoise(x, y, seed);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Creates a noise pattern deterministically with a seed.\r\n     * \r\n     * Optionally pass the octaves and persistence to effect the noise outcome.\r\n     */\r\n    private perlinNoise(x: number, y: number, seed: number, octaves: number = 1, persistence: number = 1): number {\r\n        let total = 0, frequency = 1, amplitude = 1, maxValue = 0;\r\n        for (let i = 0; i < octaves; i++) {\r\n            total += this.interpolateNoise(x * frequency, y * frequency, seed + i * 1000) * amplitude;\r\n            maxValue += amplitude;\r\n            amplitude *= persistence;\r\n            frequency *= 2;\r\n        }\r\n        return total / maxValue;\r\n    }\r\n\r\n    private ridgedNoise(x: number, y: number, seed: number, octaves: number = 1, persistence: number = 0.5): number {\r\n        let total = 0;\r\n        let frequency = 1;\r\n        let amplitude = 1;\r\n        let maxValue = 0;\r\n\r\n        for (let i = 0; i < octaves; i++) {\r\n            let noise = this.interpolateNoise(x * frequency, y * frequency, seed + i * 1000);\r\n            noise = 1 - Math.abs(noise); // Invert to create ridges\r\n            total += noise * amplitude;\r\n            maxValue += amplitude;\r\n            amplitude *= persistence;\r\n            frequency *= 2;\r\n        }\r\n\r\n        return total / maxValue; // Already [0,1] because of the inversion\r\n    }\r\n\r\n    private worleyNoise(x: number, y: number, seed: number, pointsPerCell: number = 1): number {\r\n        const cellX = Math.floor(x);\r\n        const cellY = Math.floor(y);\r\n        let minDist = Infinity;\r\n\r\n        // Check 3x3 neighborhood\r\n        for (let dx = -1; dx <= 1; dx++) {\r\n            for (let dy = -1; dy <= 1; dy++) {\r\n                const cx = cellX + dx;\r\n                const cy = cellY + dy;\r\n\r\n                for (let p = 0; p < pointsPerCell; p++) {\r\n                    // Use hash to get pseudo-random point in cell [0,1)\r\n                    const px = cx + this.hash2D(cx, cy, seed + p * 10000);\r\n                    const py = cy + this.hash2D(cx, cy, seed + p * 10000 + 1);\r\n                    const dx = x - px;\r\n                    const dy = y - py;\r\n                    const dist = Math.sqrt(dx * dx + dy * dy);\r\n                    if (dist < minDist) minDist = dist;\r\n                }\r\n            }\r\n        }\r\n\r\n        // Normalize: max distance in unit grid is ~1.5\r\n        return this.normalize(minDist / 1.5);\r\n    }\r\n\r\n    private voronoiNoise(x: number, y: number, seed: number): number {\r\n        return this.worleyNoise(x, y, seed, 1);\r\n    }\r\n    // - Noise Helpers\r\n    //\r\n    /**\r\n     * Generates a deterministic pseudo-random value from integer coordinates and a seed.\r\n     * \r\n     * Uses a fast 2D hash function to produce a normalized float in [0, 1].\r\n     */\r\n    public hash2D(x: number, y: number, seed: number): number {\r\n        const n = x * 374761393 + y * 668265263 + seed;\r\n        const hash = (n ^ (n >> 13)) * 1274126177;\r\n        return ((hash ^ (hash >> 16)) & 0x7fffffff) / 0x7fffffff;\r\n    }\r\n\r\n    /**\r\n     * Helper function to interpolate the seededNoise function.\r\n     * \r\n     * Performs bilinear interpolation with smoothstep weighting between four hashed grid points.\r\n     */\r\n    private interpolateNoise(x: number, y: number, seed: number): number {\r\n        const ix = Math.floor(x), fx = x - ix;\r\n        const iy = Math.floor(y), fy = y - iy;\r\n\r\n        const v1 = this.hash2D(ix, iy, seed);\r\n        const v2 = this.hash2D(ix + 1, iy, seed);\r\n        const v3 = this.hash2D(ix, iy + 1, seed);\r\n        const v4 = this.hash2D(ix + 1, iy + 1, seed);\r\n\r\n        const sx = this.smoothstep(fx);\r\n        const sy = this.smoothstep(fy);\r\n\r\n        const i1 = this.lerp(v1, v2, sx);\r\n        const i2 = this.lerp(v3, v4, sx);\r\n        return this.lerp(i1, i2, sy);\r\n    }\r\n\r\n    /** Smoothly blends from 0 to 1. */\r\n    public smoothstep(t: number): number { return t * t * (3 - 2 * t); }\r\n\r\n    /** Linear blend between a and b. */\r\n    public lerp(a: number, b: number, t: number): number { return a + (b - a) * t; }\r\n\r\n    /** Normalizes a value. */\r\n    public normalize(value: number): number { return Math.max(0, Math.min(1, value)); }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Generation ]\r\n    //\r\n    /**\r\n     * Returns a UID using pure random math. With 36 characters defined - 8 character long UID has ~2.8 trillion outcomes.\r\n     */\r\n    public generateUID(length: number, prefix?: string): string {\r\n        const chars = '0123456789abcdefghijklmnopqrstuvwxyz';\r\n        let result = prefix ?? '';\r\n        for (let i = 0; i < length; i++) {\r\n            result += chars[this.getRandomInt(0, chars.length - 1)];\r\n        }\r\n        return result;\r\n    }\r\n\r\n    /**\r\n     * Generate a custom link using the url from the window object.\r\n     * \r\n     * Example: generateLink(abc123, 'room'); Result: https://www.link.com/?room=abc123\r\n     */\r\n    public generateLink(value: string, param?: string): string {\r\n        const base = window.location.origin;\r\n        if (param) {\r\n            return `${base}?${param}=${value}`;\r\n        }\r\n        return `${base}?${value}`;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ DOM ]\r\n    //\r\n    /**\r\n     * Sets the value of the chosen HTMLInputElement in the DOM.\r\n     */\r\n    public setInput(params: SetInputParams): void {\r\n        const inputElement = document.getElementById(params.inputId) as HTMLInputElement | null;\r\n        if (inputElement) {\r\n            inputElement.value = params.value.toString();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Sets a specific slider to a specific value.\r\n     * \r\n     * Slider must have a base element and a fill element. Optionally lerp the value between the target and the current, using the max.\r\n     */\r\n    public setSlider(params: SetSliderParams): void {\r\n        const { sliderId, targetValue, maxValue, lerpTime = 0 } = params;\r\n\r\n        const sliderContainer = document.getElementById(sliderId);\r\n        const sliderFill = sliderContainer?.querySelector('div') as HTMLElement;\r\n\r\n        if (!sliderContainer || !sliderFill) {\r\n            console.warn(`Slider not found: ${sliderId}...`);\r\n            return;\r\n        }\r\n\r\n        if (maxValue === 0) {\r\n            console.warn(\"maxValue cannot be 0...\");\r\n            return;\r\n        }\r\n\r\n        // Clamp target value between 0 and maxValue\r\n        const clampedTarget = Math.max(0, Math.min(maxValue, targetValue));\r\n        const targetPercentage = (clampedTarget / maxValue) * 100;\r\n\r\n        // Get current width percentage\r\n        const currentWidthStr = sliderFill.style.width || '100%';\r\n        const currentPercentage = parseFloat(currentWidthStr.replace('%', ''));\r\n\r\n        // If already at target, no animation needed\r\n        if (Math.abs(currentPercentage - targetPercentage) < 0.1) return;\r\n\r\n        // If lerpTime is <= 0, directly set the slider to the targetValue\r\n        if (lerpTime <= 0) {\r\n            sliderFill.style.transition = 'none';\r\n            sliderFill.style.width = `${targetPercentage}%`;\r\n            return;\r\n        }\r\n\r\n        // Animate using CSS transition\r\n        sliderFill.style.transition = `width ${lerpTime}ms ease-out`;\r\n        sliderFill.style.width = `${targetPercentage}%`;\r\n\r\n        // Clear transition after animation completes to avoid interfering with future updates\r\n        setTimeout(() => {\r\n            if (sliderFill) {\r\n                sliderFill.style.transition = '';\r\n            }\r\n        }, lerpTime);\r\n    }\r\n\r\n    /**\r\n     * Update a span element with a specific number or string.\r\n     */\r\n    public setSpan(params: SetSpanParams): void {\r\n        const spanElement = document.getElementById(params.spanId);\r\n\r\n        if (!spanElement) {\r\n            console.warn(`Span not found: ${params.spanId}`);\r\n            return;\r\n        }\r\n\r\n        spanElement.textContent = params.value.toString();\r\n    }\r\n\r\n    /**\r\n     * Updates the attributes of a toggle element for reference.\r\n     */\r\n    public setToggle(params: SetToggleParams): void {\r\n        const toggle = document.getElementById(params.toggleId);\r\n        if (toggle) {\r\n            if (params.value) {\r\n                toggle.setAttribute('checked', 'true');\r\n                toggle.setAttribute('aria-checked', 'true');\r\n            } else {\r\n                toggle.removeAttribute('checked');\r\n                toggle.setAttribute('aria-checked', 'false');\r\n            }\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Animation ]\r\n    //\r\n    /**\r\n     * Can be used to animate most elements with text on the page.\r\n     * \r\n     * Element must have '.style.color' and '.textContent'.\r\n     */\r\n    public animateTextInElement(params: TextAnimParams): void {\r\n        const increment = (params.newValue - params.oldValue) / params.steps;\r\n        const stepTime = params.animTime / params.steps;\r\n\r\n        let currentStep = 0;\r\n        let currentValue = params.oldValue;\r\n\r\n        // Set color\r\n        params.element.style.color = params.color;\r\n\r\n        const interval = setInterval(() => {\r\n            currentStep++;\r\n            currentValue += increment;\r\n\r\n            if (currentStep >= params.steps) {\r\n                params.element.textContent = params.newValue.toFixed(params.decimals);\r\n                clearInterval(interval);\r\n\r\n                // Reset color after animation\r\n                setTimeout(() => {\r\n                    params.element.style.color = '';\r\n                }, params.timeout);\r\n            } else {\r\n                params.element.textContent = currentValue.toFixed(params.decimals);\r\n            }\r\n        }, stepTime);\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { GAME } from \"./Config\";\r\n\r\nimport { GameState } from \"./GameState\";\r\nimport { RoomManager } from \"./RoomManager\";\r\nimport { Utility } from \"./Utility\";\r\n\r\nexport class WebsocketManager {\r\n    private ws: WebSocket | null = null;\r\n\r\n    constructor(\r\n        private gameState: GameState,\r\n        private roomManager: RoomManager,\r\n        private utility: Utility\r\n    ) { }\r\n\r\n    /**\r\n     * Used for creating the websocket connection between clients.\r\n     * \r\n     * Called when joining or creating a room.\r\n     */\r\n    public connectWebSocket(): void {\r\n        const wsProtocol = location.protocol === \"https:\" ? \"wss:\" : \"ws:\";\r\n        let wsHost: string;\r\n\r\n        if (location.port === '8888') { // Electron testing  connect to localhost:8080\r\n            wsHost = 'localhost:8080';\r\n            this.ws = new WebSocket(`ws://${wsHost}`);\r\n        } else if (location.port === '9999') { // Electron production  connect to saltpeter.xyz\r\n            wsHost = 'saltpeter.xyz';\r\n            this.ws = new WebSocket(`wss://${wsHost}`);\r\n        } else { // Browser (not Electron)\r\n            wsHost = location.hostname === 'localhost' ? 'localhost:8080' : location.host;\r\n            this.ws = new WebSocket(`${wsProtocol}//${wsHost}`);\r\n        }\r\n\r\n        this.ws.onopen = () => {\r\n            console.log(\"Connected to WebSocket\");\r\n            this.roomManager.setWebSocket(this.ws!);\r\n        };\r\n\r\n        this.ws.onclose = () => {\r\n            console.log(\"Disconnected from WebSocket\");\r\n            this.gameState.gameInProgress = false;\r\n            this.utility.safeTimeout(() => this.connectWebSocket(), GAME.RECONNECT_DELAY);\r\n        };\r\n\r\n        this.ws.onerror = (error) => {\r\n            console.error(\"WebSocket error:\", error);\r\n        };\r\n    }\r\n\r\n\r\n    /**\r\n     * Returns the current WebSocket connection.\r\n     */\r\n    public getWebSocket(): WebSocket | null {\r\n        return this.ws;\r\n    }\r\n}","import { AudioMixer, AudioMixerName, ImpactSFX, WeaponSFX } from \"../Types\"\r\n\r\nexport class AudioConfig {\r\n    public mixer: Record<AudioMixerName, AudioMixer> = {\r\n        master: { out: null, volume: 1.0 },\r\n        ambience: { out: 'master', volume: 0.5 },\r\n        music: { out: 'master', volume: 0.75 },\r\n        sfx: { out: 'master', volume: 0.9 },\r\n        voice: { out: 'master', volume: 1.0 }\r\n    }\r\n\r\n    public resources = {\r\n        sfx: {\r\n            impact: {\r\n                flesh: {\r\n                    ranged: [\r\n                        '/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_00.ogg',\r\n                        '/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_01.ogg',\r\n                        '/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_02.ogg',\r\n                        '/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_03.ogg',\r\n                        '/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_04.ogg',\r\n                        '/assets/audio/sfx/impact/flesh/bullet/impact_flesh_bullet_05.ogg'\r\n                    ],\r\n                    melee: []\r\n                },\r\n                metal: {\r\n                    ranged: [\r\n                        '/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_00.ogg',\r\n                        '/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_01.ogg',\r\n                        '/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_02.ogg',\r\n                        '/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_03.ogg',\r\n                        '/assets/audio/sfx/impact/metal/bullet/impact_metal_bullet_04.ogg'\r\n                    ],\r\n                    melee: []\r\n                }\r\n            } as ImpactSFX,\r\n            player: {\r\n                locomotion: {\r\n                    footsteps: {\r\n                        dirt: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_dirt_06.ogg'\r\n                        ],\r\n                        grass: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_grass_06.ogg'\r\n                        ],\r\n                        gravel: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_gravel_06.ogg'\r\n                        ],\r\n                        mud: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_mud_06.ogg'\r\n                        ],\r\n                        sand: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_06.ogg'\r\n                        ],\r\n                        sand_wet: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_sand_wet_06.ogg'\r\n                        ],\r\n                        silt: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_06.ogg'\r\n                        ],\r\n                        silt_wet: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_silt_wet_06.ogg'\r\n                        ],\r\n                        snow: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_06.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_snow_07.ogg'\r\n                        ],\r\n                        stone: [\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_00.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_01.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_02.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_03.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_04.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_05.ogg',\r\n                            '/assets/audio/sfx/player/locomotion/footsteps/footstep_stone_06.ogg'\r\n                        ],\r\n                        water: {\r\n                            light: [\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_00.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_01.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_02.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_03.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_04.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_light_05.ogg'\r\n                            ],\r\n                            medium: [\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_00.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_01.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_02.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_03.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_04.ogg',\r\n                                '/assets/audio/sfx/player/locomotion/footsteps/footstep_water_medium_05.ogg'\r\n                            ]\r\n                        }\r\n                    }\r\n                },\r\n                voice: {\r\n                    voice_00: {\r\n                        grunt: [\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_00.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_01.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_02.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_03.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_04.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_05.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_06.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_07.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_08.ogg',\r\n                            '/assets/audio/sfx/player/voice/00/player_voice_00_hit_09.ogg'\r\n                        ]\r\n                    },\r\n                    voice_01: {\r\n                        grunt: [\r\n                            '/assets/audio/sfx/player/voice/01/player_voice_01_hit_00.ogg',\r\n                            '/assets/audio/sfx/player/voice/01/player_voice_01_hit_01.ogg',\r\n                            '/assets/audio/sfx/player/voice/01/player_voice_01_hit_02.ogg',\r\n                            '/assets/audio/sfx/player/voice/01/player_voice_01_hit_03.ogg',\r\n                            '/assets/audio/sfx/player/voice/01/player_voice_01_hit_04.ogg',\r\n                            '/assets/audio/sfx/player/voice/01/player_voice_01_hit_05.ogg',\r\n                            '/assets/audio/sfx/player/voice/01/player_voice_01_hit_06.ogg'\r\n                        ]\r\n                    }\r\n                }\r\n            },\r\n            weapon: {\r\n                glock: {\r\n                    attack: [\r\n                        '/assets/audio/sfx/weapons/glock/attack/glock_attack_00.ogg',\r\n                        '/assets/audio/sfx/weapons/glock/attack/glock_attack_01.ogg',\r\n                        '/assets/audio/sfx/weapons/glock/attack/glock_attack_02.ogg',\r\n                        '/assets/audio/sfx/weapons/glock/attack/glock_attack_03.ogg',\r\n                        '/assets/audio/sfx/weapons/glock/attack/glock_attack_04.ogg',\r\n                        '/assets/audio/sfx/weapons/glock/attack/glock_attack_05.ogg'\r\n                    ],\r\n                    empty: [\r\n                        '/assets/audio/sfx/weapons/glock/empty/glock_empty_00.ogg'\r\n                    ],\r\n                    reload: {\r\n                        end: [\r\n                            '/assets/audio/sfx/weapons/glock/reload/glock_reload_end_00.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/reload/glock_reload_end_01.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/reload/glock_reload_end_02.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/reload/glock_reload_end_03.ogg'\r\n\r\n                        ],\r\n                        start: [\r\n                            '/assets/audio/sfx/weapons/glock/reload/glock_reload_start_00.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/reload/glock_reload_start_01.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/reload/glock_reload_start_02.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/reload/glock_reload_start_03.ogg'\r\n                        ]\r\n                    },\r\n                    shell: {\r\n                        hard: [\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_00.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_01.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_02.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_03.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_04.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_05.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_06.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_07.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_08.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_09.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_10.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_11.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_12.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_13.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_hard_14.ogg'\r\n                        ],\r\n                        soft: [\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_00.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_01.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_02.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_03.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_04.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_05.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_06.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_07.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_soft_08.ogg'\r\n                        ],\r\n                        water: [\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_water_00.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_water_01.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_water_02.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_water_03.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_water_04.ogg',\r\n                            '/assets/audio/sfx/weapons/glock/shell/glock_shell_water_05.ogg'\r\n                        ]\r\n                    }\r\n                }\r\n            } as WeaponSFX\r\n        },\r\n        ambience: {\r\n            beds: {\r\n                app: ['/assets/audio/ambience/beds/env_app_00.ogg'],\r\n                cliffs: ['/assets/audio/ambience/beds/env_cliffs_00.ogg'],\r\n                mountains: ['/assets/audio/ambience/beds/env_mountains_00.ogg'],\r\n                ocean: ['/assets/audio/ambience/beds/env_ocean_00.ogg'],\r\n                plains: ['/assets/audio/ambience/beds/env_plains_00.ogg'],\r\n                shore: ['/assets/audio/ambience/beds/env_shore_00.ogg']\r\n            }\r\n        }\r\n    }\r\n\r\n    constructor() { }\r\n}","import { WORLD } from \"../Config\";\r\nimport { ActiveAudio, AudioFileType, AudioMixer, AudioMixerName, AudioParams } from \"../Types\";\r\n\r\nimport { RoomManager } from \"../RoomManager\";\r\nimport { SettingsManager } from \"../SettingsManager\";\r\nimport { Utility } from \"../Utility\";\r\n\r\nexport class AudioManager {\r\n    private audioContext: AudioContext;\r\n\r\n    private buffers: Map<string, AudioBuffer> = new Map();\r\n    private mixers: Map<AudioMixerName, GainNode> = new Map();\r\n\r\n    private loops: Set<{ source: AudioBufferSourceNode; gain: GainNode; params: AudioParams }> = new Set();\r\n\r\n    constructor(\r\n        private roomManager: RoomManager,\r\n        private settingsManager: SettingsManager,\r\n        private utility: Utility\r\n    ) {\r\n        this.audioContext = new AudioContext();\r\n        this.initMixers();\r\n    }\r\n\r\n    /**\r\n     * Initializes mixers and sets gains based on stored settings.\r\n     */\r\n    private initMixers(): void {\r\n        const mixer = this.settingsManager.getSettings().audio.mixer;\r\n\r\n        for (const name in mixer) {\r\n            const gain = this.audioContext.createGain();\r\n            gain.connect(this.audioContext.destination);\r\n            this.mixers.set(name as AudioMixerName, gain);\r\n        }\r\n\r\n        this.updateMixerGains();\r\n    }\r\n\r\n    /**\r\n     * Updates the gain for all mixers.\r\n     */\r\n    public updateMixerGains(): void {\r\n        for (const [name, gain] of this.mixers) {\r\n            gain.gain.value = this.getMixerVolume(name);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Gets the volume for a specific mixer.\r\n     */\r\n    private getMixerVolume(name: AudioMixerName): number {\r\n        const mixer = this.settingsManager.getSettings().audio.mixer;\r\n        let total = 1.0;\r\n        let current: AudioMixer | null = mixer[name];\r\n\r\n        while (current !== null) {\r\n            total *= current.volume;\r\n            current = current.out ? mixer[current.out] : null;\r\n        }\r\n\r\n        return total;\r\n    }\r\n\r\n    /**\r\n     * Preloads audio from the object passed.\r\n     * \r\n     * The object should contain an array of sounds.\r\n     */\r\n    public async preloadAudio(sounds: any, extension: AudioFileType): Promise<void> {\r\n        const promises: Promise<void>[] = [];\r\n\r\n        for (const key in sounds) {\r\n            const value = sounds[key];\r\n\r\n            if (Array.isArray(value)) {\r\n                value.forEach(src => {\r\n                    if (typeof src === 'string' && src.endsWith(extension)) {\r\n                        promises.push(this.loadSound(src));\r\n                    }\r\n                });\r\n            } else if (typeof value === 'object' && value !== null) {\r\n                promises.push(this.preloadAudio(value, extension));\r\n            }\r\n        }\r\n\r\n        await Promise.all(promises);\r\n    }\r\n\r\n    /**\r\n     * Loads a specific sound and creates a buffer for the file.\r\n     */\r\n    private async loadSound(src: string): Promise<void> {\r\n        if (this.buffers.has(src)) return;\r\n\r\n        try {\r\n            const response = await fetch(src);\r\n            const arrayBuffer = await response.arrayBuffer();\r\n            const audioBuffer = await this.audioContext.decodeAudioData(arrayBuffer);\r\n            this.buffers.set(src, audioBuffer);\r\n        } catch (error) {\r\n            console.error(`Failed to load audio: ${src}`, error);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Triggers audio playback.\r\n     */\r\n    public playAudio(params: AudioParams): ActiveAudio | null {\r\n        const buffer = this.buffers.get(params.src);\r\n        if (!buffer) {\r\n            console.warn(`Audio not loaded: ${params.src}`);\r\n            return null;\r\n        }\r\n\r\n        if (this.audioContext.state === 'suspended') {\r\n            this.audioContext.resume();\r\n        }\r\n\r\n        const category: AudioMixerName = params.output || \"master\";\r\n        const mixerGain = this.mixers.get(category);\r\n        if (!mixerGain) {\r\n            console.warn(`No mixer found: ${category}`);\r\n            return null;\r\n        }\r\n\r\n        const source = this.audioContext.createBufferSource();\r\n        const gainNode = this.audioContext.createGain();\r\n        const panNode = this.audioContext.createStereoPanner();\r\n\r\n        source.buffer = buffer;\r\n        source.loop = params.loop ?? false;\r\n\r\n        if (params.pitch) {\r\n            const pitch = this.utility.getRandomNum(params.pitch.min, params.pitch.max);\r\n            source.playbackRate.value = Math.max(0.25, Math.min(4, pitch));\r\n        }\r\n\r\n        let volume = 1.0;\r\n        if (params.volume) {\r\n            volume = this.utility.getRandomNum(params.volume.min, params.volume.max);\r\n        }\r\n\r\n        const blend = params.spatial?.blend ?? 0;\r\n\r\n        if (blend > 0 && params.spatial?.pos && params.listener) {\r\n            const dx = params.spatial.pos.x - params.listener.x;\r\n            const dy = params.spatial.pos.y - params.listener.y;\r\n            const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n            let distanceVolume: number;\r\n\r\n            if (params.spatial.rolloff) {\r\n                const rolloffType = params.spatial.rolloff.type || 'linear';\r\n                const factor = params.spatial.rolloff.factor;\r\n                const maxDistance = params.spatial.rolloff.distance;\r\n\r\n                if (rolloffType === 'logarithmic') {\r\n                    const referenceDistance = maxDistance * factor;\r\n                    if (distance < referenceDistance) {\r\n                        distanceVolume = 1.0;\r\n                    } else {\r\n                        const normalizedDistance = (distance - referenceDistance) / (maxDistance - referenceDistance);\r\n                        distanceVolume = Math.max(0, 1 - Math.pow(normalizedDistance, 0.5));\r\n                    }\r\n                } else {\r\n                    distanceVolume = Math.max(0, 1 - (distance / maxDistance) * factor);\r\n                }\r\n            } else {\r\n                const maxDistance = Math.max(WORLD.WIDTH, WORLD.HEIGHT);\r\n                distanceVolume = Math.max(0, 1 - (distance / maxDistance));\r\n            }\r\n\r\n            volume *= (1 - blend) + (distanceVolume * blend);\r\n\r\n            // Calculate stereo pan\r\n            const maxDistance = params.spatial.rolloff?.distance || Math.max(WORLD.WIDTH, WORLD.HEIGHT);\r\n            const panValue = Math.max(-1, Math.min(1, dx / (maxDistance / 2)));\r\n            panNode.pan.value = panValue;\r\n        } else {\r\n            panNode.pan.value = 0; // Center for non-spatial sounds\r\n        }\r\n\r\n        gainNode.gain.value = Math.max(0, Math.min(1, volume));\r\n\r\n        source.connect(gainNode);\r\n        gainNode.connect(panNode);\r\n        panNode.connect(mixerGain);\r\n\r\n        if (params.loop) {\r\n            this.loops.add({ source, gain: gainNode, params });\r\n        }\r\n\r\n        source.onended = () => {\r\n            const loopEntry = Array.from(this.loops).find(l => l.source === source);\r\n            if (loopEntry) this.loops.delete(loopEntry);\r\n            gainNode.disconnect();\r\n        };\r\n\r\n        let startOffset = 0;\r\n        if (params.startTime) {\r\n            startOffset = this.utility.getRandomNum(params.startTime.min, params.startTime.max);\r\n        }\r\n\r\n        let delayMs = 0;\r\n        if (params.delay) {\r\n            delayMs = this.utility.getRandomNum(params.delay.min, params.delay.max) * 1000;\r\n        }\r\n\r\n        const activeAudio: ActiveAudio = {\r\n            setVolume: (v: number) => {\r\n                gainNode.gain.value = Math.max(0, Math.min(1, v));\r\n            },\r\n            stop: () => {\r\n                try {\r\n                    source.stop();\r\n                } catch (e) {\r\n                    // Already stopped\r\n                }\r\n                const loopEntry = Array.from(this.loops).find(l => l.source === source);\r\n                if (loopEntry) this.loops.delete(loopEntry);\r\n            }\r\n        };\r\n\r\n        this.utility.safeTimeout(() => {\r\n            try {\r\n                source.start(0, startOffset);\r\n            } catch (error) {\r\n                console.warn('Audio play failed:', error);\r\n            }\r\n        }, delayMs);\r\n\r\n        return activeAudio;\r\n    }\r\n\r\n    /**\r\n     * Triggers audio playback over the network.\r\n     */\r\n    public playAudioNetwork(params: AudioParams): void {\r\n        this.playAudio(params);\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'play-audio',\r\n            params: params\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Refreshes all currently active loops.\r\n     */\r\n    public refreshActiveLoops(): void {\r\n        const records = Array.from(this.loops);\r\n\r\n        for (const record of records) {\r\n            this.loops.delete(record);\r\n            try {\r\n                record.source.stop();\r\n            } catch (e) {\r\n                // Already stopped\r\n            }\r\n            this.playAudio(record.params);\r\n        }\r\n    }\r\n}","export class ChatConfig {\r\n    public defaults = {\r\n        maxMessages: 100,\r\n        maxMessageLength: 200\r\n    };\r\n\r\n    constructor() { }\r\n}","import { ChatMessage } from \"../Types\";\r\n\r\nimport { ChatConfig } from \"./ChatConfig\";\r\nimport { RoomManager } from \"../RoomManager\";\r\nimport { UserInterface } from \"../UserInterface\";\r\n\r\nexport class ChatManager {\r\n    public chatConfig: ChatConfig;\r\n\r\n    constructor(private roomManager: RoomManager, private ui: UserInterface) { \r\n        this.chatConfig = new ChatConfig();\r\n    }\r\n\r\n    /**\r\n     * Resets the chat.\r\n     */\r\n    public clear(): void {\r\n        if (this.ui.chatMessages) {\r\n            this.ui.chatMessages.innerHTML = '';\r\n        }\r\n        if (this.ui.chatInput) {\r\n            this.ui.chatInput.value = '';\r\n        }\r\n    }\r\n\r\n    // #region [ Chat Management ]\r\n    //\r\n    /**\r\n     * Sends a message in the chat.\r\n     */\r\n    public sendChatMessage(userId: string): void {\r\n        if (!this.ui.chatInput || !this.ui.chatInput.value.trim()) return;\r\n\r\n        const message = this.ui.chatInput.value.trim();\r\n        if (message.length > this.chatConfig.defaults.maxMessageLength) {\r\n            alert(`Message too long! Max ${this.chatConfig.defaults.maxMessageLength} characters.`);\r\n            return;\r\n        }\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'chat-message',\r\n            message: message,\r\n            timestamp: Date.now()\r\n        }));\r\n\r\n        // Display my message and clear input field\r\n        this.displayChatMessage({senderId: userId, message: message, isOwn: true});\r\n        this.ui.chatInput.value = '';\r\n    }\r\n\r\n    /**\r\n     * Displayes messages sent in the chat.\r\n     */\r\n    public displayChatMessage(params: ChatMessage): void {\r\n        if (!this.ui.chatMessages) return;\r\n        const { senderId, message, isOwn = false } = params;\r\n\r\n        const messageDiv = document.createElement('div');\r\n        messageDiv.className = `chat_message ${isOwn ? 'own' : 'other'}`;\r\n\r\n        const senderSpan = document.createElement('span');\r\n        senderSpan.className = 'sender';\r\n        senderSpan.textContent = isOwn ? 'You:' : `${senderId}:`;\r\n\r\n        const contentSpan = document.createElement('span');\r\n        contentSpan.className = 'content';\r\n        contentSpan.textContent = message;\r\n\r\n        messageDiv.appendChild(senderSpan);\r\n        messageDiv.appendChild(contentSpan);\r\n\r\n        this.ui.chatMessages.appendChild(messageDiv);\r\n\r\n        // Scroll to bottom\r\n        this.ui.chatMessages.scrollTop = this.ui.chatMessages.scrollHeight;\r\n\r\n        // Limit message history\r\n        while (this.ui.chatMessages.children.length > this.chatConfig.defaults.maxMessages) {\r\n            this.ui.chatMessages.removeChild(this.ui.chatMessages.firstChild!);\r\n        }\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n}","import { GoreParticles, MaterialParticles, ParticleParams, WeaponParticles } from \"../Types\";\r\n\r\nexport class ParticlesConfig {\r\n    public goreParticles: Record<string, GoreParticles> = {\r\n        blood: {\r\n            drip: {\r\n                count: {\r\n                    min: 1,\r\n                    max: 4\r\n                },\r\n                lifetime: {\r\n                    min: 800,\r\n                    max: 1000\r\n                },\r\n                noise: {\r\n                    strength: {\r\n                        min: 0,\r\n                        max: 0\r\n                    },\r\n                    scale: {\r\n                        min: 0,\r\n                        max: 0\r\n                    }\r\n                },\r\n                opacity: {\r\n                    min: 0.25,\r\n                    max: 0.75\r\n                },\r\n                speed: {\r\n                    min: 0.25,\r\n                    max: 0.75\r\n                },\r\n                sizeOverLifetime: {\r\n                    min: 0,\r\n                    max: 0\r\n                },\r\n                size: {\r\n                    min: 0.125,\r\n                    max: 2.275\r\n                },\r\n                torque: {\r\n                    min: -720,\r\n                    max: 720\r\n                },\r\n                collide: true,\r\n                fade: true,\r\n                paint: false,\r\n                spread: 0.25,\r\n                stain: true,\r\n                colors: [\"#690303\", \"#820c0c\", \"#a70707\"]\r\n            } as ParticleParams,\r\n            spray: {\r\n                count: {\r\n                    min: 4,\r\n                    max: 12\r\n                },\r\n                lifetime: {\r\n                    min: 150,\r\n                    max: 1200\r\n                },\r\n                noise: {\r\n                    strength: {\r\n                        min: 0,\r\n                        max: 0\r\n                    },\r\n                    scale: {\r\n                        min: 0,\r\n                        max: 0\r\n                    }\r\n                },\r\n                opacity: {\r\n                    min: 0.425,\r\n                    max: 0.775\r\n                },\r\n                speed: {\r\n                    min: 1.5,\r\n                    max: 4.75\r\n                },\r\n                sizeOverLifetime: {\r\n                    min: 0,\r\n                    max: 0\r\n                },\r\n                size: {\r\n                    min: 0.75,\r\n                    max: 3.5\r\n                },\r\n                torque: {\r\n                    min: -720,\r\n                    max: 720\r\n                },\r\n                collide: true,\r\n                fade: false,\r\n                paint: true,\r\n                spread: 0.425,\r\n                stain: true,\r\n                colors: [\"#7e0a0a\", \"#941414\", \"#b51a1a\"]\r\n            } as ParticleParams,\r\n        }\r\n    };\r\n\r\n    public weaponParticles: Record<string, WeaponParticles> = {\r\n        glock: {\r\n            muzzle: {\r\n                smoke: {\r\n                    count: {\r\n                        min: 3,\r\n                        max: 6\r\n                    },\r\n                    lifetime: {\r\n                        min: 800,\r\n                        max: 1400\r\n                    },\r\n                    noise: {\r\n                        strength: {\r\n                            min: 0,\r\n                            max: 0\r\n                        },\r\n                        scale: {\r\n                            min: 0,\r\n                            max: 0\r\n                        }\r\n                    },\r\n                    opacity: {\r\n                        min: 0.15,\r\n                        max: 0.35\r\n                    },\r\n                    speed: {\r\n                        min: 0.5,\r\n                        max: 1.5\r\n                    },\r\n                    size: {\r\n                        min: 4,\r\n                        max: 8\r\n                    },\r\n                    sizeOverLifetime: {\r\n                        min: 2,\r\n                        max: 3\r\n                    },\r\n                    torque: {\r\n                        min: -180,\r\n                        max: 180\r\n                    },\r\n                    collide: false,\r\n                    fade: true,\r\n                    paint: false,\r\n                    spread: 0.4,\r\n                    stain: false,\r\n                    colors: [\"#5a5a5a\", \"#7a7a7a\"]\r\n                } as ParticleParams,\r\n                flash: {\r\n                    count: {\r\n                        min: 8,\r\n                        max: 15\r\n                    },\r\n                    lifetime: {\r\n                        min: 150,\r\n                        max: 300\r\n                    },\r\n                    noise: {\r\n                        strength: {\r\n                            min: 0,\r\n                            max: 0\r\n                        },\r\n                        scale: {\r\n                            min: 0,\r\n                            max: 0\r\n                        }\r\n                    },\r\n                    opacity: {\r\n                        min: 0.4,\r\n                        max: 0.8\r\n                    },\r\n                    speed: {\r\n                        min: 4,\r\n                        max: 10\r\n                    },\r\n                    sizeOverLifetime: {\r\n                        min: 0,\r\n                        max: 0\r\n                    },\r\n                    size: {\r\n                        min: 1,\r\n                        max: 3\r\n                    },\r\n                    torque: {\r\n                        min: 0,\r\n                        max: 0\r\n                    },\r\n                    collide: false,\r\n                    fade: true,\r\n                    paint: false,\r\n                    spread: 0.6,\r\n                    stain: false,\r\n                    colors: [\"#ffaa00\", \"#f3b02a\", \"#edbe60\"]\r\n                } as ParticleParams,\r\n            },\r\n            projectile: {\r\n                shell: {\r\n                    count: {\r\n                        min: 1,\r\n                        max: 1\r\n                    },\r\n                    lifetime: {\r\n                        min: 250,\r\n                        max: 550\r\n                    },\r\n                    noise: {\r\n                        strength: {\r\n                            min: 0,\r\n                            max: 0\r\n                        },\r\n                        scale: {\r\n                            min: 0,\r\n                            max: 0\r\n                        }\r\n                    },\r\n                    opacity: {\r\n                        min: 1.0,\r\n                        max: 1.0\r\n                    },\r\n                    speed: {\r\n                        min: 5,\r\n                        max: 8\r\n                    },\r\n                    sizeOverLifetime: {\r\n                        min: 0,\r\n                        max: 0\r\n                    },\r\n                    size: {\r\n                        min: 2,\r\n                        max: 2\r\n                    },\r\n                    torque: {\r\n                        min: -720,\r\n                        max: 720\r\n                    },\r\n                    collide: true,\r\n                    fade: false,\r\n                    paint: true,\r\n                    spread: 0.4,\r\n                    stain: false,\r\n                    colors: [\"#d4af37\", \"#c69e1c\", \"#dcb01f\"]\r\n                } as ParticleParams\r\n            }\r\n        }\r\n    }\r\n\r\n    public materialParticles: Record<string, MaterialParticles> = {\r\n        metal: {\r\n            ranged: {\r\n                count: { min: 8, max: 16 },\r\n                lifetime: { min: 150, max: 300 },\r\n                noise: {\r\n                    strength: { min: 0.25, max: 5 },\r\n                    scale: { min: 0.25, max: 1.5 }\r\n                },\r\n                opacity: { min: 0.4, max: 0.8 },\r\n                speed: { min: 4, max: 10 },\r\n                size: { min: 1, max: 3 },\r\n                sizeOverLifetime: { min: 0, max: 0 },\r\n                torque: { min: -720, max: 720 },\r\n                collide: false,\r\n                fade: true,\r\n                paint: false,\r\n                spread: 0.6,\r\n                stain: false,\r\n                colors: [\"#ffaa00\", \"#ffcf70\", \"#f9dea7\"]\r\n            }\r\n        }\r\n    };\r\n\r\n    constructor() { }\r\n}","import { GAME, WORLD } from \"../Config\";\r\nimport { CreateParticleParams, DecalParams, Emitter, EmitterParams, Particle, ParticleParams, PlayerHitParams, Shrapnel, ShrapnelPiece } from \"../Types\";\r\n\r\nimport { Camera } from \"../Camera\";\r\nimport { CharacterConfig } from \"../CharacterConfig\";\r\nimport { DecalsManager } from \"../DecalsManager\";\r\nimport { RenderingManager } from \"../RenderingManager\";\r\nimport { RoomManager } from \"../RoomManager\";\r\nimport { UserInterface } from \"../UserInterface\";\r\nimport { Utility } from \"../Utility\";\r\n\r\nimport { PlayerState } from \"../player/PlayerState\";\r\nimport { CollisionsManager } from \"../CollisionsManager\";\r\nimport { ParticlesConfig } from \"./ParticlesConfig\";\r\n\r\nexport class ParticlesManager {\r\n    public particlesConfig: ParticlesConfig;\r\n\r\n    public particles: Map<string, Particle> = new Map();\r\n    public emitters: Map<string, Emitter> = new Map();\r\n    public shrapnel: Map<string, ShrapnelPiece> = new Map();\r\n\r\n    private collisionListeners: Array<(p: Particle) => void> = [];\r\n\r\n    constructor(\r\n        private camera: Camera,\r\n        private charConfig: CharacterConfig,\r\n        private collisionsManager: CollisionsManager,\r\n        private decalsManager: DecalsManager,\r\n        private playerState: PlayerState,\r\n        private renderingManager: RenderingManager,\r\n        private roomManager: RoomManager,\r\n        private ui: UserInterface,\r\n        private userId: string,\r\n        private utility: Utility\r\n    ) {\r\n        this.particlesConfig = new ParticlesConfig();\r\n    }\r\n\r\n    /**\r\n     * Resets the internal state of the particle manager.\r\n     */\r\n    public clear(): void {\r\n        this.particles.clear();\r\n        this.emitters.clear();\r\n        this.shrapnel.clear();\r\n    }\r\n\r\n    // #region [ Particles ]\r\n    //\r\n    //\r\n    /**\r\n     * Creates particles with params. Entrypoint for all particle creations.\r\n     */\r\n    public createParticles(params: CreateParticleParams): void {\r\n        this.generateParticles(params);\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'add-particles',\r\n            params: params\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Create a particles locally when receiving an 'add-particles' network message.\r\n     */\r\n    public createParticlesNetwork(params: CreateParticleParams): void {\r\n        if (this.particles.has(params.id)) return; // Don't create duplicate particles\r\n\r\n        this.generateParticles(params);\r\n    }\r\n\r\n    /**\r\n     * Responsible for actual generation of particles locally.\r\n     */\r\n    public generateParticles(params: CreateParticleParams): void {\r\n        const particleParams: ParticleParams = params.particleParams;\r\n\r\n        const count = Math.floor(this.utility.getRandomNum(particleParams.count.min, particleParams.count.max));\r\n\r\n        for (let i = 0; i < count; i++) {\r\n            const lifetime = this.utility.getRandomNum(particleParams.lifetime.min, particleParams.lifetime.max);\r\n            const speed = this.utility.getRandomNum(particleParams.speed.min, particleParams.speed.max);\r\n            const size = this.utility.getRandomNum(particleParams.size.min, particleParams.size.max);\r\n            const opacity = this.utility.getRandomNum(particleParams.opacity.min, particleParams.opacity.max);\r\n            const torque = this.utility.getRandomNum(particleParams.torque.min, particleParams.torque.max);\r\n            const noiseStrength = this.utility.getRandomNum(particleParams.noise.strength.min, particleParams.noise.strength.max);\r\n            const noiseScale = this.utility.getRandomNum(particleParams.noise.scale.min, particleParams.noise.scale.max);\r\n            const sizeOverLifetime = this.utility.getRandomNum(particleParams.sizeOverLifetime.min, particleParams.sizeOverLifetime.max);\r\n\r\n            // Pick random color from array\r\n            const chosenColor = this.utility.getRandomInArray(particleParams.colors);\r\n\r\n            let angle;\r\n            if (params.direction) {\r\n                angle = Math.atan2(params.direction.y, params.direction.x) + (this.utility.getRandomNum(0, 1) - 0.5) * particleParams.spread;\r\n            } else {\r\n                angle = this.utility.getRandomNum(0, Math.PI * 2);\r\n            }\r\n\r\n            const particle: Particle = {\r\n                age: 0,\r\n                collide: particleParams.collide,\r\n                color: chosenColor,\r\n                fade: particleParams.fade,\r\n                hasCollided: false,\r\n                id: `${params.id}_${i}`,\r\n                initialSize: size,\r\n                lifetime: lifetime,\r\n                maxOpacity: opacity,\r\n                noiseScale: noiseScale,\r\n                noiseStrength: noiseStrength,\r\n                opacity: opacity,\r\n                paint: particleParams.paint,\r\n                pos: {\r\n                    x: params.pos.x,\r\n                    y: params.pos.y\r\n                },\r\n                size: size,\r\n                stain: particleParams.stain,\r\n                torque: torque,\r\n                rotation: this.utility.getRandomNum(0, Math.PI * 2),\r\n                sizeOverLifetime: sizeOverLifetime,\r\n                velocity: {\r\n                    x: Math.cos(angle) * speed,\r\n                    y: Math.sin(angle) * speed\r\n                }\r\n            };\r\n\r\n            this.particles.set(particle.id, particle);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Handles updating of all particles in the game during the update loop.\r\n     */\r\n    public updateParticles(delta: number): void {\r\n        const particlesToRemove: string[] = [];\r\n\r\n        this.particles.forEach((particle, id) => {\r\n            if (particle.noiseStrength > 0 && particle.noiseScale > 0) {\r\n                const time = Date.now() * 0.001; // Use time for animation\r\n                const noiseX = this.utility.simplexNoise2D(particle.pos.x / particle.noiseScale, time);\r\n                const noiseY = this.utility.simplexNoise2D(particle.pos.y / particle.noiseScale, time + 100);\r\n\r\n                particle.velocity.x += noiseX * particle.noiseStrength * delta;\r\n                particle.velocity.y += noiseY * particle.noiseStrength * delta;\r\n            }\r\n\r\n            if (particle.sizeOverLifetime > 0) {\r\n                const ageRatio = particle.age / particle.lifetime;\r\n                particle.size = particle.initialSize * (1 + ageRatio * particle.sizeOverLifetime);\r\n            }\r\n\r\n            particle.pos.x += particle.velocity.x * delta;\r\n            particle.pos.y += particle.velocity.y * delta;\r\n            particle.age += 16.67 * delta;\r\n\r\n            particle.rotation += (particle.torque * Math.PI / 180) * delta;\r\n\r\n            if (particle.fade) {\r\n                const ageRatio = particle.age / particle.lifetime;\r\n                particle.opacity = particle.maxOpacity * (1 - ageRatio);\r\n            }\r\n\r\n            // Handle staining during extended collision life\r\n            if (particle.hasCollided && particle.stain) {\r\n                // Paint every frame during extended life\r\n                this.stampParticle(particle);\r\n\r\n                // Calculate how far we are through the extended life\r\n                const extendedLifeRatio = (particle.age - (particle.lifetime - particle.lifetime * 0.5)) / (particle.lifetime * 0.5);\r\n\r\n                if (extendedLifeRatio > 0) {\r\n                    // Shrink particle during extended life\r\n                    particle.size = Math.max(0.5, particle.size * (1 - extendedLifeRatio * 0.1));\r\n\r\n                    // Fade opacity during extended life (from current opacity to 0)\r\n                    particle.opacity = particle.opacity * (1 - extendedLifeRatio);\r\n                }\r\n            }\r\n\r\n            const shouldRemove = particle.age >= particle.lifetime ||\r\n                particle.pos.x < -10 || particle.pos.x > WORLD.WIDTH + 10 ||\r\n                particle.pos.y < -10 || particle.pos.y > WORLD.HEIGHT + 10;\r\n\r\n            if (shouldRemove) {\r\n                // Handle collision for particles with COLLIDE property\r\n                if (particle.collide && particle.age >= particle.lifetime &&\r\n                    particle.pos.x >= 0 && particle.pos.x <= WORLD.WIDTH &&\r\n                    particle.pos.y >= 0 && particle.pos.y <= WORLD.HEIGHT &&\r\n                    !particle.hasCollided) {\r\n\r\n                    // Simulate collision with ground/surface\r\n                    particle.hasCollided = true;\r\n                    this.emitCollision(particle);\r\n\r\n                    // Reduce speed\r\n                    const speedReduction = 0.875 + Math.random() * 0.1;\r\n                    particle.velocity.x *= (1 - speedReduction);\r\n                    particle.velocity.y *= (1 - speedReduction);\r\n\r\n                    // Extend lifetime\r\n                    const lifetimeExtension = particle.lifetime * 0.5;\r\n                    particle.lifetime += lifetimeExtension;\r\n\r\n                    // Don't remove this particle yet\r\n                    return;\r\n                }\r\n\r\n                // Handle painting before removal (only for non-staining particles)\r\n                if (particle.paint && !particle.stain && particle.age >= particle.lifetime &&\r\n                    particle.pos.x >= 0 && particle.pos.x <= WORLD.WIDTH &&\r\n                    particle.pos.y >= 0 && particle.pos.y <= WORLD.HEIGHT) {\r\n\r\n                    this.stampParticle(particle);\r\n                }\r\n\r\n                particlesToRemove.push(id);\r\n            }\r\n        });\r\n\r\n        particlesToRemove.forEach(id => this.particles.delete(id));\r\n    }\r\n\r\n    /**\r\n     * Responsible for the actual rendering of particles spawned via emitters and particle functions.\r\n     */\r\n    public drawParticles(): void {\r\n        if (!this.ui.ctx) return;\r\n\r\n        this.particles.forEach(particle => {\r\n            if (!this.camera.isVisible(particle.pos)) return;\r\n\r\n            // Convert to screen space\r\n            const screenPos = this.camera.worldToScreen(particle.pos);\r\n\r\n            const rgb = this.utility.hexToRgb(particle.color);\r\n            if (!rgb) return;\r\n\r\n            if (!this.ui.ctx) return;\r\n            this.ui.ctx.save();\r\n            this.ui.ctx.globalAlpha = particle.opacity;\r\n\r\n            if (particle.torque !== 0) {\r\n                this.ui.ctx.translate(screenPos.x + particle.size / 2, screenPos.y + particle.size / 2);\r\n                this.ui.ctx.rotate(particle.rotation);\r\n                this.ui.ctx.fillStyle = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;\r\n                this.ui.ctx.fillRect(-particle.size / 2, -particle.size / 2, particle.size, particle.size);\r\n            } else {\r\n                this.ui.ctx.fillStyle = `rgb(${rgb.r}, ${rgb.g}, ${rgb.b})`;\r\n                this.ui.ctx.fillRect(Math.floor(screenPos.x), Math.floor(screenPos.y), particle.size, particle.size);\r\n            }\r\n\r\n            this.ui.ctx.restore();\r\n        });\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Persistence ]\r\n    //\r\n    /**\r\n     * Stamps local particles onto the decal canvas.\r\n     */\r\n    private stampParticle(particle: Particle): void {\r\n        if (!this.ui.decalCtx) return;\r\n\r\n        // DON'T convert to screen space - decal canvas is world-sized!\r\n        // Just use world coordinates directly\r\n\r\n        const rgb = this.utility.hexToRgb(particle.color);\r\n        if (!rgb) return;\r\n\r\n        this.ui.decalCtx.save();\r\n        this.ui.decalCtx.globalCompositeOperation = 'source-over';\r\n\r\n        if (particle.torque !== 0) {\r\n            // Use particle.pos directly (world coordinates)\r\n            this.ui.decalCtx.translate(particle.pos.x + particle.size / 2, particle.pos.y + particle.size / 2);\r\n            this.ui.decalCtx.rotate(particle.rotation);\r\n            this.ui.decalCtx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${particle.opacity})`;\r\n            this.ui.decalCtx.fillRect(-particle.size / 2, -particle.size / 2, particle.size, particle.size);\r\n        } else {\r\n            this.ui.decalCtx.fillStyle = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${particle.opacity})`;\r\n            this.ui.decalCtx.fillRect(Math.floor(particle.pos.x), Math.floor(particle.pos.y), particle.size, particle.size);\r\n        }\r\n\r\n        this.ui.decalCtx.restore();\r\n\r\n        const id = `stamp_${Date.now()}`;\r\n\r\n        this.decalsManager.dynamicDecals.set(id, {\r\n            params: null,\r\n            pos: {\r\n                x: particle.pos.x, // World coordinates\r\n                y: particle.pos.y\r\n            }\r\n        });\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Emitters ]\r\n    //\r\n    /**\r\n     * Creates a particle emitter in the game, and syncs this action via websocket message \"particle-emitter\".\r\n     */\r\n    public createEmitter(params: EmitterParams): void {\r\n        this.generateEmitter(params); // Create an emitter locally\r\n\r\n        // Broadcast to other clients\r\n        const message: EmitterParams = {\r\n            type: 'particle-emitter',\r\n            id: params.id,\r\n            interval: params.interval,\r\n            lifetime: params.lifetime,\r\n            offset: {\r\n                x: params.offset.x,\r\n                y: params.offset.y\r\n            },\r\n            pos: {\r\n                x: params.pos.x,\r\n                y: params.pos.y\r\n            },\r\n            particleType: params.particleType,\r\n            playerId: params.playerId\r\n        };\r\n        this.roomManager.sendMessage(JSON.stringify(message));\r\n\r\n        console.log(`Emitter created on ${params.playerId} for ${params.lifetime}ms`);\r\n    }\r\n\r\n    /**\r\n     * Actual generation of the emitter object into the emitter mapping.\r\n     */\r\n    public generateEmitter(params: EmitterParams): void {\r\n        // Calculate offset from center\r\n        const offsetX = params.pos.x - params.offset.x;\r\n        const offsetY = params.pos.y - params.offset.y;\r\n\r\n        // Calculate direction (away from center towards hit point)\r\n        const angle = Math.atan2(offsetY, offsetX);\r\n\r\n        this.emitters.set(params.id, {\r\n            age: 0,\r\n            direction: angle,\r\n            emissionInterval: params.interval,\r\n            lastEmission: 0,\r\n            lifetime: params.lifetime,\r\n            offset: {\r\n                x: offsetX,\r\n                y: offsetY\r\n            },\r\n            particleType: params.particleType,\r\n            playerId: params.playerId\r\n        });\r\n    }\r\n    /**\r\n     * Process all particle emitters in the game during the update loop.\r\n     */\r\n    public updateEmitters(delta: number): void {\r\n        const emittersToRemove: string[] = [];\r\n\r\n        this.emitters.forEach((emitter, emitterId) => {\r\n            emitter.age += 16.67 * delta;\r\n\r\n            const player = emitter.playerId === this.userId ? this.playerState.myPlayer : this.playerState.players.get(emitter.playerId);\r\n            if (!player || player.stats.health.value <= 0) {\r\n                emittersToRemove.push(emitterId);\r\n                return;\r\n            }\r\n\r\n            // Calculate current world position\r\n            const worldX = player.transform.pos.x + emitter.offset.x;\r\n            const worldY = player.transform.pos.y + emitter.offset.y;\r\n\r\n            if (emitter.age >= emitter.lastEmission + emitter.emissionInterval) {\r\n                // Create directional spray with cone spread\r\n                const coneSpread = Math.PI * 0.6; // 108 degree cone\r\n                const randomSpread = (Math.random() - 0.5) * coneSpread;\r\n                const angle = emitter.direction + randomSpread;\r\n\r\n                // Variable speed for more natural spray\r\n                const baseSpeed = 3;\r\n                const speedVariation = (Math.random() - 0.5) * 4; // -2 to +2\r\n                const finalSpeed = Math.max(0.5, baseSpeed + speedVariation);\r\n\r\n                const particleParams: CreateParticleParams = {\r\n                    id: `emitter_particles_${emitterId}_${emitter.age}`,\r\n                    pos: {\r\n                        x: worldX + (Math.random() - 0.5) * 8,\r\n                        y: worldY + (Math.random() - 0.5) * 8\r\n                    },\r\n                    particleParams: emitter.particleType,\r\n                    direction: {\r\n                        x: Math.cos(angle) * finalSpeed,\r\n                        y: Math.sin(angle) * finalSpeed\r\n                    }\r\n                }\r\n                this.generateParticles(particleParams);\r\n\r\n                emitter.lastEmission = emitter.age;\r\n                emitter.emissionInterval = 120 + Math.random() * 180; // More consistent timing\r\n            }\r\n\r\n            // Remove expired emitters\r\n            if (emitter.age >= emitter.lifetime) {\r\n                const decalParams: DecalParams = {\r\n                    id: `emitter_decal_${emitterId}`,\r\n                    pos: {\r\n                        x: worldX,\r\n                        y: worldY\r\n                    },\r\n                    type: \"parametric\",\r\n                    parametric: this.decalsManager.decalsConfig.decals.blood\r\n                };\r\n                this.decalsManager.generateDecal(decalParams);\r\n\r\n                emittersToRemove.push(emitterId);\r\n            }\r\n        });\r\n\r\n        emittersToRemove.forEach(id => this.emitters.delete(id));\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Shrapnel ]\r\n    //\r\n    /**\r\n     * Creates shrapnel pieces and sends network message with Shrapnel data.\r\n     */\r\n    public spawnShrapnel(params: Shrapnel): void {\r\n        const pieces: ShrapnelPiece[] = [];\r\n\r\n        // Generate all pieces locally\r\n        for (let i = 0; i < params.amount; i++) {\r\n            const angle = this.utility.getRandomNum(0, Math.PI * 2);\r\n            const speed = this.utility.getRandomNum(params.speed.min, params.speed.max);\r\n            const lifetime = this.utility.getRandomNum(params.lifetime.min, params.lifetime.max);\r\n            const size = this.utility.getRandomNum(params.size.min, params.size.max);\r\n            const torque = this.utility.getRandomNum(params.torque.min, params.torque.max) * (Math.PI / 180); // Convert radians > deg\r\n\r\n            const piece: ShrapnelPiece = {\r\n                id: this.utility.generateUID(GAME.DATA.ID_LENGTH),\r\n                image: params.images[i], // Already randomly selected in triggerUnique\r\n                transform: {\r\n                    pos: {\r\n                        x: params.pos.x,\r\n                        y: params.pos.y\r\n                    },\r\n                    rot: this.utility.getRandomNum(0, Math.PI * 2), // Random start rot\r\n                },\r\n                velocity: {\r\n                    x: Math.cos(angle) * speed,\r\n                    y: Math.sin(angle) * speed\r\n                },\r\n                rotationSpeed: torque, // Random spin\r\n                size: size,\r\n                age: 0,\r\n                lifetime: lifetime,\r\n                ownerId: this.userId,\r\n                damage: params.damage\r\n            };\r\n\r\n            pieces.push(piece);\r\n            this.shrapnel.set(piece.id, piece);\r\n        }\r\n\r\n        // Send ONE message with all pieces\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'shrapnel-spawn',\r\n            pieces: pieces\r\n        }));\r\n\r\n        console.log(`Spawned ${pieces.length} shrapnel pieces`);\r\n    }\r\n\r\n    /**\r\n     * Generates shrapnel baed on received network message 'shrapnel-spawn' data.\r\n     */\r\n    public generateShrapnel(params: ShrapnelPiece[]): void {\r\n        params.forEach(piece => {\r\n            this.shrapnel.set(piece.id, piece);\r\n        });\r\n\r\n        console.log(`Received ${params.length} shrapnel pieces from network`);\r\n    }\r\n\r\n    /**\r\n     * When shrapnel exists, handles updating of each piece via Client udpate loop.\r\n     */\r\n    public updateShrapnel(delta: number): void {\r\n        if (this.shrapnel.size === 0) return;\r\n\r\n        const shrapnelToRemove: string[] = [];\r\n\r\n        this.shrapnel.forEach((piece, id) => {\r\n            // Update physics\r\n            piece.transform.pos.x += piece.velocity.x * delta;\r\n            piece.transform.pos.y += piece.velocity.y * delta;\r\n            piece.transform.rot += piece.rotationSpeed * delta;\r\n            piece.age += 16.67 * delta;\r\n\r\n            // Apply friction\r\n            // TODO: Add world friction\r\n            piece.velocity.x *= 0.98;\r\n            piece.velocity.y *= 0.98;\r\n\r\n            // Only owner checks collisions and deals damage\r\n            if (piece.ownerId === this.userId) {\r\n                // Check collision with all players\r\n                this.playerState.players.forEach((player, playerId) => {\r\n                    if (player.stats.health.value > 0) {\r\n                        const dx = piece.transform.pos.x - player.transform.pos.x;\r\n                        const dy = piece.transform.pos.y - player.transform.pos.y;\r\n                        const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n                        // Collision detection (using player collider + shrapnel size for padding)\r\n                        if (distance <= this.collisionsManager.getPlayerCollider(player, piece.size)) {\r\n                            const actualDamage = Math.max(0, piece.damage - player.stats.defense);\r\n                            const newHealth = Math.max(0, player.stats.health.value - actualDamage);\r\n                            player.stats.health.value = newHealth;\r\n\r\n                            // Remove this shrapnel piece after hit\r\n                            shrapnelToRemove.push(id);\r\n                            console.log(`Shrapnel hit ${playerId} for ${piece.damage} damage`);\r\n\r\n                            const params: PlayerHitParams = {\r\n                                target: player,\r\n                                shooterId: this.userId,\r\n                                damage: piece.damage,\r\n                                newHealth: newHealth,\r\n                                source: piece,\r\n                                wasKill: newHealth <= 0\r\n                            }\r\n                            window.dispatchEvent(new CustomEvent(\"customEvent_playerHitRelay\", { detail: { params } }));\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            // Remove if lifetime expired or out of bounds\r\n            if (piece.age >= piece.lifetime ||\r\n                piece.transform.pos.x < 0 || piece.transform.pos.x > WORLD.WIDTH ||\r\n                piece.transform.pos.y < 0 || piece.transform.pos.y > WORLD.HEIGHT) {\r\n\r\n                // Stamp as decal if died in bounds\r\n                if (piece.transform.pos.x >= 0 && piece.transform.pos.x <= WORLD.WIDTH &&\r\n                    piece.transform.pos.y >= 0 && piece.transform.pos.y <= WORLD.HEIGHT) {\r\n                    this.stampShrapnel(piece);\r\n                }\r\n\r\n                shrapnelToRemove.push(id);\r\n            }\r\n        });\r\n\r\n        // Remove dead shrapnel\r\n        shrapnelToRemove.forEach(id => this.shrapnel.delete(id));\r\n    }\r\n\r\n    /**\r\n     * Draws the moving shrapnel to the canvas for rendering.\r\n     */\r\n    public drawShrapnel(): void {\r\n        if (!this.ui.ctx || this.shrapnel.size === 0) return;\r\n\r\n        this.shrapnel.forEach(piece => {\r\n            if (!this.ui.ctx) return;\r\n            if (!this.camera.isVisible(piece.transform.pos)) return;\r\n\r\n            const screenPos = this.camera.worldToScreen(piece.transform.pos);\r\n\r\n            let image = this.renderingManager.characterImages.get(piece.image);\r\n\r\n            if (!image) {\r\n                image = new Image();\r\n                image.src = piece.image;\r\n                this.renderingManager.characterImages.set(piece.image, image);\r\n\r\n                if (!image.complete) { return; }\r\n            }\r\n\r\n            if (!image.complete || image.naturalWidth === 0) return;\r\n\r\n            this.ui.ctx.save();\r\n            this.ui.ctx.translate(screenPos.x, screenPos.y);\r\n            this.ui.ctx.rotate(piece.transform.rot);\r\n\r\n            this.ui.ctx.drawImage(\r\n                image,\r\n                -piece.size / 2,\r\n                -piece.size / 2,\r\n                piece.size,\r\n                piece.size\r\n            );\r\n\r\n            this.ui.ctx.restore();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Stamps dead shrapnel to the decal canvas to persist visually.\r\n     */\r\n    private stampShrapnel(params: ShrapnelPiece): void {\r\n        if (!this.ui.decalCtx) return;\r\n        if (!this.camera.isVisible(params.transform.pos)) return;\r\n\r\n        const screenPos = this.camera.worldToScreen(params.transform.pos);\r\n\r\n        let image = this.renderingManager.characterImages.get(params.image);\r\n        if (!image || !image.complete || image.naturalWidth === 0) return;\r\n\r\n        this.ui.decalCtx.save();\r\n        this.ui.decalCtx.translate(screenPos.x, screenPos.y);\r\n        this.ui.decalCtx.rotate(params.transform.rot);\r\n\r\n        this.ui.decalCtx.drawImage(\r\n            image,\r\n            -params.size / 2,\r\n            -params.size / 2,\r\n            params.size,\r\n            params.size\r\n        );\r\n\r\n        this.ui.decalCtx.restore();\r\n\r\n        // Register decal with WORLD position\r\n        this.decalsManager.dynamicDecals.set(`shrapnel_${params.id}`, {\r\n            params: null,\r\n            pos: {\r\n                x: params.transform.pos.x, // World coordinates\r\n                y: params.transform.pos.y\r\n            }\r\n        });\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Events ]\r\n    //\r\n\r\n    public addCollisionListener(fn: (p: Particle) => void): void { this.collisionListeners.push(fn); }\r\n\r\n\r\n    private emitCollision(p: Particle): void {\r\n        for (let i = 0; i < this.collisionListeners.length; i++) {\r\n            this.collisionListeners[i](p);\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { GAME, SHRAPNEL, WORLD } from \"../Config\";\r\nimport { AttackType, AudioParams, CreateParticleParams, DecalParams, PlayerHitParams, DamageEntity, ProjectileOverrides, Shrapnel, Vec2, Particle } from \"../Types\";\r\n\r\nimport { Animator } from \"../Animator\";\r\nimport { CollisionsManager } from \"../CollisionsManager\";\r\nimport { DecalsManager } from \"../DecalsManager\";\r\nimport { GameState } from \"../GameState\";\r\nimport { LuckController } from \"./LuckController\";\r\nimport { PlayerController, } from \"./PlayerController\";\r\nimport { PlayerState } from \"./PlayerState\";\r\nimport { RoomManager } from \"../RoomManager\";\r\nimport { UserInterface } from \"../UserInterface\";\r\nimport { Utility } from \"../Utility\";\r\n\r\nimport { AudioConfig } from \"../audio/AudioConfig\";\r\nimport { AudioManager } from \"../audio/AudioManager\";\r\n\r\nimport { ParticlesManager } from \"../particles/ParticlesManager\";\r\n\r\nimport { World } from \"../world/World\";\r\n\r\nexport class CombatController {\r\n    public projectiles: Map<string, DamageEntity> = new Map();\r\n\r\n    constructor(\r\n        private animator: Animator,\r\n        private audioConfig: AudioConfig,\r\n        private audioManager: AudioManager,\r\n        private collisionsManager: CollisionsManager,\r\n        private decalsManager: DecalsManager,\r\n        private gameState: GameState,\r\n        private luckController: LuckController,\r\n        private particlesManager: ParticlesManager,\r\n        private playerController: PlayerController,\r\n        private playerState: PlayerState,\r\n        private roomManager: RoomManager,\r\n        private ui: UserInterface,\r\n        private userId: string,\r\n        private utility: Utility,\r\n        private world: World\r\n    ) { }\r\n\r\n    // #region [ Attack ]\r\n    /**\r\n     * Entrypoint for triggering attacks based on type needed.\r\n     */\r\n    public triggerAttack(type: AttackType): void {\r\n        switch (type) {\r\n            case 'melee':\r\n                this.startMelee();\r\n                break;\r\n            case 'ranged':\r\n                this.startBurst();\r\n                break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Responsible for what happens during attack actions.\r\n     */\r\n    public updateAttack(delta: number): void {\r\n        if (!this.gameState.gameInProgress || this.playerState.myPlayer.stats.health.value <= 0) return;\r\n\r\n        const currentTime = Date.now();\r\n\r\n        // Handle reload\r\n        if (this.playerState.isReloading) {\r\n            if (currentTime >= this.playerState.reloadStartTime + this.playerState.myPlayer.actions.primary.reload.time) { // Reload complete\r\n                this.finishReload();\r\n            }\r\n            return; // Can't shoot while reloading\r\n        }\r\n\r\n        // Handle ongoing burst\r\n        if (this.playerState.isBurstActive && currentTime >= this.playerState.nextBurstShotTime) {\r\n            // Check if we still have ammo and haven't finished the intended burst amount\r\n            const ammoNeeded = this.playerState.myPlayer.actions.primary.burst.amount;\r\n            if (this.playerState.myPlayer.actions.primary.magazine.currentAmmo > 0 && this.playerState.currentBurstShot < ammoNeeded) {\r\n                const angle = this.playerState.myPlayer.transform.rot - Math.PI / 2;\r\n                const targetDir = { x: Math.cos(angle), y: Math.sin(angle) };\r\n\r\n                const triggeredUniques = this.triggerBurstUniques();\r\n                if (triggeredUniques.length === 0) {\r\n                    this.launchProjectile(targetDir);\r\n                }\r\n\r\n                this.playerState.currentBurstShot++;\r\n                this.playerState.myPlayer.actions.primary.magazine.currentAmmo--; // Use 1 ammo per shot in burst\r\n\r\n                console.log(`Burst shot ${this.playerState.currentBurstShot}! Magazine: ${this.playerState.myPlayer.actions.primary.magazine.currentAmmo}/${this.playerState.myPlayer.actions.primary.magazine.size}, Inventory: ${this.playerState.myPlayer.actions.primary.magazine.currentReserve}/${this.playerState.myPlayer.actions.primary.magazine.maxReserve}`);\r\n\r\n                if (this.playerState.currentBurstShot >= ammoNeeded || this.playerState.myPlayer.actions.primary.magazine.currentAmmo === 0) { // Burst complete (reached burst amount or out of ammo)\r\n                    this.playerState.isBurstActive = false;\r\n                    this.playerState.currentBurstShot = 0;\r\n                } else { // Schedule next shot in burst\r\n                    this.playerState.nextBurstShotTime = currentTime + this.playerState.myPlayer.actions.primary.burst.delay;\r\n                }\r\n            } else { // Out of ammo or reached burst limit\r\n                this.playerState.isBurstActive = false;\r\n                this.playerState.currentBurstShot = 0;\r\n            }\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Melee ]\r\n    //\r\n    /**\r\n     * Checks if the player can melee or not.\r\n     */\r\n    public canMelee(): boolean {\r\n        const now = Date.now(); 1\r\n        return (\r\n            !this.playerState.isMelee &&\r\n            now >= this.playerState.lastMeleeTime + this.playerState.myPlayer.actions.melee.cooldown &&\r\n            this.collisionsManager.collisionsEnabled(this.playerState.myPlayer) &&\r\n            !this.playerState.isBurstActive &&\r\n            !this.playerState.isReloading\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Triggers a melee attack, using standard projectiles with special params.\r\n     */\r\n    private startMelee(): void {\r\n        this.playerState.isMelee = true;\r\n        this.playerState.lastMeleeTime = Date.now();\r\n\r\n        this.playerState.myPlayer.rig.weapon = this.playerState.myPlayer.inventory.melee;\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'weapon-change',\r\n            playerId: this.userId,\r\n            weapon: this.playerState.myPlayer.inventory.melee\r\n        }));\r\n\r\n        // Calculate melee direction (use current rotation)\r\n        const angle = this.playerState.myPlayer.transform.rot;\r\n        const range = this.playerState.myPlayer.actions.melee.range;\r\n        const size = this.playerState.myPlayer.actions.melee.size;\r\n\r\n        // Use the same spawn offset as normal projectiles\r\n        const spawnOffset = this.collisionsManager.getPlayerCollider(this.playerState.myPlayer) +\r\n            this.playerState.myPlayer.actions.primary.projectile.size +\r\n            this.playerState.myPlayer.actions.primary.offset;\r\n\r\n        // Calculate spawn position at the tip of the weapon\r\n        const spawnX = this.playerState.myPlayer.transform.pos.x + Math.cos(angle - Math.PI / 2) * spawnOffset;\r\n        const spawnY = this.playerState.myPlayer.transform.pos.y + Math.sin(angle - Math.PI / 2) * spawnOffset;\r\n\r\n        const velocity = {\r\n            x: Math.cos(angle - Math.PI / 2) * range,\r\n            y: Math.sin(angle - Math.PI / 2) * range\r\n        };\r\n\r\n        const meleeProjectile: DamageEntity = {\r\n            id: this.utility.generateUID(GAME.DATA.ID_LENGTH),\r\n            transform: {\r\n                pos: { x: spawnX, y: spawnY },\r\n                rot: angle\r\n            },\r\n            timestamp: Date.now(),\r\n            color: 'rgba(255, 255, 255, 0)', // Invisible\r\n            damage: this.playerState.myPlayer.actions.melee.damage,\r\n            distanceTraveled: 0,\r\n            length: size,\r\n            ownerId: this.userId,\r\n            range: range,\r\n            size: size,\r\n            type: 'melee',\r\n            velocity: velocity\r\n        };\r\n\r\n        this.projectiles.set(meleeProjectile.id, meleeProjectile);\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'projectile-launch',\r\n            projectile: meleeProjectile\r\n        }));\r\n\r\n        this.utility.safeTimeout(() => { // Remove meleeProjectile after it reaches duration\r\n            this.projectiles.delete(meleeProjectile.id);\r\n            this.playerState.isMelee = false;\r\n\r\n            this.playerState.myPlayer.rig.weapon = this.playerState.myPlayer.inventory.primary;\r\n\r\n            this.roomManager.sendMessage(JSON.stringify({\r\n                type: 'weapon-change',\r\n                playerId: this.userId,\r\n                weapon: this.playerState.myPlayer.inventory.primary\r\n            }));\r\n        }, this.playerState.myPlayer.actions.melee.duration);\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Ranged ]\r\n    //\r\n    /**\r\n     * Entrypoint for ranged attacks. When this is called, it starts the primary attack flow.\r\n     */\r\n    private startBurst(): void {\r\n        if (this.playerState.isBurstActive || !this.collisionsManager.collisionsEnabled(this.playerState.myPlayer) || this.playerState.isReloading) return;\r\n\r\n        const now = Date.now();\r\n        if (now < this.playerState.lastShotTime + this.playerState.myPlayer.actions.primary.buffer) return;\r\n        this.playerState.lastShotTime = now;\r\n\r\n        // Check if we have enough ammo for the burst\r\n        const ammoNeeded = this.playerState.myPlayer.actions.primary.burst.amount;\r\n        const ammoToUse = Math.min(ammoNeeded, this.playerState.myPlayer.actions.primary.magazine.currentAmmo);\r\n\r\n        const currentWeapon = this.playerState.myPlayer.inventory.primary;\r\n        const emptySfx = this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[currentWeapon].empty ?? [])\r\n\r\n        const playerX = this.playerState.myPlayer.transform.pos.x;\r\n        const playerY = this.playerState.myPlayer.transform.pos.y;\r\n\r\n        if (ammoToUse === 0) {\r\n            console.log('Out of ammo! Magazine empty.');\r\n\r\n            this.animator.animateCharacterPart({\r\n                playerId: this.userId,\r\n                part: 'weapon',\r\n                frames: {\r\n                    0: { x: 0, y: 8 } // Slide held back\r\n                },\r\n                duration: 0,\r\n                partIndex: 1\r\n            }); // duration=0 means infinite/held\r\n\r\n            if (!emptySfx) { console.warn(`No empty sound effects for ${currentWeapon}`); return; }\r\n\r\n            this.audioManager.playAudioNetwork({\r\n                src: emptySfx,\r\n                listener: {\r\n                    x: playerX,\r\n                    y: playerY\r\n                },\r\n                output: 'sfx',\r\n                pitch: { min: 0.975, max: 1.05 },\r\n                spatial: {\r\n                    blend: 1.0,\r\n                    pos: { x: playerX, y: playerY }\r\n                },\r\n                volume: { min: 0.985, max: 1 }\r\n            });\r\n            return;\r\n        }\r\n\r\n        this.playerState.isBurstActive = true;\r\n        this.playerState.currentBurstShot = 0;\r\n\r\n        // Calculate direction from player's current rotation instead of mouse\r\n        const angle = this.playerState.myPlayer.transform.rot - Math.PI / 2; // Subtract PI/2 to convert from visual rotation to direction\r\n        const targetDir = { x: Math.cos(angle), y: Math.sin(angle) };\r\n\r\n        const triggeredUniques = this.triggerBurstUniques();\r\n        if (triggeredUniques.length === 0) {\r\n            this.launchProjectile(targetDir);\r\n        }\r\n\r\n        this.playerState.currentBurstShot++;\r\n        this.playerState.myPlayer.actions.primary.magazine.currentAmmo--; // Use 1 ammo per shot in burst\r\n\r\n        // Blend in empty sound as magazine gets low\r\n        // This is a local sound only, to help the player manage their ammo\r\n        const ammoRatio = this.playerState.myPlayer.actions.primary.magazine.currentAmmo / this.playerState.myPlayer.actions.primary.magazine.size;\r\n        const emptyBlend = 1 - ammoRatio; // 0 when full, 1 when empty\r\n\r\n        if (emptySfx) {\r\n            if (emptyBlend > 0.5) { // Only play when below 50% ammo (half mag empty)\r\n                const blendVolume = (emptyBlend - 0.5) * 2 * 0.5; // Remap 0.5-1.0 to 0-0.5 volume\r\n                this.audioManager.playAudio({ // Play sound locally\r\n                    src: emptySfx,\r\n                    listener: {\r\n                        x: playerX,\r\n                        y: playerY\r\n                    },\r\n                    output: 'sfx',\r\n                    pitch: { min: 0.975, max: 1.05 },\r\n                    volume: { min: blendVolume, max: blendVolume }\r\n                });\r\n            }\r\n        }\r\n\r\n        // If burst has more shots and we have ammo, schedule the next one\r\n        if (this.playerState.myPlayer.actions.primary.burst.amount > 1 && this.playerState.myPlayer.actions.primary.magazine.currentAmmo > 0 && this.playerState.currentBurstShot < ammoToUse) {\r\n            this.playerState.nextBurstShotTime = Date.now() + this.playerState.myPlayer.actions.primary.burst.delay;\r\n        } else { // Burst complete\r\n            this.playerState.isBurstActive = false;\r\n            this.playerState.currentBurstShot = 0;\r\n\r\n            if (this.playerState.myPlayer.actions.primary.magazine.currentAmmo === 0) {\r\n                this.animator.animateCharacterPart({\r\n                    playerId: this.userId,\r\n                    part: 'weapon',\r\n                    frames: {\r\n                        0: { x: 0, y: 8 } // Slide held back\r\n                    },\r\n                    duration: 0,\r\n                    partIndex: 1\r\n                }); // duration=0 means infinite/held\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Calculates physics for projectile and adds them to mapping.\r\n     */\r\n    private launchProjectile(dir: Vec2, overrides?: ProjectileOverrides): void {\r\n        console.log(`Fired shot!`);\r\n\r\n        // Use the passed direction and normalize it\r\n        const distance = Math.sqrt(dir.x * dir.x + dir.y * dir.y);\r\n        if (distance === 0) return;\r\n\r\n        const playerX = this.playerState.myPlayer.transform.pos.x;\r\n        const playerY = this.playerState.myPlayer.transform.pos.y;\r\n\r\n        const currentWeapon = this.playerState.myPlayer.inventory.primary;\r\n\r\n        const dirX = dir.x / distance;\r\n        const dirY = dir.y / distance;\r\n\r\n        const canTriggerUnique = overrides?.canTriggerUnique ?? true;\r\n        const projectileAmount = overrides?.amount ?? this.playerState.myPlayer.actions.primary.projectile.amount;\r\n        const projectileColor = overrides?.color ?? this.playerState.myPlayer.actions.primary.projectile.color;\r\n        const projectileDamage = overrides?.damage ?? this.playerState.myPlayer.actions.primary.projectile.damage;\r\n        const projectileLength = overrides?.length ?? this.playerState.myPlayer.actions.primary.projectile.length;\r\n        const projectileRange = overrides?.range ?? this.playerState.myPlayer.actions.primary.projectile.range;\r\n        const projectileSize = overrides?.size ?? this.playerState.myPlayer.actions.primary.projectile.size;\r\n        const projectileSpeed = overrides?.speed ?? this.playerState.myPlayer.actions.primary.projectile.speed;\r\n        const projectileSpread = overrides?.spread ?? this.playerState.myPlayer.actions.primary.projectile.spread;\r\n\r\n        // Calculate spawn offset\r\n        const baseAngle = Math.atan2(dirY, dirX);\r\n        const spawnOffset = this.collisionsManager.getPlayerCollider(this.playerState.myPlayer) + projectileSize + this.playerState.myPlayer.actions.primary.offset;\r\n        const bulletSpawnX = playerX + Math.cos(baseAngle) * spawnOffset;\r\n        const bulletSpawnY = playerY + Math.sin(baseAngle) * spawnOffset;\r\n        const rightX = -dirY;\r\n        const rightY = dirX;\r\n\r\n        // Animate weapon slide (glock_slide.png is index 1 in the weapon.glock array)\r\n        this.animator.animateCharacterPart({\r\n            playerId: this.userId,\r\n            part: 'weapon',\r\n            frames: {\r\n                0: { x: 0, y: 0 },    // Start position\r\n                0.5: { x: 0, y: 20 }, // Pull back slide\r\n                1: { x: 0, y: 0 }     // Return to start\r\n            },\r\n            duration: 175,\r\n            partIndex: 1\r\n        });\r\n\r\n        // TODO: Wrap all of these particles in some sort of defined type that contains this in one message\r\n\r\n        const muzzleParams: CreateParticleParams = {\r\n            id: `muzzle_${Date.now()}`,\r\n            pos: {\r\n                x: bulletSpawnX,\r\n                y: bulletSpawnY\r\n            },\r\n            particleParams: this.particlesManager.particlesConfig.weaponParticles[currentWeapon].muzzle.flash,\r\n            direction: { x: dirX, y: dirY }\r\n        }\r\n        this.particlesManager.createParticles(muzzleParams);\r\n\r\n        const smokeParams: CreateParticleParams = {\r\n            id: `smoke_${Date.now()}`,\r\n            pos: {\r\n                x: bulletSpawnX,\r\n                y: bulletSpawnY\r\n            },\r\n            particleParams: this.particlesManager.particlesConfig.weaponParticles[currentWeapon].muzzle.smoke,\r\n            direction: { x: dirX * 0.3, y: dirY * 0.3 }\r\n        }\r\n        this.particlesManager.createParticles(smokeParams);\r\n\r\n        const shellParams: CreateParticleParams = {\r\n            id: `shell_${Date.now()}`,\r\n            pos: {\r\n                x: bulletSpawnX - 5,\r\n                y: bulletSpawnY - 5\r\n            },\r\n            particleParams: this.particlesManager.particlesConfig.weaponParticles[currentWeapon].projectile.shell,\r\n            direction: { x: rightX * 0.8 + dirX * -0.2, y: rightY * 0.8 + dirY * -0.2 } // Right + slightly back\r\n        }\r\n        this.particlesManager.createParticles(shellParams);\r\n\r\n        this.audioManager.playAudioNetwork({\r\n            src: this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[currentWeapon].attack),\r\n            listener: {\r\n                x: playerX,\r\n                y: playerY\r\n            },\r\n            output: 'sfx',\r\n            pitch: { min: 0.95, max: 1.125 },\r\n            spatial: {\r\n                blend: 1.0,\r\n                pos: { x: playerX, y: playerY },\r\n                rolloff: {\r\n                    distance: Math.max(WORLD.WIDTH, WORLD.HEIGHT) / 2, // TODO: Make more reliable distance attenuation, right now, just half of the world size\r\n                    factor: 0.5,\r\n                    type: 'logarithmic'\r\n                }\r\n            },\r\n            volume: { min: 0.965, max: 1 }\r\n        });\r\n\r\n        // Create projectiles\r\n        for (let i = 0; i < projectileAmount; i++) {\r\n            if (this.playerState.myPlayer.unique.length > 0 && canTriggerUnique) {\r\n                const shuffledUniques = this.utility.getShuffledArray(this.playerState.myPlayer.unique);\r\n\r\n                for (const unique of shuffledUniques) {\r\n                    if (this.luckController.luckRoll()) {\r\n                        this.triggerUnique(unique);\r\n                        break;\r\n                    }\r\n                }\r\n            }\r\n\r\n            const spread = (Math.random() - 0.5) * (projectileSpread / 100);\r\n            const angle = Math.atan2(dirY, dirX) + spread;\r\n            const dir = this.utility.forward(angle);\r\n\r\n            const projectile: DamageEntity = {\r\n                id: this.utility.generateUID(GAME.DATA.ID_LENGTH),\r\n                transform: {\r\n                    pos: {\r\n                        x: bulletSpawnX,\r\n                        y: bulletSpawnY,\r\n                    },\r\n                    rot: angle\r\n                },\r\n                timestamp: Date.now(),\r\n                color: projectileColor,\r\n                damage: projectileDamage,\r\n                distanceTraveled: 0,\r\n                length: projectileLength,\r\n                ownerId: this.userId,\r\n                range: projectileRange * 100, // Convert to px\r\n                size: projectileSize,\r\n                type: 'ranged',\r\n                velocity: {\r\n                    x: dir.x * projectileSpeed,\r\n                    y: dir.y * projectileSpeed,\r\n                },\r\n            };\r\n\r\n            this.projectiles.set(projectile.id, projectile);\r\n\r\n            // Send projectile to other players\r\n            this.roomManager.sendMessage(JSON.stringify({\r\n                type: 'projectile-launch',\r\n                projectile: projectile\r\n            }));\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Updates all projectiles in the game locally.\r\n     */\r\n    public updateProjectiles(delta: number): void {\r\n        const projectilesToRemove: string[] = [];\r\n\r\n        const myPlayer = this.playerState.myPlayer;\r\n        const myPlayerX = myPlayer.transform.pos.x;\r\n        const myPlayerY = myPlayer.transform.pos.y;\r\n        const myStats = myPlayer.stats;\r\n\r\n        this.projectiles.forEach((projectile, id) => {\r\n            if (projectile.ownerId === this.userId) {\r\n                if (myPlayer.unique.includes('spatial_targeting')) {\r\n                    const aim = myPlayer.transform.rot - Math.PI / 2;\r\n                    const dx = Math.cos(aim), dy = Math.sin(aim);\r\n                    const speed = Math.sqrt(projectile.velocity.x ** 2 + projectile.velocity.y ** 2);\r\n                    const vx = projectile.velocity.x / speed, vy = projectile.velocity.y / speed;\r\n                    const lerpFactor = 0.05;\r\n                    const lx = vx + (dx - vx) * lerpFactor;\r\n                    const ly = vy + (dy - vy) * lerpFactor;\r\n                    const norm = Math.sqrt(lx ** 2 + ly ** 2);\r\n\r\n                    projectile.velocity.x = (lx / norm) * speed;\r\n                    projectile.velocity.y = (ly / norm) * speed;\r\n                    projectile.transform.rot = Math.atan2(projectile.velocity.y, projectile.velocity.x);\r\n                }\r\n            }\r\n\r\n            projectile.transform.pos.x += projectile.velocity.x * delta;\r\n            projectile.transform.pos.y += projectile.velocity.y * delta;\r\n\r\n            const frameDistance = Math.sqrt( // Update distance traveled\r\n                projectile.velocity.x * projectile.velocity.x +\r\n                projectile.velocity.y * projectile.velocity.y\r\n            ) * delta;\r\n            projectile.distanceTraveled += frameDistance;\r\n\r\n            // Check collision with my player (only if I'm alive)\r\n            if (this.collisionsManager.collisionsEnabled(myPlayer)) {\r\n                const dx = projectile.transform.pos.x - myPlayerX;\r\n                const dy = projectile.transform.pos.y - myPlayerY;\r\n                const distance = Math.sqrt(dx * dx + dy * dy);\r\n\r\n                const playerCollider = this.collisionsManager.getPlayerCollider(myPlayer);\r\n                const canDeflect = myPlayer.unique.includes('kinetic_brain') &&\r\n                    distance <= playerCollider * 4 &&\r\n                    distance > playerCollider + projectile.size &&\r\n                    projectile.ownerId !== this.userId;\r\n\r\n                if (canDeflect) {\r\n                    if (this.luckController.luckRoll()) {\r\n                        console.log('Kinetic Brain activated! Deflecting projectile.');\r\n\r\n                        // Calculate normal from player center to projectile\r\n                        const normal = {\r\n                            x: (projectile.transform.pos.x - myPlayerX) / distance,\r\n                            y: (projectile.transform.pos.y - myPlayerY) / distance\r\n                        };\r\n\r\n                        const speedReduction = this.utility.getRandomNum(0.85, 0.95);\r\n\r\n                        // Reflect velocity off the normal\r\n                        const reflected = this.utility.getReflection(projectile.velocity, normal);\r\n                        projectile.velocity.x = reflected.x * speedReduction; // Slow down\r\n                        projectile.velocity.y = reflected.y * 0.85;\r\n\r\n                        // Change ownership\r\n                        projectile.ownerId = this.userId;\r\n                        projectile.color = myPlayer.actions.primary.projectile.color;\r\n\r\n                        // Update rotation\r\n                        projectile.transform.rot = Math.atan2(projectile.velocity.y, projectile.velocity.x);\r\n\r\n                        // Broadcast deflection\r\n                        this.roomManager.sendMessage(JSON.stringify({\r\n                            type: 'projectile-update',\r\n                            projectileId: projectile.id,\r\n                            newOwnerId: this.userId,\r\n                            velocity: projectile.velocity,\r\n                            color: projectile.color\r\n                        }));\r\n\r\n                        return;\r\n                    }\r\n                }\r\n\r\n                if (distance <= playerCollider + projectile.size) { // Projectile collided with my player\r\n                    projectilesToRemove.push(id);\r\n\r\n                    const actualDamage = Math.max(0, projectile.damage - myStats.defense);\r\n                    myStats.health.value = Math.max(0, myStats.health.value - actualDamage);\r\n\r\n                    const myHealth = myStats.health.value;\r\n\r\n                    const params: PlayerHitParams = {\r\n                        target: myPlayer,\r\n                        shooterId: projectile.ownerId,\r\n                        damage: projectile.damage,\r\n                        newHealth: myHealth,\r\n                        source: projectile,\r\n                        wasKill: myHealth <= 0\r\n                    }\r\n                    this.playerController.playerHit(params);\r\n                }\r\n            }\r\n\r\n            // Check my projectile's collisions with other players\r\n            if (projectile.ownerId === this.userId) {\r\n                this.playerState.players.forEach((player, playerId) => {\r\n                    if (this.collisionsManager.collisionsEnabled(player)) { // Only check collision if the player has collisions enabled\r\n                        const dx2 = projectile.transform.pos.x - player.transform.pos.x;\r\n                        const dy2 = projectile.transform.pos.y - player.transform.pos.y;\r\n                        const distance2 = Math.sqrt(dx2 * dx2 + dy2 * dy2);\r\n\r\n                        if (distance2 <= this.collisionsManager.getPlayerCollider(player) + projectile.size) { // My projectile hit another player!\r\n                            projectilesToRemove.push(id);\r\n\r\n                            const actualDamage = Math.max(0, projectile.damage - player.stats.defense);\r\n                            const newHealth = Math.max(0, player.stats.health.value - actualDamage);\r\n                            player.stats.health.value = newHealth;\r\n\r\n                            const params: PlayerHitParams = {\r\n                                target: player,\r\n                                shooterId: this.userId,\r\n                                damage: projectile.damage,\r\n                                newHealth: newHealth,\r\n                                source: projectile,\r\n                                wasKill: newHealth <= 0\r\n                            }\r\n                            this.playerController.playerHit(params);\r\n                        }\r\n                    }\r\n                });\r\n            }\r\n\r\n            const shouldRemove = projectile.distanceTraveled >= projectile.range ||\r\n                projectile.transform.pos.x < 0 || projectile.transform.pos.x > WORLD.WIDTH ||\r\n                projectile.transform.pos.y < 0 || projectile.transform.pos.y > WORLD.HEIGHT;\r\n\r\n            if (shouldRemove) {\r\n                projectilesToRemove.push(id);\r\n\r\n                if (projectile.ownerId === this.userId) { // Create burn mark where projectile expired for my projectiles\r\n                    const impactX = projectile.transform.pos.x;\r\n                    const impactY = projectile.transform.pos.y;\r\n\r\n                    const triggeredUniques = this.triggerCollisionUniques(projectile.transform.pos);\r\n\r\n                    // TODO: Catch the triggered uniques, and use that string array, might be a bouncing bullet or something that makes it not get destroyed yet\r\n\r\n                    // Notify others to remove projectile\r\n                    this.roomManager.sendMessage(JSON.stringify({\r\n                        type: 'projectile-remove',\r\n                        projectileId: id\r\n                    }));\r\n\r\n                    const inBounds = impactX >= 0 && impactX <= WORLD.WIDTH && impactY >= 0 && impactY <= WORLD.HEIGHT;\r\n                    if (!inBounds) return;\r\n\r\n                    if (projectile.distanceTraveled >= projectile.range) { // Only spawn effects on impact, not OOB removal\r\n                        const material = this.world.getMaterialAt(Math.round(impactX), Math.round(impactY));\r\n                        if (!material) { console.warn('No material returned from hit.'); return; }\r\n                        const matName = material.name.toLowerCase();\r\n\r\n                        const matParticles = this.particlesManager.particlesConfig.materialParticles[matName];\r\n                        const impactParticles = matParticles?.[projectile.type];\r\n\r\n                        if (!impactParticles) {\r\n                            console.warn(`No impact particles for material: ${matName}, type: ${projectile.type}`);\r\n                        } else {\r\n                            const sparksParams: CreateParticleParams = {\r\n                                id: `impact_particle_${id}`,\r\n                                pos: { x: impactX, y: impactY },\r\n                                particleParams: impactParticles\r\n                            };\r\n\r\n                            this.particlesManager.createParticles(sparksParams);\r\n                        }\r\n\r\n                        const matDecals = this.decalsManager.decalsConfig.materialDecals[matName];\r\n                        const impactDecal = matDecals?.[projectile.type];\r\n\r\n                        if (impactDecal) {\r\n                            this.decalsManager.createDecal({\r\n                                id: `impact_decal_${id}`,\r\n                                pos: { x: impactX, y: impactY },\r\n                                type: 'parametric',\r\n                                parametric: impactDecal\r\n                            });\r\n                        } else {\r\n                            console.warn(`No impact decal for material: ${matName}, type: ${projectile.type}`);\r\n                        }\r\n\r\n                        const impactSounds = this.audioConfig.resources.sfx.impact[matName];\r\n                        if (!impactSounds) { console.warn('No impact sounds for:', matName); return; }\r\n\r\n                        const impactSoundList = impactSounds[projectile.type];\r\n                        if (!impactSoundList || impactSoundList.length <= 0) { console.warn('No impact soundlist for:', impactSounds); return; }\r\n\r\n                        const sfxParams: AudioParams = {\r\n                            src: this.utility.getRandomInArray(impactSoundList),\r\n                            listener: {\r\n                                x: myPlayerX,\r\n                                y: myPlayerY\r\n                            },\r\n                            output: 'sfx',\r\n                            pitch: { min: 0.95, max: 1.125 },\r\n                            spatial: {\r\n                                blend: 1.0,\r\n                                pos: { x: impactX, y: impactY }\r\n                            },\r\n                            volume: { min: 0.965, max: 1 }\r\n                        }\r\n                        this.audioManager.playAudioNetwork(sfxParams);\r\n\r\n                        this.world.worldEdit.requestCraterAt(projectile.transform.pos); // TODO: Update this functionality\r\n                    }\r\n                }\r\n            }\r\n        });\r\n\r\n        projectilesToRemove.forEach(id => { this.projectiles.delete(id); }); // Remove projectiles locally\r\n    }\r\n\r\n    private cachedPrimaryBuffer: number = 0;\r\n    /**\r\n     * Used to enable auto fire on the current ranged weapon.\r\n     */\r\n    public enableAutoFire(timestamp?: number, bufferMult?: number): void {\r\n        this.playerState.canAutoFire = true;\r\n\r\n        this.cachedPrimaryBuffer = this.playerState.myPlayer.actions.primary.buffer\r\n\r\n        if (bufferMult !== undefined) {\r\n            this.playerState.myPlayer.actions.primary.buffer *= bufferMult;\r\n        }\r\n\r\n        console.log('Auto-fire enabled.');\r\n\r\n        if (timestamp !== undefined) {\r\n            this.utility.safeTimeout(() => {\r\n                this.playerState.canAutoFire = false;\r\n                if (bufferMult !== undefined) { this.playerState.myPlayer.actions.primary.buffer = this.cachedPrimaryBuffer; }\r\n                console.log('Auto-fire disabled.');\r\n            }, timestamp - Date.now()); // Duration of override\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Disables auto fire for the primary weapon and restores the original shot buffer.\r\n     */\r\n    public disableAutoFire(): void {\r\n        this.playerState.canAutoFire = false;\r\n        this.playerState.myPlayer.actions.primary.buffer = this.cachedPrimaryBuffer;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Uniques ]\r\n    //\r\n    /**\r\n     * Manually triggers a specific unique effect when called.\r\n     */\r\n    private triggerUnique(unique: string, pos?: Vec2): void {\r\n        if (unique === \"cluster_module\") {\r\n            if (pos) {\r\n                const amount = this.utility.getRandomInt(3, 6);\r\n                const images: string[] = [];\r\n                for (let i = 0; i < amount; i++) {\r\n                    images.push(this.utility.getRandomInArray(SHRAPNEL.PIECE));\r\n                }\r\n                const shrapnel: Shrapnel = {\r\n                    amount: amount,\r\n                    damage: this.playerState.myPlayer.actions.primary.projectile.damage * 0.1,\r\n                    images: images,\r\n                    lifetime: { // ms\r\n                        min: 100,\r\n                        max: 500\r\n                    },\r\n                    pos: {\r\n                        x: pos.x,\r\n                        y: pos.y\r\n                    },\r\n                    size: { // px^2\r\n                        min: 8,\r\n                        max: 14\r\n                    },\r\n                    speed: { // px/frame*(dt)\r\n                        min: 10,\r\n                        max: 15\r\n                    },\r\n                    torque: { // deg/frame*dt\r\n                        min: -360,\r\n                        max: 360\r\n                    }\r\n                }\r\n                this.particlesManager.spawnShrapnel(shrapnel);\r\n            }\r\n        }\r\n\r\n        if (unique === \"projectile_array\") {\r\n            const amount = this.utility.getRandomInt(1, 3);\r\n            for (let i = 0; i < amount; i++) {\r\n                const dir = this.utility.getRandomDirection(360);\r\n\r\n                const params: ProjectileOverrides = {\r\n                    canTriggerUnique: false,\r\n                    damage: this.playerState.myPlayer.actions.primary.projectile.damage / 2,\r\n                    range: this.utility.getRandomNum((this.playerState.myPlayer.actions.primary.projectile.range / 2), this.playerState.myPlayer.actions.primary.projectile.range),\r\n                    spread: this.utility.getRandomNum(this.playerState.myPlayer.actions.primary.projectile.spread, (this.playerState.myPlayer.actions.primary.projectile.spread * 2))\r\n                }\r\n\r\n\r\n                this.launchProjectile(dir, params);\r\n            }\r\n        }\r\n\r\n        console.log(`Triggered Unique: ${unique}`)\r\n    }\r\n\r\n    /**\r\n     * Responsible for processing possible unique triggers on burst. (Before launchProjectile is called...)\r\n     */\r\n    private triggerBurstUniques(): string[] {\r\n        const triggered: string[] = [];\r\n\r\n        if (this.playerState.myPlayer.unique.includes('muzzle_splitter')) {\r\n            if (this.luckController.luckRoll()) {\r\n                const baseAngle = this.playerState.myPlayer.transform.rot - Math.PI / 2;\r\n                const angleOffset = 10 * (Math.PI / 180); // 10 degrees\r\n\r\n                const dirA = { x: Math.cos(baseAngle - angleOffset), y: Math.sin(baseAngle - angleOffset) };\r\n                const dirB = { x: Math.cos(baseAngle + angleOffset), y: Math.sin(baseAngle + angleOffset) };\r\n\r\n                const baseParams: ProjectileOverrides = {\r\n                    canTriggerUnique: false,\r\n                    damage: this.playerState.myPlayer.actions.primary.projectile.damage,\r\n                    range: this.playerState.myPlayer.actions.primary.projectile.range,\r\n                    size: this.playerState.myPlayer.actions.primary.projectile.size,\r\n                    speed: this.playerState.myPlayer.actions.primary.projectile.speed,\r\n                    color: this.playerState.myPlayer.actions.primary.projectile.color,\r\n                    length: this.playerState.myPlayer.actions.primary.projectile.length,\r\n                    spread: this.playerState.myPlayer.actions.primary.projectile.spread\r\n                };\r\n\r\n                this.launchProjectile(dirA, baseParams);\r\n                this.launchProjectile(dirB, baseParams);\r\n\r\n                console.log(`Triggered burst unique: muzzle_splitter`);\r\n                triggered.push('muzzle_splitter');\r\n            }\r\n        }\r\n\r\n        return triggered;\r\n    }\r\n\r\n    /**\r\n     * Responsible for checking specific uniques on collision.\r\n     */\r\n    private triggerCollisionUniques(pos?: Vec2): string[] {\r\n        if (this.playerState.myPlayer.unique.length === 0) return [];\r\n\r\n        const succeededUniques: string[] = [];\r\n\r\n        for (const unique of this.playerState.myPlayer.unique) {\r\n            if (unique === 'cluster_module') {\r\n                const succeeded = this.luckController.luckRoll();\r\n\r\n                if (succeeded) {\r\n                    this.triggerUnique(unique, pos);\r\n                    succeededUniques.push('cluster_module');\r\n                }\r\n            }\r\n        }\r\n        return succeededUniques;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Reload ]\r\n    //\r\n    /**\r\n     * Checks if the player can reload or not.\r\n     */\r\n    private canReload(): boolean {\r\n        return (\r\n            !this.playerState.isReloading &&\r\n            this.playerState.myPlayer.actions.primary.magazine.currentAmmo < this.playerState.myPlayer.actions.primary.magazine.size &&\r\n            this.playerState.myPlayer.actions.primary.magazine.currentReserve > 0 && !this.playerState.isMelee\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Manual trigger for reload. Called when pressing the assigned keybind.\r\n     */\r\n    public startReload(): void {\r\n        if (!this.canReload()) return;\r\n        console.log(`Reloading...`);\r\n\r\n        this.playerState.isReloading = true;\r\n        this.playerState.reloadStartTime = Date.now();\r\n\r\n        // Cancel any ongoing burst\r\n        this.playerState.isBurstActive = false;\r\n        this.playerState.currentBurstShot = 0;\r\n\r\n        this.decalsManager.spawnMagazineDecal();\r\n\r\n        this.animator.animateCharacterPart({\r\n            playerId: this.userId,\r\n            part: 'weapon',\r\n            frames: {\r\n                0: { x: 0, y: 8 } // Slide held back\r\n            },\r\n            duration: 0,\r\n            partIndex: 1\r\n        }); // duration=0 means infinite/held\r\n\r\n        const currentWeapon = this.playerState.myPlayer.inventory.primary;\r\n        const reloadStartSfx = this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[currentWeapon].reload?.start ?? [])\r\n        if (!reloadStartSfx) { console.warn(`No reload sounds for ${currentWeapon}`); return; }\r\n\r\n        this.audioManager.playAudioNetwork({\r\n            src: reloadStartSfx,\r\n            listener: {\r\n                x: this.playerState.myPlayer.transform.pos.x,\r\n                y: this.playerState.myPlayer.transform.pos.y\r\n            },\r\n            output: 'sfx',\r\n            pitch: { min: 0.975, max: 1.05 },\r\n            spatial: {\r\n                blend: 1.0,\r\n                pos: { x: this.playerState.myPlayer.transform.pos.x, y: this.playerState.myPlayer.transform.pos.y }\r\n            },\r\n            volume: { min: 0.985, max: 1 }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Ends the reload loop, and updates visual state.\r\n     */\r\n    private finishReload(): void {\r\n        console.log(`Reload complete...`);\r\n\r\n        const magazineSpace = this.playerState.myPlayer.actions.primary.magazine.size - this.playerState.myPlayer.actions.primary.magazine.currentAmmo;\r\n        const ammoToReload = Math.min(magazineSpace, this.playerState.myPlayer.actions.primary.magazine.currentReserve);\r\n\r\n        this.playerState.myPlayer.actions.primary.magazine.currentAmmo += ammoToReload;\r\n        this.playerState.myPlayer.actions.primary.magazine.currentReserve -= ammoToReload;\r\n        this.playerState.isReloading = false;\r\n\r\n        this.ui.ammoReservesUIController.removeAmmoFromReserveUI(ammoToReload);\r\n\r\n        this.animator.animateCharacterPart({\r\n            playerId: this.userId,\r\n            part: 'weapon',\r\n            frames: {\r\n                0: { x: 0, y: 20 }, // Start with slide back\r\n                1: { x: 0, y: 0 } // Return to start\r\n            },\r\n            duration: 175,\r\n            partIndex: 1\r\n        });\r\n\r\n        const currentWeapon = this.playerState.myPlayer.inventory.primary;\r\n        const reloadEndSfx = this.utility.getRandomInArray(this.audioConfig.resources.sfx.weapon[currentWeapon].reload?.end ?? [])\r\n        if (!reloadEndSfx) { console.warn(`No reload sounds for ${currentWeapon}`); return; }\r\n\r\n        this.audioManager.playAudioNetwork({\r\n            src: reloadEndSfx,\r\n            listener: {\r\n                x: this.playerState.myPlayer.transform.pos.x,\r\n                y: this.playerState.myPlayer.transform.pos.y\r\n            },\r\n            output: 'sfx',\r\n            pitch: { min: 0.975, max: 1.05 },\r\n            spatial: {\r\n                blend: 1.0,\r\n                pos: { x: this.playerState.myPlayer.transform.pos.x, y: this.playerState.myPlayer.transform.pos.y }\r\n            },\r\n            volume: { min: 0.985, max: 1 }\r\n        });\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { NETWORK } from \"../Config\";\r\n\r\nimport { PlayerState } from \"./PlayerState\";\r\nimport { RoomManager } from \"../RoomManager\";\r\nimport { MoveController } from \"./MoveController\";\r\nimport { StaminaController } from \"./StaminaController\";\r\nimport { CombatController } from \"./CombatController\";\r\nimport { CollisionsManager } from \"../CollisionsManager\";\r\n\r\nexport class DashController {\r\n    constructor(\r\n        private collisionsManager: CollisionsManager,\r\n        private combatController: CombatController,\r\n        private moveController: MoveController,\r\n        private playerState: PlayerState,\r\n        private roomManager: RoomManager,\r\n        private staminaController: StaminaController,\r\n        private userId: string\r\n    ) { }\r\n\r\n    // #region [ Dash ]\r\n    //\r\n    /**\r\n     * Start a dash when the assigned keybind is pressed.\r\n     */\r\n    public startDash(): void {\r\n        if (this.playerState.isDashing || !this.collisionsManager.collisionsEnabled(this.playerState.myPlayer) || !this.moveController.isMoveInput()) return;\r\n\r\n        const currentTime = Date.now(); // Cooldown check first\r\n        if (currentTime < this.playerState.lastDashTime + this.playerState.myPlayer.actions.dash.cooldown) {\r\n            console.log('Dash on cooldown');\r\n            return;\r\n        }\r\n\r\n        // Input check\r\n        let { inputX, inputY, inputLength } = this.moveController.getMoveInput();\r\n\r\n        // Normalize input\r\n        if (!this.moveController.isMoveInput()) {\r\n            console.log('No movement input for dash');\r\n            return;\r\n        }\r\n\r\n        inputX = inputX / inputLength;\r\n        inputY = inputY / inputLength;\r\n\r\n        if (!this.staminaController.requestStamina(this.playerState.myPlayer.actions.dash.drain)) {\r\n            console.log('Not enough stamina to dash');\r\n            return;\r\n        }\r\n\r\n        if (this.playerState.myPlayer.unique.includes('spectral_image')) {\r\n            // Set local state\r\n            this.playerState.myPlayer.flags.hidden = true;\r\n            this.playerState.myPlayer.flags.invulnerable = true;\r\n\r\n            // Broadcast partial update\r\n            this.roomManager.sendMessage(JSON.stringify({\r\n                type: 'partial-state',\r\n                userId: this.userId,\r\n                flags: {\r\n                    hidden: true,\r\n                    invulnerable: true\r\n                }\r\n            }));\r\n        }\r\n\r\n        // Start dash\r\n        this.playerState.isDashing = true;\r\n        this.playerState.dashStartTime = currentTime;\r\n        this.playerState.lastDashTime = currentTime;\r\n\r\n        // Set dash velocity\r\n        const dashSpeed = this.playerState.myPlayer.stats.speed * this.playerState.myPlayer.actions.dash.multiplier;\r\n        this.playerState.playerVelocityX = inputX * dashSpeed;\r\n        this.playerState.playerVelocityY = inputY * dashSpeed;\r\n\r\n        console.log(`Dashing! Speed: ${dashSpeed}`);\r\n    }\r\n\r\n    /**\r\n     * Process dash update loop when isDashing.\r\n     */\r\n    public updateDash(delta: number): void {\r\n        if (!this.playerState.isDashing) return;\r\n\r\n        const currentTime = Date.now();\r\n\r\n        let newX = this.playerState.myPlayer.transform.pos.x + this.playerState.playerVelocityX * delta;\r\n        let newY = this.playerState.myPlayer.transform.pos.y + this.playerState.playerVelocityY * delta;\r\n\r\n        this.playerState.myPlayer.transform.pos.x = newX;\r\n        this.playerState.myPlayer.transform.pos.y = newY;\r\n\r\n        let moved = (this.playerState.playerVelocityX !== 0 || this.playerState.playerVelocityY !== 0);\r\n\r\n        // Send position update if moved\r\n        const distanceFromLastSent = Math.sqrt(\r\n            (this.playerState.myPlayer.transform.pos.x - this.playerState.lastSentX) ** 2 +\r\n            (this.playerState.myPlayer.transform.pos.y - this.playerState.lastSentY) ** 2\r\n        );\r\n\r\n        if (moved && distanceFromLastSent > 2 && currentTime - this.playerState.lastSentMoveTime >= NETWORK.MOVE_INTERVAL) {\r\n            this.roomManager.sendMessage(JSON.stringify({\r\n                type: 'player-move',\r\n                transform: {\r\n                    pos: {\r\n                        x: this.playerState.myPlayer.transform.pos.x,\r\n                        y: this.playerState.myPlayer.transform.pos.y\r\n                    }\r\n                }\r\n            }));\r\n\r\n            this.playerState.lastSentX = this.playerState.myPlayer.transform.pos.x;\r\n            this.playerState.lastSentY = this.playerState.myPlayer.transform.pos.y;\r\n            this.playerState.lastSentMoveTime = currentTime;\r\n        }\r\n\r\n        // Check if dash time is over\r\n        if (currentTime >= this.playerState.dashStartTime + this.playerState.myPlayer.actions.dash.time) {\r\n            if (this.playerState.myPlayer.unique.includes('spectral_image')) {\r\n                // Revert local state\r\n                this.playerState.myPlayer.flags.hidden = false;\r\n                this.playerState.myPlayer.flags.invulnerable = false;\r\n\r\n                // Broadcast partial update\r\n                this.roomManager.sendMessage(JSON.stringify({\r\n                    type: 'partial-state',\r\n                    userId: this.userId,\r\n                    flags: {\r\n                        hidden: false,\r\n                        invulnerable: false\r\n                    }\r\n                }));\r\n            }\r\n\r\n            this.playerState.isDashing = false;\r\n\r\n            if (this.playerState.myPlayer.equipment.includes('switch')) {\r\n                this.combatController.enableAutoFire(Date.now() + this.playerState.myPlayer.actions.dash.cooldown, 0.5);\r\n            }\r\n\r\n            console.log('Dash ended');\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { PlayerState } from \"./PlayerState\";\r\n\r\nexport class LuckController {\r\n    constructor(private playerState: PlayerState) { }\r\n\r\n    /**\r\n     * Perform a luck roll using the player's luck stat.\r\n     *\r\n     * Luck is a signed value centered around 0.\r\n     * - Uses tanh() to map luck smoothly into [-1, 1], which gives soft limits.\r\n     * - The resulting chance is 5%95%, with heavy diminishing returns past 10.\r\n     *\r\n     * Approximate success odds:\r\n     *   luck -20  ~2%\r\n     *   luck -10  ~4%\r\n     *   luck  -5  ~6%\r\n     *   luck   0  10%\r\n     *   luck  +5  17%\r\n     *   luck +10  30%\r\n     *   luck +20  45%\r\n     * \r\n     * Optionally pass a multiplier to scale luck.\r\n     */\r\n    public luckRoll(multiplier: number = 1): boolean {\r\n        const effectiveLuck = this.playerState.myPlayer.stats.luck * multiplier;\r\n        const scaledLuck = Math.tanh(effectiveLuck / 10);\r\n\r\n        const baseChance = 0.1; // 10%\r\n        const softCap = 0.35; // 35%\r\n\r\n        const chance = baseChance + scaledLuck * softCap;\r\n        return Math.random() < chance;\r\n    }\r\n}","import { ControlsManager } from \"../ControlsManager\";\r\nimport { SettingsManager } from \"../SettingsManager\";\r\nimport { PlayerState } from \"./PlayerState\";\r\n\r\nexport class MoveController {\r\n    private currentSpeed: number = 0;\r\n    private maxSpeed: number = 0;\r\n\r\n    constructor(private controlsManager: ControlsManager, private playerState: PlayerState, private settingsManager: SettingsManager) { }\r\n\r\n    /**\r\n     * Detects and returns the Vec2 movement input from the assigned keybinds.\r\n     */\r\n    public getMoveInput(): { inputX: number; inputY: number; inputLength: number } {\r\n        let inputX = 0;\r\n        let inputY = 0;\r\n\r\n        if (this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveUp)) inputY -= 1;\r\n        if (this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveDown)) inputY += 1;\r\n        if (this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveLeft)) inputX -= 1;\r\n        if (this.controlsManager.getActiveKeys().has(this.settingsManager.getSettings().controls.keybinds.moveRight)) inputX += 1;\r\n\r\n        const inputLength = Math.sqrt(inputX * inputX + inputY * inputY);\r\n\r\n        if (inputLength > 0) {\r\n            inputX = inputX / inputLength;\r\n            inputY = inputY / inputLength;\r\n        }\r\n\r\n        return { inputX, inputY, inputLength };\r\n    }\r\n\r\n    /**\r\n     * Returns state based on if the player is currently pressing move buttons or not.\r\n     */\r\n    public isMoveInput(): boolean {\r\n        return this.getMoveInput().inputLength > 0;\r\n    }\r\n\r\n    /**\r\n     * Returns state based on if the player is currently moving or not.\r\n     */\r\n    public isMoving(): boolean {\r\n        return Math.abs(this.playerState.playerVelocityX) > 0.01 || Math.abs(this.playerState.playerVelocityY) > 0.01;\r\n    }\r\n\r\n    /**\r\n     * Sets and gets the stored move speed.\r\n     */\r\n    public getMoveSpeed(): number {\r\n        return this.currentSpeed = Math.sqrt(this.playerState.playerVelocityX ** 2 + this.playerState.playerVelocityY ** 2);\r\n    }\r\n\r\n    /**\r\n     * Sets and gets the stored max player move speed.\r\n     */\r\n    public getMaxSpeed(): number { // TODO: Probably need to hardcap this somehow\r\n        return this.maxSpeed = this.playerState.myPlayer.stats.speed * this.playerState.myPlayer.actions.sprint.multiplier;\r\n    }\r\n}","import { FrictionTypes } from \"../Types\";\r\n\r\nexport class PlayerConfig {\r\n    public default = {\r\n        actions: {\r\n            dash: {\r\n                cooldown: 1000, // ms\r\n                drain: 40, // per dash\r\n                multiplier: 3,\r\n                time: 150 // ms\r\n            },\r\n            melee: {\r\n                cooldown: 250, // ms\r\n                damage: 10,\r\n                duration: 100, // ms\r\n                range: 10, // px\r\n                size: 2, // px^2 area at tip\r\n            },\r\n            primary: {\r\n                buffer: 250, // ms\r\n                burst: {\r\n                    amount: 1,\r\n                    delay: 75 // ms\r\n                },\r\n                magazine: {\r\n                    size: 10,\r\n                    startingReserve: 20,\r\n                    maxReserve: 50\r\n                },\r\n                offset: 10, // px\r\n                projectile: {\r\n                    amount: 1,\r\n                    color: '#fff5beff',\r\n                    damage: 25,\r\n                    length: 15,\r\n                    range: 5,\r\n                    size: 1,\r\n                    speed: 35,\r\n                    spread: 10\r\n                },\r\n                reload: {\r\n                    time: 750 // ms\r\n                }\r\n            },\r\n            sprint: {\r\n                drain: 5, // per ms\r\n                multiplier: 1.75\r\n            },\r\n        },\r\n        data: {\r\n            idLength: 12,\r\n            idOffset: 25\r\n        },\r\n        equipment: [],\r\n        flags: {\r\n            hidden: false,\r\n            invulnerable: false\r\n        },\r\n        inventory: {\r\n            primary: 'glock',\r\n            melee: 'knife'\r\n        },\r\n        physics: {\r\n            acceleration: 0.65,\r\n            friction: FrictionTypes.Normal\r\n        },\r\n        rig: {\r\n            body: 'default',\r\n            head: 'default',\r\n            headwear: 'default',\r\n            weapon: 'glock'\r\n        },\r\n        stats: {\r\n            defense: 0,\r\n            health: {\r\n                max: 100\r\n            },\r\n            luck: 1,\r\n            size: 100, // px^2\r\n            speed: 6,\r\n            stamina: {\r\n                max: 100,\r\n                recovery: {\r\n                    delay: 1000,\r\n                    rate: 25\r\n                }\r\n            }\r\n        },\r\n        unique: []\r\n    };\r\n\r\n    constructor() { }\r\n}","import { NETWORK } from \"../Config\";\r\nimport { AudioParams, CreateParticleParams, DeathDecal, DecalParams, EmitterParams, FootstepParams, LiquidFrictionTypes, Material, PixelWaterData, PlayerHitParams, Vec2 } from \"../Types\";\r\n\r\nimport { DecalsManager } from \"../DecalsManager\";\r\nimport { GameState } from \"../GameState\";\r\nimport { LuckController } from \"./LuckController\";\r\nimport { MoveController } from \"./MoveController\";\r\nimport { ObjectsManager } from \"../ObjectsManager\";\r\nimport { PlayerState } from \"./PlayerState\";\r\nimport { RoomManager } from \"../RoomManager\";\r\nimport { UserInterface } from \"../UserInterface\";\r\nimport { Utility } from \"../Utility\";\r\n\r\nimport { AudioConfig } from \"../audio/AudioConfig\";\r\nimport { AudioManager } from \"../audio/AudioManager\";\r\n\r\nimport { ParticlesManager } from \"../particles/ParticlesManager\";\r\n\r\nimport { World } from \"../world/World\";\r\n\r\nexport class PlayerController {\r\n    public lastMaterial: Material | null = null;\r\n    public lastWaterData: PixelWaterData | null = null;\r\n    public lastFriction: number = 0;\r\n    \r\n    // Footstep Configuration\r\n    //\r\n    private footstepInterval = 0;\r\n    private lastFootstepTime = 0;\r\n    private readonly FOOTSTEP_INTERVAL_MIN = 200; // ms - running\r\n    private readonly FOOTSTEP_INTERVAL_MAX = 500; // ms - walking\r\n    private readonly FOOTSTEP_SAMPLE_RADIUS = 8; // pixels around player\r\n    //\r\n    //\r\n\r\n    private readonly MEDIUM_WATER_DEPTH = 0.35;\r\n    private readonly DEEP_WATER_DEPTH = 0.6;\r\n    private readonly POSITION_SAMPLE_INTERVAL = 250; // ms\r\n\r\n    private lastSampleTime = 0;\r\n\r\n    constructor(\r\n        private audioConfig: AudioConfig,\r\n        private audioManager: AudioManager,\r\n        private decalsManager: DecalsManager,\r\n        private gameState: GameState,\r\n        private luckController: LuckController,\r\n        private moveController: MoveController,\r\n        private objectsManager: ObjectsManager,\r\n        private particlesManager: ParticlesManager,\r\n        private playerState: PlayerState,\r\n        private roomManager: RoomManager,\r\n        private ui: UserInterface,\r\n        private userId: string,\r\n        private utility: Utility,\r\n        private world: World\r\n    ) {\r\n        this.setupEventListeners();\r\n        this.initSwimDebugMenu();\r\n    }\r\n\r\n    private setupEventListeners(): void {\r\n        window.addEventListener('customEvent_playerHitRelay', ((event: CustomEvent) => {\r\n            console.log('Player hit event received:', event.detail.params);\r\n            this.playerHit(event.detail.params);\r\n        }) as EventListener);\r\n    }\r\n\r\n    public updatePlayerPosition(delta: number): void {\r\n        if (!this.gameState.gameInProgress || this.playerState.myPlayer.stats.health.value <= 0)\r\n            return;\r\n\r\n        const now = Date.now();\r\n        const { inputX, inputY } = this.moveController.getMoveInput();\r\n        const isMoveInput = this.moveController.isMoveInput();\r\n        const isMoving = this.moveController.isMoving();\r\n\r\n        // Water sampling\r\n        if (isMoving && now - this.lastSampleTime >= this.POSITION_SAMPLE_INTERVAL) {\r\n            this.samplePlayerPosition(now);\r\n        }\r\n\r\n        this.applyEnvironmentalFriction(delta);\r\n\r\n        // Movement logic\r\n        if (this.playerState.isSwimming) {\r\n            this.handleSwimming(delta, inputX, inputY, isMoveInput);\r\n        } else if (!this.playerState.isDashing) {\r\n            this.handleGroundMovement(delta, inputX, inputY, isMoveInput);\r\n        }\r\n\r\n        // Position update\r\n        this.playerState.myPlayer.transform.pos.x += this.playerState.playerVelocityX * delta;\r\n        this.playerState.myPlayer.transform.pos.y += this.playerState.playerVelocityY * delta;\r\n\r\n        // Network + footsteps\r\n        this.syncMovement(now);\r\n\r\n        if (!this.playerState.isSwimming && this.moveController.isMoving()) {\r\n            const speedRatio = Math.min(1, this.moveController.getMoveSpeed() / this.moveController.getMaxSpeed());\r\n            this.footstepInterval =\r\n                this.FOOTSTEP_INTERVAL_MAX -\r\n                speedRatio * (this.FOOTSTEP_INTERVAL_MAX - this.FOOTSTEP_INTERVAL_MIN);\r\n\r\n            if (now - this.lastFootstepTime >= this.footstepInterval) {\r\n                this.footstep();\r\n                this.lastFootstepTime = now;\r\n            }\r\n        }\r\n    }\r\n\r\n    private handleGroundMovement(delta: number, inputX: number, inputY: number, isMoveInput: boolean): void {\r\n        // Sprinting logic\r\n        const canSprint =\r\n            this.playerState.isSprinting &&\r\n            this.playerState.myPlayer.stats.stamina.value > 0 &&\r\n            isMoveInput;\r\n\r\n        const currentSpeed = canSprint\r\n            ? this.playerState.myPlayer.stats.speed *\r\n            this.playerState.myPlayer.actions.sprint.multiplier\r\n            : this.playerState.myPlayer.stats.speed;\r\n\r\n        // If sprinting but out of stamina, stop\r\n        if (this.playerState.isSprinting && this.playerState.myPlayer.stats.stamina.value <= 0) {\r\n            this.playerState.isSprinting = false;\r\n            console.log(\"Out of stamina, stopped sprinting\");\r\n        }\r\n\r\n        if (isMoveInput) {\r\n            const accel = this.playerState.myPlayer.physics.acceleration;\r\n            const targetVX = inputX * currentSpeed;\r\n            const targetVY = inputY * currentSpeed;\r\n\r\n            this.playerState.playerVelocityX += (targetVX - this.playerState.playerVelocityX) * accel * delta;\r\n            this.playerState.playerVelocityY += (targetVY - this.playerState.playerVelocityY) * accel * delta;\r\n        }\r\n    }\r\n\r\n    private lastStrokeTime: number = 0;\r\n    private strokePower: number = 0;\r\n    private lastSwimDir: Vec2 = { x: 0, y: 0 };\r\n\r\n    public STROKE_FORCE = 7.5;\r\n    public STROKE_DECAY_RATE = 0.996;\r\n    public STROKE_COOLDOWN = 0.8;\r\n    public MAX_SWIM_SPEED = 3.5;\r\n\r\n    // Drop this anywhere in PlayerController (or a debug-only file)\r\n    private initSwimDebugMenu(): void {\r\n        window.addEventListener(\"keydown\", (e: KeyboardEvent) => {\r\n            if (e.ctrlKey && e.code === \"Numpad5\") {\r\n                this.toggleSwimDebugMenu();\r\n            }\r\n        });\r\n    }\r\n\r\n    private toggleSwimDebugMenu(): void {\r\n        let panel = document.getElementById(\"swimDebugPanel\");\r\n        if (panel) {\r\n            panel.remove();\r\n            console.log(\"Swim Debug Menu closed\");\r\n            return;\r\n        }\r\n\r\n        panel = document.createElement(\"div\");\r\n        panel.id = \"swimDebugPanel\";\r\n        panel.style.position = \"fixed\";\r\n        panel.style.top = \"20px\";\r\n        panel.style.right = \"20px\";\r\n        panel.style.background = \"rgba(0,0,0,0.8)\";\r\n        panel.style.color = \"#fff\";\r\n        panel.style.padding = \"10px\";\r\n        panel.style.zIndex = \"9999\";\r\n        panel.style.fontFamily = \"monospace\";\r\n        panel.style.fontSize = \"12px\";\r\n        panel.style.border = \"1px solid #555\";\r\n        panel.style.width = \"200px\";\r\n\r\n        const settings = [\r\n            { key: \"STROKE_FORCE\", min: 1, max: 200, step: 1 },\r\n            { key: \"STROKE_DECAY_RATE\", min: 0.8, max: 0.999, step: 0.001 },\r\n            { key: \"STROKE_COOLDOWN\", min: 0.1, max: 3, step: 0.05 },\r\n            { key: \"MAX_SWIM_SPEED\", min: 1, max: 10, step: 0.1 },\r\n        ];\r\n\r\n        settings.forEach(setting => {\r\n            const label = document.createElement(\"label\");\r\n            label.textContent = setting.key;\r\n            label.style.display = \"block\";\r\n\r\n            const input = document.createElement(\"input\");\r\n            input.type = \"range\";\r\n            input.min = String(setting.min);\r\n            input.max = String(setting.max);\r\n            input.step = String(setting.step);\r\n            // @ts-ignore\r\n            input.value = String(this[setting.key]);\r\n\r\n            const valueText = document.createElement(\"span\");\r\n            // @ts-ignore\r\n            valueText.textContent = \" \" + this[setting.key];\r\n\r\n            input.addEventListener(\"input\", () => {\r\n                const v = parseFloat(input.value);\r\n                // @ts-ignore\r\n                this[setting.key] = v;\r\n                valueText.textContent = \" \" + v.toFixed(3);\r\n                console.log(`Adjusted ${setting.key}: ${v}`);\r\n            });\r\n\r\n            panel.appendChild(label);\r\n            panel.appendChild(input);\r\n            panel.appendChild(valueText);\r\n        });\r\n\r\n        document.body.appendChild(panel);\r\n        console.log(\"Swim Debug Menu opened\");\r\n    }\r\n\r\n\r\n    private handleSwimming(delta: number, inputX: number, inputY: number, isMoveInput: boolean): void {\r\n        this.playerState.isSprinting = false;\r\n        this.playerState.isDashing = false;\r\n\r\n        const now = performance.now(); // more precise than Date.now()\r\n\r\n        if (isMoveInput) {\r\n            this.lastSwimDir.x = inputX;\r\n            this.lastSwimDir.y = inputY;\r\n\r\n            // fire only once per cooldown window\r\n            if (now - this.lastStrokeTime >= this.STROKE_COOLDOWN * 1000) {\r\n                this.strokePower = this.STROKE_FORCE;\r\n                this.lastStrokeTime = now;\r\n                console.log(\"Swim stroke triggered | Power: \" + this.strokePower);\r\n            }\r\n        } else {\r\n            this.strokePower = 0;\r\n            return;\r\n        }\r\n\r\n        // active stroke adds impulse + decays\r\n        if (this.strokePower > 0) {\r\n            this.playerState.playerVelocityX += this.lastSwimDir.x * this.strokePower * delta;\r\n            this.playerState.playerVelocityY += this.lastSwimDir.y * this.strokePower * delta;\r\n            this.strokePower *= Math.pow(this.STROKE_DECAY_RATE, delta * 60);\r\n        }\r\n\r\n        const vx = this.playerState.playerVelocityX;\r\n        const vy = this.playerState.playerVelocityY;\r\n        const speed = Math.sqrt(vx * vx + vy * vy);\r\n        if (speed > this.MAX_SWIM_SPEED) {\r\n            const scale = this.MAX_SWIM_SPEED / speed;\r\n            this.playerState.playerVelocityX *= scale;\r\n            this.playerState.playerVelocityY *= scale;\r\n        }\r\n    }\r\n\r\n\r\n\r\n    private syncMovement(now: number): void {\r\n        const distance = Math.sqrt(\r\n            (this.playerState.myPlayer.transform.pos.x - this.playerState.lastSentX) ** 2 +\r\n            (this.playerState.myPlayer.transform.pos.y - this.playerState.lastSentY) ** 2\r\n        );\r\n\r\n        const isMoving = this.moveController.isMoving();\r\n\r\n        if (isMoving && distance > 2 && now - this.playerState.lastSentMoveTime >= NETWORK.MOVE_INTERVAL) {\r\n            this.roomManager.sendMessage(JSON.stringify({\r\n                type: \"player-move\",\r\n                transform: { pos: this.playerState.myPlayer.transform.pos }\r\n            }));\r\n\r\n            this.playerState.lastSentX = this.playerState.myPlayer.transform.pos.x;\r\n            this.playerState.lastSentY = this.playerState.myPlayer.transform.pos.y;\r\n            this.playerState.lastSentMoveTime = now;\r\n        }\r\n    }\r\n\r\n    private applyEnvironmentalFriction(delta: number): void {\r\n        let appliedFriction = this.lastFriction;\r\n\r\n        if (this.lastWaterData && this.lastWaterData.hasWater) {\r\n            const depth = this.lastWaterData.waterLevel;\r\n\r\n            if (depth >= this.DEEP_WATER_DEPTH) {\r\n                // fully submerged  use water friction directly\r\n                appliedFriction = LiquidFrictionTypes.Water;\r\n            } else {\r\n                // shallow / medium  increase drag temporarily\r\n                const blend = this.utility.clamp(depth / this.DEEP_WATER_DEPTH, 0, 1);\r\n\r\n                // inverted curve: shallow = strongest drag\r\n                const shallowDragBoost = 1 - Math.pow(blend, 2);\r\n\r\n                // compound land friction and extra shallow drag\r\n                appliedFriction = this.lastFriction * (1 - 0.25 * shallowDragBoost);\r\n            }\r\n        }\r\n\r\n        appliedFriction = this.utility.clamp(appliedFriction, 0.7, 1.0);\r\n\r\n        const frictionFactor = Math.pow(appliedFriction, delta);\r\n        this.playerState.playerVelocityX *= frictionFactor;\r\n        this.playerState.playerVelocityY *= frictionFactor;\r\n    }\r\n\r\n    private samplePlayerPosition(now: number): void {\r\n        const playerPos = this.playerState.myPlayer.transform.pos;\r\n        const samplePos: Vec2 = { x: Math.round(playerPos.x), y: Math.round(playerPos.y) };\r\n\r\n        this.lastWaterData = this.world.getWaterData(samplePos);\r\n        this.lastSampleTime = now;\r\n\r\n        const mat = this.world.getMaterialAt(samplePos.x, samplePos.y);\r\n        this.lastMaterial = mat || null;\r\n\r\n        const surface = this.world.getPhysicsAt(samplePos.x, samplePos.y, mat);\r\n\r\n        if (surface && \"friction\" in surface) {\r\n            const value = (surface as { friction?: number }).friction;\r\n            if (typeof value === \"number\") {\r\n                this.lastFriction = value;\r\n                console.log(\"Updated surface friction:\", value);\r\n            }\r\n        }\r\n\r\n        if (this.lastWaterData && this.lastWaterData.hasWater) {\r\n            const inDeepWater = this.lastWaterData.waterLevel >= this.DEEP_WATER_DEPTH;\r\n            if (inDeepWater && !this.playerState.isSwimming) {\r\n                this.playerState.isSwimming = true;\r\n                console.log(\r\n                    \"Entered swimming state, waterLevel: \" + this.lastWaterData.waterLevel\r\n                );\r\n            } else if (!inDeepWater && this.playerState.isSwimming) {\r\n                this.playerState.isSwimming = false;\r\n                console.log(\r\n                    \"Exited swimming state, waterLevel: \" + this.lastWaterData.waterLevel\r\n                );\r\n            }\r\n        } else if (this.playerState.isSwimming) {\r\n            this.playerState.isSwimming = false;\r\n            console.log(\"Exited swimming state, no water detected\");\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Processes local hits to players. Sends network message for syncing.\r\n     */\r\n    public playerHit(params: PlayerHitParams): void {\r\n        this.ui.updateSlider('health');\r\n\r\n        if (params.target.id === this.userId) { // Random chance to play grunt when I'm hit\r\n            if (this.utility.getRandomNum(0, 1) < 0.2) { // 20%\r\n                const gruntParams: AudioParams = {\r\n                    src: this.utility.getRandomInArray(this.audioConfig.resources.sfx.player.voice.voice_00.grunt), // TODO: Allow player to define gender\r\n                    listener: {\r\n                        x: this.playerState.myPlayer.transform.pos.x,\r\n                        y: this.playerState.myPlayer.transform.pos.y\r\n                    },\r\n                    output: 'voice',\r\n                    pitch: { min: 0.95, max: 1.075 },\r\n                    spatial: {\r\n                        blend: 1.0,\r\n                        pos: { x: this.playerState.myPlayer.transform.pos.x, y: this.playerState.myPlayer.transform.pos.y }\r\n                    },\r\n                    volume: { min: 0.9, max: 1 }\r\n                }\r\n                this.audioManager.playAudioNetwork(gruntParams);\r\n            }\r\n        } else { // The player hit was not me\r\n            const sfxParams: AudioParams = {\r\n                src: this.utility.getRandomInArray(this.audioConfig.resources.sfx.impact.flesh.ranged), // TODO: User current body material && attack type hit\r\n                listener: {\r\n                    x: this.playerState.myPlayer.transform.pos.x,\r\n                    y: this.playerState.myPlayer.transform.pos.y\r\n                },\r\n                output: 'sfx',\r\n                pitch: { min: 0.925, max: 1.15 },\r\n                spatial: {\r\n                    blend: 1.0,\r\n                    pos: { x: params.source.transform.pos.x, y: params.source.transform.pos.y }\r\n                },\r\n                volume: { min: 0.95, max: 1 }\r\n            }\r\n            this.audioManager.playAudioNetwork(sfxParams);\r\n\r\n            const decalParams: DecalParams = {\r\n                id: `blood_${params.source.id}`,\r\n                pos: {\r\n                    x: params.source.transform.pos.x,\r\n                    y: params.source.transform.pos.y\r\n                },\r\n                type: 'parametric',\r\n                parametric: this.decalsManager.decalsConfig.decals.blood // TODO: Get current blood type\r\n            };\r\n            this.decalsManager.createDecal(decalParams);\r\n\r\n            const bloodDirection: Vec2 = {\r\n                x: -params.source.velocity.x / Math.sqrt(params.source.velocity.x ** 2 + params.source.velocity.y ** 2),\r\n                y: -params.source.velocity.y / Math.sqrt(params.source.velocity.x ** 2 + params.source.velocity.y ** 2)\r\n            };\r\n\r\n            const particleParams: CreateParticleParams = {\r\n                id: `blood_${params.source.id}`,\r\n                pos: {\r\n                    x: params.source.transform.pos.x,\r\n                    y: params.source.transform.pos.y\r\n                },\r\n                particleParams: this.particlesManager.particlesConfig.goreParticles.blood.spray, // TODO: Get current blood type\r\n                direction: bloodDirection\r\n            }\r\n            this.particlesManager.createParticles(particleParams);\r\n\r\n            const emission: EmitterParams = {\r\n                id: `particle_emitter_${params.target.id}_${Date.now()}`,\r\n                interval: this.utility.getRandomNum(200, 400), // ms\r\n                lifetime: this.utility.getRandomNum(1000, 3000), // ms\r\n                offset: {\r\n                    x: params.target.transform.pos.x,\r\n                    y: params.target.transform.pos.y\r\n                },\r\n                particleType: this.particlesManager.particlesConfig.goreParticles.blood.drip, // TODO: Get current blood type\r\n                playerId: params.target.id,\r\n                pos: {\r\n                    x: params.source.transform.pos.x,\r\n                    y: params.source.transform.pos.y\r\n                }\r\n            };\r\n            this.particlesManager.createEmitter(emission);\r\n\r\n            if (params.newHealth <= 0) { // If they died, I get a kill\r\n                console.log(`I killed ${params.target.id}!`);\r\n\r\n                const me = this.ui.leaderboard.get(this.userId);\r\n                if (me) { me.kills++; }\r\n\r\n                const other = this.ui.leaderboard.get(params.target.id);\r\n                if (other) { other.deaths++; }\r\n\r\n                this.ui.updateLeaderboardDisplay(this.userId);\r\n            }\r\n        }\r\n\r\n        const message = {\r\n            type: 'player-hit',\r\n            targetId: params.target.id,\r\n            shooterId: params.shooterId,\r\n            damage: params.damage,\r\n            newHealth: params.newHealth,\r\n            projectileId: params.source.id,\r\n            wasKill: params.wasKill\r\n        }\r\n        this.roomManager.sendMessage(JSON.stringify(message));\r\n    }\r\n\r\n    /**\r\n     * Record the player's own death when they are the targetId of a player-hit message and their health reaches 0.\r\n     */\r\n    public playerDeath(): void {\r\n        const triggeredUniques = this.triggerUniques();\r\n\r\n        console.log('I died! Waiting for round to end...');\r\n\r\n        this.playerState.resetPlayerState();\r\n\r\n        const ammoBox = this.objectsManager.spawnAmmoBox(10);\r\n        this.objectsManager.ammoBoxes.set(ammoBox.id, ammoBox);\r\n\r\n        const gore: DeathDecal = {\r\n            gore: {\r\n                amount: this.utility.getRandomInt(2, 5)\r\n            },\r\n            blood: {\r\n                amount: this.utility.getRandomInt(1, 3)\r\n            },\r\n            ownerId: this.userId,\r\n            pos: {\r\n                x: this.playerState.myPlayer.transform.pos.x,\r\n                y: this.playerState.myPlayer.transform.pos.y\r\n            },\r\n            radius: this.playerState.myPlayer.stats.size\r\n        }\r\n        this.decalsManager.generateGore(gore);\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'player-death',\r\n            playerId: this.userId,\r\n            x: this.playerState.myPlayer.transform.pos.x,\r\n            y: this.playerState.myPlayer.transform.pos.y,\r\n            size: this.playerState.myPlayer.stats.size,\r\n            ammoBox: ammoBox\r\n        }));\r\n    }\r\n\r\n    /**\r\n     * Used to trigger player related uniques during specific states like death, etc.\r\n     * \r\n     * Returns each unique that succeeds.\r\n     */\r\n    private triggerUniques(): string[] {\r\n        if (this.playerState.myPlayer.unique.length === 0) return [];\r\n\r\n        const succeededUniques: string[] = [];\r\n\r\n        for (const unique of this.playerState.myPlayer.unique) {\r\n            if (unique === 'phoenix_module') {\r\n                const succeeded = this.luckController.luckRoll(1.5);\r\n\r\n                if (succeeded) {\r\n                    console.log('Phoenix Module activated!');\r\n\r\n                    // Double damage permanently\r\n                    this.playerState.myPlayer.actions.primary.projectile.damage *= 2;\r\n\r\n                    // Remove phoenix module so it can't trigger again\r\n                    const index = this.playerState.myPlayer.unique.indexOf('phoenix_module');\r\n                    if (index > -1) {\r\n                        this.playerState.myPlayer.unique.splice(index, 1);\r\n                    }\r\n\r\n                    succeededUniques.push('phoenix_module');\r\n                }\r\n            }\r\n        }\r\n        return succeededUniques;\r\n    }\r\n\r\n    /**\r\n     * Samples terrain and water around player and blends both materials for footstep audio.\r\n     */\r\n    private footstep(): void {\r\n        const playerPos = this.playerState.myPlayer.transform.pos;\r\n        const materialCounts = new Map<string, number>();\r\n        const samplePoints = 8; // TODO: Optimize this\r\n\r\n        for (let i = 0; i < samplePoints; i++) {\r\n            const angle = (i / samplePoints) * Math.PI * 2;\r\n            const sampleX = Math.round(playerPos.x + Math.cos(angle) * this.FOOTSTEP_SAMPLE_RADIUS);\r\n            const sampleY = Math.round(playerPos.y + Math.sin(angle) * this.FOOTSTEP_SAMPLE_RADIUS);\r\n            const mat = this.world.getMaterialAt(sampleX, sampleY);\r\n            if (mat) materialCounts.set(mat.name, (materialCounts.get(mat.name) || 0) + 1);\r\n        }\r\n\r\n        // Determine dominant ground material\r\n        let primaryMaterial: string | null = null;\r\n        let maxCount = 0;\r\n        materialCounts.forEach((count, matName) => {\r\n            if (count > maxCount) {\r\n                maxCount = count;\r\n                primaryMaterial = matName;\r\n            }\r\n        });\r\n        if (!primaryMaterial) return;\r\n\r\n        // Use cached water data\r\n        const cached = this.lastWaterData;\r\n        const waterRatio = cached && cached.hasWater ? this.utility.clamp(cached.waterLevel, 0, 1) : 0;\r\n        const isWet = waterRatio > 0.05;\r\n\r\n        const moveSpeed = this.moveController.getMoveSpeed();\r\n        const maxSpeed = this.moveController.getMaxSpeed();\r\n        const speedRatio = Math.min(1, moveSpeed / maxSpeed);\r\n\r\n        const context: FootstepParams = {\r\n            pos: playerPos,\r\n            material: primaryMaterial,\r\n            waterRatio: waterRatio,\r\n            isWet: isWet,\r\n            speedRatio: speedRatio\r\n        };\r\n\r\n        this.footstepSound(context);\r\n        this.footstepImpact(context);\r\n    }\r\n\r\n\r\n    /**\r\n     * Plays a footstep sound with the provided context.\r\n     */\r\n    private footstepSound(params: FootstepParams): void {\r\n        const { pos, material, waterRatio, isWet, speedRatio } = params;\r\n\r\n        const footsteps = this.audioConfig.resources.sfx.player.locomotion.footsteps;\r\n        const materialFootsteps = footsteps[material as keyof typeof footsteps];\r\n        if (!materialFootsteps || !Array.isArray(materialFootsteps) || materialFootsteps.length === 0) return;\r\n\r\n        // --- Unified volume & pitch scaling ---\r\n        const baseVolumeMin = 0.001;\r\n        const baseVolumeMax = 0.01;\r\n        const speedInfluence = 0.075;\r\n        const depthInfluence = 0.1;\r\n\r\n        // Blend both influences  faster & deeper = louder\r\n        const influence = speedInfluence * speedRatio + depthInfluence * waterRatio;\r\n        const scaledMin = baseVolumeMin + influence;\r\n        const scaledMax = baseVolumeMax + influence;\r\n\r\n        const pitchMin = 0.95 + speedRatio * 0.03;\r\n        const pitchMax = 1.05 + speedRatio * 0.03;\r\n\r\n        const waterBlend = Math.min(1, waterRatio * 6);\r\n        const groundVolumeScale = 1 - waterBlend;\r\n        const waterVolumeScale = 0.5 + waterBlend * 0.5;\r\n\r\n        const groundStartOffset = 0.04 * (1 - speedRatio);\r\n\r\n        // Ground step\r\n        if (waterRatio < this.MEDIUM_WATER_DEPTH) {\r\n            const baseFootstep = this.utility.getRandomInArray(materialFootsteps);\r\n            const baseParams: AudioParams = {\r\n                src: baseFootstep,\r\n                listener: pos,\r\n                output: \"sfx\",\r\n                pitch: { min: pitchMin, max: pitchMax },\r\n                startTime: { min: groundStartOffset, max: groundStartOffset + 0.005 },\r\n                volume: { min: scaledMin * groundVolumeScale, max: scaledMax * groundVolumeScale }\r\n            };\r\n            this.audioManager.playAudio(baseParams);\r\n        }\r\n\r\n        // Water layer\r\n        if (isWet) {\r\n            const waterFootsteps = footsteps.water;\r\n            let splashArray: string[] = [];\r\n\r\n            if (waterRatio > 0 && waterRatio < this.MEDIUM_WATER_DEPTH) splashArray = waterFootsteps.light;\r\n            else if (waterRatio >= this.MEDIUM_WATER_DEPTH) splashArray = waterFootsteps.medium;\r\n\r\n            if (splashArray.length > 0) {\r\n                const waterStartOffset = 0.04 * speedRatio;\r\n                const randomSplash = this.utility.getRandomInArray(splashArray);\r\n                const splashParams: AudioParams = {\r\n                    src: randomSplash,\r\n                    listener: pos,\r\n                    output: \"sfx\",\r\n                    pitch: { min: pitchMin, max: pitchMax },\r\n                    startTime: { min: waterStartOffset, max: waterStartOffset + 0.005 },\r\n                    volume: { min: scaledMin * waterVolumeScale, max: scaledMax * waterVolumeScale },\r\n                    delay: { min: 0.015, max: 0.02 }\r\n                };\r\n                this.audioManager.playAudio(splashParams);\r\n            }\r\n        }\r\n    }\r\n\r\n    private footstepImpact(params: FootstepParams): void {\r\n        const { pos, material, speedRatio, waterRatio } = params;\r\n        const force = (0.4 + speedRatio * 0.6) * (1 - waterRatio * 0.5);\r\n        this.world.worldEdit.applyFootstepAt(pos, material, force);\r\n    }\r\n}","import { WORLD } from \"../Config\";\r\n\r\nimport { Player, Players } from \"../Types\";\r\nimport { Utility } from \"../Utility\";\r\nimport { PlayerConfig } from \"./PlayerConfig\";\r\n\r\nexport class PlayerState {\r\n    public myPlayer: Player; // My player object\r\n    public players: Players = new Map(); // Other players in game\r\n\r\n    public isHost = false;\r\n\r\n    public canShoot = true;\r\n    public canAutoFire = false;\r\n    public isBurstActive = false;\r\n    public isReloading = false;\r\n    public isMelee = false;\r\n    public isSprinting = false;\r\n    public isDashing = false;\r\n    public isStaminaRecoveryBlocked = false;\r\n    public isSwimming = false;\r\n\r\n    public lastSentX = 0;\r\n    public lastSentY = 0;\r\n    public lastSentRotation = 0;\r\n    public lastSentRotationTime = 0;\r\n    public lastSentMoveTime = 0;\r\n\r\n    public playerVelocityX = 0;\r\n    public playerVelocityY = 0;\r\n\r\n    public dashStartTime = 0;\r\n    public lastDashTime = 0;\r\n    public reloadStartTime = 0;\r\n    public lastShotTime = 0;\r\n    public lastMeleeTime = 0;\r\n    public nextBurstShotTime = 0;\r\n    public currentBurstShot = 0;\r\n    public lastStaminaDrainTime = 0;\r\n    public staminaRecoveryBlockedUntil = 0;\r\n\r\n    private statListeners: Map<string, (value: any) => void> = new Map();\r\n\r\n    constructor(private playerConfig: PlayerConfig, private userId: string, private utility: Utility) {\r\n        this.myPlayer = this.initPlayer(this.userId);\r\n    }\r\n\r\n    /**\r\n     * Resets the internal state of the player.\r\n     */\r\n    public clear(): void {\r\n        this.players.clear();\r\n        this.resetPlayerState();\r\n    }\r\n\r\n    // #region [ State ]\r\n    //\r\n    // [ IMPORTANT ] Keep full track of Player object here\r\n    /**\r\n     * Initializes the default player object using the playerConfig.\r\n     */\r\n    public initPlayer(userId: string): Player {\r\n        return this.myPlayer = {\r\n            id: userId,\r\n            transform: {\r\n                pos: {\r\n                    x: Math.random() * (WORLD.WIDTH - WORLD.BORDER_MARGIN * 2) + WORLD.BORDER_MARGIN,\r\n                    y: Math.random() * (WORLD.HEIGHT - WORLD.BORDER_MARGIN * 2) + WORLD.BORDER_MARGIN\r\n                },\r\n                rot: 0\r\n            },\r\n            timestamp: Date.now(),\r\n            color: this.utility.getRandomColor(),\r\n            actions: {\r\n                dash: {\r\n                    cooldown: this.playerConfig.default.actions.dash.cooldown,\r\n                    drain: this.playerConfig.default.actions.dash.drain,\r\n                    multiplier: this.playerConfig.default.actions.dash.multiplier,\r\n                    time: this.playerConfig.default.actions.dash.time\r\n                },\r\n                melee: {\r\n                    cooldown: this.playerConfig.default.actions.melee.cooldown,\r\n                    damage: this.playerConfig.default.actions.melee.damage,\r\n                    duration: this.playerConfig.default.actions.melee.duration,\r\n                    range: this.playerConfig.default.actions.melee.range,\r\n                    size: this.playerConfig.default.actions.melee.size\r\n                },\r\n                primary: {\r\n                    buffer: this.playerConfig.default.actions.primary.buffer,\r\n                    burst: {\r\n                        amount: this.playerConfig.default.actions.primary.burst.amount,\r\n                        delay: this.playerConfig.default.actions.primary.burst.delay\r\n                    },\r\n                    magazine: {\r\n                        currentAmmo: this.playerConfig.default.actions.primary.magazine.size,\r\n                        currentReserve: this.playerConfig.default.actions.primary.magazine.startingReserve,\r\n                        maxReserve: this.playerConfig.default.actions.primary.magazine.maxReserve,\r\n                        size: this.playerConfig.default.actions.primary.magazine.size\r\n                    },\r\n                    offset: this.playerConfig.default.actions.primary.offset,\r\n                    projectile: {\r\n                        amount: this.playerConfig.default.actions.primary.projectile.amount,\r\n                        color: this.playerConfig.default.actions.primary.projectile.color,\r\n                        damage: this.playerConfig.default.actions.primary.projectile.damage,\r\n                        length: this.playerConfig.default.actions.primary.projectile.length,\r\n                        range: this.playerConfig.default.actions.primary.projectile.range,\r\n                        size: this.playerConfig.default.actions.primary.projectile.size,\r\n                        speed: this.playerConfig.default.actions.primary.projectile.speed,\r\n                        spread: this.playerConfig.default.actions.primary.projectile.spread\r\n                    },\r\n                    reload: {\r\n                        time: this.playerConfig.default.actions.primary.reload.time\r\n                    }\r\n                },\r\n                sprint: {\r\n                    drain: this.playerConfig.default.actions.sprint.drain,\r\n                    multiplier: this.playerConfig.default.actions.sprint.multiplier\r\n                }\r\n            },\r\n            equipment: this.playerConfig.default.equipment,\r\n            flags: {\r\n                hidden: this.playerConfig.default.flags.hidden,\r\n                invulnerable: this.playerConfig.default.flags.invulnerable\r\n            },\r\n            inventory: {\r\n                primary: this.playerConfig.default.inventory.primary,\r\n                melee: this.playerConfig.default.inventory.melee\r\n            },\r\n            physics: {\r\n                acceleration: this.playerConfig.default.physics.acceleration,\r\n                friction: this.playerConfig.default.physics.friction\r\n            },\r\n            rig: {\r\n                body: this.playerConfig.default.rig.body,\r\n                head: this.playerConfig.default.rig.head,\r\n                headwear: this.playerConfig.default.rig.headwear,\r\n                weapon: this.playerConfig.default.rig.weapon\r\n            },\r\n            stats: {\r\n                defense: this.playerConfig.default.stats.defense,\r\n                health: {\r\n                    max: this.playerConfig.default.stats.health.max,\r\n                    value: this.playerConfig.default.stats.health.max,\r\n                },\r\n                luck: this.playerConfig.default.stats.luck,\r\n                size: this.playerConfig.default.stats.size,\r\n                speed: this.playerConfig.default.stats.speed,\r\n                stamina: {\r\n                    max: this.playerConfig.default.stats.stamina.max,\r\n                    recovery: {\r\n                        delay: this.playerConfig.default.stats.stamina.recovery.delay,\r\n                        rate: this.playerConfig.default.stats.stamina.recovery.rate\r\n                    },\r\n                    value: this.playerConfig.default.stats.stamina.max,\r\n                },\r\n            },\r\n            unique: this.playerConfig.default.unique\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Resets the current player state stored in memory to default.\r\n     */\r\n    public resetPlayerState(): void {\r\n        this.canShoot = true;\r\n        this.isBurstActive = false;\r\n        this.isReloading = false;\r\n        this.isMelee = false;\r\n        this.isSprinting = false;\r\n        this.isDashing = false;\r\n        this.isStaminaRecoveryBlocked = false;\r\n        this.isSwimming = false;\r\n\r\n        this.playerVelocityX = 0;\r\n        this.playerVelocityY = 0;\r\n\r\n        this.dashStartTime = 0;\r\n        this.lastDashTime = 0;\r\n        this.reloadStartTime = 0;\r\n        this.lastMeleeTime = 0;\r\n        this.lastShotTime = 0;\r\n        this.nextBurstShotTime = 0;\r\n        this.currentBurstShot = 0;\r\n        this.lastStaminaDrainTime = 0;\r\n        this.staminaRecoveryBlockedUntil = 0;\r\n\r\n        this.lastSentX = 0;\r\n        this.lastSentY = 0;\r\n        this.lastSentRotation = 0;\r\n        this.lastSentRotationTime = 0;\r\n        this.lastSentMoveTime = 0;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Events ]\r\n    //\r\n\r\n    /**\r\n     * Event callback for when stats change, informing all stat listeners.\r\n     */\r\n    public onStatChange(statPath: string, callback: (value: any) => void): void {\r\n        this.statListeners.set(statPath, callback);\r\n    }\r\n\r\n    /**\r\n     * Routing process to notify each listener that is subscribed to a stat change.\r\n     */\r\n    private notifyChange(statPath: string, value: any): void {\r\n        const listener = this.statListeners.get(statPath);\r\n        if (listener) {\r\n            listener(value);\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Directly updates the stat, triggering an 'onStatChange' event for all listeners.\r\n     */\r\n    public updateStat(statPath: string, value: any): void {\r\n        // Navigate to the property and set it\r\n        const pathParts = statPath.split('.');\r\n        let obj: any = this.myPlayer;\r\n\r\n        for (let i = 0; i < pathParts.length - 1; i++) {\r\n            obj = obj[pathParts[i]];\r\n        }\r\n\r\n        const lastProp = pathParts[pathParts.length - 1];\r\n        obj[lastProp] = value;\r\n\r\n        console.log(`${lastProp}: ${value}`);\r\n\r\n        // Notify listeners\r\n        this.notifyChange(statPath, value);\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { PlayerState } from \"./PlayerState\";\r\n\r\nexport class StaminaController {\r\n    constructor(private playerState: PlayerState) { }\r\n\r\n    // #region [ Stamina ]\r\n    //\r\n    /**\r\n     * Requests stamina from my pool for actions that require it.\r\n     * \r\n     * If there is enough, drain the needed stamina and return true.\r\n     */\r\n    public requestStamina(amount: number): boolean {\r\n        if (this.playerState.myPlayer.stats.stamina.value < amount) {\r\n            console.log(`Insufficient stamina! Need: ${amount}, Have: ${this.playerState.myPlayer.stats.stamina}`);\r\n            return false;\r\n        }\r\n\r\n        this.playerState.myPlayer.stats.stamina.value -= amount;\r\n\r\n        // Block stamina recovery for the delay period\r\n        this.playerState.isStaminaRecoveryBlocked = true;\r\n        this.playerState.staminaRecoveryBlockedUntil = Date.now() + this.playerState.myPlayer.stats.stamina.recovery.delay;\r\n\r\n        console.log(`Stamina drained: -${amount}, Remaining: ${this.playerState.myPlayer.stats.stamina}`);\r\n        return true;\r\n    }\r\n\r\n    /**\r\n     * Process stamina requests and recovery.\r\n     */\r\n    public updateStamina(delta: number): void {\r\n        const currentTime = Date.now();\r\n\r\n        // Handle sprint stamina drain (every second while sprinting)\r\n        if (this.playerState.isSprinting && currentTime >= this.playerState.lastStaminaDrainTime + 100) {\r\n            if (!this.requestStamina(this.playerState.myPlayer.actions.sprint.drain)) {\r\n                // Out of stamina, stop sprinting\r\n                this.playerState.isSprinting = false;\r\n                console.log('Out of stamina, stopped sprinting');\r\n            }\r\n            this.playerState.lastStaminaDrainTime = currentTime;\r\n        }\r\n\r\n        // Handle stamina recovery\r\n        if (!this.playerState.isStaminaRecoveryBlocked || currentTime >= this.playerState.staminaRecoveryBlockedUntil) {\r\n            this.playerState.isStaminaRecoveryBlocked = false;\r\n\r\n            // Recover stamina if not at max and not sprinting\r\n            if (this.playerState.myPlayer.stats.stamina.value < this.playerState.myPlayer.stats.stamina.max && !this.playerState.isSprinting) {\r\n                const staminaRecoveryPerFrame = (this.playerState.myPlayer.stats.stamina.recovery.rate / 1000) * 16.67 * delta;\r\n                this.playerState.myPlayer.stats.stamina.value = Math.min(this.playerState.myPlayer.stats.stamina.max, this.playerState.myPlayer.stats.stamina.value + staminaRecoveryPerFrame);\r\n            }\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n}","import { Vec2 } from \"../Types\";\r\nimport { WorldConfig } from \"./WorldConfig\";\r\n\r\nexport class WorldChunk {\r\n    // Store version/pos/size for runtime chunk updates\r\n    public version: number = 0;\r\n    public pos: Vec2 = { x: 0, y: 0 };\r\n    public size: number = 0;\r\n    \r\n    public pixelData: Uint8Array; // (MaterialIndex << 2) | ColorVariantIndex\r\n    public heightData: Uint8Array; // Baked height per pixel in [0..255] (0=low, 255=high)\r\n    public waterData: Uint8Array;\r\n    public chosenBiomeName: string;\r\n\r\n    private worldConfig: WorldConfig;\r\n\r\n    constructor(\r\n        biomeName: string,\r\n        sourcePixels: Uint8Array,\r\n        sourceHeights: Uint8Array,\r\n        sourceWater: Uint8Array,\r\n        worldConfig: WorldConfig\r\n    ) {\r\n        this.pixelData = sourcePixels;\r\n        this.heightData = sourceHeights;\r\n        this.waterData = sourceWater;\r\n        this.chosenBiomeName = biomeName;\r\n        this.worldConfig = worldConfig;\r\n    }\r\n\r\n    /**\r\n     * Returns the specific color of a pixel within a chunk.\r\n     */\r\n    public getColorAt(localX: number, localY: number, chunkSize: number): string {\r\n        const index = localY * chunkSize + localX;\r\n        const combinedIndex = this.pixelData[index];\r\n\r\n        const materialIndex = combinedIndex >> 2;\r\n        const colorVariantIndex = combinedIndex & 0b11;\r\n        const material = this.worldConfig.materialsList[materialIndex];\r\n\r\n        return material.colors[colorVariantIndex];\r\n    }\r\n\r\n    /**\r\n     * Returns the height for a specific pixel within a chunk.\r\n     */\r\n    public getHeightAt(localX: number, localY: number, chunkSize: number): number {\r\n        const index = localY * chunkSize + localX;\r\n\r\n        return this.heightData[index] / 255;\r\n    }\r\n\r\n    /** \r\n     * Returns amount of water for a pixel in a specific chunk.\r\n     */\r\n    public getWaterAt(localX: number, localY: number, chunkSize: number): number {\r\n        const index = localY * chunkSize + localX;\r\n\r\n        return this.waterData[index] / 255;\r\n    }\r\n}","import { Material, WorldLayer, PhysicsMaterialTypes, NoiseType, WorldParams, RegionName, LiquidFrictionTypes, FrictionTypes, MaterialName, WorldLayerName, MutationTypes } from \"../Types\";\r\n\r\nexport class WorldConfig {\r\n    public worldgenParams: WorldParams = {\r\n        general: {\r\n            chunk: { size: 128 },\r\n            cell: { size: 2 },\r\n            options: { island: false, valley: false, },\r\n            seed: 0\r\n        },\r\n        terrain: {\r\n            noiseType: NoiseType.Perlin,\r\n            intensity: 2,\r\n            octaves: 6.0,\r\n            scale: 0.0005,\r\n            persistence: 0.55,\r\n            heightCurve: 1.5,\r\n            seaLevel: 0.18,\r\n            lowestDepth: 0.1\r\n        },\r\n        material: {\r\n            noiseType: NoiseType.Perlin,\r\n            scale: 0.005,\r\n            detail: {\r\n                noiseType: NoiseType.Perlin,\r\n                scale: 1.0,\r\n            },\r\n            colorVariation: 0.75\r\n        },\r\n        degen: {\r\n            noiseType: NoiseType.Perlin,\r\n            scale: 0.0001,\r\n            intensity: 0.35,\r\n            minHeight: 0.1,\r\n            threshold: 0.55,\r\n            hardness: 0.5,\r\n            detail: {\r\n                noiseType: NoiseType.Perlin,\r\n                scale: 0.005\r\n            }\r\n        },\r\n        hydration: {\r\n            noiseType: NoiseType.Perlin,\r\n            intensity: 0.5,\r\n            scale: 0.001,\r\n            multiplier: 1\r\n        },\r\n        render: {\r\n            water: {\r\n                opacityBase: 0.55,\r\n                opacityMultiplier: 0.975,\r\n                foamIntensity: 1.0,\r\n                foamScale: 0.035,\r\n                noiseScale: 0.001,\r\n                shoreBlend: 0.0275,\r\n                shimmerStrength: 0.15,\r\n                depthDarkness: 1\r\n            },\r\n            grid: {\r\n                active: false, // Switches visibility state in WorldDebug.ts\r\n                lineWidth: 1,\r\n                chunkBorderColor: \"#a1a1a1\",\r\n                worldBorderColor: \"#9747ff\",\r\n                layerBorderColor: \"#ff4343\",\r\n                borderWidth: 3\r\n            }\r\n        }\r\n    };\r\n\r\n    private worldgenMessages = {\r\n        bakeStart: [\r\n            \"baking chunks...\",\r\n            \"baking pixels into chunks...\",\r\n            \"assembling chunks...\",\r\n            \"chunkifying... is that a word?\",\r\n            \"packing pixels into chunks...\",\r\n            \"arranging cells into chunks...\"\r\n        ],\r\n        bakeHalf: [\r\n            \"getting close...\",\r\n            \"thanks for waiting...\",\r\n            \"almost done...\",\r\n            \"still chunking...\",\r\n            \"about 50% of chunks baked...\",\r\n            \"still baking pixels into chunks...\",\r\n            \"almost all pixels baked...\"\r\n        ],\r\n        generation: [\r\n            \"building cells...\",\r\n            \"placing pixels...\",\r\n            \"spawning pixels...\",\r\n            \"creating cells...\"\r\n        ],\r\n        degeneration: [\r\n            \"eroding terrain...\",\r\n            \"wearing down surfaces...\",\r\n            \"carving material layers...\",\r\n            \"degenerating terrain...\",\r\n            \"exposing layers...\"\r\n        ],\r\n        hydration: [\r\n            \"hydrating terrain...\",\r\n            \"filling water basins...\",\r\n            \"moisturizing...\",\r\n            \"creating shores...\"\r\n        ],\r\n        special: [\r\n            \"beltalowding...\",\r\n            \"i love a24 films\",\r\n            \"tehe\",\r\n            \"thank you for buying the battlepass...\"\r\n        ]\r\n    }\r\n\r\n    public regionAudioParams: Record<RegionName, {\r\n        minRegionSize: number;\r\n        radius: number;\r\n        volume: { min: number; max: number };\r\n    } | null> = {\r\n            shore: { minRegionSize: 4, radius: 400, volume: { min: 0.0, max: 0.175 } },\r\n            cliffs: { minRegionSize: 6, radius: 550, volume: { min: 0.0, max: 0.135 } },\r\n            mountains: { minRegionSize: 8, radius: 650, volume: { min: 0.0, max: 0.125 } },\r\n            ocean: { minRegionSize: 16, radius: 750, volume: { min: 0.0, max: 0.115 } },\r\n            plains: { minRegionSize: 14, radius: 1000, volume: { min: 0.0, max: 0.1 } }\r\n        };\r\n\r\n    private worldLayers: Record<WorldLayerName, WorldLayer> = {\r\n        // NAME KEY MUST MATCH OBJECT LITERAL !IMPORTANT\r\n        // MUST BE ORDERED BY HEIGHT [0..1]\r\n\r\n        foundation: {\r\n            name: \"foundation\",\r\n            height: 0.05,\r\n            materials: [\r\n                { material: \"bedrock\", weight: 10, blend: 0.1 },\r\n                { material: \"granite\", weight: 6, blend: 0.2 },\r\n                { material: \"basalt\", weight: 3, blend: 0.2 }\r\n            ]\r\n        },\r\n        substrate: {\r\n            name: \"substrate\",\r\n            height: 0.07,\r\n            materials: [\r\n                { material: \"granite\", weight: 6, blend: 0.3 },\r\n                { material: \"limestone\", weight: 4, blend: 0.5 },\r\n                { material: \"shale\", weight: 3, blend: 0.4 },\r\n                { material: \"slate\", weight: 2, blend: 0.4 }\r\n            ]\r\n        },\r\n        sediment: {\r\n            name: \"sediment\",\r\n            height: 0.12,\r\n            materials: [\r\n                { material: \"silt\", weight: 4, blend: 0.9 },\r\n                { material: \"sand\", weight: 5, blend: 0.9 },\r\n                { material: \"sand_wet\", weight: 3, blend: 0.1 },\r\n                { material: \"gravel\", weight: 2, blend: 0.6 },\r\n                { material: \"dirt\", weight: 1, blend: 0.4 }\r\n            ]\r\n        },\r\n        alluvium: {\r\n            name: \"alluvium\",\r\n            height: 0.18,\r\n            materials: [\r\n                { material: \"silt\", weight: 3, blend: 0.95 },\r\n                { material: \"sand\", weight: 6, blend: 0.9 },\r\n                { material: \"sand_wet\", weight: 3, blend: 0.1 },\r\n                { material: \"gravel\", weight: 3, blend: 0.6 },\r\n                { material: \"stone\", weight: 1, blend: 0.2 }\r\n            ]\r\n        },\r\n        soil: {\r\n            name: \"soil\",\r\n            height: 0.3,\r\n            materials: [\r\n                { material: \"grass\", weight: 7, blend: 0.8 },\r\n                { material: \"dirt\", weight: 2, blend: 0.6 },\r\n                { material: \"mud\", weight: 1, blend: 0.1 },\r\n                { material: \"gravel\", weight: 2, blend: 0.7 },\r\n                { material: \"stone\", weight: 1, blend: 0.3 }\r\n            ]\r\n        },\r\n        topsoil: {\r\n            name: \"topsoil\",\r\n            height: 0.45,\r\n            materials: [\r\n                { material: \"grass\", weight: 7, blend: 0.8 },\r\n                { material: \"dirt\", weight: 2, blend: 0.6 },\r\n                { material: \"gravel\", weight: 1, blend: 0.4 }\r\n            ]\r\n        },\r\n        colluvium: {\r\n            name: \"colluvium\",\r\n            height: 0.7,\r\n            materials: [\r\n                { material: \"stone\", weight: 6, blend: 0.3 },\r\n                { material: \"gravel\", weight: 3, blend: 0.5 },\r\n                { material: \"dirt\", weight: 1, blend: 0.6 },\r\n                { material: \"snow\", weight: 1, blend: 0.8 },\r\n            ]\r\n        },\r\n        summit: {\r\n            name: \"summit\",\r\n            height: 0.9,\r\n            materials: [\r\n                { material: \"stone\", weight: 2, blend: 0.3 },\r\n                { material: \"gravel\", weight: 1, blend: 0.4 },\r\n                { material: \"snow\", weight: 4, blend: 0.8 },\r\n                { material: \"ice\", weight: 3, blend: 0.9 }\r\n            ]\r\n        }\r\n    };\r\n\r\n    private materials: Record<MaterialName, Material> = {\r\n        // NAME KEY MUST MATCH OBJECT LITERAL !IMPORTANT\r\n\r\n        // TEMPLATE\r\n        // name: { // Name key and name string must match (case-sensitive)\r\n        //     name: \"\", type: \"terrain\",\r\n        //     colors: [],\r\n        //     physics: {\r\n        //         type: PhysicsMaterialTypes.Solid,\r\n        //         simulate: ,\r\n        //         durability: ,\r\n        //         friction: ,\r\n        //         density: \r\n        //     },\r\n        //     tags: []\r\n        // },\r\n\r\n        // TERRAIN\r\n        basalt: {\r\n            name: \"basalt\", type: \"terrain\",\r\n            colors: [\"#2e2e2e\", \"#3e3e3e\", \"#4e4e4e\", \"#5e5e5e\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.8,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.88\r\n            },\r\n            tags: [\"erosion_source\"]\r\n        },\r\n        bedrock: {\r\n            name: \"bedrock\", type: \"terrain\",\r\n            colors: [\"#2f3236\", \"#3a3e44\", \"#454a52\", \"#50565f\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 1,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.95\r\n            },\r\n            tags: [\"erosion_source\"]\r\n        },\r\n        clay: {\r\n            name: \"clay\", type: \"terrain\",\r\n            colors: [\"#6f5a4a\", \"#7c6755\", \"#897461\", \"#96816e\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.2,\r\n                friction: FrictionTypes.Soft,\r\n                density: 0.4\r\n            },\r\n            tags: [\"absorbent\", \"erosion_source\", \"imprint_on_footstep\", \"soft\"],\r\n            mutations: {\r\n                wet: \"clay_wet\"\r\n            }\r\n        },\r\n        clay_wet: {\r\n            name: \"clay_wet\", type: \"terrain\",\r\n            colors: [\"#4a3a2f\", \"#554437\", \"#604e3f\", \"#6b5947\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Wet,\r\n                density: 0.4\r\n            },\r\n            tags: [\"imprint_on_footstep\", \"soft\", \"track_on_footstep\"],\r\n            mutations: {\r\n                dry: \"clay\"\r\n            }\r\n        },\r\n        dirt: {\r\n            name: \"dirt\", type: \"terrain\",\r\n            colors: [\"#5b3a1f\", \"#6b4a2f\", \"#7b5a3f\", \"#8b6a4f\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.2,\r\n                friction: FrictionTypes.Normal,\r\n                density: 0.5\r\n            },\r\n            tags: [\"absorbent\", \"erosion_source\", \"imprint_on_footstep\", \"soft\"],\r\n            mutations: {\r\n                wet: \"mud\"\r\n            }\r\n        },\r\n        granite: {\r\n            name: \"granite\", type: \"terrain\",\r\n            colors: [\"#6e6e6e\", \"#7e7e7e\", \"#8e8e8e\", \"#9e9e9e\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.9,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.9\r\n            },\r\n            tags: [\"erosion_source\"]\r\n        },\r\n        grass: {\r\n            name: \"grass\", type: \"terrain\",\r\n            colors: [\"#3a5f3e\", \"#4a6f4e\", \"#5a7f5e\", \"#6a8f6e\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.2,\r\n                friction: FrictionTypes.Normal,\r\n                density: 0.5\r\n            },\r\n            tags: [\"soft\"]\r\n        },\r\n        gravel: {\r\n            name: \"gravel\", type: \"terrain\",\r\n            colors: [\"#606060\", \"#707070\", \"#808080\", \"#909090\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: true,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Soft,\r\n                density: 0.3\r\n            },\r\n            tags: [\"erosion_source\", \"imprint_on_footstep\", \"soft\"]\r\n        },\r\n        ice: {\r\n            name: \"ice\", type: \"terrain\",\r\n            colors: [\"#a9d5ff\", \"#8fc5ff\", \"#6fb5ff\", \"#5aa4f2\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.3,\r\n                friction: FrictionTypes.Slick,\r\n                density: 0.5\r\n            },\r\n            tags: []\r\n        },\r\n        permafrost: {\r\n            name: \"permafrost\", type: \"terrain\",\r\n            colors: [\"#a4b5ef\", \"#7aabeb\", \"#9bc6f5\", \"#7d92f9\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.7,\r\n                friction: FrictionTypes.Slick,\r\n                density: 0.8\r\n            },\r\n            tags: []\r\n        },\r\n        loam: {\r\n            name: \"loam\", type: \"terrain\",\r\n            colors: [\"#2d1f12\", \"#3a2918\", \"#4a361f\", \"#5a4328\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.2,\r\n                friction: FrictionTypes.Soft,\r\n                density: 0.55\r\n            },\r\n            tags: [\"absorbent\", \"soft\"]\r\n        },\r\n        limestone: {\r\n            name: \"limestone\", type: \"terrain\",\r\n            colors: [\"#c0b8a0\", \"#b0a890\", \"#a09880\", \"#908870\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.5,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.7\r\n            },\r\n            tags: [\"erosion_source\"]\r\n        },\r\n        moss: {\r\n            name: \"moss\", type: \"terrain\",\r\n            colors: [\"#264a2f\", \"#2f5a3a\", \"#376a45\", \"#3f7a50\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Soft,\r\n                density: 0.4\r\n            },\r\n            tags: [\"absorbent\", \"soft\"]\r\n        },\r\n        mud: {\r\n            name: \"mud\", type: \"terrain\",\r\n            colors: [\"#3b2416\", \"#4a2e1d\", \"#583924\", \"#66452b\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Wet,\r\n                density: 0.6\r\n            },\r\n            tags: [\"imprint_on_footstep\", \"soft\", \"track_on_footstep\"],\r\n            mutations: {\r\n                dry: \"dirt\"\r\n            }\r\n        },\r\n        peat: {\r\n            name: \"peat\", type: \"terrain\",\r\n            colors: [\"#1a150f\", \"#241e16\", \"#2e271e\", \"#383024\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Soft,\r\n                density: 0.3\r\n            },\r\n            tags: [\"absorbent\", \"soft\"]\r\n        },\r\n        sand: {\r\n            name: \"sand\", type: \"terrain\",\r\n            colors: [\"#b2a280\", \"#c2b290\", \"#d2c2a0\", \"#e2d2b0\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: true,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Soft,\r\n                density: 0.2\r\n            },\r\n            tags: [\"absorbent\", \"erosion_source\", \"imprint_on_footstep\", \"soft\"],\r\n            mutations: {\r\n                wet: \"sand_wet\"\r\n            }\r\n        },\r\n        sand_wet: {\r\n            name: \"sand_wet\", type: \"terrain\",\r\n            colors: [\"#8f7e5e\", \"#9d8d6c\", \"#ab9c7a\", \"#b9ab88\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Wet,\r\n                density: 0.3\r\n            },\r\n            tags: [\"imprint_on_footstep\", \"soft\", \"track_on_footstep\"],\r\n            mutations: {\r\n                dry: \"sand\"\r\n            }\r\n        },\r\n        sandstone: {\r\n            name: \"sandstone\", type: \"terrain\",\r\n            colors: [\"#c2b290\", \"#b2a280\", \"#a29270\", \"#928260\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.4,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.65\r\n            },\r\n            tags: []\r\n        },\r\n        scree: {\r\n            name: \"scree\", type: \"terrain\",\r\n            colors: [\"#868680\", \"#8f8f88\", \"#999990\", \"#a3a399\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.4,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.65\r\n            },\r\n            tags: []\r\n        },\r\n        shale: {\r\n            name: \"shale\", type: \"terrain\",\r\n            colors: [\"#4f555d\", \"#5a616a\", \"#656d77\", \"#707a85\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.4,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.7\r\n            },\r\n            tags: [\"erosion_source\"]\r\n        },\r\n        silt: {\r\n            name: \"silt\", type: \"terrain\",\r\n            colors: [\"#7a7362\", \"#777165\", \"#6b6965\", \"#6d6755\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: true,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Soft,\r\n                density: 0.3\r\n            },\r\n            tags: [\"absorbent\", \"erosion_source\", \"imprint_on_footstep\", \"soft\"],\r\n            mutations: {\r\n                wet: \"silt_wet\"\r\n            }\r\n        },\r\n        silt_wet: {\r\n            name: \"silt_wet\", type: \"terrain\",\r\n            colors: [\"#5e5648\", \"#655d4f\", \"#6c6453\", \"#746b57\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.1,\r\n                friction: FrictionTypes.Wet,\r\n                density: 0.4\r\n            },\r\n            tags: [\"imprint_on_footstep\", \"soft\", \"track_on_footstep\"],\r\n            mutations: {\r\n                dry: \"silt\"\r\n            }\r\n        },\r\n        slate: {\r\n            name: \"slate\", type: \"terrain\",\r\n            colors: [\"#4a4f55\", \"#555a60\", \"#60656b\", \"#6b7076\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.6,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.75\r\n            },\r\n            tags: [\"erosion_source\"]\r\n        },\r\n        snow: {\r\n            name: \"snow\", type: \"terrain\",\r\n            colors: [\"#ffffff\", \"#e6eef5\", \"#dfe8f2\", \"#cfdceb\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.2,\r\n                friction: FrictionTypes.Sticky,\r\n                density: 0.4\r\n            },\r\n            tags: [\"absorbent\", \"imprint_on_footstep\", \"soft\"]\r\n        },\r\n        stone: {\r\n            name: \"stone\", type: \"terrain\",\r\n            colors: [\"#707070\", \"#808080\", \"#909090\", \"#a0a0a0\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.5,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.75\r\n            },\r\n            tags: [\"erosion_source\"]\r\n        },\r\n\r\n        // MINERAL\r\n        coal: {\r\n            name: \"coal\", type: \"mineral\",\r\n            colors: [\"#0a0a0a\", \"#1a1a1a\", \"#2a2a2a\", \"#3a3a3a\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.6,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.55\r\n            },\r\n            tags: []\r\n        },\r\n        iron: {\r\n            name: \"iron\", type: \"mineral\",\r\n            colors: [\"#7b3716\", \"#8b4726\", \"#9b5736\", \"#ab6746\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.7,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.9\r\n            },\r\n            tags: []\r\n        },\r\n        gold: {\r\n            name: \"gold\", type: \"mineral\",\r\n            colors: [\"#eec700\", \"#fed700\", \"#ffe700\", \"#fff74c\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.8,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.8\r\n            },\r\n            tags: []\r\n        },\r\n        silver: {\r\n            name: \"silver\", type: \"mineral\",\r\n            colors: [\"#b0b0b0\", \"#c0c0c0\", \"#d0d0d0\", \"#e0e0e0\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.7,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.75\r\n            },\r\n            tags: []\r\n        },\r\n        copper: {\r\n            name: \"copper\", type: \"mineral\",\r\n            colors: [\"#a86323\", \"#b87333\", \"#c88343\", \"#d89353\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.6,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.7\r\n            },\r\n            tags: []\r\n        },\r\n\r\n        // ORGANIC\r\n        flesh: {\r\n            name: \"flesh\", type: \"organic\",\r\n            colors: [\"#c895e3\", \"#b94e51\", \"#be6987\", \"#c04444\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.2,\r\n                friction: FrictionTypes.Soft,\r\n                density: 0.4\r\n            },\r\n            tags: [\"soft\"]\r\n        },\r\n\r\n        // SURFACE\r\n        wood: {\r\n            name: \"wood\", type: \"surface\",\r\n            colors: [\"#7b3503\", \"#8b4513\", \"#9b5523\", \"#ab6533\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.4,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.5\r\n            },\r\n            tags: []\r\n        },\r\n        concrete: {\r\n            name: \"concrete\", type: \"surface\",\r\n            colors: [\"#2a2a2a\", \"#3a3a3a\", \"#4a4a4a\", \"#5a5a5a\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.8,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.65\r\n            },\r\n            tags: []\r\n        },\r\n        metal: {\r\n            name: \"metal\", type: \"surface\",\r\n            colors: [\"#4a4a4a\", \"#6a6a6a\", \"#7a7a7a\", \"#8a8a8a\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.9,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.8\r\n            },\r\n            tags: []\r\n        },\r\n        asphalt: {\r\n            name: \"asphalt\", type: \"surface\",\r\n            colors: [\"#1b1b1b\", \"#2b2b2b\", \"#3b3b3b\", \"#4b4b4b\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Solid,\r\n                simulate: false,\r\n                durability: 0.8,\r\n                friction: FrictionTypes.Hard,\r\n                density: 0.7\r\n            },\r\n            tags: []\r\n        },\r\n\r\n        // LIQUIDS\r\n        water: {\r\n            name: \"water\", type: \"liquid\",\r\n            colors: [\"#2d6bc9\", \"#2450a6\", \"#1f3f8a\", \"#1a2f6e\"],\r\n            physics: {\r\n                type: PhysicsMaterialTypes.Liquid,\r\n                simulate: true,\r\n                friction: LiquidFrictionTypes.Water,\r\n                viscosity: 0.2\r\n            },\r\n            tags: []\r\n        }\r\n    };\r\n\r\n    public materialIndex = {} as Record<MaterialName, number>;\r\n    public worldLayerIndex = {} as Record<WorldLayerName, number>;\r\n\r\n    public materialsList: Material[] = [];\r\n    public worldLayerList: WorldLayer[] = [];\r\n\r\n    constructor() {\r\n        this.materialsList = Object.values(this.materials);\r\n        this.worldLayerList = Object.values(this.worldLayers);\r\n\r\n        this.materialsList.forEach((mat, i) => {\r\n            this.materialIndex[mat.name as MaterialName] = i;\r\n        });\r\n\r\n        this.worldLayerList.forEach((layer, i) => {\r\n            this.worldLayerIndex[layer.name as WorldLayerName] = i;\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Returns a worldgen message for the specific loading phase.\r\n     */\r\n    public getWorldgenMessage(phase: string): string {\r\n        const messages = this.worldgenMessages;\r\n        const roll: number = Math.random();\r\n\r\n        if (roll <= 0.01 && messages.special.length > 0) {\r\n            const specialIndex: number = Math.floor(Math.random() * messages.special.length);\r\n            const specialMessage: string = messages.special[specialIndex];\r\n            return specialMessage;\r\n        }\r\n\r\n        const phaseMessages: string[] | undefined = (messages as Record<string, string[]>)[phase];\r\n        if (!phaseMessages || phaseMessages.length === 0) { return \"loading...\"; }\r\n\r\n        const randomIndex: number = Math.floor(Math.random() * phaseMessages.length);\r\n        const selectedMessage: string = phaseMessages[randomIndex];\r\n        return selectedMessage;\r\n    }\r\n\r\n    public mutate(mat: Material, mutation: MutationTypes): Material | null {\r\n        const targetName = mat.mutations?.[mutation];\r\n        if (!targetName) return null;\r\n\r\n        return this.materials[targetName] || null;\r\n    }\r\n\r\n}\r\n\r\n// 1761802917695 1761883681927 1761926328530","import { VIEWPORT, WORLD } from \"../Config\";\r\nimport { PhysicsMaterialTypes, RegionName } from \"../Types\";\r\n\r\nimport { Camera } from \"../Camera\";\r\nimport { ControlsManager } from \"../ControlsManager\";\r\nimport { UserInterface } from \"../UserInterface\";\r\nimport { Utility } from \"../Utility\";\r\nimport { World } from \"./World\";\r\n\r\nexport class WorldDebug {\r\n    public hoveredChunk: { cx: number; cy: number } | null = null;\r\n\r\n    private overlayMode: number = 0;\r\n    private overlayNames: string[] = [\"Chunk\", \"Heightmap\", \"Contours\", \"Regions\", \"Audio\"];\r\n\r\n    constructor(\r\n        private camera: Camera,\r\n        private controlsManager: ControlsManager,\r\n        private ui: UserInterface,\r\n        private utility: Utility,\r\n        private world: World\r\n    ) {\r\n        this.listenForDebugShortcuts();\r\n    }\r\n\r\n    /**\r\n     * Sets up event listeners for debug shortcut keys. (Hold CTRL + ALT + Keybind)\r\n     * \r\n     * Overlay: Numpad Enter | [ ] < -- Brackets switch debug overlay pages.\r\n     * \r\n     * Regen World: Numpad 0 | ReRender: Numpad . | Save World: Numpad /\r\n     */\r\n    private listenForDebugShortcuts(): void {\r\n        window.addEventListener(\"keydown\", e => {\r\n            if (e.ctrlKey && e.altKey) {\r\n                if (!this.world.isGenerated) return;\r\n\r\n                switch (e.code) {\r\n                    case \"Numpad0\":\r\n                        e.preventDefault();\r\n                        console.log(\"Opening generation menu...\");\r\n                        this.world.showGenerationMenu()\r\n                            .then(async (worldData) => {\r\n                                if (worldData !== \"load\") {\r\n                                    await this.world.generateWorld(worldData);\r\n                                }\r\n                            });\r\n                        break;\r\n\r\n                    case \"NumpadDecimal\":\r\n                        e.preventDefault();\r\n                        console.log(\"Refreshing world rendering...\");\r\n                        this.world.renderMenu();\r\n                        break;\r\n\r\n                    case \"NumpadEnter\":\r\n                        e.preventDefault();\r\n                        this.world.worldConfig.worldgenParams.render.grid.active =\r\n                            !this.world.worldConfig.worldgenParams.render.grid.active;\r\n                        if (!this.world.worldConfig.worldgenParams.render.grid.active) this.hoveredChunk = null;\r\n                        console.log(\"Overlay \" + (this.world.worldConfig.worldgenParams.render.grid.active ? \"enabled\" : \"disabled\") +\r\n                            \" (mode: \" + this.overlayNames[this.overlayMode] + \")\");\r\n                        if (this.world.worldConfig.worldgenParams.render.grid.active) {\r\n                            this.showOverlayName();\r\n                        }\r\n                        break;\r\n\r\n                    case \"NumpadDivide\":\r\n                        e.preventDefault();\r\n                        console.log(\"Exporting world data...\");\r\n                        this.world.exportWorldData();\r\n                        break;\r\n\r\n                    default:\r\n                        break;\r\n                }\r\n            }\r\n\r\n            if (this.world.worldConfig.worldgenParams.render.grid.active && e.ctrlKey && e.altKey) { // Debug page cycling\r\n                if (e.key === \"[\" || e.code === \"BracketLeft\") {\r\n                    e.preventDefault();\r\n                    this.overlayMode = (this.overlayMode - 1 + this.overlayNames.length) % this.overlayNames.length;\r\n                    console.log(\"Overlay mode: \" + this.overlayNames[this.overlayMode]);\r\n                    this.showOverlayName();\r\n                }\r\n                if (e.key === \"]\" || e.code === \"BracketRight\") {\r\n                    e.preventDefault();\r\n                    this.overlayMode = (this.overlayMode + 1) % this.overlayNames.length;\r\n                    console.log(\"Overlay mode: \" + this.overlayNames[this.overlayMode]);\r\n                    this.showOverlayName();\r\n                }\r\n            }\r\n        });\r\n    }\r\n\r\n\r\n    /**\r\n     * General entrypoint for different world debug overlays.\r\n     */\r\n    public drawDebug(): void {\r\n        if (!this.ui.ctx || !this.world.isGenerated) return;\r\n\r\n        // Draw terrain overlays if enabled\r\n        if (this.world.worldConfig.worldgenParams.render.grid.active) {\r\n            switch (this.overlayMode) {\r\n                case 0: this.drawChunks(); break;\r\n                case 1: this.drawHeightmap(); break;\r\n                case 2: this.drawContours(); break;\r\n                case 3: this.drawRegions(); break;\r\n                case 4: this.drawAudioZones(); break;\r\n            }\r\n            this.drawInfoPanels();\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Draws fixed info panels at the top of the screen\r\n     */\r\n    private drawInfoPanels(): void {\r\n        const hoveredCoords = this.world.updateHoveredChunk();\r\n        if (!hoveredCoords || !this.hoveredChunk) return;\r\n\r\n        const chunkSize = this.world.worldConfig.worldgenParams.general.chunk.size;\r\n        const hcx = this.hoveredChunk.cx;\r\n        const hcy = this.hoveredChunk.cy;\r\n\r\n        const worldX = Math.floor(hoveredCoords.worldX);\r\n        const worldY = Math.floor(hoveredCoords.worldY);\r\n        const worldPos = { x: worldX, y: worldY }\r\n\r\n        const chunk = this.world.chunks[hcx]?.[hcy];\r\n        const chunkLayer = this.world.chunkLayers[hcx]?.[hcy];\r\n        if (!chunk) return;\r\n\r\n        const localX = worldX - hcx * chunkSize;\r\n        const localY = worldY - hcy * chunkSize;\r\n        const li = localY * chunkSize + localX;\r\n\r\n        const combined = chunk.pixelData[li];\r\n        const materialIndex = combined >> 2;\r\n        const colorVariantIndex = combined & 0b11;\r\n        const height01 = chunk.getHeightAt(localX, localY, chunkSize);\r\n\r\n        const mat = this.world.worldConfig.materialsList[materialIndex];\r\n        const waterData = this.world.getWaterData(worldPos);\r\n\r\n        const margin = 10;\r\n        let currentX = margin;\r\n\r\n        let regionName = \"N/A\";\r\n        if (this.world.regions) {\r\n            for (const region of this.world.regions) {\r\n                if (region.chunkCoords.some(c => c.cx === hcx && c.cy === hcy)) {\r\n                    regionName = region.name;\r\n                    break;\r\n                }\r\n            }\r\n        }\r\n\r\n        const mainInfo = [ // Draw main panel\r\n            `Region: ${regionName}`,\r\n            `Layer: ${chunkLayer ? chunkLayer.name : \"N/A\"}`,\r\n            `Chunk: ${hcx},${hcy})`,\r\n            `Pixel: ${worldX},${worldY}`,\r\n            `Height: ${height01.toFixed(3)}`\r\n        ];\r\n        currentX += this.drawPanel(\"Main\", mainInfo, currentX, 10, '#888888', null) + margin;\r\n\r\n        if (mat && mat.physics.type === PhysicsMaterialTypes.Solid) {\r\n            const materialColor = this.utility.getLightestColor(mat.colors);\r\n            const solidInfo = [\r\n                `Material: ${mat.name} [${materialIndex}]`,\r\n                `Type: ${mat.type}`,\r\n                `Color Var: ${colorVariantIndex}`,\r\n                `Simulate: ${mat.physics.simulate}`,\r\n                `Durability: ${mat.physics.durability.toFixed(2)}`,\r\n                `Friction: ${mat.physics.friction.toFixed(2)}`,\r\n                `Density: ${mat.physics.density.toFixed(2)}`\r\n            ];\r\n            currentX += this.drawPanel(\"Solid\", solidInfo, currentX, 10, materialColor, materialColor) + margin;\r\n        }\r\n\r\n        if (waterData && waterData.hasWater) {\r\n            const phys = waterData.material.physics;\r\n            const materialColor = this.utility.getLightestColor(waterData.material.colors);\r\n\r\n            if (phys.type === PhysicsMaterialTypes.Liquid) {\r\n                const liquidInfo = [\r\n                    `Material: ${waterData.material.name}`,\r\n                    `Depth: ${waterData.depth.toFixed(3)}`,\r\n                    `Simulate: ${phys.simulate}`,\r\n                    `Viscosity: ${phys.viscosity.toFixed(2)}`\r\n                ];\r\n                currentX += this.drawPanel(\"Liquid\", liquidInfo, currentX, 10, materialColor, materialColor) + margin;\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Draws a single info panel and returns its width\r\n     */\r\n    private drawPanel(title: string, lines: string[], x: number, y: number, color: string, titleBgColor: string | null): number {\r\n        const ctx = this.ui.ctx;\r\n        if (!ctx) return 0;\r\n\r\n        const padding = 8;\r\n        const lineHeight = 14;\r\n        const headerHeight = 20;\r\n        const titleMargin = 4; // Space between title and content\r\n\r\n        ctx.font = \"11px monospace\";\r\n        ctx.textAlign = \"left\";\r\n\r\n        let maxWidth = ctx.measureText(title).width;\r\n        lines.forEach(line => {\r\n            maxWidth = Math.max(maxWidth, ctx.measureText(line).width);\r\n        });\r\n\r\n        const boxWidth = maxWidth + padding * 2;\r\n        const boxHeight = headerHeight + titleMargin + lines.length * lineHeight + padding;\r\n\r\n        // Background\r\n        ctx.fillStyle = \"rgba(0, 0, 0, 0.85)\";\r\n        ctx.fillRect(x, y, boxWidth, boxHeight);\r\n\r\n        // Border\r\n        ctx.strokeStyle = color;\r\n        ctx.lineWidth = 2;\r\n        ctx.strokeRect(x, y, boxWidth, boxHeight);\r\n\r\n        // Header with background color\r\n        if (titleBgColor) {\r\n            ctx.fillStyle = titleBgColor;\r\n            ctx.fillRect(x, y, boxWidth, headerHeight);\r\n        }\r\n\r\n        // Title text\r\n        ctx.font = \"bold 12px monospace\";\r\n        ctx.fillStyle = titleBgColor ? \"#000000\" : color; // Black text if has bg, colored if not\r\n        ctx.fillText(title, x + padding, y + padding + 10);\r\n\r\n        // Content\r\n        ctx.fillStyle = titleBgColor ? color : \"#ffffff\"; // Use material color for content if material panel\r\n        ctx.font = \"11px monospace\";\r\n        lines.forEach((line, i) => {\r\n            ctx.fillText(line, x + padding, y + headerHeight + titleMargin + padding + i * lineHeight);\r\n        });\r\n\r\n        return boxWidth;\r\n    }\r\n\r\n    /**\r\n     * Renders chunk borders with layer highlights\r\n     */\r\n    private drawChunks(): void {\r\n        if (!this.ui.ctx || !this.world.isGenerated) return;\r\n\r\n        const ctx = this.ui.ctx;\r\n        const chunkSize = this.world.worldConfig.worldgenParams.general.chunk.size;\r\n        const camX = this.camera.pos.x, camY = this.camera.pos.y;\r\n\r\n        const startCX = Math.floor(camX / chunkSize);\r\n        const endCX = Math.ceil((camX + VIEWPORT.WIDTH) / chunkSize);\r\n        const startCY = Math.floor(camY / chunkSize);\r\n        const endCY = Math.ceil((camY + VIEWPORT.HEIGHT) / chunkSize);\r\n\r\n        ctx.save();\r\n\r\n        // Highlight hovered chunk\r\n        if (this.hoveredChunk) {\r\n            const hcx = this.hoveredChunk.cx;\r\n            const hcy = this.hoveredChunk.cy;\r\n            const hoveredChunkWorldX = hcx * chunkSize;\r\n            const hoveredChunkWorldY = hcy * chunkSize;\r\n            const hoveredScreenX = hoveredChunkWorldX - camX;\r\n            const hoveredScreenY = hoveredChunkWorldY - camY;\r\n\r\n            const hex = this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor.slice(1);\r\n            const r = parseInt(hex.slice(0, 2), 16);\r\n            const g = parseInt(hex.slice(2, 4), 16);\r\n            const b = parseInt(hex.slice(4, 6), 16);\r\n            ctx.fillStyle = `rgba(${r}, ${g}, ${b}, 0.2)`;\r\n            ctx.fillRect(hoveredScreenX, hoveredScreenY, chunkSize, chunkSize);\r\n        }\r\n\r\n        // Draw chunk borders\r\n        for (let cx = startCX; cx < endCX; cx++) {\r\n            for (let cy = startCY; cy < endCY; cy++) {\r\n                const worldX = cx * chunkSize;\r\n                const worldY = cy * chunkSize;\r\n                const screenX = worldX - camX;\r\n                const screenY = worldY - camY;\r\n\r\n                const currentLayer = this.world.getChunkLayer(cx, cy);\r\n                const layerRight = this.world.getChunkLayer(cx + 1, cy) || currentLayer;\r\n                const layerBottom = this.world.getChunkLayer(cx, cy + 1) || currentLayer;\r\n\r\n                const vBorder = !!(currentLayer && layerRight && currentLayer.name !== layerRight.name);\r\n                const hBorder = !!(currentLayer && layerBottom && currentLayer.name !== layerBottom.name);\r\n\r\n                // Right edge\r\n                ctx.beginPath();\r\n                ctx.moveTo(screenX + chunkSize, screenY);\r\n                ctx.lineTo(screenX + chunkSize, screenY + chunkSize);\r\n                ctx.lineWidth = vBorder ? this.world.worldConfig.worldgenParams.render.grid.borderWidth : this.world.worldConfig.worldgenParams.render.grid.lineWidth;\r\n                ctx.strokeStyle = vBorder ? this.world.worldConfig.worldgenParams.render.grid.layerBorderColor : this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor;\r\n                ctx.stroke();\r\n\r\n                // Bottom edge\r\n                ctx.beginPath();\r\n                ctx.moveTo(screenX, screenY + chunkSize);\r\n                ctx.lineTo(screenX + chunkSize, screenY + chunkSize);\r\n                ctx.lineWidth = hBorder ? this.world.worldConfig.worldgenParams.render.grid.borderWidth : this.world.worldConfig.worldgenParams.render.grid.lineWidth;\r\n                ctx.strokeStyle = hBorder ? this.world.worldConfig.worldgenParams.render.grid.layerBorderColor : this.world.worldConfig.worldgenParams.render.grid.chunkBorderColor;\r\n                ctx.stroke();\r\n            }\r\n        }\r\n\r\n        // World bounds\r\n        ctx.strokeStyle = this.world.worldConfig.worldgenParams.render.grid.worldBorderColor;\r\n        ctx.lineWidth = this.world.worldConfig.worldgenParams.render.grid.borderWidth;\r\n        ctx.strokeRect(0 - camX, 0 - camY, WORLD.WIDTH, WORLD.HEIGHT);\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    /**\r\n     * Draws a heightmap debug view.\r\n     * \r\n     * Heightmap ranges from blue > green > red > white.\r\n     */\r\n    private drawHeightmap(): void {\r\n        const ctx = this.ui.ctx;\r\n        if (!ctx || !this.world.isGenerated) return;\r\n\r\n        const camX = this.camera.pos.x;\r\n        const camY = this.camera.pos.y;\r\n        const chunkSize = this.world.worldConfig.worldgenParams.general.chunk.size;\r\n        const resolution = 4;\r\n        const alpha = 0.6;\r\n\r\n        const { seaLevel, lowestDepth } = this.world.worldConfig.worldgenParams.terrain;\r\n        const layers = this.world.worldConfig.worldLayerList;\r\n\r\n        ctx.save();\r\n        ctx.globalAlpha = alpha;\r\n\r\n        const startCX = Math.floor(camX / chunkSize);\r\n        const endCX = Math.ceil((camX + VIEWPORT.WIDTH) / chunkSize);\r\n        const startCY = Math.floor(camY / chunkSize);\r\n        const endCY = Math.ceil((camY + VIEWPORT.HEIGHT) / chunkSize);\r\n\r\n        const lerpColor = (a: [number, number, number], b: [number, number, number], t: number): [number, number, number] => [\r\n            Math.floor(this.utility.lerp(a[0], b[0], t)),\r\n            Math.floor(this.utility.lerp(a[1], b[1], t)),\r\n            Math.floor(this.utility.lerp(a[2], b[2], t)),\r\n        ];\r\n\r\n        const stops: [number, [number, number, number]][] = [];\r\n        const shoreBlend = 0.05;\r\n\r\n        stops.push([lowestDepth, [0, 0, 90]]);\r\n        stops.push([seaLevel * 0.5, [0, 60, 170]]);\r\n        stops.push([seaLevel - shoreBlend, [0, 120, 220]]);\r\n        stops.push([seaLevel + shoreBlend, [0, 200, 140]]);\r\n\r\n        for (const layer of Object.values(layers)) {\r\n            const h = layer.height;\r\n\r\n            if (h <= seaLevel) continue;\r\n\r\n            const t = this.world.worldConfig.worldLayerIndex[layer.name] / (this.world.worldConfig.worldLayerList.length - 1);\r\n            let color: [number, number, number];\r\n\r\n            if (t < 0.25) color = [60, 220, 80];\r\n            else if (t < 0.5) color = [230, 230, 60];\r\n            else if (t < 0.75) color = [240, 140, 50];\r\n            else if (t < 0.95) color = [255, 70, 40];\r\n            else color = [255, 255, 255];\r\n\r\n            stops.push([h, color]);\r\n        }\r\n\r\n        stops.sort((a, b) => a[0] - b[0]);\r\n\r\n        for (let cx = startCX; cx < endCX; cx++) {\r\n            for (let cy = startCY; cy < endCY; cy++) {\r\n                const chunk = this.world.chunks[cx]?.[cy];\r\n                if (!chunk) continue;\r\n\r\n                const startX = cx * chunkSize - camX;\r\n                const startY = cy * chunkSize - camY;\r\n\r\n                for (let y = 0; y < chunkSize; y += resolution) {\r\n                    for (let x = 0; x < chunkSize; x += resolution) {\r\n                        const h = chunk.getHeightAt(x, y, chunkSize);\r\n\r\n                        let lower = stops[0];\r\n                        let upper = stops[stops.length - 1];\r\n                        for (let i = 0; i < stops.length - 1; i++) {\r\n                            if (h >= stops[i][0] && h <= stops[i + 1][0]) {\r\n                                lower = stops[i];\r\n                                upper = stops[i + 1];\r\n                                break;\r\n                            }\r\n                        }\r\n\r\n                        const range = upper[0] - lower[0];\r\n                        let t = range > 0 ? (h - lower[0]) / range : 0;\r\n                        t = this.utility.smoothstep(t);\r\n\r\n                        const [r, g, b] = lerpColor(lower[1], upper[1], t);\r\n                        ctx.fillStyle = `rgb(${r},${g},${b})`;\r\n                        ctx.fillRect(startX + x, startY + y, resolution, resolution);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    /**\r\n     * Draws contour lines showing visible height changes in the terrain.\r\n     */\r\n    private drawContours(): void {\r\n        const ctx = this.ui.ctx;\r\n        if (!ctx || !this.world.isGenerated) return;\r\n\r\n        const camX = this.camera.pos.x;\r\n        const camY = this.camera.pos.y;\r\n        const chunkSize = this.world.worldConfig.worldgenParams.general.chunk.size;\r\n        const resolution = 2;\r\n        const contourStep = 0.02;\r\n        const lineWidth = 1;\r\n        const color = \"rgba(0,0,0,0.35)\";\r\n\r\n        ctx.save();\r\n        ctx.lineWidth = lineWidth;\r\n        ctx.strokeStyle = color;\r\n\r\n        const startCX = Math.floor(camX / chunkSize);\r\n        const endCX = Math.ceil((camX + VIEWPORT.WIDTH) / chunkSize);\r\n        const startCY = Math.floor(camY / chunkSize);\r\n        const endCY = Math.ceil((camY + VIEWPORT.HEIGHT) / chunkSize);\r\n\r\n        const getH = (chunk: any, x: number, y: number): number => chunk.getHeightAt(x, y, chunkSize);\r\n\r\n        for (let cx = startCX; cx < endCX; cx++) {\r\n            for (let cy = startCY; cy < endCY; cy++) {\r\n                const chunk = this.world.chunks[cx]?.[cy];\r\n                if (!chunk) continue;\r\n\r\n                const startX = cx * chunkSize - camX;\r\n                const startY = cy * chunkSize - camY;\r\n\r\n                for (let y = 0; y < chunkSize - resolution; y += resolution) {\r\n                    for (let x = 0; x < chunkSize - resolution; x += resolution) {\r\n                        const h00 = getH(chunk, x, y);\r\n                        const h10 = getH(chunk, x + resolution, y);\r\n                        const h01 = getH(chunk, x, y + resolution);\r\n                        const h11 = getH(chunk, x + resolution, y + resolution);\r\n\r\n                        const minH = Math.min(h00, h10, h01, h11);\r\n                        const maxH = Math.max(h00, h10, h01, h11);\r\n\r\n                        const base = Math.floor(minH / contourStep) * contourStep;\r\n                        for (let level = base; level <= maxH; level += contourStep) {\r\n                            if (level >= minH && level <= maxH) {\r\n                                ctx.beginPath();\r\n\r\n                                const interp = (v1: number, v2: number, offset: number): number => {\r\n                                    const t = (offset - v1) / (v2 - v1);\r\n                                    return Math.max(0, Math.min(1, t));\r\n                                };\r\n\r\n                                const points: { x: number; y: number }[] = [];\r\n\r\n                                if ((level - h00) * (level - h10) < 0)\r\n                                    points.push({ x: startX + x + resolution * interp(h00, h10, level), y: startY + y });\r\n                                if ((level - h10) * (level - h11) < 0)\r\n                                    points.push({ x: startX + x + resolution, y: startY + y + resolution * interp(h10, h11, level) });\r\n                                if ((level - h11) * (level - h01) < 0)\r\n                                    points.push({ x: startX + x + resolution * (1 - interp(h11, h01, level)), y: startY + y + resolution });\r\n                                if ((level - h01) * (level - h00) < 0)\r\n                                    points.push({ x: startX + x, y: startY + y + resolution * (1 - interp(h01, h00, level)) });\r\n\r\n                                if (points.length >= 2) {\r\n                                    ctx.moveTo(points[0].x, points[0].y);\r\n                                    for (let i = 1; i < points.length; i++) ctx.lineTo(points[i].x, points[i].y);\r\n                                    ctx.stroke();\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    /**\r\n     * Draws region overlays with fill + border.\r\n     */\r\n    private drawRegions(): void {\r\n        if (!this.ui.ctx || !this.world.isGenerated || !this.world.regions) return;\r\n\r\n        const ctx = this.ui.ctx;\r\n        const camX = this.camera.pos.x;\r\n        const camY = this.camera.pos.y;\r\n        const chunkSize = this.world.worldConfig.worldgenParams.general.chunk.size;\r\n\r\n        const regionFillColors: Record<RegionName, string> = {\r\n            shore: \"rgba(30, 150, 200, 0.25)\",\r\n            cliffs: \"rgba(180, 80, 60, 0.25)\",\r\n            mountains: \"rgba(120, 120, 140, 0.25)\",\r\n            ocean: \"rgba(40, 80, 180, 0.3)\",\r\n            plains: \"rgba(160, 200, 100, 0.25)\"\r\n        };\r\n\r\n        const regionBorderColors: Record<RegionName, string> = {\r\n            shore: \"#1e96c8\",\r\n            cliffs: \"#b4503c\",\r\n            mountains: \"#78788c\",\r\n            ocean: \"#2850b4\",\r\n            plains: \"#afc543ff\"\r\n        };\r\n\r\n        ctx.save();\r\n\r\n        // First pass: fill\r\n        for (const region of this.world.regions) {\r\n            const color = regionFillColors[region.name];\r\n            ctx.fillStyle = color;\r\n            for (const { cx, cy } of region.chunkCoords) {\r\n                const screenX = cx * chunkSize - camX;\r\n                const screenY = cy * chunkSize - camY;\r\n                ctx.fillRect(screenX, screenY, chunkSize, chunkSize);\r\n            }\r\n        }\r\n\r\n        // Second pass: outline\r\n        ctx.lineWidth = 2;\r\n        for (const region of this.world.regions) {\r\n            const borderColor = regionBorderColors[region.name];\r\n            ctx.strokeStyle = borderColor;\r\n            for (const { cx, cy } of region.chunkCoords) {\r\n                const screenX = cx * chunkSize - camX;\r\n                const screenY = cy * chunkSize - camY;\r\n                ctx.strokeRect(screenX, screenY, chunkSize, chunkSize);\r\n            }\r\n        }\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    /**\r\n     * Draws audio zones and highlights the currently active zones.\r\n     */\r\n    private drawAudioZones(): void {\r\n        const ctx = this.ui.ctx;\r\n        if (!ctx) return;\r\n\r\n        ctx.save();\r\n\r\n        this.world.audioZones.forEach(zone => {\r\n            const screenX = zone.center.x - this.camera.pos.x;\r\n            const screenY = zone.center.y - this.camera.pos.y;\r\n            const radius = zone.audioParams.spatial?.rolloff?.distance || 500;\r\n\r\n            // Draw audio radius\r\n            ctx.strokeStyle = zone.isActive ? '#00ff0055' : '#ffffff22';\r\n            ctx.lineWidth = 2;\r\n            ctx.beginPath();\r\n            ctx.arc(screenX, screenY, radius, 0, Math.PI * 2);\r\n            ctx.stroke();\r\n\r\n            // Draw center point\r\n            ctx.fillStyle = zone.isActive ? '#00ff00' : '#ffffff';\r\n            ctx.fillRect(screenX - 3, screenY - 3, 6, 6);\r\n        });\r\n\r\n        ctx.restore();\r\n    }\r\n\r\n    /**\r\n     * Shows the current debug overlay mode name with a quick fade effect.\r\n     */\r\n    private showOverlayName(): void {\r\n        const existing = document.getElementById('debugOverlayName');\r\n        if (existing) existing.remove();\r\n\r\n        // Create overlay name element\r\n        const overlay = document.createElement('div');\r\n        overlay.id = 'debugOverlayName';\r\n        overlay.textContent = this.overlayNames[this.overlayMode];\r\n        overlay.style.cssText = `\r\n            position: fixed;\r\n            top: 60%;\r\n            left: 50%;\r\n            transform: translate(-50%, -50%);\r\n            background: rgba(0, 0, 0, 0.85);\r\n            color: #ffffff;\r\n            padding: 12px 24px;\r\n            border: 2px solid #888888;\r\n            border-radius: 4px;\r\n            z-index: 99999;\r\n            pointer-events: none;\r\n            opacity: 1;\r\n            transition: opacity 0.3s ease-out;\r\n        `;\r\n\r\n        document.body.appendChild(overlay);\r\n\r\n        setTimeout(() => { // Fade out after short delay\r\n            overlay.style.opacity = '0';\r\n\r\n            setTimeout(() => { // Remove from DOM after fade completes\r\n                if (overlay.parentElement) {\r\n                    overlay.remove();\r\n                }\r\n            }, 300); // Match transition duration\r\n        }, 800); // Show for 800ms before fading\r\n    }\r\n}","import { RoomManager } from \"../RoomManager\";\r\nimport { NetworkChunk, PhysicsMaterialTypes, Vec2 } from \"../Types\";\r\nimport { UserInterface } from \"../UserInterface\";\r\nimport { Utility } from \"../Utility\";\r\nimport { World } from \"./World\";\r\n\r\nexport class WorldEdit {\r\n    private world: World;\r\n    private roomManager: RoomManager;\r\n    private ui: UserInterface;\r\n    private utility: Utility;\r\n\r\n    constructor(\r\n        world: World,\r\n        roomManager: RoomManager,\r\n        ui: UserInterface,\r\n        utility: Utility\r\n    ) {\r\n        this.world = world;\r\n        this.roomManager = roomManager;\r\n        this.ui = ui;\r\n        this.utility = utility;\r\n    }\r\n\r\n    public createChunkPatch(params: NetworkChunk): void {\r\n        // Apply locally\r\n        this.world.handleChunkUpdate(params);\r\n\r\n        // Broadcast\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'chunk-update',\r\n            chunk: params\r\n        }));\r\n    }\r\n\r\n    public createChunkPatchNetwork(params: NetworkChunk): void {\r\n        // No-op if message originated locally (your RoomManager handles filtering)\r\n        this.world.handleChunkUpdate(params);\r\n    }\r\n\r\n    public requestCraterAt(worldPos: Vec2): void {\r\n        const chunkSize = this.world.worldConfig.worldgenParams.general.chunk.size;\r\n        const cx = Math.floor(worldPos.x / chunkSize);\r\n        const cy = Math.floor(worldPos.y / chunkSize);\r\n        const chunk = this.world.chunks[cx]?.[cy];\r\n        if (!chunk) return;\r\n\r\n        const radius = 10;\r\n        const centerX = Math.floor(worldPos.x) % chunkSize;\r\n        const centerY = Math.floor(worldPos.y) % chunkSize;\r\n\r\n        const bedrockIndex = this.world.worldConfig.materialIndex[\"bedrock\"];\r\n        const bedrock = this.world.worldConfig.materialsList[bedrockIndex];\r\n\r\n        const patches: { i: number; pixel?: number; height?: number }[] = [];\r\n\r\n        for (let y = -radius; y <= radius; y++) {\r\n            for (let x = -radius; x <= radius; x++) {\r\n                const localX = centerX + x;\r\n                const localY = centerY + y;\r\n                if (localX < 0 || localX >= chunkSize || localY < 0 || localY >= chunkSize) continue;\r\n\r\n                const idx = localY * chunkSize + localX;\r\n                const newColorIdx = Math.floor(Math.random() * bedrock.colors.length);\r\n                const newPacked = (bedrockIndex << 2) | newColorIdx;\r\n\r\n                chunk.pixelData[idx] = newPacked;\r\n                chunk.heightData[idx] = Math.max(0, chunk.heightData[idx] - 1);\r\n\r\n                patches.push({ i: idx, pixel: newPacked, height: chunk.heightData[idx] });\r\n            }\r\n        }\r\n\r\n        this.createChunkPatch({\r\n            pos: { x: cx, y: cy },\r\n            version: Date.now(),\r\n            size: chunkSize,\r\n            layer: this.world.chunkLayers[cx]?.[cy]?.name || \"unknown\",\r\n            patches\r\n        } as any);\r\n\r\n        console.log(`Crater applied: ${worldPos.x},${worldPos.y}`);\r\n    }\r\n\r\n\r\n    public applyFootstepAt(worldPos: Vec2, materialName: string, force: number): void {\r\n        const chunkSize = this.world.worldConfig.worldgenParams.general.chunk.size;\r\n        const cx = Math.floor(worldPos.x / chunkSize);\r\n        const cy = Math.floor(worldPos.y / chunkSize);\r\n        const chunk = this.world.chunks[cx]?.[cy];\r\n        if (!chunk) return;\r\n\r\n        const centerX = Math.floor(worldPos.x) % chunkSize;\r\n        const centerY = Math.floor(worldPos.y) % chunkSize;\r\n\r\n        const allMaterials = this.world.worldConfig.materialsList;\r\n\r\n        const radius = 4 + Math.floor(force * 3);\r\n        const patches: { i: number; pixel?: number; height?: number }[] = [];\r\n\r\n        for (let y = -radius; y <= radius; y++) {\r\n            for (let x = -radius; x <= radius; x++) {\r\n                const localX = centerX + x;\r\n                const localY = centerY + y;\r\n                if (localX < 0 || localX >= chunkSize || localY < 0 || localY >= chunkSize) continue;\r\n\r\n                const dist = Math.sqrt(x * x + (y * 1.2) * (y * 1.2));\r\n                if (dist > radius) continue;\r\n\r\n                const idx = localY * chunkSize + localX;\r\n\r\n                // Skip any pixels that have water on them\r\n                if (chunk.waterData[idx] > 0) continue;\r\n\r\n                const currentPacked = chunk.pixelData[idx];\r\n                const matIndex = currentPacked >> 2;\r\n                const colorIndex = currentPacked & 3;\r\n\r\n                const currentMat = allMaterials[matIndex];\r\n                if (!currentMat) continue;\r\n\r\n                // Footstep imprint only allowed if the material itself allows it\r\n                if (!currentMat.tags || !currentMat.tags.includes(\"imprint_on_footstep\")) continue;\r\n\r\n                // Darken slightly\r\n                const darken = Math.random() < 0.9;\r\n                const newColorIndex = darken ? Math.max(0, colorIndex - 1) : colorIndex;\r\n\r\n                // Compress height based on distance from center and force\r\n                const compression = (1 - dist / radius) * 0.4 * force;\r\n                const newHeight = Math.max(0, chunk.heightData[idx] - compression);\r\n\r\n                const newPacked = (matIndex << 2) | newColorIndex;\r\n                chunk.pixelData[idx] = newPacked;\r\n                chunk.heightData[idx] = newHeight;\r\n\r\n                patches.push({ i: idx, pixel: newPacked, height: newHeight });\r\n            }\r\n        }\r\n\r\n        // Send delta patch to world\r\n        this.createChunkPatch({\r\n            pos: { x: cx, y: cy },\r\n            version: Date.now(),\r\n            size: chunkSize,\r\n            layer: this.world.chunkLayers[cx]?.[cy]?.name || \"unknown\",\r\n            patches\r\n        } as any);\r\n\r\n        console.log(`Footstep imprint applied: ${worldPos.x}, ${worldPos.y} [${materialName}]`);\r\n    }\r\n}","import { VIEWPORT, WORLD } from \"../Config\";\r\nimport { WorldLayer, CellData, Material, PhysicsMaterialTypes, PixelData, Vec2, NoiseType, NetworkChunk, PixelWaterData, WorldData, WorldRegion, RegionName, AudioZone, ActiveAudio, MaterialName } from \"../Types\";\r\n\r\nimport { Camera } from \"../Camera\";\r\nimport { ControlsManager } from \"../ControlsManager\";\r\nimport { RoomManager } from \"../RoomManager\";\r\nimport { UserInterface } from \"../UserInterface\";\r\nimport { Utility } from \"../Utility\";\r\nimport { WorldChunk } from \"./WorldChunk\";\r\nimport { WorldConfig } from \"./WorldConfig\";\r\nimport { WorldDebug } from \"./WorldDebug\";\r\nimport { WorldEdit } from \"./WorldEdit\";\r\n\r\nimport { AudioConfig } from \"../audio/AudioConfig\";\r\nimport { AudioManager } from \"../audio/AudioManager\";\r\n\r\nimport { PlayerState } from \"../player/PlayerState\";\r\n\r\nexport class World {\r\n    public chunks: WorldChunk[][] = [];\r\n    public chunkLayers: WorldLayer[][] = [];\r\n    public regions: WorldRegion[] = [];\r\n\r\n    public audioZones: Map<string, AudioZone> = new Map();\r\n    private regionAudioSources: Map<number, { element: ActiveAudio | null; volume: number }> = new Map();\r\n\r\n    public isGenerated = false;\r\n    public currentSeed = 0;\r\n\r\n    public worldConfig: WorldConfig;\r\n    public worldDebug: WorldDebug;\r\n    public worldEdit: WorldEdit;\r\n\r\n    private erosionTemplate: { name: MaterialName; index: number }[] | null = null;\r\n    private chunkBuffer: { cx: number; cy: number; loaded: boolean }[] = [];\r\n    private worldBuffer: CellData | null = null;\r\n\r\n    private readonly YIELD_RATE = 10;\r\n    private readonly WORLDGEN_PHASES: readonly string[] = [\"cells\", \"degen\", \"hydration\"];\r\n\r\n    constructor(\r\n        private audioConfig: AudioConfig,\r\n        private audioManager: AudioManager,\r\n        private camera: Camera,\r\n        private controlsManager: ControlsManager,\r\n        private playerState: PlayerState,\r\n        private roomManager: RoomManager,\r\n        private ui: UserInterface,\r\n        private utility: Utility\r\n    ) {\r\n        this.worldConfig = new WorldConfig();\r\n        this.worldDebug = new WorldDebug(this.camera, this.controlsManager, this.ui, this.utility, this);\r\n        this.worldEdit = new WorldEdit(this, this.roomManager, this.ui, this.utility);\r\n\r\n        this.initLoadingProgressEvents();\r\n    }\r\n\r\n    // #region [ General ]\r\n    //\r\n    /**\r\n     * Clears all of the world data for a fresh slate.\r\n     */\r\n    public clear(): void {\r\n        console.log(\"Clearing world data...\");\r\n\r\n        // Core data maps\r\n        this.chunks = [];\r\n        this.chunkLayers = [];\r\n        this.regions = [];\r\n\r\n        this.cleanWorldAudio();\r\n\r\n        // Buffers and templates\r\n        this.chunkBuffer = [];\r\n        this.worldBuffer = null;\r\n        this.erosionTemplate = null;\r\n\r\n        // State flags\r\n        this.isGenerated = false;\r\n        this.currentSeed = 0;\r\n\r\n        // Debug + UI cleanup\r\n        this.worldDebug.hoveredChunk = null;\r\n\r\n        if (this.ui.worldCtx && this.ui.worldCanvas) {\r\n            this.ui.worldCtx.clearRect(0, 0, WORLD.WIDTH, WORLD.HEIGHT);\r\n        }\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Generation ]\r\n    //\r\n\r\n    /**\r\n     * Shows the generation menu for the host allows worldgen tuning.\r\n     * \r\n     * Returns seed and chosen params for network sync and generation.\r\n     */\r\n    public async showGenerationMenu(): Promise<WorldData | \"load\"> {\r\n        const result = await this.worldgenMenu();\r\n\r\n        if (result.mode === \"load\" && result.file) {\r\n            await this.loadWorldFromFile(result.file);\r\n            return \"load\"; // signal that we loaded\r\n        }\r\n\r\n        const params = this.worldConfig.worldgenParams;\r\n        const seed = params.general.seed || Date.now();\r\n\r\n        params.general.seed = seed;\r\n        this.currentSeed = seed;\r\n\r\n        return { seed, params };\r\n    }\r\n\r\n    /**\r\n     * Main world generation loop.\r\n     * \r\n     * - Creates cellData\r\n     * - Uses cellData for degeneration pass\r\n     * - Hydrates cells for water coverage\r\n     * - Bakes world details into chunks\r\n     */\r\n    public async generateWorld(worldData: WorldData): Promise<void> {\r\n        this.showLoadingMenu();\r\n        this.clear(); // Full refresh just in case\r\n\r\n        this.worldConfig.worldgenParams = worldData.params;\r\n        this.currentSeed = worldData.seed;\r\n\r\n        const cellData = await this.generateCells(worldData.seed);\r\n        const degenCellData = await this.applyDegen(cellData, worldData.seed);\r\n        const hydratedCellData = await this.applyHydration(degenCellData, worldData.seed);\r\n\r\n        await this.bakeChunksFromCells(hydratedCellData);\r\n\r\n        this.isGenerated = true;\r\n        this.hideLoadingMenu();\r\n        console.log(`World generated: ${worldData.seed}`);\r\n    }\r\n\r\n    /**\r\n     * Processes cell generation, which is responsible for the detail level in the world.\r\n     * \r\n     * Creates and returns the CellData which is used to bake the cells into chunks.\r\n     */\r\n    private async generateCells(seed: number): Promise<CellData> {\r\n        const worldGenParams = this.worldConfig.worldgenParams;\r\n        const cellSize = worldGenParams.general.cell.size;\r\n        const terrain = worldGenParams.terrain;\r\n        const lowestDepth = terrain.lowestDepth;\r\n        const seaLevel = terrain.seaLevel;\r\n\r\n        // Determine how many cells needed to fill world\r\n        const cellsX = Math.ceil(WORLD.WIDTH / cellSize);\r\n        const cellsY = Math.ceil(WORLD.HEIGHT / cellSize);\r\n\r\n        const worldPixelData = new Uint8Array(WORLD.WIDTH * WORLD.HEIGHT); // Build storage for pixel data (1byte per px)\r\n        const worldHeightData = new Uint8Array(WORLD.WIDTH * WORLD.HEIGHT); // Build storage for pixel height data (1byte per px)\r\n\r\n        // Build storage for the layer type for each cell\r\n        const cellLayerGrid: number[][] = Array.from({ length: cellsY }, () => new Array<number>(cellsX).fill(0));\r\n\r\n        // Show status message\r\n        const message = this.worldConfig.getWorldgenMessage(\"generation\");\r\n        await this.utility.yield(message);\r\n\r\n        const totalCells = cellsX * cellsY;\r\n        let processedCells = 0;\r\n\r\n        for (let cellY = 0; cellY < cellsY; cellY++) {\r\n            for (let cellX = 0; cellX < cellsX; cellX++) {\r\n\r\n                processedCells++;\r\n                if (processedCells % Math.floor(totalCells / this.YIELD_RATE) === 0) {\r\n                    await this.utility.yield();\r\n                }\r\n\r\n                // Sample height from noise\r\n                let adjustedHeight = this.utility.getNoise(\r\n                    terrain.noiseType,\r\n                    (cellX + 0.5) * terrain.scale,\r\n                    (cellY + 0.5) * terrain.scale,\r\n                    seed,\r\n                    {\r\n                        octaves: terrain.octaves,\r\n                        persistence: terrain.persistence\r\n                    }\r\n                );\r\n\r\n                if (adjustedHeight < 0) adjustedHeight = 0;\r\n                else if (adjustedHeight > 1) adjustedHeight = 1; // Clamp [0..1]\r\n\r\n                const mid: number = 0.5; // Push contrast around midpoint\r\n                adjustedHeight = mid + (adjustedHeight - mid) * terrain.intensity;\r\n                if (adjustedHeight < 0) adjustedHeight = 0;\r\n                else if (adjustedHeight > 1) adjustedHeight = 1; // Clamp [0..1]\r\n\r\n                adjustedHeight = Math.pow(adjustedHeight, terrain.heightCurve); // Bias curve\r\n                if (adjustedHeight < 0) adjustedHeight = 0;\r\n                else if (adjustedHeight > 1) adjustedHeight = 1; // Clamp [0..1]\r\n\r\n                // === Island / Valley shaping (exclusive) ===\r\n                const opts = worldGenParams.general.options;\r\n                if (opts.island || opts.valley) {\r\n\r\n                    // Distance from nearest world edge\r\n                    const distToEdgeX = Math.min(cellX * cellSize, WORLD.WIDTH - (cellX * cellSize + cellSize));\r\n                    const distToEdgeY = Math.min(cellY * cellSize, WORLD.HEIGHT - (cellY * cellSize + cellSize));\r\n                    const distToEdge = Math.min(distToEdgeX, distToEdgeY);\r\n\r\n                    // Normalize 0 at edge  1 at center\r\n                    const maxDist = Math.min(WORLD.WIDTH, WORLD.HEIGHT) * 0.5;\r\n                    let t = Math.min(1, distToEdge / maxDist);\r\n\r\n                    // Smooth curve (smootherstep)\r\n                    t = t * t * (3 - 2 * t);\r\n\r\n                    // Optional subtle noise for organic variation\r\n                    const edgeNoise = this.utility.getNoise(\r\n                        terrain.noiseType,\r\n                        cellX * 0.002,\r\n                        cellY * 0.002,\r\n                        seed + 9100,\r\n                        { octaves: 2, persistence: 0.5 }\r\n                    ) * 0.1;\r\n\r\n                    // === ISLAND MODE ===\r\n                    if (opts.island) {\r\n                        const target = seaLevel * 0.5; // deep ocean floor baseline\r\n                        adjustedHeight = this.utility.lerp(target, adjustedHeight, t + edgeNoise);\r\n\r\n                        if (adjustedHeight < lowestDepth) adjustedHeight = lowestDepth;\r\n                        else if (adjustedHeight > 1) adjustedHeight = 1;\r\n                    }\r\n\r\n                    // === VALLEY MODE ===\r\n                    else if (opts.valley) {\r\n                        // Hard mountain edge (height  1) fading toward valley\r\n                        const fade = Math.pow(1 - t, terrain.heightCurve * 1.5);\r\n                        const target = 1.0; // mountain peak height\r\n                        adjustedHeight = this.utility.lerp(adjustedHeight, target, fade + edgeNoise);\r\n\r\n                        if (adjustedHeight < lowestDepth) adjustedHeight = lowestDepth;\r\n                        else if (adjustedHeight > 1) adjustedHeight = 1;\r\n                    }\r\n                }\r\n\r\n\r\n                if (adjustedHeight < lowestDepth) { adjustedHeight = lowestDepth; } // Clamp water floor to lowestDepth\r\n\r\n                const layerForCell = this.pickLayerForHeight(adjustedHeight);\r\n\r\n                const layerIndex = this.worldConfig.worldLayerIndex[layerForCell.name];\r\n                cellLayerGrid[cellY][cellX] = layerIndex;\r\n\r\n                // Calculate pixel coordinates in this cell\r\n                const startX = cellX * cellSize;\r\n                const startY = cellY * cellSize;\r\n\r\n                for (let ly = 0; ly < cellSize; ly++) {\r\n                    for (let lx = 0; lx < cellSize; lx++) {\r\n                        const worldPos = {\r\n                            x: startX + lx,\r\n                            y: startY + ly\r\n                        }\r\n\r\n                        if (worldPos.x >= WORLD.WIDTH || worldPos.y >= WORLD.HEIGHT) continue; // Skip cells outside the world\r\n\r\n                        const pixelInfo = this.samplePixelData(worldPos, seed, layerForCell);\r\n\r\n                        const landMatIndex = this.worldConfig.materialIndex[pixelInfo.material.name];\r\n\r\n                        const outMaterialIndex = landMatIndex >= 0 ? landMatIndex : 0;\r\n                        const outColorIndex = pixelInfo.materialColorIndex;\r\n\r\n                        const combined = (outMaterialIndex << 2) | outColorIndex;\r\n\r\n                        const gi = worldPos.y * WORLD.WIDTH + worldPos.x;\r\n                        worldPixelData[gi] = combined;\r\n\r\n                        // Store final adjustedHeight (0..1 mapped to 0..255)\r\n                        worldHeightData[gi] = Math.round(adjustedHeight * 255);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n\r\n        return { worldPixelData, worldHeightData, cellLayerGrid };\r\n    }\r\n\r\n    /**\r\n     * Given the provided inputs, sample what pixel should be at this worldPos based on the seed.\r\n     * \r\n     * Decides:\r\n     * - Which material goes here using layer weights and noise\r\n     * - Which color variant of that material to use\r\n     * - Returns that and the layer we used to make the decision\r\n     */\r\n    public samplePixelData(worldPos: Vec2, seed: number, layer: WorldLayer): PixelData {\r\n        // Sample broad-scale material noise for this pixel\r\n        // (used to pick WHICH material from the layer we get here)\r\n        const materialNoise = this.utility.getNoise(\r\n            this.worldConfig.worldgenParams.material.noiseType,\r\n            worldPos.x * this.worldConfig.worldgenParams.material.scale,\r\n            worldPos.y * this.worldConfig.worldgenParams.material.scale,\r\n            seed + 1000,\r\n            {\r\n                octaves: this.worldConfig.worldgenParams.terrain.octaves,\r\n                persistence: this.worldConfig.worldgenParams.terrain.persistence\r\n            }\r\n        );\r\n\r\n        // Roll weighted choice from the layer's material list\r\n        // { material: \"dirt\", weight: 3 }\r\n        const entries = layer.materials;\r\n        const totalWeight = entries.reduce((s, m) => s + m.weight, 0);\r\n        let target = materialNoise * totalWeight;\r\n\r\n        let selectedMaterial: Material = this.worldConfig.materialsList[this.worldConfig.materialIndex[\"stone\"]];\r\n\r\n        for (const entry of entries) {\r\n            target -= entry.weight;\r\n            if (target <= 0) {\r\n                const idx = this.worldConfig.materialIndex[entry.material];\r\n                if (idx !== undefined) {\r\n                    selectedMaterial = this.worldConfig.materialsList[idx];\r\n                }\r\n                break;\r\n            }\r\n        }\r\n\r\n        // Sample higher-frequency noise to pick which color index of chosen material to use\r\n        // (this breaks up flat color tiling so it doesn't look copy/paste everywhere)\r\n        const detailNoise = this.utility.getNoise(\r\n            this.worldConfig.worldgenParams.material.detail.noiseType,\r\n            worldPos.x * this.worldConfig.worldgenParams.material.detail.scale,\r\n            worldPos.y * this.worldConfig.worldgenParams.material.detail.scale,\r\n            seed + 3000,\r\n            {\r\n                octaves: this.worldConfig.worldgenParams.terrain.octaves,\r\n                persistence: this.worldConfig.worldgenParams.terrain.persistence\r\n            }\r\n        );\r\n        const colorIdx = Math.floor(detailNoise * selectedMaterial.colors.length); // Pick color index from material's palette\r\n\r\n        return { material: selectedMaterial, materialColorIndex: colorIdx, layer };\r\n    }\r\n\r\n    /**\r\n     * Processes a normalized height value, and picks the closest layer.\r\n     */\r\n    private pickLayerForHeight(h: number): WorldLayer {\r\n        const layers = this.worldConfig.worldLayerList;\r\n\r\n        let best = layers[0]; // Start with first layer as \"best match\"\r\n        let bestDist = Math.abs(h - best.height);\r\n\r\n        // Check all other layer and find correct best match\r\n        for (let i = 1; i < layers.length; i++) {\r\n            const d = Math.abs(h - layers[i].height);\r\n            if (d < bestDist) {\r\n                best = layers[i];\r\n                bestDist = d;\r\n            }\r\n        }\r\n        return best;\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Degeneration ]\r\n    //\r\n    /**\r\n     * Second-phase world shaping.\r\n     * \r\n     * Lowers height, changes material and simulates nearby pixels.\r\n     * \r\n     * Returns new CellData.\r\n     */\r\n    private async applyDegen(cellData: CellData, seed: number): Promise<CellData> {\r\n        console.log(\"Applying degeneration pass...\");\r\n\r\n        const { worldPixelData, worldHeightData, cellLayerGrid } = cellData;\r\n        const newPixelData = new Uint8Array(worldPixelData);\r\n        const newHeightData = new Uint8Array(worldHeightData);\r\n\r\n        const degenConfig = this.worldConfig.worldgenParams.degen;\r\n        const allMaterials = this.worldConfig.materialsList;\r\n\r\n        const erosionMaterials = this.getErosionTemplate();\r\n\r\n        const message = this.worldConfig.getWorldgenMessage(\"degeneration\");\r\n        await this.utility.yield(message);\r\n\r\n        const totalPixels = WORLD.WIDTH * WORLD.HEIGHT;\r\n        let processedPixels = 0;\r\n\r\n        // === EROSION PASS ===\r\n        for (let wy = 0; wy < WORLD.HEIGHT; wy++) {\r\n            for (let wx = 0; wx < WORLD.WIDTH; wx++) {\r\n                const gi = wy * WORLD.WIDTH + wx;\r\n\r\n                processedPixels++;\r\n                if (processedPixels % Math.floor(totalPixels / this.YIELD_RATE) === 0) {\r\n                    await this.utility.yield();\r\n                }\r\n\r\n                const originalHeightByte = worldHeightData[gi];\r\n                const originalHeight01 = originalHeightByte / 255;\r\n\r\n                // Skip if below minimum erosion height\r\n                if (originalHeight01 < degenConfig.minHeight) {\r\n                    newPixelData[gi] = worldPixelData[gi];\r\n                    newHeightData[gi] = worldHeightData[gi];\r\n                    continue;\r\n                }\r\n\r\n                // === CALCULATE EROSION AMOUNT ===\r\n                const erosionNoise = this.utility.getNoise(\r\n                    degenConfig.noiseType,\r\n                    wx * degenConfig.scale,\r\n                    wy * degenConfig.scale,\r\n                    seed + 6000,\r\n                    {\r\n                        octaves: this.worldConfig.worldgenParams.degen.scale,\r\n                        persistence: this.worldConfig.worldgenParams.degen.hardness\r\n                    }\r\n                );\r\n\r\n                const detailNoise = this.utility.getNoise(\r\n                    degenConfig.detail.noiseType,\r\n                    wx * degenConfig.detail.scale,\r\n                    wy * degenConfig.detail.scale,\r\n                    seed + 7000,\r\n                    {\r\n                        octaves: this.worldConfig.worldgenParams.degen.detail.scale,\r\n                        persistence: this.worldConfig.worldgenParams.degen.hardness\r\n                    }\r\n                );\r\n\r\n                // Combine noises\r\n                const combinedNoise = erosionNoise * 0.7 + detailNoise * 0.3;\r\n\r\n                // Only erode if above threshold\r\n                if (combinedNoise < degenConfig.threshold) {\r\n                    newPixelData[gi] = worldPixelData[gi];\r\n                    newHeightData[gi] = worldHeightData[gi];\r\n                    continue;\r\n                }\r\n\r\n                // Calculate erosion strength\r\n                const erosionStrength = (combinedNoise - degenConfig.threshold) / (1 - degenConfig.threshold);\r\n                const erosionAmount = erosionStrength * degenConfig.intensity;\r\n\r\n                // Get current material's durability (check if solid first!)\r\n                const currentPacked = worldPixelData[gi];\r\n                const currentMatIndex = currentPacked >> 2;\r\n                const currentMat = allMaterials[currentMatIndex];\r\n\r\n                let durability = 0.5;\r\n                if (currentMat.physics.type === PhysicsMaterialTypes.Solid) {\r\n                    durability = currentMat.physics.durability;\r\n                }\r\n\r\n                // Apply erosion with material resistance\r\n                const heightReduction = erosionAmount * (1 - durability) * degenConfig.hardness;\r\n                let newHeight01 = originalHeight01 - heightReduction;\r\n                if (newHeight01 < 0) newHeight01 = 0;\r\n\r\n                const newHeightByte = Math.round(newHeight01 * 255);\r\n                newHeightData[gi] = newHeightByte;\r\n\r\n                // === CALCULATE EROSION DEPTH (0 = no erosion, 1 = max erosion) ===\r\n                const erosionDepth = (originalHeight01 - newHeight01) / Math.max(0.01, originalHeight01);\r\n\r\n                // === SELECT MATERIAL BASED ON EROSION DEPTH ===\r\n                // Map erosion depth to material hardness gradient\r\n                // 0% eroded = keep original material (or softest if significantly eroded)\r\n                // 100% eroded = hardest material (bedrock)\r\n\r\n                const originalDurability = currentMat.physics.type === PhysicsMaterialTypes.Solid\r\n                    ? currentMat.physics.durability\r\n                    : 0.5;\r\n\r\n\r\n                const harderMaterials = erosionMaterials.filter(m => {\r\n                    const mat = allMaterials[m.index];\r\n                    if (!mat) return false;\r\n\r\n                    const matDurability =\r\n                        mat.physics.type === PhysicsMaterialTypes.Solid\r\n                            ? mat.physics.durability\r\n                            : 0.5;\r\n\r\n                    return matDurability >= originalDurability;\r\n                });\r\n\r\n                let newMatIndex: number;\r\n                let newColorVariantIndex: number;\r\n\r\n                if (harderMaterials.length === 0) {\r\n                    // Current material is already the hardest - keep it\r\n                    newMatIndex = currentMatIndex;\r\n                    const colorVariant = currentPacked & 0b11;\r\n                    newColorVariantIndex = colorVariant;\r\n                } else {\r\n                    // Map erosion depth [0...1] to harder materials gradient [0...length-1]\r\n                    const normalizedDepth = Math.min(1, erosionDepth);\r\n                    const materialIndex = Math.floor(normalizedDepth * (harderMaterials.length - 1));\r\n                    const clampedIndex = Math.min(materialIndex, harderMaterials.length - 1);\r\n\r\n                    newMatIndex = harderMaterials[clampedIndex].index;\r\n\r\n                    // Pick random color variant for the new material\r\n                    const detailForColor = this.utility.getNoise(\r\n                        this.worldConfig.worldgenParams.material.detail.noiseType,\r\n                        wx * this.worldConfig.worldgenParams.material.detail.scale,\r\n                        wy * this.worldConfig.worldgenParams.material.detail.scale,\r\n                        seed + 8000,\r\n                        {\r\n                            octaves: this.worldConfig.worldgenParams.degen.detail.scale,\r\n                            persistence: this.worldConfig.worldgenParams.degen.hardness\r\n                        }\r\n                    );\r\n\r\n                    const selectedMat = allMaterials[newMatIndex];\r\n                    const numColors = selectedMat.colors.length;\r\n                    newColorVariantIndex = Math.floor(detailForColor * numColors) % numColors;\r\n                }\r\n\r\n                // Pack and store\r\n                const newPacked = (newMatIndex << 2) | (newColorVariantIndex & 0b11);\r\n                newPixelData[gi] = newPacked;\r\n            }\r\n        }\r\n\r\n        console.log(\"Degeneration pass complete.\");\r\n        return {\r\n            worldPixelData: newPixelData,\r\n            worldHeightData: newHeightData,\r\n            cellLayerGrid: cellLayerGrid\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Gets or creates the erosion template from the chosen materials.\r\n     */\r\n    private getErosionTemplate(): { name: MaterialName; index: number }[] {\r\n        if (this.erosionTemplate) return this.erosionTemplate;\r\n\r\n        const lookup = this.worldConfig.materialIndex;\r\n\r\n        const cached: { name: MaterialName; index: number }[] =\r\n            this.worldConfig.materialsList\r\n                .filter(mat => mat.tags?.includes(\"erosion_source\"))\r\n                .map(mat => ({\r\n                    name: mat.name,\r\n                    index: lookup[mat.name]\r\n                }));\r\n\r\n        this.erosionTemplate = cached;\r\n        console.log(\"Cached erosion materials from tags...\");\r\n\r\n        return cached;\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Hydration ]\r\n    //\r\n\r\n    private async applyHydration(cellData: CellData, seed: number): Promise<CellData> {\r\n        console.log(\"Applying hydration pass...\");\r\n\r\n        const { worldPixelData, worldHeightData, cellLayerGrid } = cellData;\r\n        const newWaterData = new Uint8Array(worldPixelData.length);\r\n        const newPixelData = new Uint8Array(worldPixelData);\r\n\r\n        const allMaterials = this.worldConfig.materialsList;\r\n        const materialIndexLookup = this.worldConfig.materialIndex;\r\n\r\n        const seaLevel = this.worldConfig.worldgenParams.terrain.seaLevel;\r\n        const lowestDepth = this.worldConfig.worldgenParams.terrain.lowestDepth;\r\n        const depthRange = seaLevel - lowestDepth;\r\n\r\n        const width = WORLD.WIDTH;\r\n        const height = WORLD.HEIGHT;\r\n        const totalPixels = width * height;\r\n\r\n        const message = this.worldConfig.getWorldgenMessage(\"hydration\");\r\n        await this.utility.yield(message);\r\n\r\n        // === 1. Create water depth & wetness mask ===\r\n        const wetness = new Float32Array(totalPixels);\r\n        const isWaterPixel = new Uint8Array(totalPixels); // < track direct water\r\n\r\n        for (let i = 0; i < totalPixels; i++) {\r\n            const h = worldHeightData[i] / 255;\r\n            let depthT = 0;\r\n            if (h < seaLevel) {\r\n                depthT = (seaLevel - h) / depthRange;\r\n                depthT = Math.max(0, Math.min(1, depthT));\r\n                newWaterData[i] = Math.round(depthT * 255);\r\n                wetness[i] = 1; // < force full wetness\r\n                isWaterPixel[i] = 1; // < mark as direct water\r\n            } else {\r\n                newWaterData[i] = 0;\r\n                wetness[i] = 0;\r\n            }\r\n        }\r\n\r\n        // === 2. Diffuse wetness outward (fast blur pass) ===\r\n        const tmp = new Float32Array(totalPixels);\r\n        const passes = 4;\r\n        const blurRadius = 5;\r\n\r\n        for (let pass = 0; pass < passes; pass++) {\r\n            for (let y = 0; y < height; y++) {\r\n                for (let x = 0; x < width; x++) {\r\n                    const idx = y * width + x;\r\n\r\n                    // skip direct water pixels; keep them at full wetness\r\n                    if (isWaterPixel[idx]) {\r\n                        tmp[idx] = 1;\r\n                        continue;\r\n                    }\r\n\r\n                    let acc = wetness[idx];\r\n                    let count = 1;\r\n                    for (let dy = -blurRadius; dy <= blurRadius; dy++) {\r\n                        for (let dx = -blurRadius; dx <= blurRadius; dx++) {\r\n                            if (dx === 0 && dy === 0) continue;\r\n                            const nx = x + dx;\r\n                            const ny = y + dy;\r\n                            if (nx < 0 || ny < 0 || nx >= width || ny >= height) continue;\r\n                            const nIdx = ny * width + nx;\r\n                            acc += wetness[nIdx];\r\n                            count++;\r\n                        }\r\n                    }\r\n                    tmp[idx] = acc / count;\r\n                }\r\n            }\r\n            wetness.set(tmp);\r\n        }\r\n\r\n        // === 3. Add subtle low-frequency noise for realism ===\r\n        const moistureNoiseScale = 0.0025;\r\n        for (let y = 0; y < height; y++) {\r\n            for (let x = 0; x < width; x++) {\r\n                const idx = y * width + x;\r\n                const n = this.utility.getNoise(\r\n                    this.worldConfig.worldgenParams.material.noiseType,\r\n                    x * moistureNoiseScale,\r\n                    y * moistureNoiseScale,\r\n                    seed + 9999\r\n                );\r\n                wetness[idx] = Math.min(1, Math.max(0, wetness[idx] * (0.9 + n * 0.3)));\r\n            }\r\n        }\r\n\r\n        // === 4. Apply material conversion based on wetness threshold ===\r\n        const dryThreshold = 0.05;\r\n\r\n        for (let i = 0; i < totalPixels; i++) {\r\n            const w = wetness[i];\r\n            if (w <= dryThreshold) continue;\r\n\r\n            const packed = worldPixelData[i];\r\n            const matIndex = packed >> 2;\r\n            const colorIndex = packed & 0b11;\r\n            const mat = allMaterials[matIndex];\r\n\r\n            if (!mat.tags || !mat.tags.includes(\"absorbent\")) continue;\r\n\r\n            // chance of wet conversion increases with wetness\r\n            const probability = (w - dryThreshold) / (1 - dryThreshold);\r\n            if (Math.random() < probability) {\r\n                const wetMat = this.worldConfig.mutate(mat, \"wet\");\r\n                if (wetMat) {\r\n                    const wetIndex = materialIndexLookup[wetMat.name];\r\n                    newPixelData[i] = (wetIndex << 2) | colorIndex;\r\n                }\r\n            }\r\n        }\r\n\r\n        console.log(\"Hydration pass complete (noise diffusion).\");\r\n        return {\r\n            worldPixelData: newPixelData,\r\n            worldHeightData,\r\n            worldWaterData: newWaterData,\r\n            cellLayerGrid\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Helper method that returns PixelWaterData.\r\n     * \r\n     * This contains the amount of water in a cell and the current water material.\r\n     */\r\n    public getWaterData(worldPos: Vec2): PixelWaterData | null {\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const cx = Math.floor(worldPos.x / chunkSize);\r\n        const cy = Math.floor(worldPos.y / chunkSize);\r\n\r\n        const chunk = this.chunks[cx]?.[cy];\r\n        if (!chunk) return null;\r\n\r\n        const localX = worldPos.x - cx * chunkSize;\r\n        const localY = worldPos.y - cy * chunkSize;\r\n        const waterLevel = chunk.getWaterAt(localX, localY, chunkSize);\r\n\r\n        if (waterLevel <= 0) return null;\r\n\r\n        const height = chunk.getHeightAt(localX, localY, chunkSize);\r\n        const seaLevel = this.worldConfig.worldgenParams.terrain.seaLevel;\r\n        const depth = seaLevel - height;\r\n\r\n        const waterMaterial = this.worldConfig.materialsList[this.worldConfig.materialIndex[\"water\"]];\r\n\r\n        const pxWaterData: PixelWaterData = {\r\n            hasWater: true,\r\n            waterLevel,\r\n            depth,\r\n            material: waterMaterial\r\n        }\r\n\r\n        return pxWaterData;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Baking ]\r\n    //\r\n    /**\r\n     * Bakes all generated cells into chunks.\r\n     */\r\n    private async bakeChunksFromCells(params: CellData): Promise<void> {\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size; // Get the chunk size from the config\r\n        const allWorldLayers = this.worldConfig.worldLayerList;\r\n\r\n        this.worldBuffer = params; // Save worldData for streaming\r\n\r\n        if (!params.worldHeightData || !params.worldPixelData || !params.worldWaterData) return; // Return if you don't have the data\r\n\r\n        // Determine how many chunks needed to fill world\r\n        const chunksX = Math.ceil(WORLD.WIDTH / chunkSize);\r\n        const chunksY = Math.ceil(WORLD.HEIGHT / chunkSize);\r\n        const totalChunks = chunksX * chunksY;\r\n\r\n        const cellSize = this.worldConfig.worldgenParams.general.cell.size; // Get cell size from config\r\n\r\n        // Check how many cells there are filling the world\r\n        const cellsX = Math.ceil(WORLD.WIDTH / cellSize);\r\n        const cellsY = Math.ceil(WORLD.HEIGHT / cellSize);\r\n\r\n        const startMessage = this.worldConfig.getWorldgenMessage(\"bakeStart\");\r\n        const secondMessage = this.worldConfig.getWorldgenMessage(\"bakeHalf\");\r\n\r\n        await this.utility.yield(startMessage);\r\n\r\n        // === sort chunks by distance to player spawn ===\r\n        const spawn = {\r\n            x: this.playerState.myPlayer.transform.pos.x,\r\n            y: this.playerState.myPlayer.transform.pos.y\r\n        };\r\n        const chunkCoords: { cx: number; cy: number; dist: number }[] = [];\r\n\r\n        for (let cx = 0; cx < chunksX; cx++) {\r\n            for (let cy = 0; cy < chunksY; cy++) {\r\n                const centerX = (cx + 0.5) * chunkSize;\r\n                const centerY = (cy + 0.5) * chunkSize;\r\n                const dx = centerX - spawn.x;\r\n                const dy = centerY - spawn.y;\r\n                chunkCoords.push({ cx, cy, dist: Math.sqrt(dx * dx + dy * dy) });\r\n            }\r\n        }\r\n        chunkCoords.sort((a, b) => a.dist - b.dist);\r\n\r\n        // === iterate sorted chunks ===\r\n        const progressMessagePoint = Math.floor(totalChunks * 0.25);\r\n        const halfwayPoint = Math.floor(totalChunks * 0.5);\r\n\r\n        for (let i = 0; i < chunkCoords.length; i++) {\r\n            const { cx, cy } = chunkCoords[i];\r\n\r\n            if (i === progressMessagePoint) {\r\n                await this.utility.yield(secondMessage);\r\n            }\r\n\r\n            if (i === halfwayPoint) {\r\n                this.chunkBuffer = chunkCoords.slice(i).map(c => ({ cx: c.cx, cy: c.cy, loaded: false })); // Store remaining chunks for streaming later\r\n\r\n                this.isGenerated = true;\r\n                this.hideLoadingMenu();\r\n                console.log(`Returned early after ${i}/${totalChunks} chunks baked. Buffered ${this.chunkBuffer.length} chunks for streaming.`);\r\n                this.dumpChunkBuffer(); // Load all remaining chunks\r\n                return;\r\n            }\r\n            else {\r\n                await this.utility.yield();\r\n            }\r\n\r\n            // === keep all your existing chunk-baking code ===\r\n            const chunkPixels = new Uint8Array(chunkSize * chunkSize);\r\n            const chunkHeights = new Uint8Array(chunkSize * chunkSize);\r\n            const chunkWater = new Uint8Array(chunkSize * chunkSize);\r\n\r\n            for (let y = 0; y < chunkSize; y++) {\r\n                for (let x = 0; x < chunkSize; x++) {\r\n                    const worldX = cx * chunkSize + x;\r\n                    const worldY = cy * chunkSize + y;\r\n                    if (worldX >= WORLD.WIDTH || worldY >= WORLD.HEIGHT) continue;\r\n\r\n                    const gi = worldY * WORLD.WIDTH + worldX;\r\n                    const li = y * chunkSize + x;\r\n\r\n                    chunkPixels[li] = params.worldPixelData[gi];\r\n                    chunkHeights[li] = params.worldHeightData[gi];\r\n                    chunkWater[li] = params.worldWaterData[gi];\r\n                }\r\n            }\r\n\r\n            const layerCounts: Record<number, number> = {};\r\n            const startCellX = Math.floor((cx * chunkSize) / cellSize);\r\n            const endCellX = Math.floor(((cx + 1) * chunkSize - 1) / cellSize);\r\n            const startCellY = Math.floor((cy * chunkSize) / cellSize);\r\n            const endCellY = Math.floor(((cy + 1) * chunkSize - 1) / cellSize);\r\n\r\n            for (let cby = startCellY; cby <= endCellY; cby++) {\r\n                if (cby < 0 || cby >= cellsY) continue;\r\n                for (let cbx = startCellX; cbx <= endCellX; cbx++) {\r\n                    if (cbx < 0 || cbx >= cellsX) continue;\r\n                    if (!params.cellLayerGrid) continue;\r\n\r\n                    const idx = params.cellLayerGrid[cby][cbx];\r\n                    layerCounts[idx] = (layerCounts[idx] || 0) + 1;\r\n                }\r\n            }\r\n\r\n            let dominantIdx = 0, max = -1;\r\n            for (const k in layerCounts) {\r\n                const c = layerCounts[k as any];\r\n                if (c > max) { max = c; dominantIdx = parseInt(k, 10); }\r\n            }\r\n\r\n            const dominantLayer = allWorldLayers[dominantIdx] || allWorldLayers[0];\r\n\r\n            const worldChunk = new WorldChunk(\r\n                dominantLayer.name,\r\n                chunkPixels,\r\n                chunkHeights,\r\n                chunkWater,\r\n                this.worldConfig\r\n            );\r\n\r\n            // Ensure row arrays exist\r\n            if (!this.chunks[cx]) this.chunks[cx] = [];\r\n            if (!this.chunkLayers[cx]) this.chunkLayers[cx] = [];\r\n\r\n            // Assign into 2D grid\r\n            this.chunks[cx][cy] = worldChunk;\r\n            this.chunkLayers[cx][cy] = dominantLayer;\r\n\r\n            // Render the chunk\r\n            this.renderChunk(cx, cy, worldChunk);\r\n\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Bakes and classifies chunks as regions for metadata and logic.\r\n     */\r\n    private bakeRegionsFromChunks(): void {\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const chunksX = Math.ceil(WORLD.WIDTH / chunkSize);\r\n        const chunksY = Math.ceil(WORLD.HEIGHT / chunkSize);\r\n\r\n        const visited = new Set<string>();\r\n        let regionId = 0;\r\n        this.regions = [];\r\n        const classifyRegion = (layerName: string, waterRatio: number): RegionName | null => {\r\n            if (waterRatio >= 0.9) return \"ocean\";\r\n            if (waterRatio > 0 && waterRatio < 0.9 && [\"alluvium\", \"sediment\"].includes(layerName)) return \"shore\";\r\n            if (layerName === \"colluvium\") return \"cliffs\";\r\n            if ([\"summit\"].includes(layerName)) return \"mountains\";\r\n            if ([\"soil\", \"topsoil\", \"substrate\", \"foundation\"].includes(layerName)) return \"plains\";\r\n            return null; // explicitly unclassified (handled in fill pass)\r\n        };\r\n\r\n        const chunkToRegion: (RegionName | null)[][] = Array.from({ length: chunksY }, () =>\r\n            Array.from({ length: chunksX }, () => null)\r\n        );\r\n\r\n        // === Initial region baking ===\r\n        for (let cy = 0; cy < chunksY; cy++) {\r\n            for (let cx = 0; cx < chunksX; cx++) {\r\n                const key = `${cx},${cy}`;\r\n                if (visited.has(key)) continue;\r\n\r\n                const layer = this.getChunkLayer(cx, cy);\r\n                if (!layer) continue;\r\n\r\n                // Flood-fill contiguous same-layer chunks\r\n                const regionChunks: { cx: number; cy: number }[] = [];\r\n                const queue = [{ cx, cy }];\r\n\r\n                while (queue.length > 0) {\r\n                    const { cx: qx, cy: qy } = queue.shift()!;\r\n                    const qKey = `${qx},${qy}`;\r\n                    if (visited.has(qKey)) continue;\r\n                    visited.add(qKey);\r\n\r\n                    const currentLayer = this.getChunkLayer(qx, qy);\r\n                    if (!currentLayer || currentLayer.name !== layer.name) continue;\r\n\r\n                    regionChunks.push({ cx: qx, cy: qy });\r\n\r\n                    const neighbors = [\r\n                        { cx: qx - 1, cy: qy },\r\n                        { cx: qx + 1, cy: qy },\r\n                        { cx: qx, cy: qy - 1 },\r\n                        { cx: qx, cy: qy + 1 }\r\n                    ];\r\n\r\n                    for (const n of neighbors) {\r\n                        if (\r\n                            n.cx >= 0 &&\r\n                            n.cx < chunksX &&\r\n                            n.cy >= 0 &&\r\n                            n.cy < chunksY &&\r\n                            !visited.has(`${n.cx},${n.cy}`)\r\n                        ) {\r\n                            queue.push(n);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                if (regionChunks.length <= 5) continue;\r\n\r\n                // Compute average water ratio\r\n                let totalWater = 0;\r\n                let totalPixels = 0;\r\n                for (const { cx: rcx, cy: rcy } of regionChunks) {\r\n                    const chunk = this.chunks[rcx]?.[rcy];\r\n                    if (!chunk) continue;\r\n\r\n                    for (let y = 0; y < chunkSize; y++) {\r\n                        for (let x = 0; x < chunkSize; x++) {\r\n                            totalWater += chunk.getWaterAt(x, y, chunkSize) > 0 ? 1 : 0;\r\n                            totalPixels++;\r\n                        }\r\n                    }\r\n                }\r\n                const waterRatio = totalPixels > 0 ? totalWater / totalPixels : 0;\r\n\r\n                const regionName = classifyRegion(layer.name, waterRatio);\r\n                if (!regionName) continue; // unclassified  will be fixed later\r\n\r\n                const minX = Math.min(...regionChunks.map(c => c.cx));\r\n                const maxX = Math.max(...regionChunks.map(c => c.cx));\r\n                const minY = Math.min(...regionChunks.map(c => c.cy));\r\n                const maxY = Math.max(...regionChunks.map(c => c.cy));\r\n\r\n                this.regions.push({\r\n                    id: regionId++,\r\n                    name: regionName,\r\n                    layerName: layer.name,\r\n                    bounds: { minX, minY, maxX, maxY },\r\n                    chunkCoords: regionChunks,\r\n                    area: regionChunks.length\r\n                });\r\n\r\n                // Store in map\r\n                for (const c of regionChunks) chunkToRegion[c.cy][c.cx] = regionName;\r\n            }\r\n        }\r\n\r\n        // === FINAL FILL PASS ===\r\n        for (let cy = 0; cy < chunksY; cy++) {\r\n            for (let cx = 0; cx < chunksX; cx++) {\r\n                if (chunkToRegion[cy][cx] !== null) continue;\r\n\r\n                // Find nearest classified chunk (simple expanding radius search)\r\n                let nearest: RegionName | null = null;\r\n                let radius = 1;\r\n                while (!nearest && radius < Math.max(chunksX, chunksY)) {\r\n                    for (let dy = -radius; dy <= radius; dy++) {\r\n                        for (let dx = -radius; dx <= radius; dx++) {\r\n                            const nx = cx + dx;\r\n                            const ny = cy + dy;\r\n                            if (\r\n                                nx < 0 ||\r\n                                ny < 0 ||\r\n                                nx >= chunksX ||\r\n                                ny >= chunksY\r\n                            )\r\n                                continue;\r\n\r\n                            const candidate = chunkToRegion[ny][nx];\r\n                            if (candidate) {\r\n                                nearest = candidate;\r\n                                break;\r\n                            }\r\n                        }\r\n                        if (nearest) break;\r\n                    }\r\n                    radius++;\r\n                }\r\n\r\n                if (nearest) chunkToRegion[cy][cx] = nearest;\r\n                else chunkToRegion[cy][cx] = \"plains\"; // never happens in practice\r\n            }\r\n        }\r\n\r\n        // === Rebuild regions from final map ===\r\n        this.regions = [];\r\n        visited.clear();\r\n        regionId = 0;\r\n\r\n        for (let cy = 0; cy < chunksY; cy++) {\r\n            for (let cx = 0; cx < chunksX; cx++) {\r\n                const assigned = chunkToRegion[cy][cx];\r\n                if (!assigned || visited.has(`${cx},${cy}`)) continue;\r\n\r\n                // Flood-fill new merged regions\r\n                const regionChunks: { cx: number; cy: number }[] = [];\r\n                const queue = [{ cx, cy }];\r\n                while (queue.length > 0) {\r\n                    const { cx: qx, cy: qy } = queue.shift()!;\r\n                    const key = `${qx},${qy}`;\r\n                    if (visited.has(key)) continue;\r\n                    if (chunkToRegion[qy][qx] !== assigned) continue;\r\n                    visited.add(key);\r\n                    regionChunks.push({ cx: qx, cy: qy });\r\n\r\n                    const neighbors = [\r\n                        { cx: qx - 1, cy: qy },\r\n                        { cx: qx + 1, cy: qy },\r\n                        { cx: qx, cy: qy - 1 },\r\n                        { cx: qx, cy: qy + 1 }\r\n                    ];\r\n                    for (const n of neighbors) {\r\n                        if (\r\n                            n.cx >= 0 &&\r\n                            n.cx < chunksX &&\r\n                            n.cy >= 0 &&\r\n                            n.cy < chunksY &&\r\n                            !visited.has(`${n.cx},${n.cy}`)\r\n                        ) {\r\n                            queue.push(n);\r\n                        }\r\n                    }\r\n                }\r\n\r\n                const minX = Math.min(...regionChunks.map(c => c.cx));\r\n                const maxX = Math.max(...regionChunks.map(c => c.cx));\r\n                const minY = Math.min(...regionChunks.map(c => c.cy));\r\n                const maxY = Math.max(...regionChunks.map(c => c.cy));\r\n\r\n                this.regions.push({\r\n                    id: regionId++,\r\n                    name: assigned,\r\n                    layerName: assigned,\r\n                    bounds: { minX, minY, maxX, maxY },\r\n                    chunkCoords: regionChunks,\r\n                    area: regionChunks.length\r\n                });\r\n            }\r\n        }\r\n\r\n        console.log(` Regions baked + filled: ${this.regions.length}`);\r\n        this.regions.forEach(r => {\r\n            const w = (r.bounds.maxX - r.bounds.minX + 1) * chunkSize;\r\n            const h = (r.bounds.maxY - r.bounds.minY + 1) * chunkSize;\r\n            console.log(\r\n                `   ${r.name.padEnd(10)} | ${String(r.area).padStart(3)} chunks | ${w}${h}px`\r\n            );\r\n        });\r\n\r\n        this.generateAudioZones();\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Rendering ]\r\n    //\r\n    /**\r\n     * Renders the world to the world canvas within the camera bounds.\r\n     */\r\n    public drawWorld(): void {\r\n        if (!this.ui.ctx || !this.ui.worldCanvas || !this.ui.liquidCanvas || !this.isGenerated) return;\r\n\r\n        const cam = this.camera.pos;\r\n\r\n        this.ui.ctx.drawImage(\r\n            this.ui.worldCanvas,\r\n            cam.x, cam.y,\r\n            VIEWPORT.WIDTH, VIEWPORT.HEIGHT,\r\n            0, 0,\r\n            VIEWPORT.WIDTH, VIEWPORT.HEIGHT\r\n        );\r\n\r\n        this.ui.ctx.drawImage(\r\n            this.ui.liquidCanvas,\r\n            cam.x, cam.y,\r\n            VIEWPORT.WIDTH, VIEWPORT.HEIGHT,\r\n            0, 0,\r\n            VIEWPORT.WIDTH, VIEWPORT.HEIGHT\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Renders a single chunk onto the world canvas.\r\n     * \r\n     * For each pixel in this chunk:\r\n     * - get its base material color\r\n     * - apply noise using detailNoiseScale\r\n     * - draw it to the world canvas at its world position\r\n     */\r\n    public renderChunk(cx: number, cy: number, chunk: WorldChunk): void {\r\n        if (!this.ui.worldCtx) return;\r\n\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const startX = cx * chunkSize, startY = cy * chunkSize;\r\n\r\n        for (let y = 0; y < chunkSize; y++) {\r\n            for (let x = 0; x < chunkSize; x++) {\r\n                const worldX = startX + x, worldY = startY + y;\r\n                if (worldX >= WORLD.WIDTH || worldY >= WORLD.HEIGHT) continue;\r\n\r\n                const baseColor = chunk.getColorAt(x, y, chunkSize);\r\n                const detailNoise = this.utility.getNoise( // Sample noise to slightly vary brightness/saturation\r\n                    this.worldConfig.worldgenParams.material.detail.noiseType,\r\n                    worldX * this.worldConfig.worldgenParams.material.detail.scale,\r\n                    worldY * this.worldConfig.worldgenParams.material.detail.scale,\r\n                    this.currentSeed + 3000,\r\n                    {\r\n                        octaves: this.worldConfig.worldgenParams.terrain.octaves,\r\n                        persistence: this.worldConfig.worldgenParams.terrain.persistence\r\n                    }\r\n                );\r\n                const finalColor = this.adjustPixelColor(baseColor, detailNoise);\r\n\r\n                this.ui.worldCtx.fillStyle = finalColor;\r\n                this.ui.worldCtx.fillRect(worldX, worldY, 1, 1);\r\n            }\r\n        }\r\n\r\n        this.renderWater(cx, cy, chunk);\r\n    }\r\n\r\n    /**\r\n     * Renders water with the render.water params.\r\n     * \r\n     * Uses getHeightAt and getWaterAt to create pixel perfect water render.\r\n     */\r\n    private renderWater(cx: number, cy: number, chunk: WorldChunk): void {\r\n        if (!this.ui.liquidCtx) return;\r\n\r\n        const ctx = this.ui.liquidCtx;\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const startX = cx * chunkSize;\r\n        const startY = cy * chunkSize;\r\n        const seaLevel = this.worldConfig.worldgenParams.terrain.seaLevel;\r\n\r\n        const w = this.worldConfig.worldgenParams.render.water; // hydration config reference\r\n        const waterMat = this.worldConfig.materialsList[this.worldConfig.materialIndex.water];\r\n        const palette = waterMat.colors;\r\n\r\n        const seed = this.currentSeed + 9100;\r\n        const noiseScale = w.noiseScale;\r\n        const foamScale = w.foamScale;\r\n        const shoreBlend = w.shoreBlend;\r\n\r\n        for (let y = 0; y < chunkSize; y++) {\r\n            for (let x = 0; x < chunkSize; x++) {\r\n                const worldX = startX + x;\r\n                const worldY = startY + y;\r\n                if (worldX >= WORLD.WIDTH || worldY >= WORLD.HEIGHT) continue;\r\n\r\n                const height = chunk.getHeightAt(x, y, chunkSize);\r\n                const waterLevel = chunk.getWaterAt(x, y, chunkSize);\r\n\r\n                if (waterLevel <= 0) continue;\r\n\r\n                const depth = seaLevel - height;\r\n                const depthRatio = Math.max(0, Math.min(1, depth / seaLevel));\r\n\r\n                // flip logic: shallow = bright, deep = dark\r\n                const baseIdx = Math.floor((1 - depthRatio) * (palette.length - 1));\r\n                const baseColor = palette[baseIdx];\r\n                const r = parseInt(baseColor.slice(1, 3), 16);\r\n                const g = parseInt(baseColor.slice(3, 5), 16);\r\n                const b = parseInt(baseColor.slice(5, 7), 16);\r\n\r\n                // wave shimmer\r\n                const waveNoise = this.utility.getNoise(\r\n                    NoiseType.Perlin,\r\n                    worldX * noiseScale,\r\n                    worldY * noiseScale,\r\n                    seed,\r\n                    { octaves: 4, persistence: 0.55 }\r\n                );\r\n\r\n                // ridge pattern for foam + wave edges\r\n                const ridge = this.utility.getNoise(\r\n                    NoiseType.Ridged,\r\n                    worldX * foamScale,\r\n                    worldY * foamScale,\r\n                    seed + 3000,\r\n                    { octaves: 2, persistence: 0.5 }\r\n                );\r\n\r\n                // shoreline foam  invert so it appears near land\r\n                let foam = 0;\r\n                if (height > seaLevel - shoreBlend) {\r\n                    const t = (seaLevel - height) / shoreBlend;\r\n                    foam = this.utility.smoothstep(1 - Math.max(0, Math.min(1, t))) * ridge * w.foamIntensity;\r\n                }\r\n\r\n                // depth-based shading (dark in deep)\r\n                const darkness = 1 - (depthRatio * w.depthDarkness);\r\n                const shade = (0.5 + (1 - depthRatio) * 0.5 + waveNoise * w.shimmerStrength) * darkness;\r\n                const scatter = 0.25 + waveNoise * 0.25;\r\n\r\n                const dr = Math.max(0, Math.min(255, r * shade + 200 * foam + 30 * scatter));\r\n                const dg = Math.max(0, Math.min(255, g * shade + 220 * foam + 50 * scatter));\r\n                const db = Math.max(0, Math.min(255, b * shade + 255 * foam + 60 * scatter));\r\n\r\n                // opacity from config\r\n                const alpha = Math.min(1, w.opacityBase + depthRatio * w.opacityMultiplier);\r\n\r\n                ctx.fillStyle = `rgba(${dr},${dg},${db},${alpha})`;\r\n                ctx.fillRect(worldX, worldY, 1, 1);\r\n            }\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Changes a pixel's color based on noise.\r\n     * \r\n     * Uses the colorVariation from the config to adjust the brightness.\r\n     */\r\n    private adjustPixelColor(hexColor: string, noise: number): string {\r\n        const variation = this.worldConfig.worldgenParams.material.colorVariation;\r\n\r\n        // Brightness multiplier:\r\n        // noise = 0.5 => factor ~1.0 (no change)\r\n        // noise < 0.5 => darker\r\n        // noise > 0.5 => brighter\r\n        const factor = 1 + (noise - 0.5) * variation;\r\n\r\n        const r = parseInt(hexColor.slice(1, 3), 16);\r\n        const g = parseInt(hexColor.slice(3, 5), 16);\r\n        const b = parseInt(hexColor.slice(5, 7), 16);\r\n\r\n        const nr = Math.max(0, Math.min(255, Math.floor(r * factor)));\r\n        const ng = Math.max(0, Math.min(255, Math.floor(g * factor)));\r\n        const nb = Math.max(0, Math.min(255, Math.floor(b * factor)));\r\n\r\n        return `#${nr.toString(16).padStart(2, '0')}${ng.toString(16).padStart(2, '0')}${nb.toString(16).padStart(2, '0')}`;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Runtime Helpers ]\r\n    //\r\n    /**\r\n     * Gets the material property of a pixel at runtime.\r\n     */\r\n    public getMaterialAt(x: number, y: number): Material | null {\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const cx = Math.floor(x / chunkSize), cy = Math.floor(y / chunkSize);\r\n\r\n        const chunk = this.chunks[cx]?.[cy];\r\n        if (!chunk) return null;\r\n\r\n        const localX = x - cx * chunkSize;\r\n        const localY = y - cy * chunkSize;\r\n        const idx = localY * chunkSize + localX;\r\n        const combined = chunk.pixelData[idx];\r\n        const materialIndex = combined >> 2;\r\n\r\n        return this.worldConfig.materialsList[materialIndex] || null;\r\n    }\r\n\r\n    /**\r\n     * Gets the height of a specific pixel at coordinates.\r\n     */\r\n    public getHeightAt(x: number, y: number): number | null {\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const cx = Math.floor(x / chunkSize), cy = Math.floor(y / chunkSize);\r\n\r\n        const chunk = this.chunks[cx]?.[cy];\r\n        if (!chunk) return null;\r\n\r\n        if (!chunk) return null;\r\n\r\n        const localX = x - cx * chunkSize;\r\n        const localY = y - cy * chunkSize;\r\n\r\n        return chunk.getHeightAt(localX, localY, chunkSize);\r\n    }\r\n\r\n    /**\r\n     * Gets the physics properties of a pixel.\r\n     */\r\n    public getPhysicsAt(x: number, y: number, material?: Material | null) {\r\n        const mat = material ?? this.getMaterialAt(x, y);\r\n        return mat ? mat.physics : null;\r\n    }\r\n\r\n    /**\r\n     * Gets the stored or calculated primary layer for a chunk.\r\n     */\r\n    public getChunkLayer(cx: number, cy: number): WorldLayer | null {\r\n        return this.chunkLayers[cx]?.[cy] || null;\r\n    }\r\n\r\n    /**\r\n     * Calculates the world and chunk coordinates based on the mouse position from ControlsManager.\r\n     */\r\n    public updateHoveredChunk(): { worldX: number; worldY: number } | null {\r\n        const mousePos = this.controlsManager.getMousePos();\r\n        const worldX = mousePos.x + this.camera.pos.x;\r\n        const worldY = mousePos.y + this.camera.pos.y;\r\n\r\n        if (worldX < 0 || worldX >= WORLD.WIDTH || worldY < 0 || worldY >= WORLD.HEIGHT) {\r\n            this.worldDebug.hoveredChunk = null;\r\n            return null;\r\n        }\r\n\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const cx = Math.floor(worldX / chunkSize);\r\n        const cy = Math.floor(worldY / chunkSize);\r\n        this.worldDebug.hoveredChunk = { cx, cy };\r\n\r\n        return { worldX, worldY };\r\n    }\r\n\r\n    /**\r\n     * Determines the total steps needed for a full load based on the amount of chunks and the worldgen phases.\r\n     * \r\n     * This is purely a loading helper.\r\n     */\r\n    private totalYieldSteps(): number {\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n\r\n        const chunksX = Math.ceil(WORLD.WIDTH / chunkSize);\r\n        const chunksY = Math.ceil(WORLD.HEIGHT / chunkSize);\r\n        const totalChunks = chunksX * chunksY;\r\n\r\n        const bakedChunks = Math.floor(totalChunks * 0.5);\r\n\r\n        return (this.YIELD_RATE * this.WORLDGEN_PHASES.length) + bakedChunks;\r\n    }\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Menus ]\r\n    //\r\n    /**\r\n     * Builds and displays the worldgen menu.\r\n     */\r\n    private async worldgenMenu(): Promise<{ mode: \"generate\" | \"load\", file?: File }> {\r\n        return new Promise(resolve => {\r\n            const container = document.createElement(\"div\");\r\n            container.className = \"config_popup_container\";\r\n\r\n            const header = document.createElement(\"h3\");\r\n            header.textContent = 'World Generation Config';\r\n\r\n            const popup = document.createElement(\"div\");\r\n            popup.className = \"config_popup\";\r\n\r\n            const form = document.createElement(\"form\");\r\n\r\n            // Helper to create noise type dropdown\r\n            const noiseTypeOptions = Object.values(NoiseType).map(type =>\r\n                `<option value=\"${type}\" ${this.worldConfig.worldgenParams.terrain.noiseType === type ? 'selected' : ''}>${type.charAt(0).toUpperCase() + type.slice(1)}</option>`\r\n            ).join('');\r\n\r\n            form.innerHTML = `\r\n            <!-- GENERAL -->\r\n            <fieldset id=\"generalFieldset\">\r\n                <legend>General</legend>\r\n                <div class=\"form_grid\">\r\n                    <label id=\"seedLabel\">\r\n                        <span>Seed:</span>\r\n                        <input type=\"text\" name=\"general.seed\" placeholder=\"enter seed or leave blank...\">\r\n                    </label>\r\n                    <div id=\"generalFormDiv\">\r\n                        <label>\r\n                            <span>Chunk Size (px):</span>\r\n                            <input type=\"number\" name=\"general.chunk.size\" value=\"${this.worldConfig.worldgenParams.general.chunk.size}\" min=\"1\" step=\"1\">\r\n                        </label>\r\n                        <label>\r\n                            <span>Cell Size (px):</span>\r\n                            <input type=\"number\" name=\"general.cell.size\" value=\"${this.worldConfig.worldgenParams.general.cell.size}\" min=\"1\" step=\"1\">\r\n                        </label>\r\n                    </div>\r\n                </div>\r\n            </fieldset>\r\n\r\n            <!-- TERRAIN -->\r\n            <fieldset id=\"terrainFieldset\">\r\n                <legend>Terrain</legend>\r\n                <div class=\"form_grid\">\r\n                    <label>\r\n                        <span>Noise Type:</span>\r\n                        <select name=\"terrain.noiseType\">${noiseTypeOptions}</select>\r\n                    </label>\r\n                    <label>\r\n                        <span>Scale:</span>\r\n                        <input type=\"number\" name=\"terrain.scale\" value=\"${this.worldConfig.worldgenParams.terrain.scale}\" step=\"any\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Intensity:</span>\r\n                        <input type=\"number\" name=\"terrain.intensity\" value=\"${this.worldConfig.worldgenParams.terrain.intensity}\" step=\"any\" min=\"0\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Octaves:</span>\r\n                        <input type=\"number\" name=\"terrain.octaves\" value=\"${this.worldConfig.worldgenParams.terrain.octaves}\" min=\"1\" max=\"12\" step=\"1\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Persistence:</span>\r\n                        <input type=\"number\" name=\"terrain.persistence\" value=\"${this.worldConfig.worldgenParams.terrain.persistence}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Height Curve:</span>\r\n                        <input type=\"number\" name=\"terrain.heightCurve\" value=\"${this.worldConfig.worldgenParams.terrain.heightCurve}\" step=\"any\" min=\"0.1\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Sea Level:</span>\r\n                        <input type=\"number\" name=\"terrain.seaLevel\" value=\"${this.worldConfig.worldgenParams.terrain.seaLevel}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Lowest Depth:</span>\r\n                        <input type=\"number\" name=\"terrain.lowestDepth\" value=\"${this.worldConfig.worldgenParams.terrain.lowestDepth}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                </div>\r\n            </fieldset>\r\n\r\n            <!-- MATERIALS -->\r\n            <fieldset id=\"materialsFieldset\">\r\n                <legend>Materials</legend>\r\n                <div class=\"form_grid\">\r\n                    <label>\r\n                        <span>Noise Type:</span>\r\n                        <select name=\"material.noiseType\">${noiseTypeOptions}</select>\r\n                    </label>\r\n                    <label>\r\n                        <span>Scale:</span>\r\n                        <input type=\"number\" name=\"material.scale\" value=\"${this.worldConfig.worldgenParams.material.scale}\" step=\"any\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Color Variation:</span>\r\n                        <input type=\"number\" name=\"material.colorVariation\" value=\"${this.worldConfig.worldgenParams.material.colorVariation}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                </div>\r\n                <div class=\"form_grid form_grid_detail\">\r\n                <h4>Detail</h4>\r\n                    <label>\r\n                        <span>Noise Type:</span>\r\n                        <select name=\"material.detail.noiseType\">${noiseTypeOptions}</select>\r\n                    </label>\r\n                    <label>\r\n                        <span>Scale:</span>\r\n                        <input type=\"number\" name=\"material.detail.scale\" value=\"${this.worldConfig.worldgenParams.material.detail.scale}\" step=\"any\">\r\n                    </label>\r\n                </div>\r\n            </fieldset>\r\n\r\n            <!-- DEGENERATION -->\r\n            <fieldset id=\"degenerationFieldset\">\r\n                <legend>Degeneration</legend>\r\n                <div class=\"form_grid\">\r\n                    <label>\r\n                        <span>Noise Type:</span>\r\n                        <select name=\"degen.noiseType\">${noiseTypeOptions}</select>\r\n                    </label>\r\n                    <label>\r\n                        <span>Scale:</span>\r\n                        <input type=\"number\" name=\"degen.scale\" value=\"${this.worldConfig.worldgenParams.degen.scale}\" step=\"any\" min=\"0\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Intensity:</span>\r\n                        <input type=\"number\" name=\"degen.intensity\" value=\"${this.worldConfig.worldgenParams.degen.intensity}\" step=\"any\" min=\"0\" max=\"2\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Min Height:</span>\r\n                        <input type=\"number\" name=\"degen.minHeight\" value=\"${this.worldConfig.worldgenParams.degen.minHeight}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Threshold:</span>\r\n                        <input type=\"number\" name=\"degen.threshold\" value=\"${this.worldConfig.worldgenParams.degen.threshold}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Hardness:</span>\r\n                        <input type=\"number\" name=\"degen.hardness\" value=\"${this.worldConfig.worldgenParams.degen.hardness}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                </div>\r\n                <div class=\"form_grid form_grid_detail\">\r\n                <h4>Detail</h4>\r\n                    <label>\r\n                        <span>Noise Type:</span>\r\n                        <select name=\"degen.detail.noiseType\">${noiseTypeOptions}</select>\r\n                    </label>\r\n                    <label>\r\n                        <span>Scale:</span>\r\n                        <input type=\"number\" name=\"degen.detail.scale\" value=\"${this.worldConfig.worldgenParams.degen.detail.scale}\" step=\"any\" min=\"0\">\r\n                    </label>\r\n                </div>\r\n            </fieldset>\r\n\r\n            <!-- HYDRATION\r\n            <fieldset id=\"hydrationFieldset\">\r\n                <legend>Hydration</legend>\r\n                <div class=\"form_grid\">\r\n                    <label>\r\n                        <span>Noise Type:</span>\r\n                        <select name=\"hydration.noiseType\">${noiseTypeOptions}</select>\r\n                    </label>\r\n                    <label>\r\n                        <span>Scale:</span>\r\n                        <input type=\"number\" name=\"hydration.scale\" value=\"${this.worldConfig.worldgenParams.hydration.scale}\" step=\"any\" min=\"0\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Intensity:</span>\r\n                        <input type=\"number\" name=\"hydration.intensity\" value=\"${this.worldConfig.worldgenParams.hydration.intensity}\" step=\"any\" min=\"0\" max=\"5\">\r\n                    </label>\r\n                    <label>\r\n                        <span>Multiplier:</span>\r\n                        <input type=\"number\" name=\"hydration.multiplier\" value=\"${this.worldConfig.worldgenParams.hydration.multiplier}\" step=\"any\" min=\"0\" max=\"10\">\r\n                    </label>\r\n                </div>\r\n            </fieldset> -->\r\n\r\n            <div class=\"form_submit\">\r\n                <button type=\"submit\">Generate (Enter)</button>\r\n                <input id=\"loadWorldInput\" type=\"file\" accept=\".json\" style=\"display:none\">\r\n                <button type=\"button\" id=\"loadWorldButton\">Load Saved World</button>\r\n            </div>\r\n            `;\r\n\r\n            const loadButton = form.querySelector(\"#loadWorldButton\") as HTMLButtonElement;\r\n            const fileInput = form.querySelector(\"#loadWorldInput\") as HTMLInputElement;\r\n\r\n            loadButton.onclick = () => fileInput.click();\r\n\r\n            fileInput.onchange = async (e) => {\r\n                const file = (e.target as HTMLInputElement).files?.[0];\r\n                if (!file) return;\r\n                document.body.removeChild(container);\r\n                resolve({ mode: \"load\", file });\r\n            };\r\n\r\n            form.onsubmit = e => {\r\n                e.preventDefault();\r\n                const fd = new FormData(form);\r\n\r\n                const num = (key: string) => parseFloat(fd.get(key) as string);\r\n                const int = (key: string) => parseInt(fd.get(key) as string);\r\n\r\n                // --- General ---\r\n                this.worldConfig.worldgenParams.general.chunk.size = int(\"general.chunk.size\");\r\n                this.worldConfig.worldgenParams.general.cell.size = int(\"general.cell.size\");\r\n                this.worldConfig.worldgenParams.general.seed = int(\"general.seed\");\r\n\r\n                // --- Terrain ---\r\n                this.worldConfig.worldgenParams.terrain.noiseType = fd.get(\"terrain.noiseType\") as NoiseType;\r\n                this.worldConfig.worldgenParams.terrain.scale = num(\"terrain.scale\");\r\n                this.worldConfig.worldgenParams.terrain.intensity = num(\"terrain.intensity\");\r\n                this.worldConfig.worldgenParams.terrain.octaves = int(\"terrain.octaves\");\r\n                this.worldConfig.worldgenParams.terrain.persistence = num(\"terrain.persistence\");\r\n                this.worldConfig.worldgenParams.terrain.heightCurve = num(\"terrain.heightCurve\");\r\n                this.worldConfig.worldgenParams.terrain.seaLevel = num(\"terrain.seaLevel\");\r\n                this.worldConfig.worldgenParams.terrain.lowestDepth = num(\"terrain.lowestDepth\");\r\n\r\n                // --- Materials ---\r\n                this.worldConfig.worldgenParams.material.noiseType = fd.get(\"material.noiseType\") as NoiseType;\r\n                this.worldConfig.worldgenParams.material.scale = num(\"material.scale\");\r\n                this.worldConfig.worldgenParams.material.colorVariation = num(\"material.colorVariation\");\r\n                this.worldConfig.worldgenParams.material.detail.noiseType = fd.get(\"material.detail.noiseType\") as NoiseType;\r\n                this.worldConfig.worldgenParams.material.detail.scale = num(\"material.detail.scale\");\r\n\r\n                // --- Degeneration ---\r\n                this.worldConfig.worldgenParams.degen.noiseType = fd.get(\"degen.noiseType\") as NoiseType;\r\n                this.worldConfig.worldgenParams.degen.scale = num(\"degen.scale\");\r\n                this.worldConfig.worldgenParams.degen.intensity = num(\"degen.intensity\");\r\n                this.worldConfig.worldgenParams.degen.minHeight = num(\"degen.minHeight\");\r\n                this.worldConfig.worldgenParams.degen.threshold = num(\"degen.threshold\");\r\n                this.worldConfig.worldgenParams.degen.hardness = num(\"degen.hardness\");\r\n                this.worldConfig.worldgenParams.degen.detail.noiseType = fd.get(\"degen.detail.noiseType\") as NoiseType;\r\n                this.worldConfig.worldgenParams.degen.detail.scale = num(\"degen.detail.scale\");\r\n\r\n                // --- Hydration ---\r\n                // this.worldConfig.worldgenParams.hydration.noiseType = fd.get(\"hydration.noiseType\") as NoiseType;\r\n                // this.worldConfig.worldgenParams.hydration.scale = num(\"hydration.scale\");\r\n                // this.worldConfig.worldgenParams.hydration.intensity = num(\"hydration.intensity\");\r\n                // this.worldConfig.worldgenParams.hydration.multiplier = num(\"hydration.multiplier\");\r\n\r\n                document.body.removeChild(container);\r\n                resolve({ mode: \"generate\" });\r\n            };\r\n\r\n            popup.appendChild(form);\r\n            container.appendChild(header);\r\n            container.appendChild(popup);\r\n            document.body.appendChild(container);\r\n            (form.querySelector(\"input\") as HTMLInputElement)?.focus();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Builds and displays the rendering menu.\r\n     */\r\n    public async renderMenu(): Promise<void> {\r\n        return new Promise(resolve => {\r\n            const popup = document.createElement(\"div\");\r\n            popup.className = \"config_popup\";\r\n            const form = document.createElement(\"form\");\r\n\r\n            const w = this.worldConfig.worldgenParams.render.water;\r\n\r\n            form.innerHTML = `\r\n            <h3>Render Config</h3>\r\n\r\n            <fieldset>\r\n                <legend>Water Rendering</legend>\r\n                <div class=\"form_grid\">\r\n                    <label><span>Base Opacity:</span>\r\n                        <input type=\"number\" name=\"opacityBase\" value=\"${w.opacityBase}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                    <label><span>Opacity Multiplier:</span>\r\n                        <input type=\"number\" name=\"opacityMultiplier\" value=\"${w.opacityMultiplier}\" step=\"any\" min=\"0\" max=\"2\">\r\n                    </label>\r\n                    <label><span>Foam Intensity:</span>\r\n                        <input type=\"number\" name=\"foamIntensity\" value=\"${w.foamIntensity}\" step=\"any\" min=\"0\" max=\"2\">\r\n                    </label>\r\n                    <label><span>Foam Scale:</span>\r\n                        <input type=\"number\" name=\"foamScale\" value=\"${w.foamScale}\" step=\"any\" min=\"0\">\r\n                    </label>\r\n                    <label><span>Noise Scale:</span>\r\n                        <input type=\"number\" name=\"noiseScale\" value=\"${w.noiseScale}\" step=\"any\" min=\"0\">\r\n                    </label>\r\n                    <label><span>Shore Blend:</span>\r\n                        <input type=\"number\" name=\"shoreBlend\" value=\"${w.shoreBlend}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                    <label><span>Shimmer Strength:</span>\r\n                        <input type=\"number\" name=\"shimmerStrength\" value=\"${w.shimmerStrength}\" step=\"any\" min=\"0\" max=\"1\">\r\n                    </label>\r\n                    <label><span>Depth Darkness:</span>\r\n                        <input type=\"number\" name=\"depthDarkness\" value=\"${w.depthDarkness}\" step=\"any\" min=\"0\" max=\"2\">\r\n                    </label>\r\n                </div>\r\n            </fieldset>\r\n\r\n            <div class=\"form_submit\">\r\n                <button type=\"submit\">Apply (Enter)</button>\r\n            </div>\r\n            `;\r\n\r\n            form.onsubmit = e => {\r\n                e.preventDefault();\r\n                const fd = new FormData(form);\r\n                const num = (key: string) => parseFloat(fd.get(key) as string);\r\n\r\n                // Update render params directly\r\n                w.opacityBase = num(\"opacityBase\");\r\n                w.opacityMultiplier = num(\"opacityMultiplier\");\r\n                w.foamIntensity = num(\"foamIntensity\");\r\n                w.foamScale = num(\"foamScale\");\r\n                w.noiseScale = num(\"noiseScale\");\r\n                w.shoreBlend = num(\"shoreBlend\");\r\n                w.shimmerStrength = num(\"shimmerStrength\");\r\n                w.depthDarkness = num(\"depthDarkness\");\r\n\r\n                //  FULL RE-RENDER ONLY\r\n                console.log(\" Re-rendering world (no regeneration)...\");\r\n\r\n                if (this.ui.worldCtx) {\r\n                    this.ui.worldCtx.clearRect(0, 0, WORLD.WIDTH, WORLD.HEIGHT);\r\n                }\r\n\r\n                for (let cx = 0; cx < this.chunks.length; cx++) {\r\n                    const col = this.chunks[cx];\r\n                    if (!col) continue;\r\n\r\n                    for (let cy = 0; cy < col.length; cy++) {\r\n                        const chunk = col[cy];\r\n                        if (!chunk) continue;\r\n\r\n                        this.renderChunk(cx, cy, chunk);\r\n                    }\r\n                }\r\n\r\n                document.body.removeChild(popup);\r\n                resolve();\r\n            };\r\n\r\n            popup.appendChild(form);\r\n            document.body.appendChild(popup);\r\n            (form.querySelector(\"input\") as HTMLInputElement)?.focus();\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Shows the loading menu during worldgen process.\r\n     */\r\n    public showLoadingMenu(): void {\r\n        const existing = document.getElementById(\"worldLoadingMenu\");\r\n        if (existing) existing.remove(); // Remove old if exists\r\n\r\n        const menu = document.createElement(\"div\");\r\n        menu.id = \"worldLoadingMenu\";\r\n        menu.innerHTML = `\r\n        <div class=\"loading_wrapper\">\r\n            <span id=\"loadingMessage\">Initializing world...</span>\r\n            <div class=\"loading_bar\">\r\n                <div id=\"loadingBarFill\"></div>\r\n            </div>\r\n        </div>\r\n        `;\r\n\r\n        document.body.appendChild(menu);\r\n    }\r\n\r\n    /**\r\n     * Hides the loading menu once the worldgen process is completed.\r\n     */\r\n    private hideLoadingMenu(): void {\r\n        const loadingMenu = document.getElementById(\"worldLoadingMenu\");\r\n        if (!loadingMenu) return;\r\n\r\n        loadingMenu.style.opacity = \"0\"; // fade-out (optional)\r\n        setTimeout(() => loadingMenu.remove(), 300); // remove after fade\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Chunk Management ]\r\n    //\r\n    /**\r\n     * Processes all chunk updates. Optionally patches a chunk to reflect the newest partial update.\r\n     */\r\n    public handleChunkUpdate(remoteChunk: NetworkChunk): void {\r\n        if (!remoteChunk || !remoteChunk.pos) return;\r\n\r\n        if ((remoteChunk as any).patches) {\r\n            this.handleChunkPatch(remoteChunk);\r\n            return;\r\n        }\r\n\r\n        const cx = remoteChunk.pos.x;\r\n        const cy = remoteChunk.pos.y;\r\n\r\n        const existing = this.chunks[cx]?.[cy];\r\n\r\n        // Only update if it's new or newer\r\n        if (existing && (remoteChunk.version ?? 0) <= existing.version) return;\r\n\r\n        // Convert NetworkChunk  WorldChunk\r\n        const newChunk = new WorldChunk(\r\n            remoteChunk.layer,\r\n            remoteChunk.cellData.worldPixelData,\r\n            remoteChunk.cellData.worldHeightData,\r\n            remoteChunk.cellData.worldWaterData!,\r\n            this.worldConfig\r\n        );\r\n\r\n        newChunk.version = remoteChunk.version;\r\n        newChunk.pos = remoteChunk.pos;\r\n        newChunk.size = remoteChunk.size;\r\n\r\n        if (!this.chunks[cx]) this.chunks[cx] = [];\r\n        this.chunks[cx][cy] = newChunk;\r\n\r\n        if (!this.chunkLayers[cx]) this.chunkLayers[cx] = [];\r\n\r\n        const idx = this.worldConfig.worldLayerIndex[remoteChunk.layer];\r\n\r\n        this.chunkLayers[cx][cy] =\r\n            idx !== undefined\r\n                ? this.worldConfig.worldLayerList[idx]\r\n                : this.worldConfig.worldLayerList[0];\r\n\r\n        this.renderChunk(cx, cy, newChunk);\r\n    }\r\n\r\n    /**\r\n     * Processes partial chunk updates and changes.\r\n     */\r\n    private handleChunkPatch(remoteChunk: any): void {\r\n        const cx = remoteChunk.pos.x;\r\n        const cy = remoteChunk.pos.y;\r\n\r\n        const chunk = this.chunks[cx]?.[cy];\r\n        if (!chunk || !remoteChunk.patches) return;\r\n\r\n        const ctx = this.ui.worldCtx;\r\n        if (!ctx) return;\r\n\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const startX = remoteChunk.pos.x * chunkSize;\r\n        const startY = remoteChunk.pos.y * chunkSize;\r\n\r\n        for (const patch of remoteChunk.patches) {\r\n            const i = patch.i;\r\n\r\n            // Update the pixel, height and water data\r\n            if (typeof patch.pixel !== \"undefined\") {\r\n                chunk.pixelData[i] = patch.pixel;\r\n            }\r\n            if (typeof patch.height !== \"undefined\") {\r\n                chunk.heightData[i] = patch.height;\r\n            }\r\n            if (chunk.waterData && typeof patch.water !== \"undefined\") {\r\n                chunk.waterData[i] = patch.water;\r\n            }\r\n\r\n            // Compute world-space pixel coordinates\r\n            const localX = i % chunkSize;\r\n            const localY = Math.floor(i / chunkSize);\r\n            const worldX = startX + localX;\r\n            const worldY = startY + localY;\r\n\r\n            // Draw updated pixel\r\n            const baseColor = chunk.getColorAt(localX, localY, chunkSize);\r\n            const detailNoise = this.utility.getNoise(\r\n                this.worldConfig.worldgenParams.material.detail.noiseType,\r\n                worldX * this.worldConfig.worldgenParams.material.detail.scale,\r\n                worldY * this.worldConfig.worldgenParams.material.detail.scale,\r\n                this.currentSeed + 3000,\r\n                {\r\n                    octaves: this.worldConfig.worldgenParams.terrain.octaves,\r\n                    persistence: this.worldConfig.worldgenParams.terrain.persistence\r\n                }\r\n            );\r\n            const finalColor = this.adjustPixelColor(baseColor, detailNoise);\r\n\r\n            ctx.fillStyle = finalColor;\r\n            ctx.fillRect(worldX, worldY, 1, 1);\r\n        }\r\n        // console.log(`Patched ${remoteChunk.patches.length} pixels in chunk ${key}`);\r\n    }\r\n\r\n    /**\r\n     * Immediately streams all pending chunks to the user.\r\n     * \r\n     * This can be called to dump any unloaded chunks at a maximum of 1 per frame. \r\n     */\r\n    public async dumpChunkBuffer(): Promise<void> {\r\n        console.log(\"Starting background chunk streaming...\");\r\n\r\n        for (let i = 0; i < this.chunkBuffer.length; i++) {\r\n            const entry = this.chunkBuffer[i];\r\n            if (entry.loaded) continue;\r\n\r\n            this.loadChunk(entry.cx, entry.cy);\r\n            entry.loaded = true;\r\n\r\n            await this.utility.yield(); // one chunk per frame\r\n        }\r\n\r\n        this.chunkBuffer = [];\r\n        this.worldBuffer = null;\r\n\r\n        this.bakeRegionsFromChunks();\r\n        console.log(\"All chunks loaded.\");\r\n    }\r\n\r\n    /**\r\n     * Loads a specific chunk.\r\n     */\r\n    private loadChunk(cx: number, cy: number): void {\r\n        if (!this.worldBuffer || !this.worldBuffer.cellLayerGrid || !this.worldBuffer.worldWaterData) return;\r\n\r\n        const allWorldLayers = this.worldConfig.worldLayerList;\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n        const cellSize = this.worldConfig.worldgenParams.general.cell.size;\r\n\r\n        const chunkPixels = new Uint8Array(chunkSize * chunkSize);\r\n        const chunkHeights = new Uint8Array(chunkSize * chunkSize);\r\n        const chunkWater = new Uint8Array(chunkSize * chunkSize);\r\n\r\n        // Copy pixel/height/water data from world arrays\r\n        for (let y = 0; y < chunkSize; y++) {\r\n            for (let x = 0; x < chunkSize; x++) {\r\n                const worldX = cx * chunkSize + x;\r\n                const worldY = cy * chunkSize + y;\r\n                if (worldX >= WORLD.WIDTH || worldY >= WORLD.HEIGHT) continue;\r\n\r\n                const gi = worldY * WORLD.WIDTH + worldX;\r\n                const li = y * chunkSize + x;\r\n\r\n                chunkPixels[li] = this.worldBuffer.worldPixelData[gi];\r\n                chunkHeights[li] = this.worldBuffer.worldHeightData[gi];\r\n                chunkWater[li] = this.worldBuffer.worldWaterData[gi];\r\n            }\r\n        }\r\n\r\n        const layerCounts: Record<number, number> = {};\r\n        const cellsX = Math.ceil(WORLD.WIDTH / cellSize);\r\n        const cellsY = Math.ceil(WORLD.HEIGHT / cellSize);\r\n        const startCellX = Math.floor((cx * chunkSize) / cellSize);\r\n        const endCellX = Math.floor(((cx + 1) * chunkSize - 1) / cellSize);\r\n        const startCellY = Math.floor((cy * chunkSize) / cellSize);\r\n        const endCellY = Math.floor(((cy + 1) * chunkSize - 1) / cellSize);\r\n\r\n        for (let cby = startCellY; cby <= endCellY; cby++) {\r\n            if (cby < 0 || cby >= cellsY) continue;\r\n            for (let cbx = startCellX; cbx <= endCellX; cbx++) {\r\n                if (cbx < 0 || cbx >= cellsX) continue;\r\n\r\n                const idx = this.worldBuffer.cellLayerGrid[cby][cbx];\r\n                layerCounts[idx] = (layerCounts[idx] || 0) + 1;\r\n            }\r\n        }\r\n\r\n        let dominantIdx = 0, max = -1;\r\n        for (const k in layerCounts) {\r\n            const c = layerCounts[k as any];\r\n            if (c > max) { max = c; dominantIdx = parseInt(k, 10); }\r\n        }\r\n        const dominantLayer = allWorldLayers[dominantIdx] || allWorldLayers[0];\r\n\r\n        const worldChunk = new WorldChunk(dominantLayer.name, chunkPixels, chunkHeights, chunkWater, this.worldConfig);\r\n\r\n        if (!this.chunks[cx]) this.chunks[cx] = [];\r\n        if (!this.chunkLayers[cx]) this.chunkLayers[cx] = [];\r\n\r\n        this.chunks[cx][cy] = worldChunk;\r\n        this.chunkLayers[cx][cy] = dominantLayer;\r\n\r\n        this.renderChunk(cx, cy, worldChunk);\r\n\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Audio Zones ]\r\n    //\r\n\r\n    /**\r\n     * Creates audio zones for valid regions.\r\n     */\r\n    private generateAudioZones(): void {\r\n        console.log(\"Generating audio zones...\");\r\n\r\n        this.regions.forEach(region => {\r\n            const regionAudio = this.worldConfig.regionAudioParams[region.name];\r\n            if (!regionAudio || region.area < regionAudio.minRegionSize) return;\r\n\r\n            const ambience = this.audioConfig.resources.ambience.beds[region.name];\r\n            if (!ambience || !ambience.length) return;\r\n\r\n            const audioSrc = ambience[0];\r\n            const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n\r\n            // create one shared audio source entry\r\n            this.regionAudioSources.set(region.id, { element: null, volume: 0 });\r\n\r\n            const regionWidth = (region.bounds.maxX - region.bounds.minX + 1) * chunkSize;\r\n            const regionHeight = (region.bounds.maxY - region.bounds.minY + 1) * chunkSize;\r\n\r\n            const overlapFactor = 0.9;\r\n            const effectiveCoverage = regionAudio.radius * 2 * overlapFactor;\r\n\r\n            const zonesX = Math.ceil(regionWidth / effectiveCoverage);\r\n            const zonesY = Math.ceil(regionHeight / effectiveCoverage);\r\n            const totalZones = zonesX * zonesY;\r\n            const maxZones = 10; // TODO: Calculate this more dynamically\r\n\r\n            if (totalZones > maxZones) {\r\n                console.warn(`Region ${region.name} needs ${totalZones} zones - capping at ${maxZones}.`);\r\n            }\r\n\r\n            let createdZones = 0;\r\n            for (let gy = 0; gy < zonesY; gy++) {\r\n                for (let gx = 0; gx < zonesX; gx++) {\r\n                    if (createdZones >= maxZones) break;\r\n\r\n                    const zoneX = region.bounds.minX * chunkSize + (gx + 0.5) * effectiveCoverage;\r\n                    const zoneY = region.bounds.minY * chunkSize + (gy + 0.5) * effectiveCoverage;\r\n\r\n                    const clampedX = Math.max(\r\n                        region.bounds.minX * chunkSize,\r\n                        Math.min(region.bounds.maxX * chunkSize + chunkSize, zoneX)\r\n                    );\r\n                    const clampedY = Math.max(\r\n                        region.bounds.minY * chunkSize,\r\n                        Math.min(region.bounds.maxY * chunkSize + chunkSize, zoneY)\r\n                    );\r\n\r\n                    const center: Vec2 = { x: clampedX, y: clampedY };\r\n                    const zoneId = `${region.id}_${gx}_${gy}`;\r\n\r\n                    this.audioZones.set(zoneId, {\r\n                        region: region,\r\n                        center: center,\r\n                        audioParams: {\r\n                            src: audioSrc,\r\n                            listener: this.playerState.myPlayer.transform.pos,\r\n                            loop: true,\r\n                            output: 'sfx',\r\n                            volume: regionAudio.volume,\r\n                            spatial: {\r\n                                blend: 1.0,\r\n                                pos: center,\r\n                                rolloff: {\r\n                                    distance: regionAudio.radius,\r\n                                    factor: 1.0,\r\n                                    type: 'logarithmic'\r\n                                }\r\n                            }\r\n                        },\r\n                        isActive: false\r\n                    });\r\n\r\n                    createdZones++;\r\n                }\r\n                if (createdZones >= maxZones) break;\r\n            }\r\n        });\r\n\r\n        console.log(`Generated ${this.audioZones.size} audio zones.`);\r\n    }\r\n\r\n    /**\r\n     * Processes updates for regional audio zones and controls volume based on player position.\r\n     */\r\n    public updateAudioZones(): void {\r\n        if (!this.playerState?.myPlayer) return;\r\n        const playerPos = this.playerState.myPlayer.transform.pos;\r\n\r\n        // Reset all region brain volumes\r\n        this.regionAudioSources.forEach(brain => brain.volume = 0);\r\n\r\n        // Each zone contributes its influence to its region brain\r\n        this.audioZones.forEach(zone => {\r\n            const dx = playerPos.x - zone.center.x;\r\n            const dy = playerPos.y - zone.center.y;\r\n            const distance = Math.sqrt(dx * dx + dy * dy);\r\n            const radius = zone.audioParams.spatial?.rolloff?.distance || 500;\r\n            const inRange = distance < radius;\r\n\r\n            zone.isActive = inRange;\r\n\r\n            if (inRange) {\r\n                const roll = zone.audioParams.spatial!.rolloff!;\r\n                const normalized = Math.min(1, distance / roll.distance);\r\n                const rollFactor = roll.factor > 0 ? roll.factor : 0.5;\r\n                const factor = roll.type === 'logarithmic'\r\n                    ? 1 - Math.pow(normalized, 0.5) * rollFactor\r\n                    : 1 - normalized * rollFactor;\r\n\r\n                const regionId = zone.region.id;\r\n                const brain = this.regionAudioSources.get(regionId);\r\n                if (brain) brain.volume = Math.max(brain.volume, factor);\r\n            }\r\n        });\r\n\r\n        // Manage region audio playback based on aggregate volumes\r\n        this.regionAudioSources.forEach((brain, regionId) => {\r\n            const region = this.regions.find(r => r.id === regionId);\r\n            if (!region) return;\r\n\r\n            const regionAudio = this.worldConfig.regionAudioParams[region.name];\r\n            if (!regionAudio) return;\r\n\r\n            // directly scale brain.volume into regions [min,max] range  never clamp to 1\r\n            const targetVolume = regionAudio.volume.min +\r\n                (regionAudio.volume.max - regionAudio.volume.min) * brain.volume;\r\n\r\n            if (targetVolume > regionAudio.volume.min) {\r\n                if (!brain.element) {\r\n                    const src = this.audioConfig.resources.ambience.beds[region.name][0];\r\n                    brain.element = this.audioManager.playAudio({\r\n                        src,\r\n                        loop: true,\r\n                        output: \"ambience\",\r\n                        volume: { min: regionAudio.volume.min, max: regionAudio.volume.max }\r\n                    });\r\n                    console.log(`Started ${region.name} ambience`);\r\n                }\r\n                if (brain.element) brain.element.setVolume(targetVolume);\r\n            } else if (brain.element) {\r\n                brain.element.stop();\r\n                brain.element = null;\r\n                console.log(`Stopped ${region.name} ambience`);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n    * Stops all world ambience and clears region audio references.\r\n    */\r\n    private cleanWorldAudio(): void {\r\n        console.log(\"Clearing world ambience...\");\r\n        this.regionAudioSources.forEach((brain) => {\r\n            if (brain.element) {\r\n                try {\r\n                    brain.element.stop();\r\n                } catch (e) { console.warn(\"Failed to stop world audio:\", e); }\r\n            }\r\n        });\r\n        this.regionAudioSources.clear();\r\n        this.audioZones.clear();\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n\r\n    // #region [ Events ]\r\n    //\r\n    /**\r\n     * Initializes loading events.\r\n     */\r\n    private initLoadingProgressEvents(): void {\r\n        document.addEventListener(\"yieldMessage\", (e: Event) => {\r\n            const event = e as CustomEvent<{ message: string }>;\r\n            const msgEl = document.getElementById(\"loadingMessage\");\r\n            if (msgEl) msgEl.textContent = event.detail.message;\r\n        });\r\n\r\n        document.addEventListener(\"yieldProgress\", () => {\r\n            const bar = document.getElementById(\"loadingBarFill\");\r\n            if (!bar) return;\r\n\r\n            const current = parseFloat(bar.style.width || \"0\");\r\n            const newWidth = Math.min(100, current + (100 / this.totalYieldSteps()));\r\n            bar.style.width = `${newWidth}%`;\r\n        });\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n\r\n    public exportWorldData(): void {\r\n        console.log(\"Exporting full world data snapshot...\");\r\n\r\n        const chunkSize = this.worldConfig.worldgenParams.general.chunk.size;\r\n\r\n        const encodeBase64 = (u8: Uint8Array): string => {\r\n            let binary = \"\";\r\n            const len = u8.byteLength;\r\n            for (let i = 0; i < len; i++) binary += String.fromCharCode(u8[i]);\r\n            return btoa(binary);\r\n        };\r\n\r\n        const chunksOut: any[] = []; // TODO: Type protect the output\r\n        for (let cx = 0; cx < this.chunks.length; cx++) {\r\n            const col = this.chunks[cx];\r\n            if (!col) continue;\r\n\r\n            for (let cy = 0; cy < col.length; cy++) {\r\n                const chunk = col[cy];\r\n                if (!chunk) continue;\r\n\r\n                const pos = {\r\n                    x: cx * chunkSize,\r\n                    y: cy * chunkSize\r\n                };\r\n\r\n                chunksOut.push({\r\n                    cx,\r\n                    cy,\r\n                    pos,\r\n                    size: chunkSize,\r\n                    chosenBiomeName: chunk.chosenBiomeName,\r\n                    pixelData: encodeBase64(chunk.pixelData),\r\n                    heightData: encodeBase64(chunk.heightData),\r\n                    waterData: encodeBase64(chunk.waterData)\r\n                });\r\n            }\r\n        }\r\n\r\n        const regionsOut = this.regions.map(r => ({\r\n            id: r.id,\r\n            name: r.name,\r\n            layerName: r.layerName,\r\n            bounds: r.bounds,\r\n            chunkCoords: r.chunkCoords,\r\n            area: r.area\r\n        }));\r\n\r\n        const zonesOut: any[] = []; // TODO: Type protect the output\r\n        this.audioZones.forEach((zone, id) => {\r\n            zonesOut.push({\r\n                id,\r\n                regionId: zone.region.id,\r\n                regionName: zone.region.name,\r\n                center: zone.center,\r\n                src: zone.audioParams.src,\r\n                volume: zone.audioParams.volume,\r\n                rolloff: zone.audioParams.spatial?.rolloff,\r\n                radius: zone.audioParams.spatial?.rolloff?.distance\r\n            });\r\n        });\r\n\r\n        const output = {\r\n            meta: {\r\n                seed: this.currentSeed,\r\n                generatedAt: new Date().toISOString(),\r\n                worldSize: {\r\n                    width: WORLD.WIDTH,\r\n                    height: WORLD.HEIGHT\r\n                },\r\n                chunkCount: chunksOut.length,\r\n                regionCount: this.regions.length,\r\n                audioZoneCount: this.audioZones.size\r\n            },\r\n            params: this.worldConfig.worldgenParams,\r\n            chunks: chunksOut,\r\n            regions: regionsOut,\r\n            audioZones: zonesOut\r\n        };\r\n\r\n        const json = JSON.stringify(output, null, 2);\r\n        const blob = new Blob([json], { type: \"application/json\" });\r\n        const link = document.createElement(\"a\");\r\n        link.href = URL.createObjectURL(blob);\r\n        link.download = `${this.currentSeed}.json`;\r\n        link.click();\r\n\r\n        console.log(`World exported successfully (${this.currentSeed}.json)`);\r\n    }\r\n\r\n\r\n\r\n    private async loadWorldFromFile(file: File): Promise<void> {\r\n        console.log(`Loading saved world from ${file.name}...`);\r\n\r\n        const text = await file.text();\r\n        const data = JSON.parse(text);\r\n\r\n        this.showLoadingMenu();\r\n        this.clear();\r\n\r\n        // Restore config + seed\r\n        this.worldConfig.worldgenParams = data.params;\r\n        this.currentSeed = data.meta.seed;\r\n\r\n        const decodeBase64 = (b64: string): Uint8Array => {\r\n            const binary = atob(b64);\r\n            const len = binary.length;\r\n            const bytes = new Uint8Array(len);\r\n            for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);\r\n            return bytes;\r\n        };\r\n\r\n        // === Chunks ===\r\n        this.chunks = [];\r\n        this.chunkLayers = [];\r\n\r\n        const totalChunks = data.chunks.length;\r\n        const allWorldLayers = this.worldConfig.worldLayerList;\r\n\r\n        for (let i = 0; i < totalChunks; i++) {\r\n            const c = data.chunks[i];\r\n\r\n            const pixel = decodeBase64(c.pixelData);\r\n            const height = decodeBase64(c.heightData);\r\n            const water = decodeBase64(c.waterData);\r\n\r\n            const chunk = new WorldChunk(\r\n                c.chosenBiomeName,\r\n                pixel,\r\n                height,\r\n                water,\r\n                this.worldConfig\r\n            );\r\n\r\n            const layer =\r\n                allWorldLayers.find(l => l.name === c.chosenBiomeName) ||\r\n                allWorldLayers[0];\r\n\r\n            // cx, cy were exported  use them directly\r\n            const cx = c.cx;\r\n            const cy = c.cy;\r\n\r\n            if (!this.chunks[cx]) this.chunks[cx] = [];\r\n            if (!this.chunkLayers[cx]) this.chunkLayers[cx] = [];\r\n\r\n            this.chunks[cx][cy] = chunk;\r\n            this.chunkLayers[cx][cy] = layer;\r\n\r\n            chunk.pos = c.pos;\r\n            chunk.size = c.size;\r\n\r\n            this.renderChunk(cx, cy, chunk);\r\n\r\n            if (i % 20 === 0) {\r\n                await this.utility.yield(`Restoring chunk ${i}/${totalChunks}`);\r\n            }\r\n        }\r\n\r\n        console.log(\"All chunks rendered.\");\r\n\r\n        // === Regions ===\r\n        this.regions = data.regions.map((r: any) => ({\r\n            id: r.id,\r\n            name: r.name,\r\n            layerName: r.layerName,\r\n            bounds: r.bounds,\r\n            chunkCoords: r.chunkCoords,\r\n            area: r.area\r\n        }));\r\n\r\n        // === Audio Zones ===\r\n        this.audioZones.clear();\r\n        data.audioZones.forEach((z: any) => {\r\n            const regionRef = this.regions.find(r => r.id === z.regionId);\r\n            if (!regionRef) return;\r\n\r\n            this.audioZones.set(z.id, {\r\n                region: regionRef,\r\n                center: z.center,\r\n                audioParams: {\r\n                    src: z.src,\r\n                    loop: true,\r\n                    output: \"sfx\",\r\n                    volume: z.volume,\r\n                    spatial: {\r\n                        blend: 1.0,\r\n                        pos: z.center,\r\n                        rolloff: z.rolloff\r\n                    }\r\n                },\r\n                isActive: false\r\n            });\r\n        });\r\n\r\n        // === Finalize ===\r\n        this.isGenerated = true;\r\n        this.hideLoadingMenu();\r\n\r\n        console.log(`World loaded and rendered successfully (Seed: ${data.meta.seed}).`);\r\n    }\r\n}","import { Particle } from \"../Types\";\r\n\r\nimport { ParticlesManager } from \"./ParticlesManager\";\r\nimport { Utility } from \"../Utility\";\r\n\r\nimport { AudioConfig } from \"../audio/AudioConfig\";\r\nimport { AudioManager } from \"../audio/AudioManager\";\r\n\r\nimport { PlayerState } from \"../player/PlayerState\";\r\n\r\nimport { World } from \"../world/World\";\r\n\r\nexport class ParticlesController {\r\n    constructor(\r\n        private audioConfig: AudioConfig,\r\n        private audioManager: AudioManager,\r\n        private particlesManager: ParticlesManager,\r\n        private playerState: PlayerState,\r\n        private utility: Utility,\r\n        private world: World,\r\n    ) {\r\n        this.particlesManager.addCollisionListener(this.onParticleCollision.bind(this));\r\n    }\r\n\r\n    private onParticleCollision(p: Particle): void {\r\n        if (p.id.startsWith(\"shell_\")) { // route shell casings\r\n            this.handleShellCollision(p);\r\n            return;\r\n        }\r\n\r\n        // future:\r\n        // if (p.id.startsWith(\"blood_\")) this.handleBloodCollision(p);\r\n        // if (p.id.startsWith(\"spark_\")) this.handleSparkCollision(p);\r\n        // if (p.id.startsWith(\"debris_\")) this.handleDebrisCollision(p);\r\n        // ...\r\n    }\r\n\r\n    private handleShellCollision(p: Particle): void {\r\n        const px = Math.round(p.pos.x);\r\n        const py = Math.round(p.pos.y);\r\n\r\n        const currentWeapon = this.playerState.myPlayer.inventory.primary;\r\n        const shellSets = this.audioConfig.resources.sfx.weapon[currentWeapon].shell;\r\n        if (!shellSets) return;\r\n\r\n        // 1) Resolve environmental state (water  soft  hard)\r\n        const water = this.world.getWaterData({ x: px, y: py });\r\n        const mat = this.world.getMaterialAt(px, py);\r\n        const isSoft = mat?.tags?.includes(\"soft\") === true;\r\n\r\n        let list: string[] = [];\r\n        let volume = { min: 0, max: 0 };\r\n\r\n        if (water && water.waterLevel > 0) {\r\n            list = shellSets.water;\r\n            volume = { min: 0.025, max: 0.1 };\r\n        } else if (isSoft) {\r\n            list = shellSets.soft;\r\n            volume = { min: 0.025, max: 0.075 };\r\n        } else {\r\n            list = shellSets.hard;\r\n            volume = { min: 0.2, max: 0.3 };\r\n        }\r\n\r\n        if (!list || list.length === 0) return;\r\n\r\n        const shellSfx = this.utility.getRandomInArray(list);\r\n\r\n        this.audioManager.playAudioNetwork({\r\n            src: shellSfx,\r\n            listener: { x: px, y: py },\r\n            output: 'sfx',\r\n            spatial: { blend: 1.0, pos: { x: px, y: py } },\r\n            pitch: { min: 0.95, max: 1.125 },\r\n            volume\r\n        });\r\n    }\r\n}","\r\nimport { VIEWPORT, GAME, WORLD } from './Config';\r\nimport { Player, RoomMessage, LobbyPlayer, ResetType, SetSpanParams, DeathDecal, EmitterParams, GameSettings, RenderCharacterParams } from './Types';\r\n\r\nimport { Admin } from './Admin';\r\nimport { Animator } from './Animator';\r\nimport { CacheManager } from './CacheManager';\r\nimport { Camera } from './Camera';\r\nimport { CharacterConfig } from './CharacterConfig';\r\nimport { CharacterManager } from './CharacterManager';\r\nimport { ControlsManager } from './ControlsManager';\r\nimport { CollisionsManager } from './CollisionsManager';\r\nimport { DecalsManager } from './DecalsManager';\r\nimport { EventsManager } from './EventsManager';\r\nimport { GameState } from './GameState';\r\nimport { LobbyManager } from './LobbyManager';\r\nimport { ObjectsManager } from './ObjectsManager';\r\nimport { RenderingManager } from './RenderingManager';\r\nimport { RoomController } from './RoomController';\r\nimport { RoomManager } from './RoomManager';\r\nimport { SettingsManager } from './SettingsManager';\r\nimport { UpgradeManager } from './UpgradeManager';\r\nimport { UserInterface } from './UserInterface';\r\nimport { Utility } from './Utility';\r\nimport { WebsocketManager } from './WebsocketManager';\r\n\r\nimport { AudioConfig } from './audio/AudioConfig';\r\nimport { AudioManager } from './audio/AudioManager';\r\n\r\nimport { ChatManager } from './chat/ChatManager';\r\n\r\nimport { ParticlesManager } from './particles/ParticlesManager';\r\n\r\nimport { CombatController } from './player/CombatController';\r\nimport { DashController } from './player/DashController';\r\nimport { LuckController } from './player/LuckController';\r\nimport { MoveController } from './player/MoveController';\r\nimport { PlayerConfig } from './player/PlayerConfig';\r\nimport { PlayerController } from './player/PlayerController';\r\nimport { PlayerState } from './player/PlayerState';\r\nimport { StaminaController } from './player/StaminaController';\r\n\r\nimport { World } from './world/World';\r\nimport { ParticlesController } from './particles/ParticlesController';\r\n\r\nclass Client {\r\n    private userId: string;\r\n\r\n    private isRoundInProgress = false;\r\n\r\n    private roundWinner: string | null = null;\r\n    private gameWinner: string | null = null; // TODO: Use the game winner to display lobby historical wins\r\n\r\n    private admin: Admin;\r\n    private animator: Animator;\r\n    private audioConfig: AudioConfig;\r\n    private audioManager: AudioManager;\r\n    private cacheManager: CacheManager;\r\n    private camera: Camera;\r\n    private charConfig: CharacterConfig;\r\n    private charManager: CharacterManager;\r\n    private chatManager: ChatManager;\r\n    private collisionsManager: CollisionsManager;\r\n    private combatController: CombatController;\r\n    private controlsManager: ControlsManager;\r\n    private dashController: DashController;\r\n    private decalsManager: DecalsManager;\r\n    private eventsManager: EventsManager;\r\n    private gameState: GameState;\r\n    private lobbyManager: LobbyManager;\r\n    private luckController: LuckController;\r\n    private moveController: MoveController;\r\n    private objectsManager: ObjectsManager;\r\n    private particlesController: ParticlesController;\r\n    private particlesManager: ParticlesManager;\r\n    private playerConfig: PlayerConfig;\r\n    private playerController: PlayerController;\r\n    private playerState: PlayerState;\r\n    private renderingManager: RenderingManager;\r\n    private roomController: RoomController;\r\n    private roomManager: RoomManager;\r\n    private settingsManager: SettingsManager;\r\n    private staminaController: StaminaController;\r\n    private upgradeManager: UpgradeManager;\r\n    private ui: UserInterface;\r\n    private utility: Utility;\r\n    private wsManager: WebsocketManager;\r\n    private world: World;\r\n\r\n    // #region [ Initialization ]\r\n    //\r\n    constructor() {\r\n        this.cacheManager = new CacheManager();\r\n        this.utility = new Utility();\r\n        this.gameState = new GameState();\r\n\r\n        this.audioConfig = new AudioConfig();\r\n\r\n        this.playerConfig = new PlayerConfig();\r\n\r\n        this.settingsManager = new SettingsManager(this.audioConfig, this.cacheManager, this.playerConfig);\r\n        this.controlsManager = new ControlsManager(this.settingsManager);\r\n\r\n        this.charConfig = new CharacterConfig();\r\n        this.charManager = new CharacterManager(this.charConfig);\r\n\r\n        this.userId = this.utility.generateUID(this.playerConfig.default.data.idLength);\r\n        this.playerState = new PlayerState(this.playerConfig, this.userId, this.utility);\r\n\r\n        this.camera = new Camera(this.playerState, this.utility);\r\n\r\n        this.ui = new UserInterface(this.playerState, this.settingsManager, this.utility);\r\n\r\n        this.admin = new Admin(this.cacheManager, this.ui);\r\n\r\n        this.objectsManager = new ObjectsManager(this.playerState, this.utility);\r\n\r\n        this.roomManager = new RoomManager(this.userId, this.utility);\r\n        this.lobbyManager = new LobbyManager(this.charManager, this.playerConfig, this.playerState, this.roomManager, this.settingsManager, this.ui, this.utility);\r\n        this.wsManager = new WebsocketManager(this.gameState, this.roomManager, this.utility);\r\n        this.chatManager = new ChatManager(this.roomManager, this.ui);\r\n\r\n        this.upgradeManager = new UpgradeManager(\r\n            this.playerConfig,\r\n            this.playerState,\r\n            this.ui,\r\n            this.utility\r\n        );\r\n\r\n        this.roomController = new RoomController(\r\n            this.gameState,\r\n            this.lobbyManager,\r\n            this.playerState,\r\n            this.roomManager,\r\n            this.ui,\r\n            this.upgradeManager,\r\n            this.userId,\r\n            this.utility,\r\n            this.wsManager\r\n        );\r\n\r\n        this.collisionsManager = new CollisionsManager(\r\n            this.objectsManager,\r\n            this.playerState,\r\n            this.roomManager,\r\n            this.ui,\r\n            this.userId\r\n        );\r\n\r\n        this.moveController = new MoveController(this.controlsManager, this.playerState, this.settingsManager);\r\n        this.staminaController = new StaminaController(this.playerState);\r\n        this.luckController = new LuckController(this.playerState);\r\n\r\n        this.audioManager = new AudioManager(this.roomManager, this.settingsManager, this.utility);\r\n        this.animator = new Animator(this.playerState, this.roomManager, this.userId);\r\n\r\n        this.world = new World(\r\n            this.audioConfig,\r\n            this.audioManager,\r\n            this.camera,\r\n            this.controlsManager,\r\n            this.playerState,\r\n            this.roomManager,\r\n            this.ui,\r\n            this.utility\r\n        );\r\n\r\n        this.renderingManager = new RenderingManager(\r\n            this.animator,\r\n            this.camera,\r\n            this.charManager,\r\n            this.lobbyManager,\r\n            this.objectsManager,\r\n            this.playerConfig,\r\n            this.ui,\r\n            this.userId\r\n        );\r\n\r\n        this.decalsManager = new DecalsManager(\r\n            this.camera,\r\n            this.charConfig,\r\n            this.playerState,\r\n            this.renderingManager,\r\n            this.roomManager,\r\n            this.ui,\r\n            this.userId,\r\n            this.utility\r\n        );\r\n\r\n        this.particlesManager = new ParticlesManager(\r\n            this.camera,\r\n            this.charConfig,\r\n            this.collisionsManager,\r\n            this.decalsManager,\r\n            this.playerState,\r\n            this.renderingManager,\r\n            this.roomManager,\r\n            this.ui,\r\n            this.userId,\r\n            this.utility\r\n        );\r\n\r\n        this.particlesController = new ParticlesController(\r\n            this.audioConfig,\r\n            this.audioManager,\r\n            this.particlesManager,\r\n            this.playerState,\r\n            this.utility,\r\n            this.world\r\n        );\r\n\r\n        this.playerController = new PlayerController(\r\n            this.audioConfig,\r\n            this.audioManager,\r\n            this.decalsManager,\r\n            this.gameState,\r\n            this.luckController,\r\n            this.moveController,\r\n            this.objectsManager,\r\n            this.particlesManager,\r\n            this.playerState,\r\n            this.roomManager,\r\n            this.ui,\r\n            this.userId,\r\n            this.utility,\r\n            this.world\r\n        );\r\n\r\n        this.combatController = new CombatController(\r\n            this.animator,\r\n            this.audioConfig,\r\n            this.audioManager,\r\n            this.collisionsManager,\r\n            this.decalsManager,\r\n            this.gameState,\r\n            this.luckController,\r\n            this.particlesManager,\r\n            this.playerController,\r\n            this.playerState,\r\n            this.roomManager,\r\n            this.ui,\r\n            this.userId,\r\n            this.utility,\r\n            this.world\r\n        );\r\n\r\n        this.dashController = new DashController(\r\n            this.collisionsManager,\r\n            this.combatController,\r\n            this.moveController,\r\n            this.playerState,\r\n            this.roomManager,\r\n            this.staminaController,\r\n            this.userId\r\n        );\r\n\r\n        this.eventsManager = new EventsManager(\r\n            this.animator,\r\n            this.audioManager,\r\n            this.camera,\r\n            this.chatManager,\r\n            this.controlsManager,\r\n            this.gameState,\r\n            this.roomController,\r\n            this.playerState,\r\n            this.settingsManager,\r\n            this.ui,\r\n            this.userId\r\n        );\r\n\r\n        if (document.readyState === 'loading') {\r\n            document.addEventListener('DOMContentLoaded', () => { this.initClient(); });\r\n        } else {\r\n            this.initClient();\r\n        }\r\n\r\n        document.addEventListener('keydown', (e) => {\r\n            if (e.key === 'Escape' && this.gameState.gameInProgress && !this.lobbyManager.inLobby) {\r\n                e.preventDefault();\r\n                // TODO: Test stuff here!\r\n\r\n                const ammo = 20;\r\n\r\n                this.playerState.myPlayer.actions.primary.magazine.currentReserve += ammo;\r\n                this.ui.ammoReservesUIController.spawnAmmoInReserveUI(ammo);\r\n            }\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Clears the client state.\r\n     */\r\n    private clear(): void {\r\n        this.isRoundInProgress = false;\r\n        this.gameWinner = null;\r\n        this.roundWinner = null;\r\n    }\r\n\r\n    /**\r\n     * Main initializer for the game client.\r\n     */\r\n    private async initClient(): Promise<void> {\r\n        this.ui.initInterface();\r\n        this.eventsManager.initEventListeners();\r\n        this.initGlobalEvents();\r\n\r\n        this.roomController.checkForRoomInURL();\r\n        this.roomController.showRoomControls();\r\n\r\n        const spanParams: SetSpanParams = {\r\n            spanId: 'userId',\r\n            value: this.userId\r\n        }\r\n        this.utility.setSpan(spanParams);\r\n\r\n        await this.settingsManager.loadSettings();\r\n        const settings: GameSettings = this.settingsManager.getSettings();\r\n\r\n        this.ui.initSoundSliders(settings);\r\n        this.ui.initSettingsInputs(settings);\r\n        this.ui.initSettingsToggles(settings)\r\n        this.ui.ammoReservesUIController.initAmmoReserveCanvas();\r\n\r\n        this.eventsManager.initKeybindListeners();\r\n\r\n        this.audioManager.updateMixerGains();\r\n        await this.audioManager.preloadAudio(this.audioConfig.resources.sfx, '.ogg');\r\n        await this.audioManager.preloadAudio(this.audioConfig.resources.ambience, '.ogg');\r\n\r\n        this.watchForInputs();\r\n\r\n        this.admin.onAdminCommand = (command, key) => {\r\n            this.roomManager.sendAdminCommand(command, key);\r\n        };\r\n\r\n        window.addEventListener(\"customEvent_AppStart\", () => { // Start playing background ambience once the app has been entered by user agency\r\n            const src = this.audioConfig.resources.ambience.beds.app[0];\r\n            this.audioManager.playAudio({\r\n                src: src,\r\n                loop: true,\r\n                output: \"ambience\",\r\n                volume: { min: 0.025, max: 0.025 }\r\n            });\r\n        });\r\n\r\n    }\r\n\r\n    /**\r\n     * Initializes event listeners.\r\n     */\r\n    private initGlobalEvents(): void {\r\n        window.addEventListener(\"customEvent_startGame\", () => this.startGame());\r\n        window.addEventListener(\"customEvent_resetGameState\", (e: Event) => {\r\n            const event = e as CustomEvent<{ resetType: ResetType }>;\r\n            this.resetGameState(event.detail.resetType);\r\n        });\r\n\r\n        // Room manager message handler\r\n        this.roomManager.onMessage((message) => this.handleRoomMessage(message));\r\n    }\r\n    //\r\n    // #endregion\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    // #region [ Client <> Server ]\r\n    //\r\n    /**\r\n     * Responsible for room related WS messages.\r\n     */\r\n    private handleRoomMessage(message: RoomMessage): void {\r\n        switch (message.type) {\r\n            case 'room-created':\r\n                console.log('Room created');\r\n                break;\r\n            case 'room-joined':\r\n                console.log('Joined room - lobby');\r\n                this.playerState.isHost = false;\r\n                this.lobbyManager.showLobbyControls({\r\n                    lobby: this.lobbyManager,\r\n                    lobbyOptions: {\r\n                        maxPlayers: this.gameState.gameMaxPlayers,\r\n                        maxWins: this.gameState.gameMaxWins,\r\n                        isHost: this.playerState.isHost,\r\n                        privateRoom: this.roomManager.isPrivateRoom,\r\n                        upgradesEnabled: this.upgradeManager.isUpgradesEnabled\r\n                    },\r\n                    myPlayer: this.playerState.myPlayer,\r\n                    roomId: this.roomManager.getCurrentRoom() || \"\",\r\n                    userId: this.userId\r\n                });\r\n\r\n                // Send my lobby info\r\n                this.roomManager.sendMessage(JSON.stringify({\r\n                    type: 'lobby-join',\r\n                    color: this.playerState.myPlayer.color,\r\n                    rig: {\r\n                        body: this.playerConfig.default.rig.body,\r\n                        head: this.playerConfig.default.rig.head,\r\n                        headwear: this.playerConfig.default.rig.headwear,\r\n                        weapon: this.playerConfig.default.rig.weapon\r\n                    }\r\n                }));\r\n\r\n                const centerX = this.ui.charCustomizeCanvas ? this.ui.charCustomizeCanvas.width / 2 : 0;\r\n                const centerY = this.ui.charCustomizeCanvas ? this.ui.charCustomizeCanvas.height / 2 : 0;\r\n\r\n                // Add myself to lobby\r\n                this.lobbyManager.lobbyPlayers.set(this.userId, {\r\n                    id: this.userId,\r\n                    color: this.playerState.myPlayer.color,\r\n                    isHost: this.playerState.isHost,\r\n                    rig: {\r\n                        body: this.playerConfig.default.rig.body,\r\n                        head: this.playerConfig.default.rig.head,\r\n                        headwear: this.playerConfig.default.rig.headwear,\r\n                        weapon: this.playerConfig.default.rig.weapon\r\n                    },\r\n                    transform: {\r\n                        pos: { x: centerX, y: centerY },\r\n                        rot: 0\r\n                    }\r\n                });\r\n                this.ui.displayLobbyPlayers(this.playerState.isHost, this.lobbyManager, this.userId);\r\n                this.ui.updateHostDisplay(this.playerState.isHost, this.lobbyManager);\r\n\r\n                if (this.lobbyManager.lobbyPlayers.size === 0) { // No other players added to lobby list\r\n                    this.playerState.isHost = true;\r\n                    this.lobbyManager.lobbyPlayers.get(this.userId)!.isHost = true;\r\n                    this.ui.updateHostDisplay(this.playerState.isHost, this.lobbyManager);\r\n                    console.log('I am the only player in the room...');\r\n                }\r\n                break;\r\n            case 'user-left':\r\n                console.log(`User ${message.userId} left`);\r\n                this.lobbyManager.lobbyPlayers.delete(message.userId);\r\n                this.playerState.players.delete(message.userId);\r\n\r\n                // Remove from leaderboard when player leaves\r\n                this.ui.leaderboard.delete(message.userId);\r\n                this.ui.updateLeaderboardDisplay(this.userId);\r\n                console.log(`Removed ${message.userId} from leaderboard`);\r\n\r\n                // Remove projectiles from disconnected player\r\n                this.combatController.projectiles.forEach((projectile, id) => {\r\n                    if (projectile.ownerId === message.userId) {\r\n                        this.combatController.projectiles.delete(id);\r\n                    }\r\n                });\r\n                this.ui.displayLobbyPlayers(this.playerState.isHost, this.lobbyManager, this.userId);\r\n                break;\r\n            case 'room-message':\r\n                this.handleGameMessage(message);\r\n                break;\r\n            case 'room-error':\r\n                alert(`Error: ${message.message}`);\r\n                break;\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Processes all client sent network messages related to gameplay and lobby logic.\r\n     */\r\n    private async handleGameMessage(message: RoomMessage): Promise<void> {\r\n        if (!message.message) return;\r\n\r\n        try {\r\n            const gameData = JSON.parse(message.message);\r\n\r\n            switch (gameData.type) {\r\n                //\r\n                // [ Lobby ]\r\n                //\r\n                case 'lobby-join':\r\n                    const centerX = this.ui.charCustomizeCanvas ? this.ui.charCustomizeCanvas.width / 2 : 0;\r\n                    const centerY = this.ui.charCustomizeCanvas ? this.ui.charCustomizeCanvas.height / 2 : 0;\r\n\r\n                    this.lobbyManager.lobbyPlayers.set(message.userId, {\r\n                        id: message.userId,\r\n                        color: gameData.color,\r\n                        isHost: false,\r\n                        rig: gameData.rig,\r\n                        transform: {\r\n                            pos: { x: centerX, y: centerY },\r\n                            rot: 0\r\n                        }\r\n                    });\r\n                    this.ui.displayLobbyPlayers(this.playerState.isHost, this.lobbyManager, this.userId);\r\n\r\n                    // If I'm host, send current lobby state to new player\r\n                    if (this.playerState.isHost) {\r\n                        this.roomManager.sendMessage(JSON.stringify({\r\n                            type: 'lobby-state',\r\n                            players: Array.from(this.lobbyManager.lobbyPlayers.values()),\r\n                            options: {\r\n                                privateRoom: this.roomManager.isPrivateRoom,\r\n                                maxPlayers: this.gameState.gameMaxPlayers,\r\n                                maxWins: this.gameState.gameMaxWins,\r\n                                upgradesEnabled: this.upgradeManager.isUpgradesEnabled\r\n                                // TODO: Add more room options here as enabled\r\n                            }\r\n                        }));\r\n                    }\r\n                    break;\r\n                case 'lobby-state':\r\n                    this.lobbyManager.lobbyPlayers.clear();\r\n\r\n                    gameData.players.forEach((player: LobbyPlayer) => {\r\n                        this.lobbyManager.lobbyPlayers.set(player.id, player);\r\n                    });\r\n\r\n                    this.ui.displayLobbyPlayers(this.playerState.isHost, this.lobbyManager, this.userId);\r\n                    this.ui.updateHostDisplay(this.playerState.isHost, this.lobbyManager);\r\n\r\n                    if (gameData.options) {\r\n                        this.lobbyManager.syncLobbyOptions(gameData.options);\r\n                    }\r\n                    break;\r\n                case 'lobby-options':\r\n                    this.lobbyManager.syncLobbyOptions(gameData);\r\n                    break;\r\n                case 'promote-player':\r\n                    this.lobbyManager.lobbyPlayers.forEach((player, id) => { // Update host status for all players\r\n                        player.isHost = id === gameData.targetPlayerId;\r\n                    });\r\n\r\n                    // Update my own host status\r\n                    this.playerState.isHost = gameData.targetPlayerId === this.userId;\r\n\r\n                    // If I just became host due to migration, log it\r\n                    if (this.playerState.isHost && gameData.reason === 'host-migration') {\r\n                        console.log('I am now the host due to host migration');\r\n                    }\r\n\r\n                    this.lobbyManager.setupLobbyOptions({\r\n                        maxPlayers: this.gameState.gameMaxPlayers,\r\n                        maxWins: this.gameState.gameMaxWins,\r\n                        isHost: this.playerState.isHost,\r\n                        privateRoom: this.roomManager.isPrivateRoom,\r\n                        upgradesEnabled: this.upgradeManager.isUpgradesEnabled\r\n                    });\r\n\r\n                    this.ui.displayLobbyPlayers(this.playerState.isHost, this.lobbyManager, this.userId);\r\n                    this.ui.updateHostDisplay(this.playerState.isHost, this.lobbyManager);\r\n                    break;\r\n                case 'return-to-lobby': // New message type\r\n                    console.log('Returning to lobby - last player or game ended');\r\n\r\n                    // Update host status if I'm the new host\r\n                    if (gameData.newHostId === this.userId) {\r\n                        this.playerState.isHost = true;\r\n                        console.log('I am now the host as the last remaining player');\r\n                    }\r\n\r\n                    this.resetGameState('Lobby');\r\n\r\n                    // Show lobby\r\n                    this.lobbyManager.showLobbyControls({\r\n                        lobby: this.lobbyManager,\r\n                        lobbyOptions: {\r\n                            maxPlayers: this.gameState.gameMaxPlayers,\r\n                            maxWins: this.gameState.gameMaxWins,\r\n                            isHost: this.playerState.isHost,\r\n                            privateRoom: this.roomManager.isPrivateRoom,\r\n                            upgradesEnabled: this.upgradeManager.isUpgradesEnabled\r\n                        },\r\n                        myPlayer: this.playerState.myPlayer,\r\n                        roomId: this.roomManager.getCurrentRoom() || \"\",\r\n                        userId: this.userId\r\n                    });\r\n                    break;\r\n                case 'kick-player':\r\n                    if (gameData.targetPlayerId === this.userId) {\r\n                        alert('You have been kicked from the lobby');\r\n                        this.roomController.leaveRoom();\r\n                    }\r\n                    break;\r\n                //\r\n                // [ Chat ]\r\n                //\r\n                case 'chat-message':\r\n                    if (message.userId !== this.userId) {\r\n                        this.chatManager.displayChatMessage({\r\n                            senderId: message.userId,\r\n                            message: gameData.message,\r\n                            isOwn: false\r\n                        });\r\n                    }\r\n                    break;\r\n                //\r\n                // [ Player ]\r\n                //\r\n                case \"player-state\": {\r\n                    const playerData = gameData.data;\r\n                    if (!playerData || !playerData.id) return;\r\n\r\n                    this.playerState.players.set(playerData.id, playerData);\r\n\r\n                    this.ui.createLeaderboard(this.lobbyManager, this.playerState.players, this.userId);\r\n                    console.log('State update for player', message.userId, ':', gameData);\r\n                    break;\r\n                }\r\n                case 'partial-state': {\r\n                    if (message.userId === this.userId) return;\r\n\r\n                    const player = this.playerState.players.get(message.userId);\r\n                    if (!player) break;\r\n\r\n                    this.utility.deepMerge(player, gameData);\r\n                    console.log('Partial State update for player', message.userId, ':', gameData);\r\n                    break;\r\n                }\r\n                case 'player-move':\r\n                    if (!this.lobbyManager.inLobby && this.playerState.players.has(message.userId)) {\r\n                        const player = this.playerState.players.get(message.userId);\r\n                        if (!player) break;\r\n\r\n                        if (gameData.transform.pos) {\r\n                            player.transform.pos.x = gameData.transform.pos.x;\r\n                            player.transform.pos.y = gameData.transform.pos.y;\r\n                        }\r\n\r\n                        if (gameData.transform.rot !== undefined) {\r\n                            player.transform.rot = gameData.transform.rot;\r\n                        }\r\n                    }\r\n                    break;\r\n                case 'player-hit':\r\n                    if (gameData.projectileId) { // Remove the projectile for everyone\r\n                        this.combatController.projectiles.delete(gameData.projectileId);\r\n                    }\r\n\r\n                    if (gameData.targetId === this.userId) { // I got hit\r\n                        this.playerState.myPlayer.stats.health.value = gameData.newHealth;\r\n\r\n                        this.ui.updateSlider('health');\r\n\r\n                        if (this.playerState.myPlayer.stats.health.value <= 0) {\r\n                            this.playerController.playerDeath();\r\n                        }\r\n                    } else if (this.playerState.players.has(gameData.targetId)) { // Another player got hit\r\n                        const hitPlayer = this.playerState.players.get(gameData.targetId);\r\n                        if (!hitPlayer) break;\r\n\r\n                        hitPlayer.stats.health.value = gameData.newHealth;\r\n\r\n                        if (hitPlayer.stats.health.value <= 0) {\r\n                            console.log(`Player ${hitPlayer.id} died`);\r\n                        }\r\n                    }\r\n\r\n                    if (gameData.wasKill) {\r\n                        const shooter = this.ui.leaderboard.get(gameData.shooterId);\r\n                        if (shooter) {\r\n                            shooter.kills++;\r\n                        }\r\n\r\n                        const target = this.ui.leaderboard.get(gameData.targetId);\r\n                        if (target) {\r\n                            target.deaths++;\r\n                        }\r\n\r\n                        this.ui.updateLeaderboardDisplay(this.userId);\r\n                    }\r\n                    break;\r\n                case 'player-death':\r\n                    if (message.userId !== this.userId && gameData.ammoBox) { // Spawn ammo\r\n                        this.objectsManager.ammoBoxes.set(gameData.ammoBox.id, gameData.ammoBox);\r\n                        console.log(`Ammo box spawned at death of ${message.userId}`);\r\n                    }\r\n\r\n                    const gore: DeathDecal = {\r\n                        gore: {\r\n                            amount: this.utility.getRandomInt(2, 5)\r\n                        },\r\n                        blood: {\r\n                            amount: this.utility.getRandomInt(1, 3)\r\n                        },\r\n                        ownerId: message.userId,\r\n                        pos: {\r\n                            x: gameData.x,\r\n                            y: gameData.y\r\n                        },\r\n                        radius: gameData.size\r\n                    }\r\n                    this.decalsManager.generateGore(gore); // Spawn gore\r\n\r\n                    console.log(`Generated gore for ${message.userId}`);\r\n                    break;\r\n                case 'ammo-pickup':\r\n                    if (gameData.playerId === this.userId) break;\r\n\r\n                    if (this.objectsManager.ammoBoxes.has(gameData.ammoBoxId)) {\r\n                        const box = this.objectsManager.ammoBoxes.get(gameData.ammoBoxId);\r\n                        if (!box) break;\r\n\r\n                        // Update box state\r\n                        box.isOpen = gameData.boxState.isOpen;\r\n                        box.lid = gameData.boxState.lid;\r\n\r\n                        console.log(`Ammo box opened by ${gameData.playerId}`);\r\n                    }\r\n                    break;\r\n                case 'weapon-change':\r\n                    if (message.userId !== this.userId && this.playerState.players.has(message.userId)) {\r\n                        const player = this.playerState.players.get(message.userId);\r\n                        if (!player) break;\r\n\r\n                        player.rig.weapon = gameData.weapon;\r\n                        console.log(`${message.userId} switched to ${gameData.weapon}`);\r\n                    }\r\n                    break;\r\n                //\r\n                //\r\n                // [ Projectile ]\r\n                //\r\n                case 'projectile-launch':\r\n                    if (!this.lobbyManager.inLobby && message.userId !== this.userId) {\r\n                        this.combatController.projectiles.set(gameData.projectile.id, gameData.projectile);\r\n                    }\r\n                    break;\r\n                case 'projectile-remove':\r\n                    if (!this.lobbyManager.inLobby) {\r\n                        this.combatController.projectiles.delete(gameData.projectileId);\r\n                    }\r\n                    break;\r\n                case 'projectile-update': // Used for deflections or any projectile mid trajectory updates\r\n                    if (!this.lobbyManager.inLobby && this.combatController.projectiles.has(gameData.projectileId)) {\r\n                        const projectile = this.combatController.projectiles.get(gameData.projectileId);\r\n                        if (!projectile) break;\r\n\r\n                        // Update projectile properties\r\n                        projectile.ownerId = gameData.newOwnerId;\r\n                        projectile.velocity = gameData.velocity;\r\n                        projectile.color = gameData.color;\r\n                        projectile.transform.rot = Math.atan2(projectile.velocity.y, projectile.velocity.x);\r\n\r\n                        console.log(`Projectile ${gameData.projectileId} data updated by ${gameData.newOwnerId}`);\r\n                    }\r\n                    break;\r\n                //\r\n                //\r\n                // [ Game ]\r\n                //\r\n                case 'start-game':\r\n                    if (gameData.spawnMap && gameData.spawnMap[this.userId]) {\r\n                        this.playerState.myPlayer.transform.pos.x = gameData.spawnMap[this.userId].x;\r\n                        this.playerState.myPlayer.transform.pos.y = gameData.spawnMap[this.userId].y;\r\n                        console.log(\"My Player Spawn:\", gameData.spawnMap[this.userId].x, gameData.spawnMap[this.userId].y)\r\n                    }\r\n                    // For other players\r\n                    if (gameData.spawnMap) {\r\n                        this.playerState.players.forEach((player: Player, id: string) => {\r\n                            if (gameData.spawnMap[id]) {\r\n                                player.transform.pos.x = gameData.spawnMap[id].x;\r\n                                player.transform.pos.y = gameData.spawnMap[id].y;\r\n                                console.log(`Player ${id} spawn:`, gameData.spawnMap[id].x, gameData.spawnMap[id].y)\r\n                            }\r\n                        });\r\n                    }\r\n\r\n                    if (gameData.worldData) {\r\n                        await this.world.generateWorld(gameData.worldData);\r\n                    }\r\n\r\n                    this.showGameControls(this.roomManager.getCurrentRoom() || '');\r\n                    this.startGameLoop();\r\n                    break;\r\n                case 'game-end':\r\n                    console.log(`Game ended! Winner: ${gameData.winnerId}`);\r\n                    this.gameWinner = gameData.winnerId;\r\n                    break;\r\n                //\r\n                //\r\n                // [ Round ]\r\n                //\r\n                case 'round-end':\r\n                    console.log(`Round ended! Winner: ${gameData.winnerId || 'No one'}`);\r\n                    this.endRound(gameData.winnerId);\r\n                    break;\r\n                case 'new-round':\r\n                    if (!gameData.spawnMap) return;\r\n                    console.log(gameData.spawnMap);\r\n\r\n                    // Hide upgrade UI\r\n                    if (this.ui.upgradeContainer) {\r\n                        this.ui.upgradeContainer.style.display = 'none';\r\n                    }\r\n\r\n                    console.log('New round started! Everyone respawning...');\r\n                    this.isRoundInProgress = true;\r\n                    this.roundWinner = null;\r\n\r\n                    this.playerState.myPlayer.stats.health.value = this.playerState.myPlayer.stats.health.max;\r\n\r\n                    this.ui.updateSlider('health');\r\n                    this.ui.updateSlider('stamina');\r\n\r\n                    this.playerState.myPlayer.transform.pos.x = gameData.spawnMap[this.userId].x;\r\n                    this.playerState.myPlayer.transform.pos.y = gameData.spawnMap[this.userId].y;\r\n\r\n                    this.resumeGame(); // Unpause locally\r\n\r\n                    // Receive all player's spawn locations and reset their health\r\n                    this.playerState.players.forEach((player: Player, playerId: string) => { // Respawn other players\r\n                        if (gameData.spawnMap[playerId]) {\r\n                            player.transform.pos.x = gameData.spawnMap[player.id].x;\r\n                            player.transform.pos.y = gameData.spawnMap[player.id].y;\r\n                            player.transform.rot = 0;\r\n\r\n                            // Reset vitals for good measure lol\r\n                            player.stats.health.value = player.stats.health.max;\r\n                            player.stats.stamina.value = player.stats.stamina.max;\r\n                        }\r\n                    });\r\n                    break;\r\n                case 'upgrade-taken': // Someone else took an upgrade\r\n                    if (gameData.upgradeId && gameData.isUnique) { // That upgrade is unique - remove it from my local uniques pool\r\n                        this.upgradeManager.removeUpgradeFromPool(gameData.upgradeId);\r\n                        console.log(`Unique upgrade ${gameData.upgradeId} taken by ${message.userId}`);\r\n                    }\r\n\r\n                    if (this.roundWinner === this.userId) { // I am the round winner - how many players have taken upgrades?\r\n                        this.upgradeManager.upgradesCompleted.add(message.userId);\r\n                        console.log(`${message.userId} completed upgrade. ${this.upgradeManager.upgradesCompleted.size}/${this.playerState.players.size} done`);\r\n\r\n                        // Check if all losers are done\r\n                        if (this.upgradeManager.upgradesCompleted.size >= this.playerState.players.size) {\r\n                            this.showWinnerContinueButton();\r\n                        }\r\n                    }\r\n                    break;\r\n                //\r\n                //\r\n                // [ Audio ]\r\n                //\r\n                case 'play-audio':\r\n                    if (message.userId !== this.userId) {\r\n                        this.audioManager.playAudio(gameData.params);\r\n                    }\r\n                    break;\r\n                //\r\n                //\r\n                // [ Visual ]\r\n                //\r\n                case 'add-decal':\r\n                    if (message.userId !== this.userId) {\r\n                        this.decalsManager.createDecalNetwork(gameData.params);\r\n                    }\r\n                    break;\r\n                case 'add-particles':\r\n                    if (message.userId !== this.userId) {\r\n                        this.particlesManager.createParticlesNetwork(gameData.params);\r\n                    }\r\n                    break;\r\n                case 'particle-emitter':\r\n                    if (message.userId !== this.userId) {\r\n                        const emission: EmitterParams = {\r\n                            id: gameData.id,\r\n                            interval: gameData.interval,\r\n                            lifetime: gameData.lifetime,\r\n                            offset: {\r\n                                x: gameData.offset.x,\r\n                                y: gameData.offset.y\r\n                            },\r\n                            particleType: gameData.particleType,\r\n                            playerId: gameData.playerId,\r\n                            pos: {\r\n                                x: gameData.pos.x,\r\n                                y: gameData.pos.y\r\n                            }\r\n                        }\r\n                        this.particlesManager.generateEmitter(emission);\r\n                    }\r\n                    break;\r\n                case 'character-animation':\r\n                    if (gameData.params.playerId !== this.userId) {\r\n                        this.animator.animateCharacterPartNetwork(gameData.params);\r\n                    }\r\n                    break;\r\n                case 'shrapnel-spawn':\r\n                    if (message.userId !== this.userId) {\r\n                        this.particlesManager.generateShrapnel(gameData.pieces);\r\n                    }\r\n                    break;\r\n                //\r\n                //\r\n                // [ World ]\r\n                //\r\n                case 'chunk-update':\r\n                    if (message.userId !== this.userId) {\r\n                        this.world.worldEdit.createChunkPatchNetwork(gameData.chunk);\r\n                    }\r\n                    break;\r\n            }\r\n        } catch (error) {\r\n            console.error('Error parsing game message:', error);\r\n        }\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    // #region [ Lobby ]\r\n    //\r\n    /**\r\n     * Return to the lobby for this room from the game.\r\n     * \r\n     * Called when game ends, or when you are the last player left in the game.\r\n     */\r\n    private returnToLobby(): void {\r\n        this.resetGameState('Lobby');\r\n\r\n        // Notify others and return to lobby\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'return-to-lobby',\r\n            reason: 'game-ended'\r\n        }));\r\n\r\n        this.lobbyManager.showLobbyControls({\r\n            lobby: this.lobbyManager,\r\n            lobbyOptions: {\r\n                maxPlayers: this.gameState.gameMaxPlayers,\r\n                maxWins: this.gameState.gameMaxWins,\r\n                isHost: this.playerState.isHost,\r\n                privateRoom: this.roomManager.isPrivateRoom,\r\n                upgradesEnabled: this.upgradeManager.isUpgradesEnabled\r\n            },\r\n            myPlayer: this.playerState.myPlayer,\r\n            roomId: this.roomManager.getCurrentRoom() || \"\",\r\n            userId: this.userId\r\n        });\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    // #region [ Round ]\r\n    //\r\n    /**\r\n     * Processes end of round logic.\r\n     */\r\n    private endRound(winnerId: string | null): void {\r\n        if (!this.isRoundInProgress) {\r\n            console.log('Ignoring endRound - round already ended');\r\n            return;\r\n        }\r\n\r\n        console.log(`Server confirmed round end. Winner: ${winnerId || 'No one'}`);\r\n\r\n        this.isRoundInProgress = false;\r\n        this.roundWinner = winnerId;\r\n\r\n        if (!winnerId) { // Everyone died somehow\r\n            console.log('Round ended with no survivors!');\r\n            if (this.playerState.isHost) {\r\n                this.utility.safeTimeout(() => {\r\n                    this.startNewRound();\r\n                }, GAME.ROUND_END_DELAY);\r\n            }\r\n            return;\r\n        }\r\n\r\n        // Increment win for the winner\r\n        if (winnerId && this.ui.leaderboard.has(winnerId)) {\r\n            const winnerEntry = this.ui.leaderboard.get(winnerId);\r\n            if (!winnerEntry) return;\r\n\r\n            winnerEntry.wins++;\r\n            console.log(`${winnerId} won the round! Total wins: ${winnerEntry.wins}`);\r\n\r\n            // Check if they've won the game - use dynamic max wins\r\n            if (winnerEntry.wins >= this.gameState.gameMaxWins) {\r\n                this.endGame(winnerId); // TODO: Maybe don't rely on leaderboard data to end the game but actual player data stored for the round\r\n                return; // Don't start a new round\r\n            }\r\n\r\n            // Update display to show new win count\r\n            this.ui.updateLeaderboardDisplay(this.userId);\r\n        }\r\n\r\n        this.utility.safeTimeout(() => {\r\n            this.pauseGame(); // Everybody pause locally\r\n        }, GAME.ROUND_END_DELAY / 6);\r\n\r\n        // We have a winner, start the upgrade phase after a delay\r\n        this.utility.safeTimeout(() => {\r\n            this.startUpgradePhase(winnerId);\r\n        }, GAME.ROUND_END_DELAY);\r\n    }\r\n\r\n    /**\r\n     * Processes end of game logic.\r\n     */\r\n    private endGame(winnerId: string): void {\r\n        this.gameWinner = winnerId;\r\n        console.log(`${winnerId} won the game with ${this.gameState.gameMaxWins} wins!`);\r\n\r\n        // Send game end message\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'game-end',\r\n            winnerId: winnerId\r\n        }));\r\n\r\n        // Return to lobby after delay\r\n        this.utility.safeTimeout(() => {\r\n            this.returnToLobby();\r\n        }, GAME.GAME_END_DELAY);\r\n    }\r\n\r\n    /**\r\n     * Starts a new round, keeping track of full player states.\r\n     */\r\n    private startNewRound(): void {\r\n        console.log('Starting new round...');\r\n\r\n        // Send the spawn map to all other players\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'new-round',\r\n            reservedSpawn: {\r\n                x: Math.random() * (WORLD.WIDTH - WORLD.BORDER_MARGIN * 2) + WORLD.BORDER_MARGIN,\r\n                y: Math.random() * (WORLD.HEIGHT - WORLD.BORDER_MARGIN * 2) + WORLD.BORDER_MARGIN\r\n            }\r\n        }));\r\n    }\r\n\r\n    //\r\n    // #endregion\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    // #region [ Game ]\r\n    //\r\n    /**\r\n     * Update the display with the game canvas via updateDisplay.\r\n     */\r\n    private showGameControls(roomId: string): void {\r\n        this.ui.updateDisplay(this.lobbyManager, \"game\", roomId);\r\n    }\r\n\r\n    /**\r\n     * Called by the host when the start button is pressed in the lobby.\r\n     * \r\n     * Starts game loop via executeStartGame or displays a warning before continuing if solo.\r\n     */\r\n    private startGame(): void {\r\n        if (!this.playerState.isHost) return;\r\n\r\n        // Check if solo and show warning if needed\r\n        if (this.lobbyManager.lobbyPlayers.size === 1) {\r\n            this.ui.soloGameWarning(() => this.executeStartGame());\r\n            return; // Don't continue, let the modal handle it\r\n        }\r\n\r\n        // If not solo, proceed normally\r\n        this.executeStartGame();\r\n    }\r\n\r\n    /**\r\n     * Executes the beginning of a game and broadcasts the start to all lobbyplayers.\r\n     */\r\n    private async executeStartGame(): Promise<void> {\r\n        const worldData = await this.world.showGenerationMenu(); // Show the worldgen menu for the host, and use params for all clients\r\n\r\n        // Send start game message to other players\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'start-game',\r\n            reservedSpawn: {\r\n                x: this.playerState.myPlayer.transform.pos.x,\r\n                y: this.playerState.myPlayer.transform.pos.y\r\n            },\r\n            worldData: worldData\r\n        }));\r\n\r\n        if (worldData !== \"load\") { // Generate a new world if a saved world is not loaded\r\n            await this.world.generateWorld(worldData);\r\n        }\r\n\r\n        // Also start the game for the host\r\n        this.showGameControls(this.roomManager.getCurrentRoom() || '');\r\n        this.startGameLoop();\r\n    }\r\n\r\n    /**\r\n     * Kicks of the game loop and initializes values to clean slate.\r\n     */\r\n    private startGameLoop(): void {\r\n        this.gameState.gameInProgress = true;\r\n        this.isRoundInProgress = true;\r\n\r\n        this.playerState.myPlayer.actions.primary.magazine.currentReserve = Math.floor(this.playerConfig.default.actions.primary.magazine.maxReserve / 2);\r\n        this.playerState.myPlayer.actions.primary.magazine.currentAmmo = this.playerState.myPlayer.actions.primary.magazine.size;\r\n        this.ui.ammoReservesUIController.spawnAmmoInReserveUI(this.playerState.myPlayer.actions.primary.magazine.currentReserve);\r\n        this.playerState.isReloading = false;\r\n\r\n        this.ui.createLeaderboard(this.lobbyManager, this.playerState.players, this.userId);\r\n\r\n        this.upgradeManager.resetUpgrades(this.playerState.myPlayer);\r\n\r\n        // Transfer rig from lobby to game player\r\n        const myLobbyPlayer = this.lobbyManager.lobbyPlayers.get(this.userId);\r\n        if (myLobbyPlayer) {\r\n            console.log(\"Found lobby rig for my player: \", myLobbyPlayer.rig);\r\n\r\n            this.playerState.myPlayer.rig.body = myLobbyPlayer.rig.body;\r\n            this.playerState.myPlayer.rig.head = myLobbyPlayer.rig.head;\r\n            this.playerState.myPlayer.rig.headwear = myLobbyPlayer.rig.headwear;\r\n            this.playerState.myPlayer.rig.weapon = myLobbyPlayer.rig.weapon;\r\n        }\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: \"player-state\",\r\n            userId: this.userId,\r\n            data: this.playerState.myPlayer\r\n        }));\r\n\r\n\r\n        this.gameLoop();\r\n\r\n        this.ui.updateSlider('health');\r\n        this.ui.updateSlider('stamina');\r\n    }\r\n\r\n    /**\r\n     * Core game processing function.\r\n     * \r\n     * Handles animation frame requests, update loops for all systems, and drawing functions.\r\n     */\r\n    private gameLoop(): void {\r\n        if (\r\n            !this.gameState.gameInProgress || !this.ui.ctx || !this.ui.canvas ||\r\n            !this.ui.decalCtx || !this.ui.decalCanvas || !this.ui.postEffectsCtx\r\n        ) return;\r\n\r\n        if (this.gameState.isPaused) { // Continue the loop but skip all updates\r\n            requestAnimationFrame(() => this.gameLoop());\r\n            return;\r\n        }\r\n\r\n        const dt = this.utility.deltaTime();\r\n\r\n        this.camera.update(dt);\r\n\r\n        // Update\r\n        this.playerController.updatePlayerPosition(dt);\r\n        this.combatController.updateAttack(dt);\r\n        this.combatController.updateProjectiles(dt);\r\n        this.particlesManager.updateParticles(dt);\r\n        this.particlesManager.updateEmitters(dt);\r\n        this.particlesManager.updateShrapnel(dt);\r\n        this.animator.updateCharacterAnimations(dt);\r\n        this.staminaController.updateStamina(dt);\r\n        this.dashController.updateDash(dt);\r\n\r\n        this.collisionsManager.checkCollisions(dt);\r\n\r\n        this.ui.updateSlider('stamina');\r\n\r\n        // === RENDERING ===\r\n\r\n        // Clear main canvas\r\n        this.renderingManager.clearCtx(this.ui.ctx);\r\n\r\n        this.world.drawWorld();\r\n\r\n        this.world.worldDebug.drawDebug();\r\n        this.world.updateAudioZones();\r\n\r\n        this.ui.ctx.drawImage(\r\n            this.ui.decalCanvas,\r\n            this.camera.pos.x, this.camera.pos.y,\r\n            VIEWPORT.WIDTH, VIEWPORT.HEIGHT,\r\n            0, 0,\r\n            VIEWPORT.WIDTH, VIEWPORT.HEIGHT\r\n        );\r\n\r\n        // Draw objects (with camera offset)\r\n        this.renderingManager.drawObjects();\r\n\r\n        // Draw projectiles (with camera offset)\r\n        this.combatController.projectiles.forEach(projectile => {\r\n            this.renderingManager.drawProjectile(projectile);\r\n        });\r\n\r\n        // Draw other players (with camera offset)\r\n        this.playerState.players.forEach((player: Player) => {\r\n            if (!this.ui.ctx) return;\r\n\r\n            const charRenderParams: RenderCharacterParams = { player, context: this.ui.ctx };\r\n            this.renderingManager.drawCharacter(charRenderParams);\r\n        });\r\n\r\n        // Draw my player (with camera offset)\r\n        const myRenderParams: RenderCharacterParams = { player: this.playerState.myPlayer, context: this.ui.ctx };\r\n        this.renderingManager.drawCharacter(myRenderParams);\r\n\r\n        // Draw particles and shrapnel (with camera offset)\r\n        this.particlesManager.drawParticles();\r\n        this.particlesManager.drawShrapnel();\r\n\r\n        // Continue game loop\r\n        requestAnimationFrame(() => this.gameLoop());\r\n    }\r\n\r\n    /**\r\n     * Pauses the game when called.\r\n     */\r\n    public pauseGame(): void {\r\n        if (!this.gameState.gameInProgress) return;\r\n\r\n        this.gameState.isPaused = true;\r\n        console.log('Game paused');\r\n\r\n        this.controlsManager.clearActiveKeys();\r\n        this.playerState.isSprinting = false;\r\n        this.playerState.isDashing = false;\r\n        this.playerState.isBurstActive = false;\r\n        this.playerState.currentBurstShot = 0;\r\n    }\r\n\r\n    /**\r\n     * Resumes the game when called.\r\n     */\r\n    public resumeGame(): void {\r\n        if (!this.gameState.gameInProgress) return;\r\n\r\n        this.gameState.isPaused = false;\r\n        console.log('Game resumed');\r\n    }\r\n\r\n    /**\r\n     * Resets the game state to default.\r\n     */\r\n    private resetGameState(resetType: ResetType): void {\r\n        this.clear();\r\n\r\n        this.gameState.clear();\r\n\r\n        if (resetType === 'Room') {\r\n            this.lobbyManager.inLobby = false;\r\n            this.playerState.isHost = false;\r\n        }\r\n\r\n        this.combatController.projectiles.clear();\r\n\r\n        this.decalsManager.clear();\r\n        this.objectsManager.clear();\r\n        this.particlesManager.clear();\r\n\r\n        if (resetType === 'Room') {\r\n            this.lobbyManager.lobbyPlayers.clear();\r\n        }\r\n\r\n        this.renderingManager.clearCtx();\r\n        this.ui.clear();\r\n\r\n        this.chatManager.clear();\r\n\r\n        this.playerState.clear();\r\n        this.playerState.initPlayer(this.userId);\r\n\r\n        this.controlsManager.clear();\r\n        this.animator.clear();\r\n\r\n        this.utility.clearTimeoutCache();\r\n\r\n        this.world.clear();\r\n\r\n        // Reset upgrades and equipment\r\n        this.upgradeManager.resetUpgrades(this.playerState.myPlayer);\r\n        this.upgradeManager.upgradesCompleted.clear();\r\n    }\r\n    //\r\n    // #endregion\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    // #region [ Actions / Inputs ]\r\n    //\r\n    /**\r\n     * Provides polling for inputs and keybinds - checking for any actions assigned.\r\n     */\r\n    private watchForInputs(): void {\r\n        const poll = () => {\r\n            if (this.controlsManager.gamepadConnectionEnabled) {\r\n                this.controlsManager.pollGamepad();\r\n            }\r\n            this.checkActions();\r\n            requestAnimationFrame(poll);\r\n        };\r\n        poll();\r\n    }\r\n\r\n    /**\r\n     * Checks for keybinds and input actions during polling.\r\n     */\r\n    public checkActions(): void {\r\n        // TODO: MAYBE add menu navigation with keyboard/gamepad here\r\n\r\n        if (!this.gameState.gameInProgress || this.gameState.isPaused) return;\r\n\r\n        const keybinds = this.settingsManager.getSettings().controls.keybinds;\r\n\r\n        if (this.controlsManager.triggered(keybinds.dash)) {\r\n            this.dashController.startDash();\r\n        }\r\n\r\n        if (this.controlsManager.triggered(keybinds.melee)) {\r\n            if (this.combatController.canMelee()) {\r\n                this.combatController.triggerAttack('melee');\r\n            }\r\n        }\r\n\r\n        if (this.controlsManager.triggered(keybinds.reload)) {\r\n            this.combatController.startReload();\r\n        }\r\n\r\n        if (this.controlsManager.held(keybinds.sprint)) {\r\n            if (this.moveController.isMoveInput()) {\r\n                this.playerState.isSprinting = true;\r\n            }\r\n        } else {\r\n            this.playerState.isSprinting = false;\r\n        }\r\n\r\n        if (this.controlsManager.triggered(keybinds.attack)) {\r\n            if (this.playerState.canShoot && !this.playerState.isBurstActive && !this.playerState.isMelee) {\r\n                this.combatController.triggerAttack('ranged');\r\n            }\r\n        }\r\n\r\n        if (this.controlsManager.held(keybinds.attack) && this.playerState.canAutoFire) {\r\n            this.combatController.triggerAttack('ranged');\r\n        }\r\n\r\n        const gamepadRAxis = this.controlsManager.getGamepadRAxis();\r\n        if (gamepadRAxis !== null) {\r\n            this.animator.rotateCharacterPart(this.userId, gamepadRAxis);\r\n        }\r\n\r\n        this.controlsManager.updatePreviousKeys();\r\n    }\r\n    //\r\n    // #endregion\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    //\r\n    // #region [ Upgrades ]\r\n    //\r\n    /**\r\n     * Start the upgrade phase by showing the relative UI for winners/losers.\r\n     */\r\n    private startUpgradePhase(winnerId: string | null): void {\r\n        console.log('Starting upgrade phase...');\r\n\r\n        this.upgradeManager.upgradesCompleted.clear(); // Reset upgrade tracking\r\n\r\n        const numUpgrades = 2; // TODO: This could change based on upgrades or other factors\r\n\r\n        // Show upgrade UI based on if I won or lost\r\n        if (winnerId === this.userId) {\r\n            this.showWinnerWaitScreen();\r\n        } else {\r\n            this.showUpgradeSelection(numUpgrades);\r\n        }\r\n    }\r\n\r\n    // [ Winner ]\r\n    //\r\n    /**\r\n     * Show the winner waiting screen.\r\n     * \r\n     * This screen will persist until all losers in the game finish picking upgrades.\r\n     */\r\n    private showWinnerWaitScreen(): void {\r\n        if (!this.ui.upgradeContainer) return;\r\n\r\n        this.ui.upgradeContainer.innerHTML = '';\r\n\r\n        const waitingDiv = document.createElement('div');\r\n        waitingDiv.className = 'upgrade_waiting';\r\n        waitingDiv.textContent = 'Waiting for other players...';\r\n\r\n        this.ui.upgradeContainer.appendChild(waitingDiv);\r\n        this.ui.upgradeContainer.style.display = 'flex';\r\n    }\r\n\r\n    /**\r\n     * Update winner waiting screen to show the continue button, which will conclude the round-end upgrade process.\r\n     */\r\n    private showWinnerContinueButton(): void {\r\n        if (!this.ui.upgradeContainer) return;\r\n        this.ui.upgradeContainer.innerHTML = '';\r\n\r\n        const waitingDiv = document.createElement('div');\r\n        waitingDiv.className = 'upgrade_waiting';\r\n        waitingDiv.textContent = 'Upgrade phase complete.';\r\n\r\n        const continueBtn = document.createElement('button');\r\n        continueBtn.textContent = 'Continue';\r\n        continueBtn.onclick = () => {\r\n            if (!this.ui.upgradeContainer) return;\r\n            console.log(\"Winner pressed continue...\");\r\n\r\n            this.ui.upgradeContainer.style.display = 'none';\r\n\r\n            this.utility.safeTimeout(() => {\r\n                this.startNewRound();\r\n            }, GAME.NEW_ROUND_DELAY);\r\n        };\r\n\r\n        this.ui.upgradeContainer.appendChild(waitingDiv);\r\n        this.ui.upgradeContainer.appendChild(continueBtn);\r\n        this.ui.upgradeContainer.style.display = 'flex';\r\n    }\r\n\r\n    // [ Losers ]\r\n    //\r\n    /**\r\n     * Displays the upgrade selection screen for losers during the upgrade phase.\r\n     */\r\n    private showUpgradeSelection(amount: number): void {\r\n        if (!this.ui.upgradeContainer) return;\r\n\r\n        this.ui.upgradeContainer.innerHTML = '';\r\n\r\n        // Get 3 random upgrades\r\n        const availableUpgrades = this.upgradeManager.getUpgrades(amount, this.playerState.myPlayer);\r\n\r\n        availableUpgrades.forEach(upgrade => {\r\n            const upgradeDiv = document.createElement('div');\r\n            upgradeDiv.className = 'upgrade_card container';\r\n            upgradeDiv.setAttribute('data-rarity', upgrade.rarity.toString());\r\n\r\n            // Create image element\r\n            const imageDiv = document.createElement('div');\r\n            imageDiv.className = 'upgrade_image';\r\n\r\n            const img = document.createElement('img');\r\n            img.src = upgrade.icon;\r\n            img.alt = upgrade.name;\r\n            img.className = 'upgrade_icon';\r\n\r\n            // Handle image load errors\r\n            img.onerror = () => {\r\n                console.warn(`Failed to load upgrade image: ${upgrade.icon}`);\r\n                img.style.display = 'none';\r\n            };\r\n\r\n            imageDiv.appendChild(img);\r\n\r\n            const nameDiv = document.createElement('div');\r\n            nameDiv.className = 'upgrade_name';\r\n            nameDiv.textContent = upgrade.name;\r\n\r\n            const subtitleDiv = document.createElement('div');\r\n            subtitleDiv.className = 'upgrade_subtitle';\r\n            subtitleDiv.textContent = upgrade.subtitle;\r\n\r\n            upgradeDiv.appendChild(imageDiv);\r\n            upgradeDiv.appendChild(nameDiv);\r\n            upgradeDiv.appendChild(subtitleDiv);\r\n\r\n            upgradeDiv.addEventListener('click', () => {\r\n                console.log(\"Selected upgrade: \", upgrade.name);\r\n                this.selectUpgrade(upgrade.id);\r\n            });\r\n\r\n            if (!this.ui.upgradeContainer) return;\r\n            this.ui.upgradeContainer.appendChild(upgradeDiv);\r\n        });\r\n\r\n        this.ui.upgradeContainer.style.display = 'flex';\r\n    }\r\n\r\n    /**\r\n     * Triggers on click when a loser selects an upgrade from their displayed options.\r\n     * \r\n     * Processes selection upgrade and sends a network message to inform others of the action.\r\n     */\r\n    private selectUpgrade(upgradeId: string): void {\r\n        const success = this.upgradeManager.applyUpgrade(upgradeId, this.playerState.myPlayer);\r\n        if (!success) {\r\n            console.error('Failed to apply upgrade'); // Maybe two people picked same one, (apply upgrade checks uniques)\r\n            return;\r\n        }\r\n\r\n        this.finishUpgrade(upgradeId);\r\n    }\r\n\r\n    /**\r\n     * Closes upgrade loop for loser once they have selected an upgrade.\r\n     */\r\n    private finishUpgrade(selectedUpgradeId: string): void {\r\n        if (this.ui.upgradeContainer) { // Hide upgrade UI\r\n            this.ui.upgradeContainer.style.display = 'none';\r\n        }\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: 'upgrade-taken',\r\n            upgradeId: selectedUpgradeId,\r\n            userId: this.userId,\r\n            isUnique: this.upgradeManager.upgrades.find(u => u.id === selectedUpgradeId)?.unique || false\r\n        }));\r\n\r\n        this.roomManager.sendMessage(JSON.stringify({\r\n            type: \"player-state\",\r\n            userId: this.userId,\r\n            data: this.playerState.myPlayer\r\n        }));\r\n\r\n        console.log('Upgrade selected, waiting for others...');\r\n    }\r\n    //\r\n    // #endregion\r\n}\r\n\r\n// Initialize the game client\r\nif (document.readyState === 'loading') {\r\n    document.addEventListener('DOMContentLoaded', () => {\r\n        new Client();\r\n    });\r\n} else {\r\n    new Client();\r\n}"],"names":["map","webpackContext","req","id","webpackContextResolve","__webpack_require__","o","e","Error","code","keys","Object","resolve","module","exports","create","params","name","subtitle","icon","type","UNIQUE","rarity","SUPERIOR","unique","func","player","includes","push","LEGENDARY","NoiseType","UpgradeRarity","UpgradeType","PhysicsMaterialTypes","FrictionTypes","LiquidFrictionTypes","STAT","UNCOMMON","playerState","updateStat","stats","health","max","COMMON","speed","actions","dash","cooldown","RARE","SPECIAL","EXCEPTIONAL","time","stamina","recovery","rate","delay","primary","projectile","damage","buffer","EQUIPMENT","equipment","spread","RESOURCE","magazine","currentReserve","ui","ammoReservesUIController","spawnAmmoInReserveUI","__webpack_module_cache__","moduleId","cachedModule","undefined","__webpack_modules__","d","definition","key","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","r","Symbol","toStringTag","value","SHRAPNEL","AMMO_BOX","BASE","BULLETS","LID","WORLD","VIEWPORT","GAMEPAD_MAP","A","B","X","Y","LB","RB","LT","RT","SELECT","START","L_STICK","R_STICK","DPAD_UP","DPAD_DOWN","DPAD_LEFT","DPAD_RIGHT","HOME","AXES","LEFT_STICK_X","LEFT_STICK_Y","RIGHT_STICK_X","RIGHT_STICK_Y","GAME","CHARACTER_SIZE","CONNECTION_TIMEOUT","CONTROLS","KEYBINDS","MELEE","MOVE_UP","MOVE_LEFT","MOVE_DOWN","MOVE_RIGHT","RELOAD","SPRINT","ATTACK","DASH","GAMEPAD","DEADZONE","DATA","ID_LENGTH","GAME_END_DELAY","GRAPHICS","PHYSICS","AMMORESERVES","STATIC_OVERLAY","BACKGROUND_PARTICLES","MAX_PLAYERS","MAX_WINS","RECONNECT_DELAY","ROUND_END_DELAY","NEW_ROUND_DELAY","ADMIN_KEYS","KEYS","REQUIRED_COUNT","Admin","constructor","cacheManager","adminKeysHeld","Set","this","initKeyListener","initConsoleKeybinds","window","addEventListener","add","checkAdminCombo","delete","every","has","size","clear","showAdminModal","modal","modalInput","modalConfirmButton","modalCancelButton","modalErrorDiv","modalText","classList","remove","style","display","textContent","focus","onclick","trim","command","split","executeAdminCommand","closeModal","console","log","onAdminCommand","document","getModifierState","preventDefault","clearCacheCommand","then","location","reload","Animator","roomManager","userId","characterAnimations","Map","characterOffsets","animateCharacterPart","generateCharacterAnimation","sendMessage","JSON","stringify","rotateCharacterPart","playerId","rotation","myPlayer","transform","rot","players","now","Date","Math","abs","lastSentRotation","lastSentRotationTime","animateCharacterPartNetwork","part","frames","duration","partIndex","animationId","set","startTime","originalOffset","x","y","updateCharacterAnimations","delta","animationsToRemove","currentTime","forEach","animation","progress","frameKeys","Number","sort","a","b","lerpedX","lerpedY","currentFrameIndex","i","length","frameProgress","nextFrameProgress","lastFrame","currentFrame","nextFrame","CacheManager","dbName","dbVersion","db","initDB","Promise","reject","request","indexedDB","open","onerror","error","onsuccess","result","onupgradeneeded","event","target","objectStoreNames","contains","createObjectStore","write","transaction","objectStore","put","read","Camera","utility","pos","targetPos","config","followSpeed","lookAhead","update","playerRot","PI","forwardDir","forward","offsetX","offsetY","min","worldToScreen","worldPos","screenToWorld","screenPos","isVisible","margin","CharacterConfig","weapon","glock","knife","empty","full","body","default","head","blondeAfro","headwear","fez","strawHat","trucker","upgrades","kineticBrain","characterDecals","blood","gore","CharacterManager","charConfig","getCharacterAsset","layer","variant","getUpgradeVisual","upgradeName","lowerName","toLowerCase","ControlsManager","settingsManager","activeKeys","gamepadKeys","previousKeys","mousePos","gamepadConnected","gamepadConnectionEnabled","gamepadRAxis","initGamepad","clearActiveKeys","held","triggered","getActiveKeys","addKey","removeKey","updatePreviousKeys","getMousePos","setMousePos","pollGamepad","gamepad","navigator","getGamepads","settings","getSettings","keybinds","controls","gamepadMap","deadzone","xAxis","axes","yAxis","moveRight","moveLeft","moveDown","moveUp","buttons","melee","pressed","attack","sprint","rightX","rightY","aimMagnitude","sqrt","atan2","getGamepadRAxis","CollisionsManager","objectsManager","checkCollisions","checkObjectCollisions","checkPlayersCollisions","collisionsEnabled","collisionRadius","getPlayerCollider","ammoBoxes","ammoBox","boxId","isOpen","dx","dy","maxReserve","actualAmmoAdded","ammoAmount","angle","random","lid","velocity","cos","sin","torque","ammoBoxId","boxState","dist","minDist","overlap","pushX","pushY","padding","col","flags","hidden","invulnerable","DecalsConfig","decals","radius","density","opacity","variation","colors","explosion","materialDecals","metal","ranged","DecalsManager","camera","renderingManager","dynamicDecals","staticDecalData","decalsConfig","createDecal","generateDecal","createDecalNetwork","decalCtx","parametric","generateParametricDecal","image","generateImageDecal","numPixels","floor","save","globalCompositeOperation","distance","pixelX","pixelY","chosenColor","rgb","hexToRgb","pixelOpacity","clampedOpacity","fillStyle","g","fillRect","restore","Image","src","drawImage","complete","naturalWidth","translate","rotate","drawSize","scale","onload","generateGore","gorePool","amount","goreAsset","getRandomInArray","splice","indexOf","getRandomNum","goreDecal","decalId","ownerId","stampGore","bloodPool","bloodAsset","bloodDecal","characterImages","bakeDecals","currentBaked","getImageData","data","alpha","newAlpha","oldAlpha","clearRect","renderBakedDecals","putImageData","spawnMagazineDecal","setTimeout","currentAmmo","currentWeapon","inventory","magazineSrc","decalParams","EventsManager","animator","audioManager","chatManager","controlsManager","gameState","roomController","initEventListeners","canvas","hostButton","joinButton","quickplayButton","lobbyLeaveButton","lobbyCodeButton","gameLeaveButton","gameCodeButton","startGameBtn","chatSendBtn","chatInput","hostRoom","joinRoom","quickPlay","leaveRoom","copyRoomCode","onStartButtonClick","sendChatMessage","shiftKey","canShoot","isSprinting","isDashing","isBurstActive","currentBurstShot","settingsButton","showSettingsPage","settingsCloseButton","hideSettingsPage","onKeyDown","onKeyUp","onMouseUp","onMouseMove","onMouseDown","switchSettingsPage","controlsTab","graphicsTab","soundTab","controlsBody","graphicsBody","soundBody","initSettingsAudioSliders","initSettingsInputListeners","initSettingsToggleListeners","activeElement","gameInProgress","isPaused","values","button","updateMouse","worldMousePos","targetRotation","intensity","currentRotation","newRotation","rect","getBoundingClientRect","clientX","left","clientY","top","CustomEvent","dispatchEvent","slider","masterSlider","fill","masterFill","masterValue","channel","ambienceSlider","ambienceFill","ambienceValue","musicSlider","musicFill","musicValue","sfxSlider","sfxFill","sfxValue","voiceSlider","voiceFill","voiceValue","handleMove","moveEvent","sliderValue","calculateSliderValue","updateSettingsSlider","updateSettings","audio","mixer","volume","handleUp","removeEventListener","updateMixerGains","input","deadzoneInput","settingPath","parse","parseFloat","rawValue","parsedValue","isNaN","pathParts","current","toggle","particleJSToggle","staticVfxToggle","ammoReservesPhysicsToggle","newValue","getAttribute","setAttribute","removeAttribute","initKeybindListeners","controlsSettings","initKeybindsInterface","action","newBinding","onBindingChange","element","getElementById","toUpperCase","buttonName","find","toString","GameState","gameMaxWins","gameMaxPlayers","LobbyManager","characterManager","playerConfig","inLobby","lobbyPlayers","charCustomizeHandlers","showLobbyControls","lobby","lobbyOptions","roomId","isHost","maxWins","privateRoom","upgradesEnabled","updateDisplay","centerX","charCustomizeCanvas","width","centerY","height","color","rig","character","setupLobbyOptions","winsInputParams","inputId","privateToggleParams","toggleId","upgradesToggleParams","setToggle","setInput","displayLobbyPlayers","updateHostDisplay","setupCharacterCustomization","setupLobbyToggle","val","setupLobbyInput","maxPlayers","elementProp","messageKey","getter","setter","handlerKey","handler","toggleParams","parseInt","inputParams","syncLobbyOptions","options","syncOption","bind","v","elementId","fn","label","format","displayValue","promotePlayer","targetPlayerId","kickPlayer","bodyArrowLeft","bodyArrowRight","headArrowLeft","headArrowRight","headwearArrowLeft","headwearArrowRight","addHandler","cycleRigVariant","rigProp","direction","myLobbyPlayer","allVariants","currentVariant","newIndex","ObjectsManager","spawnObject","baseObject","generateUID","timestamp","spawnAmmoBox","RenderingManager","charManager","lobbyManager","ammoBoxImages","clearCtx","customCtx","ctx","drawCharacter","context","renderUniqueEffects","font","textAlign","displayName","substring","fillText","idOffset","drawCharacterLayers","drawCharacterLayer","drawUpgradeLayers","assets","drawCharacterPart","Array","isArray","assetPath","index","partType","renderLobbyPlayer","worldX","worldY","shouldApplyCamera","posX","posY","animationOffset","uniqueName","equipmentName","renderSpectralImage","staticGhosts","_spectralGhosts","lastHidden","flashes","wasHidden","isHidden","t","ghost","age","globalAlpha","filter","ghostPlayer","getContext","drawObjects","layers","img","drawProjectile","dirX","dirY","frontX","frontY","backX","backY","strokeStyle","lineWidth","lineCap","beginPath","moveTo","lineTo","stroke","RoomController","upgradeManager","wsManager","showRoomControls","getWebSocket","createRoom","isPrivateRoom","isUpgradesEnabled","connectWebSocket","safeTimeout","showJoinRoomModal","joinRoomById","fetch","response","ok","json","catch","modalContent","modalButtons","detail","resetType","checkForRoomInURL","getRoomIdFromURL","URLSearchParams","search","roomIdDisplay","gameRoomIdDisplay","clipboard","writeText","alert","RoomManager","currentRoom","ws","messageHandlers","setWebSocket","setupMessageHandler","readyState","WebSocket","OPEN","message","send","generateLink","history","pushState","origin","text","sendAdminCommand","getCurrentRoom","getRoomLink","param","onMessage","onmessage","plainMessage","SettingsManager","audioConfig","gameSettings","initSettings","master","ambience","music","sfx","voice","graphics","physics","ammoReserves","renderBackgroundParticles","showStaticOverlay","mixerUpdates","busName","merge","source","loadSettings","cached","upgradeFiles","resource","UpgradeManager","takenUniques","upgradesCompleted","rarityConfig","weight","MYTHICAL","ENLIGHTENED","HOLY","initUpgrades","filename","upgrade","getUpgrades","count","availableUpgrades","selected","totalWeight","reduce","sum","getRarityWeight","selectedUpgrade","applyUpgrade","upgradeId","u","warn","hasEquipment","removeUpgradeFromPool","resetUpgrades","equipmentId","hasUnique","uniqueId","getRarityColor","AmmoReservesUIController","ammoReserveIcon","projectileIcon","reserveBulletParticles","initAmmoReserveCanvas","renderAmmoReserves","requestAnimationFrame","updateAmmoReservePhysics","ammoReservesCtx","physicsEnabled","collisionHeight","collisionWidth","collisionX","collisionY","getAmmoReserveCollisionZone","vx","vy","removeAmmoFromReserveUI","shift","ammoReservesCanvas","bullet","j","ax","ay","va","vb","avg","UserInterface","leaderboard","decalCanvas","worldCanvas","worldCtx","liquidCanvas","liquidCtx","postEffectsCanvas","postEffectsCtx","gameContainer","gameOptionsContainer","lobbyContainer","roomControls","upgradeContainer","lobbyPlayersList","userIdDisplay","playersInput","privateToggle","upgradesToggle","winsInput","chatContainer","chatMessages","charCustomizeContainer","charCustomizeCtx","leaderboardBody","leaderboardContainer","settingsContainer","accuracyStat","damageStat","luckStat","rangeStat","shotSpeedStat","speedStat","HUD_LERP_TIME","initInterfaceListeners","clearLeaderboard","initInterface","createElement","clearDisplay","gameRoomId","disabled","innerHTML","from","playerDiv","className","colorDiv","backgroundColor","nameDiv","controlsDiv","promoteBtn","kickBtn","appendChild","onkeydown","onConfirm","url","URL","pathname","startsWith","replace","soloGameWarning","page","fillElement","valueElement","percentage","round","sliderElement","mouseX","position","initSoundSliders","audioSettings","initSettingsInputs","initSettingsToggles","showRebindModal","buttonValue","onRebind","duplicateWarnings","warningIndex","gamepads","some","gp","checkDuplicate","binding","entries","handleKeyPress","cleanup","newKey","handleMouseDown","stopPropagation","mouseKey","handleGamepadPress","createLeaderboard","allPlayers","_","wins","kills","deaths","updateLeaderboardDisplay","localPlayer","entryA","entryB","entry","row","nameCell","winsCell","killsCell","deathsCell","updateSlider","playerStats","sliderParams","sliderId","targetValue","maxValue","lerpTime","setSlider","animTime","steps","increaseColor","decreaseColor","timeout","onStatChange","oldValue","isIncrease","animateTextInElement","decimals","Utility","lastFrameTime","performance","simplexTable","generateSimplexTable","activeTimeouts","deepMerge","yield","deltaTime","callback","clearTimeoutCache","clearTimeout","clamp","toFixed","getRandomInt","array","getShuffledArray","slice","getDotProduct","v1","v2","getReflection","normal","dot","getDirection","rootPos","getRandomDirection","degrees","randomAngle","getRandomColor","hexColor","mode","primaries","padStart","channels","dr","dg","lr","lg","lb","gray","getLightestColor","lightestColor","maxBrightness","brightness","hex","exec","table","Uint8Array","k","simplexNoise2D","override","perm","F2","G2","s","x0","y0","i1","j1","x1","y1","x2","y2","ii","jj","gi0","gi1","gi2","grad3","t0","t1","t2","pow","getNoise","noiseType","seed","Perlin","perlinNoise","octaves","persistence","Ridged","ridgedNoise","Worley","worleyNoise","Voronoi","voronoiNoise","total","frequency","amplitude","interpolateNoise","noise","pointsPerCell","cellX","cellY","Infinity","cx","cy","p","hash2D","normalize","n","hash","ix","fx","iy","fy","v3","v4","sx","smoothstep","sy","lerp","i2","prefix","chars","base","inputElement","sliderContainer","sliderFill","querySelector","targetPercentage","currentWidthStr","currentPercentage","transition","setSpan","spanElement","spanId","increment","stepTime","currentStep","currentValue","interval","setInterval","clearInterval","WebsocketManager","wsProtocol","protocol","wsHost","port","hostname","host","onopen","onclose","AudioConfig","out","resources","impact","flesh","locomotion","footsteps","dirt","grass","gravel","mud","sand","sand_wet","silt","silt_wet","snow","stone","water","light","medium","voice_00","grunt","voice_01","end","start","shell","hard","soft","beds","app","cliffs","mountains","ocean","plains","shore","AudioManager","buffers","mixers","loops","audioContext","AudioContext","initMixers","gain","createGain","connect","destination","getMixerVolume","preloadAudio","sounds","extension","promises","endsWith","loadSound","all","arrayBuffer","audioBuffer","decodeAudioData","playAudio","state","resume","category","output","mixerGain","createBufferSource","gainNode","panNode","createStereoPanner","loop","pitch","playbackRate","blend","spatial","listener","distanceVolume","rolloff","rolloffType","factor","maxDistance","referenceDistance","normalizedDistance","panValue","pan","onended","loopEntry","l","disconnect","startOffset","delayMs","activeAudio","setVolume","stop","playAudioNetwork","refreshActiveLoops","records","record","ChatConfig","defaults","maxMessages","maxMessageLength","ChatManager","chatConfig","displayChatMessage","senderId","isOwn","messageDiv","senderSpan","contentSpan","scrollTop","scrollHeight","children","removeChild","firstChild","ParticlesConfig","goreParticles","drip","lifetime","strength","sizeOverLifetime","collide","fade","paint","stain","spray","weaponParticles","muzzle","smoke","flash","materialParticles","ParticlesManager","collisionsManager","decalsManager","particles","emitters","shrapnel","collisionListeners","particlesConfig","createParticles","generateParticles","createParticlesNetwork","particleParams","noiseStrength","noiseScale","particle","hasCollided","initialSize","maxOpacity","updateParticles","particlesToRemove","noiseX","noiseY","ageRatio","stampParticle","extendedLifeRatio","emitCollision","speedReduction","lifetimeExtension","drawParticles","createEmitter","generateEmitter","offset","particleType","emissionInterval","lastEmission","updateEmitters","emittersToRemove","emitter","emitterId","coneSpread","randomSpread","baseSpeed","speedVariation","finalSpeed","spawnShrapnel","pieces","piece","images","rotationSpeed","generateShrapnel","updateShrapnel","shrapnelToRemove","actualDamage","defense","newHealth","shooterId","wasKill","stampShrapnel","drawShrapnel","addCollisionListener","CombatController","luckController","particlesManager","playerController","world","projectiles","cachedPrimaryBuffer","triggerAttack","startMelee","startBurst","updateAttack","isReloading","reloadStartTime","finishReload","nextBurstShotTime","ammoNeeded","burst","targetDir","triggerBurstUniques","launchProjectile","canMelee","isMelee","lastMeleeTime","range","spawnOffset","spawnX","spawnY","meleeProjectile","distanceTraveled","lastShotTime","ammoToUse","emptySfx","playerX","playerY","emptyBlend","blendVolume","dir","overrides","canTriggerUnique","projectileAmount","projectileColor","projectileDamage","projectileLength","projectileRange","projectileSize","projectileSpeed","projectileSpread","baseAngle","bulletSpawnX","bulletSpawnY","muzzleParams","smokeParams","shellParams","shuffledUniques","luckRoll","triggerUnique","updateProjectiles","projectilesToRemove","myPlayerX","myPlayerY","myStats","aim","lerpFactor","lx","ly","norm","frameDistance","playerCollider","reflected","projectileId","newOwnerId","myHealth","playerHit","dx2","dy2","impactX","impactY","triggerCollisionUniques","material","getMaterialAt","matName","matParticles","impactParticles","sparksParams","matDecals","impactDecal","impactSounds","impactSoundList","sfxParams","worldEdit","requestCraterAt","enableAutoFire","bufferMult","canAutoFire","disableAutoFire","angleOffset","dirA","dirB","baseParams","succeededUniques","canReload","startReload","reloadStartSfx","magazineSpace","ammoToReload","reloadEndSfx","DashController","combatController","moveController","staminaController","startDash","isMoveInput","lastDashTime","inputX","inputY","inputLength","getMoveInput","requestStamina","drain","dashStartTime","dashSpeed","multiplier","playerVelocityX","playerVelocityY","updateDash","newX","newY","moved","distanceFromLastSent","lastSentX","lastSentY","lastSentMoveTime","LuckController","effectiveLuck","luck","chance","tanh","MoveController","currentSpeed","maxSpeed","isMoving","getMoveSpeed","getMaxSpeed","PlayerConfig","startingReserve","idLength","acceleration","friction","Normal","PlayerController","lastMaterial","lastWaterData","lastFriction","footstepInterval","lastFootstepTime","FOOTSTEP_INTERVAL_MIN","FOOTSTEP_INTERVAL_MAX","FOOTSTEP_SAMPLE_RADIUS","MEDIUM_WATER_DEPTH","DEEP_WATER_DEPTH","POSITION_SAMPLE_INTERVAL","lastSampleTime","lastStrokeTime","strokePower","lastSwimDir","STROKE_FORCE","STROKE_DECAY_RATE","STROKE_COOLDOWN","MAX_SWIM_SPEED","setupEventListeners","initSwimDebugMenu","updatePlayerPosition","samplePlayerPosition","applyEnvironmentalFriction","isSwimming","handleSwimming","handleGroundMovement","syncMovement","speedRatio","footstep","accel","targetVX","targetVY","ctrlKey","toggleSwimDebugMenu","panel","right","background","zIndex","fontFamily","fontSize","border","step","setting","String","valueText","appliedFriction","hasWater","depth","waterLevel","Water","shallowDragBoost","frictionFactor","playerPos","samplePos","getWaterData","mat","surface","getPhysicsAt","inDeepWater","gruntParams","bloodDirection","emission","me","other","targetId","playerDeath","triggerUniques","resetPlayerState","materialCounts","sampleX","sampleY","primaryMaterial","maxCount","waterRatio","isWet","moveSpeed","footstepSound","footstepImpact","materialFootsteps","influence","scaledMin","scaledMax","pitchMin","pitchMax","waterBlend","groundVolumeScale","waterVolumeScale","groundStartOffset","waterFootsteps","splashArray","waterStartOffset","splashParams","force","applyFootstepAt","PlayerState","isStaminaRecoveryBlocked","lastStaminaDrainTime","staminaRecoveryBlockedUntil","statListeners","initPlayer","statPath","notifyChange","lastProp","StaminaController","updateStamina","staminaRecoveryPerFrame","WorldChunk","biomeName","sourcePixels","sourceHeights","sourceWater","worldConfig","version","pixelData","heightData","waterData","chosenBiomeName","getColorAt","localX","localY","chunkSize","combinedIndex","materialIndex","colorVariantIndex","materialsList","getHeightAt","getWaterAt","WorldConfig","worldgenParams","general","chunk","cell","island","valley","terrain","heightCurve","seaLevel","lowestDepth","colorVariation","degen","minHeight","threshold","hardness","hydration","render","opacityBase","opacityMultiplier","foamIntensity","foamScale","shoreBlend","shimmerStrength","depthDarkness","grid","active","chunkBorderColor","worldBorderColor","layerBorderColor","borderWidth","worldgenMessages","bakeStart","bakeHalf","generation","degeneration","special","regionAudioParams","minRegionSize","worldLayers","foundation","materials","substrate","sediment","alluvium","soil","topsoil","colluvium","summit","basalt","Solid","simulate","durability","Hard","tags","bedrock","clay","Soft","mutations","wet","clay_wet","Wet","dry","granite","ice","Slick","permafrost","loam","limestone","moss","peat","sandstone","scree","shale","slate","Sticky","coal","iron","gold","silver","copper","wood","concrete","asphalt","Liquid","viscosity","worldLayerIndex","worldLayerList","getWorldgenMessage","phase","messages","specialIndex","phaseMessages","mutate","mutation","targetName","WorldDebug","hoveredChunk","overlayMode","overlayNames","listenForDebugShortcuts","altKey","isGenerated","showGenerationMenu","async","worldData","generateWorld","renderMenu","showOverlayName","exportWorldData","drawDebug","drawChunks","drawHeightmap","drawContours","drawRegions","drawAudioZones","drawInfoPanels","hoveredCoords","updateHoveredChunk","hcx","hcy","chunks","chunkLayer","chunkLayers","li","combined","height01","currentX","regionName","regions","region","chunkCoords","c","mainInfo","drawPanel","materialColor","solidInfo","phys","liquidInfo","title","lines","titleBgColor","maxWidth","measureText","line","boxWidth","boxHeight","headerHeight","strokeRect","camX","camY","startCX","endCX","ceil","startCY","endCY","hoveredScreenX","hoveredScreenY","screenX","screenY","currentLayer","getChunkLayer","layerRight","layerBottom","vBorder","hBorder","lerpColor","stops","h","startX","startY","lower","upper","contourStep","getH","h00","h10","h01","h11","minH","maxH","level","interp","points","regionFillColors","regionBorderColors","borderColor","audioZones","zone","center","audioParams","isActive","arc","existing","overlay","cssText","parentElement","WorldEdit","createChunkPatch","handleChunkUpdate","createChunkPatchNetwork","bedrockIndex","patches","idx","newPacked","pixel","materialName","allMaterials","currentPacked","matIndex","colorIndex","currentMat","newColorIndex","compression","newHeight","World","regionAudioSources","currentSeed","erosionTemplate","chunkBuffer","worldBuffer","YIELD_RATE","WORLDGEN_PHASES","worldDebug","initLoadingProgressEvents","cleanWorldAudio","worldgenMenu","file","loadWorldFromFile","showLoadingMenu","cellData","generateCells","degenCellData","applyDegen","hydratedCellData","applyHydration","bakeChunksFromCells","hideLoadingMenu","worldGenParams","cellSize","cellsX","cellsY","worldPixelData","worldHeightData","cellLayerGrid","totalCells","processedCells","adjustedHeight","mid","opts","distToEdgeX","distToEdgeY","distToEdge","maxDist","edgeNoise","layerForCell","pickLayerForHeight","layerIndex","pixelInfo","samplePixelData","landMatIndex","materialColorIndex","gi","materialNoise","m","selectedMaterial","detailNoise","best","bestDist","newPixelData","newHeightData","degenConfig","erosionMaterials","getErosionTemplate","processedPixels","wy","wx","originalHeight01","combinedNoise","erosionAmount","currentMatIndex","newHeight01","newHeightByte","erosionDepth","originalDurability","harderMaterials","newMatIndex","newColorVariantIndex","normalizedDepth","detailForColor","numColors","lookup","newWaterData","materialIndexLookup","depthRange","totalPixels","wetness","Float32Array","isWaterPixel","depthT","tmp","pass","acc","nx","ny","moistureNoiseScale","w","packed","probability","wetMat","wetIndex","worldWaterData","allWorldLayers","chunksX","chunksY","totalChunks","startMessage","secondMessage","spawn","progressMessagePoint","halfwayPoint","loaded","dumpChunkBuffer","chunkPixels","chunkHeights","chunkWater","layerCounts","startCellX","endCellX","startCellY","endCellY","cby","cbx","dominantIdx","dominantLayer","worldChunk","renderChunk","bakeRegionsFromChunks","visited","regionId","classifyRegion","layerName","chunkToRegion","regionChunks","queue","qx","qy","qKey","neighbors","totalWater","rcx","rcy","minX","maxX","minY","maxY","bounds","area","nearest","candidate","assigned","padEnd","generateAudioZones","drawWorld","cam","baseColor","finalColor","adjustPixelColor","renderWater","palette","depthRatio","waveNoise","ridge","foam","darkness","shade","scatter","nr","ng","nb","totalYieldSteps","bakedChunks","container","header","popup","form","noiseTypeOptions","charAt","join","loadButton","fileInput","click","onchange","files","onsubmit","fd","FormData","num","int","menu","loadingMenu","remoteChunk","handleChunkPatch","newChunk","patch","loadChunk","regionAudio","audioSrc","regionWidth","regionHeight","effectiveCoverage","zonesX","zonesY","totalZones","createdZones","gy","gx","zoneX","zoneY","zoneId","updateAudioZones","brain","inRange","roll","normalized","rollFactor","targetVolume","msgEl","bar","newWidth","encodeBase64","u8","binary","len","byteLength","fromCharCode","btoa","chunksOut","regionsOut","zonesOut","meta","generatedAt","toISOString","worldSize","chunkCount","regionCount","audioZoneCount","blob","Blob","link","href","createObjectURL","download","decodeBase64","b64","atob","bytes","charCodeAt","z","regionRef","ParticlesController","onParticleCollision","handleShellCollision","px","py","shellSets","isSoft","list","shellSfx","Client","isRoundInProgress","roundWinner","gameWinner","admin","particlesController","dashController","eventsManager","initClient","ammo","initGlobalEvents","spanParams","watchForInputs","startGame","resetGameState","handleRoomMessage","handleGameMessage","gameData","reason","newHostId","playerData","hitPlayer","shooter","box","spawnMap","showGameControls","startGameLoop","winnerId","endRound","resumeGame","isUnique","showWinnerContinueButton","returnToLobby","startNewRound","winnerEntry","endGame","pauseGame","startUpgradePhase","reservedSpawn","executeStartGame","gameLoop","dt","charRenderParams","myRenderParams","poll","checkActions","showWinnerWaitScreen","showUpgradeSelection","waitingDiv","continueBtn","upgradeDiv","imageDiv","alt","subtitleDiv","selectUpgrade","finishUpgrade","selectedUpgradeId"],"sourceRoot":""}